<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab - ì˜ì—… ê´€ë¦¬</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,sans-serif;height:100vh;background:#f8f9fb;font-size:13px;overflow:hidden;display:flex}
@keyframes spin{to{transform:rotate(360deg)}}
.biz-verify-table{width:100%;border-collapse:collapse;margin-bottom:10px}
.biz-verify-table th{text-align:left;padding:6px 10px;background:#f5f7fa;border:1px solid #e0e0e0;width:120px;font-size:12px;color:#555}
.biz-verify-table td{padding:6px 10px;border:1px solid #e0e0e0;font-size:13px}
.biz-verify-section{margin-top:10px;padding:8px 10px;background:#f9f9f9;border-radius:6px}
.biz-valid-ok{font-size:15px;font-weight:700;color:#2e7d32}
.biz-valid-fail{font-size:15px;font-weight:700;color:#d32f2f}
.file-view-section{background:#f8fafe;border:1px solid #e2e8f0;border-radius:10px;padding:14px 16px;margin-bottom:16px}
.file-view-title{font-size:13px;font-weight:700;color:#1a2332;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.file-view-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.file-view-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid #d0d7e2;background:#fff;color:#1a2332;transition:all .15s}
.file-view-btn:hover{background:#e3f2fd;border-color:#90caf9;color:#1565c0}
.file-view-btn .fv-icon{font-size:14px}
.file-view-empty{font-size:12px;color:#8892a4;padding:4px 0}

/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700;color:white}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */


/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;margin-left:250px;height:100vh}
.topbar{background:#fff;border-bottom:1px solid #e2e6ed;padding:0 24px;height:52px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700;color:#1a2332}
.topbar-sep{color:#c8d6e5}
.topbar-sub{font-size:13px;color:#5f6b7a}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:12px}
.topbar-bell{position:relative;cursor:pointer;font-size:18px}
.topbar-bell .dot{position:absolute;top:-2px;right:-4px;width:8px;height:8px;background:#e53935;border-radius:50%}

.content{flex:1;padding:24px;overflow-y:auto}

/* Buttons */
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#1a73e8;color:#fff}.btn-primary:hover{background:#1557b0}
.btn-secondary{background:#fff;color:#5f6b7a;border:1px solid #e2e6ed}.btn-secondary:hover{background:#f0f2f5}
.btn-success{background:#2e7d32;color:#fff}.btn-success:hover{background:#1b5e20}
.btn-danger{background:#e53935;color:#fff}.btn-danger:hover{background:#c62828}
.btn-sm{padding:6px 12px;font-size:11px}
.btn-check{background:#e3f2fd;color:#1565c0;border:1px solid #bbdefb}.btn-check:hover{background:#bbdefb}

/* Cards */
.card{background:#fff;border-radius:12px;border:1px solid #e2e6ed;margin-bottom:16px}
.card-hd{padding:16px 20px;border-bottom:1px solid #eef0f4;display:flex;align-items:center;gap:10px}
.card-hd h3{font-size:15px;font-weight:700;color:#1a2332}
.card-hd .right{margin-left:auto;display:flex;gap:8px}
.card-bd{padding:20px}

/* Tables */
.tbl{width:100%;border-collapse:collapse}
.tbl th{background:#f8f9fb;padding:10px 14px;font-size:11px;font-weight:700;color:#5f6b7a;text-align:left;border-bottom:2px solid #e2e6ed;white-space:nowrap}
.tbl td{padding:10px 14px;border-bottom:1px solid #eef0f4;font-size:12px;color:#333}
.tbl tr:hover{background:#fafbfc}
.tbl .center{text-align:center}

/* Traffic dots */
.tl{display:inline-block;width:12px;height:12px;border-radius:50%;vertical-align:middle}
.tl-blue{background:#2196f3}.tl-green{background:#4caf50}.tl-yellow{background:#ffeb3b}.tl-orange{background:#ff9800}.tl-red{background:#f44336}
/* ì»¤ìŠ¤í…€ tooltip */
[data-tooltip]{position:relative;cursor:help}
[data-tooltip]:hover::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 14px;border-radius:8px;font-size:11px;white-space:pre-line;min-width:240px;max-width:320px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.2);line-height:1.7;pointer-events:none;font-weight:400;letter-spacing:0}
[data-tooltip]:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b;z-index:9999;pointer-events:none}

/* Tags */
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.tag-vip{background:#fce4ec;color:#c62828}.tag-a{background:#e3f2fd;color:#1565c0}.tag-b{background:#e8f5e9;color:#2e7d32}.tag-c{background:#f3e5f5;color:#7b1fa2}
.tag-active{background:#e8f5e9;color:#2e7d32}.tag-dormant{background:#fff3e0;color:#e65100}.tag-terminated{background:#f5f5f5;color:#9e9e9e}
.tag-pending{background:#fff3e0;color:#e65100}.tag-approved{background:#e8f5e9;color:#2e7d32}.tag-rejected{background:#fce4ec;color:#c62828}

/* Form */
.fg{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.fg label{font-size:11px;color:#5f6b7a;font-weight:600}
.fg label .req{color:#e53935}
.fg input,.fg select,.fg textarea{padding:9px 12px;border:1px solid #e2e6ed;border-radius:8px;font-size:13px;outline:none;font-family:inherit;transition:border .15s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:#4fc3f7;box-shadow:0 0 0 3px rgba(79,195,247,.1)}
.fg textarea{resize:vertical;min-height:60px}
.fg select{cursor:pointer;background:#fff}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

.sub-card{background:#f8f9fb;border:1px solid #eef0f4;border-radius:10px;padding:14px;margin-bottom:10px;position:relative}
.sub-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.sub-card-title{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px}
.sub-card-num{background:#e3f2fd;color:#1565c0;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.btn-remove{background:none;border:none;color:#e53935;font-size:18px;cursor:pointer;padding:2px 6px;border-radius:4px}
.btn-remove:hover{background:#fce4ec}
.btn-add{display:flex;align-items:center;gap:6px;padding:10px;border:2px dashed #c8d6e5;border-radius:10px;background:transparent;color:#5f6b7a;font-size:12px;font-weight:600;cursor:pointer;width:100%;justify-content:center}
.btn-add:hover{border-color:#1a73e8;color:#1a73e8;background:#f0f7ff}
.combo{display:flex;gap:6px}.combo select,.combo input{flex:1}
.hint{font-size:10px;color:#8892a4;margin-top:2px}
.check-result{margin-top:4px;font-size:11px;padding:6px 10px;border-radius:6px;display:none}
.check-ok{background:#e8f5e9;color:#2e7d32}.check-dup{background:#fff3e0;color:#e65100}

/* Section title */
.sec-title{font-size:14px;font-weight:700;color:#1a2332;margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid #eef0f4;display:flex;align-items:center;gap:8px}
.sec-num{background:#1a73e8;color:#fff;width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}

/* Timeline */
.timeline{position:relative;padding-left:24px}
.timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:#e2e6ed}
.tl-item{position:relative;margin-bottom:16px;padding:14px;background:#fff;border:1px solid #e2e6ed;border-radius:10px}
.tl-item::before{content:'';position:absolute;left:-20px;top:18px;width:10px;height:10px;border-radius:50%;background:#1a73e8;border:2px solid #fff;box-shadow:0 0 0 2px #1a73e8}
.tl-item.sys::before{background:#ff9800}
.tl-date{font-size:10px;color:#8892a4;margin-bottom:4px}
.tl-content{font-size:12px;color:#333}
.tl-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.tl-tag{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.tl-tag-call{background:#e3f2fd;color:#1565c0}.tl-tag-sms{background:#f3e5f5;color:#7b1fa2}
.tl-tag-connected{background:#e8f5e9;color:#2e7d32}.tl-tag-missed{background:#fce4ec;color:#c62828}
.tl-tag-refused{background:#fff3e0;color:#e65100}

/* Route viz */
.route{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:12px;background:#f8f9fb;border-radius:10px;margin:8px 0}
.route-stop{padding:6px 12px;background:#fff;border:1px solid #e2e6ed;border-radius:8px;font-size:11px;font-weight:600;text-align:center}
.route-stop.home{background:#1a2332;color:#fff;border-color:#1a2332}
.route-arrow{color:#1a73e8;font-weight:700;font-size:14px}

/* Overlay */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:100;justify-content:center;align-items:center}
.overlay.show{display:flex}
.popup{background:#fff;border-radius:14px;padding:24px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,.15)}
.popup h3{font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.popup-actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}

/* Login popup */
.login-popup{max-width:440px}
.login-popup .alert{background:#fff3e0;border:1px solid #ffcc80;border-radius:10px;padding:14px;margin:12px 0;font-size:12px;color:#e65100}
.login-miss{font-size:28px;font-weight:800;color:#e53935;text-align:center;margin:8px 0}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.stat{background:#fff;border:1px solid #e2e6ed;border-radius:10px;padding:14px;text-align:center}
.stat-val{font-size:22px;font-weight:800;color:#1a2332}
.stat-label{font-size:10px;color:#8892a4;margin-top:2px}

/* Approval flow */
.approval-flow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0}
.af-step{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;text-align:center;min-width:80px}
.af-arr{font-size:16px;color:#8892a4}

/* Toast */
.toast{display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#1a2332;color:#fff;padding:14px 28px;border-radius:10px;font-size:14px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:200}
.toast.show{display:block;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* View toggle */
.view-mode{display:flex;gap:4px;margin-bottom:12px}
.vm-btn{padding:6px 14px;border:1px solid #e2e6ed;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;background:#fff;color:#5f6b7a}
.vm-btn.active{background:#1a73e8;color:#fff;border-color:#1a73e8}

/* File upload area */
.file-area{border:2px dashed #e2e6ed;border-radius:10px;padding:16px;text-align:center;color:#8892a4;font-size:12px;cursor:pointer}
.file-area:hover{border-color:#1a73e8;color:#1a73e8;background:#f0f7ff}

/* Address row */
.addr-row{display:flex;gap:8px}.addr-row input{flex:1}

.radio-group{display:flex;gap:12px;padding:6px 0}
.radio-item{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px}
.radio-item input{accent-color:#1a73e8;width:16px;height:16px}

/* Responsive */
@media(max-width:768px){.sb{display:none}.stats{grid-template-columns:1fr 1fr}.fg-row,.fg-row3{grid-template-columns:1fr}}
#koreaMap,#sgMap{cursor:pointer}
.sg-btn{padding:10px 16px;background:#f8f9fb;border:1px solid #e2e6ed;border-radius:8px;font-size:13px;font-weight:600;color:#1a2332;cursor:pointer;transition:all .15s;min-width:80px;text-align:center}
.sg-btn:hover{background:#e3f2fd;border-color:#90caf9;color:#1565c0}
.dong-btn{padding:8px 12px;background:#f8f9fb;border:1px solid #e2e6ed;border-radius:6px;font-size:12px;color:#5f6b7a;cursor:pointer;transition:all .15s}
.dong-btn:hover{background:#e8f5e9;border-color:#81c784;color:#2e7d32}
/* API ìˆ˜ì§‘ ì„¤ì • */
.api-item{padding:14px 16px;border:1px solid #eef0f4;border-radius:10px;margin-bottom:10px;transition:all .15s;background:#fafbfc}
.api-item:hover{border-color:#c8d6e5;background:#fff}
.api-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.api-check{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#1a2332}
.api-check input[type="checkbox"]{width:18px;height:18px;accent-color:#1a73e8;cursor:pointer}
.api-check strong{color:#1a73e8;font-family:monospace;font-size:12px;background:#e8f0fe;padding:2px 6px;border-radius:4px}
.api-count{font-size:11px;color:#8892a4;font-weight:600;background:#f0f2f5;padding:3px 8px;border-radius:4px}
.api-fields{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.api-tag{font-size:10px;padding:2px 7px;background:#e8f5e9;color:#2e7d32;border-radius:3px;font-family:monospace;cursor:default;border:1px solid #c8e6c9}
.api-tag:hover{background:#c8e6c9}
.api-item:has(input:not(:checked)){opacity:.5;background:#f5f5f5}
.api-item:has(input:not(:checked)) .api-tag{background:#f0f0f0;color:#aaa;border-color:#e0e0e0}
.collect-row{display:flex;align-items:center;gap:12px;padding:8px 12px;border-bottom:1px solid #f0f2f5;font-size:12px}
.collect-row:last-child{border-bottom:none}
.collect-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.collect-dot.ok{background:#4caf50}
.collect-dot.err{background:#f44336}
.collect-dot.run{background:#ff9800;animation:pulse 1s infinite}
.sido-label{background:rgba(255,255,255,.88)!important;border:none!important;box-shadow:0 1px 4px rgba(0,0,0,.18)!important;font-size:12px!important;font-weight:700!important;color:#1a2332!important;padding:3px 8px!important;border-radius:4px!important}
.sido-label::before{display:none!important}
.sg-label{background:rgba(255,255,255,.82)!important;border:none!important;box-shadow:0 1px 3px rgba(0,0,0,.12)!important;font-size:10px!important;font-weight:600!important;color:#37474f!important;padding:2px 6px!important;border-radius:3px!important}
.sg-label::before{display:none!important}
.leaflet-container{font-family:inherit!important}
/* ===== Column Settings Panel ===== */
#colSettingsPanel .col-settings-header{font-size:12px;font-weight:700;color:#5f6b7a;padding-bottom:8px;border-bottom:1px solid #eef0f4;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
#colSettingsPanel .col-settings-reset{font-size:11px;color:#1a73e8;cursor:pointer;font-weight:500}
#colSettingsPanel .col-settings-reset:hover{text-decoration:underline}
#colSettingsPanel .col-setting-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;font-size:12px;color:#333;cursor:pointer;transition:background .1s}
#colSettingsPanel .col-setting-item:hover{background:#f0f2f5}
#colSettingsPanel .col-setting-item input[type="checkbox"]{width:15px;height:15px;accent-color:#1a73e8;cursor:pointer;flex-shrink:0}
#colSettingsPanel .col-setting-divider{height:1px;background:#eef0f4;margin:6px 0}
/* ===== Column Drag ===== */
.tbl th[draggable="true"]{cursor:grab;user-select:none;position:relative;transition:background .15s}
.tbl th[draggable="true"]:active{cursor:grabbing}
.tbl th.col-drag-over{background:#e3f2fd !important;box-shadow:inset 2px 0 0 #1a73e8}
.tbl th.col-dragging{opacity:.4;background:#bbdefb}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1d5b2febea0c84335256f6a15d9e7c05&libraries=services"></script>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- PDF.js: PDFë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜ (Clova íŠ¹í™”ëª¨ë¸ì€ ë‹¤ì¤‘í˜ì´ì§€ PDF ë¯¸ì§€ì›) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>
</head>
<body>

<!-- Company Dup Popup -->
<div class="overlay" id="companyDup">
<div class="popup">
  <h3>ğŸ” ë™ì¼ ê³ ê°ì‚¬ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤</h3>
  <div style="background:#f8f9fb;border:1px solid #e2e6ed;border-radius:10px;padding:14px;margin:8px 0">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <span class="tl tl-orange"></span>
      <strong style="font-size:14px">í’€ë¬´ì›ì‹í’ˆ(ì£¼)</strong>
      <span class="tag tag-a">Aë“±ê¸‰</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:12px;color:#5f6b7a">
      <div>ì‚¬ì—…ìë²ˆí˜¸: 234-56-78901</div>
      <div>ëŒ€í‘œì: ì›í’€ë¬´</div>
      <div>ë‹´ë‹¹ ì˜ì—…: <strong>ë°•ì£¼ì„</strong></div>
      <div>ìµœê·¼ê±°ë˜: 2026-01-28</div>
    </div>
  </div>
  <div style="background:#fff3e0;border:1px solid #ffcc80;border-radius:8px;padding:10px;font-size:12px;color:#e65100">
    âš ï¸ ì´ë¯¸ <strong>ë°•ì£¼ì„</strong>ì´ ë‹´ë‹¹ ì¤‘ì…ë‹ˆë‹¤. ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•˜ë©´ ë°•ì£¼ì„ì—ê²Œ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.
  </div>
  <div class="popup-actions">
    <button class="btn btn-secondary" onclick="closePopup('companyDup')">ì·¨ì†Œ</button>
    <button class="btn btn-primary" onclick="closePopup('companyDup');toast('ğŸ“© ë°•ì£¼ì„ì—ê²Œ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ. ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.')">ê¸°ì¡´ ì—…ì²´ì— ë‹´ë‹¹ì ì¶”ê°€</button>
  </div>
</div>
</div>

<!-- Contact Dup Popup -->
<div class="overlay" id="contactDup">
<div class="popup">
  <h3>ğŸ” ë™ì¼ ë‹´ë‹¹ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
  <p style="font-size:12px;color:#5f6b7a;margin-bottom:10px">ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¡œ ì¡°íšŒí•œ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
  <div style="background:#f8f9fb;border:1px solid #e2e6ed;border-radius:10px;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>ê¸°ì¡´ ë“±ë¡ ì •ë³´</strong>
      <span style="background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600">ë‹´ë‹¹: ë°•ì£¼ì„</span>
    </div>
    <div style="font-size:12px;color:#333;line-height:1.8">
      ì´ë¦„: <strong>ì´ê·œì„±</strong><br>
      ì „í™”: <strong style="letter-spacing:1px">010-****-5678</strong><br>
      ì´ë©”ì¼: <strong style="letter-spacing:1px">lee***@pulmu.com</strong><br>
      ì†Œì†: í’€ë¬´ì›ì‹í’ˆ(ì£¼)
    </div>
  </div>
  <p style="font-size:12px;color:#5f6b7a;margin:10px 0">ì´ ì‚¬ëŒê³¼ <strong>ë™ì¼ ì¸ë¬¼</strong>ì…ë‹ˆê¹Œ?</p>
  <div class="popup-actions">
    <button class="btn btn-secondary" onclick="closePopup('contactDup')">ì·¨ì†Œ</button>
    <button class="btn btn-success" onclick="closePopup('contactDup');toast('âœ… ì‹ ê·œ ë‹´ë‹¹ìë¡œ ë“±ë¡í•©ë‹ˆë‹¤.')">ì•„ë‹ˆì˜¤, ì‹ ê·œ ë“±ë¡</button>
    <button class="btn btn-primary" onclick="closePopup('contactDup');toast('ğŸ“© ê¸°ì¡´ ë‹´ë‹¹ ë°•ì£¼ì„ì—ê²Œ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ')">ì˜ˆ, ë™ì¼ ì¸ë¬¼</button>
  </div>
</div>
</div>

<!-- Unified Sidebar -->
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=2"></script>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <span class="topbar-title">ì˜ì—… ê´€ë¦¬</span>
    <span class="topbar-sep">/</span>
    <span class="topbar-sub" id="topSub">ê³ ê°ì‚¬ ê´€ë¦¬</span>
    <div class="topbar-right">
      <div class="topbar-bell" onclick="toast('ğŸ”” ì•Œë¦¼ 3ê±´: ì…ê¸ˆ ì•½ì†ì¼ ë„ë˜ 1ê±´, ì‹ í˜¸ë“± ë³€ê²½ 1ê±´, ë¯¸ì‘ì„± ê²½ê³  1ê±´')">ğŸ””<span class="dot"></span></div>
    </div>
  </div>
  <div class="content" id="contentArea">

    <!-- ===== ê³ ê°ì‚¬ ê´€ë¦¬ - ëª©ë¡ ===== -->
    <div class="page" id="page-customerList">
      <div class="stats">
        <div class="stat"><div class="stat-val">47</div><div class="stat-label">ì „ì²´ ê±°ë˜ì²˜</div></div>
        <div class="stat"><div class="stat-val" style="color:#2e7d32">38</div><div class="stat-label">í™œë™ ì¤‘</div></div>
        <div class="stat"><div class="stat-val" style="color:#e65100">6</div><div class="stat-label">ë¯¸ìˆ˜ê¸ˆ ì—…ì²´</div></div>
        <div class="stat"><div class="stat-val" style="color:#e53935">2</div><div class="stat-label">ìœ„í—˜ (ì£¼í™©+ë¹¨ê°•)</div></div>
      </div>
      <div class="card">
        <div class="card-hd">
          <h3>ê³ ê°ì‚¬ ëª©ë¡</h3>
          <div class="right" style="position:relative;display:flex;align-items:center;gap:6px">
            <input type="text" id="custSearchInput" placeholder="ğŸ” íšŒì‚¬ëª…, ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰..." style="padding:7px 12px;border:1px solid #e2e6ed;border-radius:8px;font-size:12px;width:220px" oninput="filterCustomerTable(this.value)">
            <button class="btn btn-secondary btn-sm" id="colSettingsBtn" onclick="toggleColSettings()" title="ì»¬ëŸ¼ ì„¤ì •" style="font-size:13px;padding:6px 10px;border-radius:8px">âš™ï¸</button>
            <div id="colSettingsPanel" style="display:none;position:absolute;top:100%;right:40px;margin-top:4px;background:#fff;border:1px solid #e2e6ed;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:50;width:240px;max-height:400px;overflow-y:auto;padding:12px"></div>
            <button class="btn btn-primary" onclick="location.href='companyRegForm_v2.html'">+ ì‹ ê·œ ë“±ë¡</button>
          </div>
        </div>
        <div class="card-bd" style="padding:0;overflow-x:auto">
          <table class="tbl" id="customerTable">
            <thead id="customerThead"><tr><!-- ë™ì  ë Œë”ë§ --></tr></thead>
            <tbody id="customerTbody"><!-- ë™ì  ë Œë”ë§ --></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== ì—…ì²´ì¡°íšŒ (ì§€ë„ ë“œë¦´ë‹¤ìš´ + ì¹´ì¹´ì˜¤ + ì‹ì•½ì²˜) ===== -->
    <div class="page" id="page-bizSearch" style="display:none">

      <!-- ìƒë‹¨: í˜„ì¬ ì„ íƒ ê²½ë¡œ (ë¸Œë ˆë“œí¬ëŸ¼) -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-bd" style="display:flex;align-items:center;gap:8px;padding:12px 20px;flex-wrap:wrap">
          <span style="font-size:15px">ğŸ—ºï¸</span>
          <b style="font-size:14px;color:#1a2332">ì—…ì²´ì¡°íšŒ</b>
          <span style="color:#c8d6e5">|</span>
          <div id="bizBreadcrumb" style="display:flex;align-items:center;gap:4px;font-size:13px">
            <span style="color:#1a73e8;font-weight:600;cursor:pointer" onclick="bizGoStep(0)">ì „êµ­</span>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <input id="bizQuickSearch" placeholder="ì—…ì²´ëª… ë¹ ë¥¸ê²€ìƒ‰..." style="padding:6px 12px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px;width:180px" onkeydown="if(event.key==='Enter')doBizQuickSearch()">
            <button class="btn btn-primary btn-sm" onclick="doBizQuickSearch()" style="padding:6px 12px">ğŸ”</button>
          </div>
        </div>
      </div>

      <!-- STEP 0: ì „êµ­ ì‹œë„ ì§€ë„ (Leaflet + VWORLD) -->
      <div id="bizStep0">
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <!-- ì§€ë„ ì˜ì—­ -->
          <div class="card" style="flex:1;min-width:480px">
            <div class="card-hd"><h3>ğŸ—ºï¸ ì‹œ/ë„ ì„ íƒ</h3><div class="right" style="font-size:11px;color:#8892a4">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒ</div></div>
            <div class="card-bd" style="padding:0">
              <div id="fssLoadStatus" style="display:none;padding:8px 16px;background:#fff3e0;border-bottom:1px solid #ffe0b2;font-size:12px;color:#e65100">
                <span id="fssLoadText">â³ ì‹ì•½ì²˜ ë°ì´í„° ë¡œë”© ì¤‘...</span>
                <div style="margin-top:4px;height:4px;background:#ffe0b2;border-radius:2px;overflow:hidden"><div id="fssLoadBar" style="height:100%;background:#fb8c00;width:0%;transition:width .3s"></div></div>
              </div>
              <div id="koreaMap" style="width:100%;height:calc(100vh - 200px);min-height:480px;border-radius:0 0 12px 12px"></div>
            </div>
          </div>
          <!-- ìš°ì¸¡ íŒ¨ë„ -->
          <div style="width:280px;flex-shrink:0;display:flex;flex-direction:column;gap:12px">
            <div class="card">
              <div class="card-hd"><h3>ğŸ“‹ ì¡°íšŒ ë°©ë²•</h3></div>
              <div class="card-bd" style="font-size:12px;color:#5f6b7a;line-height:2">
                <b>1ë‹¨ê³„</b> ì‹œ/ë„ ì„ íƒ (ì§€ë„ í´ë¦­)<br>
                <b>2ë‹¨ê³„</b> ì‹œ/êµ°/êµ¬ ì„ íƒ<br>
                <b>3ë‹¨ê³„</b> ì/ë©´/ë™ ì„ íƒ<br>
                <b>ê²°ê³¼</b> ì¹´ì¹´ì˜¤ë§µ + ì‹ì•½ì²˜ ë™ì‹œ ì¡°íšŒ<br>
                <div style="margin-top:8px;padding:8px;background:#e3f2fd;border-radius:6px;font-size:11px;color:#1565c0">
                  ğŸ’¡ ìš°ì¸¡ ìƒë‹¨ ë¹ ë¥¸ê²€ìƒ‰ìœ¼ë¡œ ì—…ì²´ëª… ì§ì ‘ ê²€ìƒ‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-hd"><h3>ğŸ”‘ API í‚¤ ì„¤ì •</h3></div>
              <div class="card-bd" style="font-size:11px">
                <label style="font-weight:600;color:#5f6b7a;margin-bottom:4px;display:block">ì‹ì•½ì²˜ (ì‹í’ˆì•ˆì „ë‚˜ë¼)</label>
                <input id="fssApiKey" placeholder="ì‹í’ˆì•ˆì „ë‚˜ë¼ ì¸ì¦í‚¤" style="font-size:11px;font-family:monospace;padding:7px;margin-bottom:8px" value="e5a1d9f07d6c4424a757">
                <label style="font-weight:600;color:#5f6b7a;margin-bottom:4px;display:block">VWORLD (êµ­í† ì§€ë¦¬ì •ë³´)</label>
                <input id="vworldApiKey" placeholder="VWORLD API í‚¤ (ì„ íƒ)" style="font-size:11px;font-family:monospace;padding:7px;margin-bottom:4px" onchange="applyMapTile()">
                <div style="font-size:10px;color:#8892a4;margin-bottom:6px">ë¯¸ì…ë ¥ ì‹œ OpenStreetMap ì‚¬ìš©</div>
                <div style="display:flex;gap:6px">
                  <a href="https://www.foodsafetykorea.go.kr/api/mypage/myPageUser.do" target="_blank" class="btn btn-secondary btn-sm" style="flex:1;font-size:10px;text-decoration:none;text-align:center">ì‹ì•½ì²˜ í‚¤ê´€ë¦¬</a>
                  <a href="https://www.vworld.kr/dev/v4dv_apikey_s001.do" target="_blank" class="btn btn-secondary btn-sm" style="flex:1;font-size:10px;text-decoration:none;text-align:center">VWORLD ë°œê¸‰</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 1: ì‹œêµ°êµ¬ ì„ íƒ (ì§€ë„ + ë²„íŠ¼) -->
      <div id="bizStep1" style="display:none">
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:400px">
            <div class="card-hd">
              <h3 id="step1Title">ğŸ™ï¸ ì‹œ/êµ°/êµ¬ ì„ íƒ</h3>
              <div class="right"><button class="btn btn-secondary btn-sm" onclick="bizGoStep(0)">â† ì‹œ/ë„ ë‹¤ì‹œ ì„ íƒ</button></div>
            </div>
            <div class="card-bd" style="padding:0">
              <div id="sgMap" style="width:100%;height:calc(100vh - 220px);min-height:420px"></div>
            </div>
          </div>
          <div class="card" style="width:260px;flex-shrink:0">
            <div class="card-hd"><h3>ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ</h3></div>
            <div class="card-bd" style="max-height:calc(100vh - 260px);overflow-y:auto">
              <div id="sigunguGrid" style="display:flex;flex-wrap:wrap;gap:6px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 2: ìë©´ë™ ì„ íƒ (ì§€ë„ + ë²„íŠ¼) -->
      <div id="bizStep2" style="display:none">
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:400px">
            <div class="card-hd">
              <h3 id="step2Title">ğŸ˜ï¸ ì/ë©´/ë™ ì„ íƒ</h3>
              <div class="right">
                <button class="btn btn-secondary btn-sm" onclick="bizGoStep(1)" style="margin-right:6px">â† ì‹œ/êµ°/êµ¬</button>
                <button class="btn btn-primary btn-sm" onclick="doRegionSearch()">ğŸ” ì‹œ/êµ°/êµ¬ ì „ì²´ ê²€ìƒ‰</button>
              </div>
            </div>
            <div class="card-bd" style="padding:0">
              <div id="dongMap" style="width:100%;height:calc(100vh - 220px);min-height:420px"></div>
            </div>
          </div>
          <div class="card" style="width:240px;flex-shrink:0">
            <div class="card-hd"><h3>ğŸ“‹ ëª©ë¡ì—ì„œ ì„ íƒ</h3></div>
            <div class="card-bd" style="max-height:calc(100vh - 260px);overflow-y:auto">
              <div id="dongGrid" style="display:flex;flex-wrap:wrap;gap:6px"></div>
              <div id="dongLoading" style="text-align:center;padding:20px;color:#8892a4;display:none">â³ ì/ë©´/ë™ ë¡œë”© ì¤‘...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 3: ì‹ì•½ì²˜ ê²°ê³¼ ëª©ë¡ -->
      <div id="bizStep3" style="display:none">
        <div class="card" style="margin-bottom:16px">
          <div class="card-hd">
            <h3 id="fssResultTitle">ğŸ­ ì‹ì•½ì²˜ ì¸í—ˆê°€ ì—…ì²´ ëª©ë¡</h3>
            <div class="right">
              <span id="bizFssCount" style="font-size:22px;font-weight:700;color:#2e7d32;margin-right:12px">0</span>
              <span style="font-size:12px;color:#8892a4;margin-right:16px">ê±´</span>
              <button class="btn btn-secondary btn-sm" onclick="bizGoStep(0)">ğŸ—ºï¸ ìƒˆë¡œ ê²€ìƒ‰</button>
            </div>
          </div>
          <div class="card-bd" style="padding:0;overflow-x:auto">
            <table class="tbl">
              <thead><tr><th>ì—…ì²´ëª…</th><th>ëŒ€í‘œì</th><th>ì—…ì¢…</th><th>ì¸í—ˆê°€ë²ˆí˜¸</th><th>ì†Œì¬ì§€</th><th>ê´€í• ê´€ì²­</th><th></th></tr></thead>
              <tbody id="fssTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <!-- ===== ê³ ê°ì‚¬ ë“±ë¡ ===== -->
    <div class="page" id="page-customerReg" style="display:none">
      <div style="margin-bottom:16px"><button class="btn btn-secondary btn-sm" onclick="showPage('customerList')">â† ëª©ë¡ìœ¼ë¡œ</button></div>
      <div class="card"><div class="card-bd" style="max-width:860px">

        <!-- ì‚¬ì—…ìë“±ë¡ì¦ OCR ì—…ë¡œë“œ -->
        <div style="background:linear-gradient(135deg,#e8f5e9 0%,#f1f8e9 100%);border:2px solid #c8e6c9;border-radius:12px;padding:20px;margin-bottom:20px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <span style="font-size:20px">ğŸ“„</span>
            <div>
              <div style="font-size:14px;font-weight:700;color:#2e7d32">ì‚¬ì—…ìë“±ë¡ì¦ OCR ìë™ì…ë ¥</div>
              <div style="font-size:11px;color:#558b2f">ì‚¬ì—…ìë“±ë¡ì¦ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ë³¸ì •ë³´ + ì£¼ì†Œê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</div>
            </div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="file-area" id="bizLicFileArea" style="flex:1;padding:14px;position:relative" onclick="document.getElementById('bizLicFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#43a047';this.style.background='#e8f5e9'" ondragleave="this.style.borderColor='#c8e6c9';this.style.background='transparent'" ondrop="event.preventDefault();this.style.borderColor='#c8e6c9';this.style.background='transparent';handleBizLicFile(event.dataTransfer.files[0])">
              <input type="file" id="bizLicFileInput" accept="image/*,.pdf" style="display:none" onchange="handleBizLicFile(this.files[0])">
              <span id="bizLicFileName">ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ (JPG, PNG, PDF)</span>
            </div>
            <button class="btn btn-success btn-sm" id="bizLicOcrBtn" onclick="runBizLicOCR()" disabled style="white-space:nowrap;padding:12px 16px">ğŸ¤– OCR ì¸ì‹</button>
          </div>
          <div id="bizLicOcrStatus" style="margin-top:8px;font-size:11px;color:#558b2f;display:none"></div>
          <div id="bizLicPreview" style="margin-top:10px;display:none"><img id="bizLicPreviewImg" style="max-width:100%;max-height:200px;border-radius:8px;border:1px solid #c8e6c9"></div>
        </div>

        <div class="sec-title"><span class="sec-num">1</span> ê¸°ë³¸ ì •ë³´</div>
        <div class="fg-row">
          <div class="fg"><label>ë²•ì¸ ì—¬ë¶€ <span class="req">*</span></label><div class="radio-group"><label class="radio-item"><input type="radio" name="corp" id="regCorpYes" value="ë²•ì¸" checked> ë²•ì¸</label><label class="radio-item"><input type="radio" name="corp" id="regCorpIndiv" value="ê°œì¸"> ê°œì¸</label></div></div>
          <div class="fg"><label>ê±°ë˜ì²˜ ë“±ê¸‰</label><select id="regGrade"><option>ë“±ê¸‰ ì„ íƒ</option><option>VIP</option><option>A</option><option>B</option><option>C</option></select></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>íšŒì‚¬ëª… <span class="req">*</span></label><div class="combo"><input id="regCompany" placeholder="ì˜ˆ: (ì£¼)ë°”ì´ì˜¤í‘¸ë“œë©"><button class="btn btn-check btn-sm" onclick="demoCompanyDup()">ì¤‘ë³µ í™•ì¸</button></div><div class="check-result" id="compChk"></div></div>
          <div class="fg"><label>ëŒ€í‘œìëª… <span class="req">*</span></label><input id="regRepName" placeholder="ëŒ€í‘œì ì´ë¦„"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì‚¬ì—…ìë²ˆí˜¸ <span class="req">*</span></label><div class="combo"><input id="regBizNo" placeholder="000-00-00000" maxlength="12" oninput="fmtBiz(this)"><button class="btn btn-check btn-sm" onclick="toast('âœ… ì¤‘ë³µ ì—†ìŒ')">ì¤‘ë³µ í™•ì¸</button></div></div>
          <div class="fg"><label>ë²•ì¸ë²ˆí˜¸ <span class="req">*</span></label><input id="regCorpNo" placeholder="000000-0000000" maxlength="14"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì—…íƒœ <span class="req">*</span></label><input id="regBizType" placeholder="ì˜ˆ: ì œì¡°ì—…"></div>
          <div class="fg"><label>ì¢…ëª© <span class="req">*</span></label><input id="regBizItem" placeholder="ì˜ˆ: ì‹í’ˆ"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ê³„ì•½ ìƒíƒœ</label><select id="regStatus"><option selected>í™œë™</option><option>íœ´ë©´</option><option>í•´ì§€</option></select></div>
          <div class="fg"><label>ì‹ í˜¸ë“±</label><div style="display:flex;align-items:center;gap:6px;padding:8px 0"><span class="tl tl-blue"></span><span style="font-size:11px;color:#5f6b7a">íŒŒë‘ (ì‹ ê·œ ë“±ë¡ ì‹œ ê¸°ë³¸ê°’)</span></div></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ë‹´ë‹¹ë¶€ì„œ</label><select id="regDepartment"><option value="">ì„ íƒ</option><option>ê³ ê°ì§€ì›íŒ€</option><option>ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€</option><option>ê³ ê°ê´€ë¦¬</option><option>ì§€ì‚¬</option></select></div>
          <div class="fg"><label>ì ‘ìˆ˜í˜•íƒœ</label><select id="regReceiptType"><option value="">ì„ íƒ</option><option>í™ˆí˜ì´ì§€ì ‘ìˆ˜</option><option>ë°©ë¬¸ì ‘ìˆ˜</option><option>íƒë°°ì ‘ìˆ˜</option></select></div>
        </div>

        <div class="sec-title"><span class="sec-num">2</span> ì£¼ì†Œ</div>
        <div class="fg"><label>ì£¼ì†Œ <span class="req">*</span></label><div class="addr-row"><input id="regZipcode" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px" readonly><button class="btn btn-secondary btn-sm" onclick="openPostcodeSearch()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div></div>
        <div class="fg"><input id="regAddr1" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìë™ì…ë ¥)" readonly></div>
        <div class="fg"><input id="regAddr2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"></div>

        <!-- ì‚¬ì—…ìë“±ë¡ì¦ ì˜ë¬¸ ì •ë³´ (ì ‘ì´ì‹) -->
        <div class="eng-toggle" onclick="toggleEngSection('bizEngSection')" style="margin-top:12px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">
          <span id="bizEngArrow" style="transition:transform .2s;display:inline-block">â–¶</span> ì‚¬ì—…ìë“±ë¡ì¦ (ì˜ë¬¸ ì •ë³´)
        </div>
        <div id="bizEngSection" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed;margin-bottom:8px">
          <div class="fg"><label>Company Name (EN)</label><input id="regCompanyNameEn" placeholder="Company name in English"></div>
          <div class="fg"><label>Representative (EN)</label><input id="regRepNameEn" placeholder="Representative name in English"></div>
          <div class="fg"><label>Address (EN)</label><input id="regAddrEn" placeholder="Address in English (auto-converted)"></div>
        </div>

        <div class="sec-title"><span class="sec-num">3</span> ì¸í—ˆê°€ ì •ë³´ <span style="margin-left:auto;font-size:11px;color:#8892a4;font-weight:400">ì—¬ëŸ¬ ê°œ ë“±ë¡ ê°€ëŠ¥</span></div>
        <div id="licenseArea">
          <div class="sub-card" id="licCard_1">
            <div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">1</span> ì¸í—ˆê°€</div></div>
            <div class="fg-row">
              <div class="fg"><label>ë¶„ì•¼ <span class="req">*</span></label><select id="licField_1"><option>ì„ íƒ</option><option>ì‹í’ˆ</option><option>ì¶•ì‚°</option></select></div>
              <div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ <span class="req">*</span></label><div class="combo"><select id="licBizForm_1"><option>ì„ íƒ</option><option>ì‹í’ˆì œì¡°ê°€ê³µì—…</option><option>ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</option><option>ì‹í’ˆì†Œë¶„ì—…</option><option>ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì¶•ì‚°ë¬¼ê°€ê³µì—…</option><option>ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</option><option value="etc">âœï¸ ì§ì ‘ ì…ë ¥</option></select></div></div>
            </div>
            <div class="fg-row">
              <div class="fg"><label>ëŒ€í‘œì <span class="req">*</span></label><input id="licRepName_1" placeholder="ì¸í—ˆê°€ ëŒ€í‘œì"></div>
              <div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸ <span class="req">*</span></label><input id="licNo_1" placeholder="ì¸í—ˆê°€ë²ˆí˜¸"></div>
            </div>
            <div class="fg-row">
              <div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­ <span class="req">*</span></label><input id="licBizName_1" placeholder="ì˜ì—…ì†Œ ëª…ì¹­"></div>
            </div>
            <div class="fg"><label>ì†Œì¬ì§€ <span class="req">*</span></label>
              <div class="addr-row"><input id="licZipcode_1" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px" readonly><button class="btn btn-secondary btn-sm" onclick="openLicPostcodeSearch(1)">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>
            </div>
            <div class="fg"><input id="licAddr_1" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìë™ì…ë ¥)" readonly></div>
            <div class="fg"><input id="licAddr2_1" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"></div>
            <div class="fg"><label>ì¸í—ˆê°€ ë¬¸ì„œ ì²¨ë¶€</label>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="file-area" id="licFileArea_1" style="flex:1;padding:10px;position:relative" onclick="document.getElementById('licFileInput_1').click()" ondragover="event.preventDefault();this.style.borderColor='#1a73e8'" ondragleave="this.style.borderColor='#e2e6ed'" ondrop="event.preventDefault();this.style.borderColor='#e2e6ed';handleLicFile(1,event.dataTransfer.files[0])">
                  <input type="file" id="licFileInput_1" accept="image/*,.pdf" style="display:none" onchange="handleLicFile(1,this.files[0])">
                  <span id="licFileName_1">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span>
                </div>
                <button class="btn btn-check btn-sm" id="licOcrBtn_1" onclick="runLicOCR(1)" disabled style="white-space:nowrap">ğŸ¤– OCR ì¸ì‹</button>
              </div>
              <div id="licOcrStatus_1" style="margin-top:4px;font-size:11px;color:#1565c0;display:none"></div>
            </div>
            <!-- ì¸í—ˆê°€ ì˜ë¬¸ ì •ë³´ (ì ‘ì´ì‹) -->
            <div class="eng-toggle" onclick="toggleEngSection('licEngSection_1')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">
              <span id="licEngArrow_1" style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)
            </div>
            <div id="licEngSection_1" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">
              <div class="fg"><label>Business Name (EN)</label><input id="licBizNameEn_1" placeholder="Business name in English"></div>
              <div class="fg"><label>Representative (EN)</label><input id="licRepNameEn_1" placeholder="Representative name in English"></div>
              <div class="fg"><label>Address (EN)</label><input id="licAddrEn_1" placeholder="Address in English (auto-converted)"></div>
            </div>
          </div>
        </div>
        <button class="btn-add" onclick="addLicenseCard()">+ ì¸í—ˆê°€ ì •ë³´ ì¶”ê°€</button>

        <div class="sec-title"><span class="sec-num">4</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì <span style="margin-left:auto;font-size:11px;color:#8892a4;font-weight:400">ì—¬ëŸ¬ ëª… ë“±ë¡ ê°€ëŠ¥</span></div>
        <div id="contactArea">
          <div class="sub-card">
            <div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">1</span> ë‹´ë‹¹ì</div></div>
            <div class="fg-row3">
              <div class="fg"><label>ì´ë¦„ <span class="req">*</span></label><input id="regCName" placeholder="ë‹´ë‹¹ì ì´ë¦„"></div>
              <div class="fg"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input id="regCPhone" placeholder="010-0000-0000" oninput="fmtPhone(this)"></div>
              <div class="fg"><label>ì´ë©”ì¼</label><input id="regCEmail" type="email" placeholder="email@example.com"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
              <button class="btn btn-check btn-sm" onclick="demoContactDup()">ğŸ” ì¤‘ë³µ í™•ì¸</button>
              <div class="check-result" id="cntChk"></div>
              <div style="margin-left:auto;display:flex;align-items:center;gap:6px;font-size:11px;color:#8892a4">
                ìì‚¬ ë‹´ë‹¹: <select id="regSalesRep" style="padding:5px 8px;border:1px solid #e2e6ed;border-radius:6px;font-size:11px"><option>ì„ íƒ</option><option>ë°•ì£¼ì„</option><option selected>ì´ì£¼ì„</option><option>ê¹€ì‚¬ì›</option></select>
              </div>
            </div>
          </div>
        </div>
        <button class="btn-add" onclick="toast('+ ë‹´ë‹¹ì ì¶”ê°€ë¨')">+ ë‹´ë‹¹ì ì¶”ê°€</button>

        <div class="sec-title"><span class="sec-num">5</span> ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì <button class="btn btn-check btn-sm" style="margin-left:auto" onclick="copyContactToTax()">ğŸ“‹ 1ë²ˆ ë‹´ë‹¹ì ë³µì‚¬</button></div>
        <div class="fg-row3">
          <div class="fg"><label>ì´ë¦„ <span class="req">*</span></label><input id="regTaxName" placeholder="ë‹´ë‹¹ì ì´ë¦„"></div>
          <div class="fg"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input id="regTaxPhone" placeholder="010-0000-0000" oninput="fmtPhone(this)"></div>
          <div class="fg"><label>ì´ë©”ì¼ <span class="req">*</span></label><input id="regTaxEmail" type="email" placeholder="ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì‹  ì´ë©”ì¼"></div>
        </div>

        <div class="sec-title"><span class="sec-num">6</span> ë©”ëª¨ / ë¹„ê³ </div>
        <div class="fg"><textarea id="regMemo" placeholder="íŠ¹ì´ì‚¬í•­, ê³„ì•½ ì¡°ê±´, ì°¸ê³ ì‚¬í•­ ë“±..."></textarea></div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px">
          <button class="btn btn-secondary" onclick="showPage('customerList')">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="saveCustomer()">âœ… ê³ ê°ì‚¬ ë“±ë¡</button>
        </div>
      </div></div>
    </div>

    <!-- ===== ê³ ê°ì‚¬ ìƒì„¸ ===== -->
    <div class="page" id="page-customerDetail" style="display:none">
      <div style="margin-bottom:16px"><button class="btn btn-secondary btn-sm" onclick="showPage('customerList')">â† ëª©ë¡ìœ¼ë¡œ</button></div>
      <div class="card"><div class="card-bd" style="max-width:900px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <h3 id="detailCompanyTitle" style="margin:0;font-size:18px"></h3>
          <span id="detailGradeTag"></span>
          <span id="detailStatusTag" style="margin-left:4px"></span>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn btn-primary btn-sm" id="detailEditBtn" onclick="toggleDetailEdit()">âœï¸ ìˆ˜ì •</button>
            <button class="btn btn-primary btn-sm" id="detailSaveBtn" onclick="saveDetailEdit()" style="display:none;background:#2e7d32;border-color:#2e7d32">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-secondary btn-sm" id="detailCancelBtn" onclick="cancelDetailEdit()" style="display:none">ì·¨ì†Œ</button>
          </div>
        </div>

        <!-- ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¬ì¸ì‹ -->
        <div style="background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);border:2px solid #90caf9;border-radius:12px;padding:16px;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <span style="font-size:18px">ğŸ”„</span>
            <div>
              <div style="font-size:13px;font-weight:700;color:#1565c0">ì‚¬ì—…ìë“±ë¡ì¦ / ì¸í—ˆê°€ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ì—…ë°ì´íŠ¸</div>
              <div style="font-size:11px;color:#5c6bc0">ë¬¸ì„œë¥¼ ì¬ì—…ë¡œë“œí•˜ë©´ ë³€ê²½ëœ ì •ë³´ê°€ ìë™ ë°˜ì˜ë˜ê³  ì´ë ¥ì´ ê¸°ë¡ë©ë‹ˆë‹¤</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="file-area" id="detailBizFileArea" style="flex:1;min-width:200px;padding:10px;position:relative" onclick="document.getElementById('detailBizFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#1565c0'" ondragleave="this.style.borderColor='#90caf9'" ondrop="event.preventDefault();this.style.borderColor='#90caf9';handleDetailBizFile(event.dataTransfer.files[0])">
              <input type="file" id="detailBizFileInput" accept="image/*,.pdf" style="display:none" onchange="handleDetailBizFile(this.files[0])">
              <span id="detailBizFileName" style="font-size:11px">ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼</span>
            </div>
            <button class="btn btn-primary btn-sm" id="detailBizOcrBtn" onclick="runDetailBizOCR()" disabled>ğŸ¤– ì‚¬ì—…ìë“±ë¡ì¦ OCR</button>
            <div class="file-area" id="detailLicFileArea" style="flex:1;min-width:200px;padding:10px;position:relative" onclick="document.getElementById('detailLicFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#1565c0'" ondragleave="this.style.borderColor='#90caf9'" ondrop="event.preventDefault();this.style.borderColor='#90caf9';handleDetailLicFile(event.dataTransfer.files[0])">
              <input type="file" id="detailLicFileInput" accept="image/*,.pdf" style="display:none" onchange="handleDetailLicFile(this.files[0])">
              <span id="detailLicFileName" style="font-size:11px">ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼</span>
            </div>
            <button class="btn btn-check btn-sm" id="detailLicOcrBtn" onclick="runDetailLicOCR()" disabled>ğŸ¤– ì¸í—ˆê°€ OCR</button>
          </div>
          <div id="detailOcrStatus" style="margin-top:6px;font-size:11px;color:#1565c0;display:none"></div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ / OCR ê²°ê³¼ ë³´ê¸° -->
        <div class="file-view-section" id="fileViewSection" style="display:none">
          <div class="file-view-title">ğŸ“‚ ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼</div>
          <div class="file-view-row" id="fileViewRow"></div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="sec-title"><span class="sec-num">1</span> ê¸°ë³¸ ì •ë³´</div>
        <div class="fg-row">
          <div class="fg"><label>íšŒì‚¬ëª…</label><input id="detCompany" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ëŒ€í‘œìëª…</label><input id="detRepName" readonly style="background:#f8f9fb"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì‚¬ì—…ìë²ˆí˜¸</label><div style="display:flex;gap:6px"><input id="detBizNo" readonly style="background:#f8f9fb;flex:1"><button class="btn btn-primary btn-sm" onclick="verifyBizRegistration()" style="background:#1565c0;color:#fff;white-space:nowrap;padding:6px 12px;font-size:11px;border:none;border-radius:6px;cursor:pointer">ì§„ìœ„í™•ì¸</button></div></div>
          <div class="fg"><label>ë²•ì¸ë²ˆí˜¸</label><input id="detCorpNo" readonly style="background:#f8f9fb"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì—…íƒœ</label><input id="detBizType" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ì¢…ëª©</label><input id="detBizItem" readonly style="background:#f8f9fb"></div>
        </div>
        <div class="sec-title"><span class="sec-num">2</span> ì£¼ì†Œ</div>
        <div class="fg"><label>ì†Œì¬ì§€</label>
          <div class="addr-row" style="margin-bottom:4px"><input id="detZipcode" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;background:#f8f9fb" readonly><button class="btn btn-secondary btn-sm detBizPostBtn" id="detBizPostBtn" onclick="openDetPostcodeSearch()" style="display:none">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>
        </div>
        <div class="fg"><input id="detAddr1" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly style="background:#f8f9fb"></div>
        <div class="fg"><input id="detAddr2" placeholder="ìƒì„¸ì£¼ì†Œ" readonly style="background:#f8f9fb"></div>
        <div class="eng-toggle" onclick="toggleEngSection('detBizEngSection')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">
          <span id="detBizEngArrow" style="transition:transform .2s;display:inline-block">â–¶</span> ì‚¬ì—…ìë“±ë¡ì¦ (ì˜ë¬¸ ì •ë³´)
        </div>
        <div id="detBizEngSection" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">
          <div class="fg"><label>Company Name (EN)</label><input id="detCompanyEn" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>Representative (EN)</label><input id="detRepNameEn" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>Address (EN)</label><input id="detAddrEn" readonly style="background:#f8f9fb"></div>
        </div>

        <!-- ì¸í—ˆê°€ ì •ë³´ (ë‹¤ì¤‘) -->
        <div class="sec-title"><span class="sec-num">3</span> ì¸í—ˆê°€ ì •ë³´</div>
        <div id="detLicenseContainer">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
        <button class="btn-add" id="detAddLicBtn" onclick="addDetailLicenseCard()" style="display:none">+ ì¸í—ˆê°€ ì •ë³´ ì¶”ê°€</button>

        <!-- ê³ ê°ì‚¬ ë‹´ë‹¹ì (ë‹¤ì¤‘) -->
        <div class="sec-title"><span class="sec-num">4</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì</div>
        <div id="detContactContainer">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
        <button class="btn-add" id="detAddContactBtn" onclick="addDetailContactCard()" style="display:none">+ ë‹´ë‹¹ì ì¶”ê°€</button>

        <!-- ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì -->
        <div class="sec-title"><span class="sec-num">5</span> ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì</div>
        <div class="fg-row" style="gap:8px">
          <div class="fg"><label>ì´ë¦„</label><input id="detTaxName" readonly style="background:#f8f9fb" class="det-editable"></div>
          <div class="fg"><label>ì „í™”ë²ˆí˜¸</label><input id="detTaxPhone" readonly style="background:#f8f9fb" class="det-editable"></div>
          <div class="fg"><label>íœ´ëŒ€í°</label><input id="detTaxMobile" readonly style="background:#f8f9fb" class="det-editable"></div>
          <div class="fg"><label>íŒ©ìŠ¤ë²ˆí˜¸</label><input id="detTaxFax" readonly style="background:#f8f9fb" class="det-editable"></div>
          <div class="fg"><label>ì´ë©”ì¼</label><input id="detTaxEmail" readonly style="background:#f8f9fb" class="det-editable"></div>
        </div>

        <!-- ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­ ëª¨ë‹¬ -->
        <div id="licContactMatchModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center">
          <div style="background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.2)">
            <div style="font-weight:700;font-size:16px;margin-bottom:12px">ğŸ”— ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­</div>
            <div style="font-size:13px;color:#5f6368;margin-bottom:16px" id="licMatchDesc">ì´ ë‹´ë‹¹ìë¥¼ ì¸í—ˆê°€ ë‹´ë‹¹ìë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div id="licMatchList" style="max-height:200px;overflow-y:auto;margin-bottom:16px"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-secondary btn-sm" onclick="closeLicMatchModal()" style="padding:6px 16px">ê±´ë„ˆë›°ê¸°</button>
              <button class="btn btn-primary btn-sm" onclick="applyLicMatch()" style="padding:6px 16px">ì ìš©</button>
            </div>
          </div>
        </div>

        <!-- ë©”ëª¨/ë¹„ê³  -->
        <div class="sec-title"><span class="sec-num">6</span> ë©”ëª¨ / ë¹„ê³ </div>
        <div class="fg"><textarea id="detMemo" readonly style="background:#f8f9fb;min-height:60px" placeholder="íŠ¹ì´ì‚¬í•­, ê³„ì•½ ì¡°ê±´, ì°¸ê³ ì‚¬í•­ ë“±..."></textarea></div>

        <!-- ë³€ê²½ ì´ë ¥ -->
        <div class="sec-title" style="margin-top:20px"><span class="sec-num">ğŸ“‹</span> ë³€ê²½ ì´ë ¥</div>
        <div id="changeLogArea" style="max-height:300px;overflow-y:auto">
          <table class="tbl" style="font-size:12px">
            <thead><tr><th style="width:140px">ì¼ì‹œ</th><th style="width:80px">ë³€ê²½ì</th><th>ë³€ê²½ ë‚´ìš©</th></tr></thead>
            <tbody id="changeLogTbody">
              <tr><td colspan="3" style="text-align:center;color:#8892a4;padding:20px">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
            </tbody>
          </table>
        </div>
      </div></div>
    </div>

    <!-- ===== ì—…ë¬´ì¼ì§€ - ëª©ë¡ ===== -->
    <div class="page" id="page-daily" style="display:none">
      <!-- ìš”ì•½ í†µê³„ -->
      <div class="stats">
        <div class="stat"><div class="stat-val" style="color:#1565c0">12</div><div class="stat-label">ì´ë²ˆ ì£¼ ì‘ì„±</div></div>
        <div class="stat"><div class="stat-val" style="color:#2e7d32">8</div><div class="stat-label">ë°©ë¬¸ ê±´ìˆ˜</div></div>
        <div class="stat"><div class="stat-val" style="color:#1a2332">9,680,000</div><div class="stat-label">ì´ë²ˆ ì£¼ ë§¤ì¶œí•©ê³„</div></div>
        <div class="stat"><div class="stat-val" style="color:#7b1fa2">2</div><div class="stat-label">ì‹ ê·œì˜ì—… í™œë™</div></div>
      </div>

      <div class="card">
        <div class="card-hd">
          <h3>ğŸ“ ì—…ë¬´ì¼ì§€</h3>
          <div class="right">
            <span style="font-size:11px;color:#8892a4;margin-right:8px">ì˜ì—…ë¶€ë§Œ ì‘ì„± Â· ë¶€ì„œì› ì¡°íšŒ ê°€ëŠ¥</span>
            <button class="btn btn-primary" onclick="showPage('dailyWrite')">+ ì—…ë¬´ì¼ì§€ ì‘ì„±</button>
          </div>
        </div>
        <!-- í•„í„° ì˜ì—­ -->
        <div style="padding:14px 20px;border-bottom:1px solid #eef0f4;display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:#fafbfc">
          <div class="fg" style="margin:0;flex-shrink:0">
            <input type="date" value="2026-02-10" style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px">
          </div>
          <span style="color:#c8d6e5">~</span>
          <div class="fg" style="margin:0;flex-shrink:0">
            <input type="date" value="2026-02-13" style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px">
          </div>
          <select style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px;background:#fff;cursor:pointer">
            <option>ì „ì²´ ì‘ì„±ì</option>
            <option selected>ì´ì£¼ì„</option>
            <option>ê¹€ì˜ì—…</option>
            <option>ë°•ì² ìˆ˜</option>
          </select>
          <select style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px;background:#fff;cursor:pointer">
            <option>ì „ì²´ ì‹œë£Œìˆ˜ê±°</option>
            <option>ë°©ë¬¸</option>
            <option>íƒë°°Â·í€µ</option>
            <option>ë‚´ë°©</option>
          </select>
          <input placeholder="ì—…ì²´ëª… ê²€ìƒ‰..." style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px;width:160px">
          <button class="btn btn-secondary btn-sm" onclick="toast('ğŸ” ê²€ìƒ‰ ì™„ë£Œ')">ê²€ìƒ‰</button>
        </div>
        <!-- í…Œì´ë¸” -->
        <div class="card-bd" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead><tr><th style="width:40px;text-align:center">ğŸ“</th><th>ë‚ ì§œ</th><th>ì‘ì„±ì</th><th>ì—…ì²´ëª…</th><th>ì‹œë£Œìˆ˜ê±°</th><th style="text-align:right">ë§¤ì¶œ(VATí¬í•¨)</th><th>íŠ¹ì´ì‚¬í•­</th><th>ì‹ ê·œì˜ì—…</th><th>ìµì¼ê³„íš</th><th style="width:60px"></th></tr></thead>
            <tbody>
              <tr onclick="showPage('dailyDetail')" style="cursor:pointer">
                <td class="center">ğŸ“„</td>
                <td><b>2026-02-13</b></td><td>ì´ì£¼ì„</td><td><b>CJì œì¼ì œë‹¹(ì£¼)</b></td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ë°©ë¬¸</span> <span style="font-size:10px;color:#1565c0">ğŸš—</span></td>
                <td style="text-align:right;font-weight:600">2,200,000</td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ì‹ ì œí’ˆ ì¶œì‹œ ê´€ë ¨ ì¶”ê°€ ê²€ì‚¬ ìš”ì²­</td>
                <td>-</td>
                <td style="font-size:11px;color:#5f6b7a">ë†ì‹¬ íƒë°° ì ‘ìˆ˜ ì˜ˆì •</td>
                <td class="center"><span style="cursor:pointer;font-size:14px" title="ìƒì„¸ë³´ê¸°">ğŸ‘ï¸</span></td>
              </tr>
              <tr style="cursor:pointer" onclick="showPage('dailyDetail')">
                <td class="center">ğŸ“„</td>
                <td><b>2026-02-13</b></td><td>ì´ì£¼ì„</td><td><b>(ì£¼)ë†ì‹¬</b></td>
                <td><span class="tag" style="background:#e8f5e9;color:#2e7d32">íƒë°°Â·í€µ</span></td>
                <td style="text-align:right;font-weight:600">880,000</td>
                <td>-</td><td>-</td>
                <td style="font-size:11px;color:#5f6b7a">-</td>
                <td class="center"><span style="cursor:pointer;font-size:14px">ğŸ‘ï¸</span></td>
              </tr>
              <tr style="cursor:pointer" onclick="showPage('dailyDetail')">
                <td class="center">ğŸ“„</td>
                <td>2026-02-12</td><td>ì´ì£¼ì„</td><td><b>ë™ì›F&B(ì£¼)</b></td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ë°©ë¬¸</span> <span style="font-size:10px;color:#1565c0">ğŸš—</span></td>
                <td style="text-align:right;font-weight:600">1,500,000</td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ê²½ìŸì‚¬ ê²¬ì  ë¹„êµ ìš”ì²­ â€” Aì‚¬ ê°€ê²© ë¹„êµ ìë£Œ ìš”ì²­</td>
                <td>-</td>
                <td style="font-size:11px;color:#5f6b7a">CJ ë°©ë¬¸ ì˜ˆì •</td>
                <td class="center"><span style="cursor:pointer;font-size:14px">ğŸ‘ï¸</span></td>
              </tr>
              <tr style="cursor:pointer" onclick="showPage('dailyDetail')">
                <td class="center">ğŸ“„</td>
                <td>2026-02-12</td><td>ì´ì£¼ì„</td><td><b>(ì‹ ê·œ) í•˜ë¦¼ê·¸ë£¹</b></td>
                <td><span class="tag" style="background:#f3e5f5;color:#7b1fa2">ë‚´ë°©</span></td>
                <td style="text-align:right;color:#8892a4">-</td>
                <td>-</td>
                <td style="color:#7b1fa2;font-weight:600">ì‹í’ˆì•ˆì „íŒ€ ë¯¸íŒ…</td>
                <td style="font-size:11px;color:#5f6b7a">ê²¬ì ì„œ ë°œì†¡</td>
                <td class="center"><span style="cursor:pointer;font-size:14px">ğŸ‘ï¸</span></td>
              </tr>
              <tr style="cursor:pointer" onclick="showPage('dailyDetail')">
                <td class="center">ğŸ“„</td>
                <td>2026-02-11</td><td>ì´ì£¼ì„</td><td><b>CJì œì¼ì œë‹¹(ì£¼)</b></td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ë°©ë¬¸</span> <span style="font-size:10px;color:#1565c0">ğŸš—</span></td>
                <td style="text-align:right;font-weight:600">3,100,000</td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ë°˜ê¸° ê³„ì•½ ê°±ì‹  ë…¼ì˜</td>
                <td>-</td>
                <td style="font-size:11px;color:#5f6b7a">ë™ì›F&B ë°©ë¬¸</td>
                <td class="center"><span style="cursor:pointer;font-size:14px">ğŸ‘ï¸</span></td>
              </tr>
              <tr style="cursor:pointer" onclick="showPage('dailyDetail')">
                <td class="center">ğŸ“„</td>
                <td>2026-02-11</td><td>ê¹€ì˜ì—…</td><td><b>í’€ë¬´ì›ì‹í’ˆ(ì£¼)</b></td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ë°©ë¬¸</span> <span style="font-size:10px;color:#1565c0">ğŸš—</span></td>
                <td style="text-align:right;font-weight:600">1,800,000</td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">ë¯¸ìˆ˜ê¸ˆ ê±´ ìˆ˜ê¸ˆ í™œë™ ë³‘í–‰</td>
                <td>-</td>
                <td style="font-size:11px;color:#5f6b7a">ì„œìš¸ìœ í†µ ìˆ˜ê¸ˆ ì „í™”</td>
                <td class="center"><span style="cursor:pointer;font-size:14px">ğŸ‘ï¸</span></td>
              </tr>
              <tr style="cursor:pointer" onclick="showPage('dailyDetail')">
                <td class="center">ğŸ“„</td>
                <td>2026-02-10</td><td>ì´ì£¼ì„</td><td><b>ì˜¤ëšœê¸°(ì£¼)</b></td>
                <td><span class="tag" style="background:#e8f5e9;color:#2e7d32">íƒë°°Â·í€µ</span></td>
                <td style="text-align:right;font-weight:600">650,000</td>
                <td>-</td><td>-</td>
                <td style="font-size:11px;color:#5f6b7a">CJ ê³„ì•½ ê°±ì‹  ë…¼ì˜</td>
                <td class="center"><span style="cursor:pointer;font-size:14px">ğŸ‘ï¸</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div style="padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid #eef0f4">
          <span style="font-size:11px;color:#8892a4">ì´ 7ê±´ (1/1 í˜ì´ì§€)</span>
          <div style="display:flex;gap:4px">
            <button class="btn btn-secondary btn-sm" disabled>â† ì´ì „</button>
            <button class="btn btn-sm" style="background:#1a73e8;color:#fff;border:none;border-radius:6px;min-width:28px">1</button>
            <button class="btn btn-secondary btn-sm" disabled>ë‹¤ìŒ â†’</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ì—…ë¬´ì¼ì§€ - ì‘ì„± í¼ ===== -->
    <div class="page" id="page-dailyWrite" style="display:none">
      <div style="margin-bottom:16px"><button class="btn btn-secondary btn-sm" onclick="showPage('daily')">â† ëª©ë¡ìœ¼ë¡œ</button></div>
      <div class="card"><div class="card-bd" style="max-width:860px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <h3 style="font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px">ğŸ“ ì—…ë¬´ì¼ì§€ ì‘ì„±</h3>
          <span style="font-size:11px;color:#8892a4">ì‘ì„±ì: ì´ì£¼ì„ (ì˜ì—…ë¶€) Â· 2026-02-13</span>
        </div>

        <div class="sec-title"><span class="sec-num">1</span> ê¸°ë³¸ ì •ë³´</div>
        <div class="fg-row">
          <div class="fg"><label>ë‚ ì§œ <span class="req">*</span></label><input type="date" value="2026-02-13"></div>
          <div class="fg"><label>ì—…ì²´ëª… <span class="req">*</span></label>
            <div class="combo">
              <select id="dailyCompany" onchange="dailyCompanyChange(this)">
                <option>ì—…ì²´ ì„ íƒ...</option>
                <option>CJì œì¼ì œë‹¹(ì£¼)</option>
                <option>(ì£¼)ë†ì‹¬</option>
                <option>ë™ì›F&B(ì£¼)</option>
                <option>í’€ë¬´ì›ì‹í’ˆ(ì£¼)</option>
                <option>ì˜¤ëšœê¸°(ì£¼)</option>
                <option value="_new">âœï¸ ì‹ ê·œ ì—…ì²´ ì§ì ‘ ì…ë ¥</option>
              </select>
            </div>
            <input id="dailyCompanyNew" placeholder="ì‹ ê·œ ì—…ì²´ëª… ì…ë ¥" style="display:none;margin-top:6px;padding:9px 12px;border:1px solid #e2e6ed;border-radius:8px;font-size:13px;width:100%">
          </div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì‹œë£Œìˆ˜ê±° ë°©ë²• <span class="req">*</span></label>
            <select id="dailySample" onchange="dailySampleChange(this)">
              <option value="">ì„ íƒ...</option>
              <option value="visit">ë°©ë¬¸</option>
              <option value="delivery">íƒë°°Â·í€µ</option>
              <option value="walkin">ë‚´ë°©</option>
            </select>
          </div>
          <div class="fg"><label>ë§¤ì¶œ (VAT í¬í•¨)</label><input type="text" placeholder="ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 2200000)" oninput="fmtMoney(this)"></div>
        </div>

        <!-- ë°©ë¬¸ ì‹œ ì°¨ëŸ‰ì¼ì§€ ì—°ë™ ì•ˆë‚´ -->
        <div id="dailyVehicleNotice" style="display:none;background:#e3f2fd;border:1px solid #bbdefb;border-radius:10px;padding:14px;margin:8px 0 16px;font-size:12px;color:#1565c0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
            <span style="font-size:16px">ğŸš—</span>
            <b>ì°¨ëŸ‰ì¼ì§€ ìë™ ì—°ë™</b>
            <span style="font-size:10px;background:#bbdefb;padding:2px 8px;border-radius:4px;margin-left:auto">ì¹´ì¹´ì˜¤ëª¨ë¹Œë¦¬í‹° ê¸¸ì°¾ê¸° API</span>
          </div>

          <div class="fg-row" style="margin-bottom:8px">
            <div class="fg" style="margin:0"><label style="color:#1565c0">ì¶œë°œì§€ <span class="req">*</span></label>
              <select id="vStartType" onchange="calcRoutePreview()" style="border-color:#90caf9">
                <option value="office">ğŸ¢ íšŒì‚¬ (ê¸°ë³¸)</option>
                <option value="home">ğŸ  í˜„ì§€ì¶œê·¼ (ìíƒ)</option>
              </select>
            </div>
            <div class="fg" style="margin:0"><label style="color:#1565c0">ë°©ë¬¸ì§€ (ì—…ì²´ ì£¼ì†Œ ìë™)</label>
              <input id="vDestPreview" value="ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ (CJì œì¼ì œë‹¹)" style="background:#e3f2fd;border-color:#90caf9" readonly>
            </div>
          </div>
          <div class="fg-row" style="margin-bottom:8px">
            <div class="fg" style="margin:0"><label style="color:#1565c0">ë„ì°©ì§€ <span class="req">*</span></label>
              <select id="vEndType" onchange="calcRoutePreview()" style="border-color:#90caf9">
                <option value="office">ğŸ¢ íšŒì‚¬ (ê¸°ë³¸)</option>
                <option value="home">ğŸ  ìíƒ (í‡´ê·¼)</option>
              </select>
            </div>
            <div class="fg" style="margin:0"><label style="color:#1565c0">ì˜ˆìƒ ì£¼í–‰ê±°ë¦¬</label>
              <div style="display:flex;align-items:center;gap:8px">
                <input id="vDistPreview" type="number" value="42" style="border-color:#90caf9;width:100px;text-align:right;font-weight:700;font-size:15px">
                <span style="font-weight:600">km</span>
                <span style="font-size:10px;color:#1565c0;background:#bbdefb;padding:2px 6px;border-radius:4px" id="vDistLabel">API ìë™ê³„ì‚°</span>
              </div>
              <div class="hint" style="color:#1565c0;margin-top:4px">ğŸ’¡ ìë™ ê³„ì‚° í›„ ìˆ˜ë™ ì¡°ì • ê°€ëŠ¥ (í‡´ê·¼ ê±°ë¦¬, ìš°íšŒ ë“±)</div>
            </div>
          </div>

          <!-- ê²½ìœ ì§€ ì¶”ê°€ -->
          <div id="vWaypointArea"></div>
          <button type="button" style="display:flex;align-items:center;gap:6px;padding:6px 12px;border:1px dashed #90caf9;border-radius:6px;background:transparent;color:#1565c0;font-size:11px;font-weight:600;cursor:pointer;margin-top:6px" onclick="addWaypoint()">+ ê²½ìœ ì§€ ì¶”ê°€</button>
        </div>

        <div class="sec-title"><span class="sec-num">2</span> ì—…ë¬´ ìƒì„¸</div>
        <div class="fg"><label>íŠ¹ì´ì‚¬í•­</label><textarea placeholder="ë°©ë¬¸ ë˜ëŠ” ì ‘ìˆ˜ ê´€ë ¨ íŠ¹ì´ì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”.&#10;ì˜ˆ: ì‹ ì œí’ˆ ì¶œì‹œ ê´€ë ¨ ì¶”ê°€ ê²€ì‚¬ ìš”ì²­, ë‹¨ê°€ í˜‘ì˜ í•„ìš” ë“±"></textarea></div>
        <div class="fg"><label>ê²½ìŸì‚¬ ë™í–¥</label><textarea placeholder="ê²½ìŸì‚¬ ê´€ë ¨ ì •ë³´ê°€ ìˆë‹¤ë©´ ì‘ì„±í•˜ì„¸ìš”.&#10;ì˜ˆ: Aê²€ì‚¬ê¸°ê´€ì—ì„œ 5% ì €ë ´í•œ ë‹¨ê°€ ì œì‹œ, Bê¸°ê´€ ì‹ ê·œ ì„œë¹„ìŠ¤ ì‹œì‘ ë“±" style="min-height:50px"></textarea></div>
        <div class="fg"><label>ê±´ì˜ì‚¬í•­</label><textarea placeholder="íšŒì‚¬ì— ê±´ì˜í•  ì‚¬í•­ì´ ìˆë‹¤ë©´ ì‘ì„±í•˜ì„¸ìš”.&#10;ì˜ˆ: ì‹ ê·œ ê²€ì‚¬ í•­ëª© ë„ì… í•„ìš”, ì¥ë¹„ ì¶”ê°€ ìš”ì²­ ë“±" style="min-height:50px"></textarea></div>

        <div class="sec-title"><span class="sec-num">3</span> ì˜ì—… í™œë™</div>
        <div class="fg"><label>ì‹ ê·œì˜ì—… í™œë™</label><textarea placeholder="ì‹ ê·œ ì˜ì—… ê´€ë ¨ í™œë™ì´ ìˆë‹¤ë©´ ì‘ì„±í•˜ì„¸ìš”.&#10;ì˜ˆ: í•˜ë¦¼ê·¸ë£¹ ì‹í’ˆì•ˆì „íŒ€ ë¯¸íŒ… â€” ì œì•ˆì„œ ì „ë‹¬, ê²¬ì ì„œ ë°œì†¡ ì˜ˆì •" style="min-height:50px"></textarea></div>
        <div class="fg"><label>ìµì¼ ê³„íš <span class="req">*</span></label><textarea placeholder="ë‹¤ìŒ ì˜ì—…ì¼ì— í•  ê³„íšì„ ì‘ì„±í•˜ì„¸ìš”.&#10;ì˜ˆ: ë†ì‹¬ íƒë°° ì ‘ìˆ˜ ì˜ˆì •, CJ ê³„ì•½ ê°±ì‹  ìµœì¢… í™•ì¸"></textarea></div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid #eef0f4">
          <button class="btn btn-secondary" onclick="showPage('daily')">ì·¨ì†Œ</button>
          <button class="btn btn-secondary" onclick="toast('ğŸ’¾ ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤')">ì„ì‹œì €ì¥</button>
          <button class="btn btn-primary" onclick="dailySave()">âœ… ì €ì¥</button>
        </div>
      </div></div>
    </div>

    <!-- ===== ì—…ë¬´ì¼ì§€ - ìƒì„¸ ë³´ê¸° ===== -->
    <div class="page" id="page-dailyDetail" style="display:none">
      <div style="margin-bottom:16px;display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="showPage('daily')">â† ëª©ë¡ìœ¼ë¡œ</button>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" onclick="toast('âœï¸ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜')">âœï¸ ìˆ˜ì •</button>
          <button class="btn btn-danger btn-sm" onclick="if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))toast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤')">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
      </div>

      <div class="card"><div class="card-bd">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid #eef0f4">
          <div>
            <h3 style="font-size:16px;font-weight:700;margin-bottom:4px">ğŸ“ ì—…ë¬´ì¼ì§€ ìƒì„¸</h3>
            <span style="font-size:12px;color:#8892a4">2026-02-13 (ëª©) Â· ì´ì£¼ì„ (ì˜ì—…ë¶€)</span>
          </div>
          <div style="text-align:right">
            <div style="font-size:11px;color:#8892a4;margin-bottom:4px">ì‘ì„±ì¼ì‹œ</div>
            <div style="font-size:12px;color:#5f6b7a">2026-02-13 17:32</div>
          </div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
          <div style="background:#f8f9fb;border-radius:10px;padding:14px">
            <div style="font-size:10px;color:#8892a4;margin-bottom:4px">ì—…ì²´ëª…</div>
            <div style="font-size:14px;font-weight:700;color:#1a2332">CJì œì¼ì œë‹¹(ì£¼)</div>
          </div>
          <div style="background:#f8f9fb;border-radius:10px;padding:14px">
            <div style="font-size:10px;color:#8892a4;margin-bottom:4px">ì‹œë£Œìˆ˜ê±°</div>
            <div><span class="tag" style="background:#e3f2fd;color:#1565c0">ë°©ë¬¸</span> <span style="font-size:10px;color:#1565c0">ğŸš— ì°¨ëŸ‰ì¼ì§€ ì—°ë™</span></div>
          </div>
          <div style="background:#f8f9fb;border-radius:10px;padding:14px">
            <div style="font-size:10px;color:#8892a4;margin-bottom:4px">ë§¤ì¶œ (VAT í¬í•¨)</div>
            <div style="font-size:14px;font-weight:700;color:#2e7d32">â‚© 2,200,000</div>
          </div>
          <div style="background:#f8f9fb;border-radius:10px;padding:14px">
            <div style="font-size:10px;color:#8892a4;margin-bottom:4px">ë°©ë¬¸ ì§€ì—­</div>
            <div style="font-size:13px;font-weight:600;color:#1a2332">ì„œìš¸(ì¤‘êµ¬)</div>
          </div>
        </div>

        <!-- ìƒì„¸ ë‚´ìš© -->
        <div class="sec-title" style="margin-top:8px"><span class="sec-num">1</span> íŠ¹ì´ì‚¬í•­</div>
        <div style="background:#f8f9fb;border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.7;color:#333">
          ì‹ ì œí’ˆ ì¶œì‹œ ê´€ë ¨ ì¶”ê°€ ê²€ì‚¬ ìš”ì²­. 2ì›” ë§ê¹Œì§€ ë¯¸ìƒë¬¼ 5ì¢… + ì˜ì–‘ì„±ë¶„ ë¶„ì„ì´ í•„ìš”í•˜ë©°, ì‹œë£ŒëŠ” ì˜¤ëŠ˜ ìˆ˜ê±° ì™„ë£Œ. ë‹´ë‹¹ì(ì‹í’ˆì•ˆì „íŒ€ ê¹€ê³¼ì¥)ì™€ ë‚©ê¸° 2ì£¼ í™•ì¸.
        </div>

        <div class="sec-title"><span class="sec-num">2</span> ê²½ìŸì‚¬ ë™í–¥</div>
        <div style="background:#fff3e0;border:1px solid #ffe0b2;border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.7;color:#e65100">
          <b>âš ï¸ Aê²€ì‚¬ê¸°ê´€</b> â€” ë¯¸ìƒë¬¼ ê²€ì‚¬ ë‹¨ê°€ë¥¼ ì•½ 8% ì¸í•˜í•œ ê²ƒìœ¼ë¡œ íŒŒì•…ë¨. CJì¸¡ì—ì„œ ê°€ê²© ë¹„êµ ìë£Œë¥¼ ìš”ì²­í•¨. ëŒ€ì‘ í•„ìš”.
        </div>

        <div class="sec-title"><span class="sec-num">3</span> ê±´ì˜ì‚¬í•­</div>
        <div style="background:#f8f9fb;border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.7;color:#333">
          ê²½ìŸì‚¬ ë‹¨ê°€ ì¸í•˜ì— ëŒ€ì‘í•˜ê¸° ìœ„í•´ ëŒ€ëŸ‰ ê³„ì•½ í• ì¸ ì •ì±… ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë°˜ê¸° ê³„ì•½ ê°±ì‹  ì‹œ í™œìš© ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ ë‹¨ê°€í‘œë¥¼ ì¬ë¬´ë¶€ì™€ í˜‘ì˜ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.
        </div>

        <div class="sec-title"><span class="sec-num">4</span> ì‹ ê·œì˜ì—… í™œë™</div>
        <div style="background:#f8f9fb;border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;color:#8892a4;font-style:italic">
          í•´ë‹¹ ì—†ìŒ
        </div>

        <div class="sec-title"><span class="sec-num">5</span> ìµì¼ ê³„íš</div>
        <div style="background:#e3f2fd;border:1px solid #bbdefb;border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.7;color:#1565c0">
          <b>ğŸ“… 2026-02-14 (ê¸ˆ)</b><br>
          â€¢ ë†ì‹¬ íƒë°° ì ‘ìˆ˜ ì˜ˆì • (ì‹œë£Œ ë„ì°© í™•ì¸ í›„ ì ‘ìˆ˜)<br>
          â€¢ CJ íŒ¨í‚¤ì§€ ë‹¨ê°€í‘œ ì´ˆì•ˆ ì‘ì„± â†’ ì¬ë¬´ë¶€ ê²€í†  ìš”ì²­
        </div>

        <!-- ì—°ê²° ì •ë³´ -->
        <div style="border-top:1px solid #eef0f4;padding-top:16px;margin-top:16px">
          <div style="font-size:12px;font-weight:700;color:#1a2332;margin-bottom:10px">ğŸ”— ì—°ê²°ëœ ì •ë³´</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div style="background:#e3f2fd;border:1px solid #bbdefb;border-radius:8px;padding:10px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px" onclick="showPage('vehicle')">
              ğŸš— <b>ì°¨ëŸ‰ì¼ì§€</b> â€” ì„œìš¸(ì¤‘êµ¬) ì™•ë³µ 42km
              <span style="color:#1565c0;font-size:10px">ë³´ê¸° â†’</span>
            </div>
            <div style="background:#f8f9fb;border:1px solid #e2e6ed;border-radius:8px;padding:10px 14px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px" onclick="showPage('customerList')">
              ğŸ¢ <b>CJì œì¼ì œë‹¹(ì£¼)</b> â€” ê³ ê°ì‚¬ ì •ë³´
              <span style="color:#5f6b7a;font-size:10px">ë³´ê¸° â†’</span>
            </div>
          </div>
        </div>
      </div></div>
    </div>

    <!-- ===== ì°¨ëŸ‰ì¼ì§€ ===== -->
    <div class="page" id="page-vehicle" style="display:none">
      <!-- ì„¤ì • ì¹´ë“œ -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd">
          <h3>âš™ï¸ ì°¨ëŸ‰ì¼ì§€ ì„¤ì •</h3>
          <div class="right"><button class="btn btn-sm btn-secondary" onclick="toast('âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')">ì„¤ì • ì €ì¥</button></div>
        </div>
        <div class="card-bd">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
            <div class="fg" style="margin:0">
              <label>ğŸ¢ íšŒì‚¬ ì£¼ì†Œ (ê¸°ë³¸ ì¶œë°œì§€/ë„ì°©ì§€)</label>
              <input value="ê²½ê¸°ë„ í™”ì„±ì‹œ ë™íƒ„ëŒ€ë¡œ 123 ë°”ì´ì˜¤í‘¸ë“œë©" style="background:#f8f9fb;font-size:12px" readonly>
              <div class="hint">ê´€ë¦¬ì > ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ ë³€ê²½</div>
            </div>
            <div class="fg" style="margin:0">
              <label>ğŸ  ìíƒ ì£¼ì†Œ (í˜„ì§€ì¶œê·¼/í‡´ê·¼ìš©)</label>
              <input id="vHomeAddr" placeholder="ìíƒ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="font-size:12px" value="ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123">
              <div class="hint">ê°œì¸ ì„¤ì • Â· ê±°ë¦¬ ê³„ì‚°ì— ì‚¬ìš©</div>
            </div>
            <div class="fg" style="margin:0">
              <label>ğŸš— ì°¨ëŸ‰ ë²ˆí˜¸</label>
              <input value="12ê°€ 3456" style="font-size:12px">
              <div class="hint">ê¸°ë³¸ ì°¨ëŸ‰ Â· ì—…ë¬´ì¼ì§€ ì—°ë™ ì‹œ ìë™ ì…ë ¥</div>
            </div>
          </div>
          <div style="margin-top:10px;padding:8px 12px;background:#fff3e0;border-radius:8px;font-size:11px;color:#e65100;display:flex;align-items:center;gap:6px">
            <span>ğŸ“</span> ì£¼í–‰ê±°ë¦¬ëŠ” <b>ì¹´ì¹´ì˜¤ëª¨ë¹Œë¦¬í‹° ê¸¸ì°¾ê¸° API</b>ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤ (ë¬´ë£Œ ì¼ 10,000ê±´). ìë™ ê³„ì‚° í›„ ìˆ˜ë™ ì¡°ì •ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <!-- ëª©ë¡ -->
      <div class="card">
        <div class="card-hd">
          <h3>ğŸš— ì°¨ëŸ‰ì¼ì§€</h3>
          <div class="right">
            <span style="font-size:11px;color:#1565c0;background:#e3f2fd;padding:4px 10px;border-radius:6px">ğŸ”— ì—…ë¬´ì¼ì§€ ë°©ë¬¸ ê¸°ë¡ì—ì„œ ìë™ ìƒì„±</span>
          </div>
        </div>
        <!-- í•„í„° -->
        <div style="padding:12px 20px;border-bottom:1px solid #eef0f4;display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:#fafbfc">
          <input type="date" value="2026-02-10" style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px">
          <span style="color:#c8d6e5">~</span>
          <input type="date" value="2026-02-13" style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px">
          <select style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:6px;font-size:12px;background:#fff">
            <option>ì „ì²´ ìš´ì „ì</option><option selected>ì´ì£¼ì„</option><option>ê¹€ì˜ì—…</option>
          </select>
          <div style="margin-left:auto;display:flex;align-items:center;gap:12px;font-size:12px">
            <span style="color:#5f6b7a">í•©ê³„:</span>
            <span style="font-weight:700;color:#1a2332">1,002 km</span>
            <span style="color:#8892a4">|</span>
            <span style="color:#e65100;font-weight:600">ì£¼ìœ ë¹„ 165,000</span>
            <span style="color:#8892a4">|</span>
            <span style="color:#1565c0;font-weight:600">í†µí–‰ë£Œ 49,600</span>
          </div>
        </div>
        <div class="card-bd" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th><th>ìš´ì „ì</th><th>ì°¨ëŸ‰</th>
                <th>ì¶œë°œì§€</th><th>ê²½ë¡œ</th><th>ë„ì°©ì§€</th>
                <th style="text-align:right">ì£¼í–‰(km)</th>
                <th style="text-align:center">ì¡°ì •</th>
                <th style="text-align:right">ì£¼ìœ ë¹„</th><th style="text-align:right">í†µí–‰ë£Œ</th>
                <th style="width:40px"></th>
              </tr>
            </thead>
            <tbody>
              <!-- 2/13 íšŒì‚¬â†’ì¤‘êµ¬â†’íšŒì‚¬ -->
              <tr>
                <td><b>2026-02-13</b></td><td>ì´ì£¼ì„</td><td>12ê°€ 3456</td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ğŸ¢ íšŒì‚¬</span></td>
                <td>
                  <div class="route">
                    <div class="route-stop">ì„œìš¸(ì¤‘êµ¬)</div>
                  </div>
                </td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ğŸ¢ íšŒì‚¬</span></td>
                <td style="text-align:right;font-weight:700">42</td>
                <td style="text-align:center"><span style="font-size:10px;color:#2e7d32;background:#e8f5e9;padding:1px 6px;border-radius:4px">API</span></td>
                <td style="text-align:right">-</td>
                <td style="text-align:right">4,800</td>
                <td class="center"><span style="cursor:pointer;font-size:12px" onclick="toast('âœï¸ ìˆ˜ì • ëª¨ë“œ')">âœï¸</span></td>
              </tr>
              <!-- 2/12 íšŒì‚¬â†’ê°•ë‚¨â†’ì–‘ì²œâ†’íšŒì‚¬ -->
              <tr>
                <td><b>2026-02-12</b></td><td>ì´ì£¼ì„</td><td>12ê°€ 3456</td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ğŸ¢ íšŒì‚¬</span></td>
                <td>
                  <div class="route">
                    <div class="route-stop">ì„œìš¸(ê°•ë‚¨êµ¬)</div>
                    <span class="route-arrow">â†’</span>
                    <div class="route-stop">ì„œìš¸(ì–‘ì²œêµ¬)</div>
                  </div>
                </td>
                <td><span class="tag" style="background:#e3f2fd;color:#1565c0">ğŸ¢ íšŒì‚¬</span></td>
                <td style="text-align:right;font-weight:700">68</td>
                <td style="text-align:center"><span style="font-size:10px;color:#2e7d32;background:#e8f5e9;padding:1px 6px;border-radius:4px">API</span></td>
                <td style="text-align:right">45,000</td>
                <td style="text-align:right">6,400</td>
                <td class="center"><span style="cursor:pointer;font-size:12px" onclick="toast('âœï¸ ìˆ˜ì • ëª¨ë“œ')">âœï¸</span></td>
              </tr>
              <!-- 2/11 í˜„ì§€ì¶œê·¼â†’ì¤‘êµ¬â†’ì¸ì²œâ†’ë¶€ì‚°â†’ìíƒ (ìˆ˜ë™ ì¡°ì • ì˜ˆì‹œ) -->
              <tr style="background:#fffde7">
                <td><b>2026-02-11</b></td><td>ì´ì£¼ì„</td><td>12ê°€ 3456</td>
                <td><span class="tag" style="background:#f3e5f5;color:#7b1fa2">ğŸ  í˜„ì§€ì¶œê·¼</span></td>
                <td>
                  <div class="route">
                    <div class="route-stop">ì„œìš¸(ì¤‘êµ¬)</div>
                    <span class="route-arrow">â†’</span>
                    <div class="route-stop">ì¸ì²œ(ì—°ìˆ˜êµ¬)</div>
                    <span class="route-arrow">â†’</span>
                    <div class="route-stop">ë¶€ì‚°(í•´ìš´ëŒ€êµ¬)</div>
                  </div>
                </td>
                <td><span class="tag" style="background:#f3e5f5;color:#7b1fa2">ğŸ  ìíƒ</span></td>
                <td style="text-align:right;font-weight:700;color:#e65100">
                  <span style="text-decoration:line-through;color:#8892a4;font-weight:400;font-size:10px">878</span>
                  892
                </td>
                <td style="text-align:center"><span style="font-size:10px;color:#e65100;background:#fff3e0;padding:1px 6px;border-radius:4px">ìˆ˜ë™</span></td>
                <td style="text-align:right">120,000</td>
                <td style="text-align:right">38,400</td>
                <td class="center"><span style="cursor:pointer;font-size:12px" onclick="toast('âœï¸ ìˆ˜ì • ëª¨ë“œ')">âœï¸</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- ë²”ë¡€ -->
        <div style="padding:10px 20px;border-top:1px solid #eef0f4;display:flex;gap:16px;flex-wrap:wrap;font-size:10px;color:#8892a4">
          <span><span class="tag" style="background:#e3f2fd;color:#1565c0;font-size:9px">ğŸ¢ íšŒì‚¬</span> íšŒì‚¬ ì¶œë°œ/ë„ì°©</span>
          <span><span class="tag" style="background:#f3e5f5;color:#7b1fa2;font-size:9px">ğŸ  í˜„ì§€ì¶œê·¼</span> ìíƒ ì¶œë°œ/ë„ì°©</span>
          <span><span style="background:#e8f5e9;padding:1px 6px;border-radius:4px;font-size:9px;color:#2e7d32">API</span> ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸° ìë™ê³„ì‚°</span>
          <span><span style="background:#fff3e0;padding:1px 6px;border-radius:4px;font-size:9px;color:#e65100">ìˆ˜ë™</span> ìš´ì „ìê°€ ì§ì ‘ ì¡°ì •</span>
        </div>
      </div>
    </div>

    <!-- ===== ë¯¸ìˆ˜ê¸ˆ í™œë™ ë‚´ì—­ ===== -->
    <div class="page" id="page-collection" style="display:none">
      <div class="card">
        <div class="card-hd">
          <h3>ğŸ“ ë¯¸ìˆ˜ê¸ˆ í™œë™ ë‚´ì—­</h3>
          <div class="right">
            <select style="padding:7px 10px;border:1px solid #e2e6ed;border-radius:8px;font-size:12px">
              <option>í’€ë¬´ì›ì‹í’ˆ(ì£¼) â€” ğŸŸ  ì£¼í™©</option>
              <option>(ì£¼)ì˜¤ëšœê¸° â€” ğŸŸ¡ ë…¸ë‘</option>
              <option>(ì£¼)ì‚¼ì–‘ì‹í’ˆ â€” ğŸ”´ ë¹¨ê°•</option>
            </select>
            <button class="btn btn-primary">+ ìˆ˜ê¸ˆ í™œë™ ê¸°ë¡</button>
          </div>
        </div>
        <div class="card-bd">
          <div style="display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap">
            <div style="background:#fff3e0;border:1px solid #ffcc80;border-radius:10px;padding:12px 20px;flex:1;min-width:140px;text-align:center">
              <div style="font-size:10px;color:#e65100">ë¯¸ìˆ˜ê¸ˆì•¡</div>
              <div style="font-size:20px;font-weight:800;color:#e65100">4,500,000ì›</div>
            </div>
            <div style="background:#fce4ec;border:1px solid #ef9a9a;border-radius:10px;padding:12px 20px;flex:1;min-width:140px;text-align:center">
              <div style="font-size:10px;color:#c62828">ì—°ì²´ì¼</div>
              <div style="font-size:20px;font-weight:800;color:#c62828">68ì¼</div>
            </div>
            <div style="background:#e3f2fd;border:1px solid #90caf9;border-radius:10px;padding:12px 20px;flex:1;min-width:140px;text-align:center">
              <div style="font-size:10px;color:#1565c0">ìˆ˜ê¸ˆ ì‹œë„</div>
              <div style="font-size:20px;font-weight:800;color:#1565c0">5íšŒ</div>
            </div>
            <div style="background:#f3e5f5;border:1px solid #ce93d8;border-radius:10px;padding:12px 20px;flex:1;min-width:140px;text-align:center">
              <div style="font-size:10px;color:#7b1fa2">ì…ê¸ˆ ì•½ì†ì¼</div>
              <div style="font-size:20px;font-weight:800;color:#7b1fa2">02/20</div>
            </div>
          </div>

          <div class="timeline">
            <div class="tl-item sys">
              <div class="tl-date">2026-02-13 09:00 Â· ì‹œìŠ¤í…œ</div>
              <div class="tl-content">ğŸš¦ <strong>ì‹ í˜¸ë“± ë³€ê²½:</strong> ë…¸ë‘ â†’ <span style="color:#e65100;font-weight:700">ì£¼í™©</span> (ì—°ì²´ 68ì¼, ë¯¸ì—°ê²° 2íšŒ)</div>
            </div>
            <div class="tl-item">
              <div class="tl-date">2026-02-12 14:30 Â· ì´ì£¼ì„</div>
              <div class="tl-content">ì´ê·œì„± ê³¼ì¥ì—ê²Œ ì „í™” ì—°ê²° ì„±ê³µ. "ì´ë²ˆ ë‹¬ 20ì¼ê¹Œì§€ ì…ê¸ˆí•˜ê² ë‹¤"ê³  ì•½ì†.</div>
              <div class="tl-tags">
                <span class="tl-tag tl-tag-call">ğŸ“ ì „í™”</span>
                <span class="tl-tag tl-tag-connected">âœ… ì—°ê²°</span>
                <span class="tl-tag" style="background:#e8f5e9;color:#2e7d32">ğŸ“… ì•½ì†: 02/20</span>
              </div>
            </div>
            <div class="tl-item">
              <div class="tl-date">2026-02-10 11:15 Â· ì´ì£¼ì„</div>
              <div class="tl-content">ì „í™” ì—°ê²° ì•ˆë¨. ë¬¸ì ë°œì†¡ â€” "ë¯¸ìˆ˜ê¸ˆ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤."</div>
              <div class="tl-tags">
                <span class="tl-tag tl-tag-call">ğŸ“ ì „í™”</span>
                <span class="tl-tag tl-tag-missed">âŒ ë¯¸ì—°ê²°</span>
                <span class="tl-tag tl-tag-sms">ğŸ’¬ ë¬¸ì ë°œì†¡</span>
              </div>
            </div>
            <div class="tl-item">
              <div class="tl-date">2026-02-05 16:00 Â· ì´ì£¼ì„</div>
              <div class="tl-content">ì´ê·œì„± ê³¼ì¥ ì „í™” ìˆ˜ì‹  ê±°ì ˆ.</div>
              <div class="tl-tags">
                <span class="tl-tag tl-tag-call">ğŸ“ ì „í™”</span>
                <span class="tl-tag tl-tag-refused">ğŸš« ìˆ˜ì‹ ê±°ì ˆ</span>
              </div>
            </div>
            <div class="tl-item">
              <div class="tl-date">2026-01-28 10:00 Â· ì´ì£¼ì„</div>
              <div class="tl-content">ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ë°œì†¡. ì½ìŒ í™•ì¸ë¨. íšŒì‹  ì—†ìŒ.</div>
              <div class="tl-tags">
                <span class="tl-tag" style="background:#fff9c4;color:#f57f17">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡</span>
                <span class="tl-tag tl-tag-missed">íšŒì‹  ì—†ìŒ</span>
              </div>
            </div>
            <div class="tl-item">
              <div class="tl-date">2026-01-20 09:30 Â· ì´ì£¼ì„</div>
              <div class="tl-content">ì „í™” ì—°ê²°. ê¹€ë¶€ì¥ "ë‹¤ìŒ ë‹¬ ì´ˆ ì²˜ë¦¬í•˜ê² ë‹¤" ì‘ë‹µ. (ë¯¸ì´í–‰)</div>
              <div class="tl-tags">
                <span class="tl-tag tl-tag-call">ğŸ“ ì „í™”</span>
                <span class="tl-tag tl-tag-connected">âœ… ì—°ê²°</span>
                <span class="tl-tag" style="background:#fce4ec;color:#c62828">âŒ ì•½ì† ë¯¸ì´í–‰</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ê²¬ì ì„œ ê´€ë¦¬ ===== -->
    <div class="page" id="page-estimate" style="display:none">
      <div class="card"><div class="card-bd" style="text-align:center;padding:60px">
        <div style="font-size:48px;margin-bottom:12px">â¸ï¸</div>
        <div style="font-size:16px;font-weight:700;color:#e65100;margin-bottom:8px">ì¶”í›„ ê²€í†  í•­ëª©</div>
        <div style="font-size:13px;color:#5f6b7a">í™ˆí˜ì´ì§€ ê¸°ì¡´ ê¸°ëŠ¥ í™œìš© ì˜ˆì •<br>ë‹¨ê°€ëŠ” ê²€ì‚¬í•­ëª© DB ìë™ ì—°ë™ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ ì˜ˆì •</div>
      </div></div>
    </div>

    <!-- ===== ê±°ë˜ëª…ì„¸í‘œ ê´€ë¦¬ ===== -->
    <div class="page" id="page-trade" style="display:none">
      <div class="card">
        <div class="card-hd"><h3>ğŸ“„ ê±°ë˜ëª…ì„¸í‘œ ê´€ë¦¬</h3><div class="right"><button class="btn btn-secondary btn-sm">ğŸ“… ì›”ë³„ ì¼ê´„ ë°œí–‰</button><button class="btn btn-primary btn-sm">+ ê±°ë˜ëª…ì„¸í‘œ ì‘ì„±</button></div></div>
        <div class="card-bd" style="padding:0;overflow-x:auto">
          <table class="tbl">
            <thead><tr><th>ë°œí–‰ì¼</th><th>ê±°ë˜ëª…ì„¸í‘œ ë²ˆí˜¸</th><th>ì—…ì²´ëª…</th><th>í•­ëª© ìˆ˜</th><th>ê¸ˆì•¡(í•©ê³„)</th><th>ìƒíƒœ</th><th>ë¹„ê³ </th></tr></thead>
            <tbody>
              <tr><td>2026-02-10</td><td>TM-2026-0213</td><td>CJì œì¼ì œë‹¹(ì£¼)</td><td>4ê±´</td><td style="text-align:right">2,200,000</td><td><span class="tag tag-approved">ë°œì†¡ì™„ë£Œ</span></td><td><button class="btn btn-secondary btn-sm">PDF</button> <button class="btn btn-secondary btn-sm">ğŸ“§</button></td></tr>
              <tr><td>2026-02-08</td><td>TM-2026-0198</td><td>(ì£¼)ë†ì‹¬</td><td>2ê±´</td><td style="text-align:right">880,000</td><td><span class="tag tag-approved">ë°œì†¡ì™„ë£Œ</span></td><td><button class="btn btn-secondary btn-sm">PDF</button></td></tr>
              <tr><td>2026-02-05</td><td>TM-2026-0185</td><td>ë™ì›F&B(ì£¼)</td><td>3ê±´</td><td style="text-align:right">1,500,000</td><td><span class="tag tag-pending">ëŒ€ê¸°</span></td><td><button class="btn btn-secondary btn-sm">PDF</button> <button class="btn btn-primary btn-sm">ğŸ“§ ë°œì†¡</button></td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div style="background:#fff3e0;border:1px solid #ffcc80;border-radius:10px;padding:12px 16px;font-size:12px;color:#e65100">
        âš ï¸ ì„¸ë¶€ êµ¬í˜„ì€ <strong>ì ‘ìˆ˜ê´€ë¦¬</strong> ì™„ì„± í›„ êµ¬ì²´í™” ì˜ˆì • â€” ì ‘ìˆ˜ ì™„ë£Œ ì‹œ ìë™ ìƒì„±
      </div>
    </div>

    <!-- ===== ê¸´ê¸‰ í˜‘ì¡° ìš”ì²­ ===== -->
    <div class="page" id="page-urgent" style="display:none">
      <div class="card"><div class="card-bd" style="text-align:center;padding:60px">
        <div style="font-size:48px;margin-bottom:12px">â¸ï¸</div>
        <div style="font-size:16px;font-weight:700;color:#e65100;margin-bottom:8px">ì¶”í›„ ê²€í†  í•­ëª©</div>
        <div style="font-size:13px;color:#5f6b7a">ê²€ì‚¬ ëª©ì ë³„ í‘œê¸° í•­ëª©ì´ ë‹¤ë¥´ë¯€ë¡œ ë°˜ì˜ í•„ìš”<br>ê¸°ëŠ¥ ë°©í–¥: ìš”ì²­ ë“±ë¡, í˜„í™© ì¡°íšŒ(ëŒ€ê¸°/ì²˜ë¦¬ì¤‘/ì™„ë£Œ), ë‹´ë‹¹ì ë°°ì •, ì™„ë£Œ ì•Œë¦¼</div>
      </div></div>
    </div>

    <!-- ===== ì„¸ê¸ˆê³„ì‚°ì„œë¯¸ë°œí–‰ ===== -->
    <div class="page" id="page-arManage" style="display:none">
      <div class="card"><div class="card-bd" style="text-align:center;padding:60px">
        <div style="font-size:48px;margin-bottom:12px">â¸ï¸</div>
        <div style="font-size:16px;font-weight:700;color:#e65100;margin-bottom:8px">ì¶”í›„ ê²€í†  í•­ëª©</div>
        <div style="font-size:13px;color:#5f6b7a">ì¬ë¬´ê´€ë¦¬ ì„¤ê³„ í›„ êµ¬ì²´í™” ì˜ˆì •</div>
      </div></div>
    </div>

    <!-- ===== ê³„ì‚°ì„œ ë°œí–‰ ìŠ¹ì¸ ===== -->
    <div class="page" id="page-invoice" style="display:none">
      <div class="stats">
        <div class="stat"><div class="stat-val">12</div><div class="stat-label">ì´ë²ˆ ë‹¬ ìš”ì²­</div></div>
        <div class="stat"><div class="stat-val" style="color:#e65100">3</div><div class="stat-label">ëŒ€ê¸°</div></div>
        <div class="stat"><div class="stat-val" style="color:#2e7d32">8</div><div class="stat-label">ìŠ¹ì¸</div></div>
        <div class="stat"><div class="stat-val" style="color:#e53935">1</div><div class="stat-label">ë°˜ë ¤</div></div>
      </div>
      <div class="card">
        <div class="card-hd"><h3>ğŸ§¾ ê³„ì‚°ì„œ ë°œí–‰ ìŠ¹ì¸ìš”ì²­</h3><div class="right"><button class="btn btn-primary">+ ìŠ¹ì¸ ìš”ì²­</button></div></div>
        <div class="card-bd">
          <div style="background:#f8f9fb;border:1px solid #eef0f4;border-radius:10px;padding:14px;margin-bottom:16px">
            <div style="font-size:12px;font-weight:700;margin-bottom:8px">ìŠ¹ì¸ íë¦„</div>
            <div class="approval-flow">
              <div class="af-step" style="background:#e3f2fd;color:#1565c0">ì˜ì—…ì‚¬ì›<br><small>ìš”ì²­</small></div>
              <span class="af-arr">â†’</span>
              <div class="af-step" style="background:#fff3e0;color:#e65100">ì¬ë¬´ë¶€<br><small>ê²€í† </small></div>
              <span class="af-arr">â†’</span>
              <div class="af-step" style="background:#e8f5e9;color:#2e7d32">ìŠ¹ì¸</div>
              <span class="af-arr">â†’</span>
              <div class="af-step" style="background:#f3e5f5;color:#7b1fa2">ì„¸ê¸ˆê³„ì‚°ì„œ<br><small>ìë™ ë°œí–‰</small></div>
            </div>
          </div>
          <table class="tbl">
            <thead><tr><th>ìš”ì²­ì¼</th><th>ì—…ì²´ëª…</th><th>ê¸ˆì•¡</th><th>ë°œí–‰ì‚¬ìœ </th><th>ìƒíƒœ</th><th>ì²˜ë¦¬ì</th><th>ì²˜ë¦¬ì¼</th></tr></thead>
            <tbody>
              <tr><td>2026-02-13</td><td>CJì œì¼ì œë‹¹(ì£¼)</td><td style="text-align:right">2,200,000</td><td>ì›” ì •ê¸° ê²€ì‚¬ ë¹„ìš©</td><td><span class="tag tag-pending">ëŒ€ê¸°</span></td><td>-</td><td>-</td></tr>
              <tr><td>2026-02-12</td><td>ë™ì›F&B(ì£¼)</td><td style="text-align:right">1,500,000</td><td>ê¸´ê¸‰ ê²€ì‚¬ ë¹„ìš©</td><td><span class="tag tag-pending">ëŒ€ê¸°</span></td><td>-</td><td>-</td></tr>
              <tr><td>2026-02-10</td><td>(ì£¼)ë†ì‹¬</td><td style="text-align:right">880,000</td><td>ì˜ì–‘ì„±ë¶„ ë¶„ì„ ë¹„ìš©</td><td><span class="tag tag-approved">ìŠ¹ì¸</span></td><td>ì¬ë¬´ë¶€ ê¹€ê³¼ì¥</td><td>2026-02-11</td></tr>
              <tr><td>2026-02-08</td><td>(ì£¼)ì˜¤ëšœê¸°</td><td style="text-align:right">650,000</td><td>ìœ í†µê¸°í•œ ì—°ì¥ ê²€ì‚¬</td><td><span class="tag tag-approved">ìŠ¹ì¸</span></td><td>ì¬ë¬´ë¶€ ê¹€ê³¼ì¥</td><td>2026-02-09</td></tr>
              <tr style="background:#fce4ec"><td>2026-02-05</td><td>í’€ë¬´ì›ì‹í’ˆ(ì£¼)</td><td style="text-align:right">4,500,000</td><td>ë¯¸ìˆ˜ê¸ˆ ì •ì‚° ìš”ì²­</td><td><span class="tag tag-rejected">ë°˜ë ¤</span></td><td>ì¬ë¬´ë¶€ ê¹€ê³¼ì¥</td><td>2026-02-06</td></tr>
              <tr><td colspan="7" style="background:#fce4ec;font-size:11px;color:#c62828;padding:6px 14px">â†³ ë°˜ë ¤ ì‚¬ìœ : ë¯¸ìˆ˜ê¸ˆ ì—…ì²´ â€” ìˆ˜ê¸ˆ í™œë™ ê¸°ë¡ í›„ ì¬ìš”ì²­ ë°”ëë‹ˆë‹¤.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== API ìˆ˜ì§‘ ì„¤ì • ===== -->
    <div class="page" id="page-apiSettings" style="display:none">

      <!-- ìƒë‹¨ ìš”ì•½ -->
      <div class="stats">
        <div class="stat"><div class="stat-val" id="apiTotalCount">16</div><div class="stat-label">ì „ì²´ API</div></div>
        <div class="stat"><div class="stat-val" style="color:#2e7d32" id="apiActiveCount">0</div><div class="stat-label">ìˆ˜ì§‘ í™œì„±</div></div>
        <div class="stat"><div class="stat-val" style="color:#1a73e8" id="apiLastCollect">-</div><div class="stat-label">ìµœê·¼ ìˆ˜ì§‘</div></div>
        <div class="stat"><div class="stat-val" style="color:#e65100" id="apiNextCollect">03:00</div><div class="stat-label">ë‹¤ìŒ ìˆ˜ì§‘(KST)</div></div>
      </div>

      <!-- ìˆ˜ì§‘ ì‹œê°„ ì„¤ì • -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd"><h3>ğŸ• ìˆ˜ì§‘ ìŠ¤ì¼€ì¤„ ì„¤ì •</h3></div>
        <div class="card-bd">
          <div style="display:flex;gap:24px;align-items:center;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-size:13px;font-weight:600;white-space:nowrap">ìˆ˜ì§‘ ì‹œê° (KST):</label>
              <input type="time" id="collectTime" value="03:00" style="padding:8px 12px;border:1px solid #dde2ea;border-radius:6px;font-size:14px;font-weight:600;width:120px">
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-size:13px;font-weight:600;white-space:nowrap">ìˆ˜ì§‘ ë°©ì‹:</label>
              <select id="collectMode" style="padding:8px 12px;border:1px solid #dde2ea;border-radius:6px;font-size:13px">
                <option value="incremental">ì¦ë¶„ ìˆ˜ì§‘ (ë³€ê²½ë¶„ë§Œ)</option>
                <option value="full">ì „ì²´ ìˆ˜ì§‘ (ë§¤ì¼ ì „ì²´)</option>
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-size:13px;font-weight:600;white-space:nowrap">API ì„œë²„:</label>
              <input type="text" id="apiServerUrl" value="" placeholder="API ì„œë²„ ì£¼ì†Œ" style="padding:8px 12px;border:1px solid #dde2ea;border-radius:6px;font-size:12px;font-family:monospace;width:200px">
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-primary" onclick="saveApiSettings()" style="padding:8px 20px">ğŸ’¾ ì„¤ì • ì €ì¥</button>
            <button class="btn btn-secondary" onclick="testApiConnection()" style="padding:8px 20px">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="btn btn-secondary" onclick="checkAllApis(true)" style="padding:8px 16px">â˜‘ï¸ ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" onclick="checkAllApis(false)" style="padding:8px 16px">â¬œ ì „ì²´ í•´ì œ</button>
          </div>
        </div>
      </div>

      <!-- API ì¹´í…Œê³ ë¦¬ 1: ì—…ì†Œ ì¸í—ˆê°€ -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd" style="cursor:pointer" onclick="toggleApiGroup('grpBiz')">
          <h3>ğŸ­ ì—…ì†Œ ì¸í—ˆê°€ ëŒ€ì¥ <span style="font-size:12px;font-weight:400;color:#8892a4">(9ê°œ API)</span></h3>
          <div class="right"><span id="grpBizArrow" style="font-size:16px">â–¼</span></div>
        </div>
        <div class="card-bd" id="grpBiz">

          <div class="api-item" id="api-I1220">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I1220</strong> â€” ì‹í’ˆì œì¡°ê°€ê³µì—…</label>
              <span class="api-count">~30,279ê±´</span>
            </div>
            <div class="api-fields">
              <span class="api-tag" title="ì¸í—ˆê°€ë²ˆí˜¸">LCNS_NO</span>
              <span class="api-tag" title="ì—…ì†Œëª…">BSSH_NM</span>
              <span class="api-tag" title="ëŒ€í‘œìëª…">PRSDNT_NM</span>
              <span class="api-tag" title="ì—…ì¢…">INDUTY_NM</span>
              <span class="api-tag" title="í—ˆê°€ì¼ì">PRMS_DT</span>
              <span class="api-tag" title="ì „í™”ë²ˆí˜¸">TELNO</span>
              <span class="api-tag" title="ì£¼ì†Œ">LOCP_ADDR</span>
              <span class="api-tag" title="ê¸°ê´€ëª…">INSTT_NM</span>
            </div>
          </div>

          <div class="api-item" id="api-I2829">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I2829</strong> â€” ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</label>
              <span class="api-count">~97,696ê±´</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span>
            </div>
          </div>

          <div class="api-item" id="api-I-0020">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I-0020</strong> â€” ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì „ë¬¸/ë²¤ì²˜ì œì¡°ì—…</label>
              <span class="api-count">~551ê±´</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">TELNO</span><span class="api-tag">LOCP_ADDR</span>
            </div>
          </div>

          <div class="api-item" id="api-I1300">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I1300</strong> â€” ì¶•ì‚°ë¬¼ ê°€ê³µì—…</label>
              <span class="api-count">~4,233ê±´</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span><span class="api-tag">TELNO</span>
            </div>
          </div>

          <div class="api-item" id="api-I1320">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I1320</strong> â€” ì¶•ì‚°ë¬¼ ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">CLSBIZ_DVS_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span><span class="api-tag">TELNO</span>
            </div>
          </div>

          <div class="api-item" id="api-I2835">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I2835</strong> â€” ì‹ìœ¡ì¦‰ì„íŒë§¤ê°€ê³µì—…</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span>
            </div>
          </div>

          <div class="api-item" id="api-I2831">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I2831</strong> â€” ì‹í’ˆì†Œë¶„ì—…</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span>
            </div>
          </div>

          <div class="api-item" id="api-C001">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>C001</strong> â€” ìˆ˜ì…ì‹í’ˆë“±ì˜ì—…ì‹ ê³ </label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span><span class="api-tag">TELNO</span>
            </div>
          </div>

          <div class="api-item" id="api-I1260">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I1260</strong> â€” ì‹í’ˆë“±ìˆ˜ì…íŒë§¤ì—…</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRSDNT_NM</span><span class="api-tag">INDUTY_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">TELNO</span><span class="api-tag">LOCP_ADDR</span><span class="api-tag">INSTT_NM</span>
            </div>
          </div>

        </div>
      </div>

      <!-- API ì¹´í…Œê³ ë¦¬ 2: í’ˆëª© ì œì¡° ë³´ê³  -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd" style="cursor:pointer" onclick="toggleApiGroup('grpPrd')">
          <h3>ğŸ“¦ í’ˆëª© ì œì¡° ë³´ê³  <span style="font-size:12px;font-weight:400;color:#8892a4">(2ê°œ API)</span></h3>
          <div class="right"><span id="grpPrdArrow" style="font-size:16px">â–¼</span></div>
        </div>
        <div class="card-bd" id="grpPrd">

          <div class="api-item" id="api-I1250">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I1250</strong> â€” ì‹í’ˆ(ì²¨ê°€ë¬¼)í’ˆëª©ì œì¡°ë³´ê³ </label>
              <span class="api-count" style="color:#e65100">~1,043,828ê±´</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRDLST_REPORT_NO</span><span class="api-tag">PRMS_DT</span><span class="api-tag">PRDLST_NM</span><span class="api-tag">PRDLST_DCNM</span><span class="api-tag">PRODUCTION</span><span class="api-tag">HIENG_LNTRT_DVS_NM</span><span class="api-tag">CHILD_CRTFC_YN</span><span class="api-tag">POG_DAYCNT</span><span class="api-tag">INDUTY_CD_NM</span><span class="api-tag">LAST_UPDT_DTM</span><span class="api-tag">USAGE</span><span class="api-tag">PRPOS</span><span class="api-tag">DISPOS</span><span class="api-tag">FRMLC_MTRQLT</span>
            </div>
          </div>

          <div class="api-item" id="api-I1310">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I1310</strong> â€” ì¶•ì‚°ë¬¼ í’ˆëª©ì œì¡°ì •ë³´</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRDLST_REPORT_NO</span><span class="api-tag">PRMS_DT</span><span class="api-tag">PRDLST_NM</span><span class="api-tag">PRDLST_DCNM</span><span class="api-tag">PRODUCTION</span><span class="api-tag">POG_DAYCNT</span><span class="api-tag">INDUTY_CD_NM</span><span class="api-tag">LAST_UPDT_DTM</span>
            </div>
          </div>

        </div>
      </div>

      <!-- API ì¹´í…Œê³ ë¦¬ 3: ì›ì¬ë£Œ -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd" style="cursor:pointer" onclick="toggleApiGroup('grpMat')">
          <h3>ğŸ§ª ì›ì¬ë£Œ ì •ë³´ <span style="font-size:12px;font-weight:400;color:#8892a4">(3ê°œ API)</span></h3>
          <div class="right"><span id="grpMatArrow" style="font-size:16px">â–¼</span></div>
        </div>
        <div class="card-bd" id="grpMat">

          <div class="api-item" id="api-C002">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>C002</strong> â€” ì‹í’ˆ(ì²¨ê°€ë¬¼)í’ˆëª©ì œì¡°ë³´ê³ (ì›ì¬ë£Œ)</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRDLST_REPORT_NO</span><span class="api-tag">PRMS_DT</span><span class="api-tag">PRDLST_NM</span><span class="api-tag">PRDLST_DCNM</span><span class="api-tag">RAWMTRL_NM</span><span class="api-tag">RAWMTRL_ORDNO</span><span class="api-tag">CHNG_DT</span>
            </div>
          </div>

          <div class="api-item" id="api-C003">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>C003</strong> â€” ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ í’ˆëª©ì œì¡°ì‹ ê³ (ì›ì¬ë£Œ)</label>
              <span class="api-count">~44,272ê±´</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">LCNS_NO</span><span class="api-tag">BSSH_NM</span><span class="api-tag">PRDLST_REPORT_NO</span><span class="api-tag">PRDLST_NM</span><span class="api-tag">PRMS_DT</span><span class="api-tag">POG_DAYCNT</span><span class="api-tag">DISPOS</span><span class="api-tag">NTK_MTHD</span><span class="api-tag">PRIMARY_FNCLTY</span><span class="api-tag">IFTKN_ATNT_MATR_CN</span><span class="api-tag">CSTDY_MTHD</span><span class="api-tag">SHAP</span><span class="api-tag">STDR_STND</span><span class="api-tag">RAWMTRL_NM</span>
            </div>
          </div>

          <div class="api-item" id="api-C006">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>C006</strong> â€” ì¶•ì‚°ë¬¼í’ˆëª©ì œì¡°ë³´ê³ (ì›ì¬ë£Œ)</label>
              <span class="api-count">í™•ì¸í•„ìš”</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">BSSH_NM</span><span class="api-tag">PRDLST_REPORT_NO</span><span class="api-tag">PRMS_DT</span><span class="api-tag">PRDLST_NM</span><span class="api-tag">PRDLST_DCNM</span><span class="api-tag">RAWMTRL_NM</span><span class="api-tag">LCNS_NO</span><span class="api-tag">CHNG_DT</span><span class="api-tag">RAWMTRL_ORDNO</span>
            </div>
          </div>

        </div>
      </div>

      <!-- API ì¹´í…Œê³ ë¦¬ 4: ë³€ê²½ ì´ë ¥ -->
      <div class="card" style="margin-bottom:16px">
        <div class="card-hd" style="cursor:pointer" onclick="toggleApiGroup('grpChg')">
          <h3>ğŸ“ ì¸í—ˆê°€ ë³€ê²½ ì´ë ¥ <span style="font-size:12px;font-weight:400;color:#8892a4">(2ê°œ API)</span></h3>
          <div class="right"><span id="grpChgArrow" style="font-size:16px">â–¼</span></div>
        </div>
        <div class="card-bd" id="grpChg">

          <div class="api-item" id="api-I2859">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I2859</strong> â€” ì‹í’ˆì—…ì†Œ ì¸í—ˆê°€ ë³€ê²½ ì •ë³´</label>
              <span class="api-count">ë³€ê²½ë¶„</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">BSSH_NM</span><span class="api-tag">INDUTY_CD_NM</span><span class="api-tag">LCNS_NO</span><span class="api-tag">TELNO</span><span class="api-tag">SITE_ADDR</span><span class="api-tag">CHNG_DT</span><span class="api-tag">CHNG_BF_CN</span><span class="api-tag">CHNG_AF_CN</span><span class="api-tag">CHNG_PRVNS</span>
            </div>
          </div>

          <div class="api-item" id="api-I2860">
            <div class="api-header">
              <label class="api-check"><input type="checkbox" checked onchange="updateApiCount()"><strong>I2860</strong> â€” ê±´ê°•ê¸°ëŠ¥ì‹í’ˆì—…ì†Œ ì¸í—ˆê°€ ë³€ê²½ ì •ë³´</label>
              <span class="api-count">ë³€ê²½ë¶„</span>
            </div>
            <div class="api-fields">
              <span class="api-tag">BSSH_NM</span><span class="api-tag">INDUTY_CD_NM</span><span class="api-tag">LCNS_NO</span><span class="api-tag">TELNO</span><span class="api-tag">SITE_ADDR</span><span class="api-tag">CHNG_DT</span><span class="api-tag">CHNG_BF_CN</span><span class="api-tag">CHNG_AF_CN</span><span class="api-tag">CHNG_PRVNS</span>
            </div>
          </div>

        </div>
      </div>

      <!-- ìˆ˜ì§‘ í˜„í™© -->
      <div class="card">
        <div class="card-hd"><h3>ğŸ“Š ìˆ˜ì§‘ í˜„í™©</h3><div class="right"><button class="btn btn-secondary btn-sm" onclick="loadCollectStatus()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button></div></div>
        <div class="card-bd">
          <div id="collectStatusArea" style="font-size:12px;color:#8892a4;text-align:center;padding:20px">
            API ì„œë²„ ì—°ê²° í›„ ìˆ˜ì§‘ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<div class="toast" id="toastEl"></div>

<script>
const pageNames = {
  customerList:'ê³ ê°ì‚¬ ê´€ë¦¬', customerReg:'ê³ ê°ì‚¬ ê´€ë¦¬ > ì‹ ê·œ ë“±ë¡', customerDetail:'ê³ ê°ì‚¬ ê´€ë¦¬ > ìƒì„¸',
  bizSearch:'ì—…ì²´ì¡°íšŒ',
  daily:'ì—…ë¬´ì¼ì§€', dailyWrite:'ì—…ë¬´ì¼ì§€ > ì‘ì„±', dailyDetail:'ì—…ë¬´ì¼ì§€ > ìƒì„¸',
  vehicle:'ì°¨ëŸ‰ì¼ì§€', collection:'ë¯¸ìˆ˜ê¸ˆ í™œë™ ë‚´ì—­',
  estimate:'ê²¬ì ì„œ ê´€ë¦¬', trade:'ê±°ë˜ëª…ì„¸í‘œ ê´€ë¦¬', urgent:'ê¸´ê¸‰ í˜‘ì¡° ìš”ì²­',
  arManage:'ì„¸ê¸ˆê³„ì‚°ì„œë¯¸ë°œí–‰', invoice:'ê³„ì‚°ì„œ ë°œí–‰ ìŠ¹ì¸ìš”ì²­',
  apiSettings:'API ìˆ˜ì§‘ ì„¤ì •'
};

// ============================================================
// ë“±ê¸‰ ì ìˆ˜ ìë™ ê³„ì‚° ì—”ì§„
// ============================================================
var _cachedGradeRules = null;
var _cachedSignalRules = null;
// ë³µí•© ë§¤ì¹­ ë§µ (ì¸í—ˆê°€ ê¸°ì¤€)
var _companyByBizNo = {};
var _companyByLicNo = {};
var _companyByLicName = {};
var _companyByName2 = {};
// ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜ ê³„ì‚° ê²°ê³¼
var _companyReceivables = {};    // companyKey â†’ { oldestDate, totalAmount }
var _companyReceiptStats = {};   // companyKey â†’ { annualRevenue, monthlyFrequency, tradeDuration }
var _companyTrafficLight = {};   // companyKey â†’ 'green'|'blue'|..
var _rawReceipts = [];           // ìºì‹œëœ ì ‘ìˆ˜ ë°ì´í„°

function getGradeRules() {
    if (_cachedGradeRules) return _cachedGradeRules;
    return JSON.parse(localStorage.getItem('bfl_grade_rules') || 'null') || {
        gradeThresholds: { vip: 90, a: 70, b: 50 },
        revenue:      { scores: [5,10,20,30,40], thresholds: [1000,3000,5000,10000] },
        frequency:    { scores: [5,10,15,20,25], thresholds: [1,3,5,10] },
        duration:     { scores: [3,6,9,12,15],   thresholds: [1,2,3,5] },
        payment:      { scores: [3,6,9,12,15] },
        department:   { scores: [1,3,5], conditions: ['ì§€ì‚¬','ê³ ê°ê´€ë¦¬','ê³ ê°ì§€ì›íŒ€, ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€'] },
        receiptType:  { scores: [1,3,5], conditions: ['íƒë°°ì ‘ìˆ˜','ë°©ë¬¸ì ‘ìˆ˜','í™ˆí˜ì´ì§€ì ‘ìˆ˜'] }
    };
}

function getSignalRules() {
    if (_cachedSignalRules) return _cachedSignalRules;
    return JSON.parse(localStorage.getItem('bfl_signal_rules') || 'null') || {
        green:30, blueMin:31, blueMax:60, yellowMin:61, yellowMax:90,
        orangeMin:91, orangeMax:120, redMin:121
    };
}

/**
 * ë³µí•© ë§¤ì¹­: ì ‘ìˆ˜ ë°ì´í„°ì—ì„œ ê±°ë˜ì²˜ ì°¾ê¸°
 * ìš°ì„ ìˆœìœ„: ì‚¬ì—…ìë²ˆí˜¸ â†’ ì¸í—ˆê°€ë²ˆí˜¸ â†’ ì¸í—ˆê°€ì˜ì—…ì†Œëª… â†’ íšŒì‚¬ëª…
 */
function findCompanyForReceipt(r) {
    return _companyByBizNo[(r.bizNo || '').trim()]
        || _companyByLicNo[(r.licNo || '').trim()]
        || _companyByLicName[(r.companyName || '').trim()]
        || _companyByName2[(r.companyName || '').trim()]
        || null;
}

/**
 * ë¯¸ìˆ˜ê¸ˆ ê¸°ë°˜ ì‹ í˜¸ë“± ìë™ ê³„ì‚°
 * @param {Object} receivableInfo - { oldestDate, totalAmount }
 * @returns {string} ì‹ í˜¸ë“± ìƒ‰ìƒ
 */
function calcTrafficLight(receivableInfo) {
    if (!receivableInfo || receivableInfo.totalAmount === 0 || !receivableInfo.oldestDate) return 'green';
    var debtStart = new Date(receivableInfo.oldestDate);
    var now = new Date();
    var days = Math.floor((now - debtStart) / (1000 * 60 * 60 * 24));
    var rules = getSignalRules();
    if (days <= rules.green) return 'green';
    if (days <= rules.blueMax) return 'blue';
    if (days <= rules.yellowMax) return 'yellow';
    if (days <= rules.orangeMax) return 'orange';
    return 'red';
}

/**
 * ê±°ë˜ì²˜ë³„ ì ‘ìˆ˜ í†µê³„ ê³„ì‚°
 * @param {string} companyKey - ê±°ë˜ì²˜ í‚¤
 * @param {Array} receipts - ì „ì²´ ì ‘ìˆ˜ ë°ì´í„°
 */
function calcReceiptStats(companyKey, receipts) {
    var now = new Date();
    var oneYearAgo = new Date(now);
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
    var oneYearAgoStr = oneYearAgo.toISOString().slice(0, 10);

    var totalFeeLastYear = 0;
    var receiptDates = [];
    var monthSet = {};

    for (var i = 0; i < receipts.length; i++) {
        var r = receipts[i];
        var cust = findCompanyForReceipt(r);
        if (!cust) continue;
        var key = cust.id || (cust.company || '').trim();
        if (key !== companyKey) continue;

        var rd = r.receiptDate || '';
        if (rd) receiptDates.push(rd);

        if (rd >= oneYearAgoStr) {
            totalFeeLastYear += (r.feeTotal || 0);
            var ym = rd.slice(0, 7);
            monthSet[ym] = (monthSet[ym] || 0) + 1;
        }
    }

    var annualRevenue = Math.round(totalFeeLastYear / 10000);
    var monthKeys = Object.keys(monthSet);
    var monthlyFrequency = monthKeys.length > 0 ? Math.round(monthKeys.reduce(function(s, k) { return s + monthSet[k]; }, 0) / monthKeys.length) : 0;
    var tradeDuration = 0;
    if (receiptDates.length > 0) {
        receiptDates.sort();
        var firstDate = new Date(receiptDates[0]);
        tradeDuration = Math.max(0, Math.round((now - firstDate) / (1000 * 60 * 60 * 24 * 365) * 10) / 10);
    }

    return { annualRevenue: annualRevenue, monthlyFrequency: monthlyFrequency, tradeDuration: tradeDuration };
}

/**
 * ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ ë° ê±°ë˜ì²˜ë³„ ë¯¸ìˆ˜ê¸ˆ/í†µê³„/ì‹ í˜¸ë“± ê³„ì‚°
 * @param {Array} companies - ê±°ë˜ì²˜ ëª©ë¡
 */
async function loadReceiptDataForCompanies(companies) {
    // ë³µí•© ë§¤ì¹­ ë§µ êµ¬ì¶•
    _companyByBizNo = {}; _companyByLicNo = {}; _companyByLicName = {}; _companyByName2 = {};
    companies.forEach(function(c) {
        if (c.bizNo) _companyByBizNo[c.bizNo.trim()] = c;
        var name = (c.company || c.name || '').trim();
        if (name) _companyByName2[name] = c;
        (c.licenses || []).forEach(function(lic) {
            if (lic.licNo) _companyByLicNo[lic.licNo.trim()] = c;
            if (lic.licBizName) _companyByLicName[lic.licBizName.trim()] = c;
        });
    });

    // ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ
    try {
        _rawReceipts = await fsGetReceipts({ limit: 5000 });
    } catch(e) {
        console.warn('ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        _rawReceipts = [];
    }

    // ë¯¸ìˆ˜ê¸ˆ ì§‘ê³„ (ìˆ˜ìˆ˜ë£Œ>0 & ê²°ì œì¼ ì—†ìŒ = ë¯¸ìˆ˜ê¸ˆ)
    _companyReceivables = {};
    _rawReceipts.forEach(function(r) {
        var cust = findCompanyForReceipt(r);
        if (!cust) return;
        var key = cust.id || (cust.company || '').trim();
        if (!_companyReceivables[key]) _companyReceivables[key] = { oldestDate: null, totalAmount: 0 };
        var fee = r.feeTotal || 0;
        var hasPaid = !!(r.payDate);
        if (fee > 0 && !hasPaid) {
            _companyReceivables[key].totalAmount += fee;
            var rd = r.receiptDate || '';
            if (rd && (!_companyReceivables[key].oldestDate || rd < _companyReceivables[key].oldestDate)) {
                _companyReceivables[key].oldestDate = rd;
            }
        }
    });

    // ì ‘ìˆ˜ í†µê³„ + ì‹ í˜¸ë“± ê³„ì‚°
    _companyReceiptStats = {};
    _companyTrafficLight = {};
    var processedKeys = {};
    companies.forEach(function(c) {
        var key = c.id || (c.company || '').trim();
        if (!processedKeys[key]) {
            processedKeys[key] = true;
            _companyReceiptStats[key] = calcReceiptStats(key, _rawReceipts);
            _companyTrafficLight[key] = calcTrafficLight(_companyReceivables[key]);
        }
    });
}

/**
 * ê³ ê° ë“±ê¸‰ ì ìˆ˜ ê³„ì‚° (ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜)
 * @param {Object} customer - ê±°ë˜ì²˜ ë°ì´í„°
 * @param {Object} [receiptStats] - ì ‘ìˆ˜ í†µê³„
 * @param {string} [computedTrafficLight] - ë¯¸ìˆ˜ê¸ˆ ê¸°ë°˜ ê³„ì‚°ëœ ì‹ í˜¸ë“±
 */
function calcCustomerScore(customer, receiptStats, computedTrafficLight) {
    var rules = getGradeRules();
    var detail = {};
    var total = 0;
    var stats = receiptStats || {};
    var tl = computedTrafficLight || customer.trafficLight || 'green';

    // 1. ì—°ê°„ ë§¤ì¶œì•¡ (ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜)
    var rev = rules.revenue || { scores:[5,10,20,30,40], thresholds:[1000,3000,5000,10000] };
    var revVal = stats.annualRevenue || customer.annualRevenue || 0;
    var revScore = rev.scores[0];
    for (var i = rev.thresholds.length - 1; i >= 0; i--) {
        if (revVal >= rev.thresholds[i]) { revScore = rev.scores[i + 1]; break; }
    }
    detail.revenue = { label:'ì—°ê°„ë§¤ì¶œì•¡', value: Number(revVal).toLocaleString() + 'ë§Œì›', score: revScore, max: rev.scores[rev.scores.length-1] };
    total += revScore;

    // 2. ê±°ë˜ ë¹ˆë„ (ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜)
    var freq = rules.frequency || { scores:[5,10,15,20,25], thresholds:[1,3,5,10] };
    var freqVal = stats.monthlyFrequency || customer.monthlyFrequency || 0;
    var freqScore = freq.scores[0];
    for (var i = freq.thresholds.length - 1; i >= 0; i--) {
        if (freqVal >= freq.thresholds[i]) { freqScore = freq.scores[i + 1]; break; }
    }
    detail.frequency = { label:'ê±°ë˜ë¹ˆë„', value: 'ì›” ' + freqVal + 'ê±´', score: freqScore, max: freq.scores[freq.scores.length-1] };
    total += freqScore;

    // 3. ê±°ë˜ ê¸°ê°„ (ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜)
    var dur = rules.duration || { scores:[3,6,9,12,15], thresholds:[1,2,3,5] };
    var durVal = stats.tradeDuration || customer.tradeDuration || 0;
    var durScore = dur.scores[0];
    for (var i = dur.thresholds.length - 1; i >= 0; i--) {
        if (durVal >= dur.thresholds[i]) { durScore = dur.scores[i + 1]; break; }
    }
    detail.duration = { label:'ê±°ë˜ê¸°ê°„', value: durVal + 'ë…„', score: durScore, max: dur.scores[dur.scores.length-1] };
    total += durScore;

    // 4. ê²°ì œ ì‹ ë¢°ë„ (ë¯¸ìˆ˜ê¸ˆ ê¸°ë°˜ ê³„ì‚°ëœ ì‹ í˜¸ë“± ì‚¬ìš©)
    var pay = rules.payment || { scores:[3,6,9,12,15] };
    var tlMap = { red:0, orange:1, yellow:2, blue:3, green:4 };
    var tlIdx = tlMap[tl] !== undefined ? tlMap[tl] : 4;
    var payScore = pay.scores[tlIdx];
    var tlLabels = { green:'ì •ìƒ', blue:'ì–‘í˜¸', yellow:'ì£¼ì˜', orange:'ê²½ê³ ', red:'ìœ„í—˜' };
    detail.payment = { label:'ê²°ì œì‹ ë¢°ë„', value: tlLabels[tl] || 'ì •ìƒ', score: payScore, max: pay.scores[pay.scores.length-1] };
    total += payScore;

    // 5. ë‹´ë‹¹ë¶€ì„œ
    var dept = rules.department || { scores:[1,3,5], conditions:['ì§€ì‚¬','ê³ ê°ê´€ë¦¬','ê³ ê°ì§€ì›íŒ€, ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€'] };
    var custDept = customer.department || '';
    var deptScore = 0;
    for (var i = dept.conditions.length - 1; i >= 0; i--) {
        if (dept.conditions[i].indexOf(custDept) !== -1 && custDept) { deptScore = dept.scores[i]; break; }
    }
    detail.department = { label:'ë‹´ë‹¹ë¶€ì„œ', value: custDept || 'ë¯¸ì§€ì •', score: deptScore, max: dept.scores[dept.scores.length-1] };
    total += deptScore;

    // 6. ì ‘ìˆ˜í˜•íƒœ
    var rcpt = rules.receiptType || { scores:[1,3,5], conditions:['íƒë°°ì ‘ìˆ˜','ë°©ë¬¸ì ‘ìˆ˜','í™ˆí˜ì´ì§€ì ‘ìˆ˜'] };
    var custRcpt = customer.receiptType || '';
    var rcptScore = 0;
    for (var i = rcpt.conditions.length - 1; i >= 0; i--) {
        if (rcpt.conditions[i] === custRcpt) { rcptScore = rcpt.scores[i]; break; }
    }
    detail.receiptType = { label:'ì ‘ìˆ˜í˜•íƒœ', value: custRcpt || 'ì—†ìŒ', score: rcptScore, max: rcpt.scores[rcpt.scores.length-1] };
    total += rcptScore;

    // ë“±ê¸‰ íŒì •
    var th = rules.gradeThresholds || { vip:90, a:70, b:50 };
    var grade = 'C';
    if (total >= th.vip) grade = 'VIP';
    else if (total >= th.a) grade = 'A';
    else if (total >= th.b) grade = 'B';

    return { total: total, grade: grade, detail: detail };
}

// ============================================================
// ì»¬ëŸ¼ ì •ì˜ ë°°ì—´ â€” í…Œì´ë¸” ë Œë”ë§ì˜ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤
// ============================================================
var COLUMNS = [
  { key:'trafficLight', label:'ì‹ í˜¸ë“±', defaultVisible:true, render:function(c){
    var sr = getSignalRules();
    var custKey = c.id || (c.company || '').trim();
    var tl = _companyTrafficLight[custKey] || 'green';
    var recv = _companyReceivables[custKey];
    var tipText = '';
    var tlLabels2 = {green:'ì •ìƒ',blue:'ì–‘í˜¸',yellow:'ì£¼ì˜',orange:'ê²½ê³ ',red:'ìœ„í—˜'};
    tipText = 'ìˆ˜ê¸ˆìƒíƒœ: ' + (tlLabels2[tl]||tl);
    if (recv && recv.totalAmount > 0) {
      var days2 = Math.floor((new Date() - new Date(recv.oldestDate)) / 86400000);
      tipText += '\në¯¸ìˆ˜ê¸ˆ: ' + recv.totalAmount.toLocaleString() + 'ì›\nê²½ê³¼: ' + days2 + 'ì¼';
    } else {
      tipText += '\në¯¸ìˆ˜ê¸ˆ ì—†ìŒ';
    }
    return '<td class="center"><span class="tl tl-' + tl + '" data-tooltip="' + tipText + '"></span></td>';
  }},
  { key:'grade', label:'ë“±ê¸‰', defaultVisible:true, render:function(c){
    var custKey = c.id || (c.company || '').trim();
    var stats = _companyReceiptStats[custKey] || {};
    var tl = _companyTrafficLight[custKey] || 'green';
    var si = calcCustomerScore(c, stats, tl);
    var d = si.detail;
    var tip = 'ì´ì : ' + si.total + '/105\n'
      + d.revenue.label + ': ' + d.revenue.score + '/' + d.revenue.max + ' (' + d.revenue.value + ')\n'
      + d.frequency.label + ': ' + d.frequency.score + '/' + d.frequency.max + ' (' + d.frequency.value + ')\n'
      + d.duration.label + ': ' + d.duration.score + '/' + d.duration.max + ' (' + d.duration.value + ')\n'
      + d.payment.label + ': ' + d.payment.score + '/' + d.payment.max + ' (' + d.payment.value + ')\n'
      + d.department.label + ': ' + d.department.score + '/' + d.department.max + ' (' + d.department.value + ')\n'
      + d.receiptType.label + ': ' + d.receiptType.score + '/' + d.receiptType.max + ' (' + d.receiptType.value + ')';
    var g = si.grade;
    var t = {
      'VIP':'<span class="tag tag-vip" data-tooltip="' + tip + '">VIP</span>',
      'A':'<span class="tag tag-a" data-tooltip="' + tip + '">A</span>',
      'B':'<span class="tag tag-b" data-tooltip="' + tip + '">B</span>',
      'C':'<span class="tag tag-c" data-tooltip="' + tip + '">C</span>'
    };
    return '<td>' + (t[g] || t['C']) + '</td>';
  }},
  { key:'company', label:'íšŒì‚¬ëª…', defaultVisible:true, render:function(c){ return '<td><strong>'+(c.company||'')+'</strong></td>'; }},
  { key:'repName', label:'ëŒ€í‘œì', defaultVisible:true, render:function(c){ return '<td>'+(c.repName||'-')+'</td>'; }},
  { key:'bizNo', label:'ì‚¬ì—…ìë²ˆí˜¸', defaultVisible:true, render:function(c){ return '<td>'+(c.bizNo||'-')+'</td>'; }},
  { key:'contactName', label:'ë‹´ë‹¹ì', defaultVisible:true, render:function(c){ return '<td>'+(c.contactName||'-')+'</td>'; }},
  { key:'salesRep', label:'ì˜ì—…ë‹´ë‹¹', defaultVisible:true, render:function(c){ return '<td>'+(c.salesRep||'-')+'</td>'; }},
  { key:'status', label:'ê³„ì•½ìƒíƒœ', defaultVisible:true, render:function(c){ var t={'í™œë™':'<span class="tag tag-active">í™œë™</span>','íœ´ë©´':'<span class="tag tag-dormant">íœ´ë©´</span>','í•´ì§€':'<span class="tag" style="background:#fce4ec;color:#c62828">í•´ì§€</span>'}; return '<td>'+(t[c.status]||t['í™œë™'])+'</td>'; }},
  { key:'regDate', label:'ìµœê·¼ê±°ë˜', defaultVisible:true, render:function(c){ return '<td>'+(c.regDate||'-')+'</td>'; }},
  // --- ì¶”ê°€ ì»¬ëŸ¼ (ê¸°ë³¸ ìˆ¨ê¹€) ---
  { key:'bizType', label:'ì—…ì¢…', defaultVisible:false, render:function(c){ return '<td>'+(c.bizType||'-')+'</td>'; }},
  { key:'bizItem', label:'ì—…íƒœ', defaultVisible:false, render:function(c){ return '<td>'+(c.bizItem||'-')+'</td>'; }},
  { key:'corpNo', label:'ë²•ì¸ë²ˆí˜¸', defaultVisible:false, render:function(c){ return '<td>'+(c.corpNo||'-')+'</td>'; }},
  { key:'contactPhone', label:'ë‹´ë‹¹ìì „í™”', defaultVisible:false, render:function(c){ return '<td>'+(c.contactPhone||'-')+'</td>'; }},
  { key:'contactEmail', label:'ë‹´ë‹¹ìì´ë©”ì¼', defaultVisible:false, render:function(c){ return '<td style="font-size:11px">'+(c.contactEmail||'-')+'</td>'; }},
  { key:'address', label:'ì£¼ì†Œ', defaultVisible:false, render:function(c){ var a=((c.addr1||'')+' '+(c.addr2||'')).trim(); return '<td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+a+'">'+(a||'-')+'</td>'; }},
  { key:'companyEn', label:'ì˜ë¬¸íšŒì‚¬ëª…', defaultVisible:false, render:function(c){ return '<td style="font-size:11px">'+(c.companyEn||'-')+'</td>'; }},
  { key:'licField', label:'ì¸í—ˆê°€ë¶„ì•¼', defaultVisible:false, render:function(c){
    var lics = c.licenses && c.licenses.length > 0 ? c.licenses : (c.licField ? [{licField:c.licField}] : []);
    if (!lics.length) return '<td>-</td>';
    if (lics.length === 1) return '<td>'+(lics[0].licField||'-')+'</td>';
    var h = lics.map(function(l,i){ return '<div style="line-height:1.4"><span style="color:#999;font-size:10px">'+(i+1)+'.</span> '+(l.licField||'-')+'</div>'; }).join('');
    return '<td style="font-size:11px">'+h+'</td>';
  }},
  { key:'licNo', label:'ì¸í—ˆê°€ë²ˆí˜¸', defaultVisible:false, render:function(c){
    var lics = c.licenses && c.licenses.length > 0 ? c.licenses : (c.licNo ? [{licNo:c.licNo}] : []);
    if (!lics.length) return '<td>-</td>';
    if (lics.length === 1) return '<td style="font-size:11px">'+(lics[0].licNo||'-')+'</td>';
    var h = lics.map(function(l,i){ return '<div style="line-height:1.4"><span style="color:#999;font-size:10px">'+(i+1)+'.</span> '+(l.licNo||'-')+'</div>'; }).join('');
    return '<td style="font-size:11px">'+h+'</td>';
  }},
  { key:'licBizName', label:'ì¸í—ˆê°€ì‚¬ì—…ëª…', defaultVisible:false, render:function(c){
    var lics = c.licenses && c.licenses.length > 0 ? c.licenses : (c.licBizName ? [{bizName:c.licBizName}] : []);
    if (!lics.length) return '<td>-</td>';
    if (lics.length === 1) return '<td>'+(lics[0].bizName||lics[0].licBizName||'-')+'</td>';
    var h = lics.map(function(l,i){ return '<div style="line-height:1.4"><span style="color:#999;font-size:10px">'+(i+1)+'.</span> '+(l.bizName||l.licBizName||'-')+'</div>'; }).join('');
    return '<td style="font-size:11px">'+h+'</td>';
  }}
];

var COL_CONFIG_KEY = 'bfl_colConfig';
var _colMap = {}; COLUMNS.forEach(function(c){ _colMap[c.key] = c; });

function getColConfig() {
  var saved = localStorage.getItem(COL_CONFIG_KEY);
  if (saved) {
    try {
      var cfg = JSON.parse(saved);
      // ìƒˆë¡œ ì¶”ê°€ëœ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ columns ëì— ì¶”ê°€
      COLUMNS.forEach(function(c) { if (cfg.columns.indexOf(c.key)===-1) cfg.columns.push(c.key); });
      return cfg;
    } catch(e) {}
  }
  var keys = COLUMNS.filter(function(c){ return c.defaultVisible; }).map(function(c){ return c.key; });
  return { columns: COLUMNS.map(function(c){return c.key;}), visible: keys };
}
function saveColConfig(cfg) { localStorage.setItem(COL_CONFIG_KEY, JSON.stringify(cfg)); }
function getVisibleColumns() {
  var cfg = getColConfig();
  return cfg.columns.filter(function(k){ return cfg.visible.indexOf(k)!==-1 && _colMap[k]; }).map(function(k){ return _colMap[k]; });
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  document.getElementById('page-' + id).style.display = 'block';
  document.getElementById('topSub').textContent = pageNames[id] || '';
  // ì‚¬ì´ë“œë°” í•˜ìœ„ ë©”ë‰´ active ìƒíƒœ ì—…ë°ì´íŠ¸
  const salesGroup = document.querySelector('[data-id="sales"]')?.closest('.nav-group');
  if (salesGroup) {
    salesGroup.querySelectorAll('.nav-sub-item').forEach(el => el.classList.remove('active'));
    const navId = (id === 'customerReg' || id === 'customerDetail') ? 'customerList' : (id === 'dailyWrite' || id === 'dailyDetail') ? 'daily' : id;
    const sideItem = salesGroup.querySelector('.nav-sub-item[data-page="' + navId + '"]');
    if (sideItem) sideItem.classList.add('active');
  }
  document.getElementById('contentArea').scrollTop = 0;
  if(id === 'bizSearch') setTimeout(initSidoMap, 150);
  if(id === 'apiSettings') setTimeout(updateApiCount, 100);
  if(id === 'customerReg') resetCustomerRegForm();
  if(id === 'customerList') loadCustomers();
}
function closePopup(id) { document.getElementById(id).classList.remove('show'); }
function toast(msg) {
  const t = document.getElementById('toastEl');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
// ============================================================
// ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ (Daum Postcode API)
// ============================================================
function openPostcodeSearch() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('regZipcode').value = data.zonecode;
      document.getElementById('regAddr1').value = data.roadAddress || data.jibunAddress;
      document.getElementById('regAddr2').value = '';
      document.getElementById('regAddr2').focus();
    }
  }).open();
}

// ìƒì„¸ í˜ì´ì§€: ì‚¬ì—…ìë“±ë¡ì¦ ì£¼ì†Œ ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
function openDetPostcodeSearch() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('detZipcode').value = data.zonecode;
      document.getElementById('detAddr1').value = data.roadAddress || data.jibunAddress;
      document.getElementById('detAddr2').value = '';
      document.getElementById('detAddr2').focus();
      // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
      var fullAddr = (data.roadAddress || data.jibunAddress || '').trim();
      convertToEnglishAddress(fullAddr, function(eng) {
        var enField = document.getElementById('detAddrEn');
        if (enField) { enField.value = eng; enField.style.background = '#e3f2fd'; setTimeout(function() { enField.style.background = _detailEditMode ? '#fff' : '#f8f9fb'; }, 3000); }
      });
    }
  }).open();
}

// ë²”ìš©: ì¹´ì¹´ì˜¤ ì£¼ì†Œ APIë¡œ ì£¼ì†Œì—ì„œ ìš°í¸ë²ˆí˜¸/ë„ë¡œëª…ì£¼ì†Œ/ìƒì„¸ì£¼ì†Œ íŒŒì‹±
// callback(zipcode, roadAddr, detailAddr)
function lookupAddressFromKakao(address, callback) {
  if (!address) return;
  // ê´„í˜¸ ì•ˆ ë‚´ìš© ì œê±° (ë™ëª… ë“±)
  var cleanAddr = address.replace(/\([^)]*\)/g, '').trim();
  // ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬: ë„ë¡œëª…ì£¼ì†Œ ë’¤ì˜ ", ìƒì„¸" ë˜ëŠ” "ë²ˆì§€ ìƒì„¸"
  var mainAddr = cleanAddr;
  var detailAddr = '';
  // ì‰¼í‘œ êµ¬ë¶„
  var commaMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s*[,]\s*(.+)$/);
  if (commaMatch) {
    mainAddr = commaMatch[1].trim();
    detailAddr = commaMatch[2].trim();
  } else {
    // ì‰¼í‘œ ì—†ìœ¼ë©´ ê±´ë¬¼ë²ˆí˜¸ ì´í›„ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬ (ì˜ˆ: "ì€í–‰ì •ë¡œ4ê¸¸ 5-1 1ì¸µ")
    var spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(\d+ì¸µ.*)$/);
    if (!spaceMatch) {
      spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(.+ì¸µ.*)$/);
    }
    if (spaceMatch) {
      mainAddr = spaceMatch[1].trim();
      detailAddr = spaceMatch[2].trim();
    }
  }
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(mainAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      if (roadAddr && roadAddr.zone_no) {
        callback(roadAddr.zone_no, roadAddr.address_name, detailAddr);
      } else if (doc.address) {
        callback('', doc.address.address_name, detailAddr);
      }
    }
  })
  .catch(function(e) { console.log('ì¹´ì¹´ì˜¤ ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

// OCR ì£¼ì†Œë¡œ ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ (Kakao ì£¼ì†Œê²€ìƒ‰ REST API)
function lookupZipcodeFromAddress(address) {
  if (!address) return;
  // ê´„í˜¸ ì•ˆ ë‚´ìš© ì œê±° (ë™ëª… ë“±)
  var cleanAddr = address.replace(/\([^)]*\)/g, '').trim();
  // ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬: ë²ˆì§€/ê±´ë¬¼ë²ˆí˜¸ ë’¤ì˜ ì¸µ/í˜¸ ë“±
  var mainAddr = cleanAddr;
  var detailAddr = '';
  // 1) ì‰¼í‘œ êµ¬ë¶„
  var detailMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s*[,]\s*(.+)$/);
  if (detailMatch) {
    mainAddr = detailMatch[1].trim();
    detailAddr = detailMatch[2].trim();
  } else {
    // 2) ì‰¼í‘œ ì—†ì´ ê±´ë¬¼ë²ˆí˜¸ ë’¤ì˜ "Nì¸µ" ë“± ë¶„ë¦¬
    var spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(\d+ì¸µ.*)$/);
    if (!spaceMatch) spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(.+ì¸µ.*)$/);
    if (spaceMatch) {
      mainAddr = spaceMatch[1].trim();
      detailAddr = spaceMatch[2].trim();
    }
  }
  // Kakao ì£¼ì†Œê²€ìƒ‰ REST API (KAKAO_REST_KEYëŠ” í•˜ë‹¨ ìŠ¤í¬ë¦½íŠ¸ì— ì •ì˜)
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(mainAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      if (roadAddr && roadAddr.zone_no) {
        document.getElementById('regZipcode').value = roadAddr.zone_no;
        document.getElementById('regAddr1').value = roadAddr.address_name;
        if (detailAddr) document.getElementById('regAddr2').value = detailAddr;
        highlightField('regZipcode');
        highlightField('regAddr1');
        setTimeout(updateBizEngAddress, 300);
      } else if (doc.address) {
        document.getElementById('regAddr1').value = doc.address.address_name;
        if (detailAddr) document.getElementById('regAddr2').value = detailAddr;
        setTimeout(updateBizEngAddress, 300);
      }
    }
  })
  .catch(function(e) { console.log('ìš°í¸ë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

function highlightField(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.style.background = '#e8f5e9';
  el.style.borderColor = '#66bb6a';
  setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
}

// --- ì¸í—ˆê°€ ì†Œì¬ì§€: ìš°í¸ë²ˆí˜¸ ì°¾ê¸° (Daum Postcode API) ---
function openLicPostcodeSearch(idx, isDetail) {
  var prefix = isDetail ? 'detLic' : 'lic';
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById(prefix + 'Zipcode_' + idx).value = data.zonecode;
      document.getElementById(prefix + 'Addr_' + idx).value = data.roadAddress || data.jibunAddress;
      document.getElementById(prefix + 'Addr2_' + idx).value = '';
      document.getElementById(prefix + 'Addr2_' + idx).focus();
      // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
      if (isDetail) {
        var fullAddr = (data.roadAddress || data.jibunAddress || '').trim();
        convertToEnglishAddress(fullAddr, function(eng) {
          var enField = document.getElementById('detLicAddrEn_' + idx);
          if (enField) { enField.value = eng; enField.style.background = '#e3f2fd'; setTimeout(function() { enField.style.background = _detailEditMode ? '#fff' : '#f8f9fb'; }, 3000); }
        });
      } else {
        setTimeout(function() { updateLicEngAddress(idx); }, 300);
      }
    }
  }).open();
}

// --- ì¸í—ˆê°€ ì†Œì¬ì§€: OCR ì£¼ì†Œì—ì„œ ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ ---
function lookupLicZipcodeFromAddress(idx, address) {
  if (!address) return;
  var cleanAddr = address.replace(/\([^)]*\)/g, '').trim();
  var mainAddr = cleanAddr;
  var detailAddr = '';
  // 1) ì‰¼í‘œ êµ¬ë¶„
  var detailMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s*[,]\s*(.+)$/);
  if (detailMatch) {
    mainAddr = detailMatch[1].trim();
    var candidate = detailMatch[2].trim();
    if (!/^\d|^[ê°€-í£]{1,2}(íŠ¹ë³„|ê´‘ì—­)?ì‹œ|^[ê°€-í£]{1,2}(ë„)\s|^ê²½ê¸°|^ì¶©[ë¶ë‚¨]|^ì „[ë¶ë‚¨]|^ê²½[ë¶ë‚¨]|^ê°•ì›|^ì œì£¼|^ì„¸ì¢…/.test(candidate)) {
      detailAddr = candidate;
    }
  } else {
    // 2) ì‰¼í‘œ ì—†ì´ ê±´ë¬¼ë²ˆí˜¸ ë’¤ì˜ "Nì¸µ" ë“± ë¶„ë¦¬
    var spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(\d+ì¸µ.*)$/);
    if (!spaceMatch) spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(.+ì¸µ.*)$/);
    if (spaceMatch) {
      mainAddr = spaceMatch[1].trim();
      detailAddr = spaceMatch[2].trim();
    }
  }
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(mainAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      if (roadAddr && roadAddr.zone_no) {
        document.getElementById('licZipcode_' + idx).value = roadAddr.zone_no;
        document.getElementById('licAddr_' + idx).value = roadAddr.address_name;
        if (detailAddr) document.getElementById('licAddr2_' + idx).value = detailAddr;
        highlightField('licZipcode_' + idx);
        highlightField('licAddr_' + idx);
        setTimeout(function() { updateLicEngAddress(idx); }, 300);
      } else if (doc.address) {
        document.getElementById('licAddr_' + idx).value = doc.address.address_name;
        if (detailAddr) document.getElementById('licAddr2_' + idx).value = detailAddr;
        setTimeout(function() { updateLicEngAddress(idx); }, 300);
      }
    }
  })
  .catch(function(e) { console.log('ì¸í—ˆê°€ ìš°í¸ë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

// ============================================================
// ê³ ê°ì‚¬ ë“±ë¡ ì €ì¥ ë° ëª©ë¡ ë¡œë“œ (localStorage)
// ============================================================
async function saveCustomer() {
  // í•„ìˆ˜ê°’ ê²€ì¦
  var company = (document.getElementById('regCompany').value || '').trim();
  var repName = (document.getElementById('regRepName').value || '').trim();
  var bizNo = (document.getElementById('regBizNo').value || '').trim();
  if (!company) { toast('âš ï¸ íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regCompany').focus(); return; }
  if (!repName) { toast('âš ï¸ ëŒ€í‘œìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regRepName').focus(); return; }
  if (!bizNo) { toast('âš ï¸ ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regBizNo').focus(); return; }

  // ë°ì´í„° ìˆ˜ì§‘
  var gradeSel = document.getElementById('regGrade');
  var grade = gradeSel ? gradeSel.value : 'ë“±ê¸‰ ì„ íƒ';
  if (grade === 'ë“±ê¸‰ ì„ íƒ') grade = 'B';
  var statusSel = document.getElementById('regStatus');
  var status = statusSel ? statusSel.value : 'í™œë™';
  var salesRep = document.getElementById('regSalesRep');
  var salesRepVal = (salesRep && salesRep.value !== 'ì„ íƒ') ? salesRep.value : 'ì´ì£¼ì„';
  var contactName = (document.getElementById('regCName') || {}).value || '';

  var cust = {
    company: company,
    repName: repName,
    bizNo: bizNo,
    corpNo: (document.getElementById('regCorpNo') || {}).value || '',
    bizType: (document.getElementById('regBizType') || {}).value || '',
    bizItem: (document.getElementById('regBizItem') || {}).value || '',
    grade: grade,
    status: status,
    zipcode: (document.getElementById('regZipcode') || {}).value || '',
    addr1: (document.getElementById('regAddr1') || {}).value || '',
    addr2: (document.getElementById('regAddr2') || {}).value || '',
    companyEn: (document.getElementById('regCompanyNameEn') || {}).value || '',
    repNameEn: (document.getElementById('regRepNameEn') || {}).value || '',
    addrEn: (document.getElementById('regAddrEn') || {}).value || '',
    contactName: contactName,
    contactPhone: (document.getElementById('regCPhone') || {}).value || '',
    contactEmail: (document.getElementById('regCEmail') || {}).value || '',
    salesRep: salesRepVal,
    department: (document.getElementById('regDepartment') || {}).value || '',
    receiptType: (document.getElementById('regReceiptType') || {}).value || '',
    annualRevenue: 0,
    monthlyFrequency: 0,
    tradeDuration: 0,
    // ì¸í—ˆê°€ ì •ë³´ (ë‹¤ì¤‘ ì¹´ë“œ ì§€ì›)
    licenses: (function() {
      var licArr = [];
      var indices = getLicenseCardIndices();
      for (var li = 0; li < indices.length; li++) {
        var ix = indices[li];
        var lic = {
          licField: (document.getElementById('licField_' + ix) || {}).value || '',
          licBizForm: (document.getElementById('licBizForm_' + ix) || {}).value || '',
          licRepName: (document.getElementById('licRepName_' + ix) || {}).value || '',
          licNo: (document.getElementById('licNo_' + ix) || {}).value || '',
          licBizName: (document.getElementById('licBizName_' + ix) || {}).value || '',
          licZipcode: (document.getElementById('licZipcode_' + ix) || {}).value || '',
          licAddr: (document.getElementById('licAddr_' + ix) || {}).value || '',
          licAddr2: (document.getElementById('licAddr2_' + ix) || {}).value || '',
          licBizNameEn: (document.getElementById('licBizNameEn_' + ix) || {}).value || '',
          licRepNameEn: (document.getElementById('licRepNameEn_' + ix) || {}).value || '',
          licAddrEn: (document.getElementById('licAddrEn_' + ix) || {}).value || ''
        };
        // ìµœì†Œ 1ê°œ í•„ë“œë¼ë„ ê°’ì´ ìˆìœ¼ë©´ ì €ì¥
        var hasData = lic.licField !== 'ì„ íƒ' || lic.licBizForm !== 'ì„ íƒ' || lic.licRepName || lic.licNo || lic.licBizName;
        if (hasData) licArr.push(lic);
      }
      return licArr;
    })(),
    // í•˜ìœ„ í˜¸í™˜ì„±: ì²« ë²ˆì§¸ ì¸í—ˆê°€ ì •ë³´ë¥¼ ê¸°ì¡´ í•„ë“œì—ë„ ì €ì¥
    licField: (document.getElementById('licField_1') || {}).value || '',
    licBizForm: (document.getElementById('licBizForm_1') || {}).value || '',
    licRepName: (document.getElementById('licRepName_1') || {}).value || '',
    licNo: (document.getElementById('licNo_1') || {}).value || '',
    licBizName: (document.getElementById('licBizName_1') || {}).value || '',
    licZipcode: (document.getElementById('licZipcode_1') || {}).value || '',
    licAddr: (document.getElementById('licAddr_1') || {}).value || '',
    licAddr2: (document.getElementById('licAddr2_1') || {}).value || '',
    licBizNameEn: (document.getElementById('licBizNameEn_1') || {}).value || '',
    licRepNameEn: (document.getElementById('licRepNameEn_1') || {}).value || '',
    licAddrEn: (document.getElementById('licAddrEn_1') || {}).value || '',
    // ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì
    taxName: (document.getElementById('regTaxName') || {}).value || '',
    taxPhone: (document.getElementById('regTaxPhone') || {}).value || '',
    taxEmail: (document.getElementById('regTaxEmail') || {}).value || '',
    // ë©”ëª¨
    memo: (document.getElementById('regMemo') || {}).value || '',
    regDate: new Date().toISOString().slice(0, 10),
    changeLog: []
  };

  // Firestoreì— ì €ì¥
  try {
    await fsSaveCompany(cust);
  } catch(e) {
    toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    return;
  }

  toast('âœ… ê³ ê°ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
  setTimeout(function() { showPage('customerList'); }, 1200);
}

// 1ë²ˆ ë‹´ë‹¹ì â†’ ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì ë³µì‚¬
function copyContactToTax() {
  var n = (document.getElementById('regCName') || {}).value || '';
  var p = (document.getElementById('regCPhone') || {}).value || '';
  var e = (document.getElementById('regCEmail') || {}).value || '';
  if (!n && !p && !e) { toast('âš ï¸ ë¨¼ì € 4ë²ˆ ê³ ê°ì‚¬ ë‹´ë‹¹ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  document.getElementById('regTaxName').value = n;
  document.getElementById('regTaxPhone').value = p;
  document.getElementById('regTaxEmail').value = e;
  toast('ğŸ“‹ 1ë²ˆ ë‹´ë‹¹ì ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================
// ê³ ê°ì‚¬ ëª©ë¡ í…Œì´ë¸” í†µí•© ë Œë”ë§
// ============================================================
var _custSearchQuery = '';

async function loadCustomers() {
  // ë“±ê¸‰/ì‹ í˜¸ë“± ê·œì¹™ ìºì‹± (ë Œë”ë§ ë£¨í”„ ë°–ì—ì„œ 1íšŒë§Œ ë¡œë“œ)
  _cachedGradeRules = JSON.parse(localStorage.getItem('bfl_grade_rules') || 'null') || getGradeRules();
  _cachedSignalRules = JSON.parse(localStorage.getItem('bfl_signal_rules') || 'null') || getSignalRules();

  var thead = document.getElementById('customerThead');
  var tbody = document.getElementById('customerTbody');
  if (!thead || !tbody) return;

  var visCols = getVisibleColumns();

  // â”€â”€ thead ë™ì  ë Œë”ë§ â”€â”€
  var thRow = thead.querySelector('tr');
  var thHtml = '';
  visCols.forEach(function(col) {
    thHtml += '<th draggable="true" data-col-key="' + col.key + '">' + col.label + '</th>';
  });
  thRow.innerHTML = thHtml;

  // â”€â”€ Firestoreì—ì„œ ì—…ì²´ ë¡œë“œ â”€â”€
  var allCustomers = [];
  try {
    allCustomers = await fsGetCompanies();
  } catch(e) {
    console.warn('Firestore ì—…ì²´ ë¡œë“œ ì‹¤íŒ¨:', e.message);
  }

  // â”€â”€ ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ â†’ ë¯¸ìˆ˜ê¸ˆ/í†µê³„/ì‹ í˜¸ë“± ê³„ì‚° â”€â”€
  try {
    await loadReceiptDataForCompanies(allCustomers);
  } catch(e) {
    console.warn('ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜ ê³„ì‚° ì‹¤íŒ¨:', e.message);
  }

  // â”€â”€ ê²€ìƒ‰ í•„í„° â”€â”€
  var q = _custSearchQuery.toLowerCase().trim();
  var filtered = allCustomers;
  if (q) {
    filtered = allCustomers.filter(function(c) {
      return (c.company && c.company.toLowerCase().indexOf(q) !== -1) ||
             (c.bizNo && c.bizNo.indexOf(q) !== -1) ||
             (c.contactName && c.contactName.toLowerCase().indexOf(q) !== -1) ||
             (c.repName && c.repName.toLowerCase().indexOf(q) !== -1) ||
             (c.salesRep && c.salesRep.toLowerCase().indexOf(q) !== -1);
    });
  }

  // â”€â”€ tbody ë Œë”ë§ â”€â”€
  tbody.innerHTML = '';
  filtered.forEach(function(c) {
    var tr = document.createElement('tr');
    // ì‹ í˜¸ë“±ì— ë”°ë¥¸ í–‰ ë°°ê²½ìƒ‰ (ì ‘ìˆ˜ ë°ì´í„° ê¸°ë°˜ ê³„ì‚°ëœ ê°’ ì‚¬ìš©)
    var custKey = c.id || (c.company || '').trim();
    var rowTL = _companyTrafficLight[custKey] || 'green';
    if (rowTL === 'orange') tr.style.background = '#fff8e1';
    if (rowTL === 'red') tr.style.background = '#fce4ec';
    if (c.id) {
      tr.setAttribute('data-cust-id', c.id);
      tr.style.cursor = 'pointer';
      tr.onclick = (function(custId) { return function() { openCustomerDetail(custId); }; })(c.id);
    }
    var tdHtml = '';
    visCols.forEach(function(col) { tdHtml += col.render(c); });
    tr.innerHTML = tdHtml;
    tbody.appendChild(tr);
  });

  // â”€â”€ í†µê³„ ê°±ì‹  â”€â”€
  var statVals = document.querySelectorAll('#page-customerList .stat-val');
  if (statVals.length >= 1) statVals[0].textContent = allCustomers.length;
  if (statVals.length >= 2) statVals[1].textContent = allCustomers.filter(function(c){return c.status==='í™œë™';}).length;

  // â”€â”€ ë“œë˜ê·¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” â”€â”€
  initColumnDrag();
}

function filterCustomerTable(val) {
  _custSearchQuery = val || '';
  loadCustomers();
}

// ============================================================
// âš™ï¸ ì»¬ëŸ¼ ì„¤ì • íŒ¨ë„
// ============================================================
function toggleColSettings() {
  var panel = document.getElementById('colSettingsPanel');
  if (panel.style.display === 'none' || !panel.style.display) {
    renderColSettings();
    panel.style.display = 'block';
    setTimeout(function() { document.addEventListener('click', _closeColSettingsOutside); }, 0);
  } else {
    panel.style.display = 'none';
    document.removeEventListener('click', _closeColSettingsOutside);
  }
}
function _closeColSettingsOutside(e) {
  var panel = document.getElementById('colSettingsPanel');
  var btn = document.getElementById('colSettingsBtn');
  if (!panel.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
    panel.style.display = 'none';
    document.removeEventListener('click', _closeColSettingsOutside);
  }
}
function renderColSettings() {
  var cfg = getColConfig();
  var panel = document.getElementById('colSettingsPanel');
  var html = '<div class="col-settings-header"><span>âš™ï¸ ì»¬ëŸ¼ ì„¤ì •</span><span class="col-settings-reset" onclick="resetColConfig()">ì´ˆê¸°í™”</span></div>';
  // ê¸°ë³¸ ì»¬ëŸ¼ ê·¸ë£¹
  html += '<div style="font-size:10px;color:#999;padding:4px 8px;font-weight:600">ê¸°ë³¸ ì»¬ëŸ¼</div>';
  var defaultKeys = COLUMNS.filter(function(c){return c.defaultVisible;}).map(function(c){return c.key;});
  cfg.columns.forEach(function(key) {
    var col = _colMap[key]; if (!col || !col.defaultVisible) return;
    var chk = cfg.visible.indexOf(key) !== -1 ? 'checked' : '';
    html += '<label class="col-setting-item"><input type="checkbox" ' + chk + ' onchange="toggleColumn(\'' + key + '\',this.checked)"><span>' + col.label + '</span></label>';
  });
  // ì¶”ê°€ ì»¬ëŸ¼ ê·¸ë£¹
  html += '<div class="col-setting-divider"></div>';
  html += '<div style="font-size:10px;color:#999;padding:4px 8px;font-weight:600">ì¶”ê°€ ì»¬ëŸ¼</div>';
  cfg.columns.forEach(function(key) {
    var col = _colMap[key]; if (!col || col.defaultVisible) return;
    var chk = cfg.visible.indexOf(key) !== -1 ? 'checked' : '';
    html += '<label class="col-setting-item"><input type="checkbox" ' + chk + ' onchange="toggleColumn(\'' + key + '\',this.checked)"><span>' + col.label + '</span></label>';
  });
  panel.innerHTML = html;
}
function toggleColumn(key, show) {
  var cfg = getColConfig();
  var idx = cfg.visible.indexOf(key);
  if (show && idx === -1) {
    cfg.visible.push(key);
    if (cfg.columns.indexOf(key) === -1) cfg.columns.push(key);
  } else if (!show && idx !== -1) {
    cfg.visible.splice(idx, 1);
  }
  saveColConfig(cfg);
  loadCustomers();
}
function resetColConfig() {
  localStorage.removeItem(COL_CONFIG_KEY);
  renderColSettings();
  loadCustomers();
  toast('âœ… ì»¬ëŸ¼ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================
// ì»¬ëŸ¼ ë“œë˜ê·¸ ì´ë™ (HTML5 Drag & Drop)
// ============================================================
var _dragColKey = null;

function initColumnDrag() {
  var ths = document.querySelectorAll('#customerThead th[draggable="true"]');
  ths.forEach(function(th) {
    th.addEventListener('dragstart', _onColDragStart);
    th.addEventListener('dragover', _onColDragOver);
    th.addEventListener('dragenter', _onColDragEnter);
    th.addEventListener('dragleave', _onColDragLeave);
    th.addEventListener('drop', _onColDrop);
    th.addEventListener('dragend', _onColDragEnd);
  });
}
function _onColDragStart(e) {
  _dragColKey = this.getAttribute('data-col-key');
  this.classList.add('col-dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _dragColKey);
}
function _onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function _onColDragEnter(e) { e.preventDefault(); this.classList.add('col-drag-over'); }
function _onColDragLeave() { this.classList.remove('col-drag-over'); }
function _onColDrop(e) {
  e.preventDefault();
  this.classList.remove('col-drag-over');
  var targetKey = this.getAttribute('data-col-key');
  if (!_dragColKey || _dragColKey === targetKey) return;
  var cfg = getColConfig();
  var fromIdx = cfg.columns.indexOf(_dragColKey);
  var toIdx = cfg.columns.indexOf(targetKey);
  if (fromIdx === -1 || toIdx === -1) return;
  cfg.columns.splice(fromIdx, 1);
  cfg.columns.splice(toIdx, 0, _dragColKey);
  saveColConfig(cfg);
  loadCustomers();
}
function _onColDragEnd() {
  _dragColKey = null;
  document.querySelectorAll('#customerThead th').forEach(function(th) {
    th.classList.remove('col-dragging', 'col-drag-over');
  });
}

var _detailCustId = null;
var _detailBizFile = null;
var _detailLicFile = null;

async function openCustomerDetail(custId) {
  var cust = await fsGetCompanyById(custId);
  if (!cust) { toast('âš ï¸ ê³ ê°ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
  _detailCustId = custId;
  _detailBizFile = null;
  _detailLicFile = null;

  // í•„ë“œ ì±„ìš°ê¸°
  var gradeTag = { 'VIP': '<span class="tag tag-vip">VIP</span>', 'A': '<span class="tag tag-a">A</span>', 'B': '<span class="tag tag-b">B</span>', 'C': '<span class="tag tag-c">C</span>' };
  var statusTag = { 'í™œë™': '<span class="tag tag-active">í™œë™</span>', 'íœ´ë©´': '<span class="tag tag-dormant">íœ´ë©´</span>', 'í•´ì§€': '<span class="tag" style="background:#fce4ec;color:#c62828">í•´ì§€</span>' };
  document.getElementById('detailCompanyTitle').textContent = cust.company;
  document.getElementById('detailGradeTag').innerHTML = gradeTag[cust.grade] || '';
  document.getElementById('detailStatusTag').innerHTML = statusTag[cust.status] || '';
  document.getElementById('detCompany').value = cust.company || '';
  document.getElementById('detRepName').value = cust.repName || '';
  document.getElementById('detBizNo').value = cust.bizNo || '';
  document.getElementById('detCorpNo').value = cust.corpNo || '';
  document.getElementById('detBizType').value = cust.bizType || '';
  document.getElementById('detBizItem').value = cust.bizItem || '';
  document.getElementById('detZipcode').value = cust.zipcode || '';
  document.getElementById('detAddr1').value = cust.addr1 || '';
  document.getElementById('detAddr2').value = cust.addr2 || '';
  document.getElementById('detCompanyEn').value = cust.companyEn || '';
  document.getElementById('detRepNameEn').value = cust.repNameEn || '';
  document.getElementById('detAddrEn').value = cust.addrEn || '';
  // ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì
  document.getElementById('detTaxName').value = cust.taxName || '';
  document.getElementById('detTaxPhone').value = cust.taxPhone || '';
  document.getElementById('detTaxMobile').value = cust.taxMobile || '';
  document.getElementById('detTaxFax').value = cust.taxFax || '';
  document.getElementById('detTaxEmail').value = cust.taxEmail || '';
  // ë©”ëª¨
  document.getElementById('detMemo').value = cust.memo || '';
  // ë‹¤ì¤‘ ì¸í—ˆê°€ ì •ë³´ ë Œë”ë§
  renderDetailLicenses(cust);
  // ë‹¤ì¤‘ ë‹´ë‹¹ì ì •ë³´ ë Œë”ë§ (ì¸í—ˆê°€ í›„ì— í•´ì•¼ ë§¤ì¹­ íƒœê·¸ í‘œì‹œ ê°€ëŠ¥)
  renderDetailContacts(cust);
  // ì¸í—ˆê°€ ì¹´ë“œì— ì—°ê²°ëœ ë‹´ë‹¹ì í‘œì‹œ
  updateLicContactDisplay();
  // ì²¨ë¶€íŒŒì¼ ë³´ê¸° ë Œë”ë§
  renderFileViewSection(cust);

  // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
  document.getElementById('detailBizFileName').textContent = 'ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼';
  document.getElementById('detailLicFileName').textContent = 'ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼';
  document.getElementById('detailBizOcrBtn').disabled = true;
  document.getElementById('detailLicOcrBtn').disabled = true;
  var ocrStatus = document.getElementById('detailOcrStatus');
  if (ocrStatus) { ocrStatus.style.display = 'none'; ocrStatus.textContent = ''; }

  // ìš°í¸ë²ˆí˜¸ ë¯¸ë“±ë¡ ì‹œ ì¹´ì¹´ì˜¤ APIë¡œ ìë™ ì¡°íšŒ (ì‚¬ì—…ìë“±ë¡ì¦ ì£¼ì†Œ)
  if (!cust.zipcode && cust.addr1) {
    lookupAddressFromKakao(cust.addr1, function(zipcode, roadAddr, detailAddr) {
      if (zipcode) {
        document.getElementById('detZipcode').value = zipcode;
        cust.zipcode = zipcode;
      }
      if (roadAddr && roadAddr !== cust.addr1) {
        document.getElementById('detAddr1').value = roadAddr;
        cust.addr1 = roadAddr;
      }
      // Firestore ì—…ë°ì´íŠ¸
      db.collection('companies').doc(custId).update({ zipcode: cust.zipcode, addr1: cust.addr1 }).catch(function(e){ console.warn('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', e); });
    });
  }
  // ì¸í—ˆê°€ ìš°í¸ë²ˆí˜¸ ë¯¸ë“±ë¡ ì‹œ ì¹´ì¹´ì˜¤ APIë¡œ ìë™ ì¡°íšŒ
  var lics = cust.licenses || [];
  lics.forEach(function(lic, i) {
    if (!lic.licZipcode && lic.licAddr) {
      lookupAddressFromKakao(lic.licAddr, function(zipcode, roadAddr, detailAddr) {
        var num = i + 1;
        if (zipcode) { lic.licZipcode = zipcode; var zEl = document.getElementById('detLicZipcode_' + num); if (zEl) zEl.value = zipcode; }
        if (roadAddr && roadAddr !== lic.licAddr) { lic.licAddr = roadAddr; var aEl = document.getElementById('detLicAddr_' + num); if (aEl) aEl.value = roadAddr; }
        if (detailAddr && !lic.licAddr2) { lic.licAddr2 = detailAddr; var a2El = document.getElementById('detLicAddr2_' + num); if (a2El) a2El.value = detailAddr; }
        // Firestore ì—…ë°ì´íŠ¸
        if (cust.licenses && cust.licenses[i]) { cust.licenses[i] = lic; }
        db.collection('companies').doc(custId).update({ licenses: cust.licenses || [] }).catch(function(e){ console.warn('ì¸í—ˆê°€ ì €ì¥ ì‹¤íŒ¨:', e); });
      });
    }
  });

  // ë³€ê²½ ì´ë ¥ ë¡œë“œ
  renderChangeLog(cust.changeLog || []);

  showPage('customerDetail');
}

// --- ìƒì„¸ í˜ì´ì§€: ë‹¤ì¤‘ ì¸í—ˆê°€ ì •ë³´ ë Œë”ë§ ---
function renderDetailLicenses(cust) {
  var container = document.getElementById('detLicenseContainer');
  if (!container) return;
  container.innerHTML = '';

  // licenses ë°°ì—´ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë‹¨ì¼ í•„ë“œì—ì„œ 1ê°œ ìƒì„±
  var licenses = cust.licenses && cust.licenses.length > 0 ? cust.licenses : [{
    licField: cust.licField || '',
    licBizForm: cust.licBizForm || '',
    licRepName: cust.licRepName || '',
    licNo: cust.licNo || '',
    licBizName: cust.licBizName || '',
    licAddr: ((cust.licAddr || '') + ' ' + (cust.licAddr2 || '')).trim(),
    licBizNameEn: cust.licBizNameEn || '',
    licRepNameEn: cust.licRepNameEn || '',
    licAddrEn: cust.licAddrEn || ''
  }];

  for (var i = 0; i < licenses.length; i++) {
    var lic = licenses[i];
    var num = i + 1;
    var card = document.createElement('div');
    card.className = 'sub-card';
    card.id = 'detLicCard_' + num;
    card.style.marginBottom = '12px';

    card.innerHTML =
      '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">' + num + '</span> ì¸í—ˆê°€</div>' +
        '<button class="btn btn-secondary btn-sm detLicDelBtn" onclick="removeDetailLicenseCard(' + num + ')" style="display:none;margin-left:auto;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
      '</div>' +
      '<div class="fg-row">' +
        '<div class="fg"><label>ë¶„ì•¼</label><input id="detLicField_' + num + '" value="' + escHtml(lic.licField) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ</label><input id="detLicBizForm_' + num + '" value="' + escHtml(lic.licBizForm) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '</div>' +
      '<div class="fg-row">' +
        '<div class="fg"><label>ëŒ€í‘œì</label><input id="detLicRepName_' + num + '" value="' + escHtml(lic.licRepName) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸</label><input id="detLicNo_' + num + '" value="' + escHtml(lic.licNo) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '</div>' +
      '<div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­</label><input id="detLicBizName_' + num + '" value="' + escHtml(lic.licBizName) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '<div class="fg"><label>ì†Œì¬ì§€</label>' +
        '<div class="addr-row" style="margin-bottom:4px"><input id="detLicZipcode_' + num + '" value="' + escHtml(lic.licZipcode || '') + '" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;background:#f8f9fb" readonly class="det-editable"><button class="btn btn-secondary btn-sm detLicPostBtn" onclick="openLicPostcodeSearch(' + num + ',true)" style="display:none">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>' +
      '</div>' +
      '<div class="fg"><input id="detLicAddr_' + num + '" value="' + escHtml(lic.licAddr || '') + '" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '<div class="fg"><input id="detLicAddr2_' + num + '" value="' + escHtml(lic.licAddr2 || '') + '" placeholder="ìƒì„¸ì£¼ì†Œ" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '<div class="eng-toggle" onclick="toggleEngSection(\'detLicEngSection_' + num + '\')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">' +
        '<span style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)' +
      '</div>' +
      '<div id="detLicEngSection_' + num + '" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">' +
        '<div class="fg"><label>Business Name (EN)</label><input id="detLicBizNameEn_' + num + '" value="' + escHtml(lic.licBizNameEn) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>Representative (EN)</label><input id="detLicRepNameEn_' + num + '" value="' + escHtml(lic.licRepNameEn) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>Address (EN)</label><input id="detLicAddrEn_' + num + '" value="' + escHtml(lic.licAddrEn) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '</div>' +
      // ì¸í—ˆê°€ ë‹´ë‹¹ì í•„ë“œ (ë§¤ì¹­ìœ¼ë¡œ ìë™ ì±„ì›Œì§)
      '<div style="margin-top:8px;padding:8px 10px;background:#f1f8e9;border-radius:6px;border:1px solid #c5e1a5">' +
        '<div style="display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;color:#33691e;margin-bottom:6px">ğŸ‘¤ ì¸í—ˆê°€ ë‹´ë‹¹ì' +
        '<span id="detLicSalesRepLabel_' + num + '" style="background:#e3f2fd;color:#1565c0;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;margin-left:auto">ğŸ¢ ìì‚¬: ' + escHtml(lic.licSalesRep || '-') + '</span>' +
        '<input type="hidden" id="detLicSalesRep_' + num + '" value="' + escHtml(lic.licSalesRep || '') + '">' +
      '</div>' +
        '<div class="fg-row" style="gap:8px">' +
          '<div class="fg"><label style="color:#33691e;font-size:11px">ë‹´ë‹¹ì</label><input id="detLicContact_' + num + '" value="' + escHtml(lic.licContact || '') + '" readonly style="background:#f5f9f0;border:1px solid #c5e1a5;font-size:12px" class="det-editable det-lic-contact-field" placeholder="ë§¤ì¹­ ë˜ëŠ” ì§ì ‘ ì…ë ¥"></div>' +
          '<div class="fg"><label style="color:#33691e;font-size:11px">ì „í™”ë²ˆí˜¸</label><input id="detLicContactPhone_' + num + '" value="' + escHtml(lic.licContactPhone || '') + '" readonly style="background:#f5f9f0;border:1px solid #c5e1a5;font-size:12px" class="det-editable det-lic-contact-field" placeholder="ì „í™”ë²ˆí˜¸"></div>' +
        '</div>' +
      '</div>';

    container.appendChild(card);
  }
  _detLicCardCount = licenses.length;
}
var _detLicCardCount = 0;
var _detContactCardCount = 0;
var _licMatchContactNum = null; // ë§¤ì¹­ ëª¨ë‹¬ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ë‹´ë‹¹ì ë²ˆí˜¸

// --- ìƒì„¸ í˜ì´ì§€: ì²¨ë¶€íŒŒì¼ ë³´ê¸° ë Œë”ë§ ---
function renderFileViewSection(cust) {
  var section = document.getElementById('fileViewSection');
  var row = document.getElementById('fileViewRow');
  if (!section || !row) return;

  var files = cust.files || {};
  var hasFiles = false;
  var html = '';

  // ì‚¬ì—…ìë“±ë¡ì¦ ì›ë³¸ ë³´ê¸°
  if (files.bizLicenseUrl) {
    hasFiles = true;
    html += '<button class="file-view-btn" onclick="window.open(\'' + files.bizLicenseUrl + '\',\'_blank\')">' +
      '<span class="fv-icon">ğŸ“„</span> ì‚¬ì—…ìë“±ë¡ì¦ ì›ë³¸</button>';
  }

  // OCR ê²°ê³¼ ë³´ê¸°
  if (files.ocrResults && files.ocrResults.length > 0) {
    hasFiles = true;
    html += '<button class="file-view-btn" onclick="openOcrResultModal()" style="border-color:#90caf9;color:#1565c0">' +
      '<span class="fv-icon">ğŸ”</span> OCR ê²°ê³¼ (' + files.ocrResults.length + 'ê±´)</button>';
    window._currentOcrResults = files.ocrResults;
  } else {
    window._currentOcrResults = null;
  }

  // ì¸í—ˆê°€ë¬¸ì„œ (ì¸í—ˆê°€ ì¹´ë“œì— í‘œì‹œ ì•ˆ ë  ìˆ˜ ìˆëŠ” ê²½ìš°)
  var permitDocs = files.permitDocs || [];
  var licenses = (cust.licenses && cust.licenses.length > 0) ? cust.licenses : [];
  if (permitDocs.length > 0 && licenses.length === 0) {
    hasFiles = true;
    permitDocs.forEach(function(doc, i) {
      var label = doc.name || ('ì¸í—ˆê°€ë¬¸ì„œ ' + (i + 1));
      html += '<button class="file-view-btn" onclick="window.open(\'' + doc.url + '\',\'_blank\')">' +
        '<span class="fv-icon">ğŸ“‹</span> ' + escHtml(label) + '</button>';
    });
  }

  if (hasFiles) {
    row.innerHTML = html;
    section.style.display = '';
  } else {
    section.style.display = 'none';
  }
}

function openOcrResultModal() {
  var results = window._currentOcrResults;
  if (!results || results.length === 0) { toast('ì €ì¥ëœ OCR ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }

  var body = document.getElementById('ocrModalBody');
  var sub = document.getElementById('ocrModalSub');
  sub.textContent = 'ì´ ' + results.length + 'ê±´ì˜ OCR ì¸ì‹ ê²°ê³¼';

  var html = '';
  results.forEach(function(r, i) {
    var typeLabel = r.type === 'bizLicense' ? 'ğŸ“„ ì‚¬ì—…ìë“±ë¡ì¦' : 'ğŸ“‹ ì¸í—ˆê°€ë¬¸ì„œ';
    var dateStr = r.ocrAt ? new Date(r.ocrAt).toLocaleString('ko-KR') : '';
    html += '<div style="background:#f8f9fb;border-radius:10px;padding:14px;margin-bottom:10px">';
    html += '<div style="font-weight:700;font-size:13px;margin-bottom:6px">' + typeLabel + (r.fileName ? ' â€” ' + escHtml(r.fileName) : '') + '</div>';
    if (dateStr) html += '<div style="font-size:11px;color:#667085;margin-bottom:8px">ì¸ì‹ì¼: ' + dateStr + '</div>';
    if (r.data) {
      var fieldMap;
      if (r.type === 'bizLicense') {
        fieldMap = [['companyName','íšŒì‚¬ëª…'],['repName','ëŒ€í‘œì'],['bizNo','ì‚¬ì—…ìë²ˆí˜¸'],['corpNo','ë²•ì¸ë²ˆí˜¸'],['taxType','ê³¼ì„¸ìœ í˜•'],['bizType','ì—…íƒœ'],['bizItem','ì¢…ëª©'],['address','ì†Œì¬ì§€']];
      } else {
        fieldMap = [['bizName','ì—…ì†Œëª…'],['repName','ëŒ€í‘œì'],['licNo','ì¸í—ˆê°€ë²ˆí˜¸'],['bizForm','ì˜ì—…í˜•íƒœ'],['field','ë¶„ì•¼'],['address','ì†Œì¬ì§€']];
      }
      fieldMap.forEach(function(pair) {
        var val = r.data[pair[0]] || '';
        if (val) {
          html += '<div style="display:flex;gap:8px;margin-bottom:3px"><span style="color:#667085;min-width:80px;font-size:12px">' + pair[1] + '</span><span style="font-size:12px;color:#333">' + escHtml(val) + '</span></div>';
        }
      });
    }
    html += '</div>';
  });

  body.innerHTML = html;
  document.getElementById('ocrResultModal').style.display = 'flex';
}

function closeOcrResultModal() {
  document.getElementById('ocrResultModal').style.display = 'none';
}

// --- ìƒì„¸ í˜ì´ì§€: ë‹¤ì¤‘ ë‹´ë‹¹ì ë Œë”ë§ ---
function renderDetailContacts(cust) {
  var container = document.getElementById('detContactContainer');
  if (!container) return;
  container.innerHTML = '';

  // contacts ë°°ì—´ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë‹¨ì¼ í•„ë“œì—ì„œ 1ê°œ ìƒì„±
  var contacts = cust.contacts && cust.contacts.length > 0 ? cust.contacts : [];
  if (contacts.length === 0 && (cust.contactName || cust.contactPhone || cust.contactEmail)) {
    contacts = [{ name: cust.contactName || '', phone: cust.contactPhone || '', mobile: cust.contactMobile || '', fax: cust.contactFax || '', email: cust.contactEmail || '', role: '', salesRep: cust.salesRep || '', licNums: [] }];
  }
  if (contacts.length === 0) {
    contacts = [{ name: '', phone: '', mobile: '', fax: '', email: '', role: '', salesRep: '', licNums: [] }];
  }

  for (var i = 0; i < contacts.length; i++) {
    var ct = contacts[i];
    var num = i + 1;
    var card = document.createElement('div');
    card.className = 'sub-card';
    card.id = 'detContactCard_' + num;
    card.style.cssText = 'margin-bottom:10px;border-left:3px solid #43a047';

    // ì¸í—ˆê°€ ë§¤ì¹­ íƒœê·¸ í‘œì‹œ
    var licTagsHtml = '';
    var licNums = ct.licNums || [];
    if (licNums.length > 0) {
      var lics = cust.licenses || [];
      licTagsHtml = '<div id="detContactLicTags_' + num + '" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">';
      for (var j = 0; j < licNums.length; j++) {
        var ln = licNums[j];
        var licLabel = (lics[ln - 1] && lics[ln - 1].licBizName) ? lics[ln - 1].licBizName : 'ì¸í—ˆê°€ ' + ln;
        licTagsHtml += '<span class="det-lic-match-tag" style="display:inline-flex;align-items:center;gap:3px;background:#e8f5e9;color:#2e7d32;font-size:11px;padding:2px 8px;border-radius:10px">ğŸ”— ' + escHtml(licLabel) + '</span>';
      }
      licTagsHtml += '</div>';
    } else {
      licTagsHtml = '<div id="detContactLicTags_' + num + '" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px"></div>';
    }

    var salesRepDisplay = ct.salesRep ? escHtml(ct.salesRep) : '<span style="color:#aaa">ë¯¸ì§€ì •</span>';

    card.innerHTML =
      '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num" style="background:#43a047">' + num + '</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì</div>' +
        '<div style="display:flex;gap:4px;margin-left:auto;align-items:center">' +
          '<span style="background:#e3f2fd;color:#1565c0;font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600">ğŸ¢ ìì‚¬: <span id="detContactSalesRepLabel_' + num + '">' + salesRepDisplay + '</span></span>' +
          '<button class="btn btn-secondary btn-sm detContactMatchBtn" onclick="openLicMatchModal(' + num + ')" style="display:none;font-size:11px;padding:3px 10px;color:#1565c0;border-color:#90caf9" title="ì¸í—ˆê°€ ë§¤ì¹­">ğŸ”— ë§¤ì¹­</button>' +
          '<button class="btn btn-secondary btn-sm detContactDelBtn" onclick="removeDetailContactCard(' + num + ')" style="display:none;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
        '</div>' +
      '</div>' +
      '<input type="hidden" id="detContactSalesRep_' + num + '" value="' + escHtml(ct.salesRep || '') + '">' +
      '<div class="fg-row" style="gap:8px">' +
        '<div class="fg" style="flex:1.2"><label>ì´ë¦„</label><input id="detContactName_' + num + '" value="' + escHtml(ct.name) + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
        '<div class="fg" style="flex:1"><label>ì—­í• /ì§ì±…</label><input id="detContactRole_' + num + '" value="' + escHtml(ct.role || '') + '" placeholder="í’ˆì§ˆê´€ë¦¬, êµ¬ë§¤ ë“±" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
      '</div>' +
      '<div class="fg-row" style="gap:8px">' +
        '<div class="fg"><label>ì „í™”ë²ˆí˜¸</label><input id="detContactPhone_' + num + '" value="' + escHtml(ct.phone) + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
        '<div class="fg"><label>íœ´ëŒ€í°</label><input id="detContactMobile_' + num + '" value="' + escHtml(ct.mobile || '') + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
        '<div class="fg"><label>íŒ©ìŠ¤ë²ˆí˜¸</label><input id="detContactFax_' + num + '" value="' + escHtml(ct.fax || '') + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
        '<div class="fg"><label>ì´ë©”ì¼</label><input id="detContactEmail_' + num + '" value="' + escHtml(ct.email) + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
      '</div>' +
      '<input type="hidden" id="detContactLicNums_' + num + '" value=\'' + JSON.stringify(licNums) + '\'>' +
      licTagsHtml;

    container.appendChild(card);
  }
  _detContactCardCount = contacts.length;
}

// --- ìƒì„¸ í˜ì´ì§€: ë‹´ë‹¹ì ì¹´ë“œ ë™ì  ì¶”ê°€ ---
function addDetailContactCard() {
  _detContactCardCount++;
  var num = _detContactCardCount;
  var container = document.getElementById('detContactContainer');
  if (!container) return;

  var card = document.createElement('div');
  card.className = 'sub-card';
  card.id = 'detContactCard_' + num;
  card.style.cssText = 'margin-bottom:10px;border-left:3px solid #43a047;animation:fadeIn 0.3s ease';

  card.innerHTML =
    '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num" style="background:#43a047">' + num + '</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì</div>' +
      '<div style="display:flex;gap:4px;margin-left:auto;align-items:center">' +
        '<span style="background:#e3f2fd;color:#1565c0;font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600">ğŸ¢ ìì‚¬: <input id="detContactSalesRep_' + num + '" placeholder="ìì‚¬ ë‹´ë‹¹" style="border:none;background:transparent;color:#1565c0;font-size:11px;font-weight:600;width:70px;outline:none" class="det-contact-field"></span>' +
        '<button class="btn btn-secondary btn-sm detContactMatchBtn" onclick="openLicMatchModal(' + num + ')" style="font-size:11px;padding:3px 10px;color:#1565c0;border-color:#90caf9" title="ì¸í—ˆê°€ ë§¤ì¹­">ğŸ”— ë§¤ì¹­</button>' +
        '<button class="btn btn-secondary btn-sm detContactDelBtn" onclick="removeDetailContactCard(' + num + ')" style="font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
      '</div>' +
    '</div>' +
    '<div class="fg-row" style="gap:8px">' +
      '<div class="fg" style="flex:1.2"><label>ì´ë¦„</label><input id="detContactName_' + num + '" placeholder="ë‹´ë‹¹ìëª…" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
      '<div class="fg" style="flex:1"><label>ì—­í• /ì§ì±…</label><input id="detContactRole_' + num + '" placeholder="í’ˆì§ˆê´€ë¦¬, êµ¬ë§¤ ë“±" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
    '</div>' +
    '<div class="fg-row" style="gap:8px">' +
      '<div class="fg"><label>ì „í™”ë²ˆí˜¸</label><input id="detContactPhone_' + num + '" placeholder="ì „í™”ë²ˆí˜¸" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
      '<div class="fg"><label>íœ´ëŒ€í°</label><input id="detContactMobile_' + num + '" placeholder="íœ´ëŒ€í°" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
      '<div class="fg"><label>íŒ©ìŠ¤ë²ˆí˜¸</label><input id="detContactFax_' + num + '" placeholder="íŒ©ìŠ¤ë²ˆí˜¸" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
      '<div class="fg"><label>ì´ë©”ì¼</label><input id="detContactEmail_' + num + '" placeholder="ì´ë©”ì¼" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
    '</div>' +
    '<div id="detContactLicTags_' + num + '" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px"></div>';

  container.appendChild(card);
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  toast('âœ… ë‹´ë‹¹ì ' + num + ' ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');

  // ì¸í—ˆê°€ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë§¤ì¹­ ëª¨ë‹¬ ì—´ê¸°
  if (_detLicCardCount > 0) {
    setTimeout(function() { openLicMatchModal(num); }, 400);
  }
}

// --- ë‹´ë‹¹ì ì¹´ë“œ ì‚­ì œ ---
function removeDetailContactCard(num) {
  var card = document.getElementById('detContactCard_' + num);
  if (card) {
    card.style.animation = 'fadeIn 0.2s ease reverse';
    setTimeout(function() { card.remove(); }, 200);
    toast('ğŸ—‘ ë‹´ë‹¹ì ' + num + ' ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

// --- ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­ ëª¨ë‹¬ ---
function openLicMatchModal(contactNum) {
  _licMatchContactNum = contactNum;
  var modal = document.getElementById('licContactMatchModal');
  if (!modal) return;

  var contactName = (document.getElementById('detContactName_' + contactNum) || {}).value || 'ë‹´ë‹¹ì ' + contactNum;
  document.getElementById('licMatchDesc').innerHTML = '<strong>' + escHtml(contactName) + '</strong> ë‹˜ì„ ì–´ë–¤ ì¸í—ˆê°€ì˜ ë‹´ë‹¹ìë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

  var listEl = document.getElementById('licMatchList');
  listEl.innerHTML = '';

  // í˜„ì¬ ì´ ë‹´ë‹¹ìì— ì—°ê²°ëœ ì¸í—ˆê°€ ë²ˆí˜¸ ìˆ˜ì§‘
  var currentLicTags = document.getElementById('detContactLicTags_' + contactNum);
  var currentMatched = [];
  if (currentLicTags) {
    var tags = currentLicTags.querySelectorAll('.det-lic-match-tag');
    // data attributeë¡œë¶€í„° ì¶”ì¶œí•˜ê¸°ë³´ë‹¤ëŠ” hidden inputì—ì„œ ì¶”ì¶œ
  }
  // hidden inputì—ì„œ í˜„ì¬ ë§¤ì¹­ ì •ë³´ ì½ê¸°
  var hiddenEl = document.getElementById('detContactLicNums_' + contactNum);
  if (hiddenEl && hiddenEl.value) {
    try { currentMatched = JSON.parse(hiddenEl.value); } catch(e) {}
  }

  for (var li = 1; li <= _detLicCardCount; li++) {
    if (!document.getElementById('detLicCard_' + li)) continue;
    var bizName = (document.getElementById('detLicBizName_' + li) || {}).value || '';
    var licField = (document.getElementById('detLicField_' + li) || {}).value || '';
    var label = bizName || licField || 'ì¸í—ˆê°€ ' + li;
    var checked = currentMatched.indexOf(li) !== -1 ? ' checked' : '';

    var item = document.createElement('label');
    item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e2e6ed;border-radius:8px;margin-bottom:6px;cursor:pointer;transition:background 0.15s';
    item.innerHTML =
      '<input type="checkbox" class="lic-match-chk" value="' + li + '"' + checked + ' style="width:18px;height:18px;accent-color:#43a047">' +
      '<div style="flex:1">' +
        '<div style="font-weight:600;font-size:13px">' + escHtml(label) + '</div>' +
        '<div style="font-size:11px;color:#8892a4">ì¸í—ˆê°€ ' + li + (licField ? ' Â· ' + escHtml(licField) : '') + '</div>' +
      '</div>';
    listEl.appendChild(item);
  }

  if (_detLicCardCount === 0) {
    listEl.innerHTML = '<div style="text-align:center;color:#8892a4;padding:16px">ë“±ë¡ëœ ì¸í—ˆê°€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  }

  modal.style.display = 'flex';
}

function closeLicMatchModal() {
  var modal = document.getElementById('licContactMatchModal');
  if (modal) modal.style.display = 'none';
  _licMatchContactNum = null;
}

function applyLicMatch() {
  var num = _licMatchContactNum;
  if (!num) return;

  var checkedNums = [];
  document.querySelectorAll('#licMatchList .lic-match-chk:checked').forEach(function(chk) {
    checkedNums.push(parseInt(chk.value));
  });

  // hidden inputì— ë§¤ì¹­ ì •ë³´ ì €ì¥
  var hiddenEl = document.getElementById('detContactLicNums_' + num);
  if (!hiddenEl) {
    hiddenEl = document.createElement('input');
    hiddenEl.type = 'hidden';
    hiddenEl.id = 'detContactLicNums_' + num;
    var card = document.getElementById('detContactCard_' + num);
    if (card) card.appendChild(hiddenEl);
  }
  hiddenEl.value = JSON.stringify(checkedNums);

  // íƒœê·¸ UI ì—…ë°ì´íŠ¸
  var tagsEl = document.getElementById('detContactLicTags_' + num);
  if (tagsEl) {
    tagsEl.innerHTML = '';
    for (var j = 0; j < checkedNums.length; j++) {
      var ln = checkedNums[j];
      var bizName = (document.getElementById('detLicBizName_' + ln) || {}).value || '';
      var licField = (document.getElementById('detLicField_' + ln) || {}).value || '';
      var label = bizName || licField || 'ì¸í—ˆê°€ ' + ln;
      tagsEl.innerHTML += '<span class="det-lic-match-tag" style="display:inline-flex;align-items:center;gap:3px;background:#e8f5e9;color:#2e7d32;font-size:11px;padding:2px 8px;border-radius:10px">ğŸ”— ' + escHtml(label) + '</span>';
    }
  }

  // ì¸í—ˆê°€ ì¹´ë“œì—ë„ ë‹´ë‹¹ì í‘œì‹œ ì—…ë°ì´íŠ¸
  updateLicContactDisplay();

  closeLicMatchModal();
  var contactName = (document.getElementById('detContactName_' + num) || {}).value || 'ë‹´ë‹¹ì ' + num;
  if (checkedNums.length > 0) {
    toast('ğŸ”— ' + contactName + ' â†’ ' + checkedNums.length + 'ê°œ ì¸í—ˆê°€ ì—°ê²°');
  } else {
    toast('â„¹ï¸ ' + contactName + ' ì¸í—ˆê°€ ì—°ê²° í•´ì œ');
  }
}

// --- ì¸í—ˆê°€ ì¹´ë“œ ë‚´ ì—°ê²°ëœ ë‹´ë‹¹ì í•„ë“œ ì—…ë°ì´íŠ¸ ---
function updateLicContactDisplay() {
  for (var li = 1; li <= _detLicCardCount; li++) {
    var card = document.getElementById('detLicCard_' + li);
    if (!card) continue;

    // ì´ ì¸í—ˆê°€ì— ì—°ê²°ëœ ë‹´ë‹¹ìë“¤ ìˆ˜ì§‘
    var linkedContacts = [];
    for (var ci = 1; ci <= _detContactCardCount; ci++) {
      if (!document.getElementById('detContactCard_' + ci)) continue;
      var hiddenEl = document.getElementById('detContactLicNums_' + ci);
      if (hiddenEl && hiddenEl.value) {
        try {
          var nums = JSON.parse(hiddenEl.value);
          if (nums.indexOf(li) !== -1) {
            var cName = (document.getElementById('detContactName_' + ci) || {}).value || '';
            var cPhone = (document.getElementById('detContactPhone_' + ci) || {}).value || '';
            var cSalesRep = (document.getElementById('detContactSalesRep_' + ci) || {}).value || '';
            linkedContacts.push({ name: cName, phone: cPhone, salesRep: cSalesRep });
          }
        } catch(e) {}
      }
    }

    // ì¸í—ˆê°€ ì¹´ë“œ ë‚´ ë‹´ë‹¹ì í•„ë“œì— ë§¤ì¹­ëœ ê°’ ì±„ìš°ê¸°
    var contactField = document.getElementById('detLicContact_' + li);
    var phoneField = document.getElementById('detLicContactPhone_' + li);
    var salesRepField = document.getElementById('detLicSalesRep_' + li);

    if (linkedContacts.length > 0) {
      var names = linkedContacts.map(function(c) { return c.name; }).filter(Boolean).join(', ');
      var phones = linkedContacts.map(function(c) { return c.phone; }).filter(Boolean).join(', ');
      var reps = linkedContacts.map(function(c) { return c.salesRep; }).filter(Boolean);
      var uniqueReps = reps.filter(function(v, i, a) { return a.indexOf(v) === i; }).join(', ');
      if (contactField) contactField.value = names;
      if (phoneField) phoneField.value = phones;
      if (salesRepField) salesRepField.value = uniqueReps;
      // ìì‚¬ ë‹´ë‹¹ ë¼ë²¨ ì—…ë°ì´íŠ¸
      var repLabel = document.getElementById('detLicSalesRepLabel_' + li);
      if (repLabel) repLabel.innerHTML = 'ğŸ¢ ìì‚¬: ' + escHtml(uniqueReps || '-');
    }
  }
}

var _detailEditMode = false;
var _detailSnapshot = null; // ìˆ˜ì • ì „ ìŠ¤ëƒ…ìƒ·

// --- ìƒì„¸ í˜ì´ì§€: ìˆ˜ì • ëª¨ë“œ ì „í™˜ ---
function toggleDetailEdit() {
  _detailEditMode = true;
  // ìŠ¤ëƒ…ìƒ· ì €ì¥ (ë³€ê²½ ì „ ê°’)
  _detailSnapshot = {};
  document.querySelectorAll('#page-customerDetail .det-editable').forEach(function(el) {
    _detailSnapshot[el.id] = el.value;
    el.readOnly = false;
    el.style.background = '#fff';
    el.style.border = '1px solid #1a73e8';
  });
  // ê¸°ë³¸ ì •ë³´ í•„ë“œë„ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ
  ['detCompany','detRepName','detBizNo','detCorpNo','detBizType','detBizItem','detZipcode','detAddr1','detAddr2',
   'detCompanyEn','detRepNameEn','detAddrEn',
   'detTaxName','detTaxPhone','detTaxMobile','detTaxFax','detTaxEmail','detMemo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      _detailSnapshot[id] = el.value;
      if (id !== 'detZipcode' && id !== 'detAddr1') { // ìš°í¸ë²ˆí˜¸/ê¸°ë³¸ì£¼ì†ŒëŠ” ì¹´ì¹´ì˜¤ì—ì„œë§Œ ì…ë ¥
        el.readOnly = false;
      }
      el.style.background = '#fff';
      el.style.border = '1px solid #1a73e8';
    }
  });
  // ë‹´ë‹¹ì ì¹´ë“œì˜ hidden licNumsë„ ìŠ¤ëƒ…ìƒ· ì €ì¥ + ìì‚¬ ë‹´ë‹¹ ë¼ë²¨ì„ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ
  _detailSnapshot._contactsSnapshot = [];
  _detailSnapshot._salesRepSnapshot = [];
  for (var ci = 1; ci <= _detContactCardCount; ci++) {
    var hEl = document.getElementById('detContactLicNums_' + ci);
    _detailSnapshot._contactsSnapshot.push(hEl ? hEl.value : '[]');
    var srEl = document.getElementById('detContactSalesRep_' + ci);
    _detailSnapshot._salesRepSnapshot.push(srEl ? srEl.value : '');
    // ìì‚¬ ë‹´ë‹¹ ë¼ë²¨ â†’ í¸ì§‘ ê°€ëŠ¥ input
    var srLabel = document.getElementById('detContactSalesRepLabel_' + ci);
    if (srLabel && srEl) {
      srLabel.innerHTML = '<input id="detContactSalesRepEdit_' + ci + '" value="' + escHtml(srEl.value) + '" style="border:none;background:transparent;color:#1565c0;font-size:11px;font-weight:600;width:70px;outline:none;border-bottom:1px dashed #1565c0" class="det-contact-field" onchange="document.getElementById(\'detContactSalesRep_' + ci + '\').value=this.value">';
    }
  }
  // ë²„íŠ¼ ì „í™˜
  document.getElementById('detailEditBtn').style.display = 'none';
  document.getElementById('detailSaveBtn').style.display = '';
  document.getElementById('detailCancelBtn').style.display = '';
  // ì‚¬ì—…ìë“±ë¡ì¦ ì£¼ì†Œ ìš°í¸ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ í‘œì‹œ
  var bizPostBtn = document.getElementById('detBizPostBtn');
  if (bizPostBtn) bizPostBtn.style.display = '';
  // ì¸í—ˆê°€ ì¶”ê°€/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
  var addBtn = document.getElementById('detAddLicBtn');
  if (addBtn) addBtn.style.display = '';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = ''; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = ''; });
  // ë‹´ë‹¹ì ì¶”ê°€/ì‚­ì œ/ë§¤ì¹­ ë²„íŠ¼ í‘œì‹œ
  var addContactBtn = document.getElementById('detAddContactBtn');
  if (addContactBtn) addContactBtn.style.display = '';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = ''; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = ''; });
}

async function cancelDetailEdit() {
  _detailEditMode = false;
  // ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ë³µì›
  if (_detailSnapshot) {
    Object.keys(_detailSnapshot).forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.value = _detailSnapshot[id];
    });
  }
  // readonly ë³µì›
  document.querySelectorAll('#page-customerDetail .det-editable').forEach(function(el) {
    el.readOnly = true;
    el.style.background = '#f8f9fb';
    el.style.border = '';
  });
  ['detCompany','detRepName','detBizNo','detCorpNo','detBizType','detBizItem','detZipcode','detAddr1','detAddr2',
   'detCompanyEn','detRepNameEn','detAddrEn',
   'detTaxName','detTaxPhone','detTaxMobile','detTaxFax','detTaxEmail','detMemo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.readOnly = true; el.style.background = '#f8f9fb'; el.style.border = ''; }
  });
  // ë²„íŠ¼ ë³µì›
  document.getElementById('detailEditBtn').style.display = '';
  document.getElementById('detailSaveBtn').style.display = 'none';
  document.getElementById('detailCancelBtn').style.display = 'none';
  var bizPostBtn = document.getElementById('detBizPostBtn');
  if (bizPostBtn) bizPostBtn.style.display = 'none';
  var addBtn = document.getElementById('detAddLicBtn');
  if (addBtn) addBtn.style.display = 'none';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = 'none'; });
  // ë‹´ë‹¹ì ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  var addContactBtn = document.getElementById('detAddContactBtn');
  if (addContactBtn) addContactBtn.style.display = 'none';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = 'none'; });
  // ë™ì  ì¶”ê°€ëœ ì¹´ë“œ ì›ë³µ (ì›ë˜ ë°ì´í„° ì¬ë Œë”)
  var cust = await fsGetCompanyById(_detailCustId);
  if (cust) {
    renderDetailLicenses(cust);
    renderDetailContacts(cust);
    updateLicContactDisplay();
  }
  _detailSnapshot = null;
}

async function saveDetailEdit() {
  var cust = await fsGetCompanyById(_detailCustId);
  if (!cust) { toast('âš ï¸ ê³ ê°ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
  var now = new Date().toISOString().slice(0, 16).replace('T', ' ');
  var changes = [];

  // ê¸°ë³¸ ì •ë³´ ë¹„êµ ë° ì €ì¥
  var basicFields = [
    { id: 'detCompany', key: 'company', label: 'íšŒì‚¬ëª…' },
    { id: 'detRepName', key: 'repName', label: 'ëŒ€í‘œìëª…' },
    { id: 'detBizNo', key: 'bizNo', label: 'ì‚¬ì—…ìë²ˆí˜¸' },
    { id: 'detCorpNo', key: 'corpNo', label: 'ë²•ì¸ë²ˆí˜¸' },
    { id: 'detBizType', key: 'bizType', label: 'ì—…íƒœ' },
    { id: 'detBizItem', key: 'bizItem', label: 'ì¢…ëª©' },
    { id: 'detZipcode', key: 'zipcode', label: 'ìš°í¸ë²ˆí˜¸' },
    { id: 'detAddr1', key: 'addr1', label: 'ì£¼ì†Œ' },
    { id: 'detAddr2', key: 'addr2', label: 'ìƒì„¸ì£¼ì†Œ' },
    { id: 'detCompanyEn', key: 'companyEn', label: 'Company Name (EN)' },
    { id: 'detRepNameEn', key: 'repNameEn', label: 'Representative (EN)' },
    { id: 'detAddrEn', key: 'addrEn', label: 'Address (EN)' },
    { id: 'detTaxName', key: 'taxName', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ìëª…' },
    { id: 'detTaxPhone', key: 'taxPhone', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ ì „í™”' },
    { id: 'detTaxMobile', key: 'taxMobile', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ íœ´ëŒ€í°' },
    { id: 'detTaxFax', key: 'taxFax', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ íŒ©ìŠ¤' },
    { id: 'detTaxEmail', key: 'taxEmail', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ ì´ë©”ì¼' },
    { id: 'detMemo', key: 'memo', label: 'ë©”ëª¨' }
  ];
  basicFields.forEach(function(f) {
    var el = document.getElementById(f.id);
    if (!el) return;
    var newVal = el.value.trim();
    var oldVal = (cust[f.key] || '').trim();
    if (newVal !== oldVal) {
      changes.push({ field: f.label, from: oldVal, to: newVal });
      cust[f.key] = newVal;
    }
  });

  // ì¸í—ˆê°€ ì •ë³´ ìˆ˜ì§‘
  var newLicenses = [];
  for (var li = 1; li <= _detLicCardCount; li++) {
    if (!document.getElementById('detLicCard_' + li)) continue;
    var lic = {
      licField: (document.getElementById('detLicField_' + li) || {}).value || '',
      licBizForm: (document.getElementById('detLicBizForm_' + li) || {}).value || '',
      licRepName: (document.getElementById('detLicRepName_' + li) || {}).value || '',
      licNo: (document.getElementById('detLicNo_' + li) || {}).value || '',
      licBizName: (document.getElementById('detLicBizName_' + li) || {}).value || '',
      licZipcode: (document.getElementById('detLicZipcode_' + li) || {}).value || '',
      licAddr: (document.getElementById('detLicAddr_' + li) || {}).value || '',
      licAddr2: (document.getElementById('detLicAddr2_' + li) || {}).value || '',
      licBizNameEn: (document.getElementById('detLicBizNameEn_' + li) || {}).value || '',
      licRepNameEn: (document.getElementById('detLicRepNameEn_' + li) || {}).value || '',
      licAddrEn: (document.getElementById('detLicAddrEn_' + li) || {}).value || '',
      licContact: (document.getElementById('detLicContact_' + li) || {}).value || '',
      licContactPhone: (document.getElementById('detLicContactPhone_' + li) || {}).value || '',
      licSalesRep: (document.getElementById('detLicSalesRep_' + li) || {}).value || ''
    };
    newLicenses.push(lic);
  }

  // ì¸í—ˆê°€ ë³€ê²½ ê°ì§€ (ê°¯ìˆ˜ ë³€ê²½, ë‚´ìš© ë³€ê²½)
  var oldLicenses = cust.licenses || [];
  if (newLicenses.length !== oldLicenses.length) {
    changes.push({ field: 'ì¸í—ˆê°€ ìˆ˜', from: oldLicenses.length + 'ê±´', to: newLicenses.length + 'ê±´' });
  }
  var licKeys = ['licField','licBizForm','licRepName','licNo','licBizName','licAddr','licAddr2','licBizNameEn','licRepNameEn','licAddrEn','licContact','licContactPhone','licSalesRep'];
  var licLabels = { licField:'ë¶„ì•¼', licBizForm:'ì˜ì—…í˜•íƒœ', licRepName:'ëŒ€í‘œì', licNo:'ì¸í—ˆê°€ë²ˆí˜¸', licBizName:'ì˜ì—…ì†Œëª…ì¹­', licAddr:'ì†Œì¬ì§€', licAddr2:'ìƒì„¸ì£¼ì†Œ', licBizNameEn:'Business Name(EN)', licRepNameEn:'Representative(EN)', licAddrEn:'Address(EN)', licContact:'ì¸í—ˆê°€ ë‹´ë‹¹ì', licContactPhone:'ì¸í—ˆê°€ ë‹´ë‹¹ì ì „í™”', licSalesRep:'ì¸í—ˆê°€ ìì‚¬ë‹´ë‹¹' };
  for (var ci = 0; ci < Math.min(newLicenses.length, oldLicenses.length); ci++) {
    licKeys.forEach(function(k) {
      var ov = (oldLicenses[ci][k] || '').trim();
      var nv = (newLicenses[ci][k] || '').trim();
      if (ov !== nv) {
        changes.push({ field: 'ì¸í—ˆê°€' + (ci+1) + ' ' + licLabels[k], from: ov, to: nv });
      }
    });
  }

  cust.licenses = newLicenses;
  // í•˜ìœ„ í˜¸í™˜: ì²« ë²ˆì§¸ ì¸í—ˆê°€ â†’ ê¸°ì¡´ ë‹¨ì¼ í•„ë“œ
  if (newLicenses.length > 0) {
    var first = newLicenses[0];
    licKeys.forEach(function(k) { cust[k] = first[k] || ''; });
  }

  // ë‹¤ì¤‘ ë‹´ë‹¹ì ì •ë³´ ìˆ˜ì§‘
  var newContacts = [];
  for (var cti = 1; cti <= _detContactCardCount; cti++) {
    if (!document.getElementById('detContactCard_' + cti)) continue;
    var ctName = (document.getElementById('detContactName_' + cti) || {}).value || '';
    var ctPhone = (document.getElementById('detContactPhone_' + cti) || {}).value || '';
    var ctMobile = (document.getElementById('detContactMobile_' + cti) || {}).value || '';
    var ctFax = (document.getElementById('detContactFax_' + cti) || {}).value || '';
    var ctEmail = (document.getElementById('detContactEmail_' + cti) || {}).value || '';
    var ctRole = (document.getElementById('detContactRole_' + cti) || {}).value || '';
    var ctSalesRep = (document.getElementById('detContactSalesRep_' + cti) || {}).value || '';
    var ctLicNums = [];
    var hiddenEl = document.getElementById('detContactLicNums_' + cti);
    if (hiddenEl && hiddenEl.value) { try { ctLicNums = JSON.parse(hiddenEl.value); } catch(e) {} }
    // ë¹ˆ ë‹´ë‹¹ìëŠ” ê±´ë„ˆë›°ê¸°
    if (!ctName && !ctPhone && !ctEmail) continue;
    newContacts.push({ name: ctName, phone: ctPhone, mobile: ctMobile, fax: ctFax, email: ctEmail, role: ctRole, salesRep: ctSalesRep, licNums: ctLicNums });
  }

  // ë‹´ë‹¹ì ë³€ê²½ ê°ì§€
  var oldContacts = cust.contacts || [];
  if (newContacts.length !== oldContacts.length) {
    changes.push({ field: 'ë‹´ë‹¹ì ìˆ˜', from: oldContacts.length + 'ëª…', to: newContacts.length + 'ëª…' });
  }
  var ctKeys = ['name','phone','mobile','fax','email','role','salesRep'];
  var ctLabels = { name:'ì´ë¦„', phone:'ì „í™”ë²ˆí˜¸', mobile:'íœ´ëŒ€í°', fax:'íŒ©ìŠ¤ë²ˆí˜¸', email:'ì´ë©”ì¼', role:'ì—­í• ', salesRep:'ìì‚¬ ë‹´ë‹¹' };
  for (var cdi = 0; cdi < Math.min(newContacts.length, oldContacts.length); cdi++) {
    ctKeys.forEach(function(k) {
      var ov = (oldContacts[cdi][k] || '').trim();
      var nv = (newContacts[cdi][k] || '').trim();
      if (ov !== nv) {
        changes.push({ field: 'ë‹´ë‹¹ì' + (cdi+1) + ' ' + ctLabels[k], from: ov, to: nv });
      }
    });
    // licNums ë³€ê²½ ê°ì§€
    var oldNums = JSON.stringify(oldContacts[cdi].licNums || []);
    var newNums = JSON.stringify(newContacts[cdi].licNums || []);
    if (oldNums !== newNums) {
      changes.push({ field: 'ë‹´ë‹¹ì' + (cdi+1) + ' ì¸í—ˆê°€ ë§¤ì¹­', from: oldNums, to: newNums });
    }
  }

  cust.contacts = newContacts;
  // í•˜ìœ„ í˜¸í™˜: ì²« ë²ˆì§¸ ë‹´ë‹¹ì â†’ ê¸°ì¡´ ë‹¨ì¼ í•„ë“œ
  if (newContacts.length > 0) {
    cust.contactName = newContacts[0].name || '';
    cust.contactPhone = newContacts[0].phone || '';
    cust.contactMobile = newContacts[0].mobile || '';
    cust.contactFax = newContacts[0].fax || '';
    cust.contactEmail = newContacts[0].email || '';
    cust.salesRep = newContacts[0].salesRep || '';
  }

  // ë³€ê²½ ì´ë ¥ ê¸°ë¡
  if (changes.length > 0) {
    var detail = changes.map(function(c) {
      return 'ã€' + c.field + 'ã€‘ "' + (c.from || '(ì—†ìŒ)') + '" â†’ "' + c.to + '"';
    }).join(', ');
    if (!cust.changeLog) cust.changeLog = [];
    cust.changeLog.push({
      date: now,
      who: 'ë‹´ë‹¹ì (ìˆ˜ë™ ìˆ˜ì •)',
      detail: 'ìˆ˜ë™ ìˆ˜ì •ì— ì˜í•´ ë³€ê²½ë¨ â€” ' + detail
    });
  }

  try {
    await fsSaveCompany(Object.assign({id: _detailCustId}, cust));
  } catch(e) {
    toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    return;
  }

  // UI ë³µì› (readonly)
  _detailEditMode = false;
  document.querySelectorAll('#page-customerDetail .det-editable').forEach(function(el) {
    el.readOnly = true; el.style.background = '#f8f9fb'; el.style.border = '';
  });
  ['detCompany','detRepName','detBizNo','detCorpNo','detBizType','detBizItem','detZipcode','detAddr1','detAddr2',
   'detCompanyEn','detRepNameEn','detAddrEn',
   'detTaxName','detTaxPhone','detTaxMobile','detTaxFax','detTaxEmail','detMemo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.readOnly = true; el.style.background = '#f8f9fb'; el.style.border = ''; }
  });
  document.getElementById('detailEditBtn').style.display = '';
  document.getElementById('detailSaveBtn').style.display = 'none';
  document.getElementById('detailCancelBtn').style.display = 'none';
  // ì‚¬ì—…ìë“±ë¡ì¦ ì£¼ì†Œ ìš°í¸ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  var bizPostBtn = document.getElementById('detBizPostBtn');
  if (bizPostBtn) bizPostBtn.style.display = 'none';
  var addBtn = document.getElementById('detAddLicBtn');
  if (addBtn) addBtn.style.display = 'none';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = 'none'; });
  // ë‹´ë‹¹ì ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  var addContactBtn = document.getElementById('detAddContactBtn');
  if (addContactBtn) addContactBtn.style.display = 'none';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = 'none'; });

  // ë³€ê²½ ì´ë ¥ ê°±ì‹ 
  renderChangeLog(cust.changeLog || []);
  document.getElementById('detailCompanyTitle').textContent = cust.company;
  _detailSnapshot = null;

  if (changes.length > 0) {
    toast('âœ… ' + changes.length + 'ê±´ ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else {
    toast('â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
  }
}

// --- ìƒì„¸ í˜ì´ì§€: ì¸í—ˆê°€ ì¹´ë“œ ë™ì  ì¶”ê°€ ---
function addDetailLicenseCard() {
  _detLicCardCount++;
  var num = _detLicCardCount;
  var container = document.getElementById('detLicenseContainer');
  if (!container) return;

  var card = document.createElement('div');
  card.className = 'sub-card';
  card.id = 'detLicCard_' + num;
  card.style.marginBottom = '12px';
  card.style.animation = 'fadeIn 0.3s ease';

  card.innerHTML =
    '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">' + num + '</span> ì¸í—ˆê°€</div>' +
      '<button class="btn btn-secondary btn-sm detLicDelBtn" onclick="removeDetailLicenseCard(' + num + ')" style="margin-left:auto;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
    '</div>' +
    // OCR ì˜ì—­ (ì¶”ê°€ ì¸í—ˆê°€ ì „ìš©)
    '<div style="background:#f3f0ff;border:1px solid #d1c4e9;border-radius:8px;padding:10px;margin-bottom:10px">' +
      '<div style="font-size:12px;font-weight:600;color:#5e35b1;margin-bottom:6px">ğŸ“„ ì¸í—ˆê°€ ' + num + ' ë¬¸ì„œ OCR</div>' +
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">' +
        '<div class="file-area" style="flex:1;min-width:180px;padding:8px;position:relative;cursor:pointer" onclick="document.getElementById(\'detLicFileInput_' + num + '\').click()">' +
          '<input type="file" id="detLicFileInput_' + num + '" accept="image/*,.pdf" style="display:none" onchange="handleDetLicCardFile(' + num + ',this.files[0])">' +
          '<span id="detLicFileName_' + num + '" style="font-size:11px">ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼</span>' +
        '</div>' +
        '<button class="btn btn-check btn-sm" id="detLicOcrBtn_' + num + '" onclick="runDetLicCardOCR(' + num + ')" disabled style="font-size:11px">ğŸ¤– OCR</button>' +
      '</div>' +
      '<div id="detLicOcrStatus_' + num + '" style="margin-top:4px;font-size:11px;color:#5e35b1;display:none"></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ë¶„ì•¼</label><input id="detLicField_' + num + '" placeholder="ì‹í’ˆ/ì¶•ì‚°" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ</label><input id="detLicBizForm_' + num + '" placeholder="ì˜ì—… í˜•íƒœ" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ëŒ€í‘œì</label><input id="detLicRepName_' + num + '" placeholder="ëŒ€í‘œì" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸</label><input id="detLicNo_' + num + '" placeholder="ì¸í—ˆê°€ë²ˆí˜¸" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '</div>' +
    '<div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­</label><input id="detLicBizName_' + num + '" placeholder="ì˜ì—…ì†Œ ëª…ì¹­" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '<div class="fg"><label>ì†Œì¬ì§€</label>' +
      '<div class="addr-row" style="margin-bottom:4px"><input id="detLicZipcode_' + num + '" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;border:1px solid #1a73e8" class="det-editable" readonly><button class="btn btn-secondary btn-sm detLicPostBtn" onclick="openLicPostcodeSearch(' + num + ',true)">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>' +
    '</div>' +
    '<div class="fg"><input id="detLicAddr_' + num + '" placeholder="ê¸°ë³¸ì£¼ì†Œ" style="border:1px solid #1a73e8" class="det-editable" readonly></div>' +
    '<div class="fg"><input id="detLicAddr2_' + num + '" placeholder="ìƒì„¸ì£¼ì†Œ" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '<div class="eng-toggle" onclick="toggleEngSection(\'detLicEngSection_' + num + '\')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">' +
      '<span style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)' +
    '</div>' +
    '<div id="detLicEngSection_' + num + '" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">' +
      '<div class="fg"><label>Business Name (EN)</label><input id="detLicBizNameEn_' + num + '" placeholder="Business name" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>Representative (EN)</label><input id="detLicRepNameEn_' + num + '" placeholder="Representative" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>Address (EN)</label><input id="detLicAddrEn_' + num + '" placeholder="Address" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '</div>' +
    // ì¸í—ˆê°€ ë‹´ë‹¹ì í•„ë“œ
    '<div style="margin-top:8px;padding:8px 10px;background:#f1f8e9;border-radius:6px;border:1px solid #c5e1a5">' +
      '<div style="display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;color:#33691e;margin-bottom:6px">ğŸ‘¤ ì¸í—ˆê°€ ë‹´ë‹¹ì' +
        '<span id="detLicSalesRepLabel_' + num + '" style="background:#e3f2fd;color:#1565c0;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;margin-left:auto">ğŸ¢ ìì‚¬: -</span>' +
        '<input type="hidden" id="detLicSalesRep_' + num + '" value="">' +
      '</div>' +
      '<div class="fg-row" style="gap:8px">' +
        '<div class="fg"><label style="color:#33691e;font-size:11px">ë‹´ë‹¹ì</label><input id="detLicContact_' + num + '" placeholder="ë§¤ì¹­ ë˜ëŠ” ì§ì ‘ ì…ë ¥" style="border:1px solid #c5e1a5;background:#f5f9f0;font-size:12px" class="det-editable det-lic-contact-field"></div>' +
        '<div class="fg"><label style="color:#33691e;font-size:11px">ì „í™”ë²ˆí˜¸</label><input id="detLicContactPhone_' + num + '" placeholder="ì „í™”ë²ˆí˜¸" style="border:1px solid #c5e1a5;background:#f5f9f0;font-size:12px" class="det-editable det-lic-contact-field"></div>' +
      '</div>' +
    '</div>';

  container.appendChild(card);
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  toast('âœ… ì¸í—ˆê°€ ' + num + ' ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function removeDetailLicenseCard(num) {
  var card = document.getElementById('detLicCard_' + num);
  if (!card) return;
  if (!confirm('ì¸í—ˆê°€ ' + num + ' ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  card.remove();
  toast('ğŸ—‘ï¸ ì¸í—ˆê°€ ' + num + ' ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// --- ì¶”ê°€ ì¸í—ˆê°€ ì¹´ë“œë³„ íŒŒì¼ í•¸ë“¤ëŸ¬ ---
var _detLicCardFiles = {}; // { num: File }
function handleDetLicCardFile(num, file) {
  if (!file) return;
  _detLicCardFiles[num] = file;
  var nameEl = document.getElementById('detLicFileName_' + num);
  if (nameEl) nameEl.textContent = 'ğŸ“ ' + file.name;
  var btn = document.getElementById('detLicOcrBtn_' + num);
  if (btn) btn.disabled = false;
}

// --- ì¶”ê°€ ì¸í—ˆê°€ ì¹´ë“œë³„ OCR ---
function runDetLicCardOCR(num) {
  var file = _detLicCardFiles[num];
  if (!file) return;
  var statusEl = document.getElementById('detLicOcrStatus_' + num);
  if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'â³ OCR ì¸ì‹ ì¤‘...'; }
  var btn = document.getElementById('detLicOcrBtn_' + num);
  if (btn) btn.disabled = true;

  convertPdfToJpegBase64(file).then(function(result) {
    var payload = { images: [{ format: result.format, name: 'lic' + num, data: result.base64 }], requestId: 'det-lic' + num + '-' + Date.now(), version: 'V2', timestamp: Date.now() };
    return fetch(OCR_BIZ_LICENSE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }).then(function(r) { return r.json(); })
  .then(function(data) {
    var res = data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result;
    if (!res) { if (statusEl) statusEl.textContent = 'âŒ OCR ì¸ì‹ ì‹¤íŒ¨'; return; }

    function gt(f) { return (f && f.length) ? f.map(function(x){return x.text||''}).join(' ') : ''; }
    var filled = 0;
    // ëŒ€í‘œì
    var repName = gt(res.repName);
    if (repName) { var el = document.getElementById('detLicRepName_' + num); if (el) { el.value = repName; filled++; } }
    // ì¸í—ˆê°€ë²ˆí˜¸
    var regNo = gt(res.registerNumber);
    if (regNo) { var el = document.getElementById('detLicNo_' + num); if (el) { el.value = regNo; filled++; } }
    // ì˜ì—…ì†Œëª…ì¹­
    var compName = gt(res.companyName);
    if (compName) { var el = document.getElementById('detLicBizName_' + num); if (el) { el.value = compName; filled++; } }
    // ì˜ì—…í˜•íƒœ
    var bizForm = gt(res.bisType) || gt(res.bisItem) || '';
    if (bizForm) { var el = document.getElementById('detLicBizForm_' + num); if (el) { el.value = bizForm.trim(); filled++; } }
    // ë¶„ì•¼ ìë™ ì„¤ì •
    var allText = [bizForm, compName, gt(res.documentType)].join(' ');
    var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
    var fieldEl = document.getElementById('detLicField_' + num);
    if (fieldEl) { fieldEl.value = isLivestock ? 'ì¶•ì‚°' : 'ì‹í’ˆ'; filled++; }
    // ì†Œì¬ì§€ ì£¼ì†Œ + ì¹´ì¹´ì˜¤ ì£¼ì†Œ API
    var ocrAddr = gt(res.bisAddress);
    if (ocrAddr) {
      var rawAddr = ocrAddr.trim();
      var addrEl = document.getElementById('detLicAddr_' + num);
      if (addrEl) { addrEl.value = rawAddr; filled++; }
      lookupAddressFromKakao(rawAddr, function(zipcode, roadAddr, detailAddr) {
        if (zipcode) { var zEl = document.getElementById('detLicZipcode_' + num); if (zEl) zEl.value = zipcode; }
        if (roadAddr) { var aEl = document.getElementById('detLicAddr_' + num); if (aEl) aEl.value = roadAddr; }
        if (detailAddr) { var a2El = document.getElementById('detLicAddr2_' + num); if (a2El) a2El.value = detailAddr; }
        // ì˜ë¬¸ ì£¼ì†Œ ë³€í™˜
        convertToEnglishAddress(roadAddr || rawAddr, function(eng) {
          var enEl = document.getElementById('detLicAddrEn_' + num);
          if (enEl) enEl.value = eng;
        });
      });
    }
    if (statusEl) statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ' + filled + 'ê°œ í•„ë“œ ë°˜ì˜';
  }).catch(function(e) {
    if (statusEl) statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + e.message;
  });
}

function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function renderChangeLog(logs) {
  var tbody = document.getElementById('changeLogTbody');
  if (!tbody) return;
  if (!logs || logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8892a4;padding:20px">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  // ìµœì‹  ìˆœìœ¼ë¡œ í‘œì‹œ
  var sorted = logs.slice().reverse();
  sorted.forEach(function(log) {
    var tr = document.createElement('tr');
    tr.innerHTML = '<td style="white-space:nowrap;color:#5f6b7a">' + log.date + '</td>' +
      '<td>' + (log.who || 'ì‹œìŠ¤í…œ') + '</td>' +
      '<td style="font-size:11px">' + (log.detail || '') + '</td>';
    tbody.appendChild(tr);
  });
}

function handleDetailBizFile(file) {
  if (!file) return;
  _detailBizFile = file;
  document.getElementById('detailBizFileName').textContent = 'ğŸ“ ' + file.name;
  document.getElementById('detailBizOcrBtn').disabled = false;
}

function handleDetailLicFile(file) {
  if (!file) return;
  _detailLicFile = file;
  document.getElementById('detailLicFileName').textContent = 'ğŸ“ ' + file.name;
  document.getElementById('detailLicOcrBtn').disabled = false;
}

function runDetailBizOCR() {
  if (!_detailBizFile || !_detailCustId) return;
  var statusEl = document.getElementById('detailOcrStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = 'â³ ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¸ì‹ ì¤‘...';
  document.getElementById('detailBizOcrBtn').disabled = true;

  convertPdfToJpegBase64(_detailBizFile).then(function(result) {
    var payload = { images: [{ format: result.format, name: 'biz', data: result.base64 }], requestId: 'det-biz-' + Date.now(), version: 'V2', timestamp: Date.now() };
    return fetch(OCR_BIZ_LICENSE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }).then(function(r) { return r.json(); })
  .then(async function(data) {
    var res = data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result;
    if (!res) { statusEl.textContent = 'âŒ OCR ì¸ì‹ ì‹¤íŒ¨'; return; }

    function gt(f) { return (f && f.length) ? f.map(function(x){return x.text||''}).join(' ') : ''; }
    var changes = [];
    var cust = await fsGetCompanyById(_detailCustId);
    if (!cust) { statusEl.textContent = 'âŒ ê³ ê°ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; return; }
    var now = new Date().toISOString().slice(0, 16).replace('T', ' ');

    // í•„ë“œë³„ ë¹„êµ ë° ë³€ê²½ ê°ì§€
    var fieldMap = [
      { key: 'company', label: 'íšŒì‚¬ëª…', ocrField: function() { return gt(res.corpName) || gt(res.companyName); }, detId: 'detCompany' },
      { key: 'repName', label: 'ëŒ€í‘œìëª…', ocrField: function() { return gt(res.repName); }, detId: 'detRepName' },
      { key: 'bizNo', label: 'ì‚¬ì—…ìë²ˆí˜¸', ocrField: function() { return gt(res.registerNumber); }, detId: 'detBizNo' },
      { key: 'bizType', label: 'ì—…íƒœ', ocrField: function() { return gt(res.bisType); }, detId: 'detBizType' },
      { key: 'bizItem', label: 'ì¢…ëª©', ocrField: function() { return gt(res.bisItem); }, detId: 'detBizItem' }
    ];

    fieldMap.forEach(function(fm) {
      var newVal = fm.ocrField().trim();
      var oldVal = (cust[fm.key] || '').trim();
      if (newVal && newVal !== oldVal) {
        changes.push({ field: fm.label, from: oldVal, to: newVal });
        cust[fm.key] = newVal;
        document.getElementById(fm.detId).value = newVal;
      }
    });

    // ì£¼ì†Œ ì²˜ë¦¬: ì¹´ì¹´ì˜¤ ì£¼ì†Œ APIë¡œ ìš°í¸ë²ˆí˜¸/ë„ë¡œëª…/ìƒì„¸ì£¼ì†Œ íŒŒì‹±
    var ocrAddr = gt(res.bisAddress);
    if (ocrAddr) {
      var rawAddr = ocrAddr.trim();
      // ì¦‰ì‹œ ë°˜ì˜ (raw ê¸°ì¤€)
      var oldAddr1 = (cust.addr1 || '').trim();
      if (rawAddr && rawAddr !== oldAddr1) {
        changes.push({ field: 'ì£¼ì†Œ', from: oldAddr1, to: rawAddr });
        cust.addr1 = rawAddr;
        document.getElementById('detAddr1').value = rawAddr;
      }
      // ì¹´ì¹´ì˜¤ ì£¼ì†Œ APIë¡œ ìš°í¸ë²ˆí˜¸, ë„ë¡œëª…ì£¼ì†Œ, ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬
      lookupAddressFromKakao(rawAddr, function(zipcode, roadAddr, detailAddr) {
        if (zipcode) { cust.zipcode = zipcode; document.getElementById('detZipcode').value = zipcode; }
        if (roadAddr) { cust.addr1 = roadAddr; document.getElementById('detAddr1').value = roadAddr; }
        if (detailAddr) { cust.addr2 = detailAddr; document.getElementById('detAddr2').value = detailAddr; }
        // Firestore ì—…ë°ì´íŠ¸
        db.collection('companies').doc(_detailCustId).update({ zipcode: cust.zipcode, addr1: cust.addr1, addr2: cust.addr2 || '' }).catch(function(e){ console.warn('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', e); });
      });
    }

    // ë³€ê²½ ì´ë ¥ ê¸°ë¡
    if (changes.length > 0) {
      var detail = changes.map(function(c) {
        return 'ã€' + c.field + 'ã€‘ "' + (c.from || '(ì—†ìŒ)') + '" â†’ "' + c.to + '"';
      }).join(', ');
      var logEntry = {
        date: now,
        who: 'ì‹œìŠ¤í…œ (ì‚¬ì—…ìë“±ë¡ì¦ OCR)',
        detail: 'ì‚¬ì—…ìë“±ë¡ì¦ ì¬ì¸ì‹ì— ì˜í•´ ë³€ê²½ë¨ â€” ' + detail
      };
      if (!cust.changeLog) cust.changeLog = [];
      cust.changeLog.push(logEntry);
      fsSaveCompany(Object.assign({id: _detailCustId}, cust)).catch(function(e){ console.warn('ì €ì¥ ì‹¤íŒ¨:', e); });
      renderChangeLog(cust.changeLog);
      document.getElementById('detailCompanyTitle').textContent = cust.company;
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ' + changes.length + 'ê±´ ë³€ê²½ì‚¬í•­ ë°˜ì˜';
    } else {
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ë³€ê²½ì‚¬í•­ ì—†ìŒ';
    }
    // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
    if (cust.addr1) {
      convertToEnglishAddress(cust.addr1 + ' ' + (cust.addr2 || ''), function(eng) {
        cust.addrEn = eng;
        document.getElementById('detAddrEn').value = eng;
        db.collection('companies').doc(_detailCustId).update({ addrEn: eng }).catch(function(e){ console.warn('ì˜ë¬¸ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', e); });
      });
    }
  }).catch(function(e) {
    statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + e.message;
  });
}

function runDetailLicOCR() {
  if (!_detailLicFile || !_detailCustId) return;
  var statusEl = document.getElementById('detailOcrStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = 'â³ ì¸í—ˆê°€ë¬¸ì„œ OCR ì¸ì‹ ì¤‘...';
  document.getElementById('detailLicOcrBtn').disabled = true;

  convertPdfToJpegBase64(_detailLicFile).then(function(result) {
    var payload = { images: [{ format: result.format, name: 'lic', data: result.base64 }], requestId: 'det-lic-' + Date.now(), version: 'V2', timestamp: Date.now() };
    return fetch(OCR_BIZ_LICENSE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }).then(function(r) { return r.json(); })
  .then(async function(data) {
    var res = data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result;
    if (!res) { statusEl.textContent = 'âŒ OCR ì¸ì‹ ì‹¤íŒ¨'; return; }

    function gt(f) { return (f && f.length) ? f.map(function(x){return x.text||''}).join(' ') : ''; }
    var changes = [];
    var cust = await fsGetCompanyById(_detailCustId);
    if (!cust) { statusEl.textContent = 'âŒ ê³ ê°ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; return; }
    var now = new Date().toISOString().slice(0, 16).replace('T', ' ');

    // ì²« ë²ˆì§¸ ì¸í—ˆê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ (ê¸°ì¡´ í˜¸í™˜ì„±)
    var lic0 = (cust.licenses && cust.licenses.length > 0) ? cust.licenses[0] : cust;

    var licFields = [
      { key: 'licRepName', label: 'ì¸í—ˆê°€ ëŒ€í‘œì', ocrField: function() { return gt(res.repName); }, detId: 'detLicRepName_1' },
      { key: 'licNo', label: 'ì¸í—ˆê°€ë²ˆí˜¸', ocrField: function() { return gt(res.registerNumber); }, detId: 'detLicNo_1' },
      { key: 'licBizName', label: 'ì˜ì—…ì†Œëª…ì¹­', ocrField: function() { return gt(res.companyName); }, detId: 'detLicBizName_1' }
    ];

    // ì˜ì—…í˜•íƒœ
    var bizFormRaw = gt(res.bisType) || gt(res.bisItem) || '';
    if (bizFormRaw) {
      var oldBizForm = (lic0.licBizForm || '').trim();
      if (bizFormRaw.trim() !== oldBizForm) {
        changes.push({ field: 'ì˜ì—…ì˜ í˜•íƒœ', from: oldBizForm, to: bizFormRaw.trim() });
        lic0.licBizForm = bizFormRaw.trim();
        cust.licBizForm = bizFormRaw.trim();
        var detBizFormEl = document.getElementById('detLicBizForm_1');
        if (detBizFormEl) detBizFormEl.value = bizFormRaw.trim();
      }
    }

    licFields.forEach(function(fm) {
      var newVal = fm.ocrField().trim();
      var oldVal = (lic0[fm.key] || '').trim();
      if (newVal && newVal !== oldVal) {
        changes.push({ field: fm.label, from: oldVal, to: newVal });
        lic0[fm.key] = newVal;
        cust[fm.key] = newVal;
        var detEl = document.getElementById(fm.detId);
        if (detEl) detEl.value = newVal;
      }
    });

    // ì†Œì¬ì§€ ì£¼ì†Œ: ì¹´ì¹´ì˜¤ ì£¼ì†Œ APIë¡œ ìš°í¸ë²ˆí˜¸/ë„ë¡œëª…/ìƒì„¸ íŒŒì‹±
    var ocrAddr = gt(res.bisAddress);
    if (ocrAddr) {
      var rawLicAddr = ocrAddr.trim();
      var oldLicAddr = (lic0.licAddr || '').trim();
      if (rawLicAddr !== oldLicAddr) {
        changes.push({ field: 'ì¸í—ˆê°€ ì†Œì¬ì§€', from: oldLicAddr, to: rawLicAddr });
        lic0.licAddr = rawLicAddr;
        cust.licAddr = rawLicAddr;
        var detAddrEl = document.getElementById('detLicAddr_1');
        if (detAddrEl) detAddrEl.value = rawLicAddr;
      }
      // ì¹´ì¹´ì˜¤ ì£¼ì†Œ APIë¡œ ìš°í¸ë²ˆí˜¸, ë„ë¡œëª…ì£¼ì†Œ, ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬
      lookupAddressFromKakao(rawLicAddr, function(zipcode, roadAddr, detailAddr) {
        if (zipcode) { lic0.licZipcode = zipcode; var zEl = document.getElementById('detLicZipcode_1'); if (zEl) zEl.value = zipcode; }
        if (roadAddr) { lic0.licAddr = roadAddr; cust.licAddr = roadAddr; var aEl = document.getElementById('detLicAddr_1'); if (aEl) aEl.value = roadAddr; }
        if (detailAddr) { lic0.licAddr2 = detailAddr; cust.licAddr2 = detailAddr; var a2El = document.getElementById('detLicAddr2_1'); if (a2El) a2El.value = detailAddr; }
        if (cust.licenses && cust.licenses.length > 0) cust.licenses[0] = lic0;
        db.collection('companies').doc(_detailCustId).update({ licenses: cust.licenses || [], licAddr: cust.licAddr || '', licAddr2: cust.licAddr2 || '' }).catch(function(e){ console.warn('ì¸í—ˆê°€ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', e); });
      });
    }

    // ë¶„ì•¼ ìë™ ì„¤ì •
    var allText = [bizFormRaw, gt(res.companyName), gt(res.documentType)].join(' ');
    var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
    var newField = isLivestock ? 'ì¶•ì‚°' : 'ì‹í’ˆ';
    if (lic0.licField !== newField) {
      changes.push({ field: 'ë¶„ì•¼', from: lic0.licField || '', to: newField });
      lic0.licField = newField;
      cust.licField = newField;
      var detFieldEl = document.getElementById('detLicField_1');
      if (detFieldEl) detFieldEl.value = newField;
    }

    // licenses ë°°ì—´ ì—…ë°ì´íŠ¸
    if (cust.licenses && cust.licenses.length > 0) {
      cust.licenses[0] = lic0;
    }

    // ë³€ê²½ ì´ë ¥ ê¸°ë¡
    if (changes.length > 0) {
      var detail = changes.map(function(c) {
        return 'ã€' + c.field + 'ã€‘ "' + (c.from || '(ì—†ìŒ)') + '" â†’ "' + c.to + '"';
      }).join(', ');
      var logEntry = {
        date: now,
        who: 'ì‹œìŠ¤í…œ (ì¸í—ˆê°€ë¬¸ì„œ OCR)',
        detail: 'ì¸í—ˆê°€ë¬¸ì„œ ì¬ì¸ì‹ì— ì˜í•´ ë³€ê²½ë¨ â€” ' + detail
      };
      if (!cust.changeLog) cust.changeLog = [];
      cust.changeLog.push(logEntry);
      fsSaveCompany(Object.assign({id: _detailCustId}, cust)).catch(function(e){ console.warn('ì €ì¥ ì‹¤íŒ¨:', e); });
      renderChangeLog(cust.changeLog);
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ' + changes.length + 'ê±´ ë³€ê²½ì‚¬í•­ ë°˜ì˜';
    } else {
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ë³€ê²½ì‚¬í•­ ì—†ìŒ';
    }
    // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
    if (lic0.licAddr) {
      convertToEnglishAddress(lic0.licAddr + ' ' + (lic0.licAddr2 || ''), function(eng) {
        lic0.licAddrEn = eng;
        cust.licAddrEn = eng;
        if (cust.licenses && cust.licenses.length > 0) cust.licenses[0].licAddrEn = eng;
        var detEngEl = document.getElementById('detLicAddrEn_1');
        if (detEngEl) detEngEl.value = eng;
        db.collection('companies').doc(_detailCustId).update({ licAddrEn: eng, licenses: cust.licenses || [] }).catch(function(e){ console.warn('ì¸í—ˆê°€ ì˜ë¬¸ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', e); });
      });
    }
  }).catch(function(e) {
    statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + e.message;
  });
}

// ============================================================
// ê³ ê°ì‚¬ ì‹ ê·œ ë“±ë¡ í¼ ì´ˆê¸°í™”
// ============================================================
function resetCustomerRegForm() {
  var page = document.getElementById('page-customerReg');
  if (!page) return;
  // ëª¨ë“  input ì´ˆê¸°í™” (hidden, radio ì œì™¸)
  page.querySelectorAll('input').forEach(function(el) {
    if (el.type === 'radio') return;
    if (el.type === 'file') { el.value = ''; return; }
    el.value = '';
    el.style.background = '';
    el.style.borderColor = '';
    if (el.id === 'regAddr1' || el.id === 'regZipcode') { el.value = ''; return; }
  });
  // select ì´ˆê¸°í™” (ì²«ë²ˆì§¸ option ì„ íƒ)
  page.querySelectorAll('select').forEach(function(el) { el.selectedIndex = 0; });
  // textarea ì´ˆê¸°í™”
  page.querySelectorAll('textarea').forEach(function(el) { el.value = ''; });
  // ë¼ë””ì˜¤ ê¸°ë³¸ê°’ ë³µì› (ë²•ì¸)
  var corpYes = document.getElementById('regCorpYes');
  if (corpYes) corpYes.checked = true;
  // OCR ìƒíƒœ ì´ˆê¸°í™”
  _bizLicFile = null;
  _licFiles = {};
  var bizLicFileName = document.getElementById('bizLicFileName');
  if (bizLicFileName) bizLicFileName.textContent = 'ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ (JPG, PNG, PDF)';
  var bizLicOcrBtn = document.getElementById('bizLicOcrBtn');
  if (bizLicOcrBtn) { bizLicOcrBtn.disabled = true; bizLicOcrBtn.textContent = 'ğŸ¤– OCR ì¸ì‹'; }
  var bizLicOcrStatus = document.getElementById('bizLicOcrStatus');
  if (bizLicOcrStatus) { bizLicOcrStatus.style.display = 'none'; bizLicOcrStatus.textContent = ''; }
  var bizLicPreview = document.getElementById('bizLicPreview');
  if (bizLicPreview) bizLicPreview.style.display = 'none';
  // ì¸í—ˆê°€ OCR ìƒíƒœ ì´ˆê¸°í™”
  var licFileName = document.getElementById('licFileName_1');
  if (licFileName) licFileName.textContent = 'ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸';
  var licOcrBtn = document.getElementById('licOcrBtn_1');
  if (licOcrBtn) { licOcrBtn.disabled = true; }
  var licOcrStatus = document.getElementById('licOcrStatus_1');
  if (licOcrStatus) { licOcrStatus.style.display = 'none'; licOcrStatus.textContent = ''; }
  // ì¸í—ˆê°€ ì£¼ì†Œ í•„ë“œ ì´ˆê¸°í™”
  var licZip = document.getElementById('licZipcode_1');
  if (licZip) licZip.value = '';
  var licAddr2 = document.getElementById('licAddr2_1');
  if (licAddr2) licAddr2.value = '';
  // ë™ì ìœ¼ë¡œ ì¶”ê°€ëœ ì¸í—ˆê°€ ì¹´ë“œ ì‚­ì œ (ì¹´ë“œ 2ë²ˆ ì´ìƒ)
  for (var ri = 2; ri <= _licenseCardCount; ri++) {
    var dynCard = document.getElementById('licCard_' + ri);
    if (dynCard) dynCard.remove();
  }
  _licenseCardCount = 1;
  // ì¤‘ë³µí™•ì¸ ê²°ê³¼ ì´ˆê¸°í™”
  var compChk = document.getElementById('compChk');
  if (compChk) compChk.innerHTML = '';
  var cntChk = document.getElementById('cntChk');
  if (cntChk) cntChk.innerHTML = '';
}

// ============================================================
// OCR: Naver Clova Document OCR
// ============================================================
// OCR í”„ë¡ì‹œ ì„œë²„ URL (ocr_proxy.py â€” CORS ìš°íšŒ + Secret Key ì„œë²„ ë³´ê´€)
// HTTPS: Mixed Content ë°©ì§€ (GitHub Pages ë“± HTTPS í˜ì´ì§€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
// ìì²´ì„œëª… ì¸ì¦ì„œ ì‚¬ìš© â€” ìµœì´ˆ ì ‘ì† ì‹œ ë¸Œë¼ìš°ì €ì—ì„œ ì¸ì¦ì„œ ì‹ ë¢° í•„ìš”
var OCR_PROXY_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
  ? 'https://127.0.0.1:5002'
  : '/ocr';
var OCR_BIZ_LICENSE_URL = OCR_PROXY_BASE + '/api/ocr/biz-license';
var OCR_GENERAL_URL = OCR_PROXY_BASE + '/api/ocr/general';

var _bizLicFile = null;

// --- PDF â†’ JPEG ì´ë¯¸ì§€ ë³€í™˜ (Clova íŠ¹í™”ëª¨ë¸ì€ ë‹¤ì¤‘í˜ì´ì§€ PDF ë¯¸ì§€ì›) ---
// PDF íŒŒì¼ì´ë©´ ì²« í˜ì´ì§€ë¥¼ canvasë¡œ ë Œë”ë§ â†’ JPEG base64ë¡œ ë³€í™˜
function convertPdfToJpegBase64(file) {
  return new Promise(function(resolve, reject) {
    var ext = file.name.split('.').pop().toLowerCase();
    if (ext !== 'pdf') {
      // PDFê°€ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ FileReaderë¡œ ì½ê¸°
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];
        if (ext === 'jpg' || ext === 'jpeg') ext = 'jpg';
        else if (ext === 'png') ext = 'png';
        else ext = 'jpg';
        resolve({ base64: base64, format: ext });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
      return;
    }
    // PDF â†’ ì´ë¯¸ì§€ ë³€í™˜
    if (!window.pdfjsLib) {
      reject(new Error('PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨'));
      return;
    }
    var reader2 = new FileReader();
    reader2.onload = function(e) {
      var typedArray = new Uint8Array(e.target.result);
      pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
        // ì²« í˜ì´ì§€ë§Œ ë Œë”ë§
        pdf.getPage(1).then(function(page) {
          var scale = 2.0; // ê³ í•´ìƒë„
          var viewport = page.getViewport({ scale: scale });
          var canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          var ctx = canvas.getContext('2d');
          page.render({ canvasContext: ctx, viewport: viewport }).promise.then(function() {
            var jpegBase64 = canvas.toDataURL('image/jpeg', 0.92).split(',')[1];
            resolve({ base64: jpegBase64, format: 'jpg' });
          }).catch(reject);
        }).catch(reject);
      }).catch(reject);
    };
    reader2.onerror = reject;
    reader2.readAsArrayBuffer(file);
  });
}
var _licFiles = {};
var _licenseCardCount = 1; // í˜„ì¬ ì¸í—ˆê°€ ì¹´ë“œ ìˆ˜ (ì´ˆê¸° 1ê°œ)

// --- ì¸í—ˆê°€ ì •ë³´ ë™ì  ì¶”ê°€ ---
function addLicenseCard() {
  _licenseCardCount++;
  var idx = _licenseCardCount;
  var area = document.getElementById('licenseArea');
  if (!area) return;

  var card = document.createElement('div');
  card.className = 'sub-card';
  card.id = 'licCard_' + idx;
  card.innerHTML =
    '<div class="sub-card-hd">' +
      '<div class="sub-card-title"><span class="sub-card-num">' + idx + '</span> ì¸í—ˆê°€</div>' +
      '<button type="button" class="btn btn-secondary btn-sm" onclick="removeLicenseCard(' + idx + ')" style="margin-left:auto;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ë¶„ì•¼ <span class="req">*</span></label><select id="licField_' + idx + '"><option>ì„ íƒ</option><option>ì‹í’ˆ</option><option>ì¶•ì‚°</option></select></div>' +
      '<div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ <span class="req">*</span></label><div class="combo"><select id="licBizForm_' + idx + '"><option>ì„ íƒ</option><option>ì‹í’ˆì œì¡°ê°€ê³µì—…</option><option>ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</option><option>ì‹í’ˆì†Œë¶„ì—…</option><option>ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì¶•ì‚°ë¬¼ê°€ê³µì—…</option><option>ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</option><option value="etc">âœï¸ ì§ì ‘ ì…ë ¥</option></select></div></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ëŒ€í‘œì <span class="req">*</span></label><input id="licRepName_' + idx + '" placeholder="ì¸í—ˆê°€ ëŒ€í‘œì"></div>' +
      '<div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸ <span class="req">*</span></label><input id="licNo_' + idx + '" placeholder="ì¸í—ˆê°€ë²ˆí˜¸"></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­ <span class="req">*</span></label><input id="licBizName_' + idx + '" placeholder="ì˜ì—…ì†Œ ëª…ì¹­"></div>' +
    '</div>' +
    '<div class="fg"><label>ì†Œì¬ì§€ <span class="req">*</span></label>' +
      '<div class="addr-row"><input id="licZipcode_' + idx + '" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px" readonly><button class="btn btn-secondary btn-sm" onclick="openLicPostcodeSearch(' + idx + ')">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>' +
    '</div>' +
    '<div class="fg"><input id="licAddr_' + idx + '" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìë™ì…ë ¥)" readonly></div>' +
    '<div class="fg"><input id="licAddr2_' + idx + '" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"></div>' +
    '<div class="fg"><label>ì¸í—ˆê°€ ë¬¸ì„œ ì²¨ë¶€</label>' +
      '<div style="display:flex;gap:8px;align-items:center">' +
        '<div class="file-area" id="licFileArea_' + idx + '" style="flex:1;padding:10px;position:relative" onclick="document.getElementById(\'licFileInput_' + idx + '\').click()" ondragover="event.preventDefault();this.style.borderColor=\'#1a73e8\'" ondragleave="this.style.borderColor=\'#e2e6ed\'" ondrop="event.preventDefault();this.style.borderColor=\'#e2e6ed\';handleLicFile(' + idx + ',event.dataTransfer.files[0])">' +
          '<input type="file" id="licFileInput_' + idx + '" accept="image/*,.pdf" style="display:none" onchange="handleLicFile(' + idx + ',this.files[0])">' +
          '<span id="licFileName_' + idx + '">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span>' +
        '</div>' +
        '<button class="btn btn-check btn-sm" id="licOcrBtn_' + idx + '" onclick="runLicOCR(' + idx + ')" disabled style="white-space:nowrap">ğŸ¤– OCR ì¸ì‹</button>' +
      '</div>' +
      '<div id="licOcrStatus_' + idx + '" style="margin-top:4px;font-size:11px;color:#1565c0;display:none"></div>' +
    '</div>' +
    '<!-- ì¸í—ˆê°€ ì˜ë¬¸ ì •ë³´ (ì ‘ì´ì‹) -->' +
    '<div class="eng-toggle" onclick="toggleEngSection(\'licEngSection_' + idx + '\')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">' +
      '<span id="licEngArrow_' + idx + '" style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)' +
    '</div>' +
    '<div id="licEngSection_' + idx + '" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">' +
      '<div class="fg"><label>Business Name (EN)</label><input id="licBizNameEn_' + idx + '" placeholder="Business name in English"></div>' +
      '<div class="fg"><label>Representative (EN)</label><input id="licRepNameEn_' + idx + '" placeholder="Representative name in English"></div>' +
      '<div class="fg"><label>Address (EN)</label><input id="licAddrEn_' + idx + '" placeholder="Address in English (auto-converted)"></div>' +
    '</div>';

  area.appendChild(card);

  // ìƒˆ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  card.style.animation = 'fadeIn 0.3s ease';

  toast('âœ… ì¸í—ˆê°€ ' + idx + ' ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function removeLicenseCard(idx) {
  var card = document.getElementById('licCard_' + idx);
  if (!card) return;
  if (!confirm('ì¸í—ˆê°€ ' + idx + ' ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  card.remove();
  delete _licFiles[idx];
  toast('ğŸ—‘ï¸ ì¸í—ˆê°€ ' + idx + ' ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// í˜„ì¬ ì¡´ì¬í•˜ëŠ” ëª¨ë“  ì¸í—ˆê°€ ì¹´ë“œì˜ ì¸ë±ìŠ¤ ë°°ì—´ ë°˜í™˜
function getLicenseCardIndices() {
  var indices = [];
  for (var i = 1; i <= _licenseCardCount; i++) {
    if (document.getElementById('licCard_' + i)) {
      indices.push(i);
    }
  }
  return indices;
}

// --- OCR í”„ë¡ì‹œ SSL ì¸ì¦ì„œ ì‹ ë¢° í™•ì¸ ---
// ìì²´ì„œëª… ì¸ì¦ì„œì´ë¯€ë¡œ ìµœì´ˆ 1íšŒ ë¸Œë¼ìš°ì €ì—ì„œ ìˆ˜ë½ í•„ìš”
function handleOcrFetchError(err, statusEl, btnEl) {
  if (btnEl) { btnEl.textContent = 'ğŸ¤– OCR ì¸ì‹'; btnEl.disabled = false; }
  if (err.message === 'Failed to fetch') {
    // Mixed Content ë˜ëŠ” ìì²´ì„œëª… ì¸ì¦ì„œ ë¯¸ì‹ ë¢°
    var healthUrl = OCR_PROXY_BASE + '/api/ocr/health';
    if (statusEl) {
      statusEl.innerHTML = 'âŒ OCR ì„œë²„ ì—°ê²° ì‹¤íŒ¨. <a href="' + healthUrl + '" target="_blank" style="color:#1565c0;text-decoration:underline;">ì—¬ê¸°ë¥¼ í´ë¦­</a>í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìˆ˜ë½í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
      statusEl.style.color = '#c62828';
    }
    toast('âŒ OCR ì„œë²„ ì—°ê²° ì‹¤íŒ¨ â€” ì¸ì¦ì„œ ìˆ˜ë½ì´ í•„ìš”í•©ë‹ˆë‹¤');
    // ìë™ìœ¼ë¡œ ìƒˆ íƒ­ì—ì„œ ì¸ì¦ì„œ ìˆ˜ë½ í˜ì´ì§€ ì—´ê¸°
    window.open(healthUrl, '_blank');
  } else {
    if (statusEl) {
      statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + err.message;
      statusEl.style.color = '#c62828';
    }
    toast('âŒ OCR ì‹¤íŒ¨: ' + err.message);
  }
}

// --- ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼ ì„ íƒ ---
function handleBizLicFile(file) {
  if (!file) return;
  _bizLicFile = file;
  document.getElementById('bizLicFileName').textContent = 'ğŸ“„ ' + file.name + ' (' + (file.size/1024).toFixed(0) + 'KB)';
  document.getElementById('bizLicOcrBtn').disabled = false;
  // ë¯¸ë¦¬ë³´ê¸°
  if (file.type.startsWith('image/')) {
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('bizLicPreviewImg').src = e.target.result;
      document.getElementById('bizLicPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    document.getElementById('bizLicPreview').style.display = 'none';
  }
}

// --- ì‚¬ì—…ìë“±ë¡ì¦ OCR ì‹¤í–‰ ---
function runBizLicOCR() {
  if (!_bizLicFile) { toast('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  var btn = document.getElementById('bizLicOcrBtn');
  var status = document.getElementById('bizLicOcrStatus');
  btn.disabled = true;
  btn.textContent = 'â³ ì¸ì‹ ì¤‘...';
  status.style.display = 'block';
  status.textContent = 'ğŸ”„ Clova OCR ì„œë²„ì— ì „ì†¡ ì¤‘...';
  status.style.color = '#558b2f';

  // PDF â†’ ì´ë¯¸ì§€ ìë™ ë³€í™˜ í›„ OCR ì „ì†¡
  convertPdfToJpegBase64(_bizLicFile).then(function(result) {
    var payload = {
      version: 'V2',
      requestId: 'bfl-biz-' + Date.now(),
      timestamp: Date.now(),
      images: [{ format: result.format, name: _bizLicFile.name, data: result.base64 }]
    };

    fetch(OCR_BIZ_LICENSE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(function(data) {
      btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
      btn.disabled = false;
      if (data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result) {
        var res = data.images[0].bizLicense.result;
        fillBizLicFields(res);
        status.textContent = 'âœ… OCR ì¸ì‹ ì™„ë£Œ! í•„ë“œê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
        status.style.color = '#2e7d32';
        toast('âœ… ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¸ì‹ ì™„ë£Œ');
      } else {
        status.textContent = 'âš ï¸ OCR ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‘ë‹µ: ' + JSON.stringify(data).substring(0, 200);
        status.style.color = '#e65100';
      }
    })
    .catch(function(err) {
      handleOcrFetchError(err, status, btn);
    });
  }).catch(function(err) {
    btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
    btn.disabled = false;
    status.textContent = 'âŒ PDF ë³€í™˜ ì‹¤íŒ¨: ' + err.message;
    status.style.color = '#c62828';
  });
}

// --- ì‚¬ì—…ìë“±ë¡ì¦ OCR ê²°ê³¼ â†’ í¼ ìë™ì…ë ¥ ---
function fillBizLicFields(res) {
  function getText(arr) {
    if (!arr || !arr.length) return '';
    return arr.map(function(item) { return item.text || ''; }).join(' ').trim();
  }
  function getUniqueText(arr) {
    if (!arr || !arr.length) return '';
    var seen = {};
    var result = [];
    arr.forEach(function(item) {
      var t = (item.text || '').trim();
      if (t && !seen[t]) { seen[t] = true; result.push(t); }
    });
    return result.join(', ');
  }
  // íšŒì‚¬ëª… (ê°œì¸: companyName, ë²•ì¸: corpName)
  var companyName = getText(res.companyName) || getText(res.corpName);
  if (companyName) document.getElementById('regCompany').value = companyName;
  // ëŒ€í‘œìëª…
  var repName = getText(res.repName);
  if (repName) document.getElementById('regRepName').value = repName;
  // ì‚¬ì—…ìë²ˆí˜¸ (ê°œì¸: bisNo, ë²•ì¸: registerNumber)
  var bisNo = getText(res.bisNo) || getText(res.registerNumber);
  if (bisNo) {
    var el = document.getElementById('regBizNo');
    el.value = bisNo.replace(/\s/g, '');
    fmtBiz(el);
  }
  // ë²•ì¸ë²ˆí˜¸ (ê°œì¸: corpNo, ë²•ì¸: corpRegisterNum)
  var corpNo = getText(res.corpNo) || getText(res.corpRegisterNum);
  if (corpNo) document.getElementById('regCorpNo').value = corpNo.replace(/\s/g, '');
  // ì—…íƒœ (ì¤‘ë³µ ì œê±°)
  var bisType = getUniqueText(res.bisType);
  if (bisType) document.getElementById('regBizType').value = bisType;
  // ì¢…ëª© (ì¤‘ë³µ ì œê±°)
  var bisItem = getUniqueText(res.bisItem);
  if (bisItem) document.getElementById('regBizItem').value = bisItem;
  // ì£¼ì†Œ (bisAddress ë˜ëŠ” headAddress) + ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ
  var bisAddr = getText(res.bisAddress) || getText(res.headAddress);
  if (bisAddr) {
    document.getElementById('regAddr1').value = bisAddr;
    lookupZipcodeFromAddress(bisAddr);
  }
  // ë²•ì¸/ê°œì¸ íŒë‹¨
  if (corpNo) {
    document.getElementById('regCorpYes').checked = true;
  } else {
    document.getElementById('regCorpIndiv').checked = true;
  }
  // OCRë¡œ ì±„ì›Œì§„ í•„ë“œì— í•˜ì´ë¼ì´íŠ¸
  ['regCompany','regRepName','regBizNo','regCorpNo','regBizType','regBizItem','regAddr1'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el && el.value) {
      el.style.background = '#e8f5e9';
      el.style.borderColor = '#66bb6a';
      setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
    }
  });
  // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
  if (bisAddr) {
    setTimeout(function() { updateBizEngAddress(); }, 500);
  }
}

// --- ì¸í—ˆê°€ ë¬¸ì„œ íŒŒì¼ ì„ íƒ ---
function handleLicFile(idx, file) {
  if (!file) return;
  _licFiles[idx] = file;
  document.getElementById('licFileName_' + idx).textContent = 'ğŸ“„ ' + file.name + ' (' + (file.size/1024).toFixed(0) + 'KB)';
  document.getElementById('licOcrBtn_' + idx).disabled = false;
}

// --- ì¸í—ˆê°€ ë¬¸ì„œ OCR ì‹¤í–‰ (biz-license ì—”ë“œí¬ì¸íŠ¸ ê³µìš© â€” ì˜ì—…ì‹ ê³ ì¦ ë“±ë„ ì²˜ë¦¬ ê°€ëŠ¥) ---
function runLicOCR(idx) {
  var file = _licFiles[idx];
  if (!file) { toast('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  var btn = document.getElementById('licOcrBtn_' + idx);
  var status = document.getElementById('licOcrStatus_' + idx);
  btn.disabled = true;
  btn.textContent = 'â³ ì¸ì‹ ì¤‘...';
  status.style.display = 'block';
  status.textContent = 'ğŸ”„ Clova OCR ì„œë²„ì— ì „ì†¡ ì¤‘...';

  // PDF â†’ ì´ë¯¸ì§€ ìë™ ë³€í™˜ í›„ OCR ì „ì†¡
  convertPdfToJpegBase64(file).then(function(result) {
    var payload = {
      version: 'V2',
      requestId: 'bfl-lic-' + Date.now(),
      timestamp: Date.now(),
      images: [{ format: result.format, name: file.name, data: result.base64 }]
    };

    // biz-license ì—”ë“œí¬ì¸íŠ¸ë¥¼ ê³µìš©ìœ¼ë¡œ ì‚¬ìš© (ì˜ì—…ì‹ ê³ ì¦, ì‚¬ì—…ìë“±ë¡ì¦ ë“± ëª¨ë“  ë¬¸ì„œ ì²˜ë¦¬)
    fetch(OCR_BIZ_LICENSE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(function(data) {
      btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
      btn.disabled = false;
      if (data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result) {
        var res = data.images[0].bizLicense.result;
        fillLicFields(idx, res);
        var docType = (res.documentType && res.documentType.length) ? res.documentType[0].text : 'ë¬¸ì„œ';
        status.textContent = 'âœ… OCR ì¸ì‹ ì™„ë£Œ! (' + docType + ') í•„ë“œê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
        status.style.color = '#2e7d32';
        toast('âœ… ì¸í—ˆê°€ ë¬¸ì„œ OCR ì¸ì‹ ì™„ë£Œ (' + docType + ')');
      } else {
        status.textContent = 'âš ï¸ OCR ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        status.style.color = '#e65100';
      }
    })
    .catch(function(err) {
      handleOcrFetchError(err, status, btn);
    });
  }).catch(function(err) {
    btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
    btn.disabled = false;
    status.textContent = 'âŒ PDF ë³€í™˜ ì‹¤íŒ¨: ' + err.message;
    status.style.color = '#c62828';
  });
}

// --- ì¸í—ˆê°€ ë¬¸ì„œ OCR ê²°ê³¼ â†’ í¼ ìë™ì…ë ¥ (biz-license êµ¬ì¡°í™” ì‘ë‹µ) ---
// Clova Document OCRì€ ì˜ì—…ì‹ ê³ ì¦ ë“±ë„ ì‚¬ì—…ìë“±ë¡ì¦ ëª¨ë¸ë¡œ ì²˜ë¦¬ ê°€ëŠ¥.
// ì‘ë‹µ í•„ë“œ: companyName(ì˜ì—…ì†Œëª…), corpName(ë²•ì¸ëª…), registerNumber(ì¸í—ˆê°€ë²ˆí˜¸),
//           repName(ëŒ€í‘œì), bisAddress(ì†Œì¬ì§€), bisType(ì—…íƒœ), bisItem(ì¢…ëª©),
//           documentType(ë¬¸ì„œìœ í˜•: "ì˜ì—…ì‹ ê³ ì¦" ë“±)
function fillLicFields(idx, res) {
  // getText: biz-license ì‘ë‹µì˜ ë°°ì—´ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì‚¬ì—…ìë“±ë¡ì¦ OCRê³¼ ë™ì¼ êµ¬ì¡°)
  function getText(arr) {
    if (!arr || !arr.length) return '';
    return arr.map(function(item) { return item.text || ''; }).join(' ').trim();
  }
  function getUniqueText(arr) {
    if (!arr || !arr.length) return '';
    var seen = {};
    var result = [];
    arr.forEach(function(item) {
      var t = (item.text || '').trim();
      if (t && !seen[t]) { seen[t] = true; result.push(t); }
    });
    return result.join(', ');
  }

  // ì¸í—ˆê°€ë²ˆí˜¸: registerNumber (ì˜ˆ: "ì œ 2024-0109313í˜¸")
  var licNo = getText(res.registerNumber);
  if (licNo) document.getElementById('licNo_' + idx).value = licNo;

  // ëŒ€í‘œì
  var repName = getText(res.repName);
  if (repName) document.getElementById('licRepName_' + idx).value = repName;

  // ì˜ì—…ì†Œëª…ì¹­: companyName (ê°œì¸/ì˜ì—…ì†Œëª…), corpName ì€ ë²•ì¸ëª…
  var bizName = getText(res.companyName) || getText(res.corpName);
  if (bizName) document.getElementById('licBizName_' + idx).value = bizName;

  // ì†Œì¬ì§€ â†’ ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ (headAddressëŠ” ë²•ì¸ì£¼ì†Œì´ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
  var addr = getText(res.bisAddress);
  if (addr) {
    document.getElementById('licAddr_' + idx).value = addr;
    lookupLicZipcodeFromAddress(idx, addr);
  }

  // ì˜ì—…ì˜ í˜•íƒœ: bisType ë˜ëŠ” bisItem
  var bizForm = getUniqueText(res.bisType) || getUniqueText(res.bisItem);
  if (bizForm) {
    var sel = document.getElementById('licBizForm_' + idx);
    var matched = false;
    // íŠ¹ìˆ˜ë¬¸ì(Â·, ì¤‘ì , ê³µë°±) ì œê±° í›„ ë¹„êµ â€” OCRì€ "ì¦‰ì„íŒë§¤ì œì¡°Â·ê°€ê³µì—…", ì…€ë ‰íŠ¸ëŠ” "ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…"
    var normalize = function(s) { return s.replace(/[Â·\s\-Â·â€§ãƒ»]/g, ''); };
    var normBiz = normalize(bizForm);
    for (var j = 0; j < sel.options.length; j++) {
      var normOpt = normalize(sel.options[j].text);
      if (normOpt && (normOpt.includes(normBiz) || normBiz.includes(normOpt))) {
        sel.selectedIndex = j;
        matched = true;
        break;
      }
    }
    if (!matched) {
      var opt = document.createElement('option');
      opt.value = bizForm;
      opt.textContent = bizForm + ' (OCR)';
      opt.selected = true;
      sel.appendChild(opt);
    }
  }

  // ë¶„ì•¼ ìë™ ì„¤ì •: ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²• â†’ 'ì¶•ì‚°', ì‹í’ˆìœ„ìƒë²• â†’ 'ì‹í’ˆ'
  // ê·¼ê±°: ì‹í’ˆìœ„ìƒë²•=ì‹í’ˆ, ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²•=ì¶•ì‚°
  var allText = [bizForm, bizName, getText(res.documentType)].join(' ');
  var fieldSel = document.getElementById('licField_' + idx);
  if (fieldSel && fieldSel.value === 'ì„ íƒ') {
    var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
    for (var k = 0; k < fieldSel.options.length; k++) {
      if ((isLivestock && fieldSel.options[k].text === 'ì¶•ì‚°') ||
          (!isLivestock && fieldSel.options[k].text === 'ì‹í’ˆ')) {
        fieldSel.selectedIndex = k;
        break;
      }
    }
  }

  // í•˜ì´ë¼ì´íŠ¸
  ['licNo_','licRepName_','licBizName_','licAddr_','licZipcode_','licBizForm_','licField_'].forEach(function(prefix) {
    var el = document.getElementById(prefix + idx);
    if (el && (el.value || (el.tagName === 'SELECT' && el.selectedIndex > 0))) {
      el.style.background = '#e3f2fd';
      el.style.borderColor = '#42a5f5';
      setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
    }
  });
  // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
  if (addr) {
    setTimeout(function() { updateLicEngAddress(idx); }, 500);
  }
}

// ============================================================
// ì˜ë¬¸ ì •ë³´ ì ‘ì´ì‹ í† ê¸€
// ============================================================
function toggleEngSection(sectionId) {
  var sec = document.getElementById(sectionId);
  if (!sec) return;
  var isHidden = sec.style.display === 'none';
  sec.style.display = isHidden ? 'block' : 'none';
  // í™”ì‚´í‘œ íšŒì „
  var arrow = sec.previousElementSibling.querySelector('span');
  if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : '';
}

// ============================================================
// í•œê¸€ ì£¼ì†Œ â†’ ì˜ë¬¸ ì£¼ì†Œ ë³€í™˜ (Kakao ì£¼ì†Œ â†’ ì¢Œí‘œ â†’ ì˜ë¬¸ ì¡°í•©)
// ============================================================
var KR_EN_REGION = {
  'ì„œìš¸íŠ¹ë³„ì‹œ':'Seoul','ì„œìš¸':'Seoul','ë¶€ì‚°ê´‘ì—­ì‹œ':'Busan','ë¶€ì‚°':'Busan',
  'ëŒ€êµ¬ê´‘ì—­ì‹œ':'Daegu','ëŒ€êµ¬':'Daegu','ì¸ì²œê´‘ì—­ì‹œ':'Incheon','ì¸ì²œ':'Incheon',
  'ê´‘ì£¼ê´‘ì—­ì‹œ':'Gwangju','ê´‘ì£¼':'Gwangju','ëŒ€ì „ê´‘ì—­ì‹œ':'Daejeon','ëŒ€ì „':'Daejeon',
  'ìš¸ì‚°ê´‘ì—­ì‹œ':'Ulsan','ìš¸ì‚°':'Ulsan','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':'Sejong','ì„¸ì¢…':'Sejong',
  'ê²½ê¸°ë„':'Gyeonggi-do','ê²½ê¸°':'Gyeonggi-do','ê°•ì›íŠ¹ë³„ìì¹˜ë„':'Gangwon-do','ê°•ì›ë„':'Gangwon-do','ê°•ì›':'Gangwon-do',
  'ì¶©ì²­ë¶ë„':'Chungcheongbuk-do','ì¶©ë¶':'Chungcheongbuk-do',
  'ì¶©ì²­ë‚¨ë„':'Chungcheongnam-do','ì¶©ë‚¨':'Chungcheongnam-do',
  'ì „ë¶íŠ¹ë³„ìì¹˜ë„':'Jeollabuk-do','ì „ë¼ë¶ë„':'Jeollabuk-do','ì „ë¶':'Jeollabuk-do',
  'ì „ë¼ë‚¨ë„':'Jeollanam-do','ì „ë‚¨':'Jeollanam-do',
  'ê²½ìƒë¶ë„':'Gyeongsangbuk-do','ê²½ë¶':'Gyeongsangbuk-do',
  'ê²½ìƒë‚¨ë„':'Gyeongsangnam-do','ê²½ë‚¨':'Gyeongsangnam-do',
  'ì œì£¼íŠ¹ë³„ìì¹˜ë„':'Jeju-do','ì œì£¼ë„':'Jeju-do','ì œì£¼':'Jeju-do'
};

// í•œê¸€ â†’ ì˜ë¬¸ ë„ë¡œëª…ì£¼ì†Œ ë³€í™˜
function convertToEnglishAddress(korAddr, callback) {
  if (!korAddr) { callback(''); return; }
  var cleanAddr = korAddr.replace(/\([^)]*\)/g, '').trim();
  // Juso.go.kr ì˜ë¬¸ì£¼ì†Œ ê²€ìƒ‰ API (í–‰ì •ì•ˆì „ë¶€ ê³µì‹)
  var jusoKey = 'U01TX0FVVEgyMDI2MDIxOTE2MDczMDExNzYyNDM=';
  var jusoUrl = 'https://business.juso.go.kr/addrlink/addrEngApi.do?confmKey=' + encodeURIComponent(jusoKey)
    + '&currentPage=1&countPerPage=1&keyword=' + encodeURIComponent(cleanAddr) + '&resultType=json';

  fetch(jusoUrl)
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var res = data.results;
    if (res && res.juso && res.juso.length > 0) {
      // ê³µì‹ ì˜ë¬¸ ë„ë¡œëª…ì£¼ì†Œ ì‚¬ìš©
      callback(res.juso[0].roadAddr);
    } else {
      // ê²°ê³¼ ì—†ìŒ â†’ ìì²´ ë¡œë§ˆì ë³€í™˜ í´ë°±
      var fallbackParts = cleanAddr.split(/\s+/);
      var engParts = [];
      for (var fp = 0; fp < fallbackParts.length; fp++) {
        var w = fallbackParts[fp];
        engParts.push(KR_EN_REGION[w] || romanize(w));
      }
      callback(engParts.reverse().join(', '));
    }
  })
  .catch(function() {
    // API ì˜¤ë¥˜ ì‹œ ìì²´ ë¡œë§ˆì ë³€í™˜ í´ë°±
    var fallbackParts = cleanAddr.split(/\s+/);
    var engParts = [];
    for (var fp = 0; fp < fallbackParts.length; fp++) {
      var w = fallbackParts[fp];
      engParts.push(KR_EN_REGION[w] || romanize(w));
    }
    callback(engParts.reverse().join(', '));
  });
}

// ê°„ì´ í•œê¸€ â†’ ë¡œë§ˆì ë³€í™˜ (í–‰ì •êµ¬ì—­ ì ‘ë¯¸ì‚¬ í¬í•¨)
function romanize(str) {
  if (!str) return '';
  // í–‰ì •êµ¬ì—­ ì ‘ë¯¸ì‚¬ ë³€í™˜
  str = str.replace(/íŠ¹ë³„ìì¹˜ì‹œ$/, '').replace(/íŠ¹ë³„ìì¹˜ë„$/, '-do')
           .replace(/íŠ¹ë³„ì‹œ$/, '').replace(/ê´‘ì—­ì‹œ$/, '')
           .replace(/(\S)ì‹œ$/, '$1-si').replace(/(\S)êµ°$/, '$1-gun').replace(/(\S)êµ¬$/, '$1-gu')
           .replace(/(\S)ì$/, '$1-eup').replace(/(\S)ë©´$/, '$1-myeon').replace(/(\S)ë™$/, '$1-dong')
           .replace(/(\S)ë¡œ$/, '$1-ro').replace(/(\S)ê¸¸$/, '$1-gil')
           .replace(/(\S)ë¦¬$/, '$1-ri').replace(/(\S)ê°€$/, '$1-ga');
  // ì´ˆì„±+ì¤‘ì„±+ì¢…ì„± â†’ ë¡œë§ˆì (Revised Romanization)
  var initials = ['g','kk','n','d','tt','r','m','b','pp','s','ss','','j','jj','ch','k','t','p','h'];
  var medials = ['a','ae','ya','yae','eo','e','yeo','ye','o','wa','wae','oe','yo','u','wo','we','wi','yu','eu','ui','i'];
  var finals = ['','g','kk','gs','n','nj','nh','d','l','lg','lm','lb','ls','lt','lp','lh','m','b','bs','s','ss','ng','j','ch','k','t','p','h'];
  // ì¢…ì„±ì´ ë‹¤ìŒ ì´ˆì„± ì•ì—ì„œ ë³€í•˜ëŠ” ê·œì¹™ (Revised Romanization í‘œê¸°ë²•)
  // ì¢…ì„± index â†’ ììŒ ì• í‘œê¸° (0=ì—†ìŒì€ ë¬´ì‹œ)
  var finBeforeConsonant = ['','k','kk','k','n','n','n','t','l','l','l','l','l','l','l','l','m','p','p','t','t','ng','t','t','k','t','p','t'];
  // ìŒì ˆ ë¶„í•´
  var syllables = [];
  for (var i = 0; i < str.length; i++) {
    var code = str.charCodeAt(i);
    if (code >= 0xAC00 && code <= 0xD7A3) {
      var offset = code - 0xAC00;
      syllables.push({
        ini: Math.floor(offset / (21 * 28)),
        med: Math.floor((offset % (21 * 28)) / 28),
        fin: offset % 28,
        isKor: true
      });
    } else {
      syllables.push({ ch: str.charAt(i), isKor: false });
    }
  }
  var result = '';
  for (var i = 0; i < syllables.length; i++) {
    var s = syllables[i];
    if (!s.isKor) { result += s.ch; continue; }
    result += initials[s.ini] + medials[s.med];
    if (s.fin === 0) continue; // ì¢…ì„± ì—†ìŒ
    // ë‹¤ìŒ ê¸€ìê°€ í•œê¸€ì´ë©´ ì¢…ì„± ê·œì¹™ ì ìš©
    var next = (i + 1 < syllables.length) ? syllables[i + 1] : null;
    if (next && next.isKor) {
      if (next.ini === 11) {
        // ë‹¤ìŒ ì´ˆì„±ì´ ã…‡(11) â†’ ì¢…ì„±ì´ ë‹¤ìŒ ìŒì ˆ ì´ˆì„±ìœ¼ë¡œ ì—°ìŒ
        result += finals[s.fin];
      } else {
        // ë‹¤ìŒ ì´ˆì„±ì´ ììŒ â†’ ì¢…ì„± ëŒ€í‘œìŒ
        result += finBeforeConsonant[s.fin];
      }
    } else {
      // ë‹¨ì–´ ëì´ê±°ë‚˜ ë¹„í•œê¸€ â†’ ëŒ€í‘œìŒ
      result += finBeforeConsonant[s.fin];
    }
  }
  // ì²« ê¸€ì ëŒ€ë¬¸ì
  return result.charAt(0).toUpperCase() + result.slice(1);
}

// ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜ íŠ¸ë¦¬ê±° (ì‚¬ì—…ìë“±ë¡ì¦)
function updateBizEngAddress() {
  var addr1 = document.getElementById('regAddr1');
  var addr2 = document.getElementById('regAddr2');
  var enField = document.getElementById('regAddrEn');
  if (!addr1 || !enField) return;
  var fullAddr = (addr1.value || '').trim();
  if (addr2 && addr2.value) fullAddr += ' ' + addr2.value.trim();
  if (!fullAddr) return;
  convertToEnglishAddress(fullAddr, function(engAddr) {
    enField.value = engAddr;
    enField.style.background = '#e3f2fd';
    setTimeout(function() { enField.style.background = ''; }, 3000);
  });
}

// ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜ íŠ¸ë¦¬ê±° (ì¸í—ˆê°€)
function updateLicEngAddress(idx) {
  var addr1 = document.getElementById('licAddr_' + idx);
  var addr2 = document.getElementById('licAddr2_' + idx);
  var enField = document.getElementById('licAddrEn_' + idx);
  if (!addr1 || !enField) return;
  var fullAddr = (addr1.value || '').trim();
  if (addr2 && addr2.value) fullAddr += ' ' + addr2.value.trim();
  if (!fullAddr) return;
  convertToEnglishAddress(fullAddr, function(engAddr) {
    enField.value = engAddr;
    enField.style.background = '#e3f2fd';
    setTimeout(function() { enField.style.background = ''; }, 3000);
  });
}

function fmtBiz(el) {
  let v = el.value.replace(/[^0-9]/g,'');
  if(v.length>10)v=v.slice(0,10);
  if(v.length>5)v=v.slice(0,3)+'-'+v.slice(3,5)+'-'+v.slice(5);
  else if(v.length>3)v=v.slice(0,3)+'-'+v.slice(3);
  el.value=v;
}
function fmtPhone(el) {
  var v = el.value.replace(/[^0-9]/g, '');
  if (v.length > 11) v = v.slice(0, 11);
  if (v.startsWith('02')) {
    if (v.length > 6 && v.length <= 9) v = v.slice(0, 2) + '-' + v.slice(2, 5) + '-' + v.slice(5);
    else if (v.length > 9) v = v.slice(0, 2) + '-' + v.slice(2, 6) + '-' + v.slice(6);
    else if (v.length > 2) v = v.slice(0, 2) + '-' + v.slice(2);
  } else {
    if (v.length === 10) v = v.slice(0, 3) + '-' + v.slice(3, 6) + '-' + v.slice(6);
    else if (v.length > 7) v = v.slice(0, 3) + '-' + v.slice(3, 7) + '-' + v.slice(7);
    else if (v.length > 3) v = v.slice(0, 3) + '-' + v.slice(3);
  }
  el.value = v;
}
function demoCompanyDup() {
  const name = document.getElementById('regCompany').value.trim();
  if(!name){alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(name.includes('í’€ë¬´ì›')){document.getElementById('companyDup').classList.add('show');}
  else{const el=document.getElementById('compChk');el.style.display='block';el.className='check-result check-ok';el.textContent='âœ… ì¤‘ë³µ ì—†ìŒ â€” ë“±ë¡ ê°€ëŠ¥';}
}
function demoContactDup() {
  const name = document.getElementById('regCName').value.trim();
  if(!name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(name==='ì´ê·œì„±'){document.getElementById('contactDup').classList.add('show');}
  else{const el=document.getElementById('cntChk');el.style.display='inline-block';el.className='check-result check-ok';el.textContent='âœ… ì¤‘ë³µ ì—†ìŒ';}
}
// â”€â”€ ì—…ë¬´ì¼ì§€ í•¨ìˆ˜ â”€â”€
function dailyCompanyChange(sel) {
  const newInput = document.getElementById('dailyCompanyNew');
  if (sel.value === '_new') {
    newInput.style.display = 'block';
    newInput.focus();
  } else {
    newInput.style.display = 'none';
  }
}
function dailySampleChange(sel) {
  const notice = document.getElementById('dailyVehicleNotice');
  if (sel.value === 'visit') {
    notice.style.display = 'block';
  } else {
    notice.style.display = 'none';
  }
}
function fmtMoney(el) {
  let v = el.value.replace(/[^0-9]/g, '');
  if (v) {
    el.value = Number(v).toLocaleString('ko-KR');
  }
}
function dailySave() {
  const company = document.getElementById('dailyCompany').value;
  const sample = document.getElementById('dailySample').value;
  if (!company || company === 'ì—…ì²´ ì„ íƒ...') { toast('âš ï¸ ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if (!sample) { toast('âš ï¸ ì‹œë£Œìˆ˜ê±° ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  toast('âœ… ì—…ë¬´ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  if (sample === 'visit') {
    setTimeout(() => toast('ğŸš— ì°¨ëŸ‰ì¼ì§€ì— ìë™ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.'), 1500);
  }
  setTimeout(() => showPage('daily'), 2500);
}

// â”€â”€ ì°¨ëŸ‰ì¼ì§€ ê²½ë¡œ ê³„ì‚° â”€â”€
var wpCount = 0;
function calcRoutePreview() {
  const startType = document.getElementById('vStartType').value;
  const endType = document.getElementById('vEndType').value;
  const distEl = document.getElementById('vDistPreview');
  const labelEl = document.getElementById('vDistLabel');
  // ë°ëª¨: ì¶œë°œ/ë„ì°© ì¡°í•©ì— ë”°ë¼ ë‹¤ë¥¸ ì˜ˆìƒ ê±°ë¦¬
  const demoDistMap = {
    'office-office': 42,
    'home-office': 38,
    'office-home': 45,
    'home-home': 52
  };
  const key = startType + '-' + endType;
  const dist = demoDistMap[key] || 42;
  distEl.value = dist;
  labelEl.textContent = 'API ìë™ê³„ì‚°';
  labelEl.style.background = '#bbdefb';
  labelEl.style.color = '#1565c0';
  toast('ğŸ“ ê²½ë¡œ ì¬ê³„ì‚°: ' + (startType==='office'?'íšŒì‚¬':'ìíƒ') + ' â†’ ë°©ë¬¸ì§€ â†’ ' + (endType==='office'?'íšŒì‚¬':'ìíƒ') + ' = ' + dist + 'km');
}
// km ìˆ˜ë™ ì¡°ì • ê°ì§€
document.addEventListener('input', function(e) {
  if (e.target && e.target.id === 'vDistPreview') {
    const labelEl = document.getElementById('vDistLabel');
    labelEl.textContent = 'ìˆ˜ë™ ì¡°ì •';
    labelEl.style.background = '#fff3e0';
    labelEl.style.color = '#e65100';
  }
});
function addWaypoint() {
  wpCount++;
  const area = document.getElementById('vWaypointArea');
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:8px;align-items:center;margin-top:8px';
  div.innerHTML = '<span style="font-size:11px;color:#1565c0;flex-shrink:0">ê²½ìœ ì§€ ' + wpCount + '</span>' +
    '<select style="flex:1;padding:7px 10px;border:1px solid #90caf9;border-radius:6px;font-size:12px;background:#fff">' +
    '<option>ì—…ì²´ ì„ íƒ...</option><option>CJì œì¼ì œë‹¹(ì£¼) â€” ì„œìš¸ ì¤‘êµ¬</option><option>(ì£¼)ë†ì‹¬ â€” ì„œìš¸ ë™ì‘êµ¬</option><option>ë™ì›F&B(ì£¼) â€” ì„œìš¸ ì„œì´ˆêµ¬</option><option>í’€ë¬´ì›ì‹í’ˆ(ì£¼) â€” ì„œìš¸ ê°•ë‚¨êµ¬</option>' +
    '</select>' +
    '<button onclick="this.parentElement.remove();calcRoutePreview()" style="background:none;border:1px solid #ef9a9a;color:#e53935;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px">âœ•</button>';
  area.appendChild(div);
  toast('+ ê²½ìœ ì§€ ' + wpCount + ' ì¶”ê°€ë¨ (ì—¬ëŸ¬ ì—…ì²´ ë°©ë¬¸ ì‹œ)');
}

// â”€â”€ ì—…ì²´ì¡°íšŒ (ì§€ë„ ë“œë¦´ë‹¤ìš´ + ì¹´ì¹´ì˜¤ + ì‹ì•½ì²˜) â”€â”€
const KAKAO_REST_KEY = '8e5dab09aacd882449bd3865699a9d69';
const COMPANY_ORIGIN = {x:'127.0741', y:'37.2004'};
var bizMap2 = null, bizMarkers2 = [];
var bizState = {sido:'', sigungu:'', dong:''};

var regionData = {
  'ì„œìš¸':['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
  'ë¶€ì‚°':['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬','í•´ìš´ëŒ€êµ¬'],
  'ëŒ€êµ¬':['ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬'],
  'ì¸ì²œ':['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¯¸ì¶”í™€êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì˜¹ì§„êµ°','ì¤‘êµ¬'],
  'ê´‘ì£¼':['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],
  'ëŒ€ì „':['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],
  'ìš¸ì‚°':['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°','ì¤‘êµ¬'],
  'ì„¸ì¢…':['ì„¸ì¢…ì‹œ'],
  'ê²½ê¸°':['ê°€í‰êµ°','ê³ ì–‘ì‹œ','ê³¼ì²œì‹œ','ê´‘ëª…ì‹œ','ê´‘ì£¼ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ê¹€í¬ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ë™ë‘ì²œì‹œ','ë¶€ì²œì‹œ','ì„±ë‚¨ì‹œ','ìˆ˜ì›ì‹œ','ì‹œí¥ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì„±ì‹œ','ì•ˆì–‘ì‹œ','ì–‘ì£¼ì‹œ','ì–‘í‰êµ°','ì—¬ì£¼ì‹œ','ì—°ì²œêµ°','ì˜¤ì‚°ì‹œ','ìš©ì¸ì‹œ','ì˜ì™•ì‹œ','ì˜ì •ë¶€ì‹œ','ì´ì²œì‹œ','íŒŒì£¼ì‹œ','í‰íƒì‹œ','í¬ì²œì‹œ','í•˜ë‚¨ì‹œ','í™”ì„±ì‹œ'],
  'ê°•ì›':['ê°•ë¦‰ì‹œ','ê³ ì„±êµ°','ë™í•´ì‹œ','ì‚¼ì²™ì‹œ','ì†ì´ˆì‹œ','ì–‘êµ¬êµ°','ì–‘ì–‘êµ°','ì˜ì›”êµ°','ì›ì£¼ì‹œ','ì¸ì œêµ°','ì •ì„ êµ°','ì² ì›êµ°','ì¶˜ì²œì‹œ','íƒœë°±ì‹œ','í‰ì°½êµ°','í™ì²œêµ°','í™”ì²œêµ°','íš¡ì„±êµ°'],
  'ì¶©ë¶':['ê´´ì‚°êµ°','ë‹¨ì–‘êµ°','ë³´ì€êµ°','ì˜ë™êµ°','ì˜¥ì²œêµ°','ìŒì„±êµ°','ì œì²œì‹œ','ì¦í‰êµ°','ì§„ì²œêµ°','ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ'],
  'ì¶©ë‚¨':['ê³„ë£¡ì‹œ','ê³µì£¼ì‹œ','ê¸ˆì‚°êµ°','ë…¼ì‚°ì‹œ','ë‹¹ì§„ì‹œ','ë³´ë ¹ì‹œ','ë¶€ì—¬êµ°','ì„œì‚°ì‹œ','ì„œì²œêµ°','ì•„ì‚°ì‹œ','ì˜ˆì‚°êµ°','ì²œì•ˆì‹œ','ì²­ì–‘êµ°','íƒœì•ˆêµ°','í™ì„±êµ°'],
  'ì „ë¶':['ê³ ì°½êµ°','êµ°ì‚°ì‹œ','ê¹€ì œì‹œ','ë‚¨ì›ì‹œ','ë¬´ì£¼êµ°','ë¶€ì•ˆêµ°','ìˆœì°½êµ°','ì™„ì£¼êµ°','ìµì‚°ì‹œ','ì„ì‹¤êµ°','ì¥ìˆ˜êµ°','ì „ì£¼ì‹œ','ì •ìì‹œ','ì§„ì•ˆêµ°'],
  'ì „ë‚¨':['ê°•ì§„êµ°','ê³ í¥êµ°','ê³¡ì„±êµ°','ê´‘ì–‘ì‹œ','êµ¬ë¡€êµ°','ë‚˜ì£¼ì‹œ','ë‹´ì–‘êµ°','ëª©í¬ì‹œ','ë¬´ì•ˆêµ°','ë³´ì„±êµ°','ìˆœì²œì‹œ','ì‹ ì•ˆêµ°','ì—¬ìˆ˜ì‹œ','ì˜ê´‘êµ°','ì˜ì•”êµ°','ì™„ë„êµ°','ì¥ì„±êµ°','ì¥í¥êµ°','ì§„ë„êµ°','í•¨í‰êµ°','í•´ë‚¨êµ°','í™”ìˆœêµ°'],
  'ê²½ë¶':['ê²½ì‚°ì‹œ','ê²½ì£¼ì‹œ','ê³ ë ¹êµ°','êµ¬ë¯¸ì‹œ','êµ°ìœ„êµ°','ê¹€ì²œì‹œ','ë¬¸ê²½ì‹œ','ë´‰í™”êµ°','ìƒì£¼ì‹œ','ì„±ì£¼êµ°','ì•ˆë™ì‹œ','ì˜ë•êµ°','ì˜ì–‘êµ°','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','ì˜ˆì²œêµ°','ìš¸ë¦‰êµ°','ìš¸ì§„êµ°','ì˜ì„±êµ°','ì²­ë„êµ°','ì²­ì†¡êµ°','ì¹ ê³¡êµ°','í¬í•­ì‹œ'],
  'ê²½ë‚¨':['ê±°ì œì‹œ','ê±°ì°½êµ°','ê³ ì„±êµ°','ê¹€í•´ì‹œ','ë‚¨í•´êµ°','ë°€ì–‘ì‹œ','ì‚¬ì²œì‹œ','ì‚°ì²­êµ°','ì–‘ì‚°ì‹œ','ì˜ë ¹êµ°','ì§„ì£¼ì‹œ','ì°½ë…•êµ°','ì°½ì›ì‹œ','í†µì˜ì‹œ','í•˜ë™êµ°','í•¨ì•ˆêµ°','í•¨ì–‘êµ°','í•©ì²œêµ°'],
  'ì œì£¼':['ì„œê·€í¬ì‹œ','ì œì£¼ì‹œ']
};

// â”€â”€ Leaflet ì§€ë„ (VWORLD/OSM + ì‹œë„/ì‹œêµ°êµ¬ GeoJSON) â”€â”€
var sidoMap = null, sidoGeoLayer = null, sgGeoData = null, dongGeoData = null;
var SIDO_GEO_URL = 'data/sido.json';
var SG_GEO_URL = 'data/sigungu.json';
var DONG_GEO_URL = 'data/dong.json';
var SIDO_NAME_MAP = {
  'ì„œìš¸íŠ¹ë³„ì‹œ':'ì„œìš¸','ë¶€ì‚°ê´‘ì—­ì‹œ':'ë¶€ì‚°','ëŒ€êµ¬ê´‘ì—­ì‹œ':'ëŒ€êµ¬','ì¸ì²œê´‘ì—­ì‹œ':'ì¸ì²œ',
  'ê´‘ì£¼ê´‘ì—­ì‹œ':'ê´‘ì£¼','ëŒ€ì „ê´‘ì—­ì‹œ':'ëŒ€ì „','ìš¸ì‚°ê´‘ì—­ì‹œ':'ìš¸ì‚°','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':'ì„¸ì¢…',
  'ê²½ê¸°ë„':'ê²½ê¸°','ê°•ì›ë„':'ê°•ì›','ì¶©ì²­ë¶ë„':'ì¶©ë¶','ì¶©ì²­ë‚¨ë„':'ì¶©ë‚¨',
  'ì „ë¼ë¶ë„':'ì „ë¶','ì „ë¼ë‚¨ë„':'ì „ë‚¨','ê²½ìƒë¶ë„':'ê²½ë¶','ê²½ìƒë‚¨ë„':'ê²½ë‚¨','ì œì£¼íŠ¹ë³„ìì¹˜ë„':'ì œì£¼'
};
var SIDO_COLORS = ['#1a73e8','#e53935','#43a047','#fb8c00','#8e24aa','#00897b','#f4511e','#6d4c41',
  '#3949ab','#c0ca33','#00acc1','#d81b60','#5e35b1','#039be5','#7cb342','#ff6f00','#546e7a'];

// â”€â”€ ì‹ì•½ì²˜ ì „ì²´ ë°ì´í„° (ì •ì  JSON) â”€â”€
var fssAllData = null;
var fssLoading = false;
var SIDO_ADDR = {'ì„œìš¸':'ì„œìš¸','ë¶€ì‚°':'ë¶€ì‚°','ëŒ€êµ¬':'ëŒ€êµ¬','ì¸ì²œ':'ì¸ì²œ','ê´‘ì£¼':'ê´‘ì£¼','ëŒ€ì „':'ëŒ€ì „','ìš¸ì‚°':'ìš¸ì‚°','ì„¸ì¢…':'ì„¸ì¢…',
  'ê²½ê¸°':'ê²½ê¸°ë„','ê°•ì›':'ê°•ì›ë„','ì¶©ë¶':'ì¶©ì²­ë¶ë„','ì¶©ë‚¨':'ì¶©ì²­ë‚¨ë„','ì „ë¶':'ì „ë¼ë¶ë„','ì „ë‚¨':'ì „ë¼ë‚¨ë„','ê²½ë¶':'ê²½ìƒë¶ë„','ê²½ë‚¨':'ê²½ìƒë‚¨ë„','ì œì£¼':'ì œì£¼'};

function loadFssData() {
  if(fssAllData || fssLoading) return;
  fssLoading = true;

  // Firestore ì¤€ë¹„ ëŒ€ê¸°
  if (typeof isFirebaseReady === 'function' && !isFirebaseReady()) {
    window.addEventListener('firebase-ready', function() { fssLoading = false; loadFssData(); }, { once: true });
    console.log('[FSS] Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...');
    return;
  }

  // Firestore fss_businesses ì»¬ë ‰ì…˜ì—ì„œ ë¡œë“œ
  db.collection('fss_businesses').get().then(function(snap) {
    fssAllData = [];
    snap.forEach(function(doc) {
      var d = doc.data();
      fssAllData.push({
        nm: d.bssh_nm || '',
        addr: d.locp_addr || '',
        ceo: d.prsdnt_nm || '',
        biz: d.induty_nm || '',
        lic: d.lcns_no || '',
        tel: d.telno || '',
        org: d.instt_nm || '',
        sido: d.addr_sido || '',
        sigungu: d.addr_sigungu || '',
        dong: d.addr_dong || ''
      });
    });
    fssLoading = false;
    console.log('[FSS] Firestoreì—ì„œ ' + fssAllData.length + 'ê±´ ë¡œë“œ');
    toast('ğŸ“Š ì‹ì•½ì²˜ ' + fssAllData.length.toLocaleString() + 'ê±´ ë¡œë“œ ì™„ë£Œ (Firestore)');
    updateSidoLabels();
  }).catch(function(e) {
    fssLoading = false;
    console.error('[FSS] Firestore ë¡œë“œ ì‹¤íŒ¨:', e);
    toast('âš ï¸ ì‹ì•½ì²˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
  });
}

function fssFilterSido(sido) {
  if(!fssAllData) return [];
  var key = SIDO_ADDR[sido] || sido;
  return fssAllData.filter(function(r) {
    if (r.sido) {
      // ì •í™• ë§¤ì¹­ ìš°ì„ , ë¶€ë¶„ ë§¤ì¹­ í´ë°± (ì„œìš¸â†”ì„œìš¸íŠ¹ë³„ì‹œ, ê°•ì›ë„â†”ê°•ì›íŠ¹ë³„ìì¹˜ë„ ë“±)
      return r.sido === key || r.sido === sido ||
             r.sido.indexOf(sido) >= 0 || (key !== sido && r.sido.indexOf(key) >= 0);
    }
    return r.addr && r.addr.indexOf(key) >= 0;
  });
}
function fssFilterSg(sido, sg) {
  var list = fssFilterSido(sido);
  var sgClean = sg.replace(/ì‹œ$|êµ°$|êµ¬$/,'');
  return list.filter(function(r) {
    if (r.sigungu) return r.sigungu.indexOf(sg) >= 0 || sg.indexOf(r.sigungu) >= 0;
    return r.addr.indexOf(sg) >= 0 || r.addr.indexOf(sgClean) >= 0;
  });
}
function fssFilterDong(sido, sg, dong) {
  var list = fssFilterSg(sido, sg);
  // í–‰ì •ë™(ì—­ì‚¼1ë™) â†’ ë²•ì •ë™(ì—­ì‚¼ë™) ë³€í™˜
  var dongBase = dong.replace(/\d+ë™$/, 'ë™');
  // ìˆ«ì ì—†ëŠ” ê¸°ë³¸ëª… (ì—­ì‚¼1ë™ â†’ ì—­ì‚¼)
  var dongCore = dong.replace(/\d*ë™$/, '');
  return list.filter(function(r) {
    if (r.dong) {
      return r.dong.indexOf(dong) >= 0 || dong.indexOf(r.dong) >= 0 ||
             r.dong.indexOf(dongBase) >= 0 || dongBase.indexOf(r.dong) >= 0;
    }
    // ì£¼ì†Œ ë¬¸ìì—´ì—ì„œ ë§¤ì¹­: ì—­ì‚¼1ë™, ì—­ì‚¼ë™, ì—­ì‚¼ ìˆœìœ¼ë¡œ ì‹œë„
    return r.addr.indexOf(dong) >= 0 || r.addr.indexOf(dongBase) >= 0 ||
           (dongCore.length >= 2 && r.addr.indexOf(dongCore + 'ë™') >= 0);
  });
}

function updateSidoLabels() {
  if(!fssAllData || !sidoGeoLayer) return;
  sidoGeoLayer.eachLayer(function(layer){
    var fullName = layer.feature.properties.name || '';
    var shortName = SIDO_NAME_MAP[fullName] || fullName;
    var cnt = fssFilterSido(shortName).length;
    layer.unbindTooltip();
    layer.bindTooltip(shortName + '<br><b style="color:#e53935">' + cnt.toLocaleString() + '</b>', {permanent:true, direction:'center', className:'sido-label'});
  });
}

function initSidoMap() {
  if(sidoMap) { sidoMap.invalidateSize(); if(fssAllData) updateSidoLabels(); return; }
  var el = document.getElementById('koreaMap');
  if(!el || el.offsetHeight === 0) return;
  sidoMap = L.map('koreaMap', {zoomControl:true, attributionControl:false}).setView([36.0, 127.8], 7);
  // íƒ€ì¼ ë ˆì´ì–´
  applyMapTile();
  // ì‹ì•½ì²˜ ì „ì²´ ë°ì´í„° ë¡œë“œ
  loadFssData();
  // ì‹œë„ ê²½ê³„ GeoJSON ë¡œë“œ
  fetch(SIDO_GEO_URL).then(function(r){return r.json()}).then(function(geo){
    sidoGeoLayer = L.geoJSON(geo, {
      style: function(feature){
        var idx = geo.features.indexOf(feature) % SIDO_COLORS.length;
        return {color:'#fff', weight:2, fillColor:SIDO_COLORS[idx], fillOpacity:0.45};
      },
      onEachFeature: function(feature, layer){
        var fullName = feature.properties.name || '';
        var shortName = SIDO_NAME_MAP[fullName] || fullName;
        layer.bindTooltip(shortName, {permanent:true, direction:'center', className:'sido-label'});
        layer.on('mouseover', function(e){ e.target.setStyle({fillOpacity:0.75, weight:3}); });
        layer.on('mouseout', function(e){ sidoGeoLayer.resetStyle(e.target); });
        layer.on('click', function(){ selectSido(shortName); });
      }
    }).addTo(sidoMap);
    sidoMap.fitBounds(sidoGeoLayer.getBounds(), {padding:[10,10]});
  }).catch(function(e){ console.error('ì‹œë„ GeoJSON ë¡œë“œ ì‹¤íŒ¨:', e); });
  // ì‹œêµ°êµ¬ GeoJSON í”„ë¦¬ë¡œë“œ
  fetch(SG_GEO_URL).then(function(r){return r.json()}).then(function(geo){ sgGeoData = geo; });
  // ìë©´ë™ GeoJSON í”„ë¦¬ë¡œë“œ
  fetch(DONG_GEO_URL).then(function(r){return r.json()}).then(function(geo){ dongGeoData = geo; });
}

function applyMapTile() {
  if(!sidoMap) return;
  sidoMap.eachLayer(function(l){ if(l instanceof L.TileLayer) sidoMap.removeLayer(l); });
  var vkey = document.getElementById('vworldApiKey') ? document.getElementById('vworldApiKey').value.trim() : '';
  if(vkey) {
    L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+vkey+'/Base/{z}/{y}/{x}.png', {maxZoom:19, minZoom:5}).addTo(sidoMap);
  } else {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, minZoom:5}).addTo(sidoMap);
  }
  if(sidoGeoLayer) sidoGeoLayer.bringToFront();
}

var sgMap = null, sgGeoLayer = null;
var SG_COLORS = ['#42a5f5','#66bb6a','#ffa726','#ef5350','#ab47bc','#26c6da','#8d6e63','#78909c',
  '#5c6bc0','#d4e157','#ec407a','#29b6f6','#9ccc65','#ffca28','#7e57c2','#26a69a'];
var SIDO_CODE_MAP = {
  'ì„œìš¸':'11','ë¶€ì‚°':'21','ëŒ€êµ¬':'22','ì¸ì²œ':'23','ê´‘ì£¼':'24','ëŒ€ì „':'25','ìš¸ì‚°':'26','ì„¸ì¢…':'29',
  'ê²½ê¸°':'31','ê°•ì›':'32','ì¶©ë¶':'33','ì¶©ë‚¨':'34','ì „ë¶':'35','ì „ë‚¨':'36','ê²½ë¶':'37','ê²½ë‚¨':'38','ì œì£¼':'39'
};

function selectSido(sido) {
  bizState = {sido:sido, sigungu:'', dong:''};
  var list = regionData[sido] || [];
  var html = '';
  list.forEach(function(g){
    html += '<div class="sg-btn" onclick="selectSigungu(\'' + g + '\')">' + g + '</div>';
  });
  document.getElementById('sigunguGrid').innerHTML = html;
  document.getElementById('step1Title').textContent = 'ğŸ™ï¸ ' + sido + ' > ì‹œ/êµ°/êµ¬ ì„ íƒ';
  document.getElementById('bizStep0').style.display = 'none';
  document.getElementById('bizStep1').style.display = 'block';
  document.getElementById('bizStep2').style.display = 'none';
  document.getElementById('bizStep3').style.display = 'none';
  updateBreadcrumb();
  toast('ğŸ“ ' + sido + ' ì„ íƒ');
  // ì‹œêµ°êµ¬ ì§€ë„ ìƒì„±/ì—…ë°ì´íŠ¸
  setTimeout(function(){ initSgMap(sido); }, 100);
}

function initSgMap(sido) {
  var el = document.getElementById('sgMap');
  if(!el) return;
  if(sgMap) { sgMap.remove(); sgMap = null; }
  sgMap = L.map('sgMap', {zoomControl:true, attributionControl:false}).setView([36.0, 127.8], 9);
  // íƒ€ì¼
  var vkey = document.getElementById('vworldApiKey') ? document.getElementById('vworldApiKey').value.trim() : '';
  if(vkey) {
    L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+vkey+'/Base/{z}/{y}/{x}.png', {maxZoom:19}).addTo(sgMap);
  } else {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(sgMap);
  }
  // ì‹œêµ°êµ¬ ê²½ê³„
  var sidoCode = SIDO_CODE_MAP[sido] || '';
  if(!sgGeoData || !sidoCode) return;
  var filtered = {
    type: 'FeatureCollection',
    features: sgGeoData.features.filter(function(f){ return f.properties.code.substring(0,2) === sidoCode; })
  };
  sgGeoLayer = L.geoJSON(filtered, {
    style: function(feature){
      var idx = filtered.features.indexOf(feature) % SG_COLORS.length;
      return {color:'#fff', weight:2, fillColor:SG_COLORS[idx], fillOpacity:0.45};
    },
    onEachFeature: function(feature, layer){
      var name = feature.properties.name || '';
      var cnt = fssAllData ? fssFilterSg(sido, name).length : 0;
      var label = name + (cnt ? '<br><b style="color:#e53935;font-size:9px">' + cnt.toLocaleString() + '</b>' : '');
      layer.bindTooltip(label, {permanent:true, direction:'center', className:'sg-label'});
      layer.on('mouseover', function(e){ e.target.setStyle({fillOpacity:0.75, weight:3}); });
      layer.on('mouseout', function(e){ sgGeoLayer.resetStyle(e.target); });
      layer.on('click', function(){
        var matched = matchSigungu(sido, name);
        if(matched) selectSigungu(matched);
      });
    }
  }).addTo(sgMap);
  if(filtered.features.length > 0) sgMap.fitBounds(sgGeoLayer.getBounds(), {padding:[15,15]});
}

function matchSigungu(sido, geoName) {
  var list = regionData[sido] || [];
  // 1) ì •í™• ë§¤ì¹­
  for(var i=0; i<list.length; i++) {
    if(geoName === list[i]) return list[i];
  }
  // 2) GeoJSONì´ ë” ê¸´ ê²½ìš° (ìˆ˜ì›ì‹œì¥ì•ˆêµ¬ â†’ ìˆ˜ì›ì‹œ)
  for(var i=0; i<list.length; i++) {
    if(geoName.indexOf(list[i]) === 0) return list[i];
  }
  // 3) regionDataê°€ ë” ê¸´ ê²½ìš° (ì—­: ê±°ì˜ ì—†ìŒ)
  for(var i=0; i<list.length; i++) {
    if(list[i].indexOf(geoName) === 0) return list[i];
  }
  return geoName;
}

var dongMap = null, dongGeoLayer = null;
var DONG_COLORS = ['#4fc3f7','#81c784','#ffb74d','#e57373','#ba68c8','#4dd0e1','#a1887f','#90a4ae',
  '#7986cb','#dce775','#f06292','#4db6ac','#aed581','#ffd54f','#9575cd','#64b5f6'];

function selectSigungu(sg) {
  bizState.sigungu = sg;
  bizState.dong = '';
  document.getElementById('step2Title').textContent = 'ğŸ˜ï¸ ' + bizState.sido + ' ' + sg + ' > ì/ë©´/ë™ ì„ íƒ';
  document.getElementById('bizStep1').style.display = 'none';
  document.getElementById('bizStep2').style.display = 'block';
  document.getElementById('dongGrid').style.display = 'none';
  document.getElementById('dongLoading').style.display = 'block';
  updateBreadcrumb();
  // ìë©´ë™ ì§€ë„ + ëª©ë¡ ë¡œë“œ
  setTimeout(function(){ initDongMap(bizState.sido, sg); }, 100);
}

function findSgCode(sido, sgName) {
  if(!sgGeoData) return '';
  var sidoCode = SIDO_CODE_MAP[sido] || '';
  // 1) ì •í™• ë§¤ì¹­ ìš°ì„ 
  var exact = [];
  // 2) ë³µí•©ë„ì‹œ ë§¤ì¹­ (ìˆ˜ì›ì‹œ â†’ ìˆ˜ì›ì‹œì¥ì•ˆêµ¬, ìˆ˜ì›ì‹œê¶Œì„ êµ¬)
  var composite = [];
  for(var i = 0; i < sgGeoData.features.length; i++) {
    var f = sgGeoData.features[i];
    var code = f.properties.code;
    if(code.substring(0,2) !== sidoCode) continue;
    var name = f.properties.name;
    if(name === sgName) {
      exact.push(code);
    } else if(name.indexOf(sgName) === 0) {
      // "ìˆ˜ì›ì‹œì¥ì•ˆêµ¬".indexOf("ìˆ˜ì›ì‹œ") === 0 â†’ ë³µí•©ë„ì‹œ
      composite.push(code);
    }
  }
  var matched = exact.length > 0 ? exact : composite;
  if(matched.length === 0) return sidoCode;
  if(matched.length === 1) return matched[0];
  // ë³µí•©ë„ì‹œ: ê³µí†µ prefix ê³„ì‚° (ìˆ˜ì›ì‹œ 31011,31012,31013,31014 â†’ "3101")
  var prefix = matched[0];
  for(var j = 1; j < matched.length; j++) {
    while(matched[j].substring(0, prefix.length) !== prefix && prefix.length > 2) {
      prefix = prefix.substring(0, prefix.length - 1);
    }
  }
  return prefix;
}

function initDongMap(sido, sg) {
  var el = document.getElementById('dongMap');
  if(!el) return;
  if(dongMap) { dongMap.remove(); dongMap = null; }
  dongMap = L.map('dongMap', {zoomControl:true, attributionControl:false}).setView([36.0, 127.8], 11);
  // íƒ€ì¼
  var vkey = document.getElementById('vworldApiKey') ? document.getElementById('vworldApiKey').value.trim() : '';
  if(vkey) {
    L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/'+vkey+'/Base/{z}/{y}/{x}.png', {maxZoom:19}).addTo(dongMap);
  } else {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(dongMap);
  }

  // ì‹œêµ°êµ¬ ì½”ë“œ ì°¾ê¸°
  var sgCode = findSgCode(sido, sg);
  var dongButtons = [];

  if(dongGeoData && sgCode.length >= 4) {
    // ì‹œêµ°êµ¬ì— í•˜ìœ„êµ¬ê°€ ìˆëŠ” ê²½ìš° (ì˜ˆ: ìˆ˜ì›ì‹œâ†’ì¥ì•ˆêµ¬,ê¶Œì„ êµ¬...) sgCode 5ìë¦¬ ì• 4ìë¦¬ë¡œ í•„í„°
    // ì¼ë°˜ ì‹œêµ°êµ¬ëŠ” 5ìë¦¬ ì „ì²´ë¡œ í•„í„°
    var prefix = sgCode;
    var filtered = {
      type: 'FeatureCollection',
      features: dongGeoData.features.filter(function(f){ return f.properties.code.substring(0, prefix.length) === prefix; })
    };
    // í•˜ìœ„êµ¬ í¬í•¨ ë§¤ì¹­ì´ ì•ˆ ë˜ë©´ ì• 3~4ìë¦¬ë¡œ ì¬ì‹œë„
    if(filtered.features.length === 0 && sgCode.length >= 3) {
      prefix = sgCode.substring(0, 4);
      filtered.features = dongGeoData.features.filter(function(f){ return f.properties.code.substring(0, 4) === prefix; });
    }
    if(filtered.features.length === 0 && sgCode.length >= 2) {
      prefix = sgCode.substring(0, 3);
      filtered.features = dongGeoData.features.filter(function(f){ return f.properties.code.substring(0, 3) === prefix; });
    }

    if(filtered.features.length > 0) {
      dongGeoLayer = L.geoJSON(filtered, {
        style: function(feature){
          var idx = filtered.features.indexOf(feature) % DONG_COLORS.length;
          return {color:'#fff', weight:1.5, fillColor:DONG_COLORS[idx], fillOpacity:0.4};
        },
        onEachFeature: function(feature, layer){
          var name = feature.properties.name || '';
          var cnt = fssAllData ? fssFilterDong(sido, sg, name).length : 0;
          var label = name + (cnt ? '<br><b style="color:#e53935;font-size:9px">' + cnt.toLocaleString() + '</b>' : '');
          layer.bindTooltip(label, {permanent:true, direction:'center', className:'sg-label'});
          layer.on('mouseover', function(e){ e.target.setStyle({fillOpacity:0.7, weight:2.5}); });
          layer.on('mouseout', function(e){ dongGeoLayer.resetStyle(e.target); });
          layer.on('click', function(){
            selectDong(name);
          });
        }
      }).addTo(dongMap);
      dongMap.fitBounds(dongGeoLayer.getBounds(), {padding:[15,15]});

      // GeoJSONì—ì„œ ë™ ëª©ë¡ ìƒì„±
      filtered.features.forEach(function(f){ dongButtons.push(f.properties.name); });
    }
  }

  // ë™ ë²„íŠ¼ ëª©ë¡ ë Œë”ë§
  if(dongButtons.length > 0) {
    dongButtons.sort();
    var html = '';
    dongButtons.forEach(function(d){
      html += '<div class="dong-btn" onclick="selectDong(\'' + d + '\')">' + d + '</div>';
    });
    document.getElementById('dongGrid').innerHTML = html;
  } else {
    // GeoJSONì— ì—†ìœ¼ë©´ ì¹´ì¹´ì˜¤ API í´ë°±
    loadDongList(sido, sg);
    return;
  }
  document.getElementById('dongGrid').style.display = 'flex';
  document.getElementById('dongLoading').style.display = 'none';
}

async function loadDongList(sido, sigungu) {
  try {
    var res = await fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(sido + ' ' + sigungu) + '&size=30', {
      headers: {'Authorization': 'KakaoAK ' + KAKAO_REST_KEY}
    });
    var data = await res.json();
    var dongs = new Set();
    (data.documents||[]).forEach(function(d){
      var a = d.address || d.road_address;
      if(a){
        var r3 = a.region_3depth_name || a.region_3depth_h_name || '';
        if(r3) dongs.add(r3.split(' ')[0]);
      }
    });
    var dongArr = Array.from(dongs).sort();
    if(dongArr.length === 0){
      document.getElementById('dongGrid').innerHTML = '<div style="text-align:center;width:100%;padding:16px;color:#8892a4;font-size:12px">ì/ë©´/ë™ ìë™ ë¡œë“œ ë¶ˆê°€ â€” ì‹œ/êµ°/êµ¬ ì „ì²´ ê²€ìƒ‰ì„ ì´ìš©í•˜ì„¸ìš”.</div>';
    } else {
      var html = '';
      dongArr.forEach(function(d){
        html += '<div class="dong-btn" onclick="selectDong(\'' + d + '\')">' + d + '</div>';
      });
      document.getElementById('dongGrid').innerHTML = html;
    }
    document.getElementById('dongGrid').style.display = 'flex';
    document.getElementById('dongLoading').style.display = 'none';
  } catch(e) {
    document.getElementById('dongGrid').innerHTML = '<div style="text-align:center;width:100%;padding:16px;color:#e53935">ë¡œë“œ ì‹¤íŒ¨</div>';
    document.getElementById('dongGrid').style.display = 'flex';
    document.getElementById('dongLoading').style.display = 'none';
  }
}

function selectDong(dong) {
  bizState.dong = dong;
  updateBreadcrumb();
  // ì‹ì•½ì²˜ ë°ì´í„° í•„í„°ë§
  var rows = fssAllData ? fssFilterDong(bizState.sido, bizState.sigungu, dong) : [];
  showFssResults(rows);
}

function showFssResults(rows) {
  document.getElementById('bizStep0').style.display = 'none';
  document.getElementById('bizStep1').style.display = 'none';
  document.getElementById('bizStep2').style.display = 'none';
  document.getElementById('bizStep3').style.display = 'block';
  document.getElementById('bizFssCount').textContent = rows.length;
  if(rows.length === 0) {
    document.getElementById('fssTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#8892a4;font-size:12px">í•´ë‹¹ ì§€ì—­ì— ë“±ë¡ëœ ì‹í’ˆì œì¡°ê°€ê³µì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    return;
  }
  var html = '';
  rows.forEach(function(r, i){
    var nm = r.nm || '-';
    var ceo = r.ceo || '-';
    var biz = r.biz || '-';
    var lic = r.lic || '-';
    var addr = r.addr || '-';
    var org = r.org || '';
    var tel = r.tel || '';
    html += '<tr>';
    html += '<td style="font-size:12px"><b>' + nm + '</b>' + (tel ? '<br><span style="font-size:10px;color:#8892a4">ğŸ“ ' + tel + '</span>' : '') + '</td>';
    html += '<td style="font-size:12px">' + ceo + '</td>';
    html += '<td><span style="font-size:11px">' + biz + '</span></td>';
    html += '<td style="font-size:10px;font-family:monospace">' + lic + '</td>';
    html += '<td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + addr + '">' + addr + '</td>';
    html += '<td><span style="font-size:11px;color:#1565c0">' + org + '</span></td>';
    html += '<td><button style="font-size:10px;padding:3px 10px;background:#1565c0;color:#fff;border:none;border-radius:4px;cursor:pointer" onclick="bizDetail(\'' + lic.replace(/'/g,"\\'") + '\',\'' + nm.replace(/'/g,"\\'") + '\')">ğŸ” ì¡°íšŒ</button></td>';
    html += '</tr>';
  });
  document.getElementById('fssTableBody').innerHTML = html;
  toast('ğŸ­ ì‹ì•½ì²˜ ' + rows.length + 'ê±´ ì¡°íšŒ');
}

function bizGoStep(n) {
  document.getElementById('bizStep0').style.display = n===0 ? 'block' : 'none';
  document.getElementById('bizStep1').style.display = n===1 ? 'block' : 'none';
  document.getElementById('bizStep2').style.display = n===2 ? 'block' : 'none';
  document.getElementById('bizStep3').style.display = 'none';
  if(n===0) { bizState = {sido:'', sigungu:'', dong:''}; setTimeout(function(){ if(sidoMap) sidoMap.invalidateSize(); }, 150); }
  if(n===1) { bizState.sigungu=''; bizState.dong=''; setTimeout(function(){ if(sgMap) sgMap.invalidateSize(); }, 150); }
  if(n===2) { bizState.dong=''; setTimeout(function(){ if(dongMap) dongMap.invalidateSize(); }, 150); }
  updateBreadcrumb();
}

function updateBreadcrumb() {
  var html = '<span style="color:#1a73e8;font-weight:600;cursor:pointer" onclick="bizGoStep(0)">ì „êµ­</span>';
  if(bizState.sido) html += ' <span style="color:#c8d6e5">â€º</span> <span style="color:#1a73e8;cursor:pointer" onclick="bizGoStep(1)">' + bizState.sido + '</span>';
  if(bizState.sigungu) html += ' <span style="color:#c8d6e5">â€º</span> <span style="color:#1a73e8;cursor:pointer" onclick="bizGoStep(2)">' + bizState.sigungu + '</span>';
  if(bizState.dong) html += ' <span style="color:#c8d6e5">â€º</span> <b style="color:#1a2332">' + bizState.dong + '</b>';
  document.getElementById('bizBreadcrumb').innerHTML = html;
}

function switchResTab(n) {
  document.getElementById('resPanel1').style.display = n===1 ? 'block' : 'none';
  document.getElementById('resPanel2').style.display = n===2 ? 'block' : 'none';
  ['resTab1','resTab2'].forEach(function(id,i){
    var el = document.getElementById(id);
    var active = (i+1)===n;
    el.style.background = active ? '#1a73e8' : '#fff';
    el.style.color = active ? '#fff' : '#5f6b7a';
    el.style.borderColor = active ? '#1a73e8' : '#e2e6ed';
  });
}

var lastKakaoNames = []; // ì¹´ì¹´ì˜¤ ê²€ìƒ‰ ê²°ê³¼ ì—…ì²´ëª… ì €ì¥

async function doRegionSearch() {
  var region = bizState.sido;
  if(bizState.sigungu) region += ' ' + bizState.sigungu;
  if(bizState.dong) region += ' ' + bizState.dong;
  if(!region) { toast('ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  document.getElementById('bizStep0').style.display = 'none';
  document.getElementById('bizStep1').style.display = 'none';
  document.getElementById('bizStep2').style.display = 'none';
  document.getElementById('bizStep3').style.display = 'block';
  document.getElementById('bizResultList').innerHTML = '<div style="text-align:center;padding:30px;color:#8892a4">â³ í•´ë‹¹ ì§€ì—­ ì „ì²´ ì—…ì²´ ê²€ìƒ‰ ì¤‘...</div>';
  document.getElementById('fssTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#8892a4">â³ ì‹ì•½ì²˜ ì¡°íšŒ ì¤‘...</td></tr>';
  document.getElementById('bizKakaoCount').textContent = '...';
  document.getElementById('bizFssCount').textContent = '...';
  // 1. ì¹´ì¹´ì˜¤ë§µ ì˜ì—­ ê¸°ë°˜ ê²€ìƒ‰ (ë‹¤ì¤‘ í‚¤ì›Œë“œ + í˜ì´ì§€ë„¤ì´ì…˜)
  await searchKakaoArea(region);
  // 2. ì¹´ì¹´ì˜¤ ê²°ê³¼ì˜ ì—…ì²´ëª…ìœ¼ë¡œ ì‹ì•½ì²˜ ê²€ìƒ‰
  await searchFss(region);
  initResultMap(region);
}

async function doBizQuickSearch() {
  var q = document.getElementById('bizQuickSearch').value.trim();
  if(!q) { toast('ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  bizState = {sido:'ê²€ìƒ‰', sigungu:q, dong:''};
  updateBreadcrumb();
  document.getElementById('bizStep0').style.display = 'none';
  document.getElementById('bizStep1').style.display = 'none';
  document.getElementById('bizStep2').style.display = 'none';
  document.getElementById('bizStep3').style.display = 'block';
  document.getElementById('bizResultList').innerHTML = '<div style="text-align:center;padding:30px;color:#8892a4">â³ ê²€ìƒ‰ ì¤‘...</div>';
  document.getElementById('fssTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#8892a4">â³ ì¡°íšŒ ì¤‘...</td></tr>';
  document.getElementById('bizKakaoCount').textContent = '...';
  document.getElementById('bizFssCount').textContent = '...';
  await searchKakao(q);
  await searchFss(q);
  initResultMap(q);
}

async function searchKakao(query) {
  lastKakaoNames = [];
  try {
    var res = await fetch('https://dapi.kakao.com/v2/local/search/keyword.json?query=' + encodeURIComponent(query) + '&size=15', {
      headers: {'Authorization': 'KakaoAK ' + KAKAO_REST_KEY}
    });
    var data = await res.json();
    var docs = data.documents || [];
    document.getElementById('bizKakaoCount').textContent = docs.length;
    // ì—…ì²´ëª… ì €ì¥ (ì‹ì•½ì²˜ ê²€ìƒ‰ìš©)
    docs.forEach(function(d){ lastKakaoNames.push(d.place_name); });
    if(docs.length === 0) {
      document.getElementById('bizResultList').innerHTML = '<div style="text-align:center;padding:30px;color:#8892a4">ì¹´ì¹´ì˜¤ë§µ ê²°ê³¼ ì—†ìŒ</div>';
      return;
    }
    bizMarkers2.forEach(function(m){ m.setMap(null); });
    bizMarkers2 = [];
    var bounds = bizMap2 ? new kakao.maps.LatLngBounds() : null;
    var html = '';
    docs.forEach(function(d, i) {
      var addr = d.road_address_name || d.address_name || '-';
      var phone = d.phone || '-';
      var cat = d.category_name || '';
      if(bizMap2){
        var pos = new kakao.maps.LatLng(parseFloat(d.y), parseFloat(d.x));
        var marker = new kakao.maps.Marker({position:pos, map:bizMap2});
        bizMarkers2.push(marker);
        bounds.extend(pos);
      }
      html += '<div style="padding:12px 20px;border-bottom:1px solid #eef0f4;display:flex;gap:12px" onmouseover="this.style.background=\'#f8f9fb\'" onmouseout="this.style.background=\'transparent\'">';
      html += '<div style="width:28px;height:28px;background:#e3f2fd;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#1565c0;flex-shrink:0">' + (i+1) + '</div>';
      html += '<div style="flex:1;min-width:0">';
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px"><b style="font-size:13px;color:#1a2332">' + d.place_name + '</b>';
      if(cat) html += '<span style="font-size:9px;background:#f1f3f5;padding:1px 5px;border-radius:3px;color:#8892a4">' + cat.split(' > ').pop() + '</span>';
      html += '</div>';
      html += '<div style="font-size:11px;color:#5f6b7a">ğŸ“ ' + addr + '  Â·  ğŸ“ ' + phone + '</div>';
      html += '<div style="display:flex;gap:5px;margin-top:5px">';
      html += '<span id="kD' + i + '" style="font-size:10px;color:#1565c0;background:#e3f2fd;padding:2px 7px;border-radius:4px;cursor:pointer" onclick="calcDist(\'' + d.x + '\',\'' + d.y + '\',\'kD' + i + '\')">ğŸ“ ê±°ë¦¬</span>';
      if(d.place_url) html += '<a href="' + d.place_url + '" target="_blank" style="font-size:10px;color:#e65100;background:#fff3e0;padding:2px 7px;border-radius:4px;text-decoration:none">ğŸ—ºï¸</a>';
      html += '<button style="font-size:10px;padding:2px 8px;background:#2e7d32;color:#fff;border:none;border-radius:4px;cursor:pointer" onclick="bizReg(\'' + d.place_name.replace(/'/g,"\\'") + '\',\'' + addr.replace(/'/g,"\\'") + '\')">+ ë“±ë¡</button>';
      html += '</div></div></div>';
    });
    document.getElementById('bizResultList').innerHTML = html;
    if(bizMap2 && bounds) bizMap2.setBounds(bounds);
  } catch(e) {
    document.getElementById('bizResultList').innerHTML = '<div style="text-align:center;padding:30px;color:#e53935">âŒ ' + e.message + '</div>';
    document.getElementById('bizKakaoCount').textContent = '0';
  }
}

async function searchFss(region) {
  var apiKey = document.getElementById('fssApiKey').value.trim();
  if(!apiKey) {
    document.getElementById('fssTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#e65100">ğŸ”‘ ì‹ì•½ì²˜ API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ì¸í—ˆê°€ ì •ë³´ë„ ì¡°íšŒë©ë‹ˆë‹¤</td></tr>';
    document.getElementById('bizFssCount').textContent = '-';
    return;
  }
  var baseUrl = 'https://openapi.foodsafetykorea.go.kr/api/' + apiKey + '/I1220/json/1/100';
  var allRows = [];
  var searchNames = [];

  if(bizState.sido === 'ê²€ìƒ‰' && bizState.sigungu) {
    // ë¹ ë¥¸ê²€ìƒ‰: ì…ë ¥í•œ í‚¤ì›Œë“œë¡œ ì§ì ‘ ê²€ìƒ‰
    searchNames = [bizState.sigungu];
  } else {
    // ì§€ì—­ ë“œë¦´ë‹¤ìš´: ì¹´ì¹´ì˜¤ë§µ ê²°ê³¼ ì—…ì²´ëª…ìœ¼ë¡œ ê²€ìƒ‰ (ìµœëŒ€ 10ê°œ)
    if(lastKakaoNames.length === 0) {
      document.getElementById('fssTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#8892a4;font-size:12px">ì¹´ì¹´ì˜¤ë§µ ê²°ê³¼ê°€ ì—†ì–´ ì‹ì•½ì²˜ ì¡°íšŒë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.</td></tr>';
      document.getElementById('bizFssCount').textContent = '0';
      return;
    }
    // ì—…ì²´ëª…ì—ì„œ í•µì‹¬ ë‹¨ì–´ ì¶”ì¶œ (ê´„í˜¸/ë²•ì¸ ë“± ì œê±°)
    var uniqueNames = [];
    lastKakaoNames.forEach(function(n) {
      var clean = n.replace(/\(ì£¼\)|\(ìœ \)|ì£¼ì‹íšŒì‚¬|ë†ì—…íšŒì‚¬ë²•ì¸|ìœ í•œíšŒì‚¬/g, '').trim();
      if(clean && uniqueNames.indexOf(clean) === -1) uniqueNames.push(clean);
    });
    searchNames = uniqueNames.slice(0, 10);
  }

  // ê° ì—…ì²´ëª…ìœ¼ë¡œ ì‹ì•½ì²˜ ê²€ìƒ‰
  for(var i = 0; i < searchNames.length; i++) {
    try {
      var apiUrl = baseUrl + '/BSSH_NM=' + encodeURIComponent(searchNames[i]);
      var text = '';
      // CORS í”„ë¡ì‹œ
      try {
        var res = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(apiUrl));
        text = await res.text();
      } catch(e1) {
        try { var res2 = await fetch(apiUrl); text = await res2.text(); } catch(e2){ text = ''; }
      }
      if(!text || !text.startsWith('{')) continue;
      var data = JSON.parse(text);
      var key = Object.keys(data)[0];
      var rows = (data[key] && data[key].row) ? data[key].row : [];
      rows.forEach(function(r){ r._t = 'food'; });
      // ì¤‘ë³µ ì œê±° (ì¸í—ˆê°€ë²ˆí˜¸ ê¸°ì¤€)
      rows.forEach(function(r) {
        var dup = allRows.some(function(ar){ return ar.LCNS_NO === r.LCNS_NO; });
        if(!dup) allRows.push(r);
      });
    } catch(e){ console.log('FSS error:', searchNames[i], e.message); }
  }

  // ì§€ì—­ ë“œë¦´ë‹¤ìš´ì¸ ê²½ìš°: ê²€ìƒ‰ ì§€ì—­ ì£¼ì†Œë¡œ í•„í„°ë§
  if(bizState.sido !== 'ê²€ìƒ‰' && allRows.length > 0) {
    var SIDO_FULL = {'ì„œìš¸':'ì„œìš¸','ë¶€ì‚°':'ë¶€ì‚°','ëŒ€êµ¬':'ëŒ€êµ¬','ì¸ì²œ':'ì¸ì²œ','ê´‘ì£¼':'ê´‘ì£¼','ëŒ€ì „':'ëŒ€ì „','ìš¸ì‚°':'ìš¸ì‚°','ì„¸ì¢…':'ì„¸ì¢…',
      'ê²½ê¸°':'ê²½ê¸°ë„','ê°•ì›':'ê°•ì›ë„','ì¶©ë¶':'ì¶©ì²­ë¶ë„','ì¶©ë‚¨':'ì¶©ì²­ë‚¨ë„','ì „ë¶':'ì „ë¼ë¶ë„','ì „ë‚¨':'ì „ë¼ë‚¨ë„','ê²½ë¶':'ê²½ìƒë¶ë„','ê²½ë‚¨':'ê²½ìƒë‚¨ë„','ì œì£¼':'ì œì£¼'};
    var sidoKey = SIDO_FULL[bizState.sido] || bizState.sido;
    var sgKey = bizState.sigungu || '';
    allRows = allRows.filter(function(r) {
      var addr = (r.LOCP_ADDR || '').replace(/\s+/g, ' ');
      // ì‹œë„ ë§¤ì¹­
      if(addr.indexOf(sidoKey) < 0 && addr.indexOf(bizState.sido) < 0) return false;
      // ì‹œêµ°êµ¬ ë§¤ì¹­ (ìˆìœ¼ë©´)
      if(sgKey && addr.indexOf(sgKey) < 0) {
        // "íŒŒì£¼ì‹œ" â†’ "íŒŒì£¼" ë¡œë„ ë§¤ì¹­ ì‹œë„
        var sgShort = sgKey.replace(/ì‹œ$|êµ°$|êµ¬$/,'');
        if(addr.indexOf(sgShort) < 0) return false;
      }
      return true;
    });
  }

  document.getElementById('bizFssCount').textContent = allRows.length;
  if(allRows.length === 0) {
    document.getElementById('fssTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#8892a4;font-size:12px">ì¸í—ˆê°€ ê²°ê³¼ ì—†ìŒ<br><span style="font-size:11px">CORS ì°¨ë‹¨ìœ¼ë¡œ ì¡°íšŒ ë¶ˆê°€ ì‹œ, ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í™•ì¸:<br><a href="https://openapi.foodsafetykorea.go.kr/api/' + apiKey + '/I1220/json/1/5/BSSH_NM=' + encodeURIComponent(bizState.sigungu||bizState.sido||'') + '" target="_blank" style="color:#1565c0">ğŸ”— ì‹ì•½ì²˜ API ì§ì ‘ ì—´ê¸°</a></span></td></tr>';
    return;
  }
  var html = '';
  allRows.forEach(function(r, i){
    var nm = r.BSSH_NM || '-';
    var ceo = r.PRSDNT_NM || '-';
    var biz = r.INDUTY_NM || '-';
    var lic = r.LCNS_NO || '-';
    var addr = r.LOCP_ADDR || '-';
    var org = r.INSTT_NM || '';
    var tel = r.TELNO || '';
    html += '<tr>';
    html += '<td><b>' + nm + '</b>' + (tel ? '<br><span style="font-size:10px;color:#8892a4">ğŸ“ ' + tel + '</span>' : '') + '</td>';
    html += '<td>' + ceo + '</td>';
    html += '<td><span style="font-size:11px">' + biz + '</span></td>';
    html += '<td style="font-size:10px;font-family:monospace">' + lic + '</td>';
    html += '<td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + addr + '">' + addr + '</td>';
    html += '<td><span style="font-size:11px;color:#1565c0">' + org + '</span></td>';
    html += '<td><span id="fD' + i + '" style="font-size:10px;color:#1565c0;background:#e3f2fd;padding:2px 6px;border-radius:4px;cursor:pointer" onclick="calcAddrDist(\'' + addr.replace(/'/g,"\\'") + '\',\'fD' + i + '\')">ğŸ“</span></td>';
    html += '<td><button style="font-size:10px;padding:2px 8px;background:#1565c0;color:#fff;border:none;border-radius:4px;cursor:pointer" onclick="bizDetail(\'' + lic.replace(/'/g,"\\'") + '\',\'' + nm.replace(/'/g,"\\'") + '\')">ğŸ” ì¡°íšŒ</button></td>';
    html += '</tr>';
  });
  document.getElementById('fssTableBody').innerHTML = html;
  toast('ğŸ­ ì‹ì•½ì²˜ ' + allRows.length + 'ê±´ ì¡°íšŒ');
}

function initResultMap(query) {
  try {
    var el = document.getElementById('bizResultMap');
    if(!bizMap2) bizMap2 = new kakao.maps.Map(el, {center:new kakao.maps.LatLng(36.5,127.5), level:13});
    fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(query.replace(' ì‹í’ˆ','')) + '&size=1', {
      headers:{'Authorization':'KakaoAK ' + KAKAO_REST_KEY}
    }).then(function(r){return r.json()}).then(function(data){
      if(data.documents && data.documents[0]){
        bizMap2.setCenter(new kakao.maps.LatLng(parseFloat(data.documents[0].y), parseFloat(data.documents[0].x)));
        bizMap2.setLevel(7);
      }
    });
  } catch(e){ document.getElementById('bizResultMap').innerHTML = '<div style="padding:40px;text-align:center;color:#8892a4">ì§€ë„ í‘œì‹œ ë¶ˆê°€</div>'; }
}

async function calcDist(x, y, elId) {
  var el = document.getElementById(elId); el.innerHTML = 'â³';
  try {
    var res = await fetch('https://apis-navi.kakaomobility.com/v1/directions?origin='+COMPANY_ORIGIN.x+','+COMPANY_ORIGIN.y+'&destination='+x+','+y, {
      headers:{'Authorization':'KakaoAK '+KAKAO_REST_KEY}
    });
    var d = await res.json(), r = d.routes[0];
    if(r.result_code===0){
      el.innerHTML = 'ğŸš— '+(r.summary.distance/1000).toFixed(0)+'km Â· '+Math.round(r.summary.duration/60)+'ë¶„';
      el.style.background='#e8f5e9'; el.style.color='#2e7d32';
    } else { el.innerHTML='ê²½ë¡œì—†ìŒ'; }
  } catch(e){ el.innerHTML='âŒ'; }
}

async function calcAddrDist(addr, elId) {
  var el = document.getElementById(elId); el.innerHTML = 'â³';
  try {
    var g = await fetch('https://dapi.kakao.com/v2/local/search/address.json?query='+encodeURIComponent(addr),{headers:{'Authorization':'KakaoAK '+KAKAO_REST_KEY}});
    var gd = await g.json();
    if(gd.documents && gd.documents[0]) calcDist(gd.documents[0].x, gd.documents[0].y, elId);
    else el.innerHTML='-';
  } catch(e){ el.innerHTML='âŒ'; }
}

function bizReg(name, addr) {
  showPage('customerReg');
  var c = document.getElementById('regCompany');
  if(c) c.value = name;
  toast('ğŸ“‹ "'+name+'" â†’ ê³ ê°ì‚¬ ë“±ë¡');
}

// â”€â”€ ì—…ì²´ ìƒì„¸ ì¡°íšŒ (í’ˆëª© + ë³€ê²½ì´ë ¥) â”€â”€
async function bizDetail(licNo, bizName) {
  // ëª¨ë‹¬ ì—´ê¸°
  var modal = document.getElementById('bizDetailModal');
  modal.style.display = 'flex';
  document.getElementById('bdmBizName').textContent = bizName || '-';
  document.getElementById('bdmLicNo').textContent = licNo || '-';
  // íƒ­ ì´ˆê¸°í™” (í’ˆëª© íƒ­ í™œì„±)
  bizDetailTab('products');
  // ë¡œë”© í‘œì‹œ
  document.getElementById('bdmProductsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#8892a4"><div class="spinner" style="display:inline-block;width:20px;height:20px;border:2px solid #e2e6ed;border-top:2px solid #1565c0;border-radius:50%;animation:spin .8s linear infinite"></div><br>í’ˆëª© ì¡°íšŒ ì¤‘...</td></tr>';
  document.getElementById('bdmChangesBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#8892a4">ë³€ê²½ì´ë ¥ ì¡°íšŒ ëŒ€ê¸° ì¤‘...</td></tr>';
  document.getElementById('bdmProductCount').textContent = '-';
  document.getElementById('bdmChangeCount').textContent = '-';

  // 1) fss_products ì¡°íšŒ
  try {
    var prodSnap = await db.collection('fss_products').where('lcns_no','==',licNo).get();
    var products = [];
    prodSnap.forEach(function(doc){ products.push(doc.data()); });
    document.getElementById('bdmProductCount').textContent = products.length;

    if(products.length === 0) {
      document.getElementById('bdmProductsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#e65100;font-size:12px">ğŸ“‹ í’ˆëª© ë°ì´í„° ìˆ˜ì§‘ì˜ˆì •<br><span style="font-size:11px;color:#8892a4">ìµœê·¼ ë“±ë¡ ì—…ì²´ëŠ” í’ˆëª© ë°ì´í„°ê°€ ì•„ì§ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></td></tr>';
    } else {
      // ë³´ê³ ì¼ì ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      products.sort(function(a,b){ return (b.prms_dt||'').localeCompare(a.prms_dt||''); });
      var html = '';
      products.forEach(function(p, i){
        var prodEnd = (p.production === 'Y' || p.production === 'ì¢…ë£Œ') ? '<span style="color:#e53935;font-size:10px">ì¢…ë£Œ</span>' : '<span style="color:#2e7d32;font-size:10px">ìƒì‚°ì¤‘</span>';
        html += '<tr>';
        html += '<td style="font-size:12px"><b>' + (p.prdlst_nm||'-') + '</b></td>';
        html += '<td style="font-size:11px">' + (p.prdlst_dcnm||'-') + '</td>';
        html += '<td style="font-size:11px;font-family:monospace">' + formatDate8(p.prms_dt) + '</td>';
        html += '<td style="text-align:center">' + prodEnd + '</td>';
        html += '<td style="font-size:10px;color:#5f6b7a;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + (p.pog_daycnt||'') + ' / ' + (p.cstdy_mthd||'') + '">' + (p.pog_daycnt||'-') + '</td>';
        html += '</tr>';
      });
      document.getElementById('bdmProductsBody').innerHTML = html;
    }
    console.log('[bizDetail] fss_products:', products.length, 'ê±´ ì¡°íšŒ (lcns_no=' + licNo + ')');
  } catch(e) {
    console.error('[bizDetail] fss_products ì¡°íšŒ ì‹¤íŒ¨:', e);
    document.getElementById('bdmProductsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#e53935">âŒ í’ˆëª© ì¡°íšŒ ì‹¤íŒ¨: ' + e.message + '</td></tr>';
    document.getElementById('bdmProductCount').textContent = '0';
  }

  // 2) fss_changes ì¡°íšŒ
  try {
    var chgSnap = await db.collection('fss_changes').where('lcns_no','==',licNo).get();
    var changes = [];
    chgSnap.forEach(function(doc){ changes.push(doc.data()); });
    document.getElementById('bdmChangeCount').textContent = changes.length;

    if(changes.length === 0) {
      document.getElementById('bdmChangesBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:#e65100;font-size:12px">ğŸ“‹ ë³€ê²½ì´ë ¥ ë°ì´í„° ìˆ˜ì§‘ì˜ˆì •<br><span style="font-size:11px;color:#8892a4">ë³€ê²½ì´ë ¥(I2859/I2860 API)ì€ ì¶”í›„ ìˆ˜ì§‘ ì˜ˆì •ì…ë‹ˆë‹¤.</span></td></tr>';
    } else {
      changes.sort(function(a,b){ return (b.chng_dt||'').localeCompare(a.chng_dt||''); });
      var html = '';
      changes.forEach(function(c){
        html += '<tr>';
        html += '<td style="font-size:11px;font-family:monospace">' + formatDate8(c.chng_dt) + '</td>';
        html += '<td style="font-size:11px">' + (c.chng_bf_cn||'-') + '</td>';
        html += '<td style="font-size:11px">' + (c.chng_af_cn||'-') + '</td>';
        html += '<td style="font-size:11px;color:#5f6b7a">' + (c.chng_prvns||'-') + '</td>';
        html += '</tr>';
      });
      document.getElementById('bdmChangesBody').innerHTML = html;
    }
    console.log('[bizDetail] fss_changes:', changes.length, 'ê±´ ì¡°íšŒ (lcns_no=' + licNo + ')');
  } catch(e) {
    console.error('[bizDetail] fss_changes ì¡°íšŒ ì‹¤íŒ¨:', e);
    document.getElementById('bdmChangesBody').innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:#8892a4;font-size:12px">ë³€ê²½ì´ë ¥ ì»¬ë ‰ì…˜ ë¯¸ìˆ˜ì§‘</td></tr>';
    document.getElementById('bdmChangeCount').textContent = '-';
  }
}

function bizDetailTab(tab) {
  var isProducts = (tab === 'products');
  document.getElementById('bdmTabProducts').className = isProducts ? 'bdm-tab active' : 'bdm-tab';
  document.getElementById('bdmTabChanges').className = isProducts ? 'bdm-tab' : 'bdm-tab active';
  document.getElementById('bdmProductsPanel').style.display = isProducts ? 'block' : 'none';
  document.getElementById('bdmChangesPanel').style.display = isProducts ? 'none' : 'block';
}

function bizDetailClose() {
  document.getElementById('bizDetailModal').style.display = 'none';
}

function formatDate8(d) {
  if(!d || d.length < 8) return d || '-';
  return d.substring(0,4) + '-' + d.substring(4,6) + '-' + d.substring(6,8);
}

// â”€â”€ hash ê¸°ë°˜ í˜ì´ì§€ ë¼ìš°íŒ… â”€â”€
(function(){
  var h = location.hash.replace('#','');
  if (h && pageNames[h]) { showPage(h); }
})();

// â”€â”€ API ìˆ˜ì§‘ ì„¤ì • â”€â”€
var apiSettingsData = {
  collectTime: '03:00',
  collectMode: 'incremental',
  serverUrl: (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5003' : '/fss',
  activeApis: ['I1220','I2829','I-0020','I1300','I1320','I2835','I2831','C001','I1260',
               'I1250','I1310','C002','C003','C006','I2859','I2860']
};

// ì €ì¥ëœ ì„¤ì • ë¡œë“œ
(function loadSavedSettings(){
  try {
    var saved = JSON.parse(sessionStorage.getItem('apiSettings'));
    if(saved) {
      apiSettingsData = saved;
      // UI ë°˜ì˜
      setTimeout(function(){
        var timeEl = document.getElementById('collectTime');
        if(timeEl) timeEl.value = saved.collectTime || '03:00';
        var modeEl = document.getElementById('collectMode');
        if(modeEl) modeEl.value = saved.collectMode || 'incremental';
        var urlEl = document.getElementById('apiServerUrl');
        if(urlEl) urlEl.value = saved.serverUrl || ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5003' : '/fss');
        // ì²´í¬ë°•ìŠ¤ ë°˜ì˜
        document.querySelectorAll('#page-apiSettings .api-check input[type="checkbox"]').forEach(function(cb){
          var apiId = cb.closest('.api-item').id.replace('api-','');
          cb.checked = saved.activeApis.indexOf(apiId) >= 0;
        });
        updateApiCount();
      }, 100);
    }
  } catch(e){}
})();

function updateApiCount() {
  var checks = document.querySelectorAll('#page-apiSettings .api-check input[type="checkbox"]');
  var active = 0;
  checks.forEach(function(cb){ if(cb.checked) active++; });
  var el = document.getElementById('apiActiveCount');
  if(el) el.textContent = active;
  var nextEl = document.getElementById('apiNextCollect');
  var timeEl = document.getElementById('collectTime');
  if(nextEl && timeEl) nextEl.textContent = timeEl.value;
}

function toggleApiGroup(groupId) {
  var el = document.getElementById(groupId);
  var arrow = document.getElementById(groupId + 'Arrow');
  if(!el) return;
  if(el.style.display === 'none') {
    el.style.display = 'block';
    if(arrow) arrow.textContent = 'â–¼';
  } else {
    el.style.display = 'none';
    if(arrow) arrow.textContent = 'â–¶';
  }
}

function checkAllApis(checked) {
  document.querySelectorAll('#page-apiSettings .api-check input[type="checkbox"]').forEach(function(cb){
    cb.checked = checked;
  });
  updateApiCount();
}

function saveApiSettings() {
  var checks = document.querySelectorAll('#page-apiSettings .api-check input[type="checkbox"]');
  var activeApis = [];
  checks.forEach(function(cb){
    if(cb.checked) {
      var apiId = cb.closest('.api-item').id.replace('api-','');
      activeApis.push(apiId);
    }
  });

  apiSettingsData = {
    collectTime: document.getElementById('collectTime').value,
    collectMode: document.getElementById('collectMode').value,
    serverUrl: document.getElementById('apiServerUrl').value.trim(),
    activeApis: activeApis
  };

  // ì„¸ì…˜ ì €ì¥
  sessionStorage.setItem('apiSettings', JSON.stringify(apiSettingsData));

  // ì„œë²„ì— ì„¤ì • ì „ì†¡ ì‹œë„
  var url = apiSettingsData.serverUrl + '/api/settings';
  fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(apiSettingsData)
  }).then(function(res){ return res.json(); })
    .then(function(data){
      if(data.success) {
        toast('âœ… ì„¤ì •ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì§‘ ì‹œê°: ' + apiSettingsData.collectTime + ' KST');
      } else {
        toast('âš ï¸ ë¡œì»¬ ì €ì¥ ì™„ë£Œ. ì„œë²„ ì €ì¥ì€ ì‹¤íŒ¨: ' + (data.error || ''));
      }
    })
    .catch(function(){
      toast('ğŸ’¾ ë¡œì»¬ ì €ì¥ ì™„ë£Œ. (ì„œë²„ ì—°ê²° ì‹œ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤)');
    });

  updateApiCount();
}

function testApiConnection() {
  var url = document.getElementById('apiServerUrl').value.trim();
  if(!url) { toast('âš ï¸ API ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  document.getElementById('collectStatusArea').innerHTML =
    '<div style="padding:20px;text-align:center;color:#1a73e8">ğŸ”„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</div>';

  fetch(url + '/api/status')
    .then(function(res){ return res.json(); })
    .then(function(data){
      if(data.success) {
        toast('âœ… API ì„œë²„ ì—°ê²° ì„±ê³µ!');
        renderCollectStatus(data);
      } else {
        toast('âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
        document.getElementById('collectStatusArea').innerHTML =
          '<div style="color:#e53935;padding:20px;text-align:center">ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + JSON.stringify(data) + '</div>';
      }
    })
    .catch(function(e){
      toast('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message);
      document.getElementById('collectStatusArea').innerHTML =
        '<div style="color:#e53935;padding:20px;text-align:center">ì—°ê²° ì‹¤íŒ¨: ' + e.message +
        '<br><br><span style="font-size:11px;color:#8892a4">ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.<br>' +
        'bioflseverì—ì„œ: <code>sudo systemctl status fss-api</code></span></div>';
    });
}

function loadCollectStatus() {
  var url = document.getElementById('apiServerUrl').value.trim();
  if(!url) { toast('âš ï¸ API ì„œë²„ ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.'); return; }
  testApiConnection();
}

function renderCollectStatus(data) {
  var html = '';

  // í…Œì´ë¸”ë³„ ìš”ì•½
  var tableNames = {
    'fss_businesses': 'ì—…ì†Œ ì¸í—ˆê°€',
    'fss_products': 'í’ˆëª© ì œì¡°',
    'fss_materials': 'ì›ì¬ë£Œ',
    'fss_changes': 'ë³€ê²½ ì´ë ¥'
  };

  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:16px">';
  if(data.tables) {
    for(var tbl in data.tables) {
      var t = data.tables[tbl];
      var name = tableNames[tbl] || tbl;
      var cnt = t.count ? t.count.toLocaleString() : '0';
      var last = t.last_collected ? t.last_collected.substring(0,16) : '-';
      html += '<div style="padding:12px;background:#f8f9fb;border-radius:8px;border:1px solid #eef0f4">';
      html += '<div style="font-size:11px;color:#8892a4">' + name + '</div>';
      html += '<div style="font-size:20px;font-weight:700;color:#1a2332">' + cnt + '</div>';
      html += '<div style="font-size:10px;color:#b0b8c4">ìµœê·¼: ' + last + '</div>';
      html += '</div>';
    }
  }
  html += '</div>';

  // ìµœê·¼ ìˆ˜ì§‘ ë¡œê·¸
  if(data.recent_logs && data.recent_logs.length > 0) {
    html += '<div style="font-size:12px;font-weight:700;margin-bottom:8px;color:#1a2332">ìµœê·¼ ìˆ˜ì§‘ ì´ë ¥</div>';
    data.recent_logs.forEach(function(log){
      var dt = (log.started_at || '').substring(0,16);
      var dotClass = log.error_count > 0 ? 'err' : 'ok';
      html += '<div class="collect-row">';
      html += '<span class="collect-dot ' + dotClass + '"></span>';
      html += '<span style="color:#8892a4;min-width:100px">' + dt + '</span>';
      html += '<span style="font-weight:600;min-width:60px">' + log.api_source + '</span>';
      html += '<span style="flex:1">' + (log.api_name || '') + '</span>';
      html += '<span style="color:#1a73e8">' + (log.fetched_count||0).toLocaleString() + 'ê±´</span>';
      html += '<span style="color:#2e7d32;margin-left:8px">+' + (log.inserted_count||0) + '</span>';
      html += '<span style="color:#e65100;margin-left:4px">â†»' + (log.updated_count||0) + '</span>';
      if(log.error_count > 0) html += '<span style="color:#e53935;margin-left:4px">âœ—' + log.error_count + '</span>';
      html += '<span style="color:#b0b8c4;margin-left:8px">' + (log.duration_sec||0) + 'ì´ˆ</span>';
      html += '</div>';
    });

    // ìµœê·¼ ìˆ˜ì§‘ì¼ì‹œ ì—…ë°ì´íŠ¸
    var lastEl = document.getElementById('apiLastCollect');
    if(lastEl && data.recent_logs[0]) {
      lastEl.textContent = (data.recent_logs[0].started_at || '').substring(5,16);
    }
  } else {
    html += '<div style="text-align:center;color:#8892a4;padding:16px">ìˆ˜ì§‘ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤. ìµœì´ˆ ìˆ˜ì§‘ì„ ì‹¤í–‰í•˜ì„¸ìš”.</div>';
  }

  document.getElementById('collectStatusArea').innerHTML = html;
}

// í˜ì´ì§€ ì§„ì… ì‹œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
(function(){
  setTimeout(updateApiCount, 200);
})();

</script>
<script>
// ì‚¬ì´ë“œë°” JS â†’ js/sidebar.jsë¡œ ì´ê´€ë¨
// í•´ì‹œ ê¸°ë°˜ ì„œë¸Œ í˜ì´ì§€ ì „í™˜ì€ sidebar.js renderSidebar í›„ ìë™ ì²˜ë¦¬
(function initSalesHash() {
  // sidebar.jsê°€ DOMContentLoadedì—ì„œ renderSidebarë¥¼ ì‹¤í–‰í•œ í›„,
  // í•´ì‹œê°€ ìˆìœ¼ë©´ showPage í˜¸ì¶œ
  function handleHash() {
    const hash = location.hash.replace('#', '');
    if (hash && typeof showPage === 'function') {
      showPage(hash);
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(handleHash, 50); setTimeout(loadCustomers, 100); });
  } else {
    setTimeout(handleHash, 50);
    setTimeout(loadCustomers, 100);
  }
})();
// ====== END SALES HASH HANDLER ======
</script>

<!-- ====== ì—…ì²´ ìƒì„¸ ì¡°íšŒ ëª¨ë‹¬ ====== -->
<div id="bizDetailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:16px;width:90%;max-width:800px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
    <!-- í—¤ë” -->
    <div style="padding:20px 24px 16px;border-bottom:1px solid #e2e6ed;display:flex;align-items:center;gap:12px;flex-shrink:0">
      <div style="width:40px;height:40px;background:linear-gradient(135deg,#1565c0,#42a5f5);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;flex-shrink:0">ğŸ­</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:16px;font-weight:700;color:#1a2332" id="bdmBizName">-</div>
        <div style="font-size:12px;color:#8892a4;font-family:monospace">ì¸í—ˆê°€ë²ˆí˜¸: <span id="bdmLicNo">-</span></div>
      </div>
      <button onclick="var ln=document.getElementById('bdmLicNo').textContent;var nm=document.getElementById('bdmBizName').textContent;bizReg(nm,'')" style="padding:6px 14px;background:#2e7d32;color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer;font-weight:600">ğŸ“‹ ê³ ê° ë“±ë¡</button>
      <button onclick="bizDetailClose()" style="width:32px;height:32px;background:#f1f3f5;border:none;border-radius:8px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#5f6b7a">âœ•</button>
    </div>
    <!-- íƒ­ -->
    <div style="padding:0 24px;border-bottom:1px solid #e2e6ed;display:flex;gap:0;flex-shrink:0">
      <style>
        .bdm-tab{padding:12px 20px;font-size:13px;font-weight:500;color:#8892a4;cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:all .15s}
        .bdm-tab:hover{color:#1a2332}
        .bdm-tab.active{color:#1565c0;font-weight:700;border-bottom-color:#1565c0}
        #bdmProductsBody tr, #bdmChangesBody tr{border-bottom:1px solid #f1f3f5}
        #bdmProductsBody tr:hover, #bdmChangesBody tr:hover{background:#f8f9fb}
        #bdmProductsBody td, #bdmChangesBody td{padding:8px 12px}
      </style>
      <button id="bdmTabProducts" class="bdm-tab active" onclick="bizDetailTab('products')">ğŸ“¦ í’ˆëª© <span id="bdmProductCount" style="font-size:11px;background:#e3f2fd;padding:1px 6px;border-radius:8px;margin-left:4px">-</span></button>
      <button id="bdmTabChanges" class="bdm-tab" onclick="bizDetailTab('changes')">ğŸ“ ë³€ê²½ì´ë ¥ <span id="bdmChangeCount" style="font-size:11px;background:#e3f2fd;padding:1px 6px;border-radius:8px;margin-left:4px">-</span></button>
    </div>
    <!-- í’ˆëª© íŒ¨ë„ -->
    <div id="bdmProductsPanel" style="flex:1;overflow-y:auto;padding:0">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr style="background:#f8f9fb;position:sticky;top:0">
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">ì œí’ˆëª…</th>
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">í’ˆëª©ìœ í˜•</th>
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">ë³´ê³ ì¼ì</th>
          <th style="padding:10px 8px;text-align:center;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">ìƒíƒœ</th>
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">ì†Œë¹„ê¸°í•œ</th>
        </tr></thead>
        <tbody id="bdmProductsBody">
          <tr><td colspan="5" style="text-align:center;padding:40px;color:#8892a4">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</td></tr>
        </tbody>
      </table>
    </div>
    <!-- ë³€ê²½ì´ë ¥ íŒ¨ë„ -->
    <div id="bdmChangesPanel" style="flex:1;overflow-y:auto;padding:0;display:none">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr style="background:#f8f9fb;position:sticky;top:0">
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed;width:100px">ë³€ê²½ì¼ì</th>
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">ë³€ê²½ ì „</th>
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed">ë³€ê²½ í›„</th>
          <th style="padding:10px 12px;text-align:left;color:#5f6b7a;font-weight:600;font-size:11px;border-bottom:1px solid #e2e6ed;width:120px">ì‚¬ìœ </th>
        </tr></thead>
        <tbody id="bdmChangesBody">
          <tr><td colspan="4" style="text-align:center;padding:40px;color:#8892a4">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- ====== END ì—…ì²´ ìƒì„¸ ì¡°íšŒ ëª¨ë‹¬ ====== -->

<!-- ì‚¬ì—…ì ì§„ìœ„í™•ì¸ ëª¨ë‹¬ -->
<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:9999;display:none;align-items:center;justify-content:center" id="bizVerifyModal">
  <div style="background:#fff;border-radius:14px;padding:24px;max-width:540px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.25)">
    <h3 style="font-size:16px;font-weight:700;color:#1565c0;margin-bottom:14px">ì‚¬ì—…ìë“±ë¡ì •ë³´ í™•ì¸</h3>
    <div id="bizVerifyContent" style="font-size:13px;color:#333"></div>
    <div style="text-align:right;margin-top:14px">
      <button class="btn btn-secondary btn-sm" onclick="closeBizVerifyModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- OCR ê²°ê³¼ ëª¨ë‹¬ -->
<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:9999;display:none;align-items:center;justify-content:center" id="ocrResultModal">
  <div style="background:#fff;border-radius:14px;padding:24px;max-width:600px;width:92%;max-height:80vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.25)">
    <h3 style="font-size:16px;font-weight:700;color:#1565c0;margin-bottom:4px">ğŸ” OCR ì¸ì‹ ê²°ê³¼</h3>
    <div id="ocrModalSub" style="font-size:12px;color:#667085;margin-bottom:14px"></div>
    <div id="ocrModalBody" style="font-size:13px;color:#333"></div>
    <div style="text-align:right;margin-top:14px">
      <button class="btn btn-secondary btn-sm" onclick="closeOcrResultModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
var BIZ_VERIFY_SERVICE_KEY = '4553b84e3c3d3816cdfacb285eadeb54f252e8bc48652c3e0eebdaca255fd91c';

async function verifyBizRegistration() {
  var bizNoRaw = (document.getElementById('detBizNo') || {}).value.trim();
  var bizNo = bizNoRaw.replace(/[^0-9]/g, '');
  if (bizNo.length !== 10) { toast('ì˜¬ë°”ë¥¸ ì‚¬ì—…ìë²ˆí˜¸ 10ìë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤'); return; }

  var contentEl = document.getElementById('bizVerifyContent');
  contentEl.innerHTML = '<div style="text-align:center;padding:20px">ì¡°íšŒ ì¤‘...</div>';
  document.getElementById('bizVerifyModal').style.display = 'flex';

  var now = new Date();
  var queryTime = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  var html = '';

  try {
    var statusRes = await fetch('https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey=' + encodeURIComponent(BIZ_VERIFY_SERVICE_KEY), {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'accept': 'application/json' },
      body: JSON.stringify({ b_no: [bizNo] })
    });
    var statusData = await statusRes.json();
    if (statusData.data && statusData.data[0]) {
      var s = statusData.data[0];
      var sttClass = s.b_stt_cd === '01' ? 'biz-valid-ok' : 'biz-valid-fail';
      html += '<table class="biz-verify-table">';
      html += '<tr><th>ì‚¬ì—…ìë²ˆí˜¸</th><td>' + bizNoRaw + '</td></tr>';
      html += '<tr><th>ì‚¬ì—…ììƒíƒœ</th><td class="' + sttClass + '">' + (s.b_stt || '-') + ' (' + (s.b_stt_cd || '-') + ')' + '</td></tr>';
      html += '<tr><th>ê³¼ì„¸ìœ í˜•</th><td>' + (s.tax_type || '-') + '</td></tr>';
      html += '<tr><th>íì—…ì¼ì</th><td>' + (s.end_dt || '-') + '</td></tr>';
      html += '<tr><th>ë‹¨ìœ„ê³¼ì„¸ì „í™˜ì—¬ë¶€</th><td>' + (s.utcc_yn === 'Y' ? 'Y (ì „í™˜)' : s.utcc_yn === 'N' ? 'N' : (s.utcc_yn || '-')) + '</td></tr>';
      html += '<tr><th>ê³¼ì„¸ìœ í˜• ë³€ê²½ì¼</th><td>' + (s.tax_type_change_dt || '-') + '</td></tr>';
      html += '<tr><th>ì„¸ê¸ˆê³„ì‚°ì„œ ì ìš©ì¼</th><td>' + (s.invoice_apply_dt || '-') + '</td></tr>';
      html += '<tr><th>ì§ì „ ê³¼ì„¸ìœ í˜•</th><td>' + (s.rbf_tax_type || '-') + '</td></tr>';
      html += '</table>';
    } else { html += '<div style="color:#d32f2f">ìƒíƒœì¡°íšŒ ê²°ê³¼ ì—†ìŒ</div>'; }
  } catch(e) { html += '<div style="color:#d32f2f">ìƒíƒœì¡°íšŒ ì‹¤íŒ¨: ' + e.message + '</div>'; }

  var repName = (document.getElementById('detRepName') || {}).value.trim();
  var openDate = '';
  if (_detailCustId) {
    try {
      var doc = await db.collection('companies').doc(_detailCustId).get();
      if (doc.exists) openDate = (doc.data().openDate || '').replace(/[^0-9]/g, '');
    } catch(e) {}
  }

  if (repName && openDate.length === 8) {
    try {
      var valRes = await fetch('https://api.odcloud.kr/api/nts-businessman/v1/validate?serviceKey=' + encodeURIComponent(BIZ_VERIFY_SERVICE_KEY), {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'accept': 'application/json' },
        body: JSON.stringify({ businesses: [{ b_no: bizNo, start_dt: openDate, p_nm: repName }] })
      });
      var valData = await valRes.json();
      if (valData.data && valData.data[0]) {
        var v = valData.data[0];
        var validIcon = v.valid === '01' ? '&#10003; ì¼ì¹˜' : '&#10007; ë¶ˆì¼ì¹˜';
        var validClass = v.valid === '01' ? 'biz-valid-ok' : 'biz-valid-fail';
        html += '<div class="biz-verify-section"><div style="font-weight:700;margin-bottom:6px">ì§„ìœ„í™•ì¸</div>';
        html += '<div class="' + validClass + '">' + validIcon + '</div>';
        if (v.valid_msg) html += '<div style="font-size:11px;color:#888;margin-top:4px">' + v.valid_msg + '</div>';
        html += '</div>';
      }
    } catch(e) { html += '<div style="color:#d32f2f;margin-top:8px">ì§„ìœ„í™•ì¸ ì‹¤íŒ¨: ' + e.message + '</div>'; }
  } else {
    html += '<div class="biz-verify-section" style="color:#888;font-size:12px">* ì§„ìœ„í™•ì¸ì„ ìœ„í•´ ê°œì—…ì¼ìê°€ í•„ìš”í•©ë‹ˆë‹¤ (ë“±ë¡ ì‹œ ì…ë ¥)</div>';
  }

  html += '<div style="text-align:right;font-size:11px;color:#999;margin-top:10px">ì¡°íšŒì¼ì‹œ: ' + queryTime + '</div>';
  contentEl.innerHTML = html;
}

function closeBizVerifyModal() {
  document.getElementById('bizVerifyModal').style.display = 'none';
}
</script>

</body>
</html>
