<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API ê°±ì‹  í˜„í™© - BioFoodLab ê´€ë¦¬ì</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --border: #e2e6ed;
  --text: #1a2332;
  --text2: #5f6b7a;
  --text3: #8892a4;
  --primary: #1a73e8;
  --primary-light: #e8f0fe;
  --success: #0d9f6e;
  --success-light: #def7ec;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --danger: #e53e3e;
  --danger-light: #fee2e2;
  --cat-biz: #4f46e5;
  --cat-prd: #0891b2;
  --cat-mat: #16a34a;
  --cat-chg: #d97706;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
  --shadow-lg: 0 4px 14px rgba(0,0,0,.1);
  --radius: 10px;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans KR', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

/* â”€â”€â”€ Sidebar Layout â”€â”€â”€ */
.app-layout { display:flex; min-height:100vh; }
.main-wrapper { flex:1; margin-left:250px; min-height:100vh; }
@media(max-width:768px) { .main-wrapper { margin-left:0; } }

.header {
  background: linear-gradient(135deg, #1a2332 0%, #2d3a4a 100%);
  color: #fff;
  padding: 24px 32px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,.15);
}
.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header h1 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -.3px;
}
.header h1 span { color: #90caf9; font-weight: 400; }
.header-actions { display: flex; gap: 10px; align-items: center; }

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  font-family: inherit;
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-outline {
  background: transparent;
  border: 1.5px solid rgba(255,255,255,.35);
  color: #fff;
}
.btn-outline:hover { border-color: #fff; background: rgba(255,255,255,.1); }
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 32px 60px;
}

/* â”€â”€â”€ Summary Cards â”€â”€â”€ */
.summary-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.summary-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
  text-align: center;
}
.summary-card .num {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1.2;
}
.summary-card .label {
  font-size: 12px;
  color: var(--text3);
  margin-top: 4px;
}
.summary-card.completed .num { color: var(--success); }
.summary-card.progress .num { color: var(--warning); }
.summary-card.waiting .num { color: var(--text3); }

/* â”€â”€â”€ API Table â”€â”€â”€ */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 24px;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-header h2 {
  font-size: 15px;
  font-weight: 600;
}

.api-table {
  width: 100%;
  border-collapse: collapse;
}
.api-table th {
  background: #f8f9fb;
  padding: 10px 14px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.api-table td {
  padding: 12px 14px;
  font-size: 13px;
  border-bottom: 1px solid #f0f2f5;
  vertical-align: middle;
  white-space: nowrap;
}
.api-table tr:hover td { background: #fafbfc; }

.api-id {
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 12px;
  background: #f0f2f5;
  padding: 2px 8px;
  border-radius: 4px;
  color: var(--text2);
}

/* Category badges */
.cat-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}
.cat-biz { background: #eef2ff; color: var(--cat-biz); }
.cat-prd { background: #ecfeff; color: var(--cat-prd); }
.cat-mat { background: #f0fdf4; color: var(--cat-mat); }
.cat-chg { background: #fffbeb; color: var(--cat-chg); }

/* Progress bar */
.progress-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}
.progress-bar {
  flex: 1;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  min-width: 80px;
}
.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width .5s ease;
}
.progress-fill.full { background: var(--success); }
.progress-fill.partial { background: var(--warning); }
.progress-fill.zero { background: #e5e7eb; }
.progress-pct {
  font-size: 12px;
  font-weight: 600;
  min-width: 42px;
  text-align: right;
}

/* Status badge */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.status-completed { background: var(--success-light); color: var(--success); }
.status-progress { background: var(--warning-light); color: #b45309; }
.status-waiting { background: #f3f4f6; color: var(--text3); }

.count-cell {
  font-variant-numeric: tabular-nums;
  font-weight: 500;
}

.time-cell {
  font-size: 12px;
  color: var(--text2);
  white-space: nowrap;
}

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast {
  position: fixed;
  top: 80px;
  right: 24px;
  background: #1a2332;
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 13px;
  box-shadow: var(--shadow-lg);
  transform: translateX(120%);
  transition: transform .3s;
  z-index: 999;
}
.toast.show { transform: translateX(0); }

/* â”€â”€â”€ Loading â”€â”€â”€ */
.loading {
  text-align: center;
  padding: 60px;
  color: var(--text3);
}
.loading::before {
  content: '';
  display: block;
  width: 32px;
  height: 32px;
  border: 3px solid #e5e7eb;
  border-top-color: var(--primary);
  border-radius: 50%;
  margin: 0 auto 12px;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ Auto refresh indicator â”€â”€â”€ */
.refresh-info {
  font-size: 12px;
  color: rgba(255,255,255,.6);
}

@media (max-width: 768px) {
  .container { padding: 16px; }
  .header { padding: 16px; }
  .summary-row { grid-template-columns: repeat(2, 1fr); }
  .api-table { font-size: 12px; }
  .api-table th, .api-table td { padding: 8px 10px; }
}
</style>
</head>
<body>
<div class="app-layout">
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=2"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<div class="main-wrapper">

<div class="header">
  <div class="header-inner">
    <h1>ğŸ”„ API ê°±ì‹  í˜„í™© <span>BioFoodLab ê´€ë¦¬ì</span></h1>
    <div class="header-actions">
      <span class="refresh-info" id="refreshInfo">30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ </span>
      <button class="btn btn-outline btn-sm" onclick="loadData()">â†» ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn btn-success btn-sm" id="btnAutoCollect" onclick="triggerCollect('auto')">
        â–¶ ìë™ ìˆ˜ì§‘ ì‹œì‘
      </button>
      <a href="admin_api_settings.html" class="btn btn-outline btn-sm">â† ì„¤ì •ìœ¼ë¡œ</a>
    </div>
  </div>
</div>

<div class="container">
  <!-- Summary -->
  <div class="summary-row" id="summaryRow">
    <div class="summary-card">
      <div class="num" id="totalApis">-</div>
      <div class="label">ì „ì²´ API</div>
    </div>
    <div class="summary-card completed">
      <div class="num" id="completedApis">-</div>
      <div class="label">ìˆ˜ì§‘ ì™„ë£Œ</div>
    </div>
    <div class="summary-card progress">
      <div class="num" id="progressApis">-</div>
      <div class="label">ìˆ˜ì§‘ ì¤‘</div>
    </div>
    <div class="summary-card waiting">
      <div class="num" id="waitingApis">-</div>
      <div class="label">ë¯¸ì‹œì‘</div>
    </div>
    <div class="summary-card">
      <div class="num" id="totalRecords">-</div>
      <div class="label">ì´ DB ê±´ìˆ˜</div>
    </div>
  </div>

  <!-- API Table -->
  <div class="card">
    <div class="card-header">
      <h2>APIë³„ ìˆ˜ì§‘ í˜„í™©</h2>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" onclick="triggerCollect('auto')">ğŸ”„ ì „ì²´ ìë™ê°±ì‹ </button>
        <button class="btn btn-warning btn-sm" onclick="triggerCollect('resume')">â© ì´ì–´ì„œ ìˆ˜ì§‘</button>
      </div>
    </div>
    <div id="tableWrap">
      <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// API ì„œë²„ ì£¼ì†Œ (ìˆ˜ë™ ìˆ˜ì§‘ íŠ¸ë¦¬ê±°ìš©ë§Œ ì‚¬ìš©)
var API_BASE = (function() {
  if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
    return 'http://localhost:5003';
  }
  if (location.hostname.includes('github.io')) {
    return 'https://14.7.14.31:8443/fss';
  }
  return '/fss';
})();
var refreshTimer = null;

// 16ê°œ API ì •ì˜
var ALL_APIS = {
  'I1220':  { name: 'ì‹í’ˆì œì¡°ê°€ê³µì—…',               collection: 'fss_businesses' },
  'I2829':  { name: 'ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…',           collection: 'fss_businesses' },
  'I-0020': { name: 'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì „ë¬¸/ë²¤ì²˜ì œì¡°ì—…',  collection: 'fss_businesses' },
  'I1300':  { name: 'ì¶•ì‚°ë¬¼ ê°€ê³µì—…',                collection: 'fss_businesses' },
  'I1320':  { name: 'ì¶•ì‚°ë¬¼ ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…',        collection: 'fss_businesses' },
  'I2835':  { name: 'ì‹ìœ¡ì¦‰ì„íŒë§¤ê°€ê³µì—…',           collection: 'fss_businesses' },
  'I2831':  { name: 'ì‹í’ˆì†Œë¶„ì—…',                   collection: 'fss_businesses' },
  'C001':   { name: 'ìˆ˜ì…ì‹í’ˆë“±ì˜ì—…ì‹ ê³ ',           collection: 'fss_businesses' },
  'I1260':  { name: 'ì‹í’ˆë“±ìˆ˜ì…íŒë§¤ì—…',             collection: 'fss_businesses' },
  'I1250':  { name: 'ì‹í’ˆ(ì²¨ê°€ë¬¼)í’ˆëª©ì œì¡°ë³´ê³ ',     collection: 'fss_products' },
  'I1310':  { name: 'ì¶•ì‚°ë¬¼ í’ˆëª©ì œì¡°ì •ë³´',          collection: 'fss_products' },
  'C002':   { name: 'ì‹í’ˆ(ì²¨ê°€ë¬¼)í’ˆëª©ì œì¡°ë³´ê³ (ì›ì¬ë£Œ)', collection: 'fss_materials' },
  'C003':   { name: 'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ í’ˆëª©ì œì¡°ì‹ ê³ (ì›ì¬ë£Œ)', collection: 'fss_materials' },
  'C006':   { name: 'ì¶•ì‚°ë¬¼í’ˆëª©ì œì¡°ë³´ê³ (ì›ì¬ë£Œ)',    collection: 'fss_materials' },
  'I2859':  { name: 'ì‹í’ˆì—…ì†Œ ì¸í—ˆê°€ ë³€ê²½ ì •ë³´',    collection: 'fss_changes' },
  'I2860':  { name: 'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆì—…ì†Œ ì¸í—ˆê°€ ë³€ê²½ ì •ë³´', collection: 'fss_changes' },
};

var CAT_MAP = {
  'fss_businesses': { label: 'ì—…ì†Œì¸í—ˆê°€', cls: 'cat-biz' },
  'fss_products':   { label: 'í’ˆëª©ì œì¡°', cls: 'cat-prd' },
  'fss_materials':  { label: 'ì›ì¬ë£Œ', cls: 'cat-mat' },
  'fss_changes':    { label: 'ë³€ê²½ì´ë ¥', cls: 'cat-chg' },
};

function numberFormat(n) {
  if (n === null || n === undefined) return '-';
  return Number(n).toLocaleString('ko-KR');
}

function formatTime(dtStr) {
  if (!dtStr || dtStr === 'None') return '-';
  var d = new Date(dtStr.endsWith('Z') || dtStr.includes('+') ? dtStr : dtStr + 'Z');
  if (isNaN(d.getTime())) return '-';
  return d.toLocaleString('ko-KR', {
    timeZone: 'Asia/Seoul',
    month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit',
    hour12: false
  });
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}

// fss_config/data_counts ë¬¸ì„œì—ì„œ ì¹´ìš´íŠ¸ ì¡°íšŒ (ê²½ëŸ‰)
async function loadDataCounts() {
  try {
    var doc = await db.collection('fss_config').doc('data_counts').get();
    if (doc.exists) return doc.data();
    return { counts: {}, total: {} };
  } catch(e) {
    console.warn('ì¹´ìš´íŠ¸ ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨:', e.message);
    return { counts: {}, total: {} };
  }
}

// ìˆ˜ì§‘ ë¡œê·¸ ì „ì²´ ì¡°íšŒ (ì†ŒëŸ‰ ë°ì´í„°) â†’ APIë³„ ìµœì‹  ë¡œê·¸ ë§µ ìƒì„±
async function loadAllLogs() {
  try {
    var snap = await db.collection('fss_collect_log')
      .orderBy('started_at', 'desc').get();
    var latestLogs = {};
    snap.docs.forEach(function(doc) {
      var data = doc.data();
      var src = data.api_source;
      if (src && !latestLogs[src]) latestLogs[src] = data;
    });
    return latestLogs;
  } catch(e) {
    console.warn('ìˆ˜ì§‘ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨:', e.message);
    // orderBy ì¸ë±ìŠ¤ ì—†ì„ ê²½ìš° â†’ ì¸ë±ìŠ¤ ì—†ì´ ì¬ì‹œë„
    try {
      var snap2 = await db.collection('fss_collect_log').get();
      var latestLogs2 = {};
      snap2.docs.forEach(function(doc) {
        var data = doc.data();
        var src = data.api_source;
        if (!src) return;
        var existing = latestLogs2[src];
        if (!existing || (data.started_at && (!existing.started_at || data.started_at > existing.started_at))) {
          latestLogs2[src] = data;
        }
      });
      return latestLogs2;
    } catch(e2) {
      console.error('ìˆ˜ì§‘ ë¡œê·¸ ì¬ì‹œë„ ì‹¤íŒ¨:', e2.message);
      return {};
    }
  }
}

async function loadData() {
  if (!isFirebaseReady()) {
    document.getElementById('refreshInfo').textContent = 'Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...';
    return;
  }

  document.getElementById('refreshInfo').textContent = 'ë°ì´í„° ë¡œë”© ì¤‘...';

  try {
    // 1. ì¹´ìš´íŠ¸ ë©”íƒ€ë°ì´í„° + ìˆ˜ì§‘ ë¡œê·¸ë¥¼ ë™ì‹œì— ì¡°íšŒ (2ê°œ ì¿¼ë¦¬ë§Œ)
    var results = await Promise.all([loadDataCounts(), loadAllLogs()]);
    var dataCounts = results[0];
    var latestLogs = results[1];
    var apiCounts = dataCounts.counts || {};

    var apis = [];
    var apiIds = Object.keys(ALL_APIS);

    apiIds.forEach(function(sid) {
      var info = ALL_APIS[sid];
      var dbCount = apiCounts[sid] || 0;
      var lastLog = latestLogs[sid] || null;

      var apiData = {
        api_source: sid,
        name: info.name,
        table: info.collection,
        db_count: dbCount,
        last_api_total: lastLog ? (lastLog.total_count || 0) : 0,
        last_collect: null,
      };

      if (lastLog) {
        apiData.last_collect = {
          type: lastLog.collect_type || '',
          fetched: lastLog.fetched_count || 0,
          inserted: lastLog.inserted_count || 0,
          updated: lastLog.updated_count || 0,
          errors: lastLog.error_count || 0,
          error_msg: lastLog.error_msg || '',
          started_at: lastLog.started_at || '',
          finished_at: lastLog.finished_at || '',
          duration_sec: lastLog.duration_sec || 0,
        };
      }

      // ìƒíƒœ íŒë‹¨
      if (dbCount === 0 && (!lastLog || !lastLog.total_count)) {
        apiData.status = 'not_started';
      } else if (lastLog && lastLog.total_count && dbCount < lastLog.total_count) {
        apiData.status = 'in_progress';
      } else {
        apiData.status = 'completed';
      }

      apis.push(apiData);
    });

    renderSummary(apis);
    renderTable(apis);
    document.getElementById('refreshInfo').textContent =
      'ë§ˆì§€ë§‰ ê°±ì‹ : ' + new Date().toLocaleTimeString('ko-KR') + ' (30ì´ˆë§ˆë‹¤) [Firestore]';

  } catch(e) {
    console.error('loadData ì˜¤ë¥˜:', e);
    document.getElementById('refreshInfo').textContent = 'âš ï¸ Firestore ì¡°íšŒ ì˜¤ë¥˜: ' + e.message;
  }
}

function renderSummary(apis) {
  var completed = 0, progress = 0, waiting = 0, totalRec = 0;
  apis.forEach(function(a) {
    if (a.status === 'completed') completed++;
    else if (a.status === 'in_progress') progress++;
    else waiting++;
    totalRec += a.db_count || 0;
  });
  document.getElementById('totalApis').textContent = apis.length;
  document.getElementById('completedApis').textContent = completed;
  document.getElementById('progressApis').textContent = progress;
  document.getElementById('waitingApis').textContent = waiting;
  document.getElementById('totalRecords').textContent = numberFormat(totalRec);
}

function renderTable(apis) {
  var html = '<table class="api-table">';
  html += '<thead><tr>'
    + '<th>API</th>'
    + '<th>ì´ë¦„</th>'
    + '<th>ë¶„ë¥˜</th>'
    + '<th style="text-align:right">Firestore ê±´ìˆ˜</th>'
    + '<th style="text-align:right">API ì´ê±´ìˆ˜</th>'
    + '<th>ì§„í–‰ë¥ </th>'
    + '<th>ìƒíƒœ</th>'
    + '<th>ìµœê·¼ ìˆ˜ì§‘</th>'
    + '<th>ì†Œìš”ì‹œê°„</th>'
    + '</tr></thead><tbody>';

  apis.forEach(function(a) {
    var cat = CAT_MAP[a.table] || { label: '-', cls: '' };
    var apiTotal = a.last_api_total || 0;
    var pct = apiTotal > 0 ? Math.min(100, (a.db_count / apiTotal * 100)) : 0;
    var pctStr = apiTotal > 0 ? pct.toFixed(1) + '%' : '-';
    var fillCls = pct >= 100 ? 'full' : (pct > 0 ? 'partial' : 'zero');

    var statusHtml = '';
    if (a.status === 'completed') {
      statusHtml = '<span class="status-badge status-completed">âœ… ì™„ë£Œ</span>';
    } else if (a.status === 'in_progress') {
      statusHtml = '<span class="status-badge status-progress">ğŸ”„ ìˆ˜ì§‘ì¤‘</span>';
    } else {
      statusHtml = '<span class="status-badge status-waiting">â¬œ ë¯¸ì‹œì‘</span>';
    }

    var lastTime = '-';
    var duration = '-';
    if (a.last_collect) {
      lastTime = formatTime(a.last_collect.started_at);
      duration = a.last_collect.duration_sec !== null
        ? (a.last_collect.duration_sec >= 60
            ? Math.floor(a.last_collect.duration_sec/60) + 'ë¶„'
            : a.last_collect.duration_sec + 'ì´ˆ')
        : '-';
      if (a.last_collect.error_msg) {
        lastTime += ' <span style="color:var(--danger);font-size:11px;" title="'
          + a.last_collect.error_msg + '">âš ï¸</span>';
      }
    }

    html += '<tr>'
      + '<td><span class="api-id">' + a.api_source + '</span></td>'
      + '<td>' + a.name + '</td>'
      + '<td><span class="cat-badge ' + cat.cls + '">' + cat.label + '</span></td>'
      + '<td class="count-cell" style="text-align:right">' + numberFormat(a.db_count) + '</td>'
      + '<td class="count-cell" style="text-align:right">' + numberFormat(apiTotal || null) + '</td>'
      + '<td><div class="progress-wrap">'
      +   '<div class="progress-bar"><div class="progress-fill ' + fillCls + '" style="width:' + pct + '%"></div></div>'
      +   '<span class="progress-pct">' + pctStr + '</span>'
      + '</div></td>'
      + '<td>' + statusHtml + '</td>'
      + '<td class="time-cell">' + lastTime + '</td>'
      + '<td class="time-cell">' + duration + '</td>'
      + '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('tableWrap').innerHTML = html;
}

function triggerCollect(mode) {
  var btn = document.getElementById('btnAutoCollect');
  btn.disabled = true;
  btn.textContent = 'â³ ìˆ˜ì§‘ ì‹¤í–‰ ì¤‘...';

  fetch(API_BASE + '/api/admin/collect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ mode: mode })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.success) {
      showToast('ìˆ˜ì§‘ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (' + mode + ')');
    } else {
      showToast('ìˆ˜ì§‘ ì‹œì‘ ì‹¤íŒ¨: ' + (data.error || ''));
    }
    setTimeout(function() {
      btn.disabled = false;
      btn.textContent = 'â–¶ ìë™ ìˆ˜ì§‘ ì‹œì‘';
    }, 5000);
  })
  .catch(function(e) {
    showToast('ì„œë²„ ì˜¤ë¥˜: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'â–¶ ìë™ ìˆ˜ì§‘ ì‹œì‘';
  });
}

// Firebase ì¤€ë¹„ í›„ ì´ˆê¸° ë¡œë“œ
waitForFirebase().then(function() {
  loadData();
  refreshTimer = setInterval(loadData, 30000);
});
</script>
</div><!-- /main-wrapper -->
</div><!-- /app-layout -->
</body>
</html>
