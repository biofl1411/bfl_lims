<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API ê°±ì‹  í˜„í™© - BioFoodLab ê´€ë¦¬ì</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --border: #e2e6ed;
  --text: #1a2332;
  --text2: #5f6b7a;
  --text3: #8892a4;
  --primary: #1a73e8;
  --primary-light: #e8f0fe;
  --success: #0d9f6e;
  --success-light: #def7ec;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --danger: #e53e3e;
  --danger-light: #fee2e2;
  --cat-biz: #4f46e5;
  --cat-prd: #0891b2;
  --cat-mat: #16a34a;
  --cat-chg: #d97706;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
  --shadow-lg: 0 4px 14px rgba(0,0,0,.1);
  --radius: 10px;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans KR', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

.header {
  background: linear-gradient(135deg, #1a2332 0%, #2d3a4a 100%);
  color: #fff;
  padding: 24px 32px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,.15);
}
.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header h1 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -.3px;
}
.header h1 span { color: #90caf9; font-weight: 400; }
.header-actions { display: flex; gap: 10px; align-items: center; }

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  font-family: inherit;
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-outline {
  background: transparent;
  border: 1.5px solid rgba(255,255,255,.35);
  color: #fff;
}
.btn-outline:hover { border-color: #fff; background: rgba(255,255,255,.1); }
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 32px 60px;
}

/* â”€â”€â”€ Summary Cards â”€â”€â”€ */
.summary-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.summary-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
  text-align: center;
}
.summary-card .num {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1.2;
}
.summary-card .label {
  font-size: 12px;
  color: var(--text3);
  margin-top: 4px;
}
.summary-card.completed .num { color: var(--success); }
.summary-card.progress .num { color: var(--warning); }
.summary-card.waiting .num { color: var(--text3); }

/* â”€â”€â”€ API Table â”€â”€â”€ */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 24px;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-header h2 {
  font-size: 15px;
  font-weight: 600;
}

.api-table {
  width: 100%;
  border-collapse: collapse;
}
.api-table th {
  background: #f8f9fb;
  padding: 10px 14px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.api-table td {
  padding: 12px 14px;
  font-size: 13px;
  border-bottom: 1px solid #f0f2f5;
  vertical-align: middle;
}
.api-table tr:hover td { background: #fafbfc; }

.api-id {
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 12px;
  background: #f0f2f5;
  padding: 2px 8px;
  border-radius: 4px;
  color: var(--text2);
}

/* Category badges */
.cat-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}
.cat-biz { background: #eef2ff; color: var(--cat-biz); }
.cat-prd { background: #ecfeff; color: var(--cat-prd); }
.cat-mat { background: #f0fdf4; color: var(--cat-mat); }
.cat-chg { background: #fffbeb; color: var(--cat-chg); }

/* Progress bar */
.progress-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}
.progress-bar {
  flex: 1;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  min-width: 80px;
}
.progress-fill {
  height: 100%;
  border-radius: 4px;
  transition: width .5s ease;
}
.progress-fill.full { background: var(--success); }
.progress-fill.partial { background: var(--warning); }
.progress-fill.zero { background: #e5e7eb; }
.progress-pct {
  font-size: 12px;
  font-weight: 600;
  min-width: 42px;
  text-align: right;
}

/* Status badge */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.status-completed { background: var(--success-light); color: var(--success); }
.status-progress { background: var(--warning-light); color: #b45309; }
.status-waiting { background: #f3f4f6; color: var(--text3); }

.count-cell {
  font-variant-numeric: tabular-nums;
  font-weight: 500;
}

.time-cell {
  font-size: 12px;
  color: var(--text2);
  white-space: nowrap;
}

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast {
  position: fixed;
  top: 80px;
  right: 24px;
  background: #1a2332;
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 13px;
  box-shadow: var(--shadow-lg);
  transform: translateX(120%);
  transition: transform .3s;
  z-index: 999;
}
.toast.show { transform: translateX(0); }

/* â”€â”€â”€ Loading â”€â”€â”€ */
.loading {
  text-align: center;
  padding: 60px;
  color: var(--text3);
}
.loading::before {
  content: '';
  display: block;
  width: 32px;
  height: 32px;
  border: 3px solid #e5e7eb;
  border-top-color: var(--primary);
  border-radius: 50%;
  margin: 0 auto 12px;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ Auto refresh indicator â”€â”€â”€ */
.refresh-info {
  font-size: 12px;
  color: rgba(255,255,255,.6);
}

@media (max-width: 768px) {
  .container { padding: 16px; }
  .header { padding: 16px; }
  .summary-row { grid-template-columns: repeat(2, 1fr); }
  .api-table { font-size: 12px; }
  .api-table th, .api-table td { padding: 8px 10px; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <h1>ğŸ”„ API ê°±ì‹  í˜„í™© <span>BioFoodLab ê´€ë¦¬ì</span></h1>
    <div class="header-actions">
      <span class="refresh-info" id="refreshInfo">30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ </span>
      <button class="btn btn-outline btn-sm" onclick="loadData()">â†» ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn btn-success btn-sm" id="btnAutoCollect" onclick="triggerCollect('auto')">
        â–¶ ìë™ ìˆ˜ì§‘ ì‹œì‘
      </button>
      <a href="/admin" class="btn btn-outline btn-sm">â† ì„¤ì •ìœ¼ë¡œ</a>
    </div>
  </div>
</div>

<div class="container">
  <!-- Summary -->
  <div class="summary-row" id="summaryRow">
    <div class="summary-card">
      <div class="num" id="totalApis">-</div>
      <div class="label">ì „ì²´ API</div>
    </div>
    <div class="summary-card completed">
      <div class="num" id="completedApis">-</div>
      <div class="label">ìˆ˜ì§‘ ì™„ë£Œ</div>
    </div>
    <div class="summary-card progress">
      <div class="num" id="progressApis">-</div>
      <div class="label">ìˆ˜ì§‘ ì¤‘</div>
    </div>
    <div class="summary-card waiting">
      <div class="num" id="waitingApis">-</div>
      <div class="label">ë¯¸ì‹œì‘</div>
    </div>
    <div class="summary-card">
      <div class="num" id="totalRecords">-</div>
      <div class="label">ì´ DB ê±´ìˆ˜</div>
    </div>
  </div>

  <!-- API Table -->
  <div class="card">
    <div class="card-header">
      <h2>APIë³„ ìˆ˜ì§‘ í˜„í™©</h2>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" onclick="triggerCollect('auto')">ğŸ”„ ì „ì²´ ìë™ê°±ì‹ </button>
        <button class="btn btn-warning btn-sm" onclick="triggerCollect('resume')">â© ì´ì–´ì„œ ìˆ˜ì§‘</button>
      </div>
    </div>
    <div id="tableWrap">
      <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var API_BASE = window.location.origin;
var refreshTimer = null;

var CAT_MAP = {
  'fss_businesses': { label: 'ì—…ì†Œì¸í—ˆê°€', cls: 'cat-biz' },
  'fss_products':   { label: 'í’ˆëª©ì œì¡°', cls: 'cat-prd' },
  'fss_materials':  { label: 'ì›ì¬ë£Œ', cls: 'cat-mat' },
  'fss_changes':    { label: 'ë³€ê²½ì´ë ¥', cls: 'cat-chg' },
};

function numberFormat(n) {
  if (n === null || n === undefined) return '-';
  return Number(n).toLocaleString('ko-KR');
}

function formatTime(dtStr) {
  if (!dtStr || dtStr === 'None') return '-';
  var d = new Date(dtStr);
  var mm = String(d.getMonth()+1).padStart(2,'0');
  var dd = String(d.getDate()).padStart(2,'0');
  var hh = String(d.getHours()).padStart(2,'0');
  var mi = String(d.getMinutes()).padStart(2,'0');
  return mm + '/' + dd + ' ' + hh + ':' + mi;
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}

function loadData() {
  fetch(API_BASE + '/api/collect/detail')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data.success) {
        showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        return;
      }
      renderSummary(data.apis);
      renderTable(data.apis);
      document.getElementById('refreshInfo').textContent =
        'ë§ˆì§€ë§‰ ê°±ì‹ : ' + new Date().toLocaleTimeString('ko-KR') + ' (30ì´ˆë§ˆë‹¤)';
    })
    .catch(function(e) {
      showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message);
    });
}

function renderSummary(apis) {
  var completed = 0, progress = 0, waiting = 0, totalRec = 0;
  apis.forEach(function(a) {
    if (a.status === 'completed') completed++;
    else if (a.status === 'in_progress') progress++;
    else waiting++;
    totalRec += a.db_count || 0;
  });
  document.getElementById('totalApis').textContent = apis.length;
  document.getElementById('completedApis').textContent = completed;
  document.getElementById('progressApis').textContent = progress;
  document.getElementById('waitingApis').textContent = waiting;
  document.getElementById('totalRecords').textContent = numberFormat(totalRec);
}

function renderTable(apis) {
  var html = '<table class="api-table">';
  html += '<thead><tr>'
    + '<th>API</th>'
    + '<th>ì´ë¦„</th>'
    + '<th>ë¶„ë¥˜</th>'
    + '<th style="text-align:right">DB ê±´ìˆ˜</th>'
    + '<th style="text-align:right">API ì´ê±´ìˆ˜</th>'
    + '<th>ì§„í–‰ë¥ </th>'
    + '<th>ìƒíƒœ</th>'
    + '<th>ìµœê·¼ ìˆ˜ì§‘</th>'
    + '<th>ì†Œìš”ì‹œê°„</th>'
    + '</tr></thead><tbody>';

  apis.forEach(function(a) {
    var cat = CAT_MAP[a.table] || { label: '-', cls: '' };
    var apiTotal = a.last_api_total || 0;
    var pct = apiTotal > 0 ? Math.min(100, (a.db_count / apiTotal * 100)) : 0;
    var pctStr = apiTotal > 0 ? pct.toFixed(1) + '%' : '-';
    var fillCls = pct >= 100 ? 'full' : (pct > 0 ? 'partial' : 'zero');

    var statusHtml = '';
    if (a.status === 'completed') {
      statusHtml = '<span class="status-badge status-completed">âœ… ì™„ë£Œ</span>';
    } else if (a.status === 'in_progress') {
      statusHtml = '<span class="status-badge status-progress">ğŸ”„ ìˆ˜ì§‘ì¤‘</span>';
    } else {
      statusHtml = '<span class="status-badge status-waiting">â¬œ ë¯¸ì‹œì‘</span>';
    }

    var lastTime = '-';
    var duration = '-';
    if (a.last_collect) {
      lastTime = formatTime(a.last_collect.started_at);
      duration = a.last_collect.duration_sec !== null
        ? (a.last_collect.duration_sec >= 60
            ? Math.floor(a.last_collect.duration_sec/60) + 'ë¶„'
            : a.last_collect.duration_sec + 'ì´ˆ')
        : '-';
      if (a.last_collect.error_msg) {
        lastTime += ' <span style="color:var(--danger);font-size:11px;" title="'
          + a.last_collect.error_msg + '">âš ï¸</span>';
      }
    }

    html += '<tr>'
      + '<td><span class="api-id">' + a.api_source + '</span></td>'
      + '<td>' + a.name + '</td>'
      + '<td><span class="cat-badge ' + cat.cls + '">' + cat.label + '</span></td>'
      + '<td class="count-cell" style="text-align:right">' + numberFormat(a.db_count) + '</td>'
      + '<td class="count-cell" style="text-align:right">' + numberFormat(apiTotal || null) + '</td>'
      + '<td><div class="progress-wrap">'
      +   '<div class="progress-bar"><div class="progress-fill ' + fillCls + '" style="width:' + pct + '%"></div></div>'
      +   '<span class="progress-pct">' + pctStr + '</span>'
      + '</div></td>'
      + '<td>' + statusHtml + '</td>'
      + '<td class="time-cell">' + lastTime + '</td>'
      + '<td class="time-cell">' + duration + '</td>'
      + '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('tableWrap').innerHTML = html;
}

function triggerCollect(mode) {
  var btn = document.getElementById('btnAutoCollect');
  btn.disabled = true;
  btn.textContent = 'â³ ìˆ˜ì§‘ ì‹¤í–‰ ì¤‘...';

  fetch(API_BASE + '/api/admin/collect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ mode: mode })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.success) {
      showToast('ìˆ˜ì§‘ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (' + mode + ')');
    } else {
      showToast('ìˆ˜ì§‘ ì‹œì‘ ì‹¤íŒ¨: ' + (data.error || ''));
    }
    setTimeout(function() {
      btn.disabled = false;
      btn.textContent = 'â–¶ ìë™ ìˆ˜ì§‘ ì‹œì‘';
    }, 5000);
  })
  .catch(function(e) {
    showToast('ì„œë²„ ì˜¤ë¥˜: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'â–¶ ìë™ ìˆ˜ì§‘ ì‹œì‘';
  });
}

// ì´ˆê¸° ë¡œë“œ ë° ìë™ ê°±ì‹ 
loadData();
refreshTimer = setInterval(loadData, 30000);
</script>
</body>
</html>
