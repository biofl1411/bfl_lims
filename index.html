<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ëŒ€ì‹œë³´ë“œ</title>
<style>
:root {
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --success: #10b981;
  --success-light: #d1fae5;
  --warning: #f59e0b;
  --danger: #ef4444;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-900: #111827;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
  background: #f5f5f5;
  color: #1a1a1a;
}
.app-layout { display: flex; height: 100vh; }

/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */

.main-container {
  flex: 1;
  margin-left: 250px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.top-header {
  background: white;
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.page-title { font-size: 20px; font-weight: 700; }
.header-date { font-size: 13px; color: var(--gray-600); }
.main-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

/* KPI ì¹´ë“œ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: transform 0.15s;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.stat-icon {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
}
.stat-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 4px;
}
.stat-unit { font-size: 14px; font-weight: 400; color: var(--gray-600); }
.stat-label {
  font-size: 13px;
  color: var(--gray-600);
}
.stat-change {
  font-size: 12px;
  font-weight: 500;
  margin-top: 6px;
}
.stat-change.up { color: var(--success); }
.stat-change.down { color: var(--danger); }
.stat-change.neutral { color: var(--gray-600); }

/* ì¹´ë“œ */
.content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  padding: 20px;
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--gray-200);
}
.card-title {
  font-size: 15px;
  font-weight: 700;
}
.btn-link {
  color: var(--primary);
  text-decoration: none;
  font-size: 12px;
  font-weight: 500;
}
.btn-link:hover { text-decoration: underline; }

/* í…Œì´ë¸” */
.table-simple { width: 100%; border-collapse: collapse; }
.table-simple th {
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-600);
  padding: 10px 8px;
  border-bottom: 2px solid var(--gray-200);
}
.table-simple td {
  padding: 10px 8px;
  font-size: 13px;
  border-bottom: 1px solid var(--gray-100);
}
.table-simple tr:hover { background: var(--gray-50); }
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.badge-complete { background: #e8f5e9; color: #2e7d32; }
.badge-waiting { background: #fff3e0; color: #e65100; }
.badge-inprogress { background: #e3f2fd; color: #1565c0; }

/* ì‹ í˜¸ë“± ë¶„í¬ */
.tl-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.tl-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  flex-shrink: 0;
}
.tl-dot-green { background: #4caf50; }
.tl-dot-blue { background: #2196f3; }
.tl-dot-yellow { background: #ffeb3b; border: 1px solid #e0e0e0; }
.tl-dot-orange { background: #ff9800; }
.tl-dot-red { background: #f44336; }
.tl-label { font-size: 12px; color: var(--gray-600); width: 40px; }
.tl-bar-bg {
  flex: 1;
  height: 22px;
  background: var(--gray-100);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.tl-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}
.tl-count {
  font-size: 12px;
  font-weight: 600;
  width: 30px;
  text-align: right;
}
.tl-summary {
  margin-top: 14px;
  padding-top: 12px;
  border-top: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--gray-600);
}
.tl-summary strong { color: var(--danger); font-size: 14px; }

/* ë¶„ì•¼ë³„ ì ‘ìˆ˜ */
.field-item {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}
.field-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
.field-info { flex: 1; }
.field-name { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
.field-detail { font-size: 11px; color: var(--gray-600); }
.field-bar-bg {
  height: 8px;
  background: var(--gray-100);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 6px;
}
.field-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}
.field-val { font-size: 14px; font-weight: 700; min-width: 60px; text-align: right; }

/* ê³µì§€ì‚¬í•­ */
.notice-item {
  padding: 12px 0;
  border-bottom: 1px solid var(--gray-100);
  cursor: pointer;
}
.notice-item:hover { background: var(--gray-50); padding-left: 8px; }
.notice-title {
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 3px;
}
.notice-meta {
  font-size: 11px;
  color: var(--gray-600);
}

/* ë¡œë”© */
.dash-loading {
  text-align: center;
  padding: 20px;
  color: #999;
  font-size: 13px;
}
</style>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>
<script src="js/sidebar.js?v=2"></script>
</head>
<body>

<div class="app-layout">
  <aside class="sidebar" id="sidebar"></aside>

  <div class="main-container">
    <header class="top-header">
      <div class="page-title">ëŒ€ì‹œë³´ë“œ</div>
      <div class="header-date" id="header-date"></div>
    </header>
    <main class="main-content">
      <!-- KPI ì¹´ë“œ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background:#e3f2fd;color:#1565c0;">ğŸ“</div>
          </div>
          <div class="stat-value" style="color:#1565c0;" id="kpi-receipt-count">-</div>
          <div class="stat-label">ì´ë²ˆ ë‹¬ ì ‘ìˆ˜ ì—…ì²´</div>
          <div class="stat-change neutral" id="kpi-receipt-change">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background:#d1fae5;color:#059669;">ğŸ’°</div>
          </div>
          <div class="stat-value" style="color:#059669;" id="kpi-revenue">-</div>
          <div class="stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
          <div class="stat-change neutral" id="kpi-revenue-change">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background:#fee2e2;color:#dc2626;">ğŸ”´</div>
          </div>
          <div class="stat-value" style="color:#dc2626;" id="kpi-receivable">-</div>
          <div class="stat-label">ë¯¸ìˆ˜ê¸ˆ í˜„í™©</div>
          <div class="stat-change neutral" id="kpi-receivable-detail">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background:#ede9fe;color:#7c3aed;">ğŸ¢</div>
          </div>
          <div class="stat-value" style="color:#7c3aed;" id="kpi-company-count">-</div>
          <div class="stat-label">ë“±ë¡ ê±°ë˜ì²˜</div>
          <div class="stat-change neutral" id="kpi-company-detail">ë¡œë”© ì¤‘...</div>
        </div>
      </div>

      <!-- ìµœê·¼ ì ‘ìˆ˜ & ì‹ í˜¸ë“± ë¶„í¬ -->
      <div class="content-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“‹ ìµœê·¼ ì ‘ìˆ˜ í˜„í™©</div>
            <a href="receiptStatus.html" class="btn-link">ì „ì²´ë³´ê¸° â†’</a>
          </div>
          <div id="recent-receipts-area">
            <div class="dash-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸš¦ ê±°ë˜ì²˜ ì‹ í˜¸ë“± ë¶„í¬</div>
            <a href="salesMgmt.html" class="btn-link">ê³ ê°ì‚¬ ê´€ë¦¬ â†’</a>
          </div>
          <div id="traffic-light-area">
            <div class="dash-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>

      <!-- ë¶„ì•¼ë³„ í˜„í™© & ê³µì§€ì‚¬í•­ -->
      <div class="content-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“Š ë¶„ì•¼ë³„ ì ‘ìˆ˜ í˜„í™© (ì´ë²ˆ ë‹¬)</div>
          </div>
          <div id="field-breakdown-area">
            <div class="dash-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
          </div>
          <div>
            <div class="notice-item">
              <div class="notice-title">[ê³µì§€] 2ì›” ì‹œì•½ ì¬ê³  ì ê²€ ì•ˆë‚´</div>
              <div class="notice-meta">2026-02-15 Â· ê´€ë¦¬íŒ€</div>
            </div>
            <div class="notice-item">
              <div class="notice-title">[ì¤‘ìš”] ê²€ì‚¬ ì¼ì • ë³€ê²½ ì•ˆë‚´</div>
              <div class="notice-meta">2026-02-14 Â· ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤</div>
            </div>
            <div class="notice-item">
              <div class="notice-title">ì„¤ë‚  ì—°íœ´ ì—…ë¬´ ì•ˆë‚´</div>
              <div class="notice-meta">2026-02-10 Â· ê²½ì˜ì§€ì›ì‹¤</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// ============================================================================
// ë³µí•© ë§¤ì¹­ ë§µ (receiptStatus.html ë™ì¼ íŒ¨í„´)
// ============================================================================
var _companyByBizNo = {};
var _companyByLicNo = {};
var _companyByLicName = {};
var _companyByName = {};
var _companyReceivables = {};
var _companyTrafficLight = {};

function buildCompanyMaps(companies) {
    _companyByBizNo = {}; _companyByLicNo = {}; _companyByLicName = {}; _companyByName = {};
    companies.forEach(function(c) {
        if (c.bizNo) _companyByBizNo[c.bizNo.trim()] = c;
        var name = (c.company || c.name || '').trim();
        if (name) _companyByName[name] = c;
        (c.licenses || []).forEach(function(lic) {
            if (lic.licNo) _companyByLicNo[lic.licNo.trim()] = c;
            if (lic.licBizName) _companyByLicName[lic.licBizName.trim()] = c;
        });
    });
}

function findCompanyForReceipt(r) {
    return _companyByBizNo[(r.bizNo || '').trim()]
        || _companyByLicNo[(r.licNo || '').trim()]
        || _companyByLicName[(r.companyName || '').trim()]
        || _companyByName[(r.companyName || '').trim()]
        || null;
}

function getSignalRules() {
    return JSON.parse(localStorage.getItem('bfl_signal_rules') || 'null') || {
        green:30, blueMin:31, blueMax:60, yellowMin:61, yellowMax:90,
        orangeMin:91, orangeMax:120, redMin:121
    };
}

function calcTrafficLight(receivableInfo) {
    if (!receivableInfo || receivableInfo.totalAmount === 0 || !receivableInfo.oldestDate) return 'green';
    var debtStart = new Date(receivableInfo.oldestDate);
    var now = new Date();
    var days = Math.floor((now - debtStart) / (1000 * 60 * 60 * 24));
    var rules = getSignalRules();
    if (days <= rules.green) return 'green';
    if (days <= rules.blueMax) return 'blue';
    if (days <= rules.yellowMax) return 'yellow';
    if (days <= rules.orangeMax) return 'orange';
    return 'red';
}

// ============================================================================
// ì²œì› ë‹¨ìœ„ í¬ë§·
// ============================================================================
function formatThousand(val) {
    var v = Math.round(val / 1000);
    return v.toLocaleString() + 'ì²œì›';
}

// ============================================================================
// ëŒ€ì‹œë³´ë“œ ë¡œë“œ
// ============================================================================
async function loadDashboard() {
    // ë‚ ì§œ í‘œì‹œ
    var now = new Date();
    var ymd = now.toISOString().slice(0, 10);
    var dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    document.getElementById('header-date').textContent = ymd + ' (' + dayNames[now.getDay()] + ')';

    try {
        await waitForFirebase();
    } catch(e) {
        console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        return;
    }

    var companies = [];
    var receipts = [];
    try {
        companies = await fsGetCompanies({ limit: 5000 });
        receipts = await fsGetReceipts({ limit: 5000 });
    } catch(e) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // ë³µí•© ë§¤ì¹­ ë§µ êµ¬ì¶•
    buildCompanyMaps(companies);

    // ë¯¸ìˆ˜ê¸ˆ ì§‘ê³„
    _companyReceivables = {};
    receipts.forEach(function(r) {
        var cust = findCompanyForReceipt(r);
        if (!cust) return;
        var key = cust.id || (cust.company || '').trim();
        if (!_companyReceivables[key]) _companyReceivables[key] = { oldestDate: null, totalAmount: 0 };
        var fee = r.feeTotal || 0;
        if (fee > 0 && !r.payDate) {
            _companyReceivables[key].totalAmount += fee;
            var rd = r.receiptDate || '';
            if (rd && (!_companyReceivables[key].oldestDate || rd < _companyReceivables[key].oldestDate)) {
                _companyReceivables[key].oldestDate = rd;
            }
        }
    });

    // ì‹ í˜¸ë“± ê³„ì‚°
    _companyTrafficLight = {};
    companies.forEach(function(c) {
        var key = c.id || (c.company || '').trim();
        _companyTrafficLight[key] = calcTrafficLight(_companyReceivables[key]);
    });

    // ë Œë”ë§
    renderKPICards(receipts, companies);
    renderRecentReceipts(receipts);
    renderTrafficLightChart(companies);
    renderFieldBreakdown(receipts);
}

// ============================================================================
// KPI ì¹´ë“œ
// ============================================================================
function renderKPICards(receipts, companies) {
    var now = new Date();
    var thisMonth = now.toISOString().slice(0, 7); // YYYY-MM
    var prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    var prevMonth = prevDate.toISOString().slice(0, 7);

    var thisMonthReceipts = receipts.filter(function(r) { return (r.receiptDate || '').slice(0, 7) === thisMonth; });
    var prevMonthReceipts = receipts.filter(function(r) { return (r.receiptDate || '').slice(0, 7) === prevMonth; });

    // ì´ë²ˆ ë‹¬ ì ‘ìˆ˜ â€” ì—…ì²´ ìˆ˜ + ì œí’ˆ(ì‹œë£Œ) ìˆ˜
    var thisCompanySet = {};
    var thisSampleCount = 0;
    thisMonthReceipts.forEach(function(r) {
        var cn = r.companyName || r.bizNo || 'unknown';
        thisCompanySet[cn] = true;
        thisSampleCount += (r.samples && r.samples.length > 0) ? r.samples.length : 1;
    });
    var thisCompanyCount = Object.keys(thisCompanySet).length;

    var prevCompanySet = {};
    prevMonthReceipts.forEach(function(r) {
        var cn = r.companyName || r.bizNo || 'unknown';
        prevCompanySet[cn] = true;
    });
    var prevCompanyCount = Object.keys(prevCompanySet).length;

    document.getElementById('kpi-receipt-count').innerHTML = thisCompanyCount + '<span class="stat-unit">ê°œì†Œ</span>';
    document.getElementById('kpi-receipt-change').textContent = 'ì œí’ˆ ' + thisSampleCount + 'ê±´'
        + (prevCompanyCount > 0 ? ' Â· ì „ì›” ' + prevCompanyCount + 'ê°œì†Œ' : '');
    document.getElementById('kpi-receipt-change').className = 'stat-change ' + (thisCompanyCount >= prevCompanyCount ? 'up' : 'neutral');

    // ì´ë²ˆ ë‹¬ ë§¤ì¶œ
    var thisRevenue = thisMonthReceipts.reduce(function(s, r) { return s + (r.feeTotal || 0); }, 0);
    var prevRevenue = prevMonthReceipts.reduce(function(s, r) { return s + (r.feeTotal || 0); }, 0);
    document.getElementById('kpi-revenue').innerHTML = formatThousand(thisRevenue);
    if (prevRevenue > 0) {
        var pct = Math.round((thisRevenue - prevRevenue) / prevRevenue * 100);
        document.getElementById('kpi-revenue-change').textContent = (pct >= 0 ? 'â–²' : 'â–¼') + ' ' + Math.abs(pct) + '% ì „ì›” ëŒ€ë¹„';
        document.getElementById('kpi-revenue-change').className = 'stat-change ' + (pct >= 0 ? 'up' : 'down');
    } else {
        document.getElementById('kpi-revenue-change').textContent = 'ì „ì›”: ' + formatThousand(prevRevenue);
        document.getElementById('kpi-revenue-change').className = 'stat-change neutral';
    }

    // ë¯¸ìˆ˜ê¸ˆ
    var totalReceivable = 0;
    var receivableCount = 0;
    for (var k in _companyReceivables) {
        if (_companyReceivables[k].totalAmount > 0) {
            totalReceivable += _companyReceivables[k].totalAmount;
            receivableCount++;
        }
    }
    document.getElementById('kpi-receivable').innerHTML = formatThousand(totalReceivable);
    document.getElementById('kpi-receivable-detail').textContent = receivableCount + 'ê°œ ì—…ì²´ ë¯¸ìˆ˜ê¸ˆ';
    document.getElementById('kpi-receivable-detail').className = 'stat-change ' + (receivableCount > 0 ? 'down' : 'up');

    // ë“±ë¡ ê±°ë˜ì²˜
    var activeCount = companies.filter(function(c) { return c.status === 'í™œë™' || !c.status; }).length;
    document.getElementById('kpi-company-count').innerHTML = companies.length + '<span class="stat-unit">ê°œ</span>';
    document.getElementById('kpi-company-detail').textContent = 'í™œë™ ' + activeCount + 'ê°œ';
    document.getElementById('kpi-company-detail').className = 'stat-change up';
}

// ============================================================================
// ìµœê·¼ ì ‘ìˆ˜ í˜„í™©
// ============================================================================
function renderRecentReceipts(receipts) {
    var sorted = receipts.slice().sort(function(a, b) {
        return (b.receiptDate || '').localeCompare(a.receiptDate || '');
    });
    var top5 = sorted.slice(0, 5);

    if (top5.length === 0) {
        document.getElementById('recent-receipts-area').innerHTML = '<div class="dash-loading">ì ‘ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    var html = '<table class="table-simple"><thead><tr>';
    html += '<th>ì ‘ìˆ˜ë²ˆí˜¸</th><th>ê±°ë˜ì²˜</th><th>ê²€ì‚¬ëª©ì </th><th>ì ‘ìˆ˜ì¼</th><th>ìƒíƒœ</th>';
    html += '</tr></thead><tbody>';

    top5.forEach(function(r) {
        var statusCls = r.status === 'ì ‘ìˆ˜ì™„ë£Œ' ? 'badge-complete' : r.status === 'ì ‘ìˆ˜ì¤‘' ? 'badge-inprogress' : 'badge-waiting';
        html += '<tr>';
        html += '<td style="font-weight:600">' + (r.receiptNo || '-') + '</td>';
        html += '<td>' + (r.companyName || '-') + '</td>';
        html += '<td>' + (r.testPurpose || '-') + '</td>';
        html += '<td>' + (r.receiptDate || '-') + '</td>';
        html += '<td><span class="badge ' + statusCls + '">' + (r.status || 'ëŒ€ê¸°ì¤‘') + '</span></td>';
        html += '</tr>';
    });

    html += '</tbody></table>';
    document.getElementById('recent-receipts-area').innerHTML = html;
}

// ============================================================================
// ì‹ í˜¸ë“± ë¶„í¬
// ============================================================================
function renderTrafficLightChart(companies) {
    var dist = { green: 0, blue: 0, yellow: 0, orange: 0, red: 0 };
    var total = companies.length;

    companies.forEach(function(c) {
        var key = c.id || (c.company || '').trim();
        var tl = _companyTrafficLight[key] || 'green';
        dist[tl] = (dist[tl] || 0) + 1;
    });

    var colors = { green: '#4caf50', blue: '#2196f3', yellow: '#ffeb3b', orange: '#ff9800', red: '#f44336' };
    var labels = { green: 'ì •ìƒ', blue: 'ì–‘í˜¸', yellow: 'ì£¼ì˜', orange: 'ê²½ê³ ', red: 'ìœ„í—˜' };
    var order = ['green', 'blue', 'yellow', 'orange', 'red'];

    var html = '';
    order.forEach(function(tl) {
        var count = dist[tl];
        var pct = total > 0 ? Math.round(count / total * 100) : 0;
        html += '<div class="tl-bar-row">';
        html += '<div class="tl-dot tl-dot-' + tl + '"></div>';
        html += '<div class="tl-label">' + labels[tl] + '</div>';
        html += '<div class="tl-bar-bg"><div class="tl-bar-fill" style="width:' + pct + '%;background:' + colors[tl] + '"></div></div>';
        html += '<div class="tl-count">' + count + '</div>';
        html += '</div>';
    });

    // ë¯¸ìˆ˜ê¸ˆ í•©ê³„
    var totalReceivable = 0;
    var receivableCount = 0;
    for (var k in _companyReceivables) {
        if (_companyReceivables[k].totalAmount > 0) {
            totalReceivable += _companyReceivables[k].totalAmount;
            receivableCount++;
        }
    }
    html += '<div class="tl-summary">';
    html += '<span>ë¯¸ìˆ˜ê¸ˆ ì—…ì²´: <strong>' + receivableCount + 'ê°œ</strong></span>';
    html += '<span>ë¯¸ìˆ˜ê¸ˆ í•©ê³„: <strong>' + formatThousand(totalReceivable) + '</strong></span>';
    html += '</div>';

    document.getElementById('traffic-light-area').innerHTML = html;
}

// ============================================================================
// ë¶„ì•¼ë³„ ì ‘ìˆ˜ í˜„í™©
// ============================================================================
function renderFieldBreakdown(receipts) {
    var now = new Date();
    var thisMonth = now.toISOString().slice(0, 7);
    var thisMonthReceipts = receipts.filter(function(r) { return (r.receiptDate || '').slice(0, 7) === thisMonth; });

    var fields = {};
    thisMonthReceipts.forEach(function(r) {
        var f = r.testField || 'ê¸°íƒ€';
        if (!fields[f]) fields[f] = { count: 0, revenue: 0 };
        fields[f].count++;
        fields[f].revenue += (r.feeTotal || 0);
    });

    var totalCount = thisMonthReceipts.length || 1;
    var fieldKeys = Object.keys(fields).sort(function(a, b) { return fields[b].count - fields[a].count; });

    if (fieldKeys.length === 0) {
        document.getElementById('field-breakdown-area').innerHTML = '<div class="dash-loading">ì´ë²ˆ ë‹¬ ì ‘ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    var fieldColors = { 'ì‹í’ˆ': '#1565c0', 'ì¶•ì‚°': '#e65100', 'í™˜ê²½': '#2e7d32', 'ê¸°íƒ€': '#7b1fa2' };
    var fieldIcons = { 'ì‹í’ˆ': 'ğŸ±', 'ì¶•ì‚°': 'ğŸ¥©', 'í™˜ê²½': 'ğŸŒ¿', 'ê¸°íƒ€': 'ğŸ“‹' };

    var html = '';
    fieldKeys.forEach(function(f) {
        var d = fields[f];
        var pct = Math.round(d.count / totalCount * 100);
        var color = fieldColors[f] || '#5f6b7a';
        var icon = fieldIcons[f] || 'ğŸ“‹';

        html += '<div class="field-item">';
        html += '<div class="field-icon" style="background:' + color + '15;color:' + color + '">' + icon + '</div>';
        html += '<div class="field-info">';
        html += '<div class="field-name">' + f + ' ê²€ì‚¬</div>';
        html += '<div class="field-detail">' + d.count + 'ê±´ Â· ' + formatThousand(d.revenue) + '</div>';
        html += '<div class="field-bar-bg"><div class="field-bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>';
        html += '</div>';
        html += '<div class="field-val" style="color:' + color + '">' + pct + '%</div>';
        html += '</div>';
    });

    document.getElementById('field-breakdown-area').innerHTML = html;
}

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
window.onload = function() {
    loadDashboard();
};
</script>
</body>
</html>
