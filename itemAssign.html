<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab - í•­ëª©ë°°ì •</title>
<style>
:root {
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --success: #10b981;
  --success-light: #d1fae5;
  --warning: #f59e0b;
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-900: #111827;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
  background: #f5f5f5;
  color: #1a1a1a;
}

.app-layout { display: flex; height: 100vh; }

/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */

.main-container {
  flex: 1;
  margin-left: 250px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.top-header {
  background: white;
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #64748b;
}

.breadcrumb-current { color: #1e293b; font-weight: 600; }

.main-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.page-header {
  background: white;
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.page-header h1 { font-size: 24px; margin-bottom: 8px; }
.page-header p { color: #64748b; font-size: 14px; }

.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin-bottom: 12px;
}

.stat-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
.stat-label { font-size: 13px; color: #64748b; }

.toolbar {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toolbar-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 12px;
}

.toolbar-row:last-child { margin-bottom: 0; }

.filter-group {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filter-label {
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  min-width: 60px;
}

.filter-chips {
  display: flex;
  gap: 8px;
}

.filter-chip {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  background: var(--gray-100);
  color: var(--gray-700);
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.filter-chip:hover { background: var(--gray-200); }
.filter-chip.active {
  background: var(--primary-light);
  color: var(--primary);
  border-color: var(--primary);
}

.search-box {
  flex: 1;
  min-width: 250px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 10px 16px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 14px;
}

.btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
}

.btn-primary { background: var(--primary); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-warning { background: var(--warning); color: white; }
.btn-outline { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }

.table-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
}

table { width: 100%; border-collapse: collapse; }

thead {
  background: var(--gray-50);
  border-bottom: 2px solid var(--gray-200);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 12px 16px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
}

tbody tr {
  border-bottom: 1px solid var(--gray-100);
  transition: background 0.2s;
}

tbody tr:hover { background: var(--gray-50); }
tbody tr.unassigned { background: var(--danger-light); }
tbody tr.selected { background: var(--primary-light); }

td {
  padding: 14px 16px;
  font-size: 14px;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.badge-primary { background: var(--primary-light); color: var(--primary); }
.badge-success { background: var(--success-light); color: var(--success); }
.badge-warning { background: #fef3c7; color: var(--warning); }
.badge-danger { background: var(--danger-light); color: var(--danger); }

.manager-select {
  width: 100%;
  padding: 8px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 13px;
}

.manager-select.unassigned {
  border-color: var(--danger);
  background: var(--danger-light);
}

.btn-sm { padding: 6px 12px; font-size: 12px; }

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active { display: flex; }

.modal {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow: hidden;
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
}

.modal-title { font-size: 18px; font-weight: 700; }
.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
}

.modal-body { padding: 24px; max-height: 60vh; overflow-y: auto; }

.form-group { margin-bottom: 20px; }
.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--gray-700);
}

.form-input, .form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 14px;
}

.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--gray-200);
}

.timeline-item {
  position: relative;
  padding-bottom: 20px;
}

.timeline-dot {
  position: absolute;
  left: -26px;
  top: 4px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--primary);
  border: 2px solid white;
}

.timeline-content {
  background: var(--gray-50);
  padding: 12px;
  border-radius: 8px;
  border-left: 3px solid var(--primary);
}

.alert {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.alert-success { background: var(--success-light); color: #065f46; }
.alert-warning { background: #fef3c7; color: #92400e; }
.alert-info { background: var(--primary-light); color: #1e40af; }

</style>
</head>
<body>

<div class="app-layout">
  <aside class="sidebar" id="sidebar"></aside>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="js/firebase-init.js"></script>
  <script src="js/sidebar.js?v=2"></script>

  <div class="main-container">
    <header class="top-header">
      <div class="breadcrumb">
        <span>ì‹œí—˜ ê²°ì¬</span>
        <span>â€º</span>
        <span class="breadcrumb-current">í•­ëª©ë°°ì •</span>
      </div>
    </header>
    <main class="main-content">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e8eaf6; color: #3949ab;">ğŸ“‹</div>
          <div class="stat-value" style="color: #3949ab;" id="stat-total">0</div>
          <div class="stat-label">ì „ì²´ í•­ëª©</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: var(--success-light); color: var(--success);">âœ…</div>
          <div class="stat-value" style="color: var(--success);" id="stat-assigned">0</div>
          <div class="stat-label">ë°°ì • ì™„ë£Œ</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: var(--danger-light); color: var(--danger);">âš ï¸</div>
          <div class="stat-value" style="color: var(--danger);" id="stat-unassigned">0</div>
          <div class="stat-label">ë¯¸ë°°ì •</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: #fef3c7; color: var(--warning);">ğŸ‘¥</div>
          <div class="stat-value" style="color: var(--warning);" id="stat-managers">0</div>
          <div class="stat-label">ë‹´ë‹¹ì ìˆ˜</div>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-row">
          <div class="filter-group">
            <div class="filter-label">ë¶„ì•¼</div>
            <div class="filter-chips">
              <button class="filter-chip active" onclick="filterByDivision('ì „ì²´')">ì „ì²´</button>
              <button class="filter-chip" onclick="filterByDivision('ì‹í’ˆ')">ğŸ± ì‹í’ˆ</button>
              <button class="filter-chip" onclick="filterByDivision('ì¶•ì‚°')">ğŸ¥© ì¶•ì‚°</button>
            </div>
          </div>

          <div class="filter-group" style="margin-left: auto;">
            <div class="filter-label">ìƒíƒœ</div>
            <div class="filter-chips">
              <button class="filter-chip active" onclick="filterByStatus('ì „ì²´')">ì „ì²´</button>
              <button class="filter-chip" onclick="filterByStatus('ë°°ì •')">âœ… ë°°ì •ì™„ë£Œ</button>
              <button class="filter-chip" onclick="filterByStatus('ë¯¸ë°°ì •')">âš ï¸ ë¯¸ë°°ì •</button>
            </div>
          </div>
        </div>

        <div class="toolbar-row">
          <div class="search-box">
            <input type="text" id="search-input" placeholder="í•­ëª©ëª… ê²€ìƒ‰..." oninput="filterData()">
          </div>
          <button class="btn btn-outline" onclick="showBulkAssignModal()">ğŸ“‹ ì¼ê´„ ë°°ì •</button>
          <button class="btn btn-warning" onclick="showTeamChangeModal()">ğŸ”„ íŒ€ ë³€ê²½</button>
          <button class="btn btn-success" onclick="saveAll()">ğŸ’¾ ì „ì²´ ì €ì¥</button>
        </div>
      </div>

      <div id="alert-container"></div>

      <div class="table-container">
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th style="width: 50px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                <th style="width: 60px;">No.</th>
                <th style="width: 80px;">ë¶„ì•¼</th>
                <th>í•­ëª©ëª…</th>
                <th style="width: 250px;">ë‹´ë‹¹ì</th>
                <th style="width: 100px;">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ì¼ê´„ ë°°ì • ëª¨ë‹¬ -->
<div class="modal-overlay" id="bulk-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ì¼ê´„ ë°°ì •</div>
      <button class="modal-close" onclick="closeBulkModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom: 20px;">ì„ íƒí•œ <strong id="selected-count">0</strong>ê°œ í•­ëª©ì— ë‹´ë‹¹ìë¥¼ ì¼ê´„ ë°°ì •í•©ë‹ˆë‹¤.</p>
      
      <div class="form-group">
        <label class="form-label">ë‹´ë‹¹ì ì„ íƒ</label>
        <select class="form-select" id="bulk-manager">
          <option value="">-- ë‹´ë‹¹ì ì„ íƒ --</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closeBulkModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="applyBulkAssign()">ë°°ì • ì ìš©</button>
      </div>
    </div>
  </div>
</div>

<!-- íŒ€ ë³€ê²½ ëª¨ë‹¬ -->
<div class="modal-overlay" id="team-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">íŒ€ ë³€ê²½</div>
      <button class="modal-close" onclick="closeTeamModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ë‹´ë‹¹ì ì„ íƒ</label>
        <select class="form-select" id="team-manager">
          <option value="">-- ë‹´ë‹¹ì ì„ íƒ --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">í˜„ì¬ íŒ€</label>
        <input type="text" class="form-input" id="current-team" readonly>
      </div>
      
      <div class="form-group">
        <label class="form-label">ìƒˆ íŒ€</label>
        <select class="form-select" id="new-team">
          <option value="">-- íŒ€ ì„ íƒ --</option>
          <option value="ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤">ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤</option>
          <option value="ê³ ê°ì§€ì›íŒ€">ê³ ê°ì§€ì›íŒ€</option>
          <option value="í’ˆì§ˆë³´ì¦íŒ€">í’ˆì§ˆë³´ì¦íŒ€</option>
          <option value="ê³ ê°ê´€ë¦¬">ê³ ê°ê´€ë¦¬</option>
          <option value="ê²½ì˜ì§€ì›ì‹¤">ê²½ì˜ì§€ì›ì‹¤</option>
          <option value="ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€">ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€</option>
          <option value="ë§ˆì¼€íŒ…íŒ€">ë§ˆì¼€íŒ…íŒ€</option>
          <option value="ì„ì›">ì„ì›</option>
          <option value="ê´€ë¦¬íŒ€">ê´€ë¦¬íŒ€</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closeTeamModal()">ì·¨ì†Œ</button>
        <button class="btn btn-warning" onclick="applyTeamChange()">íŒ€ ë³€ê²½</button>
      </div>
    </div>
  </div>
</div>

<!-- ë°°ì • ì´ë ¥ ëª¨ë‹¬ -->
<div class="modal-overlay" id="history-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ë°°ì • ì´ë ¥</div>
      <button class="modal-close" onclick="closeHistoryModal()">Ã—</button>
    </div>
    <div class="modal-body" id="history-content">
    </div>
  </div>
</div>

<script>
const MANAGERS = [
  {
    "id": "ê¶Œí˜œì›",
    "name": "ê¶Œí˜œì›",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 1íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ê¹€ê³ ì€",
    "name": "ê¹€ê³ ì€",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 2íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ê¹€ëŒ€ì„±",
    "name": "ê¹€ëŒ€ì„±",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 1íŒ€",
    "position": "ë¯¸ì§€ì •"
  },
  {
    "id": "ê¹€ë¬¸ê¸°",
    "name": "ê¹€ë¬¸ê¸°",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 2íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ê¹€ë²”ì¤€",
    "name": "ê¹€ë²”ì¤€",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 2íŒ€",
    "position": "ëŒ€ë¦¬"
  },
  {
    "id": "ê¹€ì‚¬ë¼",
    "name": "ê¹€ì‚¬ë¼",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 3íŒ€",
    "position": "ê³¼ì¥"
  },
  {
    "id": "ê¹€ì„ í™”",
    "name": "ê¹€ì„ í™”",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 2íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ê¹€ì§€ì˜",
    "name": "ê¹€ì§€ì˜",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 2íŒ€",
    "position": "ê³¼ì¥"
  },
  {
    "id": "ê¹€ì§€ìœ¤",
    "name": "ê¹€ì§€ìœ¤",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 2íŒ€",
    "position": "ê³¼ì¥"
  },
  {
    "id": "ê¹€ì§€ì€",
    "name": "ê¹€ì§€ì€",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 3íŒ€",
    "position": "ê³¼ì¥"
  },
  {
    "id": "ê¹€í˜„ì •",
    "name": "ê¹€í˜„ì •",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 1íŒ€",
    "position": "ì£¼ì„"
  },
  {
    "id": "ë¬¸ìœ ì§„",
    "name": "ë¬¸ìœ ì§„",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 3íŒ€",
    "position": "ëŒ€ë¦¬"
  },
  {
    "id": "ë¬¸íƒœì„±",
    "name": "ë¬¸íƒœì„±",
    "team": "ë¶„ì„ì‹¤",
    "position": "ê³¼ì¥"
  },
  {
    "id": "ë°•ì‹œì€",
    "name": "ë°•ì‹œì€",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 3íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ë°•ì˜ì£¼",
    "name": "ë°•ì˜ì£¼",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 3íŒ€",
    "position": "ë¯¸ì§€ì •"
  },
  {
    "id": "ë°•ì§€ìˆ˜",
    "name": "ë°•ì§€ìˆ˜",
    "team": "ë¶„ì„ì‹¤ ì”ë¥˜ë†ì•½",
    "position": "ì£¼ì„"
  },
  {
    "id": "ë°±ì§€ì—°",
    "name": "ë°±ì§€ì—°",
    "team": "ë¶„ì„ì‹¤ ì”ë¥˜ë†ì•½",
    "position": "ì£¼ì„"
  },
  {
    "id": "ì„œì„¸ì§„",
    "name": "ì„œì„¸ì§„",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 2íŒ€",
    "position": "ì°¨ì¥"
  },
  {
    "id": "ì„œì§„ì˜",
    "name": "ì„œì§„ì˜",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 2íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ì†ìœ¤ì£¼",
    "name": "ì†ìœ¤ì£¼",
    "team": "ë¶„ì„ì‹¤",
    "position": "ë¶€ì¥"
  },
  {
    "id": "ì†¡ì§€ì€",
    "name": "ì†¡ì§€ì€",
    "team": "ë¶„ì„ì‹¤ ì”ë¥˜ë†ì•½",
    "position": "ì£¼ì„"
  },
  {
    "id": "ì‹ ê²½ì„",
    "name": "ì‹ ê²½ì„",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 1íŒ€",
    "position": "ëŒ€ë¦¬"
  },
  {
    "id": "ì•ˆì¤€ì´",
    "name": "ì•ˆì¤€ì´",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 1íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ì—¼í•˜ë¦¼",
    "name": "ì—¼í•˜ë¦¼",
    "team": "ë¶„ì„ì‹¤ ì”ë¥˜ë†ì•½",
    "position": "ëŒ€ë¦¬"
  },
  {
    "id": "ìœ¤ì •í•œ",
    "name": "ìœ¤ì •í•œ",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 1íŒ€",
    "position": "ì°¨ì¥"
  },
  {
    "id": "ì´ì¢…í›ˆ",
    "name": "ì´ì¢…í›ˆ",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 2íŒ€",
    "position": "ì£¼ì„"
  },
  {
    "id": "ì´ì§„ì•„",
    "name": "ì´ì§„ì•„",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 2íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ì¥ë¯¼ê²½",
    "name": "ì¥ë¯¼ê²½",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 3íŒ€",
    "position": "ëŒ€ë¦¬"
  },
  {
    "id": "ì§€í˜„ì •",
    "name": "ì§€í˜„ì •",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 1íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ì§„ë¯¸ì •",
    "name": "ì§„ë¯¸ì •",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 2íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "ìµœì£¼ë¦¬",
    "name": "ìµœì£¼ë¦¬",
    "team": "ë¶„ì„ì‹¤ ë¯¸ìƒë¬¼ 1íŒ€",
    "position": "ëŒ€ë¦¬"
  },
  {
    "id": "íƒœí˜ì§„",
    "name": "íƒœí˜ì§„",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 1íŒ€",
    "position": "ì‚¬ì›"
  },
  {
    "id": "í•˜ì£¼ì‹ ",
    "name": "í•˜ì£¼ì‹ ",
    "team": "ë¶„ì„ì‹¤ ì´í™”í•™ 1íŒ€",
    "position": "ê³¼ì¥"
  }
];

// --- ì¶•ì‚° ê²€ì²´ìœ í˜• ëª©ë¡ (54ê°œ) ---
const ì¶•ì‚°_ê²€ì²´ìœ í˜• = ["ì†Œì‹œì§€","ì¤‘ë¥˜ì†Œì‹œì§€","ë°œíš¨ì†Œì‹œì§€","ì†Œì‹œì§€(ê²°ê³ ì œí’ˆ)","í–„","í”„ë ˆìŠ¤í–„","ê±´ì¡°í–„","í–„(ê²°ê³ ì œí’ˆ)","ë² ì´ì»¨","ì‹ìœ¡ì¡°ì œí’ˆ","ì‹ìœ¡ì¡°ì œëƒ‰ì¥ì œí’ˆ","ì‹ìœ¡ì¡°ì œëƒ‰ë™ì œí’ˆ","ì–‘ë…ìœ¡","ë¶„ì‡„ê°€ê³µìœ¡ì œí’ˆ","ì‹ìœ¡ì¶”ì¶œê°€ê³µí’ˆ","ê±´ì¡°ì €ì¥ìœ¡ë¥˜","ê°ˆë¹„","í¬ì¥ìœ¡","ìœ ê°€ê³µí’ˆ","ê°€ê³µìœ ë¥˜","ê°•í™”ìš°ìœ ","ê°•í™”ìœ ìœ ìœ ","ê°•í™”ìš°ìš°ìœ ","ë†ì¶•ìœ ë¥˜","ë°œíš¨ìœ ë¥˜","ìœ ì‚°ê· ìŒë£Œ","ìœ ì‚°ê· ìŒë£Œ(ê¸°ëŠ¥ì„±í‘œì‹œì‹í’ˆ)","ê°€ê³µì¹˜ì¦ˆ","ê°€ê³µì¹˜ì¦ˆ(ì¶•ì‚°ë¬¼ì¦‰ì„íŒë§¤ì œí’ˆ)","ìì—°ì¹˜ì¦ˆ","ì¹˜ì¦ˆ","ì¹˜ì¦ˆ(ê²°ê³ ì œí’ˆ)","ë¶„ìœ ë¥˜","ì¡°ì œìœ ë¥˜","ì˜ì•„ìš©ì¡°ì œì‹","ì„±ì¥ê¸°ìš©ì¡°ì œì‹","ì˜ì•„ìš©ì¡°ì œìœ ","ìœ ìŒë£Œë¥˜","ë°œíš¨ìœ ë¥˜(ë ˆí† ë¥´íŠ¸)","ë²„í„°ë¥˜","ê°€ê³µë²„í„°","ë²„í„°","ì•„ì´ìŠ¤í¬ë¦¼ë¥˜","ì•„ì´ìŠ¤í¬ë¦¼","ì•„ì´ìŠ¤ë°€í¬","ì•„ì´ìŠ¤í¬ë¦¼ë¯¹ìŠ¤","ìƒ¤ë² íŠ¸","ì•„ì´ìŠ¤í¬ë¦¼ë¯¹ìŠ¤(ë¶„ë§)","ì•„ì´ìŠ¤í¬ë¦¼ë¯¹ìŠ¤(ì•¡ìƒ)","ë™ë¬¼ì„±ìœ ì§€ë¥˜","ì•Œê°€ê³µí’ˆ","ë‚œí™©ì•¡","ë‚œë°±ì•¡","ì „ë€ì•¡"];

function getDivision(foodType) {
  if (!foodType) return 'ì‹í’ˆ';
  return ì¶•ì‚°_ê²€ì²´ìœ í˜•.includes(foodType) ? 'ì¶•ì‚°' : 'ì‹í’ˆ';
}

// --- Firestore API ë°ì´í„° ë¡œë“œ ---
let apiDataCache = {};
async function loadApiDataFromFirestore(serviceId) {
  if (apiDataCache[serviceId] && apiDataCache[serviceId].length > 0) return apiDataCache[serviceId];
  try {
    var metaDoc = await db.collection('api_data').doc(serviceId).collection('meta').doc('info').get();
    if (!metaDoc.exists) return [];
    var batchCount = metaDoc.data().batchCount || 0;
    var allItems = [];
    for (var i = 0; i < batchCount; i++) {
      var bDoc = await db.collection('api_data').doc(serviceId).collection('batches').doc('batch_' + i).get();
      if (bDoc.exists && bDoc.data().items) allItems = allItems.concat(bDoc.data().items);
    }
    apiDataCache[serviceId] = allItems;
    return allItems;
  } catch(e) { console.warn('API ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', serviceId, e); return []; }
}

// --- API ë°ì´í„° â†’ ì¤‘ë³µ ì œê±°ëœ í•­ëª© ë³€í™˜ ---
function buildUniqueItems(apiData) {
  var seen = new Map();
  var idx = 0;
  apiData.forEach(function(r) {
    var itemName = (r.TESTITM_NM || '').trim();
    if (!itemName || seen.has(itemName)) return;
    var prdName = r.PRDLST_CD_NM || '';
    seen.set(itemName, {
      id: 'A' + (++idx),
      division: getDivision(prdName),
      item: itemName,
      manager: null,
      team: null
    });
  });
  return Array.from(seen.values());
}

// --- ILAB ë°ì´í„°ì—ì„œ í•­ëª©â†’ë‹´ë‹¹ì ë§¤í•‘ ë¡œë“œ ---
async function loadIlabManagerMap() {
  try {
    // foodTypesIlabì€ ê°œë³„ ë¬¸ì„œ êµ¬ì¡° (ilab_0, ilab_1, ...)
    var snap = await db.collection('foodTypesIlab').get();
    var map = {};
    snap.docs.forEach(function(d) {
      var r = d.data();
      var name = (r['í•­ëª©ëª…'] || '').trim();
      var mgr = (r['í•­ëª©ë‹´ë‹¹ì'] || '').trim();
      if (name && mgr && !map[name]) {
        map[name] = mgr;
      }
    });
    console.log('[í•­ëª©ë°°ì •] ILAB ë‹´ë‹¹ì ë§¤í•‘: ' + Object.keys(map).length + 'ê±´');
    return map;
  } catch(e) { console.warn('ILAB ë‹´ë‹¹ì ë§¤í•‘ ë¡œë“œ ì‹¤íŒ¨:', e); return {}; }
}

// --- Firestore ë°°ì • ë°ì´í„° ì €ì¥/ë¡œë“œ ---
async function loadSavedAssignments() {
  try {
    var doc = await db.collection('itemAssignments').doc('data').get();
    return doc.exists ? (doc.data().assignments || {}) : {};
  } catch(e) { console.warn('ë°°ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e); return {}; }
}

async function saveAssignmentsToFirestore() {
  var assignments = {};
  allItems.forEach(function(item) {
    if (item.manager) {
      assignments[item.item] = { manager: item.manager, team: item.team };
    }
  });
  await db.collection('itemAssignments').doc('data').set({
    assignments: assignments,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    count: Object.keys(assignments).length
  });
}

// ì „ì—­ ë³€ìˆ˜
let allItems = [];
let filteredItems = [];
let selectedIds = new Set();
let currentFilters = {
  division: 'ì „ì²´',
  status: 'ì „ì²´',
  search: ''
};

// ì´ˆê¸°í™” (Firestoreì—ì„œ API ë°ì´í„° ë¡œë“œ)
async function init() {
  // ë¡œë”© í‘œì‹œ
  var tbody = document.getElementById('table-body');
  if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#888;">â³ ë°ì´í„° ë¡œë“œ ì¤‘...</td></tr>';

  await waitForFirebase();

  // I2580 API ë°ì´í„° ë¡œë“œ
  var apiData = await loadApiDataFromFirestore('I2580');

  // ILAB ë°ì´í„°ì—ì„œ í•­ëª©â†’ë‹´ë‹¹ì ë§¤í•‘ ë¡œë“œ
  var ilabMgrMap = await loadIlabManagerMap();

  // ì¤‘ë³µ ì œê±°ëœ í•­ëª© ëª©ë¡ ìƒì„±
  allItems = buildUniqueItems(apiData);

  // 1ë‹¨ê³„: ILAB ë‹´ë‹¹ì ë§¤í•‘ ì ìš© (ê¸°ë³¸ ë§¤í•‘)
  allItems.forEach(function(item) {
    if (ilabMgrMap[item.item]) {
      var mgrName = ilabMgrMap[item.item];
      var mgrObj = MANAGERS.find(function(m) { return m.name === mgrName; });
      item.manager = mgrName;
      item.team = mgrObj ? mgrObj.team : null;
    }
  });

  // 2ë‹¨ê³„: ìˆ˜ë™ ì €ì¥ëœ ë°°ì • ì •ë³´ë¡œ ë®ì–´ì“°ê¸° (ì‚¬ìš©ìê°€ ì§ì ‘ ë³€ê²½í•œ ê²ƒ ìš°ì„ )
  var saved = await loadSavedAssignments();
  allItems.forEach(function(item) {
    if (saved[item.item]) {
      item.manager = saved[item.item].manager;
      item.team = saved[item.item].team;
    }
  });

  loadManagers();
  filterData();
  updateStats();
  renderTable();
  console.log('[í•­ëª©ë°°ì •] ë¡œë“œ ì™„ë£Œ: ' + allItems.length + 'ê°œ í•­ëª© (ì¤‘ë³µ ì œê±°)');
}

// ë‹´ë‹¹ì ë¡œë“œ
function loadManagers() {
  const selects = ['bulk-manager', 'team-manager'];
  selects.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      MANAGERS.forEach(m => {
        const option = document.createElement('option');
        option.value = m.name;
        option.textContent = `${m.name} ${m.position} (${m.team})`;
        select.appendChild(option);
      });
    }
  });
}

// í•„í„°ë§
function filterByDivision(division) {
  currentFilters.division = division;
  updateFilterButtons('division', division);
  filterData();
}

function filterByStatus(status) {
  currentFilters.status = status;
  updateFilterButtons('status', status);
  filterData();
}

function updateFilterButtons(type, value) {
  const buttons = document.querySelectorAll('.filter-chip');
  buttons.forEach(btn => {
    if (btn.onclick && btn.onclick.toString().includes(value)) {
      btn.classList.add('active');
    } else if (btn.onclick) {
      btn.classList.remove('active');
    }
  });
}

function filterData() {
  const searchText = document.getElementById('search-input').value.toLowerCase();
  currentFilters.search = searchText;
  
  filteredItems = allItems.filter(item => {
    // ë¶„ì•¼ í•„í„°
    if (currentFilters.division !== 'ì „ì²´' && item.division !== currentFilters.division) {
      return false;
    }
    
    // ìƒíƒœ í•„í„°
    if (currentFilters.status === 'ë°°ì •' && !item.manager) return false;
    if (currentFilters.status === 'ë¯¸ë°°ì •' && item.manager) return false;
    
    // ê²€ìƒ‰ (í•­ëª©ëª…)
    if (currentFilters.search) {
      if (!item.item.toLowerCase().includes(currentFilters.search)) {
        return false;
      }
    }
    
    return true;
  });
  
  renderTable();
  updateStats();
}

// í…Œì´ë¸” ë Œë”ë§
function renderTable() {
  const tbody = document.getElementById('table-body');
  
  tbody.innerHTML = filteredItems.map((item, idx) => {
    const isSelected = selectedIds.has(item.id);
    const isUnassigned = !item.manager;
    const rowClass = isSelected ? 'selected' : (isUnassigned ? 'unassigned' : '');
    
    return `
      <tr class="${rowClass}">
        <td><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${item.id}')"></td>
        <td style="text-align: center; color: var(--gray-600);">${idx + 1}</td>
        <td>
          <span class="badge badge-${item.division === 'ì¶•ì‚°' ? 'warning' : 'primary'}">
            ${item.division === 'ì¶•ì‚°' ? 'ğŸ¥©' : 'ğŸ±'} ${item.division}
          </span>
        </td>
        <td style="font-weight: 500;">${item.item}</td>
        <td>
          <select class="manager-select ${isUnassigned ? 'unassigned' : ''}" 
                  onchange="assignManager('${item.id}', this.value)">
            <option value="">-- ë‹´ë‹¹ì ì„ íƒ --</option>
            ${MANAGERS.map(m => `
              <option value="${m.name}" ${item.manager === m.name ? 'selected' : ''}>
                ${m.name} ${m.position} (${m.team})
              </option>
            `).join('')}
          </select>
        </td>
        <td style="text-align: center;">
          <button class="btn btn-sm btn-outline" onclick="showHistory('${item.id}')">ğŸ“…</button>
        </td>
      </tr>
    `;
  }).join('');
}

// ì„ íƒ í† ê¸€
function toggleSelect(id) {
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
  } else {
    selectedIds.add(id);
  }
  renderTable();
}

function toggleSelectAll() {
  const checkbox = document.getElementById('select-all');
  if (checkbox.checked) {
    filteredItems.forEach(item => selectedIds.add(item.id));
  } else {
    selectedIds.clear();
  }
  renderTable();
}

// ë‹´ë‹¹ì ë°°ì •
function assignManager(itemId, managerName) {
  const item = allItems.find(i => i.id === itemId);
  if (item) {
    const manager = MANAGERS.find(m => m.name === managerName);
    item.manager = managerName;
    item.team = manager ? manager.team : null;
    
    updateStats();
    renderTable();
    showAlert('success', `${item.item}ì— ${managerName} ë‹´ë‹¹ìë¥¼ ë°°ì •í–ˆìŠµë‹ˆë‹¤.`);
  }
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStats() {
  const total = allItems.length;
  const assigned = allItems.filter(i => i.manager).length;
  const unassigned = total - assigned;
  const managers = new Set(allItems.filter(i => i.manager).map(i => i.manager)).size;

  const elTotal = document.getElementById('stat-total');
  const elAssigned = document.getElementById('stat-assigned');
  const elUnassigned = document.getElementById('stat-unassigned');
  const elManagers = document.getElementById('stat-managers');
  if (elTotal) elTotal.textContent = total;
  if (elAssigned) elAssigned.textContent = assigned;
  if (elUnassigned) elUnassigned.textContent = unassigned;
  if (elManagers) elManagers.textContent = managers;
}

// ì¼ê´„ ë°°ì •
function showBulkAssignModal() {
  if (selectedIds.size === 0) {
    showAlert('warning', 'í•­ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  document.getElementById('selected-count').textContent = selectedIds.size;
  document.getElementById('bulk-modal').classList.add('active');
}

function closeBulkModal() {
  document.getElementById('bulk-modal').classList.remove('active');
}

function applyBulkAssign() {
  const managerName = document.getElementById('bulk-manager').value;
  if (!managerName) {
    showAlert('warning', 'ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const manager = MANAGERS.find(m => m.name === managerName);
  let count = 0;
  
  selectedIds.forEach(id => {
    const item = allItems.find(i => i.id === id);
    if (item) {
      item.manager = managerName;
      item.team = manager ? manager.team : null;
      count++;
    }
  });
  
  selectedIds.clear();
  updateStats();
  renderTable();
  closeBulkModal();
  showAlert('success', `${count}ê°œ í•­ëª©ì— ${managerName} ë‹´ë‹¹ìë¥¼ ë°°ì •í–ˆìŠµë‹ˆë‹¤.`);
}

// íŒ€ ë³€ê²½
function showTeamChangeModal() {
  document.getElementById('team-modal').classList.add('active');
}

function closeTeamModal() {
  document.getElementById('team-modal').classList.remove('active');
}

function applyTeamChange() {
  const managerName = document.getElementById('team-manager').value;
  const newTeam = document.getElementById('new-team').value;
  
  if (!managerName || !newTeam) {
    showAlert('warning', 'ë‹´ë‹¹ìì™€ ìƒˆ íŒ€ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const manager = MANAGERS.find(m => m.name === managerName);
  if (manager) {
    const oldTeam = manager.team;
    manager.team = newTeam;
    
    // í•´ë‹¹ ë‹´ë‹¹ìê°€ ë°°ì •ëœ ëª¨ë“  í•­ëª©ì˜ íŒ€ë„ ë³€ê²½
    let count = 0;
    allItems.forEach(item => {
      if (item.manager === managerName) {
        item.team = newTeam;
        count++;
      }
    });
    
    renderTable();
    closeTeamModal();
    showAlert('success', `${managerName} ë‹´ë‹¹ìì˜ íŒ€ì„ ${oldTeam} â†’ ${newTeam}ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. (${count}ê°œ í•­ëª© ë°˜ì˜)`);
  }
}

// íŒ€ ë§¤ë‹ˆì € ì„ íƒ ì‹œ í˜„ì¬ íŒ€ í‘œì‹œ
document.addEventListener('DOMContentLoaded', function() {
  const teamManagerSelect = document.getElementById('team-manager');
  if (teamManagerSelect) {
    teamManagerSelect.addEventListener('change', function() {
      const managerName = this.value;
      const manager = MANAGERS.find(m => m.name === managerName);
      const currentTeamInput = document.getElementById('current-team');
      if (currentTeamInput) {
        currentTeamInput.value = manager ? manager.team : '';
      }
    });
  }
});

// ë°°ì • ì´ë ¥
function showHistory(itemId) {
  const item = allItems.find(i => i.id === itemId);
  if (!item) return;
  
  const historyHtml = `
    <div style="margin-bottom: 20px;">
      <strong>${item.item}</strong>
    </div>
    
    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px;">
            2026-02-16 14:30
          </div>
          <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">
            ${item.manager || 'ë¯¸ë°°ì •'} ${item.team ? `(${item.team})` : ''}
          </div>
          <div style="font-size: 12px; color: var(--gray-600);">
            ë³€ê²½ì: ê´€ë¦¬ì
          </div>
        </div>
      </div>
      
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px;">
            2026-01-15 09:00
          </div>
          <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">
            ìµœì´ˆ ë“±ë¡
          </div>
          <div style="font-size: 12px; color: var(--gray-600);">
            ë³€ê²½ì: ì‹œìŠ¤í…œ
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('history-content').innerHTML = historyHtml;
  document.getElementById('history-modal').classList.add('active');
}

function closeHistoryModal() {
  document.getElementById('history-modal').classList.remove('active');
}

// ì „ì²´ ì €ì¥
async function saveAll() {
  try {
    await saveAssignmentsToFirestore();
    showAlert('success', 'ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch(e) {
    console.error('ì €ì¥ ì‹¤íŒ¨:', e);
    showAlert('warning', 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(type, message) {
  const container = document.getElementById('alert-container');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  alert.innerHTML = `
    <span style="font-size: 20px;">${type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}</span>
    <span>${message}</span>
  `;
  container.appendChild(alert);
  
  setTimeout(() => {
    alert.remove();
  }, 3000);
}

// ì´ˆê¸°í™” ì‹¤í–‰
init();

</script>
<!-- ì‚¬ì´ë“œë°” JS â†’ js/sidebar.jsë¡œ ì´ê´€ë¨ -->

</body>
</html>
