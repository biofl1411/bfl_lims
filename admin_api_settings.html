<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹ì•½ì²˜ API ìˆ˜ì§‘ ì„¤ì • - BioFoodLab ê´€ë¦¬ì</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --border: #e2e6ed;
  --text: #1a2332;
  --text2: #5f6b7a;
  --text3: #8892a4;
  --primary: #1a73e8;
  --primary-light: #e8f0fe;
  --success: #0d9f6e;
  --success-light: #def7ec;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --danger: #e53e3e;
  --danger-light: #fee2e2;
  --cat-biz: #4f46e5;
  --cat-prd: #0891b2;
  --cat-mat: #16a34a;
  --cat-chg: #d97706;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.06);
  --shadow-lg: 0 4px 14px rgba(0,0,0,.1);
  --radius: 10px;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans KR', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

/* â”€â”€â”€ Sidebar Layout â”€â”€â”€ */
.app-layout { display:flex; min-height:100vh; }
.main-wrapper { flex:1; margin-left:250px; min-height:100vh; }
@media(max-width:768px) { .main-wrapper { margin-left:0; } }

/* â”€â”€â”€ Header â”€â”€â”€ */
.header {
  background: linear-gradient(135deg, #1a2332 0%, #2d3a4a 100%);
  color: #fff;
  padding: 24px 32px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,.15);
}
.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header h1 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -.3px;
}
.header h1 span { color: #90caf9; font-weight: 400; }
.header-actions { display: flex; gap: 10px; align-items: center; }

/* â”€â”€â”€ Buttons â”€â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  font-family: inherit;
}
.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-outline {
  background: transparent;
  border: 1.5px solid rgba(255,255,255,.35);
  color: #fff;
}
.btn-outline:hover { border-color: #fff; background: rgba(255,255,255,.1); }
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }

/* â”€â”€â”€ Layout â”€â”€â”€ */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 32px 60px;
}

/* â”€â”€â”€ Cards â”€â”€â”€ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  overflow: hidden;
}
.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  background: #fafbfc;
}
.card-header h2 {
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-body { padding: 20px; }

/* â”€â”€â”€ Schedule Section â”€â”€â”€ */
.schedule-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 20px;
}
@media (max-width: 768px) {
  .schedule-grid { grid-template-columns: 1fr; }
}
.schedule-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.schedule-item label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: .5px;
}
.schedule-item select,
.schedule-item input {
  padding: 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  color: var(--text);
  background: #fff;
  transition: border-color .2s;
}
.schedule-item select:focus,
.schedule-item input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-light);
}
.time-picker {
  display: flex;
  align-items: center;
  gap: 6px;
}
.time-picker select {
  width: 80px;
  text-align: center;
}
.time-picker .sep {
  font-size: 18px;
  font-weight: 700;
  color: var(--text3);
}

/* â”€â”€â”€ Toggle Switch â”€â”€â”€ */
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}
.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  inset: 0;
  background: #cdd5df;
  border-radius: 24px;
  cursor: pointer;
  transition: .25s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  left: 3px;
  bottom: 3px;
  background: #fff;
  border-radius: 50%;
  transition: .25s;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}
.toggle input:checked + .toggle-slider { background: var(--primary); }
.toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

/* â”€â”€â”€ Stats Bar â”€â”€â”€ */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}
@media (max-width: 768px) {
  .stats-bar { grid-template-columns: repeat(2, 1fr); }
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  text-align: center;
  box-shadow: var(--shadow);
}
.stat-card .stat-value {
  font-size: 26px;
  font-weight: 700;
  color: var(--primary);
  line-height: 1.2;
}
.stat-card .stat-label {
  font-size: 11px;
  color: var(--text3);
  margin-top: 4px;
  font-weight: 500;
}

/* â”€â”€â”€ Category Tabs â”€â”€â”€ */
.cat-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.cat-tab {
  padding: 7px 16px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  background: #fff;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  font-family: inherit;
  color: var(--text2);
}
.cat-tab:hover { border-color: var(--primary); color: var(--primary); }
.cat-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
.cat-tab .cnt { 
  display: inline-block;
  background: rgba(0,0,0,.08);
  padding: 1px 7px;
  border-radius: 10px;
  font-size: 11px;
  margin-left: 4px;
}
.cat-tab.active .cnt { background: rgba(255,255,255,.25); }

/* â”€â”€â”€ API List â”€â”€â”€ */
.api-item {
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 10px;
  overflow: hidden;
  transition: all .2s;
}
.api-item:hover { border-color: #c5cdd8; }
.api-item.disabled { opacity: .6; }
.api-item-header {
  display: flex;
  align-items: center;
  padding: 14px 18px;
  gap: 14px;
  cursor: pointer;
  user-select: none;
  background: #fafbfc;
  transition: background .15s;
}
.api-item-header:hover { background: #f3f5f8; }

.api-cat-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: .3px;
  flex-shrink: 0;
}
.badge-ì—…ì†Œì¸í—ˆê°€ { background: #eef2ff; color: var(--cat-biz); }
.badge-í’ˆëª©ì œì¡° { background: #ecfdf5; color: var(--cat-prd); }
.badge-ì›ì¬ë£Œ { background: #f0fdf4; color: var(--cat-mat); }
.badge-ë³€ê²½ì´ë ¥ { background: #fffbeb; color: var(--cat-chg); }

.api-info {
  flex: 1;
  min-width: 0;
}
.api-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}
.api-id {
  font-size: 11px;
  color: var(--text3);
  font-family: 'Courier New', monospace;
  margin-top: 1px;
}
.api-meta {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-shrink: 0;
}
.api-count {
  font-size: 12px;
  color: var(--text2);
  text-align: right;
}
.api-count strong {
  display: block;
  font-size: 16px;
  color: var(--text);
}
.api-expand {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all .2s;
  color: var(--text3);
  font-size: 12px;
}
.api-item.expanded .api-expand { transform: rotate(180deg); color: var(--primary); }

/* â”€â”€â”€ Fields Panel â”€â”€â”€ */
.api-fields {
  display: none;
  padding: 0 18px 16px;
  border-top: 1px solid var(--border);
  background: #fff;
}
.api-item.expanded .api-fields { display: block; }

.fields-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0 10px;
}
.fields-toolbar .left {
  font-size: 12px;
  font-weight: 600;
  color: var(--text2);
}
.fields-toolbar .right { display: flex; gap: 8px; }

.fields-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 6px;
}
.field-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid transparent;
  transition: all .15s;
  cursor: pointer;
}
.field-item:hover { background: #f3f5f8; border-color: var(--border); }
.field-item input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--primary);
  cursor: pointer;
  flex-shrink: 0;
}
.field-label {
  font-size: 13px;
  color: var(--text);
  font-weight: 500;
}
.field-key {
  font-size: 10px;
  color: var(--text3);
  font-family: 'Courier New', monospace;
}
.field-item.required {
  background: var(--primary-light);
  border-color: #c4dbf6;
}
.field-item.required input { pointer-events: none; }

/* â”€â”€â”€ Collection Log â”€â”€â”€ */
.log-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.log-table th {
  text-align: left;
  padding: 10px 12px;
  font-weight: 600;
  color: var(--text2);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .5px;
  border-bottom: 2px solid var(--border);
}
.log-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #f0f2f5;
  color: var(--text);
}
.log-table tr:hover td { background: #fafbfc; }

.status-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
}
.status-dot.ok { background: var(--success); }
.status-dot.err { background: var(--danger); }
.status-dot.warn { background: var(--warning); }

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  color: #fff;
  z-index: 9999;
  transition: transform .35s cubic-bezier(.4,0,.2,1);
  box-shadow: 0 8px 30px rgba(0,0,0,.2);
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--primary); }

/* â”€â”€â”€ Confirm Modal â”€â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 500;
  align-items: center;
  justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: #fff;
  border-radius: 14px;
  padding: 28px;
  max-width: 440px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,.2);
}
.modal h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 10px;
}
.modal p {
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 20px;
  line-height: 1.7;
}
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
</style>
</head>
<body>
<div class="app-layout">
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=2"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<div class="main-wrapper">

<!-- â”€â”€â”€ Header â”€â”€â”€ -->
<div class="header">
  <div class="header-inner">
    <h1>ğŸ”§ ì‹ì•½ì²˜ API ìˆ˜ì§‘ ì„¤ì • <span>| BioFoodLab ê´€ë¦¬ì</span></h1>
    <div class="header-actions">
      <a href="admin_collect_status.html" class="btn btn-success btn-sm">ğŸ“Š API ê°±ì‹  í˜„í™©</a>
      <button class="btn btn-outline btn-sm" onclick="loadStatus()">â†» ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn btn-warning btn-sm" onclick="confirmManualCollect()">â–¶ ìˆ˜ë™ ìˆ˜ì§‘</button>
      <button class="btn btn-primary" onclick="saveAllSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- â”€â”€â”€ Stats Bar â”€â”€â”€ -->
  <div class="stats-bar" id="statsBar">
    <div class="stat-card">
      <div class="stat-value" id="statTotal">-</div>
      <div class="stat-label">ì „ì²´ API</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statActive">-</div>
      <div class="stat-label">ìˆ˜ì§‘ í™œì„±</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statBizCount">-</div>
      <div class="stat-label">ì—…ì†Œ ë°ì´í„°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statPrdCount">-</div>
      <div class="stat-label">í’ˆëª© ë°ì´í„°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statLastCollect">-</div>
      <div class="stat-label">ìµœê·¼ ìˆ˜ì§‘</div>
    </div>
  </div>

  <!-- â”€â”€â”€ Schedule Settings â”€â”€â”€ -->
  <div class="card">
    <div class="card-header">
      <h2>â° ìˆ˜ì§‘ ìŠ¤ì¼€ì¤„ ì„¤ì •</h2>
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:12px;color:var(--text2)">ìë™ ìˆ˜ì§‘</span>
        <label class="toggle">
          <input type="checkbox" id="scheduleActive" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    <div class="card-body">
      <div class="schedule-grid">
        <div class="schedule-item">
          <label>ìˆ˜ì§‘ ì‹œê° (KST)</label>
          <div class="time-picker">
            <select id="collectHour"></select>
            <span class="sep">:</span>
            <select id="collectMinute"></select>
          </div>
        </div>
        <div class="schedule-item">
          <label>ìˆ˜ì§‘ ëª¨ë“œ</label>
          <select id="collectMode">
            <option value="incremental">ì¦ë¶„ ìˆ˜ì§‘ (ë³€ê²½ë¶„ë§Œ)</option>
            <option value="full">ì „ì²´ ìˆ˜ì§‘ (ì „ì²´ ì¬ìˆ˜ì§‘)</option>
          </select>
        </div>
        <div class="schedule-item">
          <label>ì‹ì•½ì²˜ API í‚¤</label>
          <input type="text" id="apiKey" value="e5a1d9f07d6c4424a757" placeholder="API ì¸ì¦í‚¤">
        </div>
        <div class="schedule-item">
          <label>1íšŒ ìš”ì²­ ê±´ìˆ˜</label>
          <select id="batchSize">
            <option value="100">100ê±´</option>
            <option value="200">200ê±´</option>
            <option value="500">500ê±´</option>
            <option value="1000" selected>1,000ê±´ (ê¶Œì¥, API ìµœëŒ€)</option>
          </select>
        </div>
        <div class="schedule-item">
          <label>ìš”ì²­ ê°„ê²© (ì´ˆ)</label>
          <select id="requestDelay">
            <option value="0.1">0.1ì´ˆ</option>
            <option value="0.2">0.2ì´ˆ</option>
            <option value="0.3" selected>0.3ì´ˆ (ê¶Œì¥)</option>
            <option value="0.5">0.5ì´ˆ</option>
            <option value="1.0">1.0ì´ˆ</option>
          </select>
        </div>
        <div class="schedule-item">
          <label>ì„œë²„ API URL</label>
          <input type="text" id="serverUrl" value="" placeholder="API ì„œë²„ ì£¼ì†Œ">
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ API Collection Settings â”€â”€â”€ -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ“¡ ìˆ˜ì§‘ ëŒ€ìƒ API ì„¤ì •</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-sm btn-outline" style="color:var(--text2);border-color:var(--border)" onclick="toggleAllApis(true)">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-sm btn-outline" style="color:var(--text2);border-color:var(--border)" onclick="toggleAllApis(false)">ì „ì²´ í•´ì œ</button>
      </div>
    </div>
    <div class="card-body">
      <!-- Category Tabs -->
      <div class="cat-tabs" id="catTabs">
        <button class="cat-tab active" data-cat="all" onclick="filterCategory('all')">ì „ì²´ <span class="cnt">16</span></button>
        <button class="cat-tab" data-cat="ì—…ì†Œì¸í—ˆê°€" onclick="filterCategory('ì—…ì†Œì¸í—ˆê°€')">ì—…ì†Œ ì¸í—ˆê°€ <span class="cnt">9</span></button>
        <button class="cat-tab" data-cat="í’ˆëª©ì œì¡°" onclick="filterCategory('í’ˆëª©ì œì¡°')">í’ˆëª© ì œì¡° <span class="cnt">2</span></button>
        <button class="cat-tab" data-cat="ì›ì¬ë£Œ" onclick="filterCategory('ì›ì¬ë£Œ')">ì›ì¬ë£Œ <span class="cnt">3</span></button>
        <button class="cat-tab" data-cat="ë³€ê²½ì´ë ¥" onclick="filterCategory('ë³€ê²½ì´ë ¥')">ë³€ê²½ ì´ë ¥ <span class="cnt">2</span></button>
      </div>

      <!-- API List -->
      <div id="apiList"></div>
    </div>
  </div>

  <!-- â”€â”€â”€ Collection Log â”€â”€â”€ -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ“‹ ìµœê·¼ ìˆ˜ì§‘ ì´ë ¥</h2>
      <button class="btn btn-sm btn-outline" style="color:var(--text2);border-color:var(--border)" onclick="loadLogs()">â†» ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="card-body" style="padding:0; overflow-x:auto;">
      <table class="log-table">
        <thead>
          <tr>
            <th>ì¼ì‹œ</th>
            <th>API</th>
            <th>ëª¨ë“œ</th>
            <th>ì´ê±´ìˆ˜</th>
            <th>ìˆ˜ì§‘</th>
            <th>ì‹ ê·œ</th>
            <th>ê°±ì‹ </th>
            <th>ì˜¤ë¥˜</th>
            <th>ì†Œìš”</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">ì„œë²„ ì—°ê²° í›„ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Confirm Modal â”€â”€â”€ -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="modalTitle">ìˆ˜ë™ ìˆ˜ì§‘ í™•ì¸</h3>
    <p id="modalMsg">í™œì„±í™”ëœ APIì— ëŒ€í•´ ìˆ˜ë™ ìˆ˜ì§‘ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ìˆ˜ì§‘ ëª¨ë“œì— ë”°ë¼ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤.</p>
    <div class="modal-actions">
      <button class="btn btn-outline" style="color:var(--text2);border-color:var(--border)" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-warning" id="modalConfirmBtn" onclick="doManualCollect()">ìˆ˜ì§‘ ì‹œì‘</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Toast â”€â”€â”€ -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// API ì •ì˜ ë°ì´í„° (16ê°œ)
// ============================================================
var API_DEFS = {
  'I1220': {
    name: 'ì‹í’ˆì œì¡°ê°€ê³µì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'}
    ]
  },
  'I2829': {
    name: 'ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'}
    ]
  },
  'I-0020': {
    name: 'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì „ë¬¸/ë²¤ì²˜ì œì¡°ì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œì'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true}
    ]
  },
  'I1300': {
    name: 'ì¶•ì‚°ë¬¼ ê°€ê³µì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'}
    ]
  },
  'I1320': {
    name: 'ì¶•ì‚°ë¬¼ ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'CLSBIZ_DVS_NM', label:'ì˜ì—…ìƒíƒœ'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'}
    ]
  },
  'I2835': {
    name: 'ì‹ìœ¡ì¦‰ì„íŒë§¤ê°€ê³µì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'}
    ]
  },
  'I2831': {
    name: 'ì‹í’ˆì†Œë¶„ì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'}
    ]
  },
  'C001': {
    name: 'ìˆ˜ì…ì‹í’ˆë“±ì˜ì—…ì‹ ê³ ', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'}
    ]
  },
  'I1260': {
    name: 'ì‹í’ˆë“±ìˆ˜ì…íŒë§¤ì—…', category: 'ì—…ì†Œì¸í—ˆê°€',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRSDNT_NM', label:'ëŒ€í‘œìëª…'},
      {key:'INDUTY_NM', label:'ì—…ì¢…'},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'},
      {key:'LOCP_ADDR', label:'ì£¼ì†Œ', required:true},
      {key:'INSTT_NM', label:'ê¸°ê´€ëª…'}
    ]
  },
  'I1250': {
    name: 'ì‹í’ˆ(ì²¨ê°€ë¬¼)í’ˆëª©ì œì¡°ë³´ê³ ', category: 'í’ˆëª©ì œì¡°',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRDLST_REPORT_NO', label:'í’ˆëª©ì œì¡°ë²ˆí˜¸', required:true},
      {key:'PRMS_DT', label:'í—ˆê°€ì¼ì'},
      {key:'PRDLST_NM', label:'ì œí’ˆëª…'},
      {key:'PRDLST_DCNM', label:'í’ˆëª©ìœ í˜•ëª…'},
      {key:'PRODUCTION', label:'ìƒì‚°ì¢…ë£Œì—¬ë¶€'},
      {key:'HIENG_LNTRT_DVS_NM', label:'ê³ ì—´ëŸ‰ì €ì˜ì–‘ì‹í’ˆ'},
      {key:'CHILD_CRTFC_YN', label:'ì–´ë¦°ì´ê¸°í˜¸ì‹í’ˆì¸ì¦'},
      {key:'POG_DAYCNT', label:'ì†Œë¹„ê¸°í•œ'},
      {key:'LAST_UPDT_DTM', label:'ìµœì¢…ìˆ˜ì •ì¼ì'},
      {key:'INDUTY_CD_NM', label:'ì—…ì¢…'},
      {key:'QLITY_MNTNC_TMLMT_DAYCNT', label:'í’ˆì§ˆìœ ì§€ê¸°í•œì¼ìˆ˜'},
      {key:'USAGE', label:'ìš©ë²•'},
      {key:'PRPOS', label:'ìš©ë„'},
      {key:'DISPOS', label:'ì œí’ˆí˜•íƒœ'},
      {key:'FRMLC_MTRQLT', label:'í¬ì¥ì¬ì§ˆ'},
      {key:'ETQTY_XPORT_PRDLST_YN', label:'ë‚´ìˆ˜/ê²¸ìš©êµ¬ë¶„'}
    ]
  },
  'I1310': {
    name: 'ì¶•ì‚°ë¬¼ í’ˆëª©ì œì¡°ì •ë³´', category: 'í’ˆëª©ì œì¡°',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRDLST_REPORT_NO', label:'í’ˆëª©ì œì¡°ë²ˆí˜¸', required:true},
      {key:'PRMS_DT', label:'ë³´ê³ ì¼ì'},
      {key:'PRDLST_NM', label:'ì œí’ˆëª…'},
      {key:'PRDLST_DCNM', label:'ìœ í˜•'},
      {key:'PRODUCTION', label:'ìƒì‚°ì¢…ë£Œì—¬ë¶€'},
      {key:'HIENG_LNTRT_DVS_NM', label:'ê³ ì—´ëŸ‰ì €ì˜ì–‘ì‹í’ˆ'},
      {key:'CHILD_CRTFC_YN', label:'ì–´ë¦°ì´ê¸°í˜¸ì‹í’ˆì¸ì¦'},
      {key:'POG_DAYCNT', label:'ì†Œë¹„ê¸°í•œ'},
      {key:'INDUTY_CD_NM', label:'ì—…ì¢…'},
      {key:'LAST_UPDT_DTM', label:'ìµœì¢…ìˆ˜ì •ì¼ì'}
    ]
  },
  'C002': {
    name: 'ì‹í’ˆ(ì²¨ê°€ë¬¼)í’ˆëª©ì œì¡°ë³´ê³ (ì›ì¬ë£Œ)', category: 'ì›ì¬ë£Œ',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRDLST_REPORT_NO', label:'í’ˆëª©ì œì¡°ë²ˆí˜¸', required:true},
      {key:'PRMS_DT', label:'ë³´ê³ ì¼ì'},
      {key:'PRDLST_NM', label:'í’ˆëª©ëª…'},
      {key:'PRDLST_DCNM', label:'í’ˆëª©ìœ í˜•ëª…'},
      {key:'RAWMTRL_NM', label:'ì›ì¬ë£Œëª…'},
      {key:'RAWMTRL_ORDNO', label:'ì›ì¬ë£Œí‘œì‹œìˆœì„œ'},
      {key:'CHNG_DT', label:'ë³€ê²½ì¼ì'},
      {key:'ETQTY_XPORT_PRDLST_YN', label:'ë‚´ìˆ˜/ê²¸ìš©êµ¬ë¶„'}
    ]
  },
  'C003': {
    name: 'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ í’ˆëª©ì œì¡°ì‹ ê³ (ì›ì¬ë£Œ)', category: 'ì›ì¬ë£Œ',
    fields: [
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRDLST_REPORT_NO', label:'í’ˆëª©ì œì¡°ë²ˆí˜¸', required:true},
      {key:'PRDLST_NM', label:'í’ˆëª©ëª…'},
      {key:'PRMS_DT', label:'ë³´ê³ ì¼ì'},
      {key:'POG_DAYCNT', label:'ì†Œë¹„ê¸°í•œ'},
      {key:'DISPOS', label:'ì„±ìƒ'},
      {key:'NTK_MTHD', label:'ì„­ì·¨ë°©ë²•'},
      {key:'PRIMARY_FNCLTY', label:'ì£¼ëœê¸°ëŠ¥ì„±'},
      {key:'IFTKN_ATNT_MATR_CN', label:'ì„­ì·¨ì‹œì£¼ì˜ì‚¬í•­'},
      {key:'CSTDY_MTHD', label:'ë³´ê´€ë°©ë²•'},
      {key:'SHAP', label:'í˜•íƒœ'},
      {key:'STDR_STND', label:'ê¸°ì¤€ê·œê²©'},
      {key:'RAWMTRL_NM', label:'ì›ì¬ë£Œ'},
      {key:'CRET_DTM', label:'ìµœì´ˆìƒì„±ì¼ì‹œ'},
      {key:'LAST_UPDT_DTM', label:'ìµœì¢…ìˆ˜ì •ì¼ì‹œ'},
      {key:'PRDT_SHAP_CD_NM', label:'ì œí’ˆí˜•íƒœ'}
    ]
  },
  'C006': {
    name: 'ì¶•ì‚°ë¬¼í’ˆëª©ì œì¡°ë³´ê³ (ì›ì¬ë£Œ)', category: 'ì›ì¬ë£Œ',
    fields: [
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'PRDLST_REPORT_NO', label:'í’ˆëª©ì œì¡°ë²ˆí˜¸', required:true},
      {key:'PRMS_DT', label:'ë³´ê³ ì¼ì'},
      {key:'PRDLST_NM', label:'í’ˆëª©ëª…'},
      {key:'PRDLST_DCNM', label:'ìœ í˜•'},
      {key:'RAWMTRL_NM', label:'ì›ì¬ë£Œ'},
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'CHNG_DT', label:'ë³€ê²½ì¼ì'},
      {key:'RAWMTRL_ORDNO', label:'ì›ì¬ë£Œí‘œì‹œìˆœì„œ'}
    ]
  },
  'I2859': {
    name: 'ì‹í’ˆì—…ì†Œ ì¸í—ˆê°€ ë³€ê²½ ì •ë³´', category: 'ë³€ê²½ì´ë ¥',
    fields: [
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'INDUTY_CD_NM', label:'ì—…ì¢…'},
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'},
      {key:'SITE_ADDR', label:'ì£¼ì†Œ'},
      {key:'CHNG_DT', label:'ë³€ê²½ì¼ì'},
      {key:'CHNG_BF_CN', label:'ë³€ê²½ì „ë‚´ìš©'},
      {key:'CHNG_AF_CN', label:'ë³€ê²½í›„ë‚´ìš©'},
      {key:'CHNG_PRVNS', label:'ë³€ê²½ì‚¬ìœ '}
    ]
  },
  'I2860': {
    name: 'ê±´ê°•ê¸°ëŠ¥ì‹í’ˆì—…ì†Œ ì¸í—ˆê°€ ë³€ê²½ ì •ë³´', category: 'ë³€ê²½ì´ë ¥',
    fields: [
      {key:'BSSH_NM', label:'ì—…ì†Œëª…', required:true},
      {key:'INDUTY_CD_NM', label:'ì—…ì¢…ëª…'},
      {key:'LCNS_NO', label:'ì¸í—ˆê°€ë²ˆí˜¸', required:true},
      {key:'TELNO', label:'ì „í™”ë²ˆí˜¸'},
      {key:'SITE_ADDR', label:'ì£¼ì†Œ'},
      {key:'CHNG_DT', label:'ë³€ê²½ì¼ì'},
      {key:'CHNG_BF_CN', label:'ë³€ê²½ì „ë‚´ìš©'},
      {key:'CHNG_AF_CN', label:'ë³€ê²½í›„ë‚´ìš©'},
      {key:'CHNG_PRVNS', label:'ë³€ê²½ì‚¬ìœ '}
    ]
  }
};

// ============================================================
// ìƒíƒœ ê´€ë¦¬
// ============================================================
var settings = {
  apis: {},       // { apiId: { enabled: true, fields: ['LCNS_NO','BSSH_NM',...] } }
  schedule: {}
};

var currentFilter = 'all';

// ============================================================
// ì´ˆê¸°í™”
// ============================================================
function init() {
  // ì‹œê°„ ì„ íƒê¸° ìƒì„±
  var hSel = document.getElementById('collectHour');
  for (var h = 0; h < 24; h++) {
    var opt = document.createElement('option');
    opt.value = h;
    opt.textContent = h.toString().padStart(2, '0') + 'ì‹œ';
    if (h === 3) opt.selected = true;
    hSel.appendChild(opt);
  }
  var mSel = document.getElementById('collectMinute');
  for (var m = 0; m < 60; m += 5) {
    var opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m.toString().padStart(2, '0') + 'ë¶„';
    mSel.appendChild(opt);
  }

  // API ê¸°ë³¸ ì„¤ì • ì´ˆê¸°í™”
  Object.keys(API_DEFS).forEach(function(id) {
    settings.apis[id] = {
      enabled: true,
      fields: API_DEFS[id].fields.map(function(f) { return f.key; })
    };
  });

  renderApiList();
  loadFromServer();
}

// ============================================================
// API ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
// ============================================================
function renderApiList() {
  var container = document.getElementById('apiList');
  var html = '';
  var order = ['I1220','I2829','I-0020','I1300','I1320','I2835','I2831','C001','I1260',
               'I1250','I1310','C002','C003','C006','I2859','I2860'];

  order.forEach(function(id) {
    var def = API_DEFS[id];
    var cfg = settings.apis[id];
    if (!def) return;

    var catClass = 'badge-' + def.category;
    var disabledClass = cfg.enabled ? '' : ' disabled';
    var display = (currentFilter === 'all' || def.category === currentFilter) ? '' : 'display:none;';
    var enabledCount = cfg.fields.length;
    var totalCount = def.fields.length;

    html += '<div class="api-item' + disabledClass + '" id="api-' + id + '" style="' + display + '">';
    html += '  <div class="api-item-header" onclick="toggleExpand(\'' + id + '\')">';
    html += '    <label class="toggle" onclick="event.stopPropagation()">';
    html += '      <input type="checkbox" ' + (cfg.enabled ? 'checked' : '') + ' onchange="toggleApi(\'' + id + '\', this.checked)">';
    html += '      <span class="toggle-slider"></span>';
    html += '    </label>';
    html += '    <span class="api-cat-badge ' + catClass + '">' + def.category + '</span>';
    html += '    <div class="api-info">';
    html += '      <div class="api-name">' + def.name + '</div>';
    html += '      <div class="api-id">' + id + '</div>';
    html += '    </div>';
    html += '    <div class="api-meta">';
    html += '      <div class="api-count">í•„ë“œ <strong>' + enabledCount + '/' + totalCount + '</strong></div>';
    html += '      <div class="api-expand">â–¼</div>';
    html += '    </div>';
    html += '  </div>';

    // Fields panel
    html += '  <div class="api-fields">';
    html += '    <div class="fields-toolbar">';
    html += '      <div class="left">ìˆ˜ì§‘í•  í•­ëª© ì„ íƒ (í•„ìˆ˜ í•­ëª©ì€ í•´ì œ ë¶ˆê°€)</div>';
    html += '      <div class="right">';
    html += '        <button class="btn btn-sm btn-outline" style="color:var(--text2);border-color:var(--border)" onclick="selectAllFields(\'' + id + '\', true)">ì „ì²´ ì„ íƒ</button>';
    html += '        <button class="btn btn-sm btn-outline" style="color:var(--text2);border-color:var(--border)" onclick="selectAllFields(\'' + id + '\', false)">í•„ìˆ˜ë§Œ</button>';
    html += '      </div>';
    html += '    </div>';
    html += '    <div class="fields-grid">';

    def.fields.forEach(function(f) {
      var isReq = f.required ? true : false;
      var isChecked = cfg.fields.indexOf(f.key) >= 0;
      var reqClass = isReq ? ' required' : '';

      html += '      <label class="field-item' + reqClass + '">';
      html += '        <input type="checkbox" ' + (isChecked ? 'checked' : '') + (isReq ? ' checked disabled' : '');
      html += '               onchange="toggleField(\'' + id + '\', \'' + f.key + '\', this.checked)">';
      html += '        <div>';
      html += '          <div class="field-label">' + f.label + (isReq ? ' âœ±' : '') + '</div>';
      html += '          <div class="field-key">' + f.key + '</div>';
      html += '        </div>';
      html += '      </label>';
    });

    html += '    </div>';
    html += '  </div>';
    html += '</div>';
  });

  container.innerHTML = html;
}

// ============================================================
// ì¸í„°ë™ì…˜
// ============================================================
function toggleExpand(id) {
  var el = document.getElementById('api-' + id);
  el.classList.toggle('expanded');
}

function toggleApi(id, enabled) {
  settings.apis[id].enabled = enabled;
  var el = document.getElementById('api-' + id);
  if (enabled) el.classList.remove('disabled');
  else el.classList.add('disabled');
  updateStats();
}

function toggleField(apiId, fieldKey, checked) {
  var fields = settings.apis[apiId].fields;
  if (checked && fields.indexOf(fieldKey) < 0) {
    fields.push(fieldKey);
  } else if (!checked) {
    settings.apis[apiId].fields = fields.filter(function(f) { return f !== fieldKey; });
  }
  // í•„ë“œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
  var el = document.getElementById('api-' + apiId);
  var countEl = el.querySelector('.api-count strong');
  countEl.textContent = settings.apis[apiId].fields.length + '/' + API_DEFS[apiId].fields.length;
}

function selectAllFields(apiId, all) {
  var def = API_DEFS[apiId];
  if (all) {
    settings.apis[apiId].fields = def.fields.map(function(f) { return f.key; });
  } else {
    settings.apis[apiId].fields = def.fields.filter(function(f) { return f.required; }).map(function(f) { return f.key; });
  }
  renderApiList();
}

function toggleAllApis(enabled) {
  Object.keys(settings.apis).forEach(function(id) {
    settings.apis[id].enabled = enabled;
  });
  renderApiList();
  updateStats();
}

function filterCategory(cat) {
  currentFilter = cat;
  document.querySelectorAll('.cat-tab').forEach(function(t) {
    t.classList.toggle('active', t.dataset.cat === cat);
  });
  renderApiList();
}

// ============================================================
// í†µê³„ ì—…ë°ì´íŠ¸
// ============================================================
function updateStats() {
  var total = Object.keys(API_DEFS).length;
  var active = Object.keys(settings.apis).filter(function(id) {
    return settings.apis[id].enabled;
  }).length;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statActive').textContent = active;
}

// ============================================================
// Firestore ì§ì ‘ í†µì‹ 
// ============================================================
// API ì„œë²„ ì£¼ì†Œ (ìˆ˜ë™ ìˆ˜ì§‘ íŠ¸ë¦¬ê±° ì „ìš©)
var _fssDefaultUrl = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5003' : '/fss';
(function(){ var el = document.getElementById('serverUrl'); if(el && !el.value) el.value = _fssDefaultUrl; })();

function getServerUrl() {
  return document.getElementById('serverUrl').value.trim() || _fssDefaultUrl;
}

async function loadFromServer() {
  if (!isFirebaseReady()) {
    showToast('Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...', 'info');
    return;
  }

  try {
    // Firestoreì—ì„œ ìŠ¤ì¼€ì¤„ ì„¤ì • ì½ê¸°
    var scheduleDoc = await db.collection('fss_config').doc('schedule').get();
    if (scheduleDoc.exists) {
      var s = scheduleDoc.data();
      document.getElementById('collectHour').value = s.collect_hour || 3;
      document.getElementById('collectMinute').value = s.collect_minute || 0;
      document.getElementById('collectMode').value = s.collect_mode || 'incremental';
      document.getElementById('apiKey').value = s.api_key || '';
      document.getElementById('batchSize').value = s.batch_size || 1000;
      document.getElementById('requestDelay').value = s.request_delay || 0.3;
      document.getElementById('scheduleActive').checked = s.is_active ? true : false;
    }

    // Firestoreì—ì„œ API ì„¤ì • ì½ê¸°
    var apiSnap = await db.collection('fss_config').doc('apis').collection('list').get();
    if (!apiSnap.empty) {
      apiSnap.forEach(function(doc) {
        var a = doc.data();
        if (settings.apis[a.api_source]) {
          settings.apis[a.api_source].enabled = a.is_enabled ? true : false;
          if (a.enabled_fields) {
            try { settings.apis[a.api_source].fields = JSON.parse(a.enabled_fields); }
            catch(e) {}
          }
        }
      });
      renderApiList();
    }

    updateStats();
    showToast('Firestoreì—ì„œ ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
  } catch(e) {
    console.log('Firestore ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e.message);
    updateStats();
    showToast('âš ï¸ Firestore ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
  }

  loadStatus();
  loadLogs();
}

async function loadStatus() {
  if (!isFirebaseReady()) return;

  try {
    // fss_config/data_counts ë©”íƒ€ë°ì´í„°ì—ì„œ ì¹´ìš´íŠ¸ ì¡°íšŒ (ê²½ëŸ‰)
    var countsDoc = await db.collection('fss_config').doc('data_counts').get();
    if (countsDoc.exists) {
      var data = countsDoc.data();
      var totals = data.total || {};
      document.getElementById('statBizCount').textContent = numberFormat(totals.fss_businesses || 0);
      document.getElementById('statPrdCount').textContent = numberFormat(totals.fss_products || 0);
    } else {
      document.getElementById('statBizCount').textContent = '-';
      document.getElementById('statPrdCount').textContent = '-';
    }

    // ìµœê·¼ ìˆ˜ì§‘ ë¡œê·¸ì—ì„œ ìµœê·¼ ìˆ˜ì§‘ì¼ ì¡°íšŒ
    var logSnap;
    try {
      logSnap = await db.collection('fss_collect_log')
        .orderBy('started_at', 'desc').limit(1).get();
    } catch(e2) {
      // orderBy ì¸ë±ìŠ¤ ì—†ì„ ì‹œ ì „ì²´ ì¡°íšŒ í›„ ìµœì‹  ì°¾ê¸°
      var allLogs = await db.collection('fss_collect_log').get();
      var latest = null;
      allLogs.docs.forEach(function(doc) {
        var d = doc.data();
        if (!latest || (d.started_at && d.started_at > (latest.started_at || ''))) latest = d;
      });
      if (latest) {
        var lastDt = latest.started_at || '';
        document.getElementById('statLastCollect').textContent = toKST(lastDt);
      }
      return;
    }
    if (!logSnap.empty) {
      var lastLog = logSnap.docs[0].data();
      var lastDt = lastLog.started_at || '';
      document.getElementById('statLastCollect').textContent = toKST(lastDt);
    } else {
      document.getElementById('statLastCollect').textContent = '-';
    }
  } catch(e) {
    console.warn('loadStatus ì˜¤ë¥˜:', e.message);
  }
}

async function loadLogs() {
  if (!isFirebaseReady()) return;

  try {
    var logSnap;
    try {
      logSnap = await db.collection('fss_collect_log')
        .orderBy('started_at', 'desc').limit(20).get();
    } catch(e2) {
      // orderBy ì¸ë±ìŠ¤ ì—†ì„ ì‹œ ì „ì²´ ì¡°íšŒ í›„ ì •ë ¬
      var allSnap = await db.collection('fss_collect_log').get();
      var allDocs = allSnap.docs.map(function(d) { return d; });
      allDocs.sort(function(a, b) {
        return (b.data().started_at || '').localeCompare(a.data().started_at || '');
      });
      logSnap = { empty: allDocs.length === 0, docs: allDocs.slice(0, 20), forEach: function(fn) { this.docs.forEach(fn); } };
    }

    if (logSnap.empty) {
      document.getElementById('logBody').innerHTML =
        '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">ìˆ˜ì§‘ ì´ë ¥ ì—†ìŒ</td></tr>';
      return;
    }

    var html = '';
    logSnap.forEach(function(doc) {
      var l = doc.data();
      var statusClass = (l.error_count || 0) > 0 ? 'warn' : 'ok';
      html += '<tr>';
      html += '<td>' + toKST(l.started_at) + '</td>';
      html += '<td><span class="status-dot ' + statusClass + '"></span>' + (l.api_source || '') + ' ' + (l.api_name || '') + '</td>';
      html += '<td>' + (l.collect_type || '') + '</td>';
      html += '<td>' + numberFormat(l.total_count) + '</td>';
      html += '<td>' + numberFormat(l.fetched_count) + '</td>';
      html += '<td style="color:var(--success)">' + numberFormat(l.inserted_count) + '</td>';
      html += '<td style="color:var(--primary)">' + numberFormat(l.updated_count) + '</td>';
      html += '<td style="color:' + ((l.error_count || 0) > 0 ? 'var(--danger)' : 'var(--text3)') + '">' + (l.error_count || 0) + '</td>';
      html += '<td>' + (l.duration_sec || 0) + 'ì´ˆ</td>';
      html += '</tr>';
    });
    document.getElementById('logBody').innerHTML = html;
  } catch(e) {
    console.warn('loadLogs ì˜¤ë¥˜:', e.message);
  }
}

async function saveAllSettings() {
  if (!isFirebaseReady()) {
    showToast('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
  }

  try {
    // Firestoreì— ìŠ¤ì¼€ì¤„ ì„¤ì • ì €ì¥
    await db.collection('fss_config').doc('schedule').set({
      collect_hour: parseInt(document.getElementById('collectHour').value),
      collect_minute: parseInt(document.getElementById('collectMinute').value),
      collect_mode: document.getElementById('collectMode').value,
      api_key: document.getElementById('apiKey').value.trim(),
      batch_size: parseInt(document.getElementById('batchSize').value),
      request_delay: parseFloat(document.getElementById('requestDelay').value),
      is_active: document.getElementById('scheduleActive').checked ? true : false,
    });

    // Firestoreì— API ì„¤ì • ì €ì¥
    var batch = db.batch();
    Object.keys(settings.apis).forEach(function(id) {
      var docRef = db.collection('fss_config').doc('apis').collection('list').doc(id);
      batch.set(docRef, {
        api_source: id,
        api_name: API_DEFS[id].name,
        category: API_DEFS[id].category,
        is_enabled: settings.apis[id].enabled,
        enabled_fields: JSON.stringify(settings.apis[id].fields || []),
        all_fields: JSON.stringify(API_DEFS[id].fields || []),
      });
    });
    await batch.commit();

    showToast('ì„¤ì •ì´ Firestoreì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  } catch(e) {
    showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
    // localStorage í´ë°±
    try {
      localStorage.setItem('fss_settings', JSON.stringify({
        schedule: {
          collect_hour: parseInt(document.getElementById('collectHour').value),
          collect_minute: parseInt(document.getElementById('collectMinute').value),
        }
      }));
    } catch(e2) {}
  }
}

// ============================================================
// ìˆ˜ë™ ìˆ˜ì§‘ (API ì„œë²„ íŠ¸ë¦¬ê±° ìœ ì§€)
// ============================================================
function confirmManualCollect() {
  var activeApis = Object.keys(settings.apis).filter(function(id) {
    return settings.apis[id].enabled;
  });
  document.getElementById('modalMsg').innerHTML =
    'í™œì„±í™”ëœ <strong>' + activeApis.length + 'ê°œ API</strong>ì— ëŒ€í•´ ìˆ˜ë™ ìˆ˜ì§‘ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>' +
    'í˜„ì¬ ëª¨ë“œ: <strong>' + document.getElementById('collectMode').value + '</strong><br>' +
    '<span style="color:var(--text3);font-size:12px">ì „ì²´ ìˆ˜ì§‘ì€ 30~60ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>';
  document.getElementById('confirmModal').classList.add('show');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('show');
}

function doManualCollect() {
  closeModal();
  var url = getServerUrl();
  var mode = document.getElementById('collectMode').value;
  var activeApis = Object.keys(settings.apis).filter(function(id) {
    return settings.apis[id].enabled;
  });

  showToast('ìˆ˜ì§‘ ìš”ì²­ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤...', 'info');

  fetch(url + '/api/admin/collect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ mode: mode, apis: activeApis })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.success) {
      showToast('ìˆ˜ì§‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë ¥ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.', 'success');
      setTimeout(loadLogs, 5000);
    } else {
      showToast('ìˆ˜ì§‘ ì‹¤íŒ¨: ' + (data.error || ''), 'error');
    }
  })
  .catch(function(e) {
    showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
  });
}

// ============================================================
// ìœ í‹¸
// ============================================================
function toKST(isoStr) {
  if (!isoStr || isoStr === 'None') return '-';
  var d = new Date(isoStr.endsWith('Z') || isoStr.includes('+') ? isoStr : isoStr + 'Z');
  if (isNaN(d.getTime())) return '-';
  return d.toLocaleString('ko-KR', {
    timeZone: 'Asia/Seoul',
    month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit',
    hour12: false
  });
}

function numberFormat(n) {
  if (n === null || n === undefined) return '-';
  return Number(n).toLocaleString();
}

function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + (type || 'info');
  setTimeout(function() { el.classList.add('show'); }, 10);
  setTimeout(function() { el.classList.remove('show'); }, 3500);
}

// â”€â”€â”€ Init â”€â”€â”€
init();
// Firebase ì¤€ë¹„ í›„ ì„œë²„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
waitForFirebase().then(function() {
  loadFromServer();
});
</script>
</div><!-- /main-wrapper -->
</div><!-- /app-layout -->
</body>
</html>
