<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹ì•½ì²˜ API ì—°ê²° í…ŒìŠ¤íŠ¸</title>
<style>
  body { font-family: -apple-system, 'Noto Sans KR', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
  .container { max-width: 800px; margin: 0 auto; }
  h1 { font-size: 22px; color: #1a1a2e; margin-bottom: 8px; }
  .sub { color: #667085; font-size: 14px; margin-bottom: 24px; }
  .card { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .card-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; color: #344054; }
  .status { display: flex; align-items: center; gap: 10px; padding: 16px; border-radius: 8px; font-size: 15px; font-weight: 600; }
  .status.waiting { background: #f8f9fa; color: #667085; }
  .status.testing { background: #fff3cd; color: #856404; }
  .status.success { background: #d4edda; color: #155724; }
  .status.fail { background: #f8d7da; color: #721c24; }
  .status .icon { font-size: 24px; }
  .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: #1565c0; color: #fff; }
  .btn-primary:hover { background: #0d47a1; transform: translateY(-1px); }
  .btn-primary:disabled { background: #90caf9; cursor: not-allowed; transform: none; }
  .btn-secondary { background: #e3f2fd; color: #1565c0; margin-left: 8px; }
  .result-box { background: #1a1a2e; color: #0f0; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; margin-top: 16px; display: none; }
  .info-row { display: flex; gap: 12px; margin-bottom: 8px; font-size: 13px; }
  .info-label { color: #667085; min-width: 100px; }
  .info-value { color: #344054; font-weight: 600; font-family: monospace; }
  .checklist { list-style: none; padding: 0; }
  .checklist li { padding: 8px 0; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 8px; font-size: 14px; }
  .checklist li:last-child { border-bottom: none; }
  .check { font-size: 18px; }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ›ï¸ ì‹ì•½ì²˜ í†µí•©LIMS API ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
  <p class="sub">ì„œë²„ â†’ ì¤‘ê°„ëª¨ë“ˆ(Tomcat) â†’ ì‹ì•½ì²˜ API ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸</p>

  <!-- ì—°ê²° ìƒíƒœ -->
  <div class="card">
    <div class="card-title">ì—°ê²° ìƒíƒœ</div>
    <div id="status" class="status waiting">
      <span class="icon">â³</span>
      <span>ì•„ì§ í…ŒìŠ¤íŠ¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</span>
    </div>
    <div style="margin-top: 16px;">
      <button class="btn btn-primary" id="btnTest" onclick="runTest()">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
      <button class="btn btn-secondary" onclick="runFullTest()">ğŸ“‹ ì „ì²´ API í…ŒìŠ¤íŠ¸</button>
    </div>
    <div id="resultBox" class="result-box"></div>
  </div>

  <!-- ì„¤ì • ì •ë³´ -->
  <div class="card">
    <div class="card-title">í˜„ì¬ ì„¤ì •</div>
    <div class="info-row">
      <span class="info-label">í”„ë¡ì‹œ ê²½ë¡œ</span>
      <span class="info-value" id="cfgProxy">/mfds</span>
    </div>
    <div class="info-row">
      <span class="info-label">ì‹ì•½ì²˜ ì„œë²„</span>
      <span class="info-value" id="cfgUrl">https://wslims.mfds.go.kr</span>
    </div>
    <div class="info-row">
      <span class="info-label">í…ŒìŠ¤íŠ¸ ê³„ì •</span>
      <span class="info-value" id="cfgUser">apitest34</span>
    </div>
    <div class="info-row">
      <span class="info-label">ê¸°ê´€ì½”ë“œ</span>
      <span class="info-value" id="cfgInst">O000170</span>
    </div>
    <div class="info-row">
      <span class="info-label">ì—…ë¬´ë¶„ì•¼</span>
      <span class="info-value" id="cfgClass">IM36 (ì‹í’ˆ)</span>
    </div>
    <div class="info-row">
      <span class="info-label">webApi</span>
      <span class="info-value" style="color:#e65100;">Y (í•„ìˆ˜ â€” ê°€ì´ë“œ ë¯¸ìˆ˜ë¡ íŒŒë¼ë¯¸í„°)</span>
    </div>
  </div>

  <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
  <div class="card">
    <div class="card-title">ì²´í¬ í•­ëª©</div>
    <ul class="checklist" id="checklist">
      <li><span class="check" id="chk1">â¬œ</span> nginx í”„ë¡ì‹œ (/mfds â†’ Tomcat 8080)</li>
      <li><span class="check" id="chk2">â¬œ</span> ì¤‘ê°„ëª¨ë“ˆ (selectUnitTest ì—”ë“œí¬ì¸íŠ¸)</li>
      <li><span class="check" id="chk3">â¬œ</span> MAC ì£¼ì†Œ ì¸ì¦ (O000170 ê¸°ê´€)</li>
      <li><span class="check" id="chk4">â¬œ</span> ì¸ì¦ì„œ ê²€ì¦ (O000170.jks)</li>
      <li><span class="check" id="chk5">â¬œ</span> API ë°ì´í„° ì‘ë‹µ (resultFlag=1)</li>
    </ul>
  </div>
</div>

<!-- Firebase + MFDS API -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/mfds-api.js"></script>

<script>
function setStatus(type, icon, text) {
  var el = document.getElementById('status');
  el.className = 'status ' + type;
  el.innerHTML = '<span class="icon">' + icon + '</span><span>' + text + '</span>';
}

function setCheck(num, pass) {
  document.getElementById('chk' + num).textContent = pass ? 'âœ…' : 'âŒ';
}

function log(msg) {
  var box = document.getElementById('resultBox');
  box.style.display = 'block';
  var time = new Date().toLocaleTimeString('ko-KR');
  box.textContent += '[' + time + '] ' + msg + '\n';
  box.scrollTop = box.scrollHeight;
}

async function runTest() {
  var btn = document.getElementById('btnTest');
  btn.disabled = true;
  document.getElementById('resultBox').textContent = '';

  setStatus('testing', 'ğŸ”„', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
  log('=== ì‹ì•½ì²˜ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  log('í”„ë¡ì‹œ: ' + MFDS.PROXY_BASE);
  log('ì„œë²„: ' + MFDS.WSLIMS_URL);
  log('ê³„ì •: ' + MFDS.DEFAULT_USER.mfdsLimsId);
  log('webApi: Y');
  log('');

  // 1ë‹¨ê³„: í”„ë¡ì‹œ ì—°ê²° í™•ì¸
  log('[1/3] nginx í”„ë¡ì‹œ ì—°ê²° í™•ì¸...');
  try {
    var result = await MFDS.testConnection();
    setCheck(1, true); // nginx OK
    setCheck(2, true); // ì¤‘ê°„ëª¨ë“ˆ OK
    log('  â†’ í”„ë¡ì‹œ ì—°ê²°: OK');
    log('  â†’ ì¤‘ê°„ëª¨ë“ˆ ì‘ë‹µ: OK');

    if (result.authenticated) {
      setCheck(3, true); // MAC OK
      setCheck(4, true); // ì¸ì¦ì„œ OK
      setCheck(5, true); // ë°ì´í„° OK
      log('');
      log('[2/3] ì¸ì¦ ê²°ê³¼: âœ… ì„±ê³µ!');
      log('  â†’ MAC ì¸ì¦: í†µê³¼');
      log('  â†’ ì¸ì¦ì„œ ê²€ì¦: í†µê³¼');
      log('  â†’ resultFlag: 1, validate: true');

      if (result.data && result.data.resultData) {
        log('');
        log('[3/3] ì‘ë‹µ ë°ì´í„°: ' + result.data.resultData.length + 'ê±´');
        result.data.resultData.forEach(function(item) {
          log('  ' + item.codeNo + ' - ' + (item.codeName || '') + ' (' + (item.codeEngName || '') + ')');
        });
      }

      setStatus('success', 'ğŸ‰', 'API ì—°ê²° ì„±ê³µ! ëª¨ë“  ì¸ì¦ í†µê³¼');
      log('');
      log('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ì„±ê³µ ===');
    } else {
      setCheck(3, false);
      log('');
      log('[2/3] ì¸ì¦ ê²°ê³¼: âŒ ì‹¤íŒ¨');
      log('  â†’ ì˜¤ë¥˜: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ìŒ'));
      setStatus('fail', 'âŒ', 'ì¸ì¦ ì‹¤íŒ¨: ' + (result.error || ''));
      log('');
      log('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ì¸ì¦ ì‹¤íŒ¨ ===');
    }
  } catch (err) {
    if (!err.connected) {
      setCheck(1, false);
      log('  â†’ í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨: ' + (err.error || err.message || ''));
      setStatus('fail', 'âŒ', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨ â€” nginx/Tomcat í™•ì¸ í•„ìš”');
    } else {
      setCheck(1, true);
      log('  â†’ ì˜¤ë¥˜: ' + (err.message || JSON.stringify(err)));
      setStatus('fail', 'âŒ', 'ì˜¤ë¥˜ ë°œìƒ');
    }
    log('');
    log('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ì‹¤íŒ¨ ===');
  }

  btn.disabled = false;
}

async function runFullTest() {
  document.getElementById('resultBox').textContent = '';
  document.getElementById('resultBox').style.display = 'block';

  log('=== ì „ì²´ API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ===');

  // í…ŒìŠ¤íŠ¸ 1: ê³µí†µì½”ë“œ ì¡°íšŒ
  log('');
  log('[í…ŒìŠ¤íŠ¸ 1] ê³µí†µì½”ë“œ ì¡°íšŒ (selectListCmmnCode)...');
  try {
    var res1 = await MFDS.selectListCmmnCode();
    log('  â†’ ì„±ê³µ! ' + (res1.resultData ? res1.resultData.length + 'ê±´' : 'OK'));
  } catch(e) {
    log('  â†’ ì‹¤íŒ¨: ' + (e.message || JSON.stringify(e)));
  }

  // í…ŒìŠ¤íŠ¸ 2: ì˜ë¢° ëª©ë¡ ì¡°íšŒ
  log('');
  log('[í…ŒìŠ¤íŠ¸ 2] ì˜ë¢° ëª©ë¡ ì¡°íšŒ (selectListInspctReqest)...');
  try {
    var res2 = await MFDS.selectListInspctReqest({
      reqestDeStart: '20260101',
      reqestDeEnd: '20260226'
    });
    var cnt = res2.resultData ? res2.resultData.length : 0;
    log('  â†’ ì„±ê³µ! ' + cnt + 'ê±´');
  } catch(e) {
    log('  â†’ ì‹¤íŒ¨: ' + (e.message || JSON.stringify(e)));
  }

  // í…ŒìŠ¤íŠ¸ 3: ë¶€ì„œ ëª©ë¡ ì¡°íšŒ
  log('');
  log('[í…ŒìŠ¤íŠ¸ 3] ë¶€ì„œ ëª©ë¡ ì¡°íšŒ (selectListDept)...');
  var bflDeptCode = '';
  try {
    var res3 = await MFDS.callApi('selectListDept', {});
    var cnt3 = res3.resultData ? res3.resultData.length : 0;
    log('  â†’ ì„±ê³µ! ' + cnt3 + 'ê±´');
    if (res3.resultData) {
      res3.resultData.forEach(function(d) {
        log('    ' + (d.codeNo || '') + ' - ' + (d.codeName || ''));
        // ë°”ì´ì˜¤í‘¸ë“œë© ë¶€ì„œì½”ë“œ ì €ì¥ (í…ŒìŠ¤íŠ¸ 4ì—ì„œ ì‚¬ìš©)
        if (d.codeName && d.codeName.indexOf('ë°”ì´ì˜¤í‘¸ë“œë©') >= 0) {
          bflDeptCode = d.codeNo;
        }
      });
    }
  } catch(e) {
    log('  â†’ ì‹¤íŒ¨: ' + (e.message || JSON.stringify(e)));
  }

  // í…ŒìŠ¤íŠ¸ 4: ì§ì› ëª©ë¡ ì¡°íšŒ (ë¶€ì„œì½”ë“œ í•„ìˆ˜)
  log('');
  var deptForTest = bflDeptCode || 'D003194';
  log('[í…ŒìŠ¤íŠ¸ 4] ì§ì› ëª©ë¡ ì¡°íšŒ (selectListEmp, ë¶€ì„œ: ' + deptForTest + ')...');
  try {
    var res4 = await MFDS.callApi('selectListEmp', { deptCode: deptForTest });
    var cnt4 = res4.resultData ? res4.resultData.length : 0;
    log('  â†’ ì„±ê³µ! ' + cnt4 + 'ê±´');
    if (res4.resultData) {
      res4.resultData.forEach(function(u) {
        log('    ' + (u.codeNo || '') + ' - ' + (u.codeName || ''));
      });
    }
  } catch(e) {
    log('  â†’ ì‹¤íŒ¨: ' + (e.message || JSON.stringify(e)));
  }

  // í…ŒìŠ¤íŠ¸ 5: í’ˆëª©ë¶„ë¥˜ ëŒ€ë¶„ë¥˜ ì¡°íšŒ
  log('');
  log('[í…ŒìŠ¤íŠ¸ 5] í’ˆëª©ë¶„ë¥˜ ëŒ€ë¶„ë¥˜ ì¡°íšŒ (selectListPrdlstLclas)...');
  try {
    var res5 = await MFDS.callApi('selectListPrdlstLclas', {});
    var cnt5 = res5.resultData ? res5.resultData.length : 0;
    log('  â†’ ì„±ê³µ! ' + cnt5 + 'ê±´');
    if (res5.resultData) {
      res5.resultData.slice(0, 5).forEach(function(item) {
        log('    ' + (item.codeNo || item.prdlstLclasCode || '') + ' - ' + (item.codeName || item.prdlstLclasNm || ''));
      });
      if (cnt5 > 5) log('    ... ì™¸ ' + (cnt5 - 5) + 'ê±´');
    }
  } catch(e) {
    log('  â†’ ì‹¤íŒ¨: ' + (e.message || JSON.stringify(e)));
  }

  log('');
  log('=== ì „ì²´ API í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
}
</script>
</body>
</html>
