<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab - ê¸°íƒ€ ì„¤ì •</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,sans-serif;height:100vh;background:#f8f9fb;font-size:13px;overflow:hidden;display:flex}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;margin-left:250px;height:100vh}
.topbar{background:#fff;padding:16px 32px;display:flex;align-items:center;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:50}
.topbar .crumb{font-size:13px;color:#6b7280}.crumb b{color:#111;font-weight:700}
.content{flex:1;padding:28px 32px;overflow-y:auto}
.page-title{font-size:22px;font-weight:800;color:#111;margin-bottom:4px}
.page-desc{font-size:13px;color:#6b7280;margin-bottom:24px}

/* íƒ­ */
.settings-tabs{display:flex;gap:0;border-bottom:2px solid #e5e7eb;margin-bottom:24px}
.settings-tab{padding:12px 24px;font-size:14px;font-weight:500;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.settings-tab:hover{color:#111;background:#f3f4f6}
.settings-tab.active{color:#2563eb;border-bottom-color:#2563eb;font-weight:700}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* ì¹´ë“œ */
.card{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:24px;margin-bottom:20px}
.card-title{font-size:16px;font-weight:700;color:#111;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* í…Œì´ë¸” */
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{padding:10px 14px;text-align:left;border-bottom:1px solid #f0f0f0;font-size:13px}
.tbl th{background:#f9fafb;font-weight:600;color:#374151}
.tbl tr:hover td{background:#f9fafb}
.tbl input{padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;width:100%}

/* ë²„íŠ¼ */
.btn{padding:8px 16px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8}
.btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626}
.btn-outline{background:#fff;color:#374151;border:1px solid #d1d5db}.btn-outline:hover{background:#f3f4f6}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-group{display:flex;gap:8px;margin-top:16px}

/* ì‹ í˜¸ë“±/ë“±ê¸‰ ê·œì¹™ */
.rule-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #f0f0f0}
.rule-row:last-child{border-bottom:none}
.color-dot{width:16px;height:16px;border-radius:50%;flex-shrink:0}
.rule-label{font-weight:600;min-width:60px}
.rule-desc{flex:1;color:#6b7280;font-size:13px}
.rule-input{width:80px;padding:5px 8px;border:1px solid #d1d5db;border-radius:6px;text-align:center;font-size:13px}
.rule-text-input{width:100%;padding:5px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}

/* ë“±ê¸‰ ë°°ì§€ */
.grade-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;font-weight:700;font-size:12px;color:#fff}

/* íœ´ì¼ ìº˜ë¦°ë” */
.holiday-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.holiday-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#fef3c7;border-radius:8px;border:1px solid #fbbf24}
.holiday-item .date{font-weight:600;color:#92400e}
.holiday-item .name{font-size:12px;color:#78350f}
.holiday-item .del{background:none;border:none;color:#dc2626;cursor:pointer;font-size:16px;padding:0 4px}
.add-holiday{display:flex;gap:8px;margin-bottom:16px;align-items:flex-end;flex-wrap:wrap}
.add-holiday label{font-size:12px;font-weight:600;color:#374151;display:block;margin-bottom:4px}
.add-holiday input{padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:30px;right:30px;background:#1e293b;color:#fff;padding:14px 24px;border-radius:10px;font-size:14px;z-index:9999;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
</style>
</head>
<body>

<!-- Unified Sidebar -->
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=3"></script>

<div class="main">
  <div class="topbar"><span class="crumb">ê´€ë¦¬ì â€º <b>ê¸°íƒ€ ì„¤ì •</b></span></div>

  <div class="content">
    <div class="page-title">ê¸°íƒ€ ì„¤ì •</div>
    <div class="page-desc">ì‹ í˜¸ë“± ê·œì¹™, ë“±ê¸‰ ê·œì¹™, íœ´ì¼ ê´€ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</div>

    <!-- íƒ­ -->
    <div class="settings-tabs">
      <div class="settings-tab active" onclick="showSettingsTab(0)">ğŸš¦ ì‹ í˜¸ë“± ê·œì¹™</div>
      <div class="settings-tab" onclick="showSettingsTab(1)">ğŸ… ë“±ê¸‰ ê·œì¹™</div>
      <div class="settings-tab" onclick="showSettingsTab(2)">ğŸ“… íœ´ì¼ ê´€ë¦¬</div>
      <div class="settings-tab" onclick="showSettingsTab(3)">ğŸŒ¤ï¸ ë‚ ì”¨ ì„¤ì •</div>
    </div>

    <!-- ======================== íƒ­ 0: ì‹ í˜¸ë“± ê·œì¹™ ======================== -->
    <div class="tab-panel active" id="panel-signal">
      <div class="card">
        <div class="card-title">ğŸš¦ ê³ ê°ì‚¬ ì‹ í˜¸ë“± ê·œì¹™</div>
        <p style="font-size:13px;color:#6b7280;margin-bottom:16px">ë¯¸ìˆ˜ê¸ˆ ê¸°ê°„ì— ë”°ë¼ ê³ ê°ì‚¬ ìƒíƒœë¥¼ ìë™ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>
        <div id="signal-rules">
          <div class="rule-row">
            <div class="color-dot" style="background:#22c55e"></div>
            <span class="rule-label">ğŸŸ¢ ì •ìƒ</span>
            <span class="rule-desc">ë¯¸ìˆ˜ê¸ˆ ì—†ìŒ ë˜ëŠ”</span>
            <input type="number" class="rule-input" id="signal-green-max" value="30" min="0"> <span>ì¼ ì´ë‚´</span>
          </div>
          <div class="rule-row">
            <div class="color-dot" style="background:#3b82f6"></div>
            <span class="rule-label">ğŸ”µ ì–‘í˜¸</span>
            <span class="rule-desc">ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ì¼</span>
            <input type="number" class="rule-input" id="signal-blue-min" value="31" min="0"> ~
            <input type="number" class="rule-input" id="signal-blue-max" value="60" min="0"> <span>ì¼</span>
          </div>
          <div class="rule-row">
            <div class="color-dot" style="background:#eab308"></div>
            <span class="rule-label">ğŸŸ¡ ì£¼ì˜</span>
            <span class="rule-desc">ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ì¼</span>
            <input type="number" class="rule-input" id="signal-yellow-min" value="61" min="0"> ~
            <input type="number" class="rule-input" id="signal-yellow-max" value="90" min="0"> <span>ì¼</span>
          </div>
          <div class="rule-row">
            <div class="color-dot" style="background:#f97316"></div>
            <span class="rule-label">ğŸŸ  ê²½ê³ </span>
            <span class="rule-desc">ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ì¼</span>
            <input type="number" class="rule-input" id="signal-orange-min" value="91" min="0"> ~
            <input type="number" class="rule-input" id="signal-orange-max" value="120" min="0"> <span>ì¼</span>
          </div>
          <div class="rule-row">
            <div class="color-dot" style="background:#ef4444"></div>
            <span class="rule-label">ğŸ”´ ìœ„í—˜</span>
            <span class="rule-desc">ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ì¼</span>
            <input type="number" class="rule-input" id="signal-red-min" value="121" min="0"> <span>ì¼ ì´ìƒ</span>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveSignalRules()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-outline" onclick="resetSignalRules()">â†©ï¸ ê¸°ë³¸ê°’ ë³µì›</button>
        </div>
      </div>
    </div>

    <!-- ======================== íƒ­ 1: ë“±ê¸‰ ê·œì¹™ (ë³µí•© ì ìˆ˜ ë°©ì‹) ======================== -->
    <div class="tab-panel" id="panel-grade">
      <!-- ë“±ê¸‰ ê¸°ì¤€ ì ìˆ˜ -->
      <div class="card">
        <div class="card-title">ğŸ… ë“±ê¸‰ ê¸°ì¤€ ì ìˆ˜ (ì´ 105ì )</div>
        <p style="font-size:13px;color:#6b7280;margin-bottom:16px">6ê°œ í‰ê°€ í•­ëª©ì˜ í•©ì‚° ì ìˆ˜ë¡œ ë“±ê¸‰ì„ ìë™ ì‚°ì •í•©ë‹ˆë‹¤.</p>
        <table class="tbl">
          <thead><tr><th style="width:80px">ë“±ê¸‰</th><th>ì¡°ê±´</th><th style="width:120px">ìµœì†Œ ì ìˆ˜</th></tr></thead>
          <tbody>
            <tr><td><span class="grade-badge" style="background:#ef4444">VIP</span></td><td>ìµœìš°ìˆ˜ ê³ ê°</td><td><input type="number" id="grade-vip-min" value="90" min="0" max="100" class="rule-input"></td></tr>
            <tr><td><span class="grade-badge" style="background:#22c55e">A</span></td><td>ìš°ìˆ˜ ê³ ê°</td><td><input type="number" id="grade-a-min" value="70" min="0" max="100" class="rule-input"></td></tr>
            <tr><td><span class="grade-badge" style="background:#3b82f6">B</span></td><td>ì¼ë°˜ ê³ ê°</td><td><input type="number" id="grade-b-min" value="50" min="0" max="100" class="rule-input"></td></tr>
            <tr><td><span class="grade-badge" style="background:#f97316">C</span></td><td>ì‹ ê·œ/ì†ŒëŸ‰ ê³ ê°</td><td style="color:#6b7280;font-size:13px">49ì  ì´í•˜</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 1. ì—°ê°„ ë§¤ì¶œì•¡ (40ì ) -->
      <div class="card">
        <div class="card-title">1ï¸âƒ£ ì—°ê°„ ë§¤ì¶œì•¡ <span style="color:#2563eb;font-size:13px;font-weight:400;margin-left:8px">ë°°ì : 40ì  â­ ê°€ì¥ ì¤‘ìš”</span></div>
        <table class="tbl">
          <thead><tr><th style="width:80px">ì ìˆ˜</th><th>ì¡°ê±´</th></tr></thead>
          <tbody>
            <tr><td><input type="number" id="rev-s5" value="40" min="0" max="40" class="rule-input"></td><td><input type="number" id="rev-t5" value="10000" class="rule-input" style="width:120px"> ë§Œì› ì´ìƒ</td></tr>
            <tr><td><input type="number" id="rev-s4" value="30" min="0" max="40" class="rule-input"></td><td><input type="number" id="rev-t4" value="5000" class="rule-input" style="width:120px"> ~ <span id="rev-t5-display">10,000</span> ë§Œì›</td></tr>
            <tr><td><input type="number" id="rev-s3" value="20" min="0" max="40" class="rule-input"></td><td><input type="number" id="rev-t3" value="3000" class="rule-input" style="width:120px"> ~ <span id="rev-t4-display">5,000</span> ë§Œì›</td></tr>
            <tr><td><input type="number" id="rev-s2" value="10" min="0" max="40" class="rule-input"></td><td><input type="number" id="rev-t2" value="1000" class="rule-input" style="width:120px"> ~ <span id="rev-t3-display">3,000</span> ë§Œì›</td></tr>
            <tr><td><input type="number" id="rev-s1" value="5" min="0" max="40" class="rule-input"></td><td><span id="rev-t2-display">1,000</span> ë§Œì› ë¯¸ë§Œ</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2. ê±°ë˜ ë¹ˆë„ (25ì ) -->
      <div class="card">
        <div class="card-title">2ï¸âƒ£ ê±°ë˜ ë¹ˆë„ <span style="color:#2563eb;font-size:13px;font-weight:400;margin-left:8px">ë°°ì : 25ì </span></div>
        <table class="tbl">
          <thead><tr><th style="width:80px">ì ìˆ˜</th><th>ì¡°ê±´</th></tr></thead>
          <tbody>
            <tr><td><input type="number" id="freq-s5" value="25" min="0" max="25" class="rule-input"></td><td>ì›” <input type="number" id="freq-t5" value="10" class="rule-input" style="width:80px"> ê±´ ì´ìƒ (ì—° 120ê±´+)</td></tr>
            <tr><td><input type="number" id="freq-s4" value="20" min="0" max="25" class="rule-input"></td><td>ì›” <input type="number" id="freq-t4" value="5" class="rule-input" style="width:80px"> ~ 9ê±´ (ì—° 60~119ê±´)</td></tr>
            <tr><td><input type="number" id="freq-s3" value="15" min="0" max="25" class="rule-input"></td><td>ì›” <input type="number" id="freq-t3" value="3" class="rule-input" style="width:80px"> ~ 4ê±´ (ì—° 36~59ê±´)</td></tr>
            <tr><td><input type="number" id="freq-s2" value="10" min="0" max="25" class="rule-input"></td><td>ì›” <input type="number" id="freq-t2" value="1" class="rule-input" style="width:80px"> ~ 2ê±´ (ì—° 12~35ê±´)</td></tr>
            <tr><td><input type="number" id="freq-s1" value="5" min="0" max="25" class="rule-input"></td><td>ì›” 1ê±´ ë¯¸ë§Œ</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 3. ê±°ë˜ ê¸°ê°„ (15ì ) -->
      <div class="card">
        <div class="card-title">3ï¸âƒ£ ê±°ë˜ ê¸°ê°„ <span style="color:#2563eb;font-size:13px;font-weight:400;margin-left:8px">ë°°ì : 15ì </span></div>
        <table class="tbl">
          <thead><tr><th style="width:80px">ì ìˆ˜</th><th>ì¡°ê±´</th></tr></thead>
          <tbody>
            <tr><td><input type="number" id="dur-s5" value="15" min="0" max="15" class="rule-input"></td><td><input type="number" id="dur-t5" value="5" class="rule-input" style="width:80px"> ë…„ ì´ìƒ</td></tr>
            <tr><td><input type="number" id="dur-s4" value="12" min="0" max="15" class="rule-input"></td><td><input type="number" id="dur-t4" value="3" class="rule-input" style="width:80px"> ~ 5ë…„</td></tr>
            <tr><td><input type="number" id="dur-s3" value="9" min="0" max="15" class="rule-input"></td><td><input type="number" id="dur-t3" value="2" class="rule-input" style="width:80px"> ~ 3ë…„</td></tr>
            <tr><td><input type="number" id="dur-s2" value="6" min="0" max="15" class="rule-input"></td><td><input type="number" id="dur-t2" value="1" class="rule-input" style="width:80px"> ~ 2ë…„</td></tr>
            <tr><td><input type="number" id="dur-s1" value="3" min="0" max="15" class="rule-input"></td><td>1ë…„ ë¯¸ë§Œ</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 4. ê²°ì œ ì‹ ë¢°ë„ (15ì ) â€” ì‹ í˜¸ë“± ê·œì¹™ ì—°ë™ -->
      <div class="card">
        <div class="card-title">4ï¸âƒ£ ê²°ì œ ì‹ ë¢°ë„ <span style="color:#2563eb;font-size:13px;font-weight:400;margin-left:8px">ë°°ì : 15ì  Â· ğŸš¦ ì‹ í˜¸ë“± ê·œì¹™ ì—°ë™</span></div>
        <p style="font-size:12px;color:#6b7280;margin-bottom:12px">ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ì¼ ê¸°ë°˜ ì‹ í˜¸ë“± ë“±ê¸‰ì— ë”°ë¼ ì ìˆ˜ê°€ ìë™ ë°°ì ë©ë‹ˆë‹¤. (ì‹ í˜¸ë“± ê·œì¹™ íƒ­ì—ì„œ ì¼ìˆ˜ ì„¤ì •)</p>
        <table class="tbl">
          <thead><tr><th style="width:80px">ì ìˆ˜</th><th>ì‹ í˜¸ë“±</th><th>ì¡°ê±´</th></tr></thead>
          <tbody>
            <tr><td><input type="number" id="pay-s5" value="15" min="0" max="15" class="rule-input"></td><td><span style="color:#22c55e;font-weight:700">ğŸŸ¢ ì •ìƒ</span></td><td>ë¯¸ìˆ˜ê¸ˆ ì—†ìŒ ë˜ëŠ” <span id="pay-desc-green"></span>ì¼ ì´ë‚´</td></tr>
            <tr><td><input type="number" id="pay-s4" value="12" min="0" max="15" class="rule-input"></td><td><span style="color:#3b82f6;font-weight:700">ğŸ”µ ì–‘í˜¸</span></td><td>ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ <span id="pay-desc-blue"></span></td></tr>
            <tr><td><input type="number" id="pay-s3" value="9" min="0" max="15" class="rule-input"></td><td><span style="color:#eab308;font-weight:700">ğŸŸ¡ ì£¼ì˜</span></td><td>ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ <span id="pay-desc-yellow"></span></td></tr>
            <tr><td><input type="number" id="pay-s2" value="6" min="0" max="15" class="rule-input"></td><td><span style="color:#f97316;font-weight:700">ğŸŸ  ê²½ê³ </span></td><td>ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ <span id="pay-desc-orange"></span></td></tr>
            <tr><td><input type="number" id="pay-s1" value="3" min="0" max="15" class="rule-input"></td><td><span style="color:#ef4444;font-weight:700">ğŸ”´ ìœ„í—˜</span></td><td>ë¯¸ìˆ˜ê¸ˆ ê²½ê³¼ <span id="pay-desc-red"></span>ì¼ ì´ìƒ</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 5. ë‹´ë‹¹ë¶€ì„œ (5ì ) -->
      <div class="card">
        <div class="card-title">5ï¸âƒ£ ë‹´ë‹¹ë¶€ì„œ <span style="color:#2563eb;font-size:13px;font-weight:400;margin-left:8px">ë°°ì : 5ì </span></div>
        <table class="tbl">
          <thead><tr><th style="width:80px">ì ìˆ˜</th><th>ë¶€ì„œ</th></tr></thead>
          <tbody>
            <tr><td><input type="number" id="dept-s3" value="5" min="0" max="5" class="rule-input"></td><td><input type="text" id="dept-c3" value="ê³ ê°ì§€ì›íŒ€, ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€" class="rule-text-input" readonly style="background:#f3f4f6"></td></tr>
            <tr><td><input type="number" id="dept-s2" value="3" min="0" max="5" class="rule-input"></td><td><input type="text" id="dept-c2" value="ê³ ê°ê´€ë¦¬" class="rule-text-input" readonly style="background:#f3f4f6"></td></tr>
            <tr><td><input type="number" id="dept-s1" value="1" min="0" max="5" class="rule-input"></td><td><input type="text" id="dept-c1" value="ì§€ì‚¬" class="rule-text-input" readonly style="background:#f3f4f6"></td></tr>
          </tbody>
        </table>
      </div>

      <!-- 6. ì ‘ìˆ˜í˜•íƒœ (5ì ) â€” ì‹ ê·œ -->
      <div class="card">
        <div class="card-title">6ï¸âƒ£ ì ‘ìˆ˜í˜•íƒœ <span style="color:#2563eb;font-size:13px;font-weight:400;margin-left:8px">ë°°ì : 5ì  Â· ğŸ†• ì‹ ê·œ</span></div>
        <table class="tbl">
          <thead><tr><th style="width:80px">ì ìˆ˜</th><th>ì ‘ìˆ˜ ë°©ë²•</th></tr></thead>
          <tbody>
            <tr><td><input type="number" id="rcpt-s3" value="5" min="0" max="5" class="rule-input"></td><td><input type="text" id="rcpt-c3" value="í™ˆí˜ì´ì§€ì ‘ìˆ˜" class="rule-text-input"></td></tr>
            <tr><td><input type="number" id="rcpt-s2" value="3" min="0" max="5" class="rule-input"></td><td><input type="text" id="rcpt-c2" value="ë°©ë¬¸ì ‘ìˆ˜" class="rule-text-input"></td></tr>
            <tr><td><input type="number" id="rcpt-s1" value="1" min="0" max="5" class="rule-input"></td><td><input type="text" id="rcpt-c1" value="íƒë°°ì ‘ìˆ˜" class="rule-text-input"></td></tr>
          </tbody>
        </table>
      </div>

      <div class="btn-group" style="margin-bottom:24px">
        <button class="btn btn-primary" onclick="saveGradeRules()">ğŸ’¾ ì „ì²´ ì €ì¥</button>
        <button class="btn btn-outline" onclick="resetGradeRules()">â†©ï¸ ê¸°ë³¸ê°’ ë³µì›</button>
      </div>
    </div>

    <!-- ======================== íƒ­ 2: íœ´ì¼ ê´€ë¦¬ ======================== -->
    <div class="tab-panel" id="panel-holiday">

      <div class="card">
        <div class="card-title">ğŸ“… íœ´ì¼ ê´€ë¦¬</div>
        <p style="font-size:13px;color:#6b7280;margin-bottom:16px">ë“±ë¡ëœ íœ´ì¼ì€ ì²˜ë¦¬ê¸°í•œ ê³„ì‚°(ì›Œí‚¹ë°ì´) ì‹œ ì œì™¸ë©ë‹ˆë‹¤. ì£¼ë§(í† /ì¼)ì€ ìë™ ì œì™¸ë©ë‹ˆë‹¤.</p>

        <div class="add-holiday">
          <div>
            <label>ë‚ ì§œ</label>
            <input type="date" id="holiday-date">
          </div>
          <div>
            <label>ëª…ì¹­</label>
            <input type="text" id="holiday-name" placeholder="ì˜ˆ: ì„¤ë‚ , ì¶”ì„">
          </div>
          <button class="btn btn-primary" onclick="addHoliday()">+ ì¶”ê°€</button>
          <button class="btn btn-outline" onclick="addDefaultHolidays()">ğŸ“‹ 2026ë…„ ê³µíœ´ì¼ ì¼ê´„ ë“±ë¡</button>
        </div>

        <div class="holiday-grid" id="holiday-list"></div>
      </div>
    </div>

    <!-- ======================== íƒ­ 3: ë‚ ì”¨ ì„¤ì • ======================== -->
    <div class="tab-panel" id="panel-weather">
      <div class="card">
        <div class="card-title">ğŸŒ¤ï¸ ì‚¬ì´ë“œë°” ë‚ ì”¨ ìœ„ì ¯ ì„¤ì •</div>
        <p style="font-size:13px;color:#6b7280;margin-bottom:20px">
          ì‚¬ì´ë“œë°” í•˜ë‹¨ì— í˜„ì¬ ë‚ ì”¨ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ê¸°ìƒì²­ ë‹¨ê¸°ì˜ˆë³´ API ì¸ì¦í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì…ë ¥í•˜ì„¸ìš”.
          <br><a href="https://www.data.go.kr/data/15084084/openapi.do" target="_blank" style="color:#2563eb;text-decoration:underline">ê³µê³µë°ì´í„°í¬í„¸ ë°”ë¡œê°€ê¸°</a>
        </p>

        <div style="display:flex;flex-direction:column;gap:16px;max-width:600px">
          <div>
            <label style="font-size:13px;font-weight:600;color:#374151;display:block;margin-bottom:6px">API ì¸ì¦í‚¤ (Encoding)</label>
            <input type="text" id="weather-api-key" placeholder="ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°œê¸‰ë°›ì€ ì¸ì¦í‚¤ ì…ë ¥" style="width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:13px">
            <p style="font-size:11px;color:#9ca3af;margin-top:4px">ë§ˆì´í˜ì´ì§€ > ì¸ì¦í‚¤ ë°œê¸‰í˜„í™© > ì¼ë°˜ ì¸ì¦í‚¤ (Encoding) ê°’ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
          </div>

          <div>
            <label style="font-size:13px;font-weight:600;color:#374151;display:block;margin-bottom:6px">ì§€ì—­ ì„ íƒ</label>
            <select id="weather-region" style="width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;background:#fff">
              <option value="">-- ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš” --</option>
              <option value="60,127">ì„œìš¸</option>
              <option value="55,124">ì¸ì²œ</option>
              <option value="60,121">ìˆ˜ì›</option>
              <option value="69,106">ì²­ì£¼</option>
              <option value="67,100">ëŒ€ì „</option>
              <option value="66,103">ì„¸ì¢…</option>
              <option value="89,90">ëŒ€êµ¬</option>
              <option value="98,76">ë¶€ì‚°</option>
              <option value="102,84">ìš¸ì‚°</option>
              <option value="58,74">ê´‘ì£¼</option>
              <option value="63,89">ì „ì£¼</option>
              <option value="73,134">ì¶˜ì²œ</option>
              <option value="92,131">ê°•ë¦‰</option>
              <option value="52,38">ì œì£¼</option>
              <option value="89,77">ì°½ì›</option>
              <option value="102,94">í¬í•­</option>
            </select>
          </div>
        </div>

        <div class="btn-group" style="margin-top:20px">
          <button class="btn btn-primary" onclick="saveWeatherSettings()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-outline" onclick="testWeatherAPI()">ğŸ” API í…ŒìŠ¤íŠ¸</button>
        </div>

        <div id="weather-test-result" style="margin-top:16px;display:none">
          <div class="card" style="background:#f0fdf4;border-color:#86efac;margin-bottom:0">
            <div id="weather-test-content" style="font-size:14px;color:#166534"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>

<script>
// ============================================================================
// íƒ­ ì „í™˜
// ============================================================================
const panels = ['panel-signal', 'panel-grade', 'panel-holiday', 'panel-weather'];
function showSettingsTab(idx) {
    document.querySelectorAll('.settings-tab').forEach((t,i) => t.classList.toggle('active', i===idx));
    panels.forEach((p,i) => document.getElementById(p).classList.toggle('active', i===idx));
}

// ============================================================================
// í† ìŠ¤íŠ¸
// ============================================================================
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

// ============================================================================
// ì‹ í˜¸ë“± ê·œì¹™
// ============================================================================
const SIGNAL_DEFAULTS = {green:30, blueMin:31, blueMax:60, yellowMin:61, yellowMax:90, orangeMin:91, orangeMax:120, redMin:121};

async function loadSignalRules() {
    var saved = SIGNAL_DEFAULTS;
    try {
        var fsData = await fsGetSettings('signalRules');
        if (fsData && fsData.green !== undefined) saved = fsData;
    } catch(e) { console.warn('Firestore ì‹ í˜¸ë“± ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', e.message); }
    document.getElementById('signal-green-max').value = saved.green;
    document.getElementById('signal-blue-min').value = saved.blueMin;
    document.getElementById('signal-blue-max').value = saved.blueMax;
    document.getElementById('signal-yellow-min').value = saved.yellowMin;
    document.getElementById('signal-yellow-max').value = saved.yellowMax;
    document.getElementById('signal-orange-min').value = saved.orangeMin;
    document.getElementById('signal-orange-max').value = saved.orangeMax;
    document.getElementById('signal-red-min').value = saved.redMin;
}

async function saveSignalRules() {
    const rules = {
        green: +document.getElementById('signal-green-max').value,
        blueMin: +document.getElementById('signal-blue-min').value,
        blueMax: +document.getElementById('signal-blue-max').value,
        yellowMin: +document.getElementById('signal-yellow-min').value,
        yellowMax: +document.getElementById('signal-yellow-max').value,
        orangeMin: +document.getElementById('signal-orange-min').value,
        orangeMax: +document.getElementById('signal-orange-max').value,
        redMin: +document.getElementById('signal-red-min').value
    };
    try {
        await fsSaveSettings('signalRules', rules);
        updatePaymentSignalDisplay();
        toast('âœ… ì‹ í˜¸ë“± ê·œì¹™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e) {
        console.error('ì‹ í˜¸ë“± ê·œì¹™ ì €ì¥ ì‹¤íŒ¨:', e);
        toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    }
}

async function resetSignalRules() {
    try {
        await fsSaveSettings('signalRules', SIGNAL_DEFAULTS);
    } catch(e) { console.warn('Firestore ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message); }
    await loadSignalRules();
    toast('â†©ï¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ë“±ê¸‰ ê·œì¹™ (ë³µí•© ì ìˆ˜ ë°©ì‹ â€” 6ê°œ í•­ëª© ì´ 105ì )
// ============================================================================
const GRADE_DEFAULTS = {
    // ë“±ê¸‰ ê¸°ì¤€ ì ìˆ˜
    gradeThresholds: { vip: 90, a: 70, b: 50 },
    // 1. ì—°ê°„ ë§¤ì¶œì•¡ (40ì )
    revenue: {
        scores: [5, 10, 20, 30, 40],
        thresholds: [1000, 3000, 5000, 10000]
    },
    // 2. ê±°ë˜ ë¹ˆë„ (25ì )
    frequency: {
        scores: [5, 10, 15, 20, 25],
        thresholds: [1, 3, 5, 10]
    },
    // 3. ê±°ë˜ ê¸°ê°„ (15ì )
    duration: {
        scores: [3, 6, 9, 12, 15],
        thresholds: [1, 2, 3, 5]
    },
    // 4. ê²°ì œ ì‹ ë¢°ë„ (15ì ) â€” ì‹ í˜¸ë“± ê·œì¹™ ì—°ë™
    payment: { scores: [3, 6, 9, 12, 15] },
    // 5. ë‹´ë‹¹ë¶€ì„œ (5ì )
    department: {
        scores: [1, 3, 5],
        conditions: ['ì§€ì‚¬', 'ê³ ê°ê´€ë¦¬', 'ê³ ê°ì§€ì›íŒ€, ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€']
    },
    // 6. ì ‘ìˆ˜í˜•íƒœ (5ì ) â€” ì‹ ê·œ
    receiptType: {
        scores: [1, 3, 5],
        conditions: ['íƒë°°ì ‘ìˆ˜', 'ë°©ë¬¸ì ‘ìˆ˜', 'í™ˆí˜ì´ì§€ì ‘ìˆ˜']
    }
};

// ë“±ê¸‰ ê·œì¹™ í•„ë“œ ID ë§¤í•‘
const GRADE_FIELD_IDS = {
    gradeThresholds: ['grade-vip-min', 'grade-a-min', 'grade-b-min'],
    revenueScores:   ['rev-s1', 'rev-s2', 'rev-s3', 'rev-s4', 'rev-s5'],
    revenueThresholds: ['rev-t2', 'rev-t3', 'rev-t4', 'rev-t5'],
    freqScores:      ['freq-s1', 'freq-s2', 'freq-s3', 'freq-s4', 'freq-s5'],
    freqThresholds:  ['freq-t2', 'freq-t3', 'freq-t4', 'freq-t5'],
    durScores:       ['dur-s1', 'dur-s2', 'dur-s3', 'dur-s4', 'dur-s5'],
    durThresholds:   ['dur-t2', 'dur-t3', 'dur-t4', 'dur-t5'],
    payScores:       ['pay-s1', 'pay-s2', 'pay-s3', 'pay-s4', 'pay-s5'],
    deptScores:      ['dept-s1', 'dept-s2', 'dept-s3'],
    deptConditions:  ['dept-c1', 'dept-c2', 'dept-c3'],
    rcptScores:      ['rcpt-s1', 'rcpt-s2', 'rcpt-s3'],
    rcptConditions:  ['rcpt-c1', 'rcpt-c2', 'rcpt-c3']
};

async function loadGradeRules() {
    var saved = GRADE_DEFAULTS;
    try {
        var fsData = await fsGetSettings('gradeRules');
        if (fsData && fsData.gradeThresholds) saved = fsData;
    } catch(e) { console.warn('Firestore ë“±ê¸‰ ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', e.message); }
    // ë“±ê¸‰ ê¸°ì¤€ ì ìˆ˜
    const th = saved.gradeThresholds || GRADE_DEFAULTS.gradeThresholds;
    document.getElementById('grade-vip-min').value = th.vip;
    document.getElementById('grade-a-min').value = th.a;
    document.getElementById('grade-b-min').value = th.b;
    // ì—°ê°„ ë§¤ì¶œì•¡
    const rev = saved.revenue || GRADE_DEFAULTS.revenue;
    rev.scores.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.revenueScores[i]).value = v);
    rev.thresholds.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.revenueThresholds[i]).value = v);
    // ê±°ë˜ ë¹ˆë„
    const freq = saved.frequency || GRADE_DEFAULTS.frequency;
    freq.scores.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.freqScores[i]).value = v);
    freq.thresholds.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.freqThresholds[i]).value = v);
    // ê±°ë˜ ê¸°ê°„
    const dur = saved.duration || GRADE_DEFAULTS.duration;
    dur.scores.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.durScores[i]).value = v);
    dur.thresholds.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.durThresholds[i]).value = v);
    // ê²°ì œ ì‹ ë¢°ë„
    const pay = saved.payment || GRADE_DEFAULTS.payment;
    pay.scores.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.payScores[i]).value = v);
    // ë‹´ë‹¹ë¶€ì„œ (ê¸°ì¡´ contract â†’ department ë§ˆì´ê·¸ë ˆì´ì…˜)
    const dept = saved.department || GRADE_DEFAULTS.department;
    dept.scores.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.deptScores[i]).value = v);
    const deptCond = dept.conditions || GRADE_DEFAULTS.department.conditions;
    deptCond.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.deptConditions[i]).value = v);
    // ì ‘ìˆ˜í˜•íƒœ (ì‹ ê·œ)
    const rcpt = saved.receiptType || GRADE_DEFAULTS.receiptType;
    rcpt.scores.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.rcptScores[i]).value = v);
    const rcptCond = rcpt.conditions || GRADE_DEFAULTS.receiptType.conditions;
    rcptCond.forEach((v, i) => document.getElementById(GRADE_FIELD_IDS.rcptConditions[i]).value = v);
    // ì—°ë™ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateGradeDisplays();
}

async function saveGradeRules() {
    const rules = {
        gradeThresholds: {
            vip: +document.getElementById('grade-vip-min').value,
            a:   +document.getElementById('grade-a-min').value,
            b:   +document.getElementById('grade-b-min').value
        },
        revenue: {
            scores: GRADE_FIELD_IDS.revenueScores.map(id => +document.getElementById(id).value),
            thresholds: GRADE_FIELD_IDS.revenueThresholds.map(id => +document.getElementById(id).value)
        },
        frequency: {
            scores: GRADE_FIELD_IDS.freqScores.map(id => +document.getElementById(id).value),
            thresholds: GRADE_FIELD_IDS.freqThresholds.map(id => +document.getElementById(id).value)
        },
        duration: {
            scores: GRADE_FIELD_IDS.durScores.map(id => +document.getElementById(id).value),
            thresholds: GRADE_FIELD_IDS.durThresholds.map(id => +document.getElementById(id).value)
        },
        payment: {
            scores: GRADE_FIELD_IDS.payScores.map(id => +document.getElementById(id).value)
        },
        department: {
            scores: GRADE_FIELD_IDS.deptScores.map(id => +document.getElementById(id).value),
            conditions: GRADE_FIELD_IDS.deptConditions.map(id => document.getElementById(id).value)
        },
        receiptType: {
            scores: GRADE_FIELD_IDS.rcptScores.map(id => +document.getElementById(id).value),
            conditions: GRADE_FIELD_IDS.rcptConditions.map(id => document.getElementById(id).value)
        }
    };
    try {
        await fsSaveSettings('gradeRules', rules);
        toast('âœ… ë“±ê¸‰ ê·œì¹™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e) {
        console.error('ë“±ê¸‰ ê·œì¹™ ì €ì¥ ì‹¤íŒ¨:', e);
        toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    }
}

async function resetGradeRules() {
    try {
        await fsSaveSettings('gradeRules', GRADE_DEFAULTS);
    } catch(e) { console.warn('Firestore ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message); }
    await loadGradeRules();
    toast('â†©ï¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ë§¤ì¶œì•¡ ì¹´ë“œì˜ ì—°ë™ í‘œì‹œ (ì˜ˆ: "~ 10,000 ë§Œì›") ì—…ë°ì´íŠ¸
function updateGradeDisplays() {
    const fmt = n => Number(n).toLocaleString();
    ['rev-t2', 'rev-t3', 'rev-t4', 'rev-t5'].forEach(id => {
        const span = document.getElementById(id + '-display');
        if (span) span.textContent = fmt(document.getElementById(id).value);
    });
    // ê²°ì œ ì‹ ë¢°ë„ â€” ì‹ í˜¸ë“± ê·œì¹™ ê°’ ì—°ë™ í‘œì‹œ
    updatePaymentSignalDisplay();
}

// ê²°ì œ ì‹ ë¢°ë„ ì¡°ê±´ì— ì‹ í˜¸ë“± ê·œì¹™ ì¼ìˆ˜ë¥¼ í‘œì‹œ
function updatePaymentSignalDisplay() {
    const g = id => document.getElementById(id);
    const v = id => g(id) ? g(id).value : '';
    const el = id => document.getElementById('pay-desc-' + id);
    if (el('green'))  el('green').textContent = v('signal-green-max');
    if (el('blue'))   el('blue').textContent = v('signal-blue-min') + '~' + v('signal-blue-max') + 'ì¼';
    if (el('yellow')) el('yellow').textContent = v('signal-yellow-min') + '~' + v('signal-yellow-max') + 'ì¼';
    if (el('orange')) el('orange').textContent = v('signal-orange-min') + '~' + v('signal-orange-max') + 'ì¼';
    if (el('red'))    el('red').textContent = v('signal-red-min');
}

// ë§¤ì¶œì•¡ ì„ê³„ê°’ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ì—°ë™
document.addEventListener('DOMContentLoaded', () => {
    ['rev-t2', 'rev-t3', 'rev-t4', 'rev-t5'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateGradeDisplays);
    });
});

// ============================================================================
// íœ´ì¼ ê´€ë¦¬
// ============================================================================
// íœ´ì¼ ë°ì´í„° ìºì‹œ (Firestore ë¹„ë™ê¸° â†’ ë™ê¸° í˜¸í™˜)
var _holidayCache = [];

async function getHolidayData() {
    try {
        var fsData = await fsGetSettings('holidays');
        if (fsData && Array.isArray(fsData.list)) {
            _holidayCache = fsData.list;
            return fsData.list;
        }
    } catch(e) { console.warn('Firestore íœ´ì¼ ë¡œë“œ ì‹¤íŒ¨:', e.message); }
    return _holidayCache;
}

async function saveHolidayData(data) {
    _holidayCache = data;
    try {
        await fsSaveSettings('holidays', {
            list: data,
            dates: data.map(function(h) { return h.date; })
        });
    } catch(e) {
        console.error('íœ´ì¼ ì €ì¥ ì‹¤íŒ¨:', e);
        toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    }
}

async function renderHolidays() {
    const data = (await getHolidayData()).sort((a,b) => a.date.localeCompare(b.date));
    const el = document.getElementById('holiday-list');
    if (!data.length) {
        el.innerHTML = '<p style="color:#9ca3af;font-size:13px">ë“±ë¡ëœ íœ´ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê³µíœ´ì¼ì„ ì¼ê´„ ë“±ë¡í•˜ê±°ë‚˜ ê°œë³„ ì¶”ê°€í•˜ì„¸ìš”.</p>';
        return;
    }
    el.innerHTML = data.map((h,i) => `
        <div class="holiday-item">
            <div><div class="date">${h.date}</div><div class="name">${h.name}</div></div>
            <button class="del" onclick="deleteHoliday(${i})" title="ì‚­ì œ">âœ•</button>
        </div>
    `).join('');
}

async function addHoliday() {
    const date = document.getElementById('holiday-date').value;
    const name = document.getElementById('holiday-name').value.trim();
    if (!date) { toast('âš ï¸ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
    if (!name) { toast('âš ï¸ ëª…ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    const data = await getHolidayData();
    if (data.some(h => h.date === date)) { toast('âš ï¸ ì´ë¯¸ ë“±ë¡ëœ ë‚ ì§œì…ë‹ˆë‹¤'); return; }
    data.push({ date, name });
    await saveHolidayData(data);
    await renderHolidays();
    document.getElementById('holiday-date').value = '';
    document.getElementById('holiday-name').value = '';
    toast('âœ… íœ´ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

async function deleteHoliday(idx) {
    const data = await getHolidayData();
    data.splice(idx, 1);
    await saveHolidayData(data);
    await renderHolidays();
    toast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

async function addDefaultHolidays() {
    const defaults = [
        {date:'2026-01-01', name:'ì‹ ì •'},
        {date:'2026-01-26', name:'ì„¤ë‚  ì „ë‚ '}, {date:'2026-01-27', name:'ì„¤ë‚ '}, {date:'2026-01-28', name:'ì„¤ë‚  ë‹¤ìŒë‚ '},
        {date:'2026-03-01', name:'ì‚¼ì¼ì ˆ'},
        {date:'2026-05-05', name:'ì–´ë¦°ì´ë‚ '},
        {date:'2026-05-24', name:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ '},
        {date:'2026-06-06', name:'í˜„ì¶©ì¼'},
        {date:'2026-08-15', name:'ê´‘ë³µì ˆ'},
        {date:'2026-09-24', name:'ì¶”ì„ ì „ë‚ '}, {date:'2026-09-25', name:'ì¶”ì„'}, {date:'2026-09-26', name:'ì¶”ì„ ë‹¤ìŒë‚ '},
        {date:'2026-10-03', name:'ê°œì²œì ˆ'},
        {date:'2026-10-09', name:'í•œê¸€ë‚ '},
        {date:'2026-12-25', name:'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'}
    ];
    const data = await getHolidayData();
    let added = 0;
    defaults.forEach(d => {
        if (!data.some(h => h.date === d.date)) { data.push(d); added++; }
    });
    await saveHolidayData(data);
    await renderHolidays();
    toast(`âœ… 2026ë…„ ê³µíœ´ì¼ ${added}ê±´ ì¶”ê°€ (ì¤‘ë³µ ì œì™¸)`);
}

// ============================================================================
// ë‚ ì”¨ ì„¤ì •
// ============================================================================
const WEATHER_REGIONS = {
    '60,127':'ì„œìš¸','55,124':'ì¸ì²œ','60,121':'ìˆ˜ì›','69,106':'ì²­ì£¼',
    '67,100':'ëŒ€ì „','66,103':'ì„¸ì¢…','89,90':'ëŒ€êµ¬','98,76':'ë¶€ì‚°',
    '102,84':'ìš¸ì‚°','58,74':'ê´‘ì£¼','63,89':'ì „ì£¼','73,134':'ì¶˜ì²œ',
    '92,131':'ê°•ë¦‰','52,38':'ì œì£¼','89,77':'ì°½ì›','102,94':'í¬í•­'
};

async function loadWeatherSettings() {
    try {
        var saved = await fsGetSettings('weatherSettings');
        if (saved) {
            if (saved.apiKey) document.getElementById('weather-api-key').value = saved.apiKey;
            if (saved.nx && saved.ny) {
                document.getElementById('weather-region').value = saved.nx + ',' + saved.ny;
            }
        }
    } catch(e) { console.warn('ë‚ ì”¨ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e.message); }
}

async function saveWeatherSettings() {
    var apiKey = document.getElementById('weather-api-key').value.trim();
    var regionVal = document.getElementById('weather-region').value;
    if (!apiKey) { toast('âš ï¸ API ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    if (!regionVal) { toast('âš ï¸ ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
    var parts = regionVal.split(',');
    var city = WEATHER_REGIONS[regionVal] || '';
    var data = {
        apiKey: apiKey,
        city: city,
        nx: parseInt(parts[0]),
        ny: parseInt(parts[1])
    };
    try {
        await fsSaveSettings('weatherSettings', data);
        // localStorage ìºì‹œ í´ë¦¬ì–´ (ìƒˆ ì„¤ì • ì¦‰ì‹œ ë°˜ì˜)
        try { localStorage.removeItem('bfl_weather_cache'); } catch(e){}
        toast('âœ… ë‚ ì”¨ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e) {
        console.error('ë‚ ì”¨ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', e);
        toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    }
}

function getWeatherBaseTime() {
    var now = new Date();
    var hour = now.getHours();
    var min = now.getMinutes();
    // ì´ˆë‹¨ê¸°ì‹¤í™©: ë§¤ì‹œ ì •ê° ë°œí‘œ, API ì œê³µì€ ì•½ 40ë¶„ í›„
    if (min < 40) hour = hour - 1;
    if (hour < 0) hour = 23;
    return String(hour).padStart(2, '0') + '00';
}

function getWeatherBaseDate(baseTime) {
    var now = new Date();
    // base_timeì´ 2300ì¸ë° í˜„ì¬ê°€ 00ì‹œëŒ€ë©´ ì–´ì œ ë‚ ì§œ
    if (baseTime === '2300' && now.getHours() < 1) {
        now.setDate(now.getDate() - 1);
    }
    var y = now.getFullYear();
    var m = String(now.getMonth() + 1).padStart(2, '0');
    var d = String(now.getDate()).padStart(2, '0');
    return y + m + d;
}

function getWeatherIcon(pty) {
    var p = parseInt(pty) || 0;
    if (p === 1) return 'ğŸŒ§ï¸';
    if (p === 2) return 'ğŸŒ¨ï¸';
    if (p === 3) return 'â„ï¸';
    if (p === 5) return 'ğŸ’§';
    if (p === 6) return 'ğŸ’§';
    if (p === 7) return 'ğŸŒ¨ï¸';
    // PTY 0 = ë§‘ìŒ â€” ì‹œê°„ëŒ€ë³„ ì•„ì´ì½˜
    var h = new Date().getHours();
    return (h >= 6 && h < 18) ? 'â˜€ï¸' : 'ğŸŒ™';
}

async function testWeatherAPI() {
    var apiKey = document.getElementById('weather-api-key').value.trim();
    var regionVal = document.getElementById('weather-region').value;
    var resultDiv = document.getElementById('weather-test-result');
    var contentDiv = document.getElementById('weather-test-content');

    if (!apiKey) { toast('âš ï¸ API ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    if (!regionVal) { toast('âš ï¸ ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”'); return; }

    var parts = regionVal.split(',');
    var nx = parts[0], ny = parts[1];
    var city = WEATHER_REGIONS[regionVal] || '';
    var baseTime = getWeatherBaseTime();
    var baseDate = getWeatherBaseDate(baseTime);

    contentDiv.textContent = 'â³ API í˜¸ì¶œ ì¤‘...';
    resultDiv.style.display = 'block';
    resultDiv.querySelector('.card').style.background = '#f3f4f6';
    resultDiv.querySelector('.card').style.borderColor = '#d1d5db';

    try {
        var url = 'https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst'
            + '?serviceKey=' + apiKey
            + '&dataType=JSON&numOfRows=10&pageNo=1'
            + '&base_date=' + baseDate
            + '&base_time=' + baseTime
            + '&nx=' + nx + '&ny=' + ny;

        var resp = await fetch(url);
        var text = await resp.text();
        var json;
        try { json = JSON.parse(text); } catch(pe) {
            contentDiv.innerHTML = 'âŒ API ì‘ë‹µ ì˜¤ë¥˜: ' + (text.substring(0, 100) || 'Empty response') + '<br><span style="font-size:12px;color:#6b7280">ì¸ì¦í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”. Encoding í‚¤ë¥¼ ê·¸ëŒ€ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</span>';
            resultDiv.querySelector('.card').style.background = '#fef2f2';
            resultDiv.querySelector('.card').style.borderColor = '#fca5a5';
            return;
        }

        if (json.response && json.response.header && json.response.header.resultCode === '00') {
            var items = json.response.body.items.item;
            var data = {};
            items.forEach(function(item) { data[item.category] = item.obsrValue; });

            var icon = getWeatherIcon(data.PTY);
            var temp = data.T1H || '-';
            var hum = data.REH || '-';
            var wind = data.WSD || '-';
            var pty = parseInt(data.PTY) || 0;
            var ptyText = ['ë§‘ìŒ','ë¹„','ë¹„/ëˆˆ','ëˆˆ','','ë¹—ë°©ìš¸','ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼','ëˆˆë‚ ë¦¼'][pty] || 'ë§‘ìŒ';

            contentDiv.innerHTML = '<div style="font-size:18px;font-weight:700;margin-bottom:8px">' + icon + ' ' + city + ' í˜„ì¬ ë‚ ì”¨</div>'
                + '<div style="display:flex;gap:24px;flex-wrap:wrap">'
                + '<span>ğŸŒ¡ï¸ ê¸°ì˜¨: <b>' + temp + 'Â°C</b></span>'
                + '<span>ğŸ’§ ìŠµë„: <b>' + hum + '%</b></span>'
                + '<span>ğŸŒ¬ï¸ í’ì†: <b>' + wind + 'm/s</b></span>'
                + '<span>â˜ï¸ ìƒíƒœ: <b>' + ptyText + '</b></span>'
                + '</div>'
                + '<div style="font-size:11px;color:#6b7280;margin-top:8px">ê¸°ì¤€ì‹œê°: ' + baseDate + ' ' + baseTime + '</div>';

            resultDiv.querySelector('.card').style.background = '#f0fdf4';
            resultDiv.querySelector('.card').style.borderColor = '#86efac';
        } else {
            var errMsg = (json.response && json.response.header) ? json.response.header.resultMsg : 'Unknown error';
            contentDiv.innerHTML = 'âŒ API ì˜¤ë¥˜: ' + errMsg;
            resultDiv.querySelector('.card').style.background = '#fef2f2';
            resultDiv.querySelector('.card').style.borderColor = '#fca5a5';
        }
    } catch(e) {
        contentDiv.innerHTML = 'âŒ ìš”ì²­ ì‹¤íŒ¨: ' + e.message;
        resultDiv.querySelector('.card').style.background = '#fef2f2';
        resultDiv.querySelector('.card').style.borderColor = '#fca5a5';
    }
}

// ============================================================================
// ì´ˆê¸°í™” â€” Firebase ì¤€ë¹„ í›„ ë°ì´í„° ë¡œë“œ
// ============================================================================
window.addEventListener('firebase-ready', async function() {
    console.log('[adminSettings] Firebase ì¤€ë¹„ ì™„ë£Œ, ë°ì´í„° ë¡œë“œ ì‹œì‘');
    await loadSignalRules();
    await loadGradeRules();
    await renderHolidays();
    await loadWeatherSettings();
});
// Firebase ì´ë¯¸ ì¤€ë¹„ëœ ê²½ìš° (ìºì‹œ ë“±)
window.onload = async function() {
    if (typeof isFirebaseReady === 'function' && isFirebaseReady()) {
        await loadSignalRules();
        await loadGradeRules();
        await renderHolidays();
        await loadWeatherSettings();
    }
};
</script>
</body>
</html>
