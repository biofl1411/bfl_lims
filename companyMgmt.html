<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ì—…ì²´ë“±ë¡Â·ìˆ˜ì •</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,sans-serif;height:100vh;background:#f8f9fb;font-size:13px;overflow:hidden;display:flex}

/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;margin-left:250px;height:100vh}
.topbar{background:#fff;border-bottom:1px solid #e2e6ed;padding:0 24px;height:52px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700;color:#1a2332}
.topbar-sep{color:#c8d6e5}
.topbar-sub{font-size:13px;color:#5f6b7a}
.content{flex:1;padding:24px;overflow-y:auto}

/* Buttons */
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#1a73e8;color:#fff}.btn-primary:hover{background:#1557b0}
.btn-secondary{background:#fff;color:#5f6b7a;border:1px solid #e2e6ed}.btn-secondary:hover{background:#f0f2f5}
.btn-success{background:#2e7d32;color:#fff}.btn-success:hover{background:#1b5e20}
.btn-danger{background:#e53935;color:#fff}.btn-danger:hover{background:#c62828}
.btn-sm{padding:6px 12px;font-size:11px}
.btn-check{background:#e3f2fd;color:#1565c0;border:1px solid #bbdefb}.btn-check:hover{background:#bbdefb}
.btn-warning{background:#ff9800;color:#fff}.btn-warning:hover{background:#f57c00}

/* Card */
.card{background:#fff;border-radius:12px;border:1px solid #e2e6ed;margin-bottom:16px}
.card-hd{padding:16px 20px;border-bottom:1px solid #eef0f4;display:flex;align-items:center;gap:10px}
.card-hd h3{font-size:15px;font-weight:700;color:#1a2332}
.card-hd .right{margin-left:auto;display:flex;gap:8px}
.card-bd{padding:20px}

/* Tables */
.tbl{width:100%;border-collapse:collapse}
.tbl th{background:#f8f9fb;padding:10px 14px;font-size:11px;font-weight:700;color:#5f6b7a;text-align:left;border-bottom:2px solid #e2e6ed;white-space:nowrap}
.tbl td{padding:10px 14px;border-bottom:1px solid #eef0f4;font-size:12px;color:#333}
.tbl tr:hover{background:#fafbfc;cursor:pointer}
.tbl .center{text-align:center}

/* Tags */
.tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.tag-active{background:#e8f5e9;color:#2e7d32}.tag-dormant{background:#fff3e0;color:#e65100}.tag-terminated{background:#f5f5f5;color:#9e9e9e}
.tag-vip{background:#fce4ec;color:#c62828}.tag-a{background:#e3f2fd;color:#1565c0}.tag-b{background:#e8f5e9;color:#2e7d32}.tag-c{background:#f3e5f5;color:#7b1fa2}
.tl{display:inline-block;width:12px;height:12px;border-radius:50%;vertical-align:middle}
.tl-blue{background:#2196f3}.tl-green{background:#4caf50}.tl-yellow{background:#ffeb3b}.tl-orange{background:#ff9800}.tl-red{background:#f44336}

/* Form */
.fg{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.fg label{font-size:11px;color:#5f6b7a;font-weight:600}
.fg label .req{color:#e53935}
.fg input,.fg select,.fg textarea{padding:9px 12px;border:1px solid #e2e6ed;border-radius:8px;font-size:13px;outline:none;font-family:inherit;transition:border .15s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:#4fc3f7;box-shadow:0 0 0 3px rgba(79,195,247,.1)}
.fg textarea{resize:vertical;min-height:60px}
.fg select{cursor:pointer;background:#fff}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

/* Sub-card */
.sub-card{background:#f8f9fb;border:1px solid #eef0f4;border-radius:10px;padding:14px;margin-bottom:10px;position:relative}
.sub-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.sub-card-title{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px}
.sub-card-num{background:#e3f2fd;color:#1565c0;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.btn-add{display:flex;align-items:center;gap:6px;padding:10px;border:2px dashed #c8d6e5;border-radius:10px;background:transparent;color:#5f6b7a;font-size:12px;font-weight:600;cursor:pointer;width:100%;justify-content:center}
.btn-add:hover{border-color:#1a73e8;color:#1a73e8;background:#f0f7ff}
.combo{display:flex;gap:6px}.combo select,.combo input{flex:1}
.check-result{margin-top:4px;font-size:11px;padding:6px 10px;border-radius:6px;display:none}
.check-ok{background:#e8f5e9;color:#2e7d32}

/* Section title */
.sec-title{font-size:14px;font-weight:700;color:#1a2332;margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid #eef0f4;display:flex;align-items:center;gap:8px}
.sec-num{background:#1a73e8;color:#fff;width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}

/* File area */
.file-area{border:2px dashed #e2e6ed;border-radius:10px;padding:16px;text-align:center;color:#8892a4;font-size:12px;cursor:pointer}
.file-area:hover{border-color:#1a73e8;color:#1a73e8;background:#f0f7ff}
.addr-row{display:flex;gap:8px}.addr-row input{flex:1}
.radio-group{display:flex;gap:12px;padding:6px 0}

/* Toast */
.toast{display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#1a2332;color:#fff;padding:14px 28px;border-radius:10px;font-size:14px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:200}
.toast.show{display:block;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* Search bar */
.search-bar{display:flex;gap:8px;align-items:center}
.search-bar input{flex:1;max-width:300px}
.search-bar select{max-width:130px}

/* Stats row (legacy - unused) */

/* Page */
.page{display:none}

/* Stats (salesMgmt style) */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.stat{background:#fff;border:1px solid #e2e6ed;border-radius:10px;padding:14px;text-align:center}
.stat-val{font-size:22px;font-weight:800;color:#1a2332}
.stat-label{font-size:10px;color:#8892a4;margin-top:2px}

/* Column Settings Panel */
#colSettingsPanel .col-settings-header{font-size:12px;font-weight:700;color:#5f6b7a;padding-bottom:8px;border-bottom:1px solid #eef0f4;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
#colSettingsPanel .col-settings-reset{font-size:11px;color:#1a73e8;cursor:pointer;font-weight:500}
#colSettingsPanel .col-settings-reset:hover{text-decoration:underline}
#colSettingsPanel .col-setting-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:6px;font-size:12px;color:#333;cursor:pointer;transition:background .1s}
#colSettingsPanel .col-setting-item:hover{background:#f0f2f5}
#colSettingsPanel .col-setting-item input[type="checkbox"]{width:15px;height:15px;accent-color:#1a73e8;cursor:pointer;flex-shrink:0}
#colSettingsPanel .col-setting-divider{height:1px;background:#eef0f4;margin:6px 0}
/* Column Drag */
.tbl th[draggable="true"]{cursor:grab;user-select:none;position:relative;transition:background .15s}
.tbl th[draggable="true"]:active{cursor:grabbing}
.tbl th.col-drag-over{background:#e3f2fd !important;box-shadow:inset 2px 0 0 #1a73e8}
.tbl th.col-dragging{opacity:.4;background:#bbdefb}
/* Custom tooltip */
[data-tooltip]{position:relative;cursor:help}
[data-tooltip]:hover::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 14px;border-radius:8px;font-size:11px;white-space:pre-line;min-width:240px;max-width:320px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.2);line-height:1.7;pointer-events:none;font-weight:400;letter-spacing:0}
[data-tooltip]:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b;z-index:9999;pointer-events:none}
/* ì„ íƒ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ */
#bulkDeleteModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:9999;display:none;align-items:center;justify-content:center}
#bulkDeleteModal.show{display:flex}
.bulk-delete-dialog{background:#fff;border-radius:14px;padding:28px;max-width:480px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.25);animation:fadeIn .2s ease}
.bulk-delete-header{font-weight:700;font-size:17px;margin-bottom:6px;color:#c62828;display:flex;align-items:center;gap:8px}
.bulk-delete-desc{font-size:13px;color:#5f6b7a;margin-bottom:14px}
.bulk-delete-list{max-height:200px;overflow-y:auto;border:1px solid #eef0f4;border-radius:8px;padding:4px 0;margin-bottom:14px;font-size:12px}
.bulk-delete-list .del-item{padding:7px 12px;border-bottom:1px solid #f5f5f5;display:flex;align-items:center;gap:8px}
.bulk-delete-list .del-item:last-child{border-bottom:none}
.bulk-delete-list .del-idx{color:#8892a4;font-size:10px;min-width:20px}
.bulk-delete-list .del-name{font-weight:600;color:#1a2332}
.bulk-delete-list .del-biz{color:#8892a4;font-size:11px;margin-left:auto}
.bulk-delete-warn{background:#fff3e0;color:#e65100;padding:10px 14px;border-radius:8px;font-size:12px;margin-bottom:18px;line-height:1.5}
.bulk-delete-actions{display:flex;gap:8px;justify-content:flex-end}
.del-progress-area{margin-bottom:14px}
.del-progress-bar{height:6px;background:#eef0f4;border-radius:3px;overflow:hidden;margin-bottom:6px}
.del-progress-fill{height:100%;background:#e53935;border-radius:3px;transition:width 0.3s;width:0%}
.del-progress-text{font-size:11px;color:#5f6b7a;text-align:center}
/* ì²¨ë¶€íŒŒì¼/OCR ë³´ê¸° ì„¹ì…˜ */
.file-view-section{background:#f8fafe;border:1px solid #e2e8f0;border-radius:10px;padding:14px 16px;margin-bottom:16px}
.file-view-title{font-size:13px;font-weight:700;color:#1a2332;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.file-view-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.file-view-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid #d0d7e2;background:#fff;color:#1a2332;transition:all .15s}
.file-view-btn:hover{background:#e3f2fd;border-color:#90caf9;color:#1565c0}
.file-view-btn .fv-icon{font-size:14px}
.file-view-empty{font-size:12px;color:#8892a4;padding:4px 0}
/* OCR ê²°ê³¼ ë³´ê¸° ëª¨ë‹¬ */
#ocrResultModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:9999;display:none;align-items:center;justify-content:center}
#ocrResultModal.show{display:flex}
.ocr-modal-dialog{background:#fff;border-radius:14px;padding:24px;max-width:600px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.25);max-height:80vh;display:flex;flex-direction:column}
.ocr-modal-header{font-weight:700;font-size:16px;margin-bottom:4px;display:flex;align-items:center;gap:8px;color:#1565c0}
.ocr-modal-sub{font-size:12px;color:#8892a4;margin-bottom:14px}
.ocr-modal-body{overflow-y:auto;flex:1}
.ocr-card{border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:10px}
.ocr-card-title{font-size:13px;font-weight:600;color:#1a2332;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ocr-card-meta{font-size:11px;color:#8892a4;margin-bottom:8px}
.ocr-field-row{display:flex;gap:8px;margin-bottom:4px;font-size:12px}
.ocr-field-label{min-width:80px;color:#5f6b7a;font-weight:500;flex-shrink:0}
.ocr-field-value{color:#1a2332;word-break:break-all}
.ocr-modal-footer{display:flex;justify-content:flex-end;margin-top:14px;padding-top:10px;border-top:1px solid #eef0f4}
</style>
<!-- Daum Postcode API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- PDF.js (OCR PDFâ†’ì´ë¯¸ì§€ ë³€í™˜) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
</head>
<body>

<!-- ===== SIDEBAR (js/sidebar.js) ===== -->
<nav class="sidebar" id="sidebar"></nav>

<!-- ===== MAIN ===== -->
<div class="main">
  <div class="topbar">
    <span class="topbar-title">ì ‘ìˆ˜ ê´€ë¦¬</span>
    <span class="topbar-sep">â€º</span>
    <span class="topbar-sub" id="topSub">ì—…ì²´ë“±ë¡Â·ìˆ˜ì •</span>
  </div>
  <div class="content" id="contentArea">

    <!-- ========== ëª©ë¡ í˜ì´ì§€ ========== -->
    <div class="page" id="page-list" style="display:block">
      <!-- í†µê³„ (salesMgmt ìŠ¤íƒ€ì¼) -->
      <div class="stats">
        <div class="stat"><div class="stat-val" id="statTotal">0</div><div class="stat-label">ì „ì²´ ê±°ë˜ì²˜</div></div>
        <div class="stat"><div class="stat-val" id="statActive" style="color:#2e7d32">0</div><div class="stat-label">í™œë™ ì¤‘</div></div>
        <div class="stat"><div class="stat-val" id="statReceivable" style="color:#e65100">0</div><div class="stat-label">ë¯¸ìˆ˜ê¸ˆ ì—…ì²´</div></div>
        <div class="stat"><div class="stat-val" id="statDanger" style="color:#e53935">0</div><div class="stat-label">ìœ„í—˜ (ì£¼í™©+ë¹¨ê°•)</div></div>
      </div>

      <div class="card">
        <div class="card-hd">
          <h3>ê³ ê°ì‚¬ ëª©ë¡</h3>
          <div class="right" style="position:relative;display:flex;align-items:center;gap:6px">
            <input type="text" id="custSearchInput" placeholder="ğŸ” íšŒì‚¬ëª…, ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰..." style="padding:7px 12px;border:1px solid #e2e6ed;border-radius:8px;font-size:12px;width:220px" oninput="filterCustomerTable(this.value)">
            <button class="btn btn-secondary btn-sm" id="colSettingsBtn" onclick="toggleColSettings()" title="ì»¬ëŸ¼ ì„¤ì •" style="font-size:13px;padding:6px 10px;border-radius:8px">âš™ï¸</button>
            <div id="colSettingsPanel" style="display:none;position:absolute;top:100%;right:40px;margin-top:4px;background:#fff;border:1px solid #e2e6ed;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:50;width:240px;max-height:400px;overflow-y:auto;padding:12px"></div>
            <button class="btn btn-danger btn-sm" id="btnBulkDelete" onclick="bulkDeleteCompanies()" style="display:none">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
            <button class="btn btn-primary" onclick="location.href='companyRegForm_v2.html'">+ ì‹ ê·œ ë“±ë¡</button>
          </div>
        </div>
        <div class="card-bd" style="padding:0;overflow-x:auto">
          <table class="tbl" id="customerTable">
            <thead id="customerThead"><tr><!-- ë™ì  ë Œë”ë§ --></tr></thead>
            <tbody id="customerTbody"><!-- ë™ì  ë Œë”ë§ --></tbody>
          </table>
          <div id="emptyMsg" style="text-align:center;padding:40px;color:#8892a4;display:none">
            <div style="font-size:36px;margin-bottom:8px">ğŸ“‹</div>
            <div>ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤. <a href="companyRegForm_v2.html" style="color:#1a73e8">ì‹ ê·œ ë“±ë¡</a>ì„ í•´ì£¼ì„¸ìš”.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== ë“±ë¡ í˜ì´ì§€ ========== -->
    <div class="page" id="page-reg">
      <div style="margin-bottom:16px"><button class="btn btn-secondary btn-sm" onclick="showPage('list')">â† ëª©ë¡ìœ¼ë¡œ</button></div>
      <div class="card"><div class="card-bd" style="max-width:860px">

        <!-- ì‚¬ì—…ìë“±ë¡ì¦ OCR -->
        <div style="background:linear-gradient(135deg,#e8f5e9 0%,#f1f8e9 100%);border:2px solid #c8e6c9;border-radius:12px;padding:20px;margin-bottom:20px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
            <span style="font-size:20px">ğŸ“„</span>
            <div>
              <div style="font-size:14px;font-weight:700;color:#2e7d32">ì‚¬ì—…ìë“±ë¡ì¦ OCR ìë™ì…ë ¥</div>
              <div style="font-size:11px;color:#558b2f">ì‚¬ì—…ìë“±ë¡ì¦ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ë³¸ì •ë³´ + ì£¼ì†Œê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</div>
            </div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="file-area" id="bizLicFileArea" style="flex:1;padding:14px;position:relative" onclick="document.getElementById('bizLicFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#43a047';this.style.background='#e8f5e9'" ondragleave="this.style.borderColor='#c8e6c9';this.style.background='transparent'" ondrop="event.preventDefault();this.style.borderColor='#c8e6c9';this.style.background='transparent';handleBizLicFile(event.dataTransfer.files[0])">
              <input type="file" id="bizLicFileInput" accept="image/*,.pdf" style="display:none" onchange="handleBizLicFile(this.files[0])">
              <span id="bizLicFileName">ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ (JPG, PNG, PDF)</span>
            </div>
            <button class="btn btn-success btn-sm" id="bizLicOcrBtn" onclick="runBizLicOCR()" disabled style="white-space:nowrap;padding:12px 16px">ğŸ¤– OCR ì¸ì‹</button>
          </div>
          <div id="bizLicOcrStatus" style="margin-top:8px;font-size:11px;color:#558b2f;display:none"></div>
          <div id="bizLicPreview" style="margin-top:10px;display:none"><img id="bizLicPreviewImg" style="max-width:100%;max-height:200px;border-radius:8px;border:1px solid #c8e6c9"></div>
        </div>

        <div class="sec-title"><span class="sec-num">1</span> ê¸°ë³¸ ì •ë³´</div>
        <div class="fg-row">
          <div class="fg"><label>ë²•ì¸ ì—¬ë¶€ <span class="req">*</span></label><div class="radio-group"><label class="radio-item"><input type="radio" name="corp" id="regCorpYes" value="ë²•ì¸" checked> ë²•ì¸</label><label class="radio-item"><input type="radio" name="corp" id="regCorpIndiv" value="ê°œì¸"> ê°œì¸</label></div></div>
          <div class="fg"><label>ê±°ë˜ì²˜ ë“±ê¸‰</label><select id="regGrade"><option>ë“±ê¸‰ ì„ íƒ</option><option>VIP</option><option>A</option><option>B</option><option>C</option></select></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>íšŒì‚¬ëª… <span class="req">*</span></label><div class="combo"><input id="regCompany" placeholder="ì˜ˆ: (ì£¼)ë°”ì´ì˜¤í‘¸ë“œë©"><button class="btn btn-check btn-sm" onclick="demoCompanyDup()">ì¤‘ë³µ í™•ì¸</button></div><div class="check-result" id="compChk"></div></div>
          <div class="fg"><label>ëŒ€í‘œìëª… <span class="req">*</span></label><input id="regRepName" placeholder="ëŒ€í‘œì ì´ë¦„"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì‚¬ì—…ìë²ˆí˜¸ <span class="req">*</span></label><div class="combo"><input id="regBizNo" placeholder="000-00-00000" maxlength="12" oninput="fmtBiz(this)"><button class="btn btn-check btn-sm" onclick="toast('âœ… ì¤‘ë³µ ì—†ìŒ')">ì¤‘ë³µ í™•ì¸</button></div></div>
          <div class="fg"><label>ë²•ì¸ë²ˆí˜¸ <span class="req">*</span></label><input id="regCorpNo" placeholder="000000-0000000" maxlength="14"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì—…íƒœ <span class="req">*</span></label><input id="regBizType" placeholder="ì˜ˆ: ì œì¡°ì—…"></div>
          <div class="fg"><label>ì¢…ëª© <span class="req">*</span></label><input id="regBizItem" placeholder="ì˜ˆ: ì‹í’ˆ"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ê³„ì•½ ìƒíƒœ</label><select id="regStatus"><option selected>í™œë™</option><option>íœ´ë©´</option><option>í•´ì§€</option></select></div>
          <div class="fg"><label>ì‹ í˜¸ë“±</label><div style="display:flex;align-items:center;gap:6px;padding:8px 0"><span class="tl tl-blue"></span><span style="font-size:11px;color:#5f6b7a">íŒŒë‘ (ì‹ ê·œ ë“±ë¡ ì‹œ ê¸°ë³¸ê°’)</span></div></div>
        </div>

        <div class="sec-title"><span class="sec-num">2</span> ì£¼ì†Œ</div>
        <div class="fg"><label>ì£¼ì†Œ <span class="req">*</span></label><div class="addr-row"><input id="regZipcode" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px" readonly><button class="btn btn-secondary btn-sm" onclick="openPostcodeSearch()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div></div>
        <div class="fg"><input id="regAddr1" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìë™ì…ë ¥)" readonly></div>
        <div class="fg"><input id="regAddr2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"></div>

        <div class="eng-toggle" onclick="toggleEngSection('bizEngSection')" style="margin-top:12px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">
          <span id="bizEngArrow" style="transition:transform .2s;display:inline-block">â–¶</span> ì‚¬ì—…ìë“±ë¡ì¦ (ì˜ë¬¸ ì •ë³´)
        </div>
        <div id="bizEngSection" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed;margin-bottom:8px">
          <div class="fg"><label>Company Name (EN)</label><input id="regCompanyNameEn" placeholder="Company name in English"></div>
          <div class="fg"><label>Representative (EN)</label><input id="regRepNameEn" placeholder="Representative name in English"></div>
          <div class="fg"><label>Address (EN)</label><input id="regAddrEn" placeholder="Address in English (auto-converted)"></div>
        </div>

        <div class="sec-title"><span class="sec-num">3</span> ì¸í—ˆê°€ ì •ë³´ <span style="margin-left:auto;font-size:11px;color:#8892a4;font-weight:400">ì—¬ëŸ¬ ê°œ ë“±ë¡ ê°€ëŠ¥</span></div>
        <div id="licenseArea">
          <div class="sub-card" id="licCard_1">
            <div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">1</span> ì¸í—ˆê°€</div></div>
            <div class="fg-row">
              <div class="fg"><label>ë¶„ì•¼ <span class="req">*</span></label><select id="licField_1"><option>ì„ íƒ</option><option>ì‹í’ˆ</option><option>ì¶•ì‚°</option></select></div>
              <div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ <span class="req">*</span></label><div class="combo"><select id="licBizForm_1"><option>ì„ íƒ</option><option>ì‹í’ˆì œì¡°ê°€ê³µì—…</option><option>ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</option><option>ì‹í’ˆì†Œë¶„ì—…</option><option>ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì¶•ì‚°ë¬¼ê°€ê³µì—…</option><option>ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</option><option value="etc">âœï¸ ì§ì ‘ ì…ë ¥</option></select></div></div>
            </div>
            <div class="fg-row">
              <div class="fg"><label>ëŒ€í‘œì <span class="req">*</span></label><input id="licRepName_1" placeholder="ì¸í—ˆê°€ ëŒ€í‘œì"></div>
              <div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸ <span class="req">*</span></label><input id="licNo_1" placeholder="ì¸í—ˆê°€ë²ˆí˜¸"></div>
            </div>
            <div class="fg-row">
              <div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­ <span class="req">*</span></label><input id="licBizName_1" placeholder="ì˜ì—…ì†Œ ëª…ì¹­"></div>
            </div>
            <div class="fg"><label>ì†Œì¬ì§€ <span class="req">*</span></label>
              <div class="addr-row"><input id="licZipcode_1" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px" readonly><button class="btn btn-secondary btn-sm" onclick="openLicPostcodeSearch(1)">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>
            </div>
            <div class="fg"><input id="licAddr_1" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìë™ì…ë ¥)" readonly></div>
            <div class="fg"><input id="licAddr2_1" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"></div>
            <div class="fg"><label>ì¸í—ˆê°€ ë¬¸ì„œ ì²¨ë¶€</label>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="file-area" id="licFileArea_1" style="flex:1;padding:10px;position:relative" onclick="document.getElementById('licFileInput_1').click()" ondragover="event.preventDefault();this.style.borderColor='#1a73e8'" ondragleave="this.style.borderColor='#e2e6ed'" ondrop="event.preventDefault();this.style.borderColor='#e2e6ed';handleLicFile(1,event.dataTransfer.files[0])">
                  <input type="file" id="licFileInput_1" accept="image/*,.pdf" style="display:none" onchange="handleLicFile(1,this.files[0])">
                  <span id="licFileName_1">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span>
                </div>
                <button class="btn btn-check btn-sm" id="licOcrBtn_1" onclick="runLicOCR(1)" disabled style="white-space:nowrap">ğŸ¤– OCR ì¸ì‹</button>
              </div>
              <div id="licOcrStatus_1" style="margin-top:4px;font-size:11px;color:#1565c0;display:none"></div>
            </div>
            <div class="eng-toggle" onclick="toggleEngSection('licEngSection_1')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">
              <span id="licEngArrow_1" style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)
            </div>
            <div id="licEngSection_1" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">
              <div class="fg"><label>Business Name (EN)</label><input id="licBizNameEn_1" placeholder="Business name in English"></div>
              <div class="fg"><label>Representative (EN)</label><input id="licRepNameEn_1" placeholder="Representative name in English"></div>
              <div class="fg"><label>Address (EN)</label><input id="licAddrEn_1" placeholder="Address in English (auto-converted)"></div>
            </div>
          </div>
        </div>
        <button class="btn-add" onclick="addLicenseCard()">+ ì¸í—ˆê°€ ì •ë³´ ì¶”ê°€</button>

        <div class="sec-title"><span class="sec-num">4</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì <span style="margin-left:auto;font-size:11px;color:#8892a4;font-weight:400">ì—¬ëŸ¬ ëª… ë“±ë¡ ê°€ëŠ¥</span></div>
        <div id="contactArea">
          <div class="sub-card">
            <div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">1</span> ë‹´ë‹¹ì</div></div>
            <div class="fg-row3">
              <div class="fg"><label>ì´ë¦„ <span class="req">*</span></label><input id="regCName" placeholder="ë‹´ë‹¹ì ì´ë¦„"></div>
              <div class="fg"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input id="regCPhone" placeholder="010-0000-0000" oninput="fmtPhone(this)"></div>
              <div class="fg"><label>ì´ë©”ì¼</label><input id="regCEmail" type="email" placeholder="email@example.com"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
              <button class="btn btn-check btn-sm" onclick="demoContactDup()">ğŸ” ì¤‘ë³µ í™•ì¸</button>
              <div class="check-result" id="cntChk"></div>
              <div style="margin-left:auto;display:flex;align-items:center;gap:6px;font-size:11px;color:#8892a4">
                ìì‚¬ ë‹´ë‹¹: <select id="regSalesRep" style="padding:5px 8px;border:1px solid #e2e6ed;border-radius:6px;font-size:11px"><option>ì„ íƒ</option><option>ë°•ì£¼ì„</option><option selected>ì´ì£¼ì„</option><option>ê¹€ì‚¬ì›</option></select>
              </div>
            </div>
          </div>
        </div>
        <button class="btn-add" onclick="toast('+ ë‹´ë‹¹ì ì¶”ê°€ë¨')">+ ë‹´ë‹¹ì ì¶”ê°€</button>

        <div class="sec-title"><span class="sec-num">5</span> ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì <button class="btn btn-check btn-sm" style="margin-left:auto" onclick="toast('ğŸ“‹ 1ë²ˆ ë‹´ë‹¹ì ì •ë³´ ë³µì‚¬ ì™„ë£Œ')">ğŸ“‹ 1ë²ˆ ë‹´ë‹¹ì ë³µì‚¬</button></div>
        <div class="fg-row3">
          <div class="fg"><label>ì´ë¦„ <span class="req">*</span></label><input placeholder="ë‹´ë‹¹ì ì´ë¦„"></div>
          <div class="fg"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input placeholder="010-0000-0000"></div>
          <div class="fg"><label>ì´ë©”ì¼ <span class="req">*</span></label><input type="email" placeholder="ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì‹  ì´ë©”ì¼"></div>
        </div>

        <div class="sec-title"><span class="sec-num">6</span> ë©”ëª¨ / ë¹„ê³ </div>
        <div class="fg"><textarea placeholder="íŠ¹ì´ì‚¬í•­, ê³„ì•½ ì¡°ê±´, ì°¸ê³ ì‚¬í•­ ë“±..."></textarea></div>

        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px">
          <button class="btn btn-secondary" onclick="showPage('customerList')">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="saveCustomer()">âœ… ê³ ê°ì‚¬ ë“±ë¡</button>
        </div>
      </div></div>
    </div>

    <!-- ========== ìƒì„¸/ìˆ˜ì • í˜ì´ì§€ ========== -->
    <div class="page" id="page-detail">
      <div style="margin-bottom:16px"><button class="btn btn-secondary btn-sm" onclick="showPage('list')">â† ëª©ë¡ìœ¼ë¡œ</button></div>
      <div class="card"><div class="card-bd" style="max-width:900px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <h3 id="detailCompanyTitle" style="margin:0;font-size:18px"></h3>
          <span id="detailGradeTag"></span>
          <span id="detailStatusTag" style="margin-left:4px"></span>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn btn-primary btn-sm" id="detailEditBtn" onclick="toggleDetailEdit()">âœï¸ ìˆ˜ì •</button>
            <button class="btn btn-primary btn-sm" id="detailSaveBtn" onclick="saveDetailEdit()" style="display:none;background:#2e7d32;border-color:#2e7d32">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-secondary btn-sm" id="detailCancelBtn" onclick="cancelDetailEdit()" style="display:none">ì·¨ì†Œ</button>
            <button class="btn btn-danger btn-sm" onclick="deleteCompany()">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </div>

        <!-- ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¬ì¸ì‹ -->
        <div style="background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);border:2px solid #90caf9;border-radius:12px;padding:16px;margin-bottom:16px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <span style="font-size:18px">ğŸ”„</span>
            <div>
              <div style="font-size:13px;font-weight:700;color:#1565c0">ì‚¬ì—…ìë“±ë¡ì¦ / ì¸í—ˆê°€ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ì—…ë°ì´íŠ¸</div>
              <div style="font-size:11px;color:#5c6bc0">ë¬¸ì„œë¥¼ ì¬ì—…ë¡œë“œí•˜ë©´ ë³€ê²½ëœ ì •ë³´ê°€ ìë™ ë°˜ì˜ë˜ê³  ì´ë ¥ì´ ê¸°ë¡ë©ë‹ˆë‹¤</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="file-area" id="detailBizFileArea" style="flex:1;min-width:200px;padding:10px;position:relative" onclick="document.getElementById('detailBizFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#1565c0'" ondragleave="this.style.borderColor='#90caf9'" ondrop="event.preventDefault();this.style.borderColor='#90caf9';handleDetailBizFile(event.dataTransfer.files[0])">
              <input type="file" id="detailBizFileInput" accept="image/*,.pdf" style="display:none" onchange="handleDetailBizFile(this.files[0])">
              <span id="detailBizFileName" style="font-size:11px">ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼</span>
            </div>
            <button class="btn btn-primary btn-sm" id="detailBizOcrBtn" onclick="runDetailBizOCR()" disabled>ğŸ¤– ì‚¬ì—…ìë“±ë¡ì¦ OCR</button>
            <div class="file-area" id="detailLicFileArea" style="flex:1;min-width:200px;padding:10px;position:relative" onclick="document.getElementById('detailLicFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#1565c0'" ondragleave="this.style.borderColor='#90caf9'" ondrop="event.preventDefault();this.style.borderColor='#90caf9';handleDetailLicFile(event.dataTransfer.files[0])">
              <input type="file" id="detailLicFileInput" accept="image/*,.pdf" style="display:none" onchange="handleDetailLicFile(this.files[0])">
              <span id="detailLicFileName" style="font-size:11px">ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼</span>
            </div>
            <button class="btn btn-check btn-sm" id="detailLicOcrBtn" onclick="runDetailLicOCR()" disabled>ğŸ¤– ì¸í—ˆê°€ OCR</button>
          </div>
          <div id="detailOcrStatus" style="margin-top:6px;font-size:11px;color:#1565c0;display:none"></div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ / OCR ê²°ê³¼ ë³´ê¸° -->
        <div class="file-view-section" id="fileViewSection" style="display:none">
          <div class="file-view-title">ğŸ“‚ ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼</div>
          <div class="file-view-row" id="fileViewRow">
            <!-- ë™ì ìœ¼ë¡œ ë²„íŠ¼ ìƒì„±ë¨ -->
          </div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="sec-title"><span class="sec-num">1</span> ê¸°ë³¸ ì •ë³´</div>
        <div class="fg-row">
          <div class="fg"><label>íšŒì‚¬ëª…</label><input id="detCompany" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ëŒ€í‘œìëª…</label><input id="detRepName" readonly style="background:#f8f9fb"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì‚¬ì—…ìë²ˆí˜¸</label><input id="detBizNo" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ë²•ì¸ë²ˆí˜¸</label><input id="detCorpNo" readonly style="background:#f8f9fb"></div>
        </div>
        <div class="fg-row">
          <div class="fg"><label>ì—…íƒœ</label><input id="detBizType" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ì¢…ëª©</label><input id="detBizItem" readonly style="background:#f8f9fb"></div>
        </div>
        <div class="sec-title"><span class="sec-num">2</span> ì£¼ì†Œ</div>
        <div class="fg"><label>ì†Œì¬ì§€</label>
          <div class="addr-row" style="margin-bottom:4px"><input id="detZipcode" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;background:#f8f9fb" readonly><button class="btn btn-secondary btn-sm detBizPostBtn" id="detBizPostBtn" onclick="openDetPostcodeSearch()" style="display:none">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>
        </div>
        <div class="fg"><input id="detAddr1" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly style="background:#f8f9fb"></div>
        <div class="fg"><input id="detAddr2" placeholder="ìƒì„¸ì£¼ì†Œ" readonly style="background:#f8f9fb"></div>
        <div class="eng-toggle" onclick="toggleEngSection('detBizEngSection')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">
          <span id="detBizEngArrow" style="transition:transform .2s;display:inline-block">â–¶</span> ì‚¬ì—…ìë“±ë¡ì¦ (ì˜ë¬¸ ì •ë³´)
        </div>
        <div id="detBizEngSection" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">
          <div class="fg"><label>Company Name (EN)</label><input id="detCompanyEn" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>Representative (EN)</label><input id="detRepNameEn" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>Address (EN)</label><input id="detAddrEn" readonly style="background:#f8f9fb"></div>
        </div>

        <!-- ì¸í—ˆê°€ ì •ë³´ (ë‹¤ì¤‘) -->
        <div class="sec-title"><span class="sec-num">3</span> ì¸í—ˆê°€ ì •ë³´</div>
        <div id="detLicenseContainer">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
        <button class="btn-add" id="detAddLicBtn" onclick="addDetailLicenseCard()" style="display:none">+ ì¸í—ˆê°€ ì •ë³´ ì¶”ê°€</button>

        <!-- ê³ ê°ì‚¬ ë‹´ë‹¹ì (ë‹¤ì¤‘) -->
        <div class="sec-title"><span class="sec-num">4</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì</div>
        <div id="detContactContainer">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
        <button class="btn-add" id="detAddContactBtn" onclick="addDetailContactCard()" style="display:none">+ ë‹´ë‹¹ì ì¶”ê°€</button>

        <!-- ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì -->
        <div class="sec-title"><span class="sec-num">5</span> ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì</div>
        <div class="fg-row3">
          <div class="fg"><label>ì´ë¦„</label><input id="detTaxName" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ì „í™”ë²ˆí˜¸</label><input id="detTaxPhone" readonly style="background:#f8f9fb"></div>
          <div class="fg"><label>ì´ë©”ì¼</label><input id="detTaxEmail" readonly style="background:#f8f9fb"></div>
        </div>

        <!-- ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­ ëª¨ë‹¬ -->
        <div id="licContactMatchModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center">
          <div style="background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.2)">
            <div style="font-weight:700;font-size:16px;margin-bottom:12px">ğŸ”— ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­</div>
            <div style="font-size:13px;color:#5f6368;margin-bottom:16px" id="licMatchDesc">ì´ ë‹´ë‹¹ìë¥¼ ì¸í—ˆê°€ ë‹´ë‹¹ìë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div id="licMatchList" style="max-height:200px;overflow-y:auto;margin-bottom:16px"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-secondary btn-sm" onclick="closeLicMatchModal()" style="padding:6px 16px">ê±´ë„ˆë›°ê¸°</button>
              <button class="btn btn-primary btn-sm" onclick="applyLicMatch()" style="padding:6px 16px">ì ìš©</button>
            </div>
          </div>
        </div>

        <!-- ë©”ëª¨/ë¹„ê³  -->
        <div class="sec-title"><span class="sec-num">6</span> ë©”ëª¨ / ë¹„ê³ </div>
        <div class="fg"><textarea id="detMemo" readonly style="background:#f8f9fb;min-height:60px" placeholder="íŠ¹ì´ì‚¬í•­, ê³„ì•½ ì¡°ê±´, ì°¸ê³ ì‚¬í•­ ë“±..."></textarea></div>

        <!-- ë³€ê²½ ì´ë ¥ -->
        <div class="sec-title" style="margin-top:20px"><span class="sec-num">ğŸ“‹</span> ë³€ê²½ ì´ë ¥</div>
        <div id="changeLogArea" style="max-height:300px;overflow-y:auto">
          <table class="tbl" style="font-size:12px">
            <thead><tr><th style="width:140px">ì¼ì‹œ</th><th style="width:80px">ë³€ê²½ì</th><th>ë³€ê²½ ë‚´ìš©</th></tr></thead>
            <tbody id="changeLogTbody">
              <tr><td colspan="3" style="text-align:center;color:#8892a4;padding:20px">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
            </tbody>
          </table>
        </div>
      </div></div>
    </div>

  </div>
</div>

<!-- ì„ íƒ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="bulkDeleteModal">
  <div class="bulk-delete-dialog">
    <div class="bulk-delete-header">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ í™•ì¸</div>
    <div class="bulk-delete-desc">ë‹¤ìŒ <strong id="delCount">0</strong>ê°œ ì—…ì²´ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê´€ë ¨ ì²¨ë¶€íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</div>
    <div class="bulk-delete-list" id="delList"></div>
    <div class="bulk-delete-warn">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    <div class="del-progress-area" id="delProgress" style="display:none">
      <div class="del-progress-bar"><div class="del-progress-fill" id="delProgressFill"></div></div>
      <div class="del-progress-text" id="delProgressText">ì‚­ì œ ì¤‘... 0/0</div>
    </div>
    <div class="bulk-delete-actions" id="delActions">
      <button class="btn btn-secondary btn-sm" onclick="closeBulkDeleteModal()">ì·¨ì†Œ</button>
      <button class="btn btn-danger btn-sm" id="delConfirmBtn" onclick="confirmBulkDelete()">ğŸ—‘ï¸ ì‚­ì œ ì‹¤í–‰</button>
    </div>
  </div>
</div>

<!-- ë‹¨ê±´ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="singleDeleteModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);z-index:9999;align-items:center;justify-content:center">
  <div class="bulk-delete-dialog">
    <div class="bulk-delete-header">ğŸ—‘ï¸ ì—…ì²´ ì‚­ì œ í™•ì¸</div>
    <div class="bulk-delete-desc"><strong id="singleDelName"></strong> ì—…ì²´ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</div>
    <div class="bulk-delete-warn">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë ¨ ì²¨ë¶€íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</div>
    <div class="del-progress-area" id="singleDelProgress" style="display:none">
      <div class="del-progress-bar"><div class="del-progress-fill" id="singleDelProgressFill"></div></div>
      <div class="del-progress-text" id="singleDelProgressText">ì‚­ì œ ì¤‘...</div>
    </div>
    <div class="bulk-delete-actions" id="singleDelActions">
      <button class="btn btn-secondary btn-sm" onclick="closeSingleDeleteModal()">ì·¨ì†Œ</button>
      <button class="btn btn-danger btn-sm" id="singleDelConfirmBtn" onclick="confirmSingleDelete()">ğŸ—‘ï¸ ì‚­ì œ ì‹¤í–‰</button>
    </div>
  </div>
</div>

<!-- OCR ê²°ê³¼ ë³´ê¸° ëª¨ë‹¬ -->
<div id="ocrResultModal">
  <div class="ocr-modal-dialog">
    <div class="ocr-modal-header">ğŸ” OCR ì¸ì‹ ê²°ê³¼</div>
    <div class="ocr-modal-sub" id="ocrModalSub">ì €ì¥ëœ OCR ì¸ì‹ ë°ì´í„°ì…ë‹ˆë‹¤.</div>
    <div class="ocr-modal-body" id="ocrModalBody">
      <!-- ë™ì ìœ¼ë¡œ OCR ê²°ê³¼ ì¹´ë“œ ìƒì„±ë¨ -->
    </div>
    <div class="ocr-modal-footer">
      <button class="btn btn-secondary btn-sm" onclick="closeOcrResultModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toastEl"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>

<script src="js/sidebar.js"></script>
<script>
// ============================================================
// ì „ì—­ ë³€ìˆ˜
// ============================================================
var _licenseCardCount = 1;
var _bizLicFile = null;
var _editMode = false;
var _currentId = null;
// ìƒì„¸ í˜ì´ì§€ ì „ìš© ë³€ìˆ˜
var _detailCustId = null;
var _detailBizFile = null;
var _detailLicFile = null;
var _detLicCardCount = 0;
var _detContactCardCount = 0;
var _detLicCardFiles = {};
var _detailEditMode = false;
var _detailSnapshot = null;
var _licMatchContactNum = null;
var _custSearchQuery = '';

// ============================================================
// ì»¬ëŸ¼ ì •ì˜ ë°°ì—´ â€” í…Œì´ë¸” ë Œë”ë§ì˜ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ (salesMgmt.htmlê³¼ ë™ì¼)
// ============================================================
var COLUMNS = [
  { key:'trafficLight', label:'ì‹ í˜¸ë“±', defaultVisible:true, render:function(c){
    return '<td class="center"><span class="tl tl-' + (c.trafficLight||'blue') + '"></span></td>';
  }},
  { key:'grade', label:'ë“±ê¸‰', defaultVisible:true, render:function(c){
    var g = c.grade || 'B';
    var t = {
      'VIP':'<span class="tag tag-vip">VIP</span>',
      'A':'<span class="tag tag-a">A</span>',
      'B':'<span class="tag tag-b">B</span>',
      'C':'<span class="tag tag-c">C</span>'
    };
    return '<td>' + (t[g] || t['B']) + '</td>';
  }},
  { key:'company', label:'íšŒì‚¬ëª…', defaultVisible:true, render:function(c){ return '<td><strong>'+(c.company||'')+'</strong></td>'; }},
  { key:'repName', label:'ëŒ€í‘œì', defaultVisible:true, render:function(c){ return '<td>'+(c.repName||'-')+'</td>'; }},
  { key:'bizNo', label:'ì‚¬ì—…ìë²ˆí˜¸', defaultVisible:true, render:function(c){ return '<td>'+(c.bizNo||'-')+'</td>'; }},
  { key:'contactName', label:'ë‹´ë‹¹ì', defaultVisible:true, render:function(c){ return '<td>'+(c.contactName||'-')+'</td>'; }},
  { key:'salesRep', label:'ì˜ì—…ë‹´ë‹¹', defaultVisible:true, render:function(c){ return '<td>'+(c.salesRep||'-')+'</td>'; }},
  { key:'status', label:'ê³„ì•½ìƒíƒœ', defaultVisible:true, render:function(c){ var t={'í™œë™':'<span class="tag tag-active">í™œë™</span>','íœ´ë©´':'<span class="tag tag-dormant">íœ´ë©´</span>','í•´ì§€':'<span class="tag" style="background:#fce4ec;color:#c62828">í•´ì§€</span>'}; return '<td>'+(t[c.status]||t['í™œë™'])+'</td>'; }},
  { key:'regDate', label:'ìµœê·¼ê±°ë˜', defaultVisible:true, render:function(c){ return '<td>'+(c.regDate||'-')+'</td>'; }},
  // --- ì¶”ê°€ ì»¬ëŸ¼ (ê¸°ë³¸ ìˆ¨ê¹€) ---
  { key:'bizType', label:'ì—…ì¢…', defaultVisible:false, render:function(c){ return '<td>'+(c.bizType||'-')+'</td>'; }},
  { key:'bizItem', label:'ì—…íƒœ', defaultVisible:false, render:function(c){ return '<td>'+(c.bizItem||'-')+'</td>'; }},
  { key:'corpNo', label:'ë²•ì¸ë²ˆí˜¸', defaultVisible:false, render:function(c){ return '<td>'+(c.corpNo||'-')+'</td>'; }},
  { key:'contactPhone', label:'ë‹´ë‹¹ìì „í™”', defaultVisible:false, render:function(c){ return '<td>'+(c.contactPhone||'-')+'</td>'; }},
  { key:'contactEmail', label:'ë‹´ë‹¹ìì´ë©”ì¼', defaultVisible:false, render:function(c){ return '<td style="font-size:11px">'+(c.contactEmail||'-')+'</td>'; }},
  { key:'address', label:'ì£¼ì†Œ', defaultVisible:false, render:function(c){ var a=((c.addr1||'')+' '+(c.addr2||'')).trim(); return '<td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+a+'">'+(a||'-')+'</td>'; }},
  { key:'companyEn', label:'ì˜ë¬¸íšŒì‚¬ëª…', defaultVisible:false, render:function(c){ return '<td style="font-size:11px">'+(c.companyEn||'-')+'</td>'; }},
  { key:'licField', label:'ì¸í—ˆê°€ë¶„ì•¼', defaultVisible:false, render:function(c){
    var lics = c.licenses && c.licenses.length > 0 ? c.licenses : (c.licField ? [{licField:c.licField}] : []);
    if (!lics.length) return '<td>-</td>';
    if (lics.length === 1) return '<td>'+(lics[0].licField||'-')+'</td>';
    var h = lics.map(function(l,i){ return '<div style="line-height:1.4"><span style="color:#999;font-size:10px">'+(i+1)+'.</span> '+(l.licField||'-')+'</div>'; }).join('');
    return '<td style="font-size:11px">'+h+'</td>';
  }},
  { key:'licNo', label:'ì¸í—ˆê°€ë²ˆí˜¸', defaultVisible:false, render:function(c){
    var lics = c.licenses && c.licenses.length > 0 ? c.licenses : (c.licNo ? [{licNo:c.licNo}] : []);
    if (!lics.length) return '<td>-</td>';
    if (lics.length === 1) return '<td style="font-size:11px">'+(lics[0].licNo||'-')+'</td>';
    var h = lics.map(function(l,i){ return '<div style="line-height:1.4"><span style="color:#999;font-size:10px">'+(i+1)+'.</span> '+(l.licNo||'-')+'</div>'; }).join('');
    return '<td style="font-size:11px">'+h+'</td>';
  }},
  { key:'licBizName', label:'ì¸í—ˆê°€ì‚¬ì—…ëª…', defaultVisible:false, render:function(c){
    var lics = c.licenses && c.licenses.length > 0 ? c.licenses : (c.licBizName ? [{bizName:c.licBizName}] : []);
    if (!lics.length) return '<td>-</td>';
    if (lics.length === 1) return '<td>'+(lics[0].bizName||lics[0].licBizName||'-')+'</td>';
    var h = lics.map(function(l,i){ return '<div style="line-height:1.4"><span style="color:#999;font-size:10px">'+(i+1)+'.</span> '+(l.bizName||l.licBizName||'-')+'</div>'; }).join('');
    return '<td style="font-size:11px">'+h+'</td>';
  }}
];

var COL_CONFIG_KEY = 'bfl_companyMgmt_colConfig';
var _colMap = {}; COLUMNS.forEach(function(c){ _colMap[c.key] = c; });

function getColConfig() {
  var saved = localStorage.getItem(COL_CONFIG_KEY);
  if (saved) {
    try {
      var cfg = JSON.parse(saved);
      // ìƒˆë¡œ ì¶”ê°€ëœ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ columns ëì— ì¶”ê°€
      COLUMNS.forEach(function(c) { if (cfg.columns.indexOf(c.key)===-1) cfg.columns.push(c.key); });
      return cfg;
    } catch(e) {}
  }
  var keys = COLUMNS.filter(function(c){ return c.defaultVisible; }).map(function(c){ return c.key; });
  return { columns: COLUMNS.map(function(c){return c.key;}), visible: keys };
}
function saveColConfig(cfg) { localStorage.setItem(COL_CONFIG_KEY, JSON.stringify(cfg)); }
function getVisibleColumns() {
  var cfg = getColConfig();
  return cfg.columns.filter(function(k){ return cfg.visible.indexOf(k)!==-1 && _colMap[k]; }).map(function(k){ return _colMap[k]; });
}

// ============================================================
// í† ìŠ¤íŠ¸
// ============================================================
function toast(msg) {
  var el = document.getElementById('toastEl');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(function() { el.classList.remove('show'); }, 2000);
}

// ============================================================
// í˜ì´ì§€ ì „í™˜
// ============================================================
function showPage(id) {
  // salesMgmt í˜¸í™˜ ë§¤í•‘
  var pageMap = { 'customerList': 'list', 'customerReg': 'reg', 'customerDetail': 'detail' };
  var mappedId = pageMap[id] || id;

  document.querySelectorAll('.page').forEach(function(p) { p.style.display = 'none'; });
  var page = document.getElementById('page-' + mappedId);
  if (page) page.style.display = 'block';
  document.getElementById('contentArea').scrollTop = 0;

  if (mappedId === 'list') {
    document.getElementById('topSub').textContent = 'ì—…ì²´ë“±ë¡Â·ìˆ˜ì •';
    loadList();
  } else if (mappedId === 'reg') {
    document.getElementById('topSub').textContent = 'ì‹ ê·œ ë“±ë¡';
    _currentId = null;
    _editMode = false;
    resetRegForm();
  }
}

// ============================================================
// ì—…ì²´ ëª©ë¡ ë¡œë“œ
// ============================================================
var _customersCache = [];

async function getCustomers() {
  try {
    _customersCache = await fsGetCompanies();
  } catch(e) {
    console.warn('Firestore ì—…ì²´ ë¡œë“œ ì‹¤íŒ¨:', e.message);
  }
  return _customersCache;
}

function getCustomersSync() {
  return _customersCache;
}

async function loadList() {
  var thead = document.getElementById('customerThead');
  var tbody = document.getElementById('customerTbody');
  if (!thead || !tbody) return;

  var visCols = getVisibleColumns();

  // â”€â”€ thead ë™ì  ë Œë”ë§ â”€â”€
  var thRow = thead.querySelector('tr');
  var thHtml = '<th class="center" style="width:36px"><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)"></th>';
  visCols.forEach(function(col) {
    thHtml += '<th draggable="true" data-col-key="' + col.key + '">' + col.label + '</th>';
  });
  thRow.innerHTML = thHtml;

  // â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€
  var allCustomers = await getCustomers();

  // â”€â”€ ê²€ìƒ‰ í•„í„° â”€â”€
  var q = _custSearchQuery.toLowerCase().trim();
  var filtered = allCustomers;
  if (q) {
    filtered = allCustomers.filter(function(c) {
      return (c.company && c.company.toLowerCase().indexOf(q) !== -1) ||
             (c.bizNo && c.bizNo.indexOf(q) !== -1) ||
             (c.contactName && c.contactName.toLowerCase().indexOf(q) !== -1) ||
             (c.repName && c.repName.toLowerCase().indexOf(q) !== -1) ||
             (c.salesRep && c.salesRep.toLowerCase().indexOf(q) !== -1);
    });
  }

  // checkAll ì´ˆê¸°í™”
  var checkAll = document.getElementById('checkAll');
  if (checkAll) checkAll.checked = false;
  updateBulkDeleteBtn();

  // â”€â”€ ë¹ˆ ëª©ë¡ ì²˜ë¦¬ â”€â”€
  var emptyMsg = document.getElementById('emptyMsg');
  if (filtered.length === 0) {
    tbody.innerHTML = '';
    if (emptyMsg) emptyMsg.style.display = 'block';
  } else {
    if (emptyMsg) emptyMsg.style.display = 'none';
  }

  // â”€â”€ tbody ë Œë”ë§ â”€â”€
  tbody.innerHTML = '';
  filtered.forEach(function(c) {
    var tr = document.createElement('tr');
    // ì‹ í˜¸ë“±ì— ë”°ë¥¸ í–‰ ë°°ê²½ìƒ‰
    if (c.trafficLight === 'orange') tr.style.background = '#fff8e1';
    if (c.trafficLight === 'red') tr.style.background = '#fce4ec';

    tr.style.cursor = 'pointer';
    var tdHtml = '<td class="center" onclick="event.stopPropagation()"><input type="checkbox" class="row-check" value="' + (c.id||'') + '" onchange="updateBulkDeleteBtn()"></td>';
    visCols.forEach(function(col) { tdHtml += col.render(c); });
    tr.innerHTML = tdHtml;
    // í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸°
    if (c.id) {
      tr.setAttribute('data-cust-id', c.id);
      tr.onclick = (function(custId) { return function(e) { if (e.target.type === 'checkbox') return; openDetail(custId); }; })(c.id);
    }
    tbody.appendChild(tr);
  });

  // â”€â”€ í†µê³„ ê°±ì‹  â”€â”€
  var statTotal = document.getElementById('statTotal');
  var statActive = document.getElementById('statActive');
  var statReceivable = document.getElementById('statReceivable');
  var statDanger = document.getElementById('statDanger');
  if (statTotal) statTotal.textContent = allCustomers.length;
  if (statActive) statActive.textContent = allCustomers.filter(function(c){return c.status==='í™œë™';}).length;
  if (statReceivable) statReceivable.textContent = allCustomers.filter(function(c){ return c.trafficLight === 'yellow' || c.trafficLight === 'orange' || c.trafficLight === 'red'; }).length;
  if (statDanger) statDanger.textContent = allCustomers.filter(function(c){ return c.trafficLight === 'orange' || c.trafficLight === 'red'; }).length;

  // â”€â”€ ë“œë˜ê·¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” â”€â”€
  initColumnDrag();
}

function filterCustomerTable(val) {
  _custSearchQuery = val || '';
  loadList();
}

// ============================================================
// âš™ï¸ ì»¬ëŸ¼ ì„¤ì • íŒ¨ë„
// ============================================================
function toggleColSettings() {
  var panel = document.getElementById('colSettingsPanel');
  if (panel.style.display === 'none' || !panel.style.display) {
    renderColSettings();
    panel.style.display = 'block';
    setTimeout(function() { document.addEventListener('click', _closeColSettingsOutside); }, 0);
  } else {
    panel.style.display = 'none';
    document.removeEventListener('click', _closeColSettingsOutside);
  }
}
function _closeColSettingsOutside(e) {
  var panel = document.getElementById('colSettingsPanel');
  var btn = document.getElementById('colSettingsBtn');
  if (!panel.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
    panel.style.display = 'none';
    document.removeEventListener('click', _closeColSettingsOutside);
  }
}
function renderColSettings() {
  var cfg = getColConfig();
  var panel = document.getElementById('colSettingsPanel');
  var html = '<div class="col-settings-header"><span>âš™ï¸ ì»¬ëŸ¼ ì„¤ì •</span><span class="col-settings-reset" onclick="resetColConfig()">ì´ˆê¸°í™”</span></div>';
  // ê¸°ë³¸ ì»¬ëŸ¼ ê·¸ë£¹
  html += '<div style="font-size:10px;color:#999;padding:4px 8px;font-weight:600">ê¸°ë³¸ ì»¬ëŸ¼</div>';
  cfg.columns.forEach(function(key) {
    var col = _colMap[key]; if (!col || !col.defaultVisible) return;
    var chk = cfg.visible.indexOf(key) !== -1 ? 'checked' : '';
    html += '<label class="col-setting-item"><input type="checkbox" ' + chk + ' onchange="toggleColumn(\'' + key + '\',this.checked)"><span>' + col.label + '</span></label>';
  });
  // ì¶”ê°€ ì»¬ëŸ¼ ê·¸ë£¹
  html += '<div class="col-setting-divider"></div>';
  html += '<div style="font-size:10px;color:#999;padding:4px 8px;font-weight:600">ì¶”ê°€ ì»¬ëŸ¼</div>';
  cfg.columns.forEach(function(key) {
    var col = _colMap[key]; if (!col || col.defaultVisible) return;
    var chk = cfg.visible.indexOf(key) !== -1 ? 'checked' : '';
    html += '<label class="col-setting-item"><input type="checkbox" ' + chk + ' onchange="toggleColumn(\'' + key + '\',this.checked)"><span>' + col.label + '</span></label>';
  });
  panel.innerHTML = html;
}
function toggleColumn(key, show) {
  var cfg = getColConfig();
  var idx = cfg.visible.indexOf(key);
  if (show && idx === -1) {
    cfg.visible.push(key);
    if (cfg.columns.indexOf(key) === -1) cfg.columns.push(key);
  } else if (!show && idx !== -1) {
    cfg.visible.splice(idx, 1);
  }
  saveColConfig(cfg);
  loadList();
}
function resetColConfig() {
  localStorage.removeItem(COL_CONFIG_KEY);
  renderColSettings();
  loadList();
  toast('âœ… ì»¬ëŸ¼ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================
// ì»¬ëŸ¼ ë“œë˜ê·¸ ì´ë™ (HTML5 Drag & Drop)
// ============================================================
var _dragColKey = null;

function initColumnDrag() {
  var ths = document.querySelectorAll('#customerThead th[draggable="true"]');
  ths.forEach(function(th) {
    th.addEventListener('dragstart', _onColDragStart);
    th.addEventListener('dragover', _onColDragOver);
    th.addEventListener('dragenter', _onColDragEnter);
    th.addEventListener('dragleave', _onColDragLeave);
    th.addEventListener('drop', _onColDrop);
    th.addEventListener('dragend', _onColDragEnd);
  });
}
function _onColDragStart(e) {
  _dragColKey = this.getAttribute('data-col-key');
  this.classList.add('col-dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _dragColKey);
}
function _onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function _onColDragEnter(e) { e.preventDefault(); this.classList.add('col-drag-over'); }
function _onColDragLeave() { this.classList.remove('col-drag-over'); }
function _onColDrop(e) {
  e.preventDefault();
  this.classList.remove('col-drag-over');
  var targetKey = this.getAttribute('data-col-key');
  if (!_dragColKey || _dragColKey === targetKey) return;
  var cfg = getColConfig();
  var fromIdx = cfg.columns.indexOf(_dragColKey);
  var toIdx = cfg.columns.indexOf(targetKey);
  if (fromIdx === -1 || toIdx === -1) return;
  cfg.columns.splice(fromIdx, 1);
  cfg.columns.splice(toIdx, 0, _dragColKey);
  saveColConfig(cfg);
  loadList();
}
function _onColDragEnd() {
  _dragColKey = null;
  document.querySelectorAll('#customerThead th').forEach(function(th) {
    th.classList.remove('col-dragging', 'col-drag-over');
  });
}

// ============================================================
// ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ / ì„ íƒ ì‚­ì œ
// ============================================================
function toggleCheckAll(el) {
  var checks = document.querySelectorAll('.row-check');
  checks.forEach(function(cb) { cb.checked = el.checked; });
  updateBulkDeleteBtn();
}

function updateBulkDeleteBtn() {
  var checked = document.querySelectorAll('.row-check:checked');
  var btn = document.getElementById('btnBulkDelete');
  if (btn) {
    btn.style.display = checked.length > 0 ? '' : 'none';
    btn.textContent = 'ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ (' + checked.length + ')';
  }
}

/* ===== ì‚­ì œ ê¶Œí•œ ì²´í¬ â€” ì¶”í›„ ë“±ê¸‰ë³„ ì œì–´ êµ¬í˜„ ì˜ˆì • ===== */
function checkDeletePermission() {
  // TODO: ì‚¬ìš©ì ë“±ê¸‰ í™•ì¸ ë¡œì§ (ì¶”í›„ ì§€ì • ì—…ë¬´)
  // ì˜ˆ: var user = firebase.auth().currentUser;
  //     var role = getUserRole(user.uid);
  //     if (role !== 'admin' && role !== 'manager') return false;
  return true;
}

/* ===== ì„ íƒ(ì¼ê´„) ì‚­ì œ â€” ëª¨ë‹¬ í‘œì‹œ ===== */
async function bulkDeleteCompanies() {
  var checked = document.querySelectorAll('.row-check:checked');
  if (checked.length === 0) return;

  // ê¶Œí•œ ì²´í¬ (ì¶”í›„ ë“±ê¸‰ë³„ ì œì–´)
  if (!checkDeletePermission()) {
    toast('â›” ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
    return;
  }

  // ì‚­ì œ ëŒ€ìƒ ì—…ì²´ëª… + ì‚¬ì—…ìë²ˆí˜¸ ì¡°íšŒ
  var ids = [];
  checked.forEach(function(cb) { ids.push(cb.value); });

  var listHtml = '';
  ids.forEach(function(id, i) {
    var c = (_customersCache || []).find(function(x) { return x.id === id; });
    var name = c ? (c.company || c.name || id) : id;
    var bizNo = c ? (c.bizNo || '') : '';
    listHtml += '<div class="del-item">' +
      '<span class="del-idx">' + (i + 1) + '</span>' +
      '<span class="del-name">' + escHtml(name) + '</span>' +
      (bizNo ? '<span class="del-biz">' + escHtml(bizNo) + '</span>' : '') +
      '</div>';
  });

  // ëª¨ë‹¬ ì´ˆê¸°í™” ë° í‘œì‹œ
  document.getElementById('delCount').textContent = ids.length;
  document.getElementById('delList').innerHTML = listHtml;
  document.getElementById('delProgress').style.display = 'none';
  document.getElementById('delProgressFill').style.width = '0%';
  document.getElementById('delActions').style.display = 'flex';
  document.getElementById('delConfirmBtn').disabled = false;
  document.getElementById('bulkDeleteModal').classList.add('show');
  window._bulkDeleteIds = ids;
}

function closeBulkDeleteModal() {
  document.getElementById('bulkDeleteModal').classList.remove('show');
  window._bulkDeleteIds = null;
}

async function confirmBulkDelete() {
  var ids = window._bulkDeleteIds;
  if (!ids || ids.length === 0) return;

  // ë²„íŠ¼ ë¹„í™œì„±í™” + ì§„í–‰ë¥  í‘œì‹œ
  document.getElementById('delConfirmBtn').disabled = true;
  document.getElementById('delActions').querySelector('.btn-secondary').disabled = true;
  document.getElementById('delProgress').style.display = 'block';

  var total = ids.length;
  var done = 0;
  var failed = 0;

  for (var i = 0; i < ids.length; i++) {
    try {
      // Storage íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œ
      try { await fsDeleteCompanyFiles(ids[i]); } catch(e) { console.warn('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', e.message); }
      await fsDeleteCompany(ids[i]);
      done++;
    } catch(e) {
      failed++;
      console.warn('ì—…ì²´ ì‚­ì œ ì‹¤íŒ¨:', ids[i], e.message);
    }
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    var pct = Math.round(((done + failed) / total) * 100);
    document.getElementById('delProgressFill').style.width = pct + '%';
    document.getElementById('delProgressText').textContent = 'ì‚­ì œ ì¤‘... ' + (done + failed) + '/' + total;
  }

  closeBulkDeleteModal();
  _customersCache = null;  // ìºì‹œ ë¬´íš¨í™”
  toast('ğŸ—‘ï¸ ' + done + 'ê°œ ì—…ì²´ ì‚­ì œ ì™„ë£Œ' + (failed > 0 ? ' (' + failed + 'ê°œ ì‹¤íŒ¨)' : ''));
  await loadList();
}

// ============================================================
// ìƒì„¸ ë³´ê¸° (salesMgmt.html openCustomerDetailê³¼ ë™ì¼)
// ============================================================
async function openDetail(id) {
  var cust = await fsGetCompanyById(id);
  if (!cust) { toast('ì—…ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

  _currentId = id;
  _detailCustId = id;
  _editMode = false;
  _detailEditMode = false;
  _detailBizFile = null;
  _detailLicFile = null;

  document.getElementById('topSub').textContent = cust.company + ' ìƒì„¸';

  // ë“±ê¸‰/ìƒíƒœ íƒœê·¸
  var gradeTag = { 'VIP': '<span class="tag tag-vip">VIP</span>', 'A': '<span class="tag tag-a">A</span>', 'B': '<span class="tag tag-b">B</span>', 'C': '<span class="tag tag-c">C</span>' };
  var statusTag = { 'í™œë™': '<span class="tag tag-active">í™œë™</span>', 'íœ´ë©´': '<span class="tag tag-dormant">íœ´ë©´</span>', 'í•´ì§€': '<span class="tag" style="background:#fce4ec;color:#c62828">í•´ì§€</span>' };
  document.getElementById('detailCompanyTitle').textContent = cust.company;
  document.getElementById('detailGradeTag').innerHTML = gradeTag[cust.grade] || '';
  document.getElementById('detailStatusTag').innerHTML = statusTag[cust.status] || '';

  // ê¸°ë³¸ ì •ë³´ í•„ë“œ ì±„ìš°ê¸°
  document.getElementById('detCompany').value = cust.company || '';
  document.getElementById('detRepName').value = cust.repName || '';
  document.getElementById('detBizNo').value = cust.bizNo || '';
  document.getElementById('detCorpNo').value = cust.corpNo || '';
  document.getElementById('detBizType').value = cust.bizType || '';
  document.getElementById('detBizItem').value = cust.bizItem || '';
  document.getElementById('detZipcode').value = cust.zipcode || '';
  document.getElementById('detAddr1').value = cust.addr1 || '';
  document.getElementById('detAddr2').value = cust.addr2 || '';
  document.getElementById('detCompanyEn').value = cust.companyEn || '';
  document.getElementById('detRepNameEn').value = cust.repNameEn || '';
  document.getElementById('detAddrEn').value = cust.addrEn || '';
  // ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì
  document.getElementById('detTaxName').value = cust.taxName || '';
  document.getElementById('detTaxPhone').value = cust.taxPhone || '';
  document.getElementById('detTaxEmail').value = cust.taxEmail || '';
  // ë©”ëª¨
  document.getElementById('detMemo').value = cust.memo || '';

  // ë‹¤ì¤‘ ì¸í—ˆê°€ ì •ë³´ ë Œë”ë§
  renderDetailLicenses(cust);
  // ë‹¤ì¤‘ ë‹´ë‹¹ì ì •ë³´ ë Œë”ë§
  renderDetailContacts(cust);
  // ì¸í—ˆê°€ ì¹´ë“œì— ì—°ê²°ëœ ë‹´ë‹¹ì í‘œì‹œ
  updateLicContactDisplay();

  // ì²¨ë¶€íŒŒì¼/OCR ë³´ê¸° ë Œë”ë§
  renderFileViewSection(cust);

  // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
  document.getElementById('detailBizFileName').textContent = 'ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼';
  document.getElementById('detailLicFileName').textContent = 'ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼';
  document.getElementById('detailBizOcrBtn').disabled = true;
  document.getElementById('detailLicOcrBtn').disabled = true;
  var ocrStatus = document.getElementById('detailOcrStatus');
  if (ocrStatus) { ocrStatus.style.display = 'none'; ocrStatus.textContent = ''; }

  // ìš°í¸ë²ˆí˜¸ ë¯¸ë“±ë¡ ì‹œ ì¹´ì¹´ì˜¤ APIë¡œ ìë™ ì¡°íšŒ
  if (!cust.zipcode && cust.addr1) {
    lookupAddressFromKakao(cust.addr1, function(zipcode, roadAddr, detailAddr) {
      if (zipcode) { document.getElementById('detZipcode').value = zipcode; cust.zipcode = zipcode; }
      if (roadAddr && roadAddr !== cust.addr1) { document.getElementById('detAddr1').value = roadAddr; cust.addr1 = roadAddr; }
      db.collection('companies').doc(id).update({ zipcode: cust.zipcode, addr1: cust.addr1 });
    });
  }
  // ì¸í—ˆê°€ ìš°í¸ë²ˆí˜¸ ë¯¸ë“±ë¡ ì‹œ ì¹´ì¹´ì˜¤ APIë¡œ ìë™ ì¡°íšŒ
  var lics = cust.licenses || [];
  lics.forEach(function(lic, i) {
    if (!lic.licZipcode && lic.licAddr) {
      lookupAddressFromKakao(lic.licAddr, function(zipcode, roadAddr, detailAddr) {
        var num = i + 1;
        if (zipcode) { lic.licZipcode = zipcode; var zEl = document.getElementById('detLicZipcode_' + num); if (zEl) zEl.value = zipcode; }
        if (roadAddr && roadAddr !== lic.licAddr) { lic.licAddr = roadAddr; var aEl = document.getElementById('detLicAddr_' + num); if (aEl) aEl.value = roadAddr; }
        if (detailAddr && !lic.licAddr2) { lic.licAddr2 = detailAddr; var a2El = document.getElementById('detLicAddr2_' + num); if (a2El) a2El.value = detailAddr; }
        var updLics = cust.licenses || [];
        if (updLics[i]) { updLics[i] = lic; }
        db.collection('companies').doc(id).update({ licenses: updLics });
      });
    }
  });

  // ë³€ê²½ ì´ë ¥ ë¡œë“œ
  renderChangeLog(cust.changeLog || []);

  // ìˆ˜ì • ëª¨ë“œ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ
  document.getElementById('detailEditBtn').style.display = '';
  document.getElementById('detailSaveBtn').style.display = 'none';
  document.getElementById('detailCancelBtn').style.display = 'none';
  var bizPostBtn = document.getElementById('detBizPostBtn');
  if (bizPostBtn) bizPostBtn.style.display = 'none';
  var addLicBtn = document.getElementById('detAddLicBtn');
  if (addLicBtn) addLicBtn.style.display = 'none';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = 'none'; });
  var addContactBtn = document.getElementById('detAddContactBtn');
  if (addContactBtn) addContactBtn.style.display = 'none';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = 'none'; });

  showPage('detail');
}

// ============================================================
// ì²¨ë¶€íŒŒì¼ / OCR ê²°ê³¼ ë³´ê¸°
// ============================================================
function renderFileViewSection(cust) {
  var section = document.getElementById('fileViewSection');
  var row = document.getElementById('fileViewRow');
  if (!section || !row) return;

  var files = cust.files || {};
  var hasFiles = false;
  var html = '';

  // ì‚¬ì—…ìë“±ë¡ì¦ ì›ë³¸ ë³´ê¸°
  if (files.bizLicenseUrl) {
    hasFiles = true;
    html += '<button class="file-view-btn" onclick="window.open(\'' + files.bizLicenseUrl + '\',\'_blank\')">' +
      '<span class="fv-icon">ğŸ“„</span> ì‚¬ì—…ìë“±ë¡ì¦ ì›ë³¸</button>';
  }

  // ì¸í—ˆê°€ë¬¸ì„œ ì›ë³¸ ë³´ê¸° â€” ì¸í—ˆê°€ ì¹´ë“œì— ê°œë³„ í‘œì‹œë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìƒëµ
  // (licenseIndex ì—†ëŠ” ê¸°ì¡´ ë°ì´í„°ë„ ì¸í—ˆê°€ ì¹´ë“œì—ì„œ ìˆœì„œëŒ€ë¡œ ë§¤í•‘ë¨)

  // OCR ê²°ê³¼ ë³´ê¸°
  if (files.ocrResults && files.ocrResults.length > 0) {
    hasFiles = true;
    html += '<button class="file-view-btn" onclick="openOcrResultModal()" style="border-color:#90caf9;color:#1565c0">' +
      '<span class="fv-icon">ğŸ”</span> OCR ê²°ê³¼ (' + files.ocrResults.length + 'ê±´)</button>';
    window._currentOcrResults = files.ocrResults;
  } else {
    window._currentOcrResults = null;
  }

  // ì¸í—ˆê°€ë¬¸ì„œê°€ ìˆì§€ë§Œ ì¸í—ˆê°€ ì¹´ë“œì— í‘œì‹œ ì•ˆ ë  ìˆ˜ ìˆëŠ” ê²½ìš° (ì¸í—ˆê°€ê°€ ì—†ëŠ”ë° ë¬¸ì„œë§Œ ìˆì„ ë•Œ)
  var permitDocs = files.permitDocs || [];
  var licenses = (cust.licenses && cust.licenses.length > 0) ? cust.licenses : [];
  if (permitDocs.length > 0 && licenses.length === 0) {
    hasFiles = true;
    permitDocs.forEach(function(doc, i) {
      var label = doc.name || ('ì¸í—ˆê°€ë¬¸ì„œ ' + (i + 1));
      html += '<button class="file-view-btn" onclick="window.open(\'' + doc.url + '\',\'_blank\')">' +
        '<span class="fv-icon">ğŸ“‹</span> ' + escHtml(label) + '</button>';
    });
  }

  if (hasFiles) {
    row.innerHTML = html;
    section.style.display = '';
  } else {
    section.style.display = 'none';
  }
}

function openOcrResultModal() {
  var results = window._currentOcrResults;
  if (!results || results.length === 0) { toast('ì €ì¥ëœ OCR ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }

  var body = document.getElementById('ocrModalBody');
  var sub = document.getElementById('ocrModalSub');
  sub.textContent = 'ì´ ' + results.length + 'ê±´ì˜ OCR ì¸ì‹ ê²°ê³¼';

  var html = '';
  results.forEach(function(r, i) {
    var typeLabel = r.type === 'bizLicense' ? 'ğŸ“„ ì‚¬ì—…ìë“±ë¡ì¦' : 'ğŸ“‹ ì¸í—ˆê°€ë¬¸ì„œ';
    var dateStr = r.ocrAt ? new Date(r.ocrAt).toLocaleString('ko-KR') : '';

    html += '<div class="ocr-card">';
    html += '<div class="ocr-card-title">' + typeLabel + (r.fileName ? ' â€” ' + escHtml(r.fileName) : '') + '</div>';
    if (dateStr) html += '<div class="ocr-card-meta">ì¸ì‹ì¼: ' + dateStr + '</div>';

    if (r.data) {
      var fieldMap;
      if (r.type === 'bizLicense') {
        fieldMap = [
          ['companyName', 'íšŒì‚¬ëª…'], ['repName', 'ëŒ€í‘œì'], ['bizNo', 'ì‚¬ì—…ìë²ˆí˜¸'],
          ['corpNo', 'ë²•ì¸ë²ˆí˜¸'], ['taxType', 'ê³¼ì„¸ìœ í˜•'], ['bizType', 'ì—…íƒœ'],
          ['bizItem', 'ì¢…ëª©'], ['address', 'ì†Œì¬ì§€']
        ];
      } else {
        fieldMap = [
          ['bizName', 'ì—…ì†Œëª…'], ['repName', 'ëŒ€í‘œì'], ['licNo', 'ì¸í—ˆê°€ë²ˆí˜¸'],
          ['bizForm', 'ì˜ì—…í˜•íƒœ'], ['field', 'ë¶„ì•¼'], ['address', 'ì†Œì¬ì§€']
        ];
      }
      fieldMap.forEach(function(pair) {
        var val = r.data[pair[0]] || '';
        if (val) {
          html += '<div class="ocr-field-row"><span class="ocr-field-label">' + pair[1] + '</span><span class="ocr-field-value">' + escHtml(val) + '</span></div>';
        }
      });
    }
    html += '</div>';
  });

  body.innerHTML = html;
  document.getElementById('ocrResultModal').classList.add('show');
}

function closeOcrResultModal() {
  document.getElementById('ocrResultModal').classList.remove('show');
}

// ============================================================
// escHtml ìœ í‹¸ë¦¬í‹°
// ============================================================
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ë‹¤ì¤‘ ì¸í—ˆê°€ ì •ë³´ ë Œë”ë§
// ============================================================
function renderDetailLicenses(cust) {
  var container = document.getElementById('detLicenseContainer');
  if (!container) return;
  container.innerHTML = '';

  var licenses = cust.licenses && cust.licenses.length > 0 ? cust.licenses : [{
    licField: cust.licField || '',
    licBizForm: cust.licBizForm || '',
    licRepName: cust.licRepName || '',
    licNo: cust.licNo || '',
    licBizName: cust.licBizName || '',
    licZipcode: cust.licZipcode || '',
    licAddr: cust.licAddr || '',
    licAddr2: cust.licAddr2 || '',
    licBizNameEn: cust.licBizNameEn || '',
    licRepNameEn: cust.licRepNameEn || '',
    licAddrEn: cust.licAddrEn || '',
    licContact: cust.licContact || '',
    licContactPhone: cust.licContactPhone || '',
    licSalesRep: cust.licSalesRep || ''
  }];

  // ì¸í—ˆê°€ ì›ë³¸ ë¬¸ì„œ ë§¤í•‘ (licenseIndex ê¸°ë°˜, ì—†ìœ¼ë©´ ìˆœì„œëŒ€ë¡œ)
  var permitDocs = (cust.files && cust.files.permitDocs) || [];
  var permitDocsByIdx = {};
  var unmappedDocs = [];
  permitDocs.forEach(function(doc) {
    if (typeof doc.licenseIndex === 'number') {
      if (!permitDocsByIdx[doc.licenseIndex]) permitDocsByIdx[doc.licenseIndex] = [];
      permitDocsByIdx[doc.licenseIndex].push(doc);
    } else {
      unmappedDocs.push(doc);
    }
  });
  // licenseIndexê°€ ì—†ëŠ” ê¸°ì¡´ ë¬¸ì„œëŠ” ìˆœì„œëŒ€ë¡œ ë§¤í•‘
  var unmappedIdx = 0;
  for (var mi = 0; mi < licenses.length && unmappedIdx < unmappedDocs.length; mi++) {
    if (!permitDocsByIdx[mi]) {
      permitDocsByIdx[mi] = [unmappedDocs[unmappedIdx++]];
    }
  }

  for (var i = 0; i < licenses.length; i++) {
    var lic = licenses[i];
    var num = i + 1;
    var card = document.createElement('div');
    card.className = 'sub-card';
    card.id = 'detLicCard_' + num;
    card.style.marginBottom = '12px';

    // ì´ ì¸í—ˆê°€ì— ì—°ê²°ëœ ì›ë³¸ ë¬¸ì„œ ë²„íŠ¼ HTML
    var permitBtnHtml = '';
    var licDocs = permitDocsByIdx[i] || [];
    if (licDocs.length > 0) {
      permitBtnHtml = '<div style="margin-top:8px;padding:6px 10px;background:#fff3e0;border-radius:6px;border:1px solid #ffe0b2;display:flex;align-items:center;gap:8px;flex-wrap:wrap">' +
        '<span style="font-size:11px;font-weight:600;color:#e65100">ğŸ“‹ ì›ë³¸ ë¬¸ì„œ</span>';
      licDocs.forEach(function(doc) {
        var label = doc.name || 'ì¸í—ˆê°€ë¬¸ì„œ';
        permitBtnHtml += '<button class="file-view-btn" onclick="window.open(\'' + doc.url + '\',\'_blank\')" style="font-size:11px;padding:3px 10px">' +
          '<span class="fv-icon" style="font-size:12px">ğŸ“„</span> ' + escHtml(label) + '</button>';
      });
      permitBtnHtml += '</div>';
    }

    card.innerHTML =
      '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">' + num + '</span> ì¸í—ˆê°€</div>' +
        '<button class="btn btn-secondary btn-sm detLicDelBtn" onclick="removeDetailLicenseCard(' + num + ')" style="display:none;margin-left:auto;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
      '</div>' +
      '<div class="fg-row">' +
        '<div class="fg"><label>ë¶„ì•¼</label><input id="detLicField_' + num + '" value="' + escHtml(lic.licField) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ</label><input id="detLicBizForm_' + num + '" value="' + escHtml(lic.licBizForm) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '</div>' +
      '<div class="fg-row">' +
        '<div class="fg"><label>ëŒ€í‘œì</label><input id="detLicRepName_' + num + '" value="' + escHtml(lic.licRepName) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸</label><input id="detLicNo_' + num + '" value="' + escHtml(lic.licNo) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '</div>' +
      '<div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­</label><input id="detLicBizName_' + num + '" value="' + escHtml(lic.licBizName) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '<div class="fg"><label>ì†Œì¬ì§€</label>' +
        '<div class="addr-row" style="margin-bottom:4px"><input id="detLicZipcode_' + num + '" value="' + escHtml(lic.licZipcode || '') + '" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;background:#f8f9fb" readonly class="det-editable"><button class="btn btn-secondary btn-sm detLicPostBtn" onclick="openLicPostcodeSearch(' + num + ',true)" style="display:none">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>' +
      '</div>' +
      '<div class="fg"><input id="detLicAddr_' + num + '" value="' + escHtml(lic.licAddr || '') + '" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '<div class="fg"><input id="detLicAddr2_' + num + '" value="' + escHtml(lic.licAddr2 || '') + '" placeholder="ìƒì„¸ì£¼ì†Œ" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '<div class="eng-toggle" onclick="toggleEngSection(\'detLicEngSection_' + num + '\')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">' +
        '<span style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)' +
      '</div>' +
      '<div id="detLicEngSection_' + num + '" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">' +
        '<div class="fg"><label>Business Name (EN)</label><input id="detLicBizNameEn_' + num + '" value="' + escHtml(lic.licBizNameEn) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>Representative (EN)</label><input id="detLicRepNameEn_' + num + '" value="' + escHtml(lic.licRepNameEn) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
        '<div class="fg"><label>Address (EN)</label><input id="detLicAddrEn_' + num + '" value="' + escHtml(lic.licAddrEn) + '" readonly style="background:#f8f9fb" class="det-editable"></div>' +
      '</div>' +
      permitBtnHtml +
      // ì¸í—ˆê°€ ë‹´ë‹¹ì í•„ë“œ
      '<div style="margin-top:8px;padding:8px 10px;background:#f1f8e9;border-radius:6px;border:1px solid #c5e1a5">' +
        '<div style="display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;color:#33691e;margin-bottom:6px">ğŸ‘¤ ì¸í—ˆê°€ ë‹´ë‹¹ì' +
        '<span id="detLicSalesRepLabel_' + num + '" style="background:#e3f2fd;color:#1565c0;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;margin-left:auto">ğŸ¢ ìì‚¬: ' + escHtml(lic.licSalesRep || '-') + '</span>' +
        '<input type="hidden" id="detLicSalesRep_' + num + '" value="' + escHtml(lic.licSalesRep || '') + '">' +
      '</div>' +
        '<div class="fg-row" style="gap:8px">' +
          '<div class="fg"><label style="color:#33691e;font-size:11px">ë‹´ë‹¹ì</label><input id="detLicContact_' + num + '" value="' + escHtml(lic.licContact || '') + '" readonly style="background:#f5f9f0;border:1px solid #c5e1a5;font-size:12px" class="det-editable det-lic-contact-field" placeholder="ë§¤ì¹­ ë˜ëŠ” ì§ì ‘ ì…ë ¥"></div>' +
          '<div class="fg"><label style="color:#33691e;font-size:11px">ì „í™”ë²ˆí˜¸</label><input id="detLicContactPhone_' + num + '" value="' + escHtml(lic.licContactPhone || '') + '" readonly style="background:#f5f9f0;border:1px solid #c5e1a5;font-size:12px" class="det-editable det-lic-contact-field" placeholder="ì „í™”ë²ˆí˜¸"></div>' +
        '</div>' +
      '</div>';

    container.appendChild(card);
  }
  _detLicCardCount = licenses.length;
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ë‹¤ì¤‘ ë‹´ë‹¹ì ë Œë”ë§
// ============================================================
function renderDetailContacts(cust) {
  var container = document.getElementById('detContactContainer');
  if (!container) return;
  container.innerHTML = '';

  var contacts = cust.contacts && cust.contacts.length > 0 ? cust.contacts : [];
  if (contacts.length === 0 && (cust.contactName || cust.contactPhone || cust.contactEmail)) {
    contacts = [{ name: cust.contactName || '', phone: cust.contactPhone || '', email: cust.contactEmail || '', role: '', salesRep: cust.salesRep || '', licNums: [] }];
  }
  if (contacts.length === 0) {
    contacts = [{ name: '', phone: '', email: '', role: '', salesRep: '', licNums: [] }];
  }

  for (var i = 0; i < contacts.length; i++) {
    var ct = contacts[i];
    var num = i + 1;
    var card = document.createElement('div');
    card.className = 'sub-card';
    card.id = 'detContactCard_' + num;
    card.style.cssText = 'margin-bottom:10px;border-left:3px solid #43a047';

    var licTagsHtml = '';
    var licNums = ct.licNums || [];
    if (licNums.length > 0) {
      var lics2 = cust.licenses || [];
      licTagsHtml = '<div id="detContactLicTags_' + num + '" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">';
      for (var j = 0; j < licNums.length; j++) {
        var ln = licNums[j];
        var licLabel = (lics2[ln - 1] && lics2[ln - 1].licBizName) ? lics2[ln - 1].licBizName : 'ì¸í—ˆê°€ ' + ln;
        licTagsHtml += '<span class="det-lic-match-tag" style="display:inline-flex;align-items:center;gap:3px;background:#e8f5e9;color:#2e7d32;font-size:11px;padding:2px 8px;border-radius:10px">ğŸ”— ' + escHtml(licLabel) + '</span>';
      }
      licTagsHtml += '</div>';
    } else {
      licTagsHtml = '<div id="detContactLicTags_' + num + '" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px"></div>';
    }

    var salesRepDisplay = ct.salesRep ? escHtml(ct.salesRep) : '<span style="color:#aaa">ë¯¸ì§€ì •</span>';

    card.innerHTML =
      '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num" style="background:#43a047">' + num + '</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì</div>' +
        '<div style="display:flex;gap:4px;margin-left:auto;align-items:center">' +
          '<span style="background:#e3f2fd;color:#1565c0;font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600">ğŸ¢ ìì‚¬: <span id="detContactSalesRepLabel_' + num + '">' + salesRepDisplay + '</span></span>' +
          '<button class="btn btn-secondary btn-sm detContactMatchBtn" onclick="openLicMatchModal(' + num + ')" style="display:none;font-size:11px;padding:3px 10px;color:#1565c0;border-color:#90caf9" title="ì¸í—ˆê°€ ë§¤ì¹­">ğŸ”— ë§¤ì¹­</button>' +
          '<button class="btn btn-secondary btn-sm detContactDelBtn" onclick="removeDetailContactCard(' + num + ')" style="display:none;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
        '</div>' +
      '</div>' +
      '<input type="hidden" id="detContactSalesRep_' + num + '" value="' + escHtml(ct.salesRep || '') + '">' +
      '<div class="fg-row" style="gap:8px">' +
        '<div class="fg" style="flex:1.2"><label>ì´ë¦„</label><input id="detContactName_' + num + '" value="' + escHtml(ct.name) + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
        '<div class="fg" style="flex:1"><label>ì—­í• /ì§ì±…</label><input id="detContactRole_' + num + '" value="' + escHtml(ct.role || '') + '" placeholder="í’ˆì§ˆê´€ë¦¬, êµ¬ë§¤ ë“±" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
      '</div>' +
      '<div class="fg-row" style="gap:8px">' +
        '<div class="fg"><label>ì „í™”ë²ˆí˜¸</label><input id="detContactPhone_' + num + '" value="' + escHtml(ct.phone) + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
        '<div class="fg"><label>ì´ë©”ì¼</label><input id="detContactEmail_' + num + '" value="' + escHtml(ct.email) + '" readonly style="background:#f8f9fb" class="det-editable det-contact-field"></div>' +
      '</div>' +
      '<input type="hidden" id="detContactLicNums_' + num + '" value=\'' + JSON.stringify(licNums) + '\'>' +
      licTagsHtml;

    container.appendChild(card);
  }
  _detContactCardCount = contacts.length;
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ì¸í—ˆê°€ ì¹´ë“œ ë™ì  ì¶”ê°€/ì‚­ì œ
// ============================================================
function addDetailLicenseCard() {
  _detLicCardCount++;
  var num = _detLicCardCount;
  var container = document.getElementById('detLicenseContainer');
  if (!container) return;

  var card = document.createElement('div');
  card.className = 'sub-card';
  card.id = 'detLicCard_' + num;
  card.style.marginBottom = '12px';
  card.style.animation = 'fadeIn 0.3s ease';

  card.innerHTML =
    '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num">' + num + '</span> ì¸í—ˆê°€</div>' +
      '<button class="btn btn-secondary btn-sm detLicDelBtn" onclick="removeDetailLicenseCard(' + num + ')" style="margin-left:auto;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
    '</div>' +
    // OCR ì˜ì—­
    '<div style="background:#f3f0ff;border:1px solid #d1c4e9;border-radius:8px;padding:10px;margin-bottom:10px">' +
      '<div style="font-size:12px;font-weight:600;color:#5e35b1;margin-bottom:6px">ğŸ“„ ì¸í—ˆê°€ ' + num + ' ë¬¸ì„œ OCR</div>' +
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">' +
        '<div class="file-area" style="flex:1;min-width:180px;padding:8px;position:relative;cursor:pointer" onclick="document.getElementById(\'detLicFileInput_' + num + '\').click()">' +
          '<input type="file" id="detLicFileInput_' + num + '" accept="image/*,.pdf" style="display:none" onchange="handleDetLicCardFile(' + num + ',this.files[0])">' +
          '<span id="detLicFileName_' + num + '" style="font-size:11px">ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼</span>' +
        '</div>' +
        '<button class="btn btn-check btn-sm" id="detLicOcrBtn_' + num + '" onclick="runDetLicCardOCR(' + num + ')" disabled style="font-size:11px">ğŸ¤– OCR</button>' +
      '</div>' +
      '<div id="detLicOcrStatus_' + num + '" style="margin-top:4px;font-size:11px;color:#5e35b1;display:none"></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ë¶„ì•¼</label><input id="detLicField_' + num + '" placeholder="ì‹í’ˆ/ì¶•ì‚°" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ</label><input id="detLicBizForm_' + num + '" placeholder="ì˜ì—… í˜•íƒœ" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ëŒ€í‘œì</label><input id="detLicRepName_' + num + '" placeholder="ëŒ€í‘œì" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸</label><input id="detLicNo_' + num + '" placeholder="ì¸í—ˆê°€ë²ˆí˜¸" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '</div>' +
    '<div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­</label><input id="detLicBizName_' + num + '" placeholder="ì˜ì—…ì†Œ ëª…ì¹­" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '<div class="fg"><label>ì†Œì¬ì§€</label>' +
      '<div class="addr-row" style="margin-bottom:4px"><input id="detLicZipcode_' + num + '" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;border:1px solid #1a73e8" class="det-editable" readonly><button class="btn btn-secondary btn-sm detLicPostBtn" onclick="openLicPostcodeSearch(' + num + ',true)">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>' +
    '</div>' +
    '<div class="fg"><input id="detLicAddr_' + num + '" placeholder="ê¸°ë³¸ì£¼ì†Œ" style="border:1px solid #1a73e8" class="det-editable" readonly></div>' +
    '<div class="fg"><input id="detLicAddr2_' + num + '" placeholder="ìƒì„¸ì£¼ì†Œ" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '<div class="eng-toggle" onclick="toggleEngSection(\'detLicEngSection_' + num + '\')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">' +
      '<span style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)' +
    '</div>' +
    '<div id="detLicEngSection_' + num + '" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">' +
      '<div class="fg"><label>Business Name (EN)</label><input id="detLicBizNameEn_' + num + '" placeholder="Business name" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>Representative (EN)</label><input id="detLicRepNameEn_' + num + '" placeholder="Representative" style="border:1px solid #1a73e8" class="det-editable"></div>' +
      '<div class="fg"><label>Address (EN)</label><input id="detLicAddrEn_' + num + '" placeholder="Address" style="border:1px solid #1a73e8" class="det-editable"></div>' +
    '</div>' +
    // ì¸í—ˆê°€ ë‹´ë‹¹ì
    '<div style="margin-top:8px;padding:8px 10px;background:#f1f8e9;border-radius:6px;border:1px solid #c5e1a5">' +
      '<div style="display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;color:#33691e;margin-bottom:6px">ğŸ‘¤ ì¸í—ˆê°€ ë‹´ë‹¹ì' +
        '<span id="detLicSalesRepLabel_' + num + '" style="background:#e3f2fd;color:#1565c0;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;margin-left:auto">ğŸ¢ ìì‚¬: -</span>' +
        '<input type="hidden" id="detLicSalesRep_' + num + '" value="">' +
      '</div>' +
      '<div class="fg-row" style="gap:8px">' +
        '<div class="fg"><label style="color:#33691e;font-size:11px">ë‹´ë‹¹ì</label><input id="detLicContact_' + num + '" placeholder="ë§¤ì¹­ ë˜ëŠ” ì§ì ‘ ì…ë ¥" style="border:1px solid #c5e1a5;background:#f5f9f0;font-size:12px" class="det-editable det-lic-contact-field"></div>' +
        '<div class="fg"><label style="color:#33691e;font-size:11px">ì „í™”ë²ˆí˜¸</label><input id="detLicContactPhone_' + num + '" placeholder="ì „í™”ë²ˆí˜¸" style="border:1px solid #c5e1a5;background:#f5f9f0;font-size:12px" class="det-editable det-lic-contact-field"></div>' +
      '</div>' +
    '</div>';

  container.appendChild(card);
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  toast('âœ… ì¸í—ˆê°€ ' + num + ' ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function removeDetailLicenseCard(num) {
  var card = document.getElementById('detLicCard_' + num);
  if (!card) return;
  if (!confirm('ì¸í—ˆê°€ ' + num + ' ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  card.remove();
  toast('ğŸ—‘ï¸ ì¸í—ˆê°€ ' + num + ' ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ë‹´ë‹¹ì ì¹´ë“œ ë™ì  ì¶”ê°€/ì‚­ì œ
// ============================================================
function addDetailContactCard() {
  _detContactCardCount++;
  var num = _detContactCardCount;
  var container = document.getElementById('detContactContainer');
  if (!container) return;

  var card = document.createElement('div');
  card.className = 'sub-card';
  card.id = 'detContactCard_' + num;
  card.style.cssText = 'margin-bottom:10px;border-left:3px solid #43a047;animation:fadeIn 0.3s ease';

  card.innerHTML =
    '<div class="sub-card-hd"><div class="sub-card-title"><span class="sub-card-num" style="background:#43a047">' + num + '</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì</div>' +
      '<div style="display:flex;gap:4px;margin-left:auto;align-items:center">' +
        '<span style="background:#e3f2fd;color:#1565c0;font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600">ğŸ¢ ìì‚¬: <input id="detContactSalesRep_' + num + '" placeholder="ìì‚¬ ë‹´ë‹¹" style="border:none;background:transparent;color:#1565c0;font-size:11px;font-weight:600;width:70px;outline:none" class="det-contact-field"></span>' +
        '<button class="btn btn-secondary btn-sm detContactMatchBtn" onclick="openLicMatchModal(' + num + ')" style="font-size:11px;padding:3px 10px;color:#1565c0;border-color:#90caf9" title="ì¸í—ˆê°€ ë§¤ì¹­">ğŸ”— ë§¤ì¹­</button>' +
        '<button class="btn btn-secondary btn-sm detContactDelBtn" onclick="removeDetailContactCard(' + num + ')" style="font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
      '</div>' +
    '</div>' +
    '<div class="fg-row" style="gap:8px">' +
      '<div class="fg" style="flex:1.2"><label>ì´ë¦„</label><input id="detContactName_' + num + '" placeholder="ë‹´ë‹¹ìëª…" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
      '<div class="fg" style="flex:1"><label>ì—­í• /ì§ì±…</label><input id="detContactRole_' + num + '" placeholder="í’ˆì§ˆê´€ë¦¬, êµ¬ë§¤ ë“±" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
    '</div>' +
    '<div class="fg-row" style="gap:8px">' +
      '<div class="fg"><label>ì „í™”ë²ˆí˜¸</label><input id="detContactPhone_' + num + '" placeholder="ì „í™”ë²ˆí˜¸" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
      '<div class="fg"><label>ì´ë©”ì¼</label><input id="detContactEmail_' + num + '" placeholder="ì´ë©”ì¼" style="border:1px solid #1a73e8" class="det-editable det-contact-field"></div>' +
    '</div>' +
    '<div id="detContactLicTags_' + num + '" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px"></div>';

  container.appendChild(card);
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  toast('âœ… ë‹´ë‹¹ì ' + num + ' ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
  if (_detLicCardCount > 0) {
    openLicMatchModal(num);
  }
}

function removeDetailContactCard(num) {
  var card = document.getElementById('detContactCard_' + num);
  if (card) {
    card.style.animation = 'fadeIn 0.2s ease reverse';
    setTimeout(function() { card.remove(); }, 200);
    toast('ğŸ—‘ ë‹´ë‹¹ì ' + num + ' ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

// ============================================================
// ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­ ëª¨ë‹¬
// ============================================================
function openLicMatchModal(contactNum) {
  _licMatchContactNum = contactNum;
  var modal = document.getElementById('licContactMatchModal');
  if (!modal) return;

  var contactName = (document.getElementById('detContactName_' + contactNum) || {}).value || 'ë‹´ë‹¹ì ' + contactNum;
  document.getElementById('licMatchDesc').innerHTML = '<strong>' + escHtml(contactName) + '</strong> ë‹˜ì„ ì–´ë–¤ ì¸í—ˆê°€ì˜ ë‹´ë‹¹ìë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

  var listEl = document.getElementById('licMatchList');
  listEl.innerHTML = '';

  var currentMatched = [];
  var hiddenEl = document.getElementById('detContactLicNums_' + contactNum);
  if (hiddenEl && hiddenEl.value) {
    try { currentMatched = JSON.parse(hiddenEl.value); } catch(e) {}
  }

  for (var li = 1; li <= _detLicCardCount; li++) {
    if (!document.getElementById('detLicCard_' + li)) continue;
    var bizName = (document.getElementById('detLicBizName_' + li) || {}).value || '';
    var licField = (document.getElementById('detLicField_' + li) || {}).value || '';
    var label = bizName || licField || 'ì¸í—ˆê°€ ' + li;
    var checked = currentMatched.indexOf(li) !== -1 ? ' checked' : '';

    var item = document.createElement('label');
    item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e2e6ed;border-radius:8px;margin-bottom:6px;cursor:pointer;transition:background 0.15s';
    item.innerHTML =
      '<input type="checkbox" class="lic-match-chk" value="' + li + '"' + checked + ' style="width:18px;height:18px;accent-color:#43a047">' +
      '<div style="flex:1">' +
        '<div style="font-weight:600;font-size:13px">' + escHtml(label) + '</div>' +
        '<div style="font-size:11px;color:#8892a4">ì¸í—ˆê°€ ' + li + (licField ? ' Â· ' + escHtml(licField) : '') + '</div>' +
      '</div>';
    listEl.appendChild(item);
  }

  if (_detLicCardCount === 0) {
    listEl.innerHTML = '<div style="text-align:center;color:#8892a4;padding:16px">ë“±ë¡ëœ ì¸í—ˆê°€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  }

  modal.style.display = 'flex';
}

function closeLicMatchModal() {
  var modal = document.getElementById('licContactMatchModal');
  if (modal) modal.style.display = 'none';
  _licMatchContactNum = null;
}

function applyLicMatch() {
  var num = _licMatchContactNum;
  if (!num) return;

  var checkedNums = [];
  document.querySelectorAll('#licMatchList .lic-match-chk:checked').forEach(function(chk) {
    checkedNums.push(parseInt(chk.value));
  });

  var hiddenEl = document.getElementById('detContactLicNums_' + num);
  if (!hiddenEl) {
    hiddenEl = document.createElement('input');
    hiddenEl.type = 'hidden';
    hiddenEl.id = 'detContactLicNums_' + num;
    var card = document.getElementById('detContactCard_' + num);
    if (card) card.appendChild(hiddenEl);
  }
  hiddenEl.value = JSON.stringify(checkedNums);

  var tagsEl = document.getElementById('detContactLicTags_' + num);
  if (tagsEl) {
    tagsEl.innerHTML = '';
    for (var j = 0; j < checkedNums.length; j++) {
      var ln = checkedNums[j];
      var bizName = (document.getElementById('detLicBizName_' + ln) || {}).value || '';
      var licField = (document.getElementById('detLicField_' + ln) || {}).value || '';
      var label = bizName || licField || 'ì¸í—ˆê°€ ' + ln;
      tagsEl.innerHTML += '<span class="det-lic-match-tag" style="display:inline-flex;align-items:center;gap:3px;background:#e8f5e9;color:#2e7d32;font-size:11px;padding:2px 8px;border-radius:10px">ğŸ”— ' + escHtml(label) + '</span>';
    }
  }

  updateLicContactDisplay();
  closeLicMatchModal();
  var contactName = (document.getElementById('detContactName_' + num) || {}).value || 'ë‹´ë‹¹ì ' + num;
  if (checkedNums.length > 0) {
    toast('ğŸ”— ' + contactName + ' â†’ ' + checkedNums.length + 'ê°œ ì¸í—ˆê°€ ì—°ê²°');
  } else {
    toast('â„¹ï¸ ' + contactName + ' ì¸í—ˆê°€ ì—°ê²° í•´ì œ');
  }
}

// ============================================================
// ì¸í—ˆê°€ ì¹´ë“œ ë‚´ ì—°ê²°ëœ ë‹´ë‹¹ì í•„ë“œ ì—…ë°ì´íŠ¸
// ============================================================
function updateLicContactDisplay() {
  for (var li = 1; li <= _detLicCardCount; li++) {
    var card = document.getElementById('detLicCard_' + li);
    if (!card) continue;

    var linkedContacts = [];
    for (var ci = 1; ci <= _detContactCardCount; ci++) {
      if (!document.getElementById('detContactCard_' + ci)) continue;
      var hiddenEl = document.getElementById('detContactLicNums_' + ci);
      if (hiddenEl && hiddenEl.value) {
        try {
          var nums = JSON.parse(hiddenEl.value);
          if (nums.indexOf(li) !== -1) {
            var cName = (document.getElementById('detContactName_' + ci) || {}).value || '';
            var cPhone = (document.getElementById('detContactPhone_' + ci) || {}).value || '';
            var cSalesRep = (document.getElementById('detContactSalesRep_' + ci) || {}).value || '';
            linkedContacts.push({ name: cName, phone: cPhone, salesRep: cSalesRep });
          }
        } catch(e) {}
      }
    }

    var contactField = document.getElementById('detLicContact_' + li);
    var phoneField = document.getElementById('detLicContactPhone_' + li);
    var salesRepField = document.getElementById('detLicSalesRep_' + li);

    if (linkedContacts.length > 0) {
      var names = linkedContacts.map(function(c) { return c.name; }).filter(Boolean).join(', ');
      var phones = linkedContacts.map(function(c) { return c.phone; }).filter(Boolean).join(', ');
      var reps = linkedContacts.map(function(c) { return c.salesRep; }).filter(Boolean);
      var uniqueReps = reps.filter(function(v, i, a) { return a.indexOf(v) === i; }).join(', ');
      if (contactField) contactField.value = names;
      if (phoneField) phoneField.value = phones;
      if (salesRepField) salesRepField.value = uniqueReps;
      var repLabel = document.getElementById('detLicSalesRepLabel_' + li);
      if (repLabel) repLabel.innerHTML = 'ğŸ¢ ìì‚¬: ' + escHtml(uniqueReps || '-');
    }
  }
}

// ============================================================
// ë³€ê²½ ì´ë ¥ ë Œë”ë§
// ============================================================
function renderChangeLog(logs) {
  var tbody = document.getElementById('changeLogTbody');
  if (!tbody) return;
  if (!logs || logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8892a4;padding:20px">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  var sorted = logs.slice().reverse();
  sorted.forEach(function(log) {
    var tr = document.createElement('tr');
    tr.innerHTML = '<td style="white-space:nowrap;color:#5f6b7a">' + (log.date || '') + '</td>' +
      '<td>' + (log.who || 'ì‹œìŠ¤í…œ') + '</td>' +
      '<td style="font-size:11px">' + (log.detail || '') + '</td>';
    tbody.appendChild(tr);
  });
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ìˆ˜ì • ëª¨ë“œ ì „í™˜/ì €ì¥/ì·¨ì†Œ
// ============================================================
function toggleDetailEdit() {
  _detailEditMode = true;
  _detailSnapshot = {};
  document.querySelectorAll('#page-detail .det-editable').forEach(function(el) {
    _detailSnapshot[el.id] = el.value;
    el.readOnly = false;
    el.style.background = '#fff';
    el.style.border = '1px solid #1a73e8';
  });
  ['detCompany','detRepName','detBizNo','detCorpNo','detBizType','detBizItem','detZipcode','detAddr1','detAddr2',
   'detCompanyEn','detRepNameEn','detAddrEn',
   'detTaxName','detTaxPhone','detTaxEmail','detMemo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      _detailSnapshot[id] = el.value;
      if (id !== 'detZipcode' && id !== 'detAddr1') {
        el.readOnly = false;
      }
      el.style.background = '#fff';
      el.style.border = '1px solid #1a73e8';
    }
  });
  // ë‹´ë‹¹ì ì¹´ë“œì˜ hidden licNumsë„ ìŠ¤ëƒ…ìƒ· ì €ì¥ + ìì‚¬ ë‹´ë‹¹ ë¼ë²¨ì„ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ
  _detailSnapshot._contactsSnapshot = [];
  _detailSnapshot._salesRepSnapshot = [];
  for (var ci = 1; ci <= _detContactCardCount; ci++) {
    var hEl = document.getElementById('detContactLicNums_' + ci);
    _detailSnapshot._contactsSnapshot.push(hEl ? hEl.value : '[]');
    var srEl = document.getElementById('detContactSalesRep_' + ci);
    _detailSnapshot._salesRepSnapshot.push(srEl ? srEl.value : '');
    var srLabel = document.getElementById('detContactSalesRepLabel_' + ci);
    if (srLabel && srEl) {
      srLabel.innerHTML = '<input id="detContactSalesRepEdit_' + ci + '" value="' + escHtml(srEl.value) + '" style="border:none;background:transparent;color:#1565c0;font-size:11px;font-weight:600;width:70px;outline:none;border-bottom:1px dashed #1565c0" class="det-contact-field" onchange="document.getElementById(\'detContactSalesRep_' + ci + '\').value=this.value">';
    }
  }
  // ë²„íŠ¼ ì „í™˜
  document.getElementById('detailEditBtn').style.display = 'none';
  document.getElementById('detailSaveBtn').style.display = '';
  document.getElementById('detailCancelBtn').style.display = '';
  var bizPostBtn = document.getElementById('detBizPostBtn');
  if (bizPostBtn) bizPostBtn.style.display = '';
  var addBtn = document.getElementById('detAddLicBtn');
  if (addBtn) addBtn.style.display = '';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = ''; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = ''; });
  var addContactBtn = document.getElementById('detAddContactBtn');
  if (addContactBtn) addContactBtn.style.display = '';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = ''; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = ''; });
}

async function cancelDetailEdit() {
  _detailEditMode = false;
  if (_detailSnapshot) {
    Object.keys(_detailSnapshot).forEach(function(id) {
      if (id.startsWith('_')) return;
      var el = document.getElementById(id);
      if (el) el.value = _detailSnapshot[id];
    });
  }
  document.querySelectorAll('#page-detail .det-editable').forEach(function(el) {
    el.readOnly = true;
    el.style.background = '#f8f9fb';
    el.style.border = '';
  });
  ['detCompany','detRepName','detBizNo','detCorpNo','detBizType','detBizItem','detZipcode','detAddr1','detAddr2',
   'detCompanyEn','detRepNameEn','detAddrEn',
   'detTaxName','detTaxPhone','detTaxEmail','detMemo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.readOnly = true; el.style.background = '#f8f9fb'; el.style.border = ''; }
  });
  document.getElementById('detailEditBtn').style.display = '';
  document.getElementById('detailSaveBtn').style.display = 'none';
  document.getElementById('detailCancelBtn').style.display = 'none';
  var bizPostBtn = document.getElementById('detBizPostBtn');
  if (bizPostBtn) bizPostBtn.style.display = 'none';
  var addBtn = document.getElementById('detAddLicBtn');
  if (addBtn) addBtn.style.display = 'none';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = 'none'; });
  var addContactBtn = document.getElementById('detAddContactBtn');
  if (addContactBtn) addContactBtn.style.display = 'none';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = 'none'; });
  // ë™ì  ì¶”ê°€ëœ ì¹´ë“œ ì›ë³µ (ì›ë˜ ë°ì´í„° ì¬ë Œë”)
  var cust = await fsGetCompanyById(_detailCustId);
  if (cust) {
    renderDetailLicenses(cust);
    renderDetailContacts(cust);
    updateLicContactDisplay();
  }
  _detailSnapshot = null;
}

async function saveDetailEdit() {
  var cust = await fsGetCompanyById(_detailCustId);
  if (!cust) { toast('âš ï¸ ì—…ì²´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
  var now = new Date().toISOString().slice(0, 16).replace('T', ' ');
  var changes = [];

  // ê¸°ë³¸ ì •ë³´ ë¹„êµ ë° ì €ì¥
  var basicFields = [
    { id: 'detCompany', key: 'company', label: 'íšŒì‚¬ëª…' },
    { id: 'detRepName', key: 'repName', label: 'ëŒ€í‘œìëª…' },
    { id: 'detBizNo', key: 'bizNo', label: 'ì‚¬ì—…ìë²ˆí˜¸' },
    { id: 'detCorpNo', key: 'corpNo', label: 'ë²•ì¸ë²ˆí˜¸' },
    { id: 'detBizType', key: 'bizType', label: 'ì—…íƒœ' },
    { id: 'detBizItem', key: 'bizItem', label: 'ì¢…ëª©' },
    { id: 'detZipcode', key: 'zipcode', label: 'ìš°í¸ë²ˆí˜¸' },
    { id: 'detAddr1', key: 'addr1', label: 'ì£¼ì†Œ' },
    { id: 'detAddr2', key: 'addr2', label: 'ìƒì„¸ì£¼ì†Œ' },
    { id: 'detCompanyEn', key: 'companyEn', label: 'Company Name (EN)' },
    { id: 'detRepNameEn', key: 'repNameEn', label: 'Representative (EN)' },
    { id: 'detAddrEn', key: 'addrEn', label: 'Address (EN)' },
    { id: 'detTaxName', key: 'taxName', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ìëª…' },
    { id: 'detTaxPhone', key: 'taxPhone', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ ì „í™”' },
    { id: 'detTaxEmail', key: 'taxEmail', label: 'ì„¸ê¸ˆê³„ì‚°ì„œ ì´ë©”ì¼' },
    { id: 'detMemo', key: 'memo', label: 'ë©”ëª¨' }
  ];
  basicFields.forEach(function(f) {
    var el = document.getElementById(f.id);
    if (!el) return;
    var newVal = el.value.trim();
    var oldVal = (cust[f.key] || '').trim();
    if (newVal !== oldVal) {
      changes.push({ field: f.label, from: oldVal, to: newVal });
      cust[f.key] = newVal;
    }
  });

  // ì¸í—ˆê°€ ì •ë³´ ìˆ˜ì§‘
  var newLicenses = [];
  for (var li = 1; li <= _detLicCardCount; li++) {
    if (!document.getElementById('detLicCard_' + li)) continue;
    var lic = {
      licField: (document.getElementById('detLicField_' + li) || {}).value || '',
      licBizForm: (document.getElementById('detLicBizForm_' + li) || {}).value || '',
      licRepName: (document.getElementById('detLicRepName_' + li) || {}).value || '',
      licNo: (document.getElementById('detLicNo_' + li) || {}).value || '',
      licBizName: (document.getElementById('detLicBizName_' + li) || {}).value || '',
      licZipcode: (document.getElementById('detLicZipcode_' + li) || {}).value || '',
      licAddr: (document.getElementById('detLicAddr_' + li) || {}).value || '',
      licAddr2: (document.getElementById('detLicAddr2_' + li) || {}).value || '',
      licBizNameEn: (document.getElementById('detLicBizNameEn_' + li) || {}).value || '',
      licRepNameEn: (document.getElementById('detLicRepNameEn_' + li) || {}).value || '',
      licAddrEn: (document.getElementById('detLicAddrEn_' + li) || {}).value || '',
      licContact: (document.getElementById('detLicContact_' + li) || {}).value || '',
      licContactPhone: (document.getElementById('detLicContactPhone_' + li) || {}).value || '',
      licSalesRep: (document.getElementById('detLicSalesRep_' + li) || {}).value || ''
    };
    newLicenses.push(lic);
  }

  // ì¸í—ˆê°€ ë³€ê²½ ê°ì§€
  var oldLicenses = cust.licenses || [];
  if (newLicenses.length !== oldLicenses.length) {
    changes.push({ field: 'ì¸í—ˆê°€ ìˆ˜', from: oldLicenses.length + 'ê±´', to: newLicenses.length + 'ê±´' });
  }
  var licKeys = ['licField','licBizForm','licRepName','licNo','licBizName','licAddr','licAddr2','licBizNameEn','licRepNameEn','licAddrEn','licContact','licContactPhone','licSalesRep'];
  var licLabels = { licField:'ë¶„ì•¼', licBizForm:'ì˜ì—…í˜•íƒœ', licRepName:'ëŒ€í‘œì', licNo:'ì¸í—ˆê°€ë²ˆí˜¸', licBizName:'ì˜ì—…ì†Œëª…ì¹­', licAddr:'ì†Œì¬ì§€', licAddr2:'ìƒì„¸ì£¼ì†Œ', licBizNameEn:'Business Name(EN)', licRepNameEn:'Representative(EN)', licAddrEn:'Address(EN)', licContact:'ì¸í—ˆê°€ ë‹´ë‹¹ì', licContactPhone:'ì¸í—ˆê°€ ë‹´ë‹¹ì ì „í™”', licSalesRep:'ì¸í—ˆê°€ ìì‚¬ë‹´ë‹¹' };
  for (var ci2 = 0; ci2 < Math.min(newLicenses.length, oldLicenses.length); ci2++) {
    licKeys.forEach(function(k) {
      var ov = (oldLicenses[ci2][k] || '').trim();
      var nv = (newLicenses[ci2][k] || '').trim();
      if (ov !== nv) {
        changes.push({ field: 'ì¸í—ˆê°€' + (ci2+1) + ' ' + licLabels[k], from: ov, to: nv });
      }
    });
  }

  cust.licenses = newLicenses;
  if (newLicenses.length > 0) {
    var first = newLicenses[0];
    licKeys.forEach(function(k) { cust[k] = first[k] || ''; });
  }

  // ë‹¤ì¤‘ ë‹´ë‹¹ì ì •ë³´ ìˆ˜ì§‘
  var newContacts = [];
  for (var cti = 1; cti <= _detContactCardCount; cti++) {
    if (!document.getElementById('detContactCard_' + cti)) continue;
    var ctName = (document.getElementById('detContactName_' + cti) || {}).value || '';
    var ctPhone = (document.getElementById('detContactPhone_' + cti) || {}).value || '';
    var ctEmail = (document.getElementById('detContactEmail_' + cti) || {}).value || '';
    var ctRole = (document.getElementById('detContactRole_' + cti) || {}).value || '';
    var ctSalesRep = (document.getElementById('detContactSalesRep_' + cti) || {}).value || '';
    var ctLicNums = [];
    var ctHiddenEl = document.getElementById('detContactLicNums_' + cti);
    if (ctHiddenEl && ctHiddenEl.value) { try { ctLicNums = JSON.parse(ctHiddenEl.value); } catch(e) {} }
    if (!ctName && !ctPhone && !ctEmail) continue;
    newContacts.push({ name: ctName, phone: ctPhone, email: ctEmail, role: ctRole, salesRep: ctSalesRep, licNums: ctLicNums });
  }

  // ë‹´ë‹¹ì ë³€ê²½ ê°ì§€
  var oldContacts = cust.contacts || [];
  if (newContacts.length !== oldContacts.length) {
    changes.push({ field: 'ë‹´ë‹¹ì ìˆ˜', from: oldContacts.length + 'ëª…', to: newContacts.length + 'ëª…' });
  }
  var ctKeys = ['name','phone','email','role','salesRep'];
  var ctLabels = { name:'ì´ë¦„', phone:'ì „í™”ë²ˆí˜¸', email:'ì´ë©”ì¼', role:'ì—­í• ', salesRep:'ìì‚¬ ë‹´ë‹¹' };
  for (var cdi = 0; cdi < Math.min(newContacts.length, oldContacts.length); cdi++) {
    ctKeys.forEach(function(k) {
      var ov = (oldContacts[cdi][k] || '').trim();
      var nv = (newContacts[cdi][k] || '').trim();
      if (ov !== nv) {
        changes.push({ field: 'ë‹´ë‹¹ì' + (cdi+1) + ' ' + ctLabels[k], from: ov, to: nv });
      }
    });
    var oldNums = JSON.stringify(oldContacts[cdi].licNums || []);
    var newNums = JSON.stringify(newContacts[cdi].licNums || []);
    if (oldNums !== newNums) {
      changes.push({ field: 'ë‹´ë‹¹ì' + (cdi+1) + ' ì¸í—ˆê°€ ë§¤ì¹­', from: oldNums, to: newNums });
    }
  }

  cust.contacts = newContacts;
  if (newContacts.length > 0) {
    cust.contactName = newContacts[0].name || '';
    cust.contactPhone = newContacts[0].phone || '';
    cust.contactEmail = newContacts[0].email || '';
    cust.salesRep = newContacts[0].salesRep || '';
  }

  // ë³€ê²½ ì´ë ¥ ê¸°ë¡
  if (changes.length > 0) {
    var detail = changes.map(function(c) {
      return 'ã€' + c.field + 'ã€‘ "' + (c.from || '(ì—†ìŒ)') + '" â†’ "' + c.to + '"';
    }).join(', ');
    if (!cust.changeLog) cust.changeLog = [];
    cust.changeLog.push({
      date: now,
      who: 'ë‹´ë‹¹ì (ìˆ˜ë™ ìˆ˜ì •)',
      detail: 'ìˆ˜ë™ ìˆ˜ì •ì— ì˜í•´ ë³€ê²½ë¨ â€” ' + detail
    });
  }

  await fsSaveCompany(Object.assign({id: _detailCustId}, cust));

  // UI ë³µì› (readonly)
  _detailEditMode = false;
  document.querySelectorAll('#page-detail .det-editable').forEach(function(el) {
    el.readOnly = true; el.style.background = '#f8f9fb'; el.style.border = '';
  });
  ['detCompany','detRepName','detBizNo','detCorpNo','detBizType','detBizItem','detZipcode','detAddr1','detAddr2',
   'detCompanyEn','detRepNameEn','detAddrEn',
   'detTaxName','detTaxPhone','detTaxEmail','detMemo'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.readOnly = true; el.style.background = '#f8f9fb'; el.style.border = ''; }
  });
  document.getElementById('detailEditBtn').style.display = '';
  document.getElementById('detailSaveBtn').style.display = 'none';
  document.getElementById('detailCancelBtn').style.display = 'none';
  var detBizPostBtn = document.getElementById('detBizPostBtn');
  if (detBizPostBtn) detBizPostBtn.style.display = 'none';
  var detAddBtn = document.getElementById('detAddLicBtn');
  if (detAddBtn) detAddBtn.style.display = 'none';
  document.querySelectorAll('.detLicDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detLicPostBtn').forEach(function(b) { b.style.display = 'none'; });
  var detAddContactBtn = document.getElementById('detAddContactBtn');
  if (detAddContactBtn) detAddContactBtn.style.display = 'none';
  document.querySelectorAll('.detContactDelBtn').forEach(function(b) { b.style.display = 'none'; });
  document.querySelectorAll('.detContactMatchBtn').forEach(function(b) { b.style.display = 'none'; });

  renderChangeLog(cust.changeLog || []);
  document.getElementById('detailCompanyTitle').textContent = cust.company;
  _detailSnapshot = null;

  if (changes.length > 0) {
    toast('âœ… ' + changes.length + 'ê±´ ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else {
    toast('â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
  }
}

// ============================================================
// ìˆ˜ì • ëª¨ë“œ (ë“±ë¡ í¼ ê¸°ë°˜ ìˆ˜ì • - ê¸°ì¡´ í˜¸í™˜)
// ============================================================
async function toggleEdit() {
  if (!_currentId) return;
  var cust = await fsGetCompanyById(_currentId);
  if (!cust) return;

  if (!_editMode) {
    _editMode = true;
    showPage('reg');
    _currentId = cust.id;
    _editMode = true;
    document.getElementById('topSub').textContent = cust.company + ' ìˆ˜ì •';
    document.getElementById('btnSave').textContent = 'ğŸ’¾ ìˆ˜ì • ì €ì¥';
    document.getElementById('btnSave').setAttribute('onclick', 'updateCompany()');
    fillRegForm(cust);
  }
}

function fillRegForm(c) {
  document.getElementById('regCompany').value = c.company || '';
  document.getElementById('regRepName').value = c.repName || '';
  document.getElementById('regBizNo').value = c.bizNo || '';
  document.getElementById('regCorpNo').value = c.corpNo || '';
  document.getElementById('regBizType').value = c.bizType || '';
  document.getElementById('regBizItem').value = c.bizItem || '';
  setSelectVal('regGrade', c.grade || 'B');
  setSelectVal('regStatus', c.status || 'í™œë™');
  setSelectVal('regDepartment', c.department || '');
  setSelectVal('regReceiptType', c.receiptType || '');
  document.getElementById('regZipcode').value = c.zipcode || '';
  document.getElementById('regAddr1').value = c.addr1 || '';
  document.getElementById('regAddr2').value = c.addr2 || '';
  document.getElementById('regCompanyNameEn').value = c.companyEn || '';
  document.getElementById('regRepNameEn').value = c.repNameEn || '';
  document.getElementById('regAddrEn').value = c.addrEn || '';
  document.getElementById('regCName').value = c.contactName || '';
  document.getElementById('regCPhone').value = c.contactPhone || '';
  document.getElementById('regCEmail').value = c.contactEmail || '';
  setSelectVal('regSalesRep', c.salesRep || 'ì´ì£¼ì„');
  document.getElementById('regTaxName').value = c.taxName || '';
  document.getElementById('regTaxPhone').value = c.taxPhone || '';
  document.getElementById('regTaxEmail').value = c.taxEmail || '';
  document.getElementById('regMemo').value = c.memo || '';

  // ì¸í—ˆê°€ ì •ë³´ ì²« ë²ˆì§¸ ì¹´ë“œ
  var lic = (c.licenses && c.licenses[0]) || c;
  setSelectVal('licField_1', lic.licField || 'ì„ íƒ');
  setSelectVal('licBizForm_1', lic.licBizForm || 'ì„ íƒ');
  document.getElementById('licRepName_1').value = lic.licRepName || '';
  document.getElementById('licNo_1').value = lic.licNo || '';
  document.getElementById('licBizName_1').value = lic.licBizName || '';
  document.getElementById('licZipcode_1').value = lic.licZipcode || '';
  document.getElementById('licAddr_1').value = lic.licAddr || '';
  document.getElementById('licAddr2_1').value = lic.licAddr2 || '';
  document.getElementById('licBizNameEn_1').value = lic.licBizNameEn || '';
  document.getElementById('licRepNameEn_1').value = lic.licRepNameEn || '';
  document.getElementById('licAddrEn_1').value = lic.licAddrEn || '';

  // ë²•ì¸ì—¬ë¶€
  if (c.corpType === 'ê°œì¸') {
    document.getElementById('regCorpIndiv').checked = true;
  } else {
    document.getElementById('regCorpYes').checked = true;
  }
}

function setSelectVal(id, val) {
  var sel = document.getElementById(id);
  if (!sel) return;
  for (var i = 0; i < sel.options.length; i++) {
    if (sel.options[i].value === val || sel.options[i].text === val) {
      sel.selectedIndex = i;
      return;
    }
  }
}

// ============================================================
// ì—…ì²´ ì €ì¥ (ì‹ ê·œ ë“±ë¡) â€” salesMgmt.htmlê³¼ ë™ì¼í•œ êµ¬ì¡°
// ============================================================
async function saveCustomer() {
  // í•„ìˆ˜ê°’ ê²€ì¦
  var company = (document.getElementById('regCompany').value || '').trim();
  var repName = (document.getElementById('regRepName').value || '').trim();
  var bizNo = (document.getElementById('regBizNo').value || '').trim();
  if (!company) { toast('âš ï¸ íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regCompany').focus(); return; }
  if (!repName) { toast('âš ï¸ ëŒ€í‘œìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regRepName').focus(); return; }
  if (!bizNo) { toast('âš ï¸ ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regBizNo').focus(); return; }

  // ë°ì´í„° ìˆ˜ì§‘
  var gradeSel = document.getElementById('regGrade');
  var grade = gradeSel ? gradeSel.value : 'ë“±ê¸‰ ì„ íƒ';
  if (grade === 'ë“±ê¸‰ ì„ íƒ') grade = 'B';
  var statusSel = document.getElementById('regStatus');
  var status = statusSel ? statusSel.value : 'í™œë™';
  var salesRep = document.getElementById('regSalesRep');
  var salesRepVal = (salesRep && salesRep.value !== 'ì„ íƒ') ? salesRep.value : 'ì´ì£¼ì„';
  var contactName = (document.getElementById('regCName') || {}).value || '';

  var cust = {
    company: company,
    repName: repName,
    bizNo: bizNo,
    corpNo: (document.getElementById('regCorpNo') || {}).value || '',
    bizType: (document.getElementById('regBizType') || {}).value || '',
    bizItem: (document.getElementById('regBizItem') || {}).value || '',
    grade: grade,
    status: status,
    zipcode: (document.getElementById('regZipcode') || {}).value || '',
    addr1: (document.getElementById('regAddr1') || {}).value || '',
    addr2: (document.getElementById('regAddr2') || {}).value || '',
    companyEn: (document.getElementById('regCompanyNameEn') || {}).value || '',
    repNameEn: (document.getElementById('regRepNameEn') || {}).value || '',
    addrEn: (document.getElementById('regAddrEn') || {}).value || '',
    contactName: contactName,
    contactPhone: (document.getElementById('regCPhone') || {}).value || '',
    contactEmail: (document.getElementById('regCEmail') || {}).value || '',
    salesRep: salesRepVal,
    // ì¸í—ˆê°€ ì •ë³´ (ë‹¤ì¤‘ ì¹´ë“œ ì§€ì›)
    licenses: (function() {
      var licArr = [];
      var indices = getLicenseCardIndices();
      for (var li = 0; li < indices.length; li++) {
        var ix = indices[li];
        var lic = {
          licField: (document.getElementById('licField_' + ix) || {}).value || '',
          licBizForm: (document.getElementById('licBizForm_' + ix) || {}).value || '',
          licRepName: (document.getElementById('licRepName_' + ix) || {}).value || '',
          licNo: (document.getElementById('licNo_' + ix) || {}).value || '',
          licBizName: (document.getElementById('licBizName_' + ix) || {}).value || '',
          licZipcode: (document.getElementById('licZipcode_' + ix) || {}).value || '',
          licAddr: (document.getElementById('licAddr_' + ix) || {}).value || '',
          licAddr2: (document.getElementById('licAddr2_' + ix) || {}).value || '',
          licBizNameEn: (document.getElementById('licBizNameEn_' + ix) || {}).value || '',
          licRepNameEn: (document.getElementById('licRepNameEn_' + ix) || {}).value || '',
          licAddrEn: (document.getElementById('licAddrEn_' + ix) || {}).value || ''
        };
        // ìµœì†Œ 1ê°œ í•„ë“œë¼ë„ ê°’ì´ ìˆìœ¼ë©´ ì €ì¥
        var hasData = lic.licField !== 'ì„ íƒ' || lic.licBizForm !== 'ì„ íƒ' || lic.licRepName || lic.licNo || lic.licBizName;
        if (hasData) licArr.push(lic);
      }
      return licArr;
    })(),
    // í•˜ìœ„ í˜¸í™˜ì„±: ì²« ë²ˆì§¸ ì¸í—ˆê°€ ì •ë³´ë¥¼ ê¸°ì¡´ í•„ë“œì—ë„ ì €ì¥
    licField: (document.getElementById('licField_1') || {}).value || '',
    licBizForm: (document.getElementById('licBizForm_1') || {}).value || '',
    licRepName: (document.getElementById('licRepName_1') || {}).value || '',
    licNo: (document.getElementById('licNo_1') || {}).value || '',
    licBizName: (document.getElementById('licBizName_1') || {}).value || '',
    licZipcode: (document.getElementById('licZipcode_1') || {}).value || '',
    licAddr: (document.getElementById('licAddr_1') || {}).value || '',
    licAddr2: (document.getElementById('licAddr2_1') || {}).value || '',
    licBizNameEn: (document.getElementById('licBizNameEn_1') || {}).value || '',
    licRepNameEn: (document.getElementById('licRepNameEn_1') || {}).value || '',
    licAddrEn: (document.getElementById('licAddrEn_1') || {}).value || '',
    regDate: new Date().toISOString().slice(0, 10),
    changeLog: []
  };

  // Firestoreì— ì €ì¥
  try {
    await fsSaveCompany(cust);
    toast('âœ… ê³ ê°ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
    setTimeout(function() { showPage('customerList'); }, 1200);
  } catch(e) {
    toast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

// ============================================================
// ì—…ì²´ ìˆ˜ì •
// ============================================================
async function updateCompany() {
  if (!_currentId) return;
  var updated = collectFormData();
  if (!updated) return;

  var existing = await fsGetCompanyById(_currentId);
  if (!existing) { toast('ì—…ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }

  // ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©´ì„œ ì—…ë°ì´íŠ¸
  updated.id = _currentId;
  updated.regDate = existing.regDate || new Date().toISOString().slice(0, 10);
  updated.changeLog = existing.changeLog || [];
  updated.changeLog.push({
    date: new Date().toISOString().slice(0, 10),
    action: 'ìˆ˜ì •',
    detail: 'ì—…ì²´ ì •ë³´ ìˆ˜ì •'
  });
  // ë“±ê¸‰ ê³„ì‚° ê´€ë ¨ ê¸°ì¡´ê°’ ìœ ì§€
  updated.annualRevenue = existing.annualRevenue || 0;
  updated.monthlyFrequency = existing.monthlyFrequency || 0;
  updated.tradeDuration = existing.tradeDuration || 0;
  updated.trafficLight = existing.trafficLight || 'blue';

  try {
    await fsSaveCompany(updated);
    toast('ğŸ’¾ ì—…ì²´ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
    _editMode = false;
    setTimeout(function() { openDetail(_currentId); }, 800);
  } catch(e) {
    toast('âŒ ìˆ˜ì • ì‹¤íŒ¨: ' + e.message);
  }
}

// ============================================================
// í¼ ë°ì´í„° ìˆ˜ì§‘ (ë“±ë¡/ìˆ˜ì • ê³µí†µ)
// ============================================================
function collectFormData() {
  var company = (document.getElementById('regCompany').value || '').trim();
  var repName = (document.getElementById('regRepName').value || '').trim();
  var bizNo = (document.getElementById('regBizNo').value || '').trim();
  if (!company) { toast('âš ï¸ íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regCompany').focus(); return null; }
  if (!repName) { toast('âš ï¸ ëŒ€í‘œìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regRepName').focus(); return null; }
  if (!bizNo) { toast('âš ï¸ ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); document.getElementById('regBizNo').focus(); return null; }

  var gradeSel = document.getElementById('regGrade');
  var grade = gradeSel ? gradeSel.value : 'ë“±ê¸‰ ì„ íƒ';
  if (grade === 'ë“±ê¸‰ ì„ íƒ') grade = 'B';
  var statusSel = document.getElementById('regStatus');
  var status = statusSel ? statusSel.value : 'í™œë™';
  var salesRep = document.getElementById('regSalesRep');
  var salesRepVal = (salesRep && salesRep.value !== 'ì„ íƒ') ? salesRep.value : 'ì´ì£¼ì„';

  var cust = {
    company: company,
    repName: repName,
    bizNo: bizNo,
    corpType: document.getElementById('regCorpYes').checked ? 'ë²•ì¸' : 'ê°œì¸',
    corpNo: (document.getElementById('regCorpNo') || {}).value || '',
    bizType: (document.getElementById('regBizType') || {}).value || '',
    bizItem: (document.getElementById('regBizItem') || {}).value || '',
    grade: grade,
    status: status,
    zipcode: (document.getElementById('regZipcode') || {}).value || '',
    addr1: (document.getElementById('regAddr1') || {}).value || '',
    addr2: (document.getElementById('regAddr2') || {}).value || '',
    companyEn: (document.getElementById('regCompanyNameEn') || {}).value || '',
    repNameEn: (document.getElementById('regRepNameEn') || {}).value || '',
    addrEn: (document.getElementById('regAddrEn') || {}).value || '',
    contactName: (document.getElementById('regCName') || {}).value || '',
    contactPhone: (document.getElementById('regCPhone') || {}).value || '',
    contactEmail: (document.getElementById('regCEmail') || {}).value || '',
    salesRep: salesRepVal,
    department: (document.getElementById('regDepartment') || {}).value || '',
    receiptType: (document.getElementById('regReceiptType') || {}).value || '',
    annualRevenue: 0,
    monthlyFrequency: 0,
    tradeDuration: 0,
    // ì¸í—ˆê°€ ì •ë³´
    licenses: collectLicenses(),
    licField: (document.getElementById('licField_1') || {}).value || '',
    licBizForm: (document.getElementById('licBizForm_1') || {}).value || '',
    licRepName: (document.getElementById('licRepName_1') || {}).value || '',
    licNo: (document.getElementById('licNo_1') || {}).value || '',
    licBizName: (document.getElementById('licBizName_1') || {}).value || '',
    licZipcode: (document.getElementById('licZipcode_1') || {}).value || '',
    licAddr: (document.getElementById('licAddr_1') || {}).value || '',
    licAddr2: (document.getElementById('licAddr2_1') || {}).value || '',
    licBizNameEn: (document.getElementById('licBizNameEn_1') || {}).value || '',
    licRepNameEn: (document.getElementById('licRepNameEn_1') || {}).value || '',
    licAddrEn: (document.getElementById('licAddrEn_1') || {}).value || '',
    taxName: (document.getElementById('regTaxName') || {}).value || '',
    taxPhone: (document.getElementById('regTaxPhone') || {}).value || '',
    taxEmail: (document.getElementById('regTaxEmail') || {}).value || '',
    memo: (document.getElementById('regMemo') || {}).value || ''
  };
  return cust;
}

function collectLicenses() {
  var licArr = [];
  var indices = getLicenseCardIndices();
  for (var li = 0; li < indices.length; li++) {
    var ix = indices[li];
    var lic = {
      licField: (document.getElementById('licField_' + ix) || {}).value || '',
      licBizForm: (document.getElementById('licBizForm_' + ix) || {}).value || '',
      licRepName: (document.getElementById('licRepName_' + ix) || {}).value || '',
      licNo: (document.getElementById('licNo_' + ix) || {}).value || '',
      licBizName: (document.getElementById('licBizName_' + ix) || {}).value || '',
      licZipcode: (document.getElementById('licZipcode_' + ix) || {}).value || '',
      licAddr: (document.getElementById('licAddr_' + ix) || {}).value || '',
      licAddr2: (document.getElementById('licAddr2_' + ix) || {}).value || '',
      licBizNameEn: (document.getElementById('licBizNameEn_' + ix) || {}).value || '',
      licRepNameEn: (document.getElementById('licRepNameEn_' + ix) || {}).value || '',
      licAddrEn: (document.getElementById('licAddrEn_' + ix) || {}).value || ''
    };
    var hasData = lic.licField !== 'ì„ íƒ' || lic.licBizForm !== 'ì„ íƒ' || lic.licRepName || lic.licNo || lic.licBizName;
    if (hasData) licArr.push(lic);
  }
  return licArr;
}

// ============================================================
// ì‚­ì œ
// ============================================================
async function deleteCompany() {
  if (!_currentId) return;
  // ê¶Œí•œ ì²´í¬
  if (!checkDeletePermission()) {
    toast('â›” ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
    return;
  }
  // ëª¨ë‹¬ë¡œ í™•ì¸
  var nameEl = document.getElementById('detailCompanyName') || document.getElementById('dCompany');
  var companyName = nameEl ? nameEl.value || nameEl.textContent : '(ì•Œìˆ˜ì—†ìŒ)';
  document.getElementById('singleDelName').textContent = companyName;
  document.getElementById('singleDelProgress').style.display = 'none';
  document.getElementById('singleDelActions').style.display = 'flex';
  document.getElementById('singleDelConfirmBtn').disabled = false;
  document.getElementById('singleDeleteModal').style.display = 'flex';
}

function closeSingleDeleteModal() {
  document.getElementById('singleDeleteModal').style.display = 'none';
}

async function confirmSingleDelete() {
  if (!_currentId) return;
  document.getElementById('singleDelConfirmBtn').disabled = true;
  document.getElementById('singleDelActions').querySelector('.btn-secondary').disabled = true;
  document.getElementById('singleDelProgress').style.display = 'block';
  document.getElementById('singleDelProgressText').textContent = 'ì‚­ì œ ì¤‘...';
  try {
    // Storage íŒŒì¼ ì‚­ì œ
    try { await fsDeleteCompanyFiles(_currentId); } catch(e) { console.warn('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', e.message); }
    document.getElementById('singleDelProgressFill').style.width = '60%';
    // Firestore ë¬¸ì„œ ì‚­ì œ
    await fsDeleteCompany(_currentId);
    document.getElementById('singleDelProgressFill').style.width = '100%';
    closeSingleDeleteModal();
    toast('ğŸ—‘ï¸ ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    _currentId = null;
    _customersCache = null;
    setTimeout(function() { showPage('list'); loadList(); }, 500);
  } catch(e) {
    closeSingleDeleteModal();
    toast('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
  }
}

// ============================================================
// í¼ ì´ˆê¸°í™”
// ============================================================
function resetRegForm() {
  var inputs = document.querySelectorAll('#page-reg input:not([type=radio]):not([type=file]), #page-reg textarea');
  inputs.forEach(function(el) { el.value = ''; });
  var selects = document.querySelectorAll('#page-reg select');
  selects.forEach(function(el) { el.selectedIndex = 0; });
  document.getElementById('regCorpYes').checked = true;
  var chk = document.getElementById('compChk'); if(chk) chk.style.display = 'none';
  var bchk = document.getElementById('bizChk'); if(bchk) bchk.style.display = 'none';
  var cchk = document.getElementById('cntChk'); if(cchk) cchk.style.display = 'none';
  // ë“±ë¡ ë²„íŠ¼ ë³µì›
  var btnSave = document.getElementById('btnSave');
  if (btnSave) {
    btnSave.textContent = 'âœ… ì—…ì²´ ë“±ë¡';
    btnSave.setAttribute('onclick', 'saveCustomer()');
  }
}

// ============================================================
// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (salesMgmt.htmlê³¼ ë™ì¼)
// ============================================================
function fmtBiz(el) {
  var v = el.value.replace(/[^0-9]/g, '');
  if (v.length > 10) v = v.slice(0, 10);
  if (v.length > 5) v = v.slice(0, 3) + '-' + v.slice(3, 5) + '-' + v.slice(5);
  else if (v.length > 3) v = v.slice(0, 3) + '-' + v.slice(3);
  el.value = v;
}

function fmtPhone(el) {
  var v = el.value.replace(/[^0-9]/g, '');
  if (v.length > 11) v = v.slice(0, 11);
  if (v.length > 7) v = v.slice(0, 3) + '-' + v.slice(3, 7) + '-' + v.slice(7);
  else if (v.length > 3) v = v.slice(0, 3) + '-' + v.slice(3);
  el.value = v;
}

function openPostcodeSearch() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('regZipcode').value = data.zonecode;
      document.getElementById('regAddr1').value = data.roadAddress || data.jibunAddress;
      document.getElementById('regAddr2').value = '';
      document.getElementById('regAddr2').focus();
      // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
      setTimeout(function() { updateBizEngAddress(); }, 300);
    }
  }).open();
}

function openLicPostcodeSearch(idx, isDetail) {
  new daum.Postcode({
    oncomplete: function(data) {
      var prefix = isDetail ? 'detLicZipcode_' : 'licZipcode_';
      var addrPrefix = isDetail ? 'detLicAddr_' : 'licAddr_';
      var addr2Prefix = isDetail ? 'detLicAddr2_' : 'licAddr2_';
      var enPrefix = isDetail ? 'detLicAddrEn_' : 'licAddrEn_';

      document.getElementById(prefix + idx).value = data.zonecode;
      document.getElementById(addrPrefix + idx).value = data.roadAddress || data.jibunAddress;
      document.getElementById(addr2Prefix + idx).value = '';
      document.getElementById(addr2Prefix + idx).focus();
      // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
      var fullAddr = (data.roadAddress || data.jibunAddress || '').trim();
      convertToEnglishAddress(fullAddr, function(eng) {
        var enField = document.getElementById(enPrefix + idx);
        if (enField) {
          enField.value = eng;
          enField.style.background = '#e3f2fd';
          setTimeout(function() { enField.style.background = ''; }, 3000);
        }
      });
    }
  }).open();
}

function toggleEngSection(sectionId) {
  var sec = document.getElementById(sectionId);
  if (!sec) return;
  var isHidden = sec.style.display === 'none';
  sec.style.display = isHidden ? 'block' : 'none';
  var arrow = sec.previousElementSibling.querySelector('span');
  if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : '';
}

function demoCompanyDup() {
  const name = document.getElementById('regCompany').value.trim();
  if(!name){alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(name.includes('í’€ë¬´ì›')){document.getElementById('companyDup').classList.add('show');}
  else{const el=document.getElementById('compChk');el.style.display='block';el.className='check-result check-ok';el.textContent='âœ… ì¤‘ë³µ ì—†ìŒ â€” ë“±ë¡ ê°€ëŠ¥';}
}
function demoContactDup() {
  const name = document.getElementById('regCName').value.trim();
  if(!name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(name==='ì´ê·œì„±'){document.getElementById('contactDup').classList.add('show');}
  else{const el=document.getElementById('cntChk');el.style.display='inline-block';el.className='check-result check-ok';el.textContent='âœ… ì¤‘ë³µ ì—†ìŒ';}
}

// ============================================================
// ì¸í—ˆê°€ ì¹´ë“œ ì¶”ê°€/ì‚­ì œ (salesMgmt.htmlê³¼ ë™ì¼)
// ============================================================
function addLicenseCard() {
  _licenseCardCount++;
  var idx = _licenseCardCount;
  var area = document.getElementById('licenseArea');
  if (!area) return;

  var card = document.createElement('div');
  card.className = 'sub-card';
  card.id = 'licCard_' + idx;
  card.innerHTML =
    '<div class="sub-card-hd">' +
      '<div class="sub-card-title"><span class="sub-card-num">' + idx + '</span> ì¸í—ˆê°€</div>' +
      '<button type="button" class="btn btn-secondary btn-sm" onclick="removeLicenseCard(' + idx + ')" style="margin-left:auto;font-size:11px;padding:3px 10px;color:#c62828;border-color:#ef9a9a">âœ• ì‚­ì œ</button>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ë¶„ì•¼ <span class="req">*</span></label><select id="licField_' + idx + '"><option>ì„ íƒ</option><option>ì‹í’ˆ</option><option>ì¶•ì‚°</option></select></div>' +
      '<div class="fg"><label>ì˜ì—…ì˜ í˜•íƒœ <span class="req">*</span></label><div class="combo"><select id="licBizForm_' + idx + '"><option>ì„ íƒ</option><option>ì‹í’ˆì œì¡°ê°€ê³µì—…</option><option>ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</option><option>ì‹í’ˆì†Œë¶„ì—…</option><option>ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì¶•ì‚°ë¬¼ê°€ê³µì—…</option><option>ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</option><option value="etc">âœï¸ ì§ì ‘ ì…ë ¥</option></select></div></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ëŒ€í‘œì <span class="req">*</span></label><input id="licRepName_' + idx + '" placeholder="ì¸í—ˆê°€ ëŒ€í‘œì"></div>' +
      '<div class="fg"><label>ì¸í—ˆê°€ë²ˆí˜¸ <span class="req">*</span></label><input id="licNo_' + idx + '" placeholder="ì¸í—ˆê°€ë²ˆí˜¸"></div>' +
    '</div>' +
    '<div class="fg-row">' +
      '<div class="fg"><label>ì˜ì—…ì†Œëª…ì¹­ <span class="req">*</span></label><input id="licBizName_' + idx + '" placeholder="ì˜ì—…ì†Œ ëª…ì¹­"></div>' +
    '</div>' +
    '<div class="fg"><label>ì†Œì¬ì§€ <span class="req">*</span></label>' +
      '<div class="addr-row"><input id="licZipcode_' + idx + '" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px" readonly><button class="btn btn-secondary btn-sm" onclick="openLicPostcodeSearch(' + idx + ')">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div>' +
    '</div>' +
    '<div class="fg"><input id="licAddr_' + idx + '" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìë™ì…ë ¥)" readonly></div>' +
    '<div class="fg"><input id="licAddr2_' + idx + '" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"></div>' +
    '<div class="fg"><label>ì¸í—ˆê°€ ë¬¸ì„œ ì²¨ë¶€</label>' +
      '<div style="display:flex;gap:8px;align-items:center">' +
        '<div class="file-area" id="licFileArea_' + idx + '" style="flex:1;padding:10px;position:relative" onclick="document.getElementById(\'licFileInput_' + idx + '\').click()" ondragover="event.preventDefault();this.style.borderColor=\'#1a73e8\'" ondragleave="this.style.borderColor=\'#e2e6ed\'" ondrop="event.preventDefault();this.style.borderColor=\'#e2e6ed\';handleLicFile(' + idx + ',event.dataTransfer.files[0])">' +
          '<input type="file" id="licFileInput_' + idx + '" accept="image/*,.pdf" style="display:none" onchange="handleLicFile(' + idx + ',this.files[0])">' +
          '<span id="licFileName_' + idx + '">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span>' +
        '</div>' +
        '<button class="btn btn-check btn-sm" id="licOcrBtn_' + idx + '" onclick="runLicOCR(' + idx + ')" disabled style="white-space:nowrap">ğŸ¤– OCR ì¸ì‹</button>' +
      '</div>' +
      '<div id="licOcrStatus_' + idx + '" style="margin-top:4px;font-size:11px;color:#1565c0;display:none"></div>' +
    '</div>' +
    '<!-- ì¸í—ˆê°€ ì˜ë¬¸ ì •ë³´ (ì ‘ì´ì‹) -->' +
    '<div class="eng-toggle" onclick="toggleEngSection(\'licEngSection_' + idx + '\')" style="margin-top:8px;cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 0;color:#1565c0;font-size:13px;font-weight:500">' +
      '<span id="licEngArrow_' + idx + '" style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)' +
    '</div>' +
    '<div id="licEngSection_' + idx + '" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">' +
      '<div class="fg"><label>Business Name (EN)</label><input id="licBizNameEn_' + idx + '" placeholder="Business name in English"></div>' +
      '<div class="fg"><label>Representative (EN)</label><input id="licRepNameEn_' + idx + '" placeholder="Representative name in English"></div>' +
      '<div class="fg"><label>Address (EN)</label><input id="licAddrEn_' + idx + '" placeholder="Address in English (auto-converted)"></div>' +
    '</div>';

  area.appendChild(card);

  // ìƒˆ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  card.style.animation = 'fadeIn 0.3s ease';

  toast('âœ… ì¸í—ˆê°€ ' + idx + ' ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function removeLicenseCard(idx) {
  var card = document.getElementById('licCard_' + idx);
  if (!card) return;
  if (!confirm('ì¸í—ˆê°€ ' + idx + ' ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  card.remove();
  delete _licFiles[idx];
  toast('ğŸ—‘ï¸ ì¸í—ˆê°€ ' + idx + ' ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function getLicenseCardIndices() {
  var indices = [];
  for (var i = 1; i <= _licenseCardCount; i++) {
    if (document.getElementById('licCard_' + i)) indices.push(i);
  }
  return indices;
}

// ============================================================
// OCR: Naver Clova Document OCR (salesMgmt.htmlê³¼ ì™„ì „ ë™ì¼)
// ============================================================
// OCR í”„ë¡ì‹œ ì„œë²„ URL (ocr_proxy.py â€” CORS ìš°íšŒ + Secret Key ì„œë²„ ë³´ê´€)
// HTTPS: Mixed Content ë°©ì§€ (GitHub Pages ë“± HTTPS í˜ì´ì§€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
// ìì²´ì„œëª… ì¸ì¦ì„œ ì‚¬ìš© â€” ìµœì´ˆ ì ‘ì† ì‹œ ë¸Œë¼ìš°ì €ì—ì„œ ì¸ì¦ì„œ ì‹ ë¢° í•„ìš”
var OCR_PROXY_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
  ? 'https://127.0.0.1:5002'
  : '/ocr';
var OCR_BIZ_LICENSE_URL = OCR_PROXY_BASE + '/api/ocr/biz-license';
var OCR_GENERAL_URL = OCR_PROXY_BASE + '/api/ocr/general';

var _licFiles = {};

// --- PDF â†’ JPEG ì´ë¯¸ì§€ ë³€í™˜ (Clova íŠ¹í™”ëª¨ë¸ì€ ë‹¤ì¤‘í˜ì´ì§€ PDF ë¯¸ì§€ì›) ---
// PDF íŒŒì¼ì´ë©´ ì²« í˜ì´ì§€ë¥¼ canvasë¡œ ë Œë”ë§ â†’ JPEG base64ë¡œ ë³€í™˜
function convertPdfToJpegBase64(file) {
  return new Promise(function(resolve, reject) {
    var ext = file.name.split('.').pop().toLowerCase();
    if (ext !== 'pdf') {
      // PDFê°€ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ FileReaderë¡œ ì½ê¸°
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64 = e.target.result.split(',')[1];
        if (ext === 'jpg' || ext === 'jpeg') ext = 'jpg';
        else if (ext === 'png') ext = 'png';
        else ext = 'jpg';
        resolve({ base64: base64, format: ext });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
      return;
    }
    // PDF â†’ ì´ë¯¸ì§€ ë³€í™˜
    if (!window.pdfjsLib) {
      reject(new Error('PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨'));
      return;
    }
    var reader2 = new FileReader();
    reader2.onload = function(e) {
      var typedArray = new Uint8Array(e.target.result);
      pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
        // ì²« í˜ì´ì§€ë§Œ ë Œë”ë§
        pdf.getPage(1).then(function(page) {
          var scale = 2.0; // ê³ í•´ìƒë„
          var viewport = page.getViewport({ scale: scale });
          var canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          var ctx = canvas.getContext('2d');
          page.render({ canvasContext: ctx, viewport: viewport }).promise.then(function() {
            var jpegBase64 = canvas.toDataURL('image/jpeg', 0.92).split(',')[1];
            resolve({ base64: jpegBase64, format: 'jpg' });
          }).catch(reject);
        }).catch(reject);
      }).catch(reject);
    };
    reader2.onerror = reject;
    reader2.readAsArrayBuffer(file);
  });
}

// --- OCR í”„ë¡ì‹œ SSL ì¸ì¦ì„œ ì‹ ë¢° í™•ì¸ ---
// ìì²´ì„œëª… ì¸ì¦ì„œì´ë¯€ë¡œ ìµœì´ˆ 1íšŒ ë¸Œë¼ìš°ì €ì—ì„œ ìˆ˜ë½ í•„ìš”
function handleOcrFetchError(err, statusEl, btnEl) {
  if (btnEl) { btnEl.textContent = 'ğŸ¤– OCR ì¸ì‹'; btnEl.disabled = false; }
  if (err.message === 'Failed to fetch') {
    // Mixed Content ë˜ëŠ” ìì²´ì„œëª… ì¸ì¦ì„œ ë¯¸ì‹ ë¢°
    var healthUrl = OCR_PROXY_BASE + '/api/ocr/health';
    if (statusEl) {
      statusEl.innerHTML = 'âŒ OCR ì„œë²„ ì—°ê²° ì‹¤íŒ¨. <a href="' + healthUrl + '" target="_blank" style="color:#1565c0;text-decoration:underline;">ì—¬ê¸°ë¥¼ í´ë¦­</a>í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìˆ˜ë½í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
      statusEl.style.color = '#c62828';
    }
    toast('âŒ OCR ì„œë²„ ì—°ê²° ì‹¤íŒ¨ â€” ì¸ì¦ì„œ ìˆ˜ë½ì´ í•„ìš”í•©ë‹ˆë‹¤');
    // ìë™ìœ¼ë¡œ ìƒˆ íƒ­ì—ì„œ ì¸ì¦ì„œ ìˆ˜ë½ í˜ì´ì§€ ì—´ê¸°
    window.open(healthUrl, '_blank');
  } else {
    if (statusEl) {
      statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + err.message;
      statusEl.style.color = '#c62828';
    }
    toast('âŒ OCR ì‹¤íŒ¨: ' + err.message);
  }
}

// --- ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼ ì„ íƒ ---
function handleBizLicFile(file) {
  if (!file) return;
  _bizLicFile = file;
  document.getElementById('bizLicFileName').textContent = 'ğŸ“„ ' + file.name + ' (' + (file.size/1024).toFixed(0) + 'KB)';
  document.getElementById('bizLicOcrBtn').disabled = false;
  // ë¯¸ë¦¬ë³´ê¸°
  if (file.type.startsWith('image/')) {
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('bizLicPreviewImg').src = e.target.result;
      document.getElementById('bizLicPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    document.getElementById('bizLicPreview').style.display = 'none';
  }
}

// --- ì‚¬ì—…ìë“±ë¡ì¦ OCR ì‹¤í–‰ ---
function runBizLicOCR() {
  if (!_bizLicFile) { toast('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  var btn = document.getElementById('bizLicOcrBtn');
  var status = document.getElementById('bizLicOcrStatus');
  btn.disabled = true;
  btn.textContent = 'â³ ì¸ì‹ ì¤‘...';
  status.style.display = 'block';
  status.textContent = 'ğŸ”„ Clova OCR ì„œë²„ì— ì „ì†¡ ì¤‘...';
  status.style.color = '#558b2f';

  // PDF â†’ ì´ë¯¸ì§€ ìë™ ë³€í™˜ í›„ OCR ì „ì†¡
  convertPdfToJpegBase64(_bizLicFile).then(function(result) {
    var payload = {
      version: 'V2',
      requestId: 'bfl-biz-' + Date.now(),
      timestamp: Date.now(),
      images: [{ format: result.format, name: _bizLicFile.name, data: result.base64 }]
    };

    fetch(OCR_BIZ_LICENSE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(function(data) {
      btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
      btn.disabled = false;
      if (data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result) {
        var res = data.images[0].bizLicense.result;
        fillBizLicFields(res);
        status.textContent = 'âœ… OCR ì¸ì‹ ì™„ë£Œ! í•„ë“œê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
        status.style.color = '#2e7d32';
        toast('âœ… ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¸ì‹ ì™„ë£Œ');
      } else {
        status.textContent = 'âš ï¸ OCR ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‘ë‹µ: ' + JSON.stringify(data).substring(0, 200);
        status.style.color = '#e65100';
      }
    })
    .catch(function(err) {
      handleOcrFetchError(err, status, btn);
    });
  }).catch(function(err) {
    btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
    btn.disabled = false;
    status.textContent = 'âŒ PDF ë³€í™˜ ì‹¤íŒ¨: ' + err.message;
    status.style.color = '#c62828';
  });
}

// --- ì‚¬ì—…ìë“±ë¡ì¦ OCR ê²°ê³¼ â†’ í¼ ìë™ì…ë ¥ ---
function fillBizLicFields(res) {
  function getText(arr) {
    if (!arr || !arr.length) return '';
    return arr.map(function(item) { return item.text || ''; }).join(' ').trim();
  }
  function getUniqueText(arr) {
    if (!arr || !arr.length) return '';
    var seen = {};
    var result = [];
    arr.forEach(function(item) {
      var t = (item.text || '').trim();
      if (t && !seen[t]) { seen[t] = true; result.push(t); }
    });
    return result.join(', ');
  }
  // íšŒì‚¬ëª… (ê°œì¸: companyName, ë²•ì¸: corpName)
  var companyName = getText(res.companyName) || getText(res.corpName);
  if (companyName) document.getElementById('regCompany').value = companyName;
  // ëŒ€í‘œìëª…
  var repName = getText(res.repName);
  if (repName) document.getElementById('regRepName').value = repName;
  // ì‚¬ì—…ìë²ˆí˜¸ (ê°œì¸: bisNo, ë²•ì¸: registerNumber)
  var bisNo = getText(res.bisNo) || getText(res.registerNumber);
  if (bisNo) {
    var el = document.getElementById('regBizNo');
    el.value = bisNo.replace(/\s/g, '');
    fmtBiz(el);
  }
  // ë²•ì¸ë²ˆí˜¸ (ê°œì¸: corpNo, ë²•ì¸: corpRegisterNum)
  var corpNo = getText(res.corpNo) || getText(res.corpRegisterNum);
  if (corpNo) document.getElementById('regCorpNo').value = corpNo.replace(/\s/g, '');
  // ì—…íƒœ (ì¤‘ë³µ ì œê±°)
  var bisType = getUniqueText(res.bisType);
  if (bisType) document.getElementById('regBizType').value = bisType;
  // ì¢…ëª© (ì¤‘ë³µ ì œê±°)
  var bisItem = getUniqueText(res.bisItem);
  if (bisItem) document.getElementById('regBizItem').value = bisItem;
  // ì£¼ì†Œ (bisAddress ë˜ëŠ” headAddress) + ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ
  var bisAddr = getText(res.bisAddress) || getText(res.headAddress);
  if (bisAddr) {
    document.getElementById('regAddr1').value = bisAddr;
    lookupZipcodeFromAddress(bisAddr);
  }
  // ë²•ì¸/ê°œì¸ íŒë‹¨
  if (corpNo) {
    document.getElementById('regCorpYes').checked = true;
  } else {
    document.getElementById('regCorpIndiv').checked = true;
  }
  // OCRë¡œ ì±„ì›Œì§„ í•„ë“œì— í•˜ì´ë¼ì´íŠ¸
  ['regCompany','regRepName','regBizNo','regCorpNo','regBizType','regBizItem','regAddr1'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el && el.value) {
      el.style.background = '#e8f5e9';
      el.style.borderColor = '#66bb6a';
      setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
    }
  });
  // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
  if (bisAddr) {
    setTimeout(function() { updateBizEngAddress(); }, 500);
  }
}

// --- ì¸í—ˆê°€ ë¬¸ì„œ íŒŒì¼ ì„ íƒ ---
function handleLicFile(idx, file) {
  if (!file) return;
  _licFiles[idx] = file;
  document.getElementById('licFileName_' + idx).textContent = 'ğŸ“„ ' + file.name + ' (' + (file.size/1024).toFixed(0) + 'KB)';
  document.getElementById('licOcrBtn_' + idx).disabled = false;
}

// --- ì¸í—ˆê°€ ë¬¸ì„œ OCR ì‹¤í–‰ (biz-license ì—”ë“œí¬ì¸íŠ¸ ê³µìš© â€” ì˜ì—…ì‹ ê³ ì¦ ë“±ë„ ì²˜ë¦¬ ê°€ëŠ¥) ---
function runLicOCR(idx) {
  var file = _licFiles[idx];
  if (!file) { toast('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
  var btn = document.getElementById('licOcrBtn_' + idx);
  var status = document.getElementById('licOcrStatus_' + idx);
  btn.disabled = true;
  btn.textContent = 'â³ ì¸ì‹ ì¤‘...';
  status.style.display = 'block';
  status.textContent = 'ğŸ”„ Clova OCR ì„œë²„ì— ì „ì†¡ ì¤‘...';

  // PDF â†’ ì´ë¯¸ì§€ ìë™ ë³€í™˜ í›„ OCR ì „ì†¡
  convertPdfToJpegBase64(file).then(function(result) {
    var payload = {
      version: 'V2',
      requestId: 'bfl-lic-' + Date.now(),
      timestamp: Date.now(),
      images: [{ format: result.format, name: file.name, data: result.base64 }]
    };

    // biz-license ì—”ë“œí¬ì¸íŠ¸ë¥¼ ê³µìš©ìœ¼ë¡œ ì‚¬ìš© (ì˜ì—…ì‹ ê³ ì¦, ì‚¬ì—…ìë“±ë¡ì¦ ë“± ëª¨ë“  ë¬¸ì„œ ì²˜ë¦¬)
    fetch(OCR_BIZ_LICENSE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    .then(function(data) {
      btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
      btn.disabled = false;
      if (data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result) {
        var res = data.images[0].bizLicense.result;
        fillLicFields(idx, res);
        var docType = (res.documentType && res.documentType.length) ? res.documentType[0].text : 'ë¬¸ì„œ';
        status.textContent = 'âœ… OCR ì¸ì‹ ì™„ë£Œ! (' + docType + ') í•„ë“œê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
        status.style.color = '#2e7d32';
        toast('âœ… ì¸í—ˆê°€ ë¬¸ì„œ OCR ì¸ì‹ ì™„ë£Œ (' + docType + ')');
      } else {
        status.textContent = 'âš ï¸ OCR ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        status.style.color = '#e65100';
      }
    })
    .catch(function(err) {
      handleOcrFetchError(err, status, btn);
    });
  }).catch(function(err) {
    btn.textContent = 'ğŸ¤– OCR ì¸ì‹';
    btn.disabled = false;
    status.textContent = 'âŒ PDF ë³€í™˜ ì‹¤íŒ¨: ' + err.message;
    status.style.color = '#c62828';
  });
}

// --- ì¸í—ˆê°€ ë¬¸ì„œ OCR ê²°ê³¼ â†’ í¼ ìë™ì…ë ¥ (biz-license êµ¬ì¡°í™” ì‘ë‹µ) ---
// Clova Document OCRì€ ì˜ì—…ì‹ ê³ ì¦ ë“±ë„ ì‚¬ì—…ìë“±ë¡ì¦ ëª¨ë¸ë¡œ ì²˜ë¦¬ ê°€ëŠ¥.
// ì‘ë‹µ í•„ë“œ: companyName(ì˜ì—…ì†Œëª…), corpName(ë²•ì¸ëª…), registerNumber(ì¸í—ˆê°€ë²ˆí˜¸),
//           repName(ëŒ€í‘œì), bisAddress(ì†Œì¬ì§€), bisType(ì—…íƒœ), bisItem(ì¢…ëª©),
//           documentType(ë¬¸ì„œìœ í˜•: "ì˜ì—…ì‹ ê³ ì¦" ë“±)
function fillLicFields(idx, res) {
  // getText: biz-license ì‘ë‹µì˜ ë°°ì—´ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì‚¬ì—…ìë“±ë¡ì¦ OCRê³¼ ë™ì¼ êµ¬ì¡°)
  function getText(arr) {
    if (!arr || !arr.length) return '';
    return arr.map(function(item) { return item.text || ''; }).join(' ').trim();
  }
  function getUniqueText(arr) {
    if (!arr || !arr.length) return '';
    var seen = {};
    var result = [];
    arr.forEach(function(item) {
      var t = (item.text || '').trim();
      if (t && !seen[t]) { seen[t] = true; result.push(t); }
    });
    return result.join(', ');
  }

  // ì¸í—ˆê°€ë²ˆí˜¸: registerNumber (ì˜ˆ: "ì œ 2024-0109313í˜¸")
  var licNo = getText(res.registerNumber);
  if (licNo) document.getElementById('licNo_' + idx).value = licNo;

  // ëŒ€í‘œì
  var repName = getText(res.repName);
  if (repName) document.getElementById('licRepName_' + idx).value = repName;

  // ì˜ì—…ì†Œëª…ì¹­: companyName (ê°œì¸/ì˜ì—…ì†Œëª…), corpName ì€ ë²•ì¸ëª…
  var bizName = getText(res.companyName) || getText(res.corpName);
  if (bizName) document.getElementById('licBizName_' + idx).value = bizName;

  // ì†Œì¬ì§€ â†’ ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ (headAddressëŠ” ë²•ì¸ì£¼ì†Œì´ë¯€ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
  var addr = getText(res.bisAddress);
  if (addr) {
    document.getElementById('licAddr_' + idx).value = addr;
    lookupLicZipcodeFromAddress(idx, addr);
  }

  // ì˜ì—…ì˜ í˜•íƒœ: bisType ë˜ëŠ” bisItem
  var bizForm = getUniqueText(res.bisType) || getUniqueText(res.bisItem);
  if (bizForm) {
    var sel = document.getElementById('licBizForm_' + idx);
    var matched = false;
    // íŠ¹ìˆ˜ë¬¸ì(Â·, ì¤‘ì , ê³µë°±) ì œê±° í›„ ë¹„êµ â€” OCRì€ "ì¦‰ì„íŒë§¤ì œì¡°Â·ê°€ê³µì—…", ì…€ë ‰íŠ¸ëŠ” "ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…"
    var normalize = function(s) { return s.replace(/[Â·\s\-Â·â€§ãƒ»]/g, ''); };
    var normBiz = normalize(bizForm);
    for (var j = 0; j < sel.options.length; j++) {
      var normOpt = normalize(sel.options[j].text);
      if (normOpt && (normOpt.includes(normBiz) || normBiz.includes(normOpt))) {
        sel.selectedIndex = j;
        matched = true;
        break;
      }
    }
    if (!matched) {
      var opt = document.createElement('option');
      opt.value = bizForm;
      opt.textContent = bizForm + ' (OCR)';
      opt.selected = true;
      sel.appendChild(opt);
    }
  }

  // ë¶„ì•¼ ìë™ ì„¤ì •: ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²• â†’ 'ì¶•ì‚°', ì‹í’ˆìœ„ìƒë²• â†’ 'ì‹í’ˆ'
  // ê·¼ê±°: ì‹í’ˆìœ„ìƒë²•=ì‹í’ˆ, ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²•=ì¶•ì‚°
  var allText = [bizForm, bizName, getText(res.documentType)].join(' ');
  var fieldSel = document.getElementById('licField_' + idx);
  if (fieldSel && fieldSel.value === 'ì„ íƒ') {
    var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
    for (var k = 0; k < fieldSel.options.length; k++) {
      if ((isLivestock && fieldSel.options[k].text === 'ì¶•ì‚°') ||
          (!isLivestock && fieldSel.options[k].text === 'ì‹í’ˆ')) {
        fieldSel.selectedIndex = k;
        break;
      }
    }
  }

  // í•˜ì´ë¼ì´íŠ¸
  ['licNo_','licRepName_','licBizName_','licAddr_','licZipcode_','licBizForm_','licField_'].forEach(function(prefix) {
    var el = document.getElementById(prefix + idx);
    if (el && (el.value || (el.tagName === 'SELECT' && el.selectedIndex > 0))) {
      el.style.background = '#e3f2fd';
      el.style.borderColor = '#42a5f5';
      setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
    }
  });
  // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
  if (addr) {
    setTimeout(function() { updateLicEngAddress(idx); }, 500);
  }
}

// ============================================================
// ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ (OCR ì£¼ì†Œ â†’ Kakao API)
// ============================================================
function lookupZipcodeFromAddress(address) {
  if (!address) return;
  // ê´„í˜¸ ì•ˆ ë‚´ìš© ì œê±° (ë™ëª… ë“±)
  var cleanAddr = address.replace(/\([^)]*\)/g, '').trim();
  // ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬: ë²ˆì§€/ê±´ë¬¼ë²ˆí˜¸ ë’¤ì˜ ì¸µ/í˜¸ ë“±
  var mainAddr = cleanAddr;
  var detailAddr = '';
  // 1) ì‰¼í‘œ êµ¬ë¶„
  var detailMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s*[,]\s*(.+)$/);
  if (detailMatch) {
    mainAddr = detailMatch[1].trim();
    detailAddr = detailMatch[2].trim();
  } else {
    // 2) ì‰¼í‘œ ì—†ì´ ê±´ë¬¼ë²ˆí˜¸ ë’¤ì˜ "Nì¸µ" ë“± ë¶„ë¦¬
    var spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(\d+ì¸µ.*)$/);
    if (!spaceMatch) spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(.+ì¸µ.*)$/);
    if (spaceMatch) {
      mainAddr = spaceMatch[1].trim();
      detailAddr = spaceMatch[2].trim();
    }
  }
  // Kakao ì£¼ì†Œê²€ìƒ‰ REST API
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(mainAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      if (roadAddr && roadAddr.zone_no) {
        document.getElementById('regZipcode').value = roadAddr.zone_no;
        document.getElementById('regAddr1').value = roadAddr.address_name;
        if (detailAddr) document.getElementById('regAddr2').value = detailAddr;
        highlightField('regZipcode');
        highlightField('regAddr1');
        setTimeout(updateBizEngAddress, 300);
      } else if (doc.address) {
        document.getElementById('regAddr1').value = doc.address.address_name;
        if (detailAddr) document.getElementById('regAddr2').value = detailAddr;
        setTimeout(updateBizEngAddress, 300);
      }
    }
  })
  .catch(function(e) { console.log('ìš°í¸ë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

function highlightField(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.style.background = '#e8f5e9';
  el.style.borderColor = '#66bb6a';
  setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
}

// --- ì¸í—ˆê°€ ì†Œì¬ì§€: OCR ì£¼ì†Œì—ì„œ ìš°í¸ë²ˆí˜¸ ìë™ ì¡°íšŒ ---
function lookupLicZipcodeFromAddress(idx, address) {
  if (!address) return;
  var cleanAddr = address.replace(/\([^)]*\)/g, '').trim();
  var mainAddr = cleanAddr;
  var detailAddr = '';
  // 1) ì‰¼í‘œ êµ¬ë¶„
  var detailMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s*[,]\s*(.+)$/);
  if (detailMatch) {
    mainAddr = detailMatch[1].trim();
    var candidate = detailMatch[2].trim();
    if (!/^\d|^[ê°€-í£]{1,2}(íŠ¹ë³„|ê´‘ì—­)?ì‹œ|^[ê°€-í£]{1,2}(ë„)\s|^ê²½ê¸°|^ì¶©[ë¶ë‚¨]|^ì „[ë¶ë‚¨]|^ê²½[ë¶ë‚¨]|^ê°•ì›|^ì œì£¼|^ì„¸ì¢…/.test(candidate)) {
      detailAddr = candidate;
    }
  } else {
    // 2) ì‰¼í‘œ ì—†ì´ ê±´ë¬¼ë²ˆí˜¸ ë’¤ì˜ "Nì¸µ" ë“± ë¶„ë¦¬
    var spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(\d+ì¸µ.*)$/);
    if (!spaceMatch) spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(.+ì¸µ.*)$/);
    if (spaceMatch) {
      mainAddr = spaceMatch[1].trim();
      detailAddr = spaceMatch[2].trim();
    }
  }
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(mainAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      if (roadAddr && roadAddr.zone_no) {
        document.getElementById('licZipcode_' + idx).value = roadAddr.zone_no;
        document.getElementById('licAddr_' + idx).value = roadAddr.address_name;
        if (detailAddr) document.getElementById('licAddr2_' + idx).value = detailAddr;
        highlightField('licZipcode_' + idx);
        highlightField('licAddr_' + idx);
        setTimeout(function() { updateLicEngAddress(idx); }, 300);
      } else if (doc.address) {
        document.getElementById('licAddr_' + idx).value = doc.address.address_name;
        if (detailAddr) document.getElementById('licAddr2_' + idx).value = detailAddr;
        setTimeout(function() { updateLicEngAddress(idx); }, 300);
      }
    }
  })
  .catch(function(e) { console.log('ì¸í—ˆê°€ ìš°í¸ë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

// ============================================================
// í•œê¸€ ì£¼ì†Œ â†’ ì˜ë¬¸ ì£¼ì†Œ ë³€í™˜ (Juso.go.kr ê³µì‹ API)
// ============================================================
var KR_EN_REGION = {
  'ì„œìš¸íŠ¹ë³„ì‹œ':'Seoul','ì„œìš¸':'Seoul','ë¶€ì‚°ê´‘ì—­ì‹œ':'Busan','ë¶€ì‚°':'Busan',
  'ëŒ€êµ¬ê´‘ì—­ì‹œ':'Daegu','ëŒ€êµ¬':'Daegu','ì¸ì²œê´‘ì—­ì‹œ':'Incheon','ì¸ì²œ':'Incheon',
  'ê´‘ì£¼ê´‘ì—­ì‹œ':'Gwangju','ê´‘ì£¼':'Gwangju','ëŒ€ì „ê´‘ì—­ì‹œ':'Daejeon','ëŒ€ì „':'Daejeon',
  'ìš¸ì‚°ê´‘ì—­ì‹œ':'Ulsan','ìš¸ì‚°':'Ulsan','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':'Sejong','ì„¸ì¢…':'Sejong',
  'ê²½ê¸°ë„':'Gyeonggi-do','ê²½ê¸°':'Gyeonggi-do','ê°•ì›íŠ¹ë³„ìì¹˜ë„':'Gangwon-do','ê°•ì›ë„':'Gangwon-do','ê°•ì›':'Gangwon-do',
  'ì¶©ì²­ë¶ë„':'Chungcheongbuk-do','ì¶©ë¶':'Chungcheongbuk-do',
  'ì¶©ì²­ë‚¨ë„':'Chungcheongnam-do','ì¶©ë‚¨':'Chungcheongnam-do',
  'ì „ë¶íŠ¹ë³„ìì¹˜ë„':'Jeollabuk-do','ì „ë¼ë¶ë„':'Jeollabuk-do','ì „ë¶':'Jeollabuk-do',
  'ì „ë¼ë‚¨ë„':'Jeollanam-do','ì „ë‚¨':'Jeollanam-do',
  'ê²½ìƒë¶ë„':'Gyeongsangbuk-do','ê²½ë¶':'Gyeongsangbuk-do',
  'ê²½ìƒë‚¨ë„':'Gyeongsangnam-do','ê²½ë‚¨':'Gyeongsangnam-do',
  'ì œì£¼íŠ¹ë³„ìì¹˜ë„':'Jeju-do','ì œì£¼ë„':'Jeju-do','ì œì£¼':'Jeju-do'
};

// í•œê¸€ â†’ ì˜ë¬¸ ë„ë¡œëª…ì£¼ì†Œ ë³€í™˜
function convertToEnglishAddress(korAddr, callback) {
  if (!korAddr) { callback(''); return; }
  var cleanAddr = korAddr.replace(/\([^)]*\)/g, '').trim();
  // Juso.go.kr ì˜ë¬¸ì£¼ì†Œ ê²€ìƒ‰ API (í–‰ì •ì•ˆì „ë¶€ ê³µì‹)
  var jusoKey = 'U01TX0FVVEgyMDI2MDIxOTE2MDczMDExNzYyNDM=';
  var jusoUrl = 'https://business.juso.go.kr/addrlink/addrEngApi.do?confmKey=' + encodeURIComponent(jusoKey)
    + '&currentPage=1&countPerPage=1&keyword=' + encodeURIComponent(cleanAddr) + '&resultType=json';

  fetch(jusoUrl)
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var res = data.results;
    if (res && res.juso && res.juso.length > 0) {
      // ê³µì‹ ì˜ë¬¸ ë„ë¡œëª…ì£¼ì†Œ ì‚¬ìš©
      callback(res.juso[0].roadAddr);
    } else {
      // ê²°ê³¼ ì—†ìŒ â†’ ìì²´ ë¡œë§ˆì ë³€í™˜ í´ë°±
      var fallbackParts = cleanAddr.split(/\s+/);
      var engParts = [];
      for (var fp = 0; fp < fallbackParts.length; fp++) {
        var w = fallbackParts[fp];
        engParts.push(KR_EN_REGION[w] || romanize(w));
      }
      callback(engParts.reverse().join(', '));
    }
  })
  .catch(function() {
    // API ì˜¤ë¥˜ ì‹œ ìì²´ ë¡œë§ˆì ë³€í™˜ í´ë°±
    var fallbackParts = cleanAddr.split(/\s+/);
    var engParts = [];
    for (var fp = 0; fp < fallbackParts.length; fp++) {
      var w = fallbackParts[fp];
      engParts.push(KR_EN_REGION[w] || romanize(w));
    }
    callback(engParts.reverse().join(', '));
  });
}

// ê°„ì´ í•œê¸€ â†’ ë¡œë§ˆì ë³€í™˜ (í–‰ì •êµ¬ì—­ ì ‘ë¯¸ì‚¬ í¬í•¨)
function romanize(str) {
  if (!str) return '';
  // í–‰ì •êµ¬ì—­ ì ‘ë¯¸ì‚¬ ë³€í™˜
  str = str.replace(/íŠ¹ë³„ìì¹˜ì‹œ$/, '').replace(/íŠ¹ë³„ìì¹˜ë„$/, '-do')
           .replace(/íŠ¹ë³„ì‹œ$/, '').replace(/ê´‘ì—­ì‹œ$/, '')
           .replace(/(\S)ì‹œ$/, '$1-si').replace(/(\S)êµ°$/, '$1-gun').replace(/(\S)êµ¬$/, '$1-gu')
           .replace(/(\S)ì$/, '$1-eup').replace(/(\S)ë©´$/, '$1-myeon').replace(/(\S)ë™$/, '$1-dong')
           .replace(/(\S)ë¡œ$/, '$1-ro').replace(/(\S)ê¸¸$/, '$1-gil')
           .replace(/(\S)ë¦¬$/, '$1-ri').replace(/(\S)ê°€$/, '$1-ga');
  // ì´ˆì„±+ì¤‘ì„±+ì¢…ì„± â†’ ë¡œë§ˆì (Revised Romanization)
  var initials = ['g','kk','n','d','tt','r','m','b','pp','s','ss','','j','jj','ch','k','t','p','h'];
  var medials = ['a','ae','ya','yae','eo','e','yeo','ye','o','wa','wae','oe','yo','u','wo','we','wi','yu','eu','ui','i'];
  var finals = ['','g','kk','gs','n','nj','nh','d','l','lg','lm','lb','ls','lt','lp','lh','m','b','bs','s','ss','ng','j','ch','k','t','p','h'];
  var finBeforeConsonant = ['','k','kk','k','n','n','n','t','l','l','l','l','l','l','l','l','m','p','p','t','t','ng','t','t','k','t','p','t'];
  var syllables = [];
  for (var i = 0; i < str.length; i++) {
    var code = str.charCodeAt(i);
    if (code >= 0xAC00 && code <= 0xD7A3) {
      var offset = code - 0xAC00;
      syllables.push({
        ini: Math.floor(offset / (21 * 28)),
        med: Math.floor((offset % (21 * 28)) / 28),
        fin: offset % 28,
        isKor: true
      });
    } else {
      syllables.push({ ch: str.charAt(i), isKor: false });
    }
  }
  var result = '';
  for (var i = 0; i < syllables.length; i++) {
    var s = syllables[i];
    if (!s.isKor) { result += s.ch; continue; }
    result += initials[s.ini] + medials[s.med];
    if (s.fin === 0) continue;
    var next = (i + 1 < syllables.length) ? syllables[i + 1] : null;
    if (next && next.isKor) {
      if (next.ini === 11) {
        result += finals[s.fin];
      } else {
        result += finBeforeConsonant[s.fin];
      }
    } else {
      result += finBeforeConsonant[s.fin];
    }
  }
  return result.charAt(0).toUpperCase() + result.slice(1);
}

// ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜ íŠ¸ë¦¬ê±° (ì‚¬ì—…ìë“±ë¡ì¦)
function updateBizEngAddress() {
  var addr1 = document.getElementById('regAddr1');
  var addr2 = document.getElementById('regAddr2');
  var enField = document.getElementById('regAddrEn');
  if (!addr1 || !enField) return;
  var fullAddr = (addr1.value || '').trim();
  if (addr2 && addr2.value) fullAddr += ' ' + addr2.value.trim();
  if (!fullAddr) return;
  convertToEnglishAddress(fullAddr, function(engAddr) {
    enField.value = engAddr;
    enField.style.background = '#e3f2fd';
    setTimeout(function() { enField.style.background = ''; }, 3000);
  });
}

// ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜ íŠ¸ë¦¬ê±° (ì¸í—ˆê°€)
function updateLicEngAddress(idx) {
  var addr1 = document.getElementById('licAddr_' + idx);
  var addr2 = document.getElementById('licAddr2_' + idx);
  var enField = document.getElementById('licAddrEn_' + idx);
  if (!addr1 || !enField) return;
  var fullAddr = (addr1.value || '').trim();
  if (addr2 && addr2.value) fullAddr += ' ' + addr2.value.trim();
  if (!fullAddr) return;
  convertToEnglishAddress(fullAddr, function(engAddr) {
    enField.value = engAddr;
    enField.style.background = '#e3f2fd';
    setTimeout(function() { enField.style.background = ''; }, 3000);
  });
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰
// ============================================================
function openDetPostcodeSearch() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('detZipcode').value = data.zonecode;
      document.getElementById('detAddr1').value = data.roadAddress || data.jibunAddress;
      document.getElementById('detAddr2').value = '';
      document.getElementById('detAddr2').focus();
      // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜
      var fullAddr = (data.roadAddress || data.jibunAddress || '').trim();
      convertToEnglishAddress(fullAddr, function(eng) {
        var enField = document.getElementById('detAddrEn');
        if (enField) { enField.value = eng; enField.style.background = '#e3f2fd'; setTimeout(function() { enField.style.background = _detailEditMode ? '#fff' : '#f8f9fb'; }, 3000); }
      });
    }
  }).open();
}

// ============================================================
// ì¹´ì¹´ì˜¤ ì£¼ì†Œ API (ìƒì„¸ í˜ì´ì§€ OCRìš©)
// ============================================================
function lookupAddressFromKakao(address, callback) {
  if (!address) return;
  var cleanAddr = address.replace(/\([^)]*\)/g, '').trim();
  var mainAddr = cleanAddr;
  var detailAddr = '';
  var commaMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s*[,]\s*(.+)$/);
  if (commaMatch) {
    mainAddr = commaMatch[1].trim();
    detailAddr = commaMatch[2].trim();
  } else {
    var spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(\d+ì¸µ.*)$/);
    if (!spaceMatch) {
      spaceMatch = cleanAddr.match(/^(.+?\d+(?:-\d+)?)\s+(.+ì¸µ.*)$/);
    }
    if (spaceMatch) {
      mainAddr = spaceMatch[1].trim();
      detailAddr = spaceMatch[2].trim();
    }
  }
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(mainAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      if (roadAddr && roadAddr.zone_no) {
        callback(roadAddr.zone_no, roadAddr.address_name, detailAddr);
      } else if (doc.address) {
        callback(doc.address.zip_code || '', doc.address.address_name || mainAddr, detailAddr);
      }
    }
  })
  .catch(function(e) { console.warn('ì¹´ì¹´ì˜¤ ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: OCR íŒŒì¼ í•¸ë“¤ëŸ¬
// ============================================================
function handleDetailBizFile(file) {
  if (!file) return;
  _detailBizFile = file;
  document.getElementById('detailBizFileName').textContent = 'ğŸ“ ' + file.name;
  document.getElementById('detailBizOcrBtn').disabled = false;
}

function handleDetailLicFile(file) {
  if (!file) return;
  _detailLicFile = file;
  document.getElementById('detailLicFileName').textContent = 'ğŸ“ ' + file.name;
  document.getElementById('detailLicOcrBtn').disabled = false;
}

// ì¶”ê°€ ì¸í—ˆê°€ ì¹´ë“œë³„ íŒŒì¼ í•¸ë“¤ëŸ¬
function handleDetLicCardFile(num, file) {
  if (!file) return;
  _detLicCardFiles[num] = file;
  var nameEl = document.getElementById('detLicFileName_' + num);
  if (nameEl) nameEl.textContent = 'ğŸ“ ' + file.name;
  var btn = document.getElementById('detLicOcrBtn_' + num);
  if (btn) btn.disabled = false;
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¬ì¸ì‹
// ============================================================
function runDetailBizOCR() {
  if (!_detailBizFile || !_detailCustId) return;
  var statusEl = document.getElementById('detailOcrStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = 'â³ ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¸ì‹ ì¤‘...';
  document.getElementById('detailBizOcrBtn').disabled = true;

  convertPdfToJpegBase64(_detailBizFile).then(function(result) {
    var payload = { images: [{ format: result.format, name: 'biz', data: result.base64 }], requestId: 'det-biz-' + Date.now(), version: 'V2', timestamp: Date.now() };
    return fetch(OCR_BIZ_LICENSE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }).then(function(r) { return r.json(); })
  .then(async function(data) {
    var res = data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result;
    if (!res) { statusEl.textContent = 'âŒ OCR ì¸ì‹ ì‹¤íŒ¨'; return; }

    function gt(f) { return (f && f.length) ? f.map(function(x){return x.text||''}).join(' ') : ''; }
    var changes = [];
    var cust = await fsGetCompanyById(_detailCustId);
    if (!cust) { statusEl.textContent = 'âŒ ì—…ì²´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; return; }
    var now = new Date().toISOString().slice(0, 16).replace('T', ' ');

    // í•„ë“œë³„ ë¹„êµ ë° ë³€ê²½ ê°ì§€
    var fieldMap = [
      { key: 'company', label: 'íšŒì‚¬ëª…', ocrField: function() { return gt(res.corpName) || gt(res.companyName); }, detId: 'detCompany' },
      { key: 'repName', label: 'ëŒ€í‘œìëª…', ocrField: function() { return gt(res.repName); }, detId: 'detRepName' },
      { key: 'bizNo', label: 'ì‚¬ì—…ìë²ˆí˜¸', ocrField: function() { return gt(res.registerNumber); }, detId: 'detBizNo' },
      { key: 'bizType', label: 'ì—…íƒœ', ocrField: function() { return gt(res.bisType); }, detId: 'detBizType' },
      { key: 'bizItem', label: 'ì¢…ëª©', ocrField: function() { return gt(res.bisItem); }, detId: 'detBizItem' }
    ];

    fieldMap.forEach(function(fm) {
      var newVal = fm.ocrField().trim();
      var oldVal = (cust[fm.key] || '').trim();
      if (newVal && newVal !== oldVal) {
        changes.push({ field: fm.label, from: oldVal, to: newVal });
        cust[fm.key] = newVal;
        document.getElementById(fm.detId).value = newVal;
      }
    });

    // ì£¼ì†Œ ì²˜ë¦¬
    var ocrAddr = gt(res.bisAddress);
    if (ocrAddr) {
      var rawAddr = ocrAddr.trim();
      var oldAddr1 = (cust.addr1 || '').trim();
      if (rawAddr && rawAddr !== oldAddr1) {
        changes.push({ field: 'ì£¼ì†Œ', from: oldAddr1, to: rawAddr });
        cust.addr1 = rawAddr;
        document.getElementById('detAddr1').value = rawAddr;
      }
      lookupAddressFromKakao(rawAddr, function(zipcode, roadAddr, detailAddr2) {
        if (zipcode) { cust.zipcode = zipcode; document.getElementById('detZipcode').value = zipcode; }
        if (roadAddr) { cust.addr1 = roadAddr; document.getElementById('detAddr1').value = roadAddr; }
        if (detailAddr2) { cust.addr2 = detailAddr2; document.getElementById('detAddr2').value = detailAddr2; }
        db.collection('companies').doc(_detailCustId).update({ zipcode: cust.zipcode, addr1: cust.addr1, addr2: cust.addr2 || '' });
      });
    }

    // ë³€ê²½ ì´ë ¥ ê¸°ë¡
    if (changes.length > 0) {
      var detail = changes.map(function(c) {
        return 'ã€' + c.field + 'ã€‘ "' + (c.from || '(ì—†ìŒ)') + '" â†’ "' + c.to + '"';
      }).join(', ');
      var logEntry = {
        date: now,
        who: 'ì‹œìŠ¤í…œ (ì‚¬ì—…ìë“±ë¡ì¦ OCR)',
        detail: 'ì‚¬ì—…ìë“±ë¡ì¦ ì¬ì¸ì‹ì— ì˜í•´ ë³€ê²½ë¨ â€” ' + detail
      };
      if (!cust.changeLog) cust.changeLog = [];
      cust.changeLog.push(logEntry);
      fsSaveCompany(Object.assign({id: _detailCustId}, cust));
      renderChangeLog(cust.changeLog);
      document.getElementById('detailCompanyTitle').textContent = cust.company;
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ' + changes.length + 'ê±´ ë³€ê²½ì‚¬í•­ ë°˜ì˜';
    } else {
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ë³€ê²½ì‚¬í•­ ì—†ìŒ';
    }
    // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜ (ê¸°ë³¸ì£¼ì†Œë§Œ â€” ìƒì„¸ì£¼ì†Œ í¬í•¨ ì‹œ API ë§¤ì¹­ ì‹¤íŒ¨)
    if (cust.addr1) {
      convertToEnglishAddress(cust.addr1, function(eng) {
        cust.addrEn = eng;
        document.getElementById('detAddrEn').value = eng;
        db.collection('companies').doc(_detailCustId).update({ addrEn: eng });
      });
    }
  }).catch(function(e) {
    statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + e.message;
  });
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ì¸í—ˆê°€ë¬¸ì„œ OCR ì¬ì¸ì‹
// ============================================================
function runDetailLicOCR() {
  if (!_detailLicFile || !_detailCustId) return;
  var statusEl = document.getElementById('detailOcrStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = 'â³ ì¸í—ˆê°€ë¬¸ì„œ OCR ì¸ì‹ ì¤‘...';
  document.getElementById('detailLicOcrBtn').disabled = true;

  convertPdfToJpegBase64(_detailLicFile).then(function(result) {
    var payload = { images: [{ format: result.format, name: 'lic', data: result.base64 }], requestId: 'det-lic-' + Date.now(), version: 'V2', timestamp: Date.now() };
    return fetch(OCR_BIZ_LICENSE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }).then(function(r) { return r.json(); })
  .then(async function(data) {
    var res = data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result;
    if (!res) { statusEl.textContent = 'âŒ OCR ì¸ì‹ ì‹¤íŒ¨'; return; }

    function gt(f) { return (f && f.length) ? f.map(function(x){return x.text||''}).join(' ') : ''; }
    var changes = [];
    var cust = await fsGetCompanyById(_detailCustId);
    if (!cust) { statusEl.textContent = 'âŒ ì—…ì²´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; return; }
    var now = new Date().toISOString().slice(0, 16).replace('T', ' ');

    // ì²« ë²ˆì§¸ ì¸í—ˆê°€ ê¸°ì¤€
    var lic0 = (cust.licenses && cust.licenses.length > 0) ? cust.licenses[0] : cust;

    var licFields = [
      { key: 'licRepName', label: 'ì¸í—ˆê°€ ëŒ€í‘œì', ocrField: function() { return gt(res.repName); }, detId: 'detLicRepName_1' },
      { key: 'licNo', label: 'ì¸í—ˆê°€ë²ˆí˜¸', ocrField: function() { return gt(res.registerNumber); }, detId: 'detLicNo_1' },
      { key: 'licBizName', label: 'ì˜ì—…ì†Œëª…ì¹­', ocrField: function() { return gt(res.companyName); }, detId: 'detLicBizName_1' }
    ];

    // ì˜ì—…í˜•íƒœ
    var bizFormRaw = gt(res.bisType) || gt(res.bisItem) || '';
    if (bizFormRaw) {
      var oldBizForm = (lic0.licBizForm || '').trim();
      if (bizFormRaw.trim() !== oldBizForm) {
        changes.push({ field: 'ì˜ì—…ì˜ í˜•íƒœ', from: oldBizForm, to: bizFormRaw.trim() });
        lic0.licBizForm = bizFormRaw.trim();
        cust.licBizForm = bizFormRaw.trim();
        var detBizFormEl = document.getElementById('detLicBizForm_1');
        if (detBizFormEl) detBizFormEl.value = bizFormRaw.trim();
      }
    }

    licFields.forEach(function(fm) {
      var newVal = fm.ocrField().trim();
      var oldVal = (lic0[fm.key] || '').trim();
      if (newVal && newVal !== oldVal) {
        changes.push({ field: fm.label, from: oldVal, to: newVal });
        lic0[fm.key] = newVal;
        cust[fm.key] = newVal;
        var detEl = document.getElementById(fm.detId);
        if (detEl) detEl.value = newVal;
      }
    });

    // ì†Œì¬ì§€ ì£¼ì†Œ
    var ocrAddr = gt(res.bisAddress);
    if (ocrAddr) {
      var rawLicAddr = ocrAddr.trim();
      var oldLicAddr = (lic0.licAddr || '').trim();
      if (rawLicAddr !== oldLicAddr) {
        changes.push({ field: 'ì¸í—ˆê°€ ì†Œì¬ì§€', from: oldLicAddr, to: rawLicAddr });
        lic0.licAddr = rawLicAddr;
        cust.licAddr = rawLicAddr;
        var detAddrEl = document.getElementById('detLicAddr_1');
        if (detAddrEl) detAddrEl.value = rawLicAddr;
      }
      lookupAddressFromKakao(rawLicAddr, function(zipcode, roadAddr, detailAddr2) {
        if (zipcode) { lic0.licZipcode = zipcode; var zEl = document.getElementById('detLicZipcode_1'); if (zEl) zEl.value = zipcode; }
        if (roadAddr) { lic0.licAddr = roadAddr; cust.licAddr = roadAddr; var aEl = document.getElementById('detLicAddr_1'); if (aEl) aEl.value = roadAddr; }
        if (detailAddr2) { lic0.licAddr2 = detailAddr2; cust.licAddr2 = detailAddr2; var a2El = document.getElementById('detLicAddr2_1'); if (a2El) a2El.value = detailAddr2; }
        if (cust.licenses && cust.licenses.length > 0) cust.licenses[0] = lic0;
        db.collection('companies').doc(_detailCustId).update({ licenses: cust.licenses || [], licAddr: cust.licAddr, licAddr2: cust.licAddr2 || '' });
      });
    }

    // ë¶„ì•¼ ìë™ ì„¤ì •
    var allText = [bizFormRaw, gt(res.companyName), gt(res.documentType)].join(' ');
    var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
    var newField = isLivestock ? 'ì¶•ì‚°' : 'ì‹í’ˆ';
    if (lic0.licField !== newField) {
      changes.push({ field: 'ë¶„ì•¼', from: lic0.licField || '', to: newField });
      lic0.licField = newField;
      cust.licField = newField;
      var detFieldEl = document.getElementById('detLicField_1');
      if (detFieldEl) detFieldEl.value = newField;
    }

    // licenses ë°°ì—´ ì—…ë°ì´íŠ¸
    if (cust.licenses && cust.licenses.length > 0) {
      cust.licenses[0] = lic0;
    }

    // ë³€ê²½ ì´ë ¥ ê¸°ë¡
    if (changes.length > 0) {
      var detail = changes.map(function(c) {
        return 'ã€' + c.field + 'ã€‘ "' + (c.from || '(ì—†ìŒ)') + '" â†’ "' + c.to + '"';
      }).join(', ');
      var logEntry = {
        date: now,
        who: 'ì‹œìŠ¤í…œ (ì¸í—ˆê°€ë¬¸ì„œ OCR)',
        detail: 'ì¸í—ˆê°€ë¬¸ì„œ ì¬ì¸ì‹ì— ì˜í•´ ë³€ê²½ë¨ â€” ' + detail
      };
      if (!cust.changeLog) cust.changeLog = [];
      cust.changeLog.push(logEntry);
      await fsSaveCompany(Object.assign({id: _detailCustId}, cust));
      renderChangeLog(cust.changeLog);
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ' + changes.length + 'ê±´ ë³€ê²½ì‚¬í•­ ë°˜ì˜';
    } else {
      statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ë³€ê²½ì‚¬í•­ ì—†ìŒ';
    }
    // ì˜ë¬¸ ì£¼ì†Œ ìë™ ë³€í™˜ (ê¸°ë³¸ì£¼ì†Œë§Œ â€” ìƒì„¸ì£¼ì†Œ í¬í•¨ ì‹œ API ë§¤ì¹­ ì‹¤íŒ¨)
    if (lic0.licAddr) {
      convertToEnglishAddress(lic0.licAddr, function(eng) {
        lic0.licAddrEn = eng;
        cust.licAddrEn = eng;
        if (cust.licenses && cust.licenses.length > 0) cust.licenses[0].licAddrEn = eng;
        var detEngEl = document.getElementById('detLicAddrEn_1');
        if (detEngEl) detEngEl.value = eng;
        db.collection('companies').doc(_detailCustId).update({ licAddrEn: eng, licenses: cust.licenses || [] });
      });
    }
  }).catch(function(e) {
    statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + e.message;
  });
}

// ============================================================
// ìƒì„¸ í˜ì´ì§€: ì¶”ê°€ ì¸í—ˆê°€ ì¹´ë“œë³„ OCR
// ============================================================
function runDetLicCardOCR(num) {
  var file = _detLicCardFiles[num];
  if (!file) return;
  var statusEl = document.getElementById('detLicOcrStatus_' + num);
  if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'â³ OCR ì¸ì‹ ì¤‘...'; }
  var btn = document.getElementById('detLicOcrBtn_' + num);
  if (btn) btn.disabled = true;

  convertPdfToJpegBase64(file).then(function(result) {
    var payload = { images: [{ format: result.format, name: 'lic' + num, data: result.base64 }], requestId: 'det-lic' + num + '-' + Date.now(), version: 'V2', timestamp: Date.now() };
    return fetch(OCR_BIZ_LICENSE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }).then(function(r) { return r.json(); })
  .then(function(data) {
    var res = data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result;
    if (!res) { if (statusEl) statusEl.textContent = 'âŒ OCR ì¸ì‹ ì‹¤íŒ¨'; return; }

    function gt(f) { return (f && f.length) ? f.map(function(x){return x.text||''}).join(' ') : ''; }
    var filled = 0;
    var repName = gt(res.repName);
    if (repName) { var el = document.getElementById('detLicRepName_' + num); if (el) { el.value = repName; filled++; } }
    var regNo = gt(res.registerNumber);
    if (regNo) { var el2 = document.getElementById('detLicNo_' + num); if (el2) { el2.value = regNo; filled++; } }
    var compName = gt(res.companyName);
    if (compName) { var el3 = document.getElementById('detLicBizName_' + num); if (el3) { el3.value = compName; filled++; } }
    var bizForm = gt(res.bisType) || gt(res.bisItem) || '';
    if (bizForm) { var el4 = document.getElementById('detLicBizForm_' + num); if (el4) { el4.value = bizForm.trim(); filled++; } }
    // ë¶„ì•¼ ìë™ ì„¤ì •
    var allText = [bizForm, compName, gt(res.documentType)].join(' ');
    var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
    var fieldEl = document.getElementById('detLicField_' + num);
    if (fieldEl) { fieldEl.value = isLivestock ? 'ì¶•ì‚°' : 'ì‹í’ˆ'; filled++; }
    // ì†Œì¬ì§€ ì£¼ì†Œ + ì¹´ì¹´ì˜¤ ì£¼ì†Œ API
    var ocrAddr = gt(res.bisAddress);
    if (ocrAddr) {
      var rawAddr = ocrAddr.trim();
      var addrEl = document.getElementById('detLicAddr_' + num);
      if (addrEl) { addrEl.value = rawAddr; filled++; }
      lookupAddressFromKakao(rawAddr, function(zipcode, roadAddr, detailAddr2) {
        if (zipcode) { var zEl = document.getElementById('detLicZipcode_' + num); if (zEl) zEl.value = zipcode; }
        if (roadAddr) { var aEl = document.getElementById('detLicAddr_' + num); if (aEl) aEl.value = roadAddr; }
        if (detailAddr2) { var a2El = document.getElementById('detLicAddr2_' + num); if (a2El) a2El.value = detailAddr2; }
        // ì˜ë¬¸ ì£¼ì†Œ ë³€í™˜
        convertToEnglishAddress(roadAddr || rawAddr, function(eng) {
          var enEl = document.getElementById('detLicAddrEn_' + num);
          if (enEl) enEl.value = eng;
        });
      });
    }
    if (statusEl) statusEl.textContent = 'âœ… OCR ì™„ë£Œ â€” ' + filled + 'ê°œ í•„ë“œ ë°˜ì˜';
  }).catch(function(e) {
    if (statusEl) statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + e.message;
  });
}

// ============================================================
// ì´ˆê¸°í™”
// ============================================================
var _firebaseInitDone = false;
window.addEventListener('firebase-ready', async function() {
  if (_firebaseInitDone) return;
  _firebaseInitDone = true;
  console.log('[companyMgmt] Firebase ì¤€ë¹„ ì™„ë£Œ, ì—…ì²´ ëª©ë¡ ë¡œë“œ');
  await loadList();
});
// fallback
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(async function() {
    if (!_firebaseInitDone && typeof isFirebaseReady === 'function' && isFirebaseReady()) {
      _firebaseInitDone = true;
      await loadList();
    }
  }, 3000);
});
</script>
</body>
</html>
