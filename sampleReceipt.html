<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ì‹œë£Œ ì ‘ìˆ˜ ë“±ë¡</title>
<style>
:root{--primary:#2563eb;--success:#10b981;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-600:#4b5563;--gray-900:#111827;--accent:#667eea;--accent2:#764ba2}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;background:#f5f5f5;color:#1a1a1a}
.app-layout{display:flex;height:100vh}
/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */
.main-container{flex:1;margin-left:250px;display:flex;flex-direction:column;overflow:hidden}
.top-header{background:white;padding:16px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:#64748b}
.breadcrumb-current{color:#1e293b;font-weight:600}
.server-status{display:flex;align-items:center;gap:6px;font-size:12px;padding:4px 12px;border-radius:20px;background:#f1f5f9}
.server-status.online{color:#16a34a;background:#f0fdf4}
.server-status.offline{color:#dc2626;background:#fef2f2}
.main-content{flex:1;overflow-y:auto;padding:24px}

/* ====== RECEIPT FORM STYLES ====== */
.form-container{max-width:1100px;margin:0 auto}
.section{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:12px;background:white}
.section-header{background:#f8f9fa;padding:18px 24px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:16px;color:#333;transition:all 0.3s;border-radius:12px 12px 0 0}
.section-header:hover{background:#e9ecef}
.section-header.active{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white}
.toggle-icon{transition:transform 0.3s;font-size:12px}
.section-header.active .toggle-icon{transform:rotate(180deg)}
.section-content{padding:24px;display:none}
.section-content.active{display:block}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
.form-group{display:flex;flex-direction:column}
.form-group label{font-weight:500;margin-bottom:8px;color:#333;font-size:14px}
.required{color:#f44336;margin-left:4px}
.form-group input,.form-group select,.form-group textarea{padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:all 0.3s;font-family:inherit}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.form-group input:disabled,.form-group select:disabled,.form-group textarea:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
.pin-check{display:inline-flex;align-items:center;font-size:13px;font-weight:400;color:#bbb;cursor:pointer;margin-left:6px;vertical-align:middle;user-select:none;transition:color 0.2s}
.pin-check:hover{color:#888}
.pin-check input[type="checkbox"]{display:none}
.pin-check.active{color:#ff9800}
.report-send-chip{cursor:pointer;user-select:none}
.report-send-chip input{display:none}
.report-send-chip .chip-body{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border:2px solid #e0e0e0;border-radius:20px;font-size:13px;font-weight:500;color:#667085;background:#fff;transition:all 0.2s}
.report-send-chip .chip-icon{font-size:15px}
.report-send-chip:hover .chip-body{border-color:#b0bec5;background:#f8f9fb}
.report-send-chip input:checked+.chip-body{border-color:var(--accent);background:linear-gradient(135deg,#f0f4ff,#e8ecff);color:#4a5aef;font-weight:600;box-shadow:0 2px 8px rgba(102,126,234,0.15)}
.radio-group{display:flex;gap:20px;margin-top:8px}
.radio-label{display:flex;align-items:center;padding:10px 20px;border:2px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.3s;margin-bottom:0!important}
.radio-label:hover{border-color:var(--accent);background:#f8f9ff}
.radio-label input[type="radio"]:checked{accent-color:var(--accent)}
.radio-label input[type="radio"]{margin-right:8px}
.company-search{position:relative}
.search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#999}
.suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none}
.suggestions.active{display:block}
.suggestion-item{padding:12px;cursor:pointer;transition:background 0.2s}
.suggestion-item:hover{background:#f5f7fa}
.field-help{font-size:12px;color:#999;margin-top:4px}
.buttons{display:flex;gap:12px;justify-content:center;margin-top:40px;padding-top:30px;border-top:1px solid #e0e0e0}
.btn-receipt{padding:14px 32px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s}
.btn-receipt.primary{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white}
.btn-receipt.primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4)}
.btn-receipt.save{background:#e0e0e0;color:#666}
.btn-receipt.save.modified{background:linear-gradient(135deg,#1de9b6 0%,#1dc4e9 100%);color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.btn-receipt.secondary{background:white;color:var(--accent);border:2px solid var(--accent)}
.btn-receipt.secondary:hover{background:#f8f9ff}
.btn-receipt.cancel{background:#f5f5f5;color:#666}
.btn-receipt.cancel:hover{background:#e0e0e0}
.auto-value{background:#e3f2fd;border-color:#90caf9}
.receipt-no-allocated{background:#c8e6c9;border-color:#4caf50;font-weight:600}
.autocomplete-input{position:relative}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none}
.autocomplete-list.active{display:block}
.autocomplete-item{padding:10px;cursor:pointer;transition:background 0.2s}
.autocomplete-item:hover{background:#f0f0f0}
.autocomplete-item mark{background:#ffeb3b;padding:0 2px}
.team-memo{border-left:4px solid;padding:16px;margin-bottom:16px;background:#f9f9f9;border-radius:8px}
.team-memo.customer-support{border-color:#2196f3}
.team-memo.quality{border-color:#4caf50}
.team-memo.finance{border-color:#ff9800}
.team-memo.marketing{border-color:#e91e63}
.team-memo-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.team-memo-title{font-weight:600;font-size:14px}
.team-memo-lock{font-size:12px;color:#999}
.team-memo textarea{width:100%;min-height:80px;resize:vertical}
.team-memo textarea:disabled{background:#fafafa;cursor:not-allowed}
.toast{position:fixed;top:20px;right:20px;background:#4caf50;color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);display:none;z-index:2000;min-width:250px}
.toast.active{display:block;animation:slideIn 0.3s}
.toast.error{background:#f44336}
.toast.warning{background:#ff9800}
.toast.info{background:#2196f3}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:16px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.warning-box-icon{font-size:24px}
.warning-box-text{flex:1}
@media(max-width:768px){.sidebar{display:none}.main-container{margin-left:0}.form-row{grid-template-columns:1fr}.buttons{flex-direction:column}.btn-receipt{width:100%}}
/* ì»¤ìŠ¤í…€ ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ */
.custom-select-wrap{position:relative;width:100%}
.custom-select-display{padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s}
.custom-select-display:hover{border-color:var(--accent)}
.custom-select-display.open{border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,126,234,0.1);border-radius:8px 8px 0 0}
.custom-select-arrow{color:#888;font-size:12px;transition:transform 0.2s}
.custom-select-display.open .custom-select-arrow{transform:rotate(180deg)}
.custom-select-options{display:none;position:absolute;top:100%;left:0;min-width:100%;width:max-content;background:#fff;border:1px solid var(--accent);border-top:none;border-radius:0 0 8px 8px;max-height:300px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.custom-select-options.open{display:block}
.custom-select-option{padding:10px 14px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:8px;transition:background 0.15s}
.custom-select-option:hover{background:#f0f4ff}
.custom-select-option.selected{background:#e8edff;font-weight:600}
.custom-select-option .field-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.custom-select-option .field-label{font-size:12px;padding:1px 6px;border-radius:4px;color:#fff;margin-left:auto;white-space:nowrap}
/* ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ì˜ì—­ */
.mfds-section{background:#f0f7ff;border:1px solid #bbdefb;border-radius:8px;padding:14px 16px;margin-top:4px}
.mfds-label{font-weight:600;font-size:13px;color:#1565c0;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.mfds-label::before{content:'ğŸ›ï¸';font-size:14px}
</style>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/mfds-codes.js"></script>
<script src="js/mfds-fee-mapping.js"></script>
<script src="js/mfds_templates.js?v=20260227"></script>
<script src="js/firestore-helpers.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
</head>
<body>
<div class="app-layout">
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=2"></script>
<div class="main-container">
<header class="top-header">
<div class="breadcrumb">
<span>ì ‘ìˆ˜ ê´€ë¦¬</span>
<span>â€º</span>
<span class="breadcrumb-current">ì ‘ìˆ˜ ë“±ë¡</span>
</div>
<div class="server-status offline" id="server-status">
<span id="server-status-icon">ğŸ”´</span>
<span id="server-status-text">API ì˜¤í”„ë¼ì¸</span>
</div>
</header>
<main class="main-content">
<div class="form-container">
    <form id="receipt-form">

        <!-- 0. ì˜ë¢°ì„œ OCR ìë™ì…ë ¥ -->
        <div id="ocr-upload-section" style="margin-bottom:16px;padding:14px 18px;border:2px dashed #c8e6c9;border-radius:10px;background:#f9fdf9">
            <div style="display:flex;align-items:center;gap:10px">
                <div id="receiptOcrFileArea" style="flex:1;padding:12px;border:2px dashed #c8e6c9;border-radius:8px;cursor:pointer;text-align:center;font-size:13px;color:#666;transition:all 0.2s"
                    onclick="document.getElementById('receiptOcrFileInput').click()"
                    ondragover="event.preventDefault();this.style.borderColor='#43a047';this.style.background='#e8f5e9'"
                    ondragleave="this.style.borderColor='#c8e6c9';this.style.background='transparent'"
                    ondrop="event.preventDefault();this.style.borderColor='#c8e6c9';this.style.background='transparent';handleReceiptOcrFile(event.dataTransfer.files[0])">
                    <input type="file" id="receiptOcrFileInput" accept="image/*,.pdf" style="display:none" onchange="handleReceiptOcrFile(this.files[0])">
                    <span id="receiptOcrFileName">ğŸ“‹ ì‹œí—˜Â·ê²€ì‚¬ ì˜ë¢°ì„œ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ (JPG, PNG, PDF) â†’ ì ‘ìˆ˜ ì–‘ì‹ ìë™ì…ë ¥</span>
                </div>
                <button type="button" class="btn btn-success btn-sm" id="receiptOcrBtn" onclick="runReceiptOCR()" disabled style="white-space:nowrap;padding:12px 16px">ğŸ¤– ì˜ë¢°ì„œ OCR</button>
            </div>
            <div id="receiptOcrStatus" style="font-size:12px;margin-top:6px;color:#666"></div>
        </div>

        <!-- 1. ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´ -->
        <div class="section">
            <div class="section-header active" onclick="toggleSection(this)">
                <span>ğŸ“‹ ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content active">
                <div class="warning-box" id="receipt-no-warning">
                    <span class="warning-box-icon">âš ï¸</span>
                    <div class="warning-box-text">
                        <strong>ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!</strong><br>
                        ë™ì‹œ ì ‘ìˆ˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ í›„ ì‘ì—…ì„ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <div class="form-row" style="grid-template-columns:auto 1.5fr 1fr auto;align-items:end;margin-bottom:16px">
                    <div class="form-group">
                        <label>ì‹œí—˜ë¶„ì•¼ <span class="required">*</span>
                            <label class="pin-check" title="ê³ ì •: ë‹¤ìŒ ì ‘ìˆ˜ì—ë„ ì´ ì‹œí—˜ë¶„ì•¼ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤">
                                <input type="checkbox" id="pin-test-field" onchange="togglePin('test-field')"><span class="pin-icon">ğŸ”“</span>
                            </label>
                        </label>
                        <div class="radio-group" style="margin-top:0;gap:12px">
                            <label class="radio-label" style="padding:11px 18px">
                                <input type="radio" name="test-field" value="ì‹í’ˆ" checked onchange="onTestFieldChange()">
                                <span>ğŸ ì‹í’ˆ</span>
                            </label>
                            <label class="radio-label" style="padding:11px 18px">
                                <input type="radio" name="test-field" value="ì¶•ì‚°" onchange="onTestFieldChange()">
                                <span>ğŸ¥© ì¶•ì‚°</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì‚¬ëª©ì  <span class="required">*</span>
                            <label class="pin-check" title="ê³ ì •: ë‹¤ìŒ ì ‘ìˆ˜ì—ë„ ì´ ê²€ì‚¬ëª©ì ì„ ìœ ì§€í•©ë‹ˆë‹¤">
                                <input type="checkbox" id="pin-test-purpose" onchange="togglePin('test-purpose')"><span class="pin-icon">ğŸ”“</span>
                            </label>
                        </label>
                        <select id="test-purpose" required onchange="onTestPurposeChange()" style="display:none;">
                            <option value="">ë¨¼ì € ì‹œí—˜ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <div class="custom-select-wrap" id="test-purpose-custom">
                            <div class="custom-select-display" id="test-purpose-display" onclick="toggleCustomSelect()">
                                <span class="custom-select-text">ì„ íƒí•˜ì„¸ìš”</span>
                                <span class="custom-select-arrow">â–¾</span>
                            </div>
                            <div class="custom-select-options" id="test-purpose-options"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì ‘ìˆ˜ì¼ì <span class="required">*</span>
                            <label class="pin-check" title="ê³ ì •: ë‹¤ìŒ ì ‘ìˆ˜ì—ë„ ì´ ì ‘ìˆ˜ì¼ìë¥¼ ìœ ì§€í•©ë‹ˆë‹¤">
                                <input type="checkbox" id="pin-receipt-date" onchange="togglePin('receipt-date')"><span class="pin-icon">ğŸ”“</span>
                            </label>
                        </label>
                        <input type="date" id="receipt-date" required onchange="calculateProcessingDeadline()">
                    </div>
                    <div>
                        <button type="button" class="btn-receipt primary" onclick="allocateReceiptNo()" style="padding:11px 24px;white-space:nowrap">
                            ğŸ”¢ ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹
                        </button>
                    </div>
                </div>

                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="form-group">
                        <label>ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ (ì„ íƒ)</label>
                        <input type="text" id="prev-receipt-no" placeholder="ì˜ˆ: 260207FQ001-001" onchange="setPrevReceiptNo()">
                        <small class="field-help">ì´ì–´ë°›ì„ ê²½ìš° ì…ë ¥í•˜ì„¸ìš”</small>
                    </div>
                    <div class="form-group">
                        <label>í• ë‹¹ëœ ì ‘ìˆ˜ë²ˆí˜¸</label>
                        <input type="text" id="receipt-no" class="auto-value" readonly>
                        <small class="field-help" id="receipt-no-status" style="color:#f44336;">âŒ ë¯¸í• ë‹¹</small>
                    </div>
                    <div class="form-group">
                        <label>ê¸´ê¸‰ì—¬ë¶€</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="urgent" value="ì¼ë°˜" checked>
                                <span>ì¼ë°˜</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="urgent" value="ê¸´ê¸‰">
                                <span>âš¡ ê¸´ê¸‰</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="form-group">
                        <label>ì²˜ë¦¬ê¸°í•œ</label>
                        <input type="date" id="processing-deadline" class="auto-value" readonly>
                        <small class="field-help">ì ‘ìˆ˜ì¼ + ì›Œí‚¹ë°ì´ 12ì¼</small>
                    </div>
                    <div class="form-group">
                        <label>ìƒíƒœ</label>
                        <input type="text" id="status" value="ëŒ€ê¸°ì¤‘" class="auto-value" readonly>
                        <small class="field-help">ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ í›„ 'ì ‘ìˆ˜ì¤‘'</small>
                    </div>
                    <div class="form-group">
                        <label>ì‹œë£Œ ìˆ˜</label>
                        <input type="number" id="sample-total-count" placeholder="ì˜ˆ: 1" min="1" value="1" onchange="updateSampleCount(this.value)" oninput="updateSampleCount(this.value)">
                    </div>
                </div>

            </div>
        </div>

        <!-- 2. ì—…ì²´ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ¢ ì—…ì²´ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="form-group company-search">
                        <label>ê±°ë˜ì²˜ <span class="required">*</span></label>
                        <input type="text" id="company-search" placeholder="ì—…ì²´ëª…, ì¸í—ˆê°€ë²ˆí˜¸, ì˜ì—…ì†Œëª… ê²€ìƒ‰..." oninput="searchCompany(this.value)" required>
                        <span class="search-icon">ğŸ”</span>
                        <div class="suggestions" id="company-suggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>ì¸í—ˆê°€ë²ˆí˜¸</label>
                        <input type="text" id="lic-no" readonly style="font-family:monospace;color:#1565c0">
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì</label>
                        <input type="text" id="sales-rep" readonly style="background:#f0f4c3;font-weight:600">
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr 1fr">
                    <div class="form-group">
                        <label>ì¸í—ˆê°€ ë¶„ì•¼</label>
                        <input type="text" id="lic-biz-form" readonly>
                    </div>
                    <div class="form-group">
                        <label>ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="company-phone" readonly>
                    </div>
                    <div class="form-group">
                        <label>íŒ©ìŠ¤ë²ˆí˜¸</label>
                        <input type="tel" id="company-fax" readonly>
                    </div>
                    <div class="form-group">
                        <label>íœ´ëŒ€í°</label>
                        <input type="tel" id="company-mobile" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì£¼ì†Œ</label>
                        <input type="text" id="company-address" readonly>
                    </div>
                </div>
                <input type="hidden" id="lic-biz-name">
                <!-- ì„±ì ì„œ ë°œì†¡ -->
                <div class="form-row" style="grid-template-columns:1fr">
                    <div class="form-group">
                        <label>ì„±ì ì„œ ë°œì†¡</label>
                        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:6px">
                            <label class="report-send-chip">
                                <input type="checkbox" name="report-send" value="ìš°í¸" onchange="toggleReportSendOption()">
                                <span class="chip-body"><span class="chip-icon">ğŸ“®</span> ìš°í¸</span>
                            </label>
                            <label class="report-send-chip">
                                <input type="checkbox" name="report-send" value="ì„ ë°œì†¡" onchange="toggleReportSendOption()">
                                <span class="chip-body"><span class="chip-icon">ğŸš€</span> ì„ ë°œì†¡</span>
                            </label>
                            <label class="report-send-chip">
                                <input type="checkbox" name="report-send" value="íŒ©ìŠ¤(ì„ )" onchange="toggleReportSendOption()">
                                <span class="chip-body"><span class="chip-icon">ğŸ“ </span> íŒ©ìŠ¤(ì„ )</span>
                            </label>
                            <label class="report-send-chip">
                                <input type="checkbox" name="report-send" value="ë©”ì¼(ì‚¬ë³¸)" onchange="toggleReportSendOption()">
                                <span class="chip-body"><span class="chip-icon">ğŸ“§</span> ë©”ì¼(ì‚¬ë³¸)</span>
                            </label>
                        </div>
                        <!-- ìš°í¸ ì˜µì…˜ íŒ¨ë„ -->
                        <div id="mail-option-panel" style="display:none;margin-top:12px;padding:12px;background:#f8f9fb;border-radius:8px;border:1px solid #e2e6ed">
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <label class="radio-label" style="padding:6px 12px;font-size:13px">
                                    <input type="checkbox" name="mail-addr-type" value="biz" onchange="toggleMailAddrType()">
                                    ì‚¬ì—…ìë“±ë¡ì¦ ì£¼ì†Œ <span id="mail-biz-addr-preview" style="color:#5f6b7a;font-size:12px;margin-left:8px"></span>
                                </label>
                                <label class="radio-label" style="padding:6px 12px;font-size:13px">
                                    <input type="checkbox" name="mail-addr-type" value="lic" onchange="toggleMailAddrType()">
                                    ì¸í—ˆê°€ ì£¼ì†Œ <span id="mail-lic-addr-preview" style="color:#5f6b7a;font-size:12px;margin-left:8px"></span>
                                </label>
                                <label class="radio-label" style="padding:6px 12px;font-size:13px">
                                    <input type="checkbox" name="mail-addr-type" value="other" onchange="toggleMailAddrType()">
                                    ë‹¤ë¥¸ ì£¼ì†Œ
                                </label>
                            </div>
                            <div id="mail-other-addr-panel" style="display:none;margin-top:10px">
                                <div style="display:flex;gap:6px;margin-bottom:6px">
                                    <button type="button" class="btn-receipt secondary" onclick="openMailPostcode()" style="padding:8px 14px;font-size:13px;white-space:nowrap">ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰</button>
                                    <input type="text" id="mail-zipcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly style="width:100px;background:#e8f5e9">
                                </div>
                                <input type="text" id="mail-addr1" placeholder="ì£¼ì†Œ" readonly style="width:100%;margin-bottom:6px;background:#e8f5e9">
                                <input type="text" id="mail-addr2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥" style="width:100%">
                            </div>
                        </div>
                        <!-- íŒ©ìŠ¤(ì„ ) ì˜µì…˜ íŒ¨ë„ -->
                        <div id="fax-option-panel" style="display:none;margin-top:12px;padding:12px;background:#f8f9fb;border-radius:8px;border:1px solid #e2e6ed">
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <label class="radio-label" style="padding:6px 12px;font-size:13px">
                                    <input type="checkbox" name="fax-type" value="registered" onchange="toggleFaxType()">
                                    ë“±ë¡ëœ íŒ©ìŠ¤ë²ˆí˜¸ <span id="fax-registered-preview" style="color:#5f6b7a;font-size:12px;margin-left:8px"></span>
                                </label>
                                <label class="radio-label" style="padding:6px 12px;font-size:13px">
                                    <input type="checkbox" name="fax-type" value="other" onchange="toggleFaxType()">
                                    ë‹¤ë¥¸ íŒ©ìŠ¤ë²ˆí˜¸
                                </label>
                            </div>
                            <div id="fax-other-panel" style="display:none;margin-top:10px">
                                <input type="tel" id="report-fax-no" placeholder="íŒ©ìŠ¤ë²ˆí˜¸ ì…ë ¥" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px">
                            </div>
                        </div>
                        <!-- ë©”ì¼(ì‚¬ë³¸) ì˜µì…˜ íŒ¨ë„ -->
                        <div id="email-option-panel" style="display:none;margin-top:12px;padding:12px;background:#f8f9fb;border-radius:8px;border:1px solid #e2e6ed">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                                <label style="font-size:13px;font-weight:500;white-space:nowrap">ìˆ˜ì‹  ì´ë©”ì¼:</label>
                                <input type="email" id="report-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px">
                            </div>
                            <div>
                                <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer">
                                    <input type="checkbox" id="email-cc-toggle" onchange="toggleMailCc()"> CC ì°¸ì—¬ì ì¶”ê°€
                                </label>
                                <div id="email-cc-panel" style="display:none;margin-top:8px">
                                    <div id="email-cc-fields">
                                        <input type="email" class="cc-email-field" placeholder="CC ì´ë©”ì¼ 1" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;margin-bottom:4px">
                                    </div>
                                    <button type="button" onclick="addCcField()" class="btn-receipt secondary" style="padding:4px 12px;font-size:12px;margin-top:4px">+ CC ì¶”ê°€</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ì—…ì²´ ë³€ê²½ì´ë ¥ -->
                <div id="company-changelog" style="display:none;margin-top:12px;border-top:1px solid #e2e6ed;padding-top:10px">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                        <div style="font-size:12px;font-weight:600;color:#5f6b7a">ğŸ“‹ ë³€ê²½ì´ë ¥</div>
                        <button type="button" onclick="toggleChangeLog()" id="changelog-toggle-btn" style="background:none;border:1px solid #e2e6ed;border-radius:4px;padding:2px 8px;font-size:11px;color:#5f6b7a;cursor:pointer">ì ‘ê¸° â–²</button>
                    </div>
                    <div id="company-changelog-body" style="max-height:150px;overflow-y:auto;font-size:11px"></div>
                </div>
            </div>
        </div>

        <!-- 3. ì‹œë£Œì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ§ª ì‹œë£Œì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <!-- ì‹œë£Œ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div id="sample-nav" style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px 14px;background:linear-gradient(135deg,#f0f4ff,#f8f0ff);border-radius:10px;border:1px solid #e2e6ed">
                    <button type="button" onclick="switchSample(_currentSampleIdx-1)" id="sample-nav-prev" style="background:none;border:1px solid #d0d5dd;border-radius:6px;padding:4px 10px;font-size:16px;cursor:pointer;color:#344054" disabled>â—€</button>
                    <div id="sample-nav-tabs" style="display:flex;gap:4px;flex:1;overflow-x:auto"></div>
                    <button type="button" onclick="switchSample(_currentSampleIdx+1)" id="sample-nav-next" style="background:none;border:1px solid #d0d5dd;border-radius:6px;padding:4px 10px;font-size:16px;cursor:pointer;color:#344054" disabled>â–¶</button>
                </div>
                <!-- ì‹œë£Œ ë¼ë²¨ -->
                <div id="sample-label" style="font-size:15px;font-weight:700;color:#6941C6;margin-bottom:10px">ğŸ“Œ ì‹œë£Œ #1</div>
                <div class="form-row" style="grid-template-columns:1fr 1fr auto;align-items:start">
                    <div class="form-group" style="position:relative">
                        <label>ì œí’ˆ/ì‹œë£Œëª… <span class="required">*</span></label>
                        <div style="display:flex;gap:6px">
                            <input type="text" id="product-name" required style="flex:1;min-width:0">
                            <button type="button" class="btn-receipt secondary" onclick="searchProductHistory()" style="padding:8px 14px;font-size:13px;white-space:nowrap">ğŸ“‹ ì¡°íšŒ</button>
                        </div>
                        <div id="product-history-panel" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:200;background:#fff;border:1px solid #d0d5dd;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.15);margin-top:4px;max-height:300px;overflow-y:auto"></div>
                    </div>
                    <div class="form-group autocomplete-input" id="food-type-group">
                        <label>ê²€ì²´ìœ í˜• <span class="required">*</span></label>
                        <input type="text" id="food-type-input" placeholder="ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”" oninput="searchFoodType(this.value)" onfocus="searchFoodType('')" autocomplete="off" disabled>
                        <input type="hidden" id="food-type-value">
                        <div class="autocomplete-list" id="food-type-list"></div>
                        <small class="field-help">ì‹œí—˜ë¶„ì•¼ + ê²€ì‚¬ëª©ì ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                    <div style="padding-top:24px">
                        <button type="button" disabled class="btn-receipt secondary" style="padding:9px 16px;font-size:13px;opacity:0.6;cursor:not-allowed" title="3ì›” êµ¬í˜„ ì˜ˆì •">ğŸ” APIì¡°íšŒ <span style="font-size:10px;color:#999">(3ì›”)</span></button>
                    </div>
                </div>
                <!-- ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ì„ íƒ (ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš© ì„ íƒ ì‹œ í‘œì‹œ) -->
                <div id="mfds-product-picker-container" style="display:none;margin:12px 0"></div>
                <!-- ì‹ì•½ì²˜ ê¸°ì¤€ê·œê²© ì‹œí—˜í•­ëª© (í’ˆëª©ì½”ë“œ ì„ íƒ ì‹œ í‘œì‹œ) -->
                <div id="mfds-std-section" style="display:none;margin:12px 0;padding:16px;background:#f0f7ff;border-radius:10px;border:1px solid #b3d4fc">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <label style="font-weight:600;font-size:14px;color:#1565c0">ğŸ“‹ ì‹ì•½ì²˜ ê¸°ì¤€ê·œê²© ì‹œí—˜í•­ëª©</label>
                        <span id="mfds-std-summary" style="font-size:13px;color:#667085"></span>
                    </div>
                    <div id="mfds-std-info" style="font-size:12px;color:#667085;margin-bottom:8px"></div>
                    <div style="overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:13px">
                            <thead>
                                <tr style="background:#e3f2fd;border-bottom:2px solid #90caf9">
                                    <th style="padding:8px 6px;width:30px;text-align:center"><input type="checkbox" id="mfds-std-check-all" onchange="toggleAllMfdsStdChecks(this)" title="ì „ì²´ ì„ íƒ"></th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:600;color:#1565c0;width:36px">No</th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:600;color:#1565c0">ì‹œí—˜í•­ëª©</th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:600;color:#1565c0;width:180px">ê¸°ì¤€ê·œê²©ê°’</th>
                                    <th style="padding:8px 10px;text-align:center;font-weight:600;color:#1565c0;width:100px">ë²”ìœ„(ìµœì†Œ~ìµœëŒ€)</th>
                                    <th style="padding:8px 10px;text-align:center;font-weight:600;color:#1565c0;width:60px">ë‹¨ìœ„</th>
                                    <th style="padding:8px 10px;text-align:right;font-weight:600;color:#1565c0;width:90px">ìˆ˜ìˆ˜ë£Œ(ì›)</th>
                                </tr>
                            </thead>
                            <tbody id="mfds-std-tbody"></tbody>
                            <tfoot id="mfds-std-tfoot" style="display:none">
                                <tr style="background:#e3f2fd;border-top:2px solid #90caf9">
                                    <td colspan="6" style="padding:8px 10px;font-weight:700;color:#1565c0;text-align:right">í•©ê³„</td>
                                    <td id="mfds-std-fee-total" style="padding:8px 10px;font-weight:700;color:#1565c0;text-align:right"></td>
                                </tr>
                                <tr style="background:#e3f2fd">
                                    <td colspan="6" style="padding:4px 10px;font-size:12px;color:#667085;text-align:right">ê³µê¸‰ê°€ì•¡</td>
                                    <td id="mfds-std-fee-supply" style="padding:4px 10px;font-size:12px;color:#667085;text-align:right"></td>
                                </tr>
                                <tr style="background:#e3f2fd">
                                    <td colspan="6" style="padding:4px 10px;font-size:12px;color:#667085;text-align:right">ì„¸ì•¡ (VAT 10%)</td>
                                    <td id="mfds-std-fee-vat" style="padding:4px 10px;font-size:12px;color:#667085;text-align:right"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div id="mfds-std-add-bar" style="display:none;margin-top:10px;text-align:center">
                        <button type="button" onclick="addStdItemsToInspection()" style="padding:8px 24px;background:#1565c0;color:#fff;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer">
                            â†“ ì„ íƒ í•­ëª©ì„ ì‹œí—˜í•­ëª©ì— ì¶”ê°€
                        </button>
                        <span id="mfds-std-check-count" style="margin-left:10px;font-size:12px;color:#667085"></span>
                    </div>
                </div>
                <!-- ì‹œí—˜í•­ëª© í…Œì´ë¸” -->
                <div id="inspection-items-section" style="display:none;margin:20px 0;padding:16px;background:#fafbfc;border-radius:10px;border:1px solid #e2e6ed">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <label style="font-weight:600;font-size:14px;color:#344054">ğŸ”¬ ì‹œí—˜í•­ëª©</label>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span id="inspection-items-summary" style="font-size:13px;color:#667085"></span>
                            <button type="button" id="delete-inspection-items-btn" onclick="deleteSelectedInspectionItems()" style="display:none;padding:4px 12px;font-size:12px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;border-radius:6px;cursor:pointer">ğŸ—‘ ì„ íƒ ì‚­ì œ</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto">
                        <table style="width:100%;border-collapse:collapse;font-size:13px">
                            <thead>
                                <tr style="background:#f8f9fc;border-bottom:2px solid #e0e0e0">
                                    <th style="padding:10px 6px;width:30px;text-align:center"><input type="checkbox" id="inspection-check-all" onchange="toggleAllInspectionChecks(this)" title="ì „ì²´ ì„ íƒ"></th>
                                    <th style="padding:10px 12px;text-align:left;font-weight:600;color:#344054;width:40px">No</th>
                                    <th style="padding:10px 12px;text-align:left;font-weight:600;color:#344054">ì‹œí—˜í•­ëª©</th>
                                    <th style="padding:10px 12px;text-align:left;font-weight:600;color:#344054;width:90px">ì‹œí—˜í•­ëª©ì½”ë“œ</th>
                                    <th style="padding:10px 12px;text-align:left;font-weight:600;color:#344054">ê¸°ì¤€ê·œê²©</th>
                                    <th style="padding:10px 12px;text-align:left;font-weight:600;color:#344054;width:70px">ë‹¨ìœ„</th>
                                    <th style="padding:10px 12px;text-align:right;font-weight:600;color:#344054;width:100px">ìˆ˜ìˆ˜ë£Œ</th>
                                </tr>
                            </thead>
                            <tbody id="inspection-items-tbody"></tbody>
                            <tfoot id="inspection-items-tfoot" style="display:none">
                                <tr style="background:#f0f4ff;border-top:2px solid #d0d5dd">
                                    <td colspan="6" style="padding:10px 12px;font-weight:700;color:#344054;text-align:right">í•©ê³„</td>
                                    <td id="inspection-items-total" style="padding:10px 12px;font-weight:700;color:#6941C6;text-align:right"></td>
                                </tr>
                                <tr style="background:#f0f4ff">
                                    <td colspan="6" style="padding:6px 12px;font-size:12px;color:#667085;text-align:right">ê³µê¸‰ê°€ì•¡</td>
                                    <td id="inspection-items-supply" style="padding:6px 12px;font-size:12px;color:#667085;text-align:right"></td>
                                </tr>
                                <tr style="background:#f0f4ff">
                                    <td colspan="6" style="padding:6px 12px;font-size:12px;color:#667085;text-align:right">ì„¸ì•¡ (VAT 10%)</td>
                                    <td id="inspection-items-vat" style="padding:6px 12px;font-size:12px;color:#667085;text-align:right"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ê²€ì²´ëŸ‰ <span class="required">*</span></label>
                        <div style="display:flex;gap:6px">
                            <input type="text" id="sample-amount" placeholder="ì˜ˆ: 500" required style="flex:1;min-width:0">
                            <select id="sample-amount-unit" style="width:70px;padding:12px 8px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="ml">ml</option>
                                <option value="L">L</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì²´ìˆ˜ <span class="required">*</span></label>
                        <input type="number" id="sample-count" placeholder="ì˜ˆ: 3" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>í¬ì¥ë‹¨ìœ„</label>
                        <input type="text" id="package-unit" placeholder="ì˜ˆ: ë³‘, íŒ©, ë´‰ì§€">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìš´ë°˜ìƒíƒœ</label>
                        <select id="transport-status">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ëƒ‰ì¥">â„ï¸ ëƒ‰ì¥</option>
                            <option value="ëƒ‰ë™">ğŸ§Š ëƒ‰ë™</option>
                            <option value="ì‹¤ì˜¨">ğŸŒ¡ï¸ ì‹¤ì˜¨</option>
                            <option value="ìƒì˜¨">ğŸ  ìƒì˜¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>í’ˆëª©ì œì¡°NO</label>
                        <input type="text" id="manufacture-no">
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr 1fr">
                    <div class="form-group">
                        <label>ì œì¡°ì¼ì</label>
                        <input type="date" id="manufacture-date" onchange="calcExpiryDate()">
                    </div>
                    <div class="form-group">
                        <label>ì†Œë¹„ê¸°í•œ</label>
                        <input type="date" id="expiry-date">
                    </div>
                    <div class="form-group">
                        <label>ì†Œë¹„ê¸°í•œ (ì¼ìˆ˜)</label>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-size:13px;color:#667085;white-space:nowrap">ì œì¡°ì¼ë¡œë¶€í„°</span>
                            <input type="text" id="expiry-days" placeholder="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');calcExpiryDate()" style="width:70px;text-align:center">
                            <span style="font-size:13px;color:#667085">ì¼</span>
                        </div>
                    </div>
                    <div class="form-group"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œë£Œìœ„ì¹˜</label>
                        <input type="text" id="sample-location" placeholder="ì˜ˆ: A-01">
                    </div>
                    <div class="form-group">
                        <label>ì‹œë£Œë°•ìŠ¤ë²ˆí˜¸</label>
                        <input type="text" id="sample-box-no">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="grid-column:1/-1">
                        <label>ë¹„ê³ </label>
                        <textarea id="remarks" rows="3" placeholder="ë¹„ê³  ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." oninput="markAsModified()" style="width:100%;padding:10px 12px;border:1px solid #d0d5dd;border-radius:8px;font-size:13px;resize:vertical"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. ìˆ˜ìˆ˜ë£Œì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ’° ìˆ˜ìˆ˜ë£Œì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <!-- ìˆ˜ìˆ˜ë£Œ ì´í•© -->
                <div id="fee-summary-section" style="margin-bottom:20px;padding:16px;background:#fafbfc;border-radius:10px;border:1px solid #e2e6ed">
                    <div style="font-weight:600;font-size:14px;color:#344054;margin-bottom:10px">ğŸ“Š ìˆ˜ìˆ˜ë£Œ ì´í•©</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                        <div style="text-align:center;padding:12px;background:#fff;border-radius:8px;border:1px solid #e2e6ed">
                            <div style="font-size:11px;color:#667085;margin-bottom:4px">ê³µê¸‰ê°€ì•¡</div>
                            <div id="fee-supply" style="font-size:18px;font-weight:700;color:#344054">0ì›</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:#fff;border-radius:8px;border:1px solid #e2e6ed">
                            <div style="font-size:11px;color:#667085;margin-bottom:4px">ì„¸ì•¡ (VAT 10%)</div>
                            <div id="fee-vat" style="font-size:18px;font-weight:700;color:#667085">0ì›</div>
                        </div>
                        <div style="text-align:center;padding:12px;background:#f0f4ff;border-radius:8px;border:1px solid #c7d2fe">
                            <div style="font-size:11px;color:#6941C6;margin-bottom:4px">ì´ê³„</div>
                            <div id="fee-total" style="font-size:20px;font-weight:800;color:#6941C6">0ì›</div>
                        </div>
                    </div>
                    <!-- í• ì¸ ì˜ì—­ -->
                    <div id="discount-section" style="margin-top:10px;padding:10px 14px;background:#fff8f0;border-radius:8px;border:1px solid #fed7aa;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <span style="font-size:13px;font-weight:600;color:#c2410c;white-space:nowrap">ğŸ·ï¸ í• ì¸</span>
                        <div style="display:flex;align-items:center;gap:4px">
                            <input type="number" id="discount-rate" min="0" max="100" step="1" placeholder="0"
                                   oninput="onDiscountRateChange()"
                                   style="width:55px;padding:6px 8px;border:1px solid #fed7aa;border-radius:6px;font-size:13px;text-align:right;background:#fff">
                            <span style="font-size:13px;color:#c2410c;font-weight:600">%</span>
                        </div>
                        <span style="color:#ccc;font-size:12px">ë˜ëŠ”</span>
                        <div style="display:flex;align-items:center;gap:4px">
                            <input type="number" id="discount-amount" min="0" step="1000" placeholder="0"
                                   oninput="onDiscountAmountChange()"
                                   style="width:100px;padding:6px 8px;border:1px solid #fed7aa;border-radius:6px;font-size:13px;text-align:right;background:#fff">
                            <span style="font-size:13px;color:#c2410c">ì›</span>
                        </div>
                        <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
                            <span style="font-size:12px;color:#667085">í• ì¸ ì ìš©ê°€</span>
                            <span id="discount-final" style="font-size:18px;font-weight:800;color:#c2410c">0ì›</span>
                        </div>
                    </div>
                </div>
                <!-- ê²°ì œë°©ë²• -->
                <div style="margin-bottom:16px">
                    <label style="font-weight:600;font-size:14px;color:#344054;display:block;margin-bottom:8px">ğŸ’³ ê²°ì œë°©ë²•</label>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px">
                        <label class="radio-label" style="padding:8px 14px;font-size:13px">
                            <input type="radio" name="pay-method" value="ì¹´ë“œ" onchange="togglePayMethod()"> ì¹´ë“œ
                        </label>
                        <label class="radio-label" style="padding:8px 14px;font-size:13px">
                            <input type="radio" name="pay-method" value="ì˜¨ë¼ì¸" onchange="togglePayMethod()"> ì˜¨ë¼ì¸
                        </label>
                        <label class="radio-label" style="padding:8px 14px;font-size:13px">
                            <input type="radio" name="pay-method" value="í˜„ê¸ˆ" onchange="togglePayMethod()"> í˜„ê¸ˆ
                        </label>
                    </div>
                    <!-- ì¹´ë“œ ì˜µì…˜ -->
                    <div id="pay-card-panel" style="display:none;padding:12px;background:#f8f9fb;border-radius:8px;border:1px solid #e2e6ed;margin-bottom:8px">
                        <div class="form-row" style="grid-template-columns:1fr 1fr">
                            <div class="form-group"><label>ê²°ì œì¼</label><input type="date" id="pay-card-date"></div>
                            <div class="form-group"></div>
                        </div>
                    </div>
                    <!-- ì˜¨ë¼ì¸ ì˜µì…˜ -->
                    <div id="pay-online-panel" style="display:none;padding:12px;background:#f8f9fb;border-radius:8px;border:1px solid #e2e6ed;margin-bottom:8px">
                        <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                            <div class="form-group"><label>ì…ê¸ˆì</label><input type="text" id="pay-depositor" placeholder="ì…ê¸ˆìëª…"></div>
                            <div class="form-group"><label>ì…ê¸ˆì€í–‰ ë° ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="pay-bank-account" placeholder="ì˜ˆ: êµ­ë¯¼ì€í–‰ 123-456-789"></div>
                            <div class="form-group"><label>ìƒëŒ€ì€í–‰</label><input type="text" id="pay-counter-bank" placeholder="ìƒëŒ€ì€í–‰ëª…"></div>
                        </div>
                    </div>
                    <!-- ë‚©ë¶€ì¼ -->
                    <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                        <div class="form-group"><label>ë‚©ë¶€ì¼</label><input type="date" id="pay-date"></div>
                        <div class="form-group"><label>ë¬¸ì„œë²ˆí˜¸</label><input type="text" id="document-no"></div>
                        <div class="form-group"></div>
                    </div>
                </div>
                <!-- ì…ê¸ˆ ë¶„í•  -->
                <div style="border-top:1px solid #e2e6ed;padding-top:16px">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
                        <label style="font-weight:600;font-size:14px;color:#344054">ğŸ§¾ ì…ê¸ˆ ë‚´ì—­</label>
                        <button type="button" class="btn-receipt secondary" onclick="addPaymentEntry()" style="padding:6px 14px;font-size:12px">+ ì…ê¸ˆ ì¶”ê°€</button>
                    </div>
                    <div id="payment-entries">
                        <!-- ì…ê¸ˆ ë‚´ì—­ì´ ì—¬ê¸°ì— ë™ì  ìƒì„± -->
                    </div>
                    <div id="payment-summary" style="display:none;margin-top:10px;padding:10px;background:#f0f4ff;border-radius:8px;text-align:right">
                        <span style="font-size:12px;color:#667085">ì…ê¸ˆí•©ê³„: </span>
                        <span id="payment-total" style="font-size:14px;font-weight:700;color:#6941C6">0ì›</span>
                        <span style="font-size:12px;color:#667085;margin-left:12px">ì”ì•¡: </span>
                        <span id="payment-remain" style="font-size:14px;font-weight:700;color:#e53935">0ì›</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. ê³„ì‚°ì„œ ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ§¾ ê³„ì‚°ì„œ ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <!-- ì‚¬ì—…ìë“±ë¡ì¦ ì •ë³´ (ì—…ì²´ ì„ íƒ ì‹œ ìë™ ì±„ì›€) -->
                <div class="form-row">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œì—…ì²´</label>
                        <input type="text" id="company-name" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                        <input type="text" id="business-no" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ëŒ€í‘œì</label>
                        <input type="text" id="ceo" readonly style="background:#e8f5e9">
                    </div>
                </div>
                <!-- ê³„ì‚°ì„œ ë‹´ë‹¹ ì •ë³´ (ì—…ì²´ ì„ íƒ ì‹œ ìë™ ì±„ì›€) -->
                <div class="form-row" style="grid-template-columns:repeat(5,1fr)">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œ ë‹´ë‹¹ì</label>
                        <input type="text" id="bill-name" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="tel" id="bill-phone" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>íŒ©ìŠ¤ë²ˆí˜¸</label>
                        <input type="tel" id="bill-fax" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>íœ´ëŒ€í°</label>
                        <input type="tel" id="bill-mobile" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="bill-email" readonly style="background:#e8f5e9">
                    </div>
                </div>

                <!-- ìˆ˜ì • ì²´í¬ë°•ìŠ¤ -->
                <div style="margin-bottom:15px">
                    <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
                        <input type="checkbox" id="bill-edit-check" onchange="toggleBillEdit()">
                        <span>ê³„ì‚°ì„œ ì…ë ¥ ì •ë³´ ìˆ˜ì •í•˜ê¸°</span>
                    </label>
                </div>

                <!-- ìˆ˜ì • ì…ë ¥ ì˜ì—­ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                <div id="bill-edit-area" style="display:none;border:1px dashed #bdbdbd;border-radius:8px;padding:16px;background:#fff8e1;margin-bottom:16px">
                    <div class="form-row" style="grid-template-columns:repeat(4,1fr)">
                        <div class="form-group">
                            <label>ê³„ì‚°ì„œì—…ì²´ëª…</label>
                            <input type="text" id="bill-edit-company">
                        </div>
                        <div class="form-group">
                            <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                            <input type="text" id="bill-edit-bizno">
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹ì</label>
                            <input type="text" id="bill-edit-name">
                        </div>
                        <div class="form-group">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" id="bill-edit-phone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="bill-edit-email">
                        </div>
                    </div>
                </div>

                <!-- ë°œí–‰ ì˜µì…˜ -->
                <div class="form-row">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œ ë°œí–‰ì¼</label>
                        <select id="billing-date-type" onchange="onBillingDateTypeChange()">
                            <option value="receipt">ì ‘ìˆ˜ì¼</option>
                            <option value="specific">íŠ¹ì •ì¼</option>
                            <option value="monthEnd">ì›”ë§ ë°œí–‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>íŠ¹ì •ì¼</label>
                        <input type="date" id="billing-date" style="display:none">
                    </div>
                    <div class="form-group">
                        <label>ë°œí–‰ ìœ í˜•</label>
                        <select id="billing-type" onchange="onBillingTypeChange()">
                            <option value="byPurpose">ëª©ì ë³„ êµ¬ë¶„ ë°œí–‰</option>
                            <option value="combined">í•©ì‚° ë°œí–‰</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="billing-type-note-row" style="display:none">
                    <div class="form-group">
                        <label>ê¸°íƒ€ ë‚´ìš©</label>
                        <textarea id="billing-type-note" rows="2" placeholder="ê¸°íƒ€ ë°œí–‰ ë°©ì‹ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. íŒ€ë³„ ë©”ëª¨ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ“ íŒ€ë³„ ë©”ëª¨</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="team-memo customer-support">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’™ ê³ ê°ì§€ì›íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="customer-lock">ğŸ”“ í¸ì§‘ ê°€ëŠ¥</span>
                    </div>
                    <textarea id="memo-customer" rows="4" placeholder="ê³ ê°ì§€ì›íŒ€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="markAsModified()"></textarea>
                </div>
                <div class="team-memo quality">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’š í’ˆì§ˆë³´ì¦íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="quality-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-quality" rows="4" placeholder="í’ˆì§ˆë³´ì¦íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">í’ˆì§ˆë³´ì¦íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo finance">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ§¡ ì¬ë¬´íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="finance-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-finance" rows="4" placeholder="ì¬ë¬´íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">ì¬ë¬´íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo marketing">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’— ë§ˆì¼€íŒ…íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="marketing-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-marketing" rows="4" placeholder="ë§ˆì¼€íŒ…íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">ë§ˆì¼€íŒ…íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo sales" style="border-left-color:#ff9800">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ“¢ ë§¤ì¶œë¶€ì„œ ìš”ì²­ì‚¬í•­</span>
                        <span class="team-memo-lock" id="sales-lock">ğŸ”“ í¸ì§‘ ê°€ëŠ¥</span>
                    </div>
                    <textarea id="memo-sales" rows="4" placeholder="ë§¤ì¶œë¶€ì„œ ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." oninput="markAsModified()"></textarea>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="buttons">
            <button type="button" class="btn-receipt secondary" onclick="saveDraft()">
                ğŸ’¾ ì„ì‹œì €ì¥
            </button>
            <button type="button" class="btn-receipt save" id="save-btn" onclick="saveReceipt()">
                ğŸ’¾ ì €ì¥
            </button>
            <button type="submit" class="btn-receipt primary">
                âœ… ì ‘ìˆ˜ ì™„ë£Œ
            </button>
            <button type="button" class="btn-receipt cancel" onclick="resetForm()">
                âŒ ì·¨ì†Œ
            </button>
        </div>
    </form>
</div>
</main>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================================
// API ì„¤ì •
// ============================================================================
const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://127.0.0.1:5001' : '';
let apiOnline = false;

// ============================================================================
// OCR í”„ë¡ì‹œ ì„¤ì • (ì˜ë¢°ì„œ OCR)
// ============================================================================
var OCR_PROXY_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:')
    ? 'https://127.0.0.1:5002'
    : '/ocr';
var _receiptOcrFile = null;

// PDFâ†’JPEG ë³€í™˜ (PDF.js ì‚¬ìš©)
function convertPdfToJpegBase64(file) {
    return new Promise(function(resolve, reject) {
        var ext = file.name.split('.').pop().toLowerCase();
        if (ext !== 'pdf') {
            var reader = new FileReader();
            reader.onload = function(e) {
                var base64 = e.target.result.split(',')[1];
                if (ext === 'jpg' || ext === 'jpeg') ext = 'jpg';
                else if (ext === 'png') ext = 'png';
                else ext = 'jpg';
                resolve({ base64: base64, format: ext });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
            return;
        }
        if (!window.pdfjsLib) { reject(new Error('PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨')); return; }
        var reader2 = new FileReader();
        reader2.onload = function(e) {
            var typedArray = new Uint8Array(e.target.result);
            pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                pdf.getPage(1).then(function(page) {
                    var scale = 2.0;
                    var viewport = page.getViewport({ scale: scale });
                    var canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    var ctx = canvas.getContext('2d');
                    page.render({ canvasContext: ctx, viewport: viewport }).promise.then(function() {
                        var jpegBase64 = canvas.toDataURL('image/jpeg', 0.92).split(',')[1];
                        resolve({ base64: jpegBase64, format: 'jpg' });
                    }).catch(reject);
                }).catch(reject);
            }).catch(reject);
        };
        reader2.onerror = reject;
        reader2.readAsArrayBuffer(file);
    });
}

// OCR fetch ì—ëŸ¬ ì²˜ë¦¬ (SSL ì¸ì¦ì„œ ë¬¸ì œ ë“±)
function handleOcrFetchError(err, statusEl, btnEl) {
    if (btnEl) { btnEl.textContent = 'ğŸ¤– ì˜ë¢°ì„œ OCR'; btnEl.disabled = false; }
    if (err.message === 'Failed to fetch') {
        var healthUrl = OCR_PROXY_BASE + '/api/ocr/health';
        if (statusEl) {
            statusEl.innerHTML = 'âŒ OCR ì„œë²„ ì—°ê²° ì‹¤íŒ¨. <a href="' + healthUrl + '" target="_blank" style="color:#1565c0;text-decoration:underline;">ì—¬ê¸°ë¥¼ í´ë¦­</a>í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìˆ˜ë½í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
            statusEl.style.color = '#c62828';
        }
        showToast('âŒ OCR ì„œë²„ ì—°ê²° ì‹¤íŒ¨ â€” ì¸ì¦ì„œ ìˆ˜ë½ì´ í•„ìš”í•©ë‹ˆë‹¤');
        window.open(healthUrl, '_blank');
    } else {
        if (statusEl) {
            statusEl.textContent = 'âŒ OCR ì˜¤ë¥˜: ' + err.message;
            statusEl.style.color = '#c62828';
        }
        showToast('âŒ OCR ì‹¤íŒ¨: ' + err.message);
    }
}

// ì˜ë¢°ì„œ íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
function handleReceiptOcrFile(file) {
    if (!file) return;
    _receiptOcrFile = file;
    document.getElementById('receiptOcrFileName').textContent = 'ğŸ“‹ ' + file.name + ' (' + (file.size / 1024).toFixed(1) + 'KB)';
    document.getElementById('receiptOcrBtn').disabled = false;
    document.getElementById('receiptOcrStatus').textContent = '';
}

// ì˜ë¢°ì„œ OCR ì‹¤í–‰
async function runReceiptOCR() {
    if (!_receiptOcrFile) return;
    var btn = document.getElementById('receiptOcrBtn');
    var status = document.getElementById('receiptOcrStatus');
    btn.disabled = true;
    btn.textContent = 'â³ ë¶„ì„ ì¤‘...';
    status.textContent = 'Claude Visionìœ¼ë¡œ ì˜ë¢°ì„œ ë¶„ì„ ì¤‘... (5~10ì´ˆ ì†Œìš”)';
    status.style.color = '#1565c0';

    try {
        var imgData = await convertPdfToJpegBase64(_receiptOcrFile);
        var payload = {
            images: [{ format: imgData.format, name: _receiptOcrFile.name, data: imgData.base64 }]
        };

        var resp = await fetch(OCR_PROXY_BASE + '/api/ocr/inspection-form', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            var errBody = await resp.json().catch(function() { return {}; });
            throw new Error(errBody.error || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + resp.status);
        }

        var result = await resp.json();

        try {
            fillFormFromOcrResult(result);
        } catch (fillErr) {
            console.error('[OCR] í¼ ìë™ì…ë ¥ ì¤‘ ì˜¤ë¥˜:', fillErr);
            status.textContent = 'âš ï¸ ì¸ì‹ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ì¼ë¶€ í•„ë“œ ì…ë ¥ ì‹¤íŒ¨: ' + fillErr.message;
            status.style.color = '#e65100';
            btn.textContent = 'ğŸ¤– ì˜ë¢°ì„œ OCR';
            btn.disabled = false;
            showToast('âš ï¸ OCR ì¸ì‹ ì™„ë£Œ â€” ì¼ë¶€ í•„ë“œ ìˆ˜ë™ í™•ì¸ í•„ìš”');
            return;
        }

        status.textContent = 'âœ… ì˜ë¢°ì„œ ì¸ì‹ ì™„ë£Œ! ì´ˆë¡ìƒ‰ í‘œì‹œëœ í•„ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.';
        status.style.color = '#2e7d32';
        btn.textContent = 'ğŸ¤– ì˜ë¢°ì„œ OCR';
        btn.disabled = false;
        showToast('âœ… ì˜ë¢°ì„œ OCR ì™„ë£Œ â€” ìë™ì…ë ¥ëœ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”');
    } catch (err) {
        handleOcrFetchError(err, status, btn);
        btn.textContent = 'ğŸ¤– ì˜ë¢°ì„œ OCR';
    }
}

// ê²€ì‚¬ëª©ì  ë¶€ë¶„ë§¤ì¹­
function matchTestPurpose(ocrText) {
    if (!ocrText) return null;
    var t = ocrText.trim();
    // 1) ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” optionì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
    var sel = document.getElementById('test-purpose');
    if (sel) {
        var opts = sel.querySelectorAll('option');
        for (var i = 0; i < opts.length; i++) {
            if (opts[i].value && opts[i].value === t) return t;
        }
    }
    // 2) í‚¤ì›Œë“œ ë¶€ë¶„ ë§¤ì¹­ (ìš°ì„ ìˆœìœ„ ìˆœì„œ)
    var purposeMap = [
        ['ìê°€í’ˆì§ˆìœ„íƒ', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©'],
        ['ìê°€í’ˆì§ˆ', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©'],
        ['ìœ„íƒê²€ì‚¬', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©'],
        ['í’ˆì§ˆê²€ì‚¬', 'í’ˆì§ˆê²€ì‚¬(ì˜ë¢°)'],
        ['ìˆ˜ì…ì‹í’ˆ', 'ìˆ˜ì…ì‹í’ˆê²€ì‚¬'],
        ['ìœ„ìƒê²€ì‚¬', 'ìœ„ìƒê²€ì‚¬'],
        ['ìœ í†µì‹í’ˆ', 'ìœ í†µì‹í’ˆê²€ì‚¬'],
        ['ìˆ˜ê±°ê²€ì‚¬', 'ìˆ˜ê±°ê²€ì‚¬'],
        ['ì¬ê²€ì‚¬', 'ì¬ê²€ì‚¬'],
        ['ì´ì˜ì‹ ì²­', 'ì´ì˜ì‹ ì²­ê²€ì‚¬'],
        ['ì”ë¥˜ë†ì•½', 'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)'],
        ['ì˜ì–‘ì„±ë¶„', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)'],
        ['ì†Œë¹„ê¸°í•œì„¤ì •', 'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)'],
        ['ì†Œë¹„ê¸°í•œ', 'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)'],
        ['ê¸°ì¤€ê·œê²©ì™¸', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)'],
        ['ê¸°ì¤€ê·œê²©', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)'],
        ['Allergen', 'Allergen(RT-PCR)'],
        ['ì•Œë ˆë¥´ê²', 'Allergen(RT-PCR)'],
        ['RT-PCR', 'Allergen(RT-PCR)'],
        ['ELISA', 'Allergen(ELISA)'],
        ['ì—°êµ¬ìš©ì—­', 'ì—°êµ¬ìš©ì—­'],
        ['í•­ìƒë¬¼ì§ˆ', 'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)']
    ];
    for (var j = 0; j < purposeMap.length; j++) {
        if (t.indexOf(purposeMap[j][0]) !== -1) return purposeMap[j][1];
    }
    // 3) ìµœì¢…: option í…ìŠ¤íŠ¸ì— ë¶€ë¶„ í¬í•¨ ì—¬ë¶€
    if (sel) {
        var opts2 = sel.querySelectorAll('option');
        for (var k = 0; k < opts2.length; k++) {
            if (opts2[k].value && (opts2[k].value.indexOf(t) !== -1 || t.indexOf(opts2[k].value) !== -1)) return opts2[k].value;
        }
    }
    return null;
}

// custom-select UI ë™ê¸°í™”
function syncCustomSelect(selectId, value) {
    var textSpan = document.querySelector('#' + selectId + '-display .custom-select-text');
    if (textSpan) textSpan.textContent = value;
    document.querySelectorAll('.custom-select-option').forEach(function(o) {
        o.classList.toggle('selected', o.dataset.value === value);
    });
}

// OCR ì…ë ¥ í•„ë“œ í•˜ì´ë¼ì´íŠ¸
function highlightOcrFields(fieldIds) {
    fieldIds.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
            el.style.background = '#e8f5e9';
            el.style.borderColor = '#66bb6a';
            setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 8000);
        }
    });
}

// ì—…ì²´ ë¯¸ë§¤ì¹­ ì‹œ OCR ì—°ë½ì²˜ë¥¼ í¼ì— ì§ì ‘ ì…ë ¥
function _fillCompanyContactFromOcr(result) {
    try {
        if (result.phone) {
            var el = document.getElementById('company-phone');
            if (el) { el.value = result.phone; el.style.background = '#e8f5e9'; }
        }
        if (result.fax) {
            var el2 = document.getElementById('company-fax');
            if (el2) { el2.value = result.fax; el2.style.background = '#e8f5e9'; }
        }
        if (result.mobile) {
            var el3 = document.getElementById('company-mobile');
            if (el3) { el3.value = result.mobile; el3.style.background = '#e8f5e9'; }
        }
        if (result.address) {
            var el4 = document.getElementById('company-address');
            if (el4) { el4.value = result.address; el4.style.background = '#e8f5e9'; }
        }
        console.log('[OCR] ì—…ì²´ ì—°ë½ì²˜ ì§ì ‘ ì…ë ¥:', result.phone, result.fax, result.address);
    } catch(e) { console.warn('[OCR] ì—°ë½ì²˜ ì§ì ‘ ì…ë ¥ ì˜¤ë¥˜:', e.message); }
}

// í•µì‹¬: OCR ê²°ê³¼ â†’ í¼ ìë™ì…ë ¥
function fillFormFromOcrResult(result) {
    var filledFields = [];
    var skippedFields = [];  // PIN ì ê¸ˆìœ¼ë¡œ ê±´ë„ˆë›´ í•„ë“œëª…
    console.log('[OCR] ì¸ì‹ ê²°ê³¼:', JSON.stringify(result, null, 2));

    // [0] PIN ì ê¸ˆ ì²´í¬ â€” ì ê¸ˆ ì‹œ í•´ì œ ì—¬ë¶€ë¥¼ ì‚¬ìš©ìì—ê²Œ í™•ì¸
    var pinTestField = document.getElementById('pin-test-field');
    var isTestFieldLocked = pinTestField && pinTestField.checked;
    // ì ê¸ˆ ìƒíƒœì´ê³  OCR ê°’ì´ ìˆìœ¼ë©´ í•´ì œ ì—¬ë¶€ í™•ì¸
    if (isTestFieldLocked && (result.testField || result.testPurpose)) {
        var currentField = document.querySelector('input[name="test-field"]:checked')?.value || '';
        var ocrField = (result.testField || '').trim();
        var ocrPurpose = result.testPurpose || '';
        var msg = 'ğŸ”’ ì‹œí—˜ë¶„ì•¼/ê²€ì‚¬ëª©ì ì´ ì ê¸ˆ ìƒíƒœì…ë‹ˆë‹¤.\n\n';
        if (ocrField) msg += 'í˜„ì¬ ì‹œí—˜ë¶„ì•¼: ' + currentField + ' â†’ OCR ì¸ì‹: ' + ocrField + '\n';
        if (ocrPurpose) msg += 'OCR ê²€ì‚¬ëª©ì : ' + ocrPurpose + '\n';
        msg += '\nì ê¸ˆì„ í•´ì œí•˜ê³  OCR ê°’ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
        if (confirm(msg)) {
            isTestFieldLocked = false;
            // PIN ì²´í¬ë°•ìŠ¤ í•´ì œ + UI ì—…ë°ì´íŠ¸
            pinTestField.checked = false;
            var pinLabel = pinTestField.closest('.pin-check');
            if (pinLabel) { pinLabel.classList.remove('active'); var ico = pinLabel.querySelector('.pin-icon'); if (ico) ico.textContent = 'ğŸ”“'; }
            // localStorageì—ì„œë„ ì œê±°
            var pins = getPinnedFields();
            delete pins['test-field'];
            delete pins['_test-field-via-purpose'];
            delete pins['test-purpose'];
            localStorage.setItem('bfl_pinned_fields', JSON.stringify(pins));
            console.log('[OCR] ì‹œí—˜ë¶„ì•¼ PIN ì ê¸ˆ í•´ì œë¨ (ì‚¬ìš©ì í™•ì¸)');
        }
    }

    // â‘  ì‹œí—˜ë¶„ì•¼ ì„¤ì •
    try {
        if (result.testField) {
            if (isTestFieldLocked) {
                skippedFields.push('ì‹œí—˜ë¶„ì•¼');
                console.log('[OCR] ì‹œí—˜ë¶„ì•¼ PIN ì ê¸ˆ ìœ ì§€ â†’ ê±´ë„ˆëœ€');
            } else {
                var fieldVal = result.testField.trim();
                var radios = document.querySelectorAll('input[name="test-field"]');
                radios.forEach(function(r) {
                    if (r.value === fieldVal || (fieldVal === 'ì‹í’ˆ' && r.value === 'ì‹í’ˆ') || (fieldVal === 'ì¶•ì‚°' && r.value === 'ì¶•ì‚°')) {
                        r.checked = true;
                        r.dispatchEvent(new Event('change', {bubbles: true}));
                        console.log('[OCR] ì‹œí—˜ë¶„ì•¼ ì„¤ì •:', fieldVal);
                    }
                });
            }
        }
    } catch(e) { console.warn('[OCR] ì‹œí—˜ë¶„ì•¼ ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘¡ ê²€ì‚¬ëª©ì  ë§¤ì¹­
    try {
        if (result.testPurpose) {
            if (isTestFieldLocked) {
                skippedFields.push('ê²€ì‚¬ëª©ì ');
                console.log('[OCR] ê²€ì‚¬ëª©ì  PIN ì ê¸ˆ ìœ ì§€ â†’ ê±´ë„ˆëœ€');
            } else {
                var matched = matchTestPurpose(result.testPurpose);
                console.log('[OCR] ê²€ì‚¬ëª©ì  ë§¤ì¹­:', result.testPurpose, 'â†’', matched);
                if (matched) {
                    var sel = document.getElementById('test-purpose');
                    if (sel) {
                        sel.value = matched;
                        syncCustomSelect('test-purpose', matched);
                        onTestPurposeChange();
                        filledFields.push('test-purpose');
                    }
                }
            }
        }
    } catch(e) { console.warn('[OCR] ê²€ì‚¬ëª©ì  ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘¢ ì—…ì²´ ê²€ìƒ‰ (Firestore ë§¤ì¹­ + ë¯¸ë§¤ì¹­ ì‹œ ì—°ë½ì²˜ ì§ì ‘ ì…ë ¥)
    try {
        if (result.companyName) {
            var compEl = document.getElementById('company-search');
            if (compEl) {
                compEl.value = result.companyName;
                compEl.readOnly = false;
                searchCompany(result.companyName, function(found) {
                    if (!found) {
                        showToast('âš ï¸ ë§¤ì¹­ ì—…ì²´ ì—†ìŒ: "' + result.companyName + '" â€” ì—°ë½ì²˜ ì§ì ‘ ì…ë ¥', 'warning');
                        // ì—…ì²´ ë¯¸ë§¤ì¹­ ì‹œ OCR ì—°ë½ì²˜ë¥¼ í¼ì— ì§ì ‘ ì…ë ¥
                        _fillCompanyContactFromOcr(result);
                    }
                });
                filledFields.push('company-search');
            }
        } else {
            // ì—…ì²´ëª… ë¹„ì–´ìˆì–´ë„ ì—°ë½ì²˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì§ì ‘ ì…ë ¥
            if (result.phone || result.fax || result.address) {
                _fillCompanyContactFromOcr(result);
            }
        }
    } catch(e) { console.warn('[OCR] ì—…ì²´ê²€ìƒ‰ ì˜¤ë¥˜:', e.message); }

    // â‘£ ì„±ì ì„œ ë°œì†¡ ë°©ë²•
    try {
        if (result.reportSend && result.reportSend.length) {
            document.querySelectorAll('input[name="report-send"]').forEach(function(cb) { cb.checked = false; });
            result.reportSend.forEach(function(method) {
                var m = method.replace(/\s/g, '');  // ê³µë°± ì œê±°
                document.querySelectorAll('input[name="report-send"]').forEach(function(chip) {
                    if (chip.value.indexOf(m) !== -1 || m.indexOf(chip.value) !== -1 ||
                        (m.indexOf('ìš°í¸') !== -1 && chip.value === 'ìš°í¸') ||
                        (m.indexOf('íŒ©ìŠ¤') !== -1 && chip.value.indexOf('íŒ©ìŠ¤') !== -1) ||
                        (m.indexOf('ë©”ì¼') !== -1 && chip.value.indexOf('ë©”ì¼') !== -1) ||
                        (m.indexOf('ì„ ë°œì†¡') !== -1 && chip.value === 'ì„ ë°œì†¡')) {
                        chip.checked = true;
                    }
                });
            });
            if (typeof toggleReportSendOption === 'function') toggleReportSendOption();
        }
    } catch(e) { console.warn('[OCR] ì„±ì ì„œ ë°œì†¡ ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘¤ íŒ©ìŠ¤/ì´ë©”ì¼ ìˆ˜ë ¹ ì •ë³´
    try {
        if (result.reportSendFax) {
            var faxInput = document.getElementById('report-fax-no');
            if (faxInput) { faxInput.value = result.reportSendFax; filledFields.push('report-fax-no'); }
        }
        if (result.reportSendEmail) {
            var emailInput = document.getElementById('report-email');
            if (emailInput) { emailInput.value = result.reportSendEmail; filledFields.push('report-email'); }
        }
    } catch(e) { console.warn('[OCR] íŒ©ìŠ¤/ì´ë©”ì¼ ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘¥ ê³„ì‚°ì„œ ë°œí–‰ì¼ ì •ë³´ (NEW)
    try {
        if (result.billingInfo) {
            var bdt = result.billingInfo.billingDateType;
            if (bdt) {
                var bdtMap = {'ì ‘ìˆ˜ì¼':'receipt', 'ì›”ë§':'monthEnd', 'receipt':'receipt', 'monthEnd':'monthEnd', 'specific':'specific'};
                var bdtVal = bdtMap[bdt] || '';
                // ë‚ ì§œ í˜•ì‹ì´ë©´ specific
                if (!bdtVal && /\d{4}[-\/]\d{2}[-\/]\d{2}/.test(bdt)) {
                    bdtVal = 'specific';
                    result.billingInfo.billingDate = bdt;
                }
                if (bdtVal) {
                    var bdtSel = document.getElementById('billing-date-type');
                    if (bdtSel) {
                        bdtSel.value = bdtVal;
                        if (typeof onBillingDateTypeChange === 'function') onBillingDateTypeChange();
                        filledFields.push('billing-date-type');
                    }
                }
            }
            if (result.billingInfo.billingDate) {
                var bdInput = document.getElementById('billing-date');
                if (bdInput) {
                    bdInput.value = result.billingInfo.billingDate;
                    bdInput.style.display = '';
                    filledFields.push('billing-date');
                }
            }
        }
    } catch(e) { console.warn('[OCR] ê³„ì‚°ì„œ ì •ë³´ ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘¦ ì‹œë£Œ ì •ë³´ (í¬ì¥ë‹¨ìœ„ íŒŒì‹± ê°œì„  + ê²€ì²´ìˆ˜ ê¸°ë³¸ê°’ 1)
    try {
        if (result.samples && result.samples.length) {
            var sampleCount = result.samples.length;
            var countEl = document.getElementById('sample-total-count');
            if (countEl) {
                countEl.value = sampleCount;
                updateSampleCount(sampleCount);
            }

            result.samples.forEach(function(sample, idx) {
                _currentSampleIdx = idx;
                loadSampleFromArray(idx);

                // ì œí’ˆëª…
                if (sample.productName) {
                    var pn = document.getElementById('product-name');
                    if (pn) { pn.value = sample.productName; filledFields.push('product-name'); }
                }
                // ê²€ì²´ìœ í˜• (food-type-input + food-type-value)
                if (sample.foodType) {
                    var ftInput = document.getElementById('food-type-input');
                    var ftValue = document.getElementById('food-type-value');
                    if (ftInput) {
                        ftInput.value = sample.foodType;
                        ftInput.disabled = false;
                        filledFields.push('food-type-input');
                    }
                    if (ftValue) { ftValue.value = sample.foodType; }
                    if (typeof searchFoodType === 'function') {
                        try { searchFoodType(sample.foodType); } catch(e2) {}
                    }
                }
                // ìš´ë°˜ìƒíƒœ
                if (sample.transportStatus) {
                    var ts = document.getElementById('transport-status');
                    if (ts) {
                        var tsMap = {'ëƒ‰ì¥':'ëƒ‰ì¥','ëƒ‰ë™':'ëƒ‰ë™','ì‹¤ì˜¨':'ì‹¤ì˜¨','ìƒì˜¨':'ìƒì˜¨','å†·è”µ':'ëƒ‰ì¥','å†·å‡':'ëƒ‰ë™'};
                        ts.value = tsMap[sample.transportStatus] || sample.transportStatus;
                        filledFields.push('transport-status');
                    }
                }
                // í’ˆëª©ì œì¡°NO
                if (sample.manufactureNo) {
                    var mn = document.getElementById('manufacture-no');
                    if (mn) { mn.value = sample.manufactureNo; filledFields.push('manufacture-no'); }
                }
                // ì œì¡°ì¼ì
                if (sample.manufactureDate) {
                    var md = document.getElementById('manufacture-date');
                    if (md) { md.value = sample.manufactureDate; filledFields.push('manufacture-date'); }
                }
                // ì†Œë¹„ê¸°í•œ
                if (sample.expiryDate) {
                    var ed = document.getElementById('expiry-date');
                    if (ed) { ed.value = sample.expiryDate; filledFields.push('expiry-date'); }
                }
                // ì†Œë¹„ê¸°í•œ ì¼ìˆ˜
                if (sample.expiryDays) {
                    var edDays = document.getElementById('expiry-days');
                    if (edDays) {
                        edDays.value = String(sample.expiryDays).replace(/[^0-9]/g, '');
                        filledFields.push('expiry-days');
                        if (sample.manufactureDate && typeof calcExpiryDate === 'function') {
                            try { calcExpiryDate(); } catch(e2) {}
                        }
                    }
                }

                // ê²€ì²´ëŸ‰/ë‹¨ìœ„/í¬ì¥ë‹¨ìœ„ â€” parseSampleAmountInfo ì‚¬ìš©
                var amountText = sample.sampleAmount || sample.packageUnit || '';
                if (amountText && typeof parseSampleAmountInfo === 'function') {
                    var parsed = parseSampleAmountInfo(sample);
                    if (parsed.amount) {
                        var saEl = document.getElementById('sample-amount');
                        if (saEl) { saEl.value = parsed.amount; filledFields.push('sample-amount'); }
                    }
                    if (parsed.unit) {
                        var unitEl = document.getElementById('sample-amount-unit');
                        if (unitEl) { unitEl.value = parsed.unit; }
                    }
                    if (parsed.packageUnit) {
                        var puEl = document.getElementById('package-unit');
                        if (puEl) { puEl.value = parsed.packageUnit; filledFields.push('package-unit'); }
                    }
                    // parseSampleAmountInfoì—ì„œ ê²€ì²´ìˆ˜ë„ íŒŒì‹±ëœ ê²½ìš° ë°˜ì˜
                    if (parsed.sampleCount) {
                        var scParsed = document.getElementById('sample-count');
                        if (scParsed) { scParsed.value = parsed.sampleCount; filledFields.push('sample-count'); }
                    }
                } else {
                    // parseSampleAmountInfo ë¯¸ì‚¬ìš© ì‹œ ê¸°ì¡´ ë°©ì‹ ìœ ì§€
                    if (sample.sampleAmount) {
                        var sa = document.getElementById('sample-amount');
                        if (sa) { sa.value = sample.sampleAmount; filledFields.push('sample-amount'); }
                    }
                    if (sample.sampleAmountUnit) {
                        var unitEl2 = document.getElementById('sample-amount-unit');
                        if (unitEl2) {
                            var unitMap = { 'g': 'g', 'kg': 'kg', 'ml': 'ml', 'mL': 'ml', 'L': 'L', 'l': 'L', 'ea': 'ea', 'ê°œ': 'ea' };
                            unitEl2.value = unitMap[sample.sampleAmountUnit] || 'g';
                        }
                    }
                    if (sample.packageUnit) {
                        var pu = document.getElementById('package-unit');
                        if (pu) { pu.value = sample.packageUnit; filledFields.push('package-unit'); }
                    }
                }

                // ê²€ì²´ìˆ˜ (íŒŒì‹± ì•ˆ ëœ ê²½ìš°ë§Œ ê¸°ë³¸ê°’ 1)
                var scEl = document.getElementById('sample-count');
                if (scEl && !scEl.value) {
                    scEl.value = sample.sampleCount || '1';
                    filledFields.push('sample-count');
                }

                // ê²€ì‚¬í•­ëª© (OCRì—ì„œ ì½ì€ í…ìŠ¤íŠ¸ â€” ë‚˜ì¤‘ì— í•„í„°ë§ì— ì‚¬ìš©)
                if (sample.inspectionItems) {
                    console.log('[OCR] ì‹œë£Œ ' + (idx+1) + ' ê²€ì‚¬í•­ëª©:', sample.inspectionItems);
                }

                saveSampleToArray();
            });

            // ì²« ë²ˆì§¸ ì‹œë£Œë¡œ ëŒì•„ê°€ê¸°
            _currentSampleIdx = 0;
            loadSampleFromArray(0);
            renderSampleNav();
        }
    } catch(e) { console.warn('[OCR] ì‹œë£Œì •ë³´ ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘§ ë¹„ê³  (ì˜ë¢°ì„œ ë¹„ê³  + ê²€ì‚¬í•­ëª© ì°¸ì¡°ìš© ì¶”ê°€)
    try {
        var remarksParts = [];
        if (result.remarks) remarksParts.push(result.remarks);
        if (result.samples && result.samples.length) {
            result.samples.forEach(function(sample, idx) {
                if (sample.inspectionItems) {
                    var prefix = result.samples.length > 1 ? '[ì‹œë£Œ' + (idx+1) + '] ' : '';
                    remarksParts.push(prefix + 'ê²€ì‚¬í•­ëª©(OCR): ' + sample.inspectionItems);
                }
            });
        }
        if (remarksParts.length) {
            var remarksEl = document.getElementById('remarks');
            if (remarksEl) {
                remarksEl.value = remarksParts.join('\n');
                filledFields.push('remarks');
            }
        }
    } catch(e) { console.warn('[OCR] ë¹„ê³  ì„¤ì • ì˜¤ë¥˜:', e.message); }

    // â‘¨ ê²€ì‚¬í•­ëª© OCR í•„í„°ë§ â€” ë¯¸ë§¤ì¹­ í•­ëª© ìë™ ì²´í¬ (ì‚­ì œ ë²„íŠ¼ë§Œ ëˆ„ë¥´ë©´ ë¨)
    try {
        var ocrItemNames = [];
        if (result.samples && result.samples.length) {
            result.samples.forEach(function(sample) {
                if (sample.inspectionItems) {
                    // ë¨¼ì € ê´„í˜¸ ë‚´ìš© ì œê±° í›„ ë¶„ë¦¬ (ê´„í˜¸ ì•ˆ ì½¤ë§ˆë¡œ ì˜ëª» ë¶„ë¦¬ë˜ëŠ” ê²ƒ ë°©ì§€)
                    var cleanedRaw = cleanInspectionItemName(sample.inspectionItems);
                    var items = cleanedRaw.split(/[,\/\n]+/).map(function(s) { return s.trim(); }).filter(Boolean);
                    items.forEach(function(item) {
                        if (item && ocrItemNames.indexOf(item) === -1) ocrItemNames.push(item);
                    });
                }
            });
        }
        if (ocrItemNames.length > 0) {
            setTimeout(function() {
                var tableRows = document.querySelectorAll('#inspection-items-tbody tr');
                if (tableRows.length === 0) return;

                var checkedCount = 0;
                tableRows.forEach(function(row) {
                    var nameCell = row.querySelector('td:nth-child(3)');
                    var checkbox = row.querySelector('td:first-child input[type="checkbox"]');
                    if (!nameCell || !checkbox) return;
                    var tName = cleanInspectionItemName(nameCell.textContent.trim());
                    var found = ocrItemNames.some(function(ocrName) {
                        return tName.indexOf(ocrName) !== -1 || ocrName.indexOf(tName) !== -1;
                    });
                    if (!found) {
                        // OCRì— ì—†ëŠ” í•­ëª© â†’ ìë™ ì²´í¬
                        checkbox.checked = true;
                        checkedCount++;
                    }
                });

                if (checkedCount > 0) {
                    // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                    if (typeof onInspectionCheckChange === 'function') onInspectionCheckChange();
                    showToast('ğŸ“‹ ì˜ë¢°ì„œì— ì—†ëŠ” ' + checkedCount + 'ê°œ í•­ëª© ì„ íƒë¨ â€” [ì„ íƒ ì‚­ì œ] ë²„íŠ¼ìœ¼ë¡œ ì œê±°í•˜ì„¸ìš”', 'info');
                }
            }, 1500);
        }
    } catch(e) { console.warn('[OCR] ê²€ì‚¬í•­ëª© í•„í„° ì˜¤ë¥˜:', e.message); }

    // â‘© í•˜ì´ë¼ì´íŠ¸
    highlightOcrFields(filledFields);

    // â‘ª PIN ì ê¸ˆ ì•ˆë‚´ í† ìŠ¤íŠ¸
    if (skippedFields.length > 0) {
        showToast('ğŸ”’ ì ê¸ˆ: ' + skippedFields.join(', ') + ' â€” ë³€ê²½ë˜ì§€ ì•ŠìŒ', 'info');
    }

    // â‘« ì™„ë£Œ í† ìŠ¤íŠ¸ (ë¹„êµ ì•ˆë‚´ ë©”ì‹œì§€)
    var summary = 'ìë™ì…ë ¥: ' + filledFields.length + 'ê°œ í•„ë“œ';
    console.log('[OCR] ' + summary + ' â€” ', filledFields);
    showToast('âœ… OCR ì¸ì‹ ì™„ë£Œ â€” ì¸ì‹ëœ ë‚´ìš©ê³¼ ë¹„êµ ë°”ëë‹ˆë‹¤');
}
let firestorePurposes = [];  // Firestoreì—ì„œ ë¡œë“œí•œ ê²€ì‚¬ëª©ì  P ë°°ì—´
let firestoreFields = [];    // Firestoreì—ì„œ ë¡œë“œí•œ ê²€ì‚¬ ë¶„ì•¼ ì •ë³´ [{code,name,color}]
let firestoreReady = false;  // Firebase ì¤€ë¹„ ìƒíƒœ

// ì‹œí—˜ë¶„ì•¼ëª… â†’ ì½”ë“œ ë³€í™˜ (Firestore ë™ì )
function getFieldCode(fieldName) {
    var f = firestoreFields.find(f => f.name === fieldName);
    return f ? (f.code || f.id) : fieldName;
}

// ============================================================================
// í´ë°± ë°ì´í„° (API ì„œë²„ ë¯¸ì‹¤í–‰ ì‹œ ì‚¬ìš©)
// ============================================================================
const FALLBACK_TEST_PURPOSE_MAPPING = {
  'ì‹í’ˆ': [
    'Allergen(RT-PCR)', 'ì—°êµ¬ìš©ì—­', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©',
    'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)', 'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)'
  ],
  'ì¶•ì‚°': [
    'Allergen(ELISA)', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©',
    'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)', 'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)'
  ]
};

const FALLBACK_TEST_PURPOSE_CODES = {
  'Allergen(RT-PCR)': 'AR', 'Allergen(ELISA)': 'AE',
  'ì—°êµ¬ìš©ì—­': 'RD', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': 'QC',
  'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': 'PR', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': 'RF',
  'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': 'SL', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': 'NR',
  'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': 'AB'
};

const FALLBACK_FOOD_TYPE_BY_PURPOSE = {
  'ì‹í’ˆ-Allergen(RT-PCR)': ['Sample', 'ê¸°íƒ€ê°€ê³µí’ˆ', 'ê³¼ì', 'ë¹µë¥˜'],
  'ì‹í’ˆ-ì—°êµ¬ìš©ì—­': ['Sample', 'ê¸°íƒ€ê°€ê³µí’ˆ'],
  'ì‹í’ˆ-ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': ['Sample', 'ê°€ê³µê¹€(ì¡°ë¯¸ê¹€ ë˜ëŠ” êµ¬ìš´ê¹€)', 'ê°€ê³µì†Œê¸ˆ', 'ê°„í¸ì¡°ë¦¬ì„¸íŠ¸', 'ê³ ì¶§ê°€ë£¨', 'ê³¼ì', 'ê¹€ì¹˜', 'ë¹µë¥˜', 'ì†ŒìŠ¤', 'ì»¤í”¼'],
  'ì‹í’ˆ-ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': ['Sample', 'ì”ë¥˜ë†ì•½(463ì¢…)', 'ì”ë¥˜ë†ì•½(510ì¢…)'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': ['Sample', 'ê³¼.ì±„ê°€ê³µí’ˆ', 'ê³¼.ì±„ìŒë£Œ', 'ê¸°íƒ€ê°€ê³µí’ˆ', 'ì•¡ìƒì°¨'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': ['Sample', 'ê¸°íƒ€ë†ì‚°ê°€ê³µí’ˆ', 'ê¸°íƒ€ìˆ˜ì‚°ë¬¼ê°€ê³µí’ˆ'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': ['Sample', 'ê³µì¤‘ë‚™í•˜ê· ', 'í‘œë©´ê· ', 'ê³¼ì', 'ë¹µë¥˜'],
  'ì¶•ì‚°-Allergen(ELISA)': ['Sample', 'ê°€ê³µì¹˜ì¦ˆ', 'ì†Œì‹œì§€'],
  'ì¶•ì‚°-ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': ['Sample', 'ê°€ê³µì¹˜ì¦ˆ', 'ì†Œì‹œì§€', 'í–„', 'ì–‘ë…ìœ¡', 'í¬ì¥ìœ¡'],
  'ì¶•ì‚°-ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': ['Sample', 'ê±´ì¡°ì €ì¥ìœ¡ë¥˜', 'ë¶„ì‡„ê°€ê³µìœ¡ì œí’ˆ', 'ì‹ìœ¡ì¶”ì¶œê°€ê³µí’ˆ'],
  'ì¶•ì‚°-ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': ['Sample', 'ì‹ìš©ë€', 'ì¹˜ì¦ˆ', 'ë°œíš¨ìœ ', 'ë†í›„ë°œíš¨ìœ '],
  'ì¶•ì‚°-í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': ['Sample', 'í•­ìƒë¬¼ì§ˆ(156ì¢…)', 'í•­ìƒë¬¼ì§ˆ(99ì¢…)']
};

const FALLBACK_COMPANIES = [
  { id: 1, name: '(ì£¼)íƒ­ìŠ¤ì¸í„°ë‚´ì…”ë„1ê³µì¥', businessNo: '725-85-02346', ceo: 'ë°°ìœ¤ì„±', phone: '02-1234-5678' },
  { id: 2, name: '(ì£¼)ë‚˜ëˆ”ê³µë™ì²´', businessNo: '119-81-63685', ceo: 'ìµœì˜ë‚¨', phone: '02-2345-6789' },
  { id: 3, name: 'ìš°ë¦¬ë°”ì´ì˜¤ ì£¼ì‹íšŒì‚¬', businessNo: '134-81-55919', ceo: 'ì—„íƒœìš± ì™¸ 1ëª…', phone: '02-3456-7890' }
];

// ============================================================================
// ì „ì—­ ë³€ìˆ˜
// ============================================================================
let isReceiptNoAllocated = false;
let isModified = false;
let currentUserTeam = 'customer-support'; // ëª©ì—…: ê³ ê°ì§€ì›íŒ€ ì‚¬ìš©ì

// ============================================================================
// ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
// ============================================================================
async function checkServerStatus() {
    try {
        const res = await fetch(`${API_BASE}/api/health`, { signal: AbortSignal.timeout(3000) });
        if (res.ok) {
            apiOnline = true;
            updateServerStatusUI(true);
            return true;
        }
    } catch (e) {
        // ì„œë²„ ì—°ê²° ì‹¤íŒ¨
    }
    apiOnline = false;
    updateServerStatusUI(false);
    return false;
}

function updateServerStatusUI(online) {
    const statusEl = document.getElementById('server-status');
    const iconEl = document.getElementById('server-status-icon');
    const textEl = document.getElementById('server-status-text');
    if (online) {
        statusEl.className = 'server-status online';
        iconEl.textContent = 'ğŸŸ¢';
        textEl.textContent = 'API ì—°ê²°ë¨';
    } else {
        statusEl.className = 'server-status offline';
        iconEl.textContent = 'ğŸ”´';
        textEl.textContent = 'API ì˜¤í”„ë¼ì¸ (í´ë°± ëª¨ë“œ)';
    }
}

// ============================================================================
// Firebase ì´ˆê¸°í™” â€” Firestoreì—ì„œ ê²€ì‚¬ëª©ì (P ë°°ì—´) ë¡œë“œ
// ============================================================================
window.addEventListener('firebase-ready', async function() {
    firestoreReady = true;
    try {
        // ê²€ì‚¬ ë¶„ì•¼ ì •ë³´ ë¡œë“œ (ì‹í’ˆ/ì¶•ì‚° ë¼ë²¨, ìƒ‰ìƒ)
        const fieldsDoc = await db.collection('settings').doc('inspectionFields').get();
        if (fieldsDoc.exists && fieldsDoc.data().fields) {
            firestoreFields = fieldsDoc.data().fields;
            console.log('[Firestore] ê²€ì‚¬ ë¶„ì•¼ ë¡œë“œ:', firestoreFields.map(f => f.name).join(', '));
        }

        // ê²€ì‚¬ëª©ì  P ë°°ì—´ ë¡œë“œ
        const doc = await db.collection('settings').doc('inspectionPurposes').get();
        if (doc.exists && doc.data().purposes) {
            firestorePurposes = doc.data().purposes;
            // ì •ë ¬ìˆœì„œ(c) ê¸°ì¤€ ì •ë ¬
            firestorePurposes.sort((a, b) => (a.c || 999) - (b.c || 999));
            console.log('[Firestore] ê²€ì‚¬ëª©ì  ë¡œë“œ ì™„ë£Œ:', firestorePurposes.length + 'ê°œ');
            // í˜„ì¬ ì„ íƒëœ ì‹œí—˜ë¶„ì•¼ê°€ ìˆìœ¼ë©´ ë“œë¡­ë‹¤ìš´ ê°±ì‹  (ì ê¸ˆ ìƒíƒœë©´ ê°’ ë³´ì¡´)
            const currentField = document.querySelector('input[name="test-field"]:checked')?.value;
            if (currentField) {
                var pinnedPurpose = getPinnedFields()['test-purpose'];
                var savedVal = pinnedPurpose ? pinnedPurpose.value : null;
                await updateTestPurposeOptions(currentField);
                if (savedVal) {
                    var sel = document.getElementById('test-purpose');
                    if (sel) sel.value = savedVal;
                    var textSpan = document.querySelector('#test-purpose-display .custom-select-text');
                    if (textSpan) textSpan.textContent = savedVal;
                    document.querySelectorAll('.custom-select-option').forEach(function(o) {
                        o.classList.toggle('selected', o.dataset.value === savedVal);
                    });
                    updateInspectionMode(savedVal);
                }
            }
        }
    } catch(e) {
        console.warn('[Firestore] ë¡œë“œ ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©:', e.message);
    }

    // ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ìºìŠ¤ì¼€ì´ë”© ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    if (typeof MFDS_CODES !== 'undefined') {
        MFDS_CODES.renderProductPicker('mfds-product-picker-container', function(item) {
            console.log('[ì‹ì•½ì²˜] í’ˆëª©ì½”ë“œ ì„ íƒ:', item['í’ˆëª© ì½”ë“œ'], item['í•œê¸€ ëª…']);
            loadMfdsStandardItems(item['í’ˆëª© ì½”ë“œ'], item['í•œê¸€ ëª…']).then(function() {
                setTimeout(function() {
                    var stdSection = document.getElementById('mfds-std-section');
                    if (stdSection && stdSection.style.display !== 'none') {
                        stdSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            });
        });
        console.log('[MFDS] í’ˆëª©ì½”ë“œ í”¼ì»¤ ì´ˆê¸°í™” ì™„ë£Œ');
    }
});

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
window.onload = async function() {
    setTodayDate();

    // ì„œë²„ ìƒíƒœ í™•ì¸
    await checkServerStatus();

    // ì´ˆê¸° ì‹œí—˜ë¶„ì•¼ ì„ íƒ ì‹œ ê²€ì‚¬ëª©ì  ë¡œë“œ (ì ê¸ˆ ë³µì›ì€ restorePinnedFieldsì—ì„œ ì²˜ë¦¬)
    const initialTestField = document.querySelector('input[name="test-field"]:checked')?.value;
    const pins = getPinnedFields();
    if (initialTestField && !pins['test-purpose']) {
        await updateTestPurposeOptions(initialTestField);
    }

    loadDraft();
    setupTeamMemoPermissions();
    renderSampleNav();

    // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
    document.querySelectorAll('input:not([readonly]), select:not([disabled]), textarea:not([disabled])').forEach(el => {
        el.addEventListener('input', markAsModified);
        el.addEventListener('change', markAsModified);
    });

    // ì£¼ê¸°ì  ì„œë²„ ìƒíƒœ í™•ì¸ (30ì´ˆë§ˆë‹¤)
    setInterval(checkServerStatus, 30000);
};

// ============================================================================
// Accordion í† ê¸€
// ============================================================================
function toggleSection(header) {
    header.classList.toggle('active');
    header.nextElementSibling.classList.toggle('active');
}

// ë³€ê²½ì´ë ¥ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleChangeLog() {
    var body = document.getElementById('company-changelog-body');
    var btn = document.getElementById('changelog-toggle-btn');
    if (body.style.display === 'none') {
        body.style.display = '';
        btn.textContent = 'ì ‘ê¸° â–²';
    } else {
        body.style.display = 'none';
        btn.textContent = 'í¼ì¹˜ê¸° â–¼';
    }
}

// ============================================================================
// ê³„ì‚°ì„œ ì •ë³´ í† ê¸€/ì¡°ê±´ë¶€ í‘œì‹œ
// ============================================================================
function toggleBillEdit() {
    var chk = document.getElementById('bill-edit-check').checked;
    document.getElementById('bill-edit-area').style.display = chk ? 'block' : 'none';
}
function onBillingDateTypeChange() {
    var v = document.getElementById('billing-date-type').value;
    document.getElementById('billing-date').style.display = v === 'specific' ? '' : 'none';
}
function onBillingTypeChange() {
    var v = document.getElementById('billing-type').value;
    document.getElementById('billing-type-note-row').style.display = v === 'other' ? '' : 'none';
}

// ============================================================================
// ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
// ============================================================================
function setTodayDate() {
    const pins = getPinnedFields();
    if (!pins['receipt-date']) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receipt-date').value = today;
    }
    restorePinnedFields();
    calculateProcessingDeadline();
}

// ============================================================================
// ì²˜ë¦¬ê¸°í•œ ê³„ì‚° (ì›Œí‚¹ë°ì´ 12ì¼ ê¸°ì¤€)
// ============================================================================
function getHolidays() {
    try {
        const stored = localStorage.getItem('bfl_holidays');
        return stored ? JSON.parse(stored) : [];
    } catch(e) { return []; }
}

function isWorkingDay(date) {
    const day = date.getDay();
    if (day === 0 || day === 6) return false; // ì£¼ë§
    const dateStr = date.toISOString().split('T')[0];
    const holidays = getHolidays();
    return !holidays.includes(dateStr);
}

function addWorkingDays(startDate, workDays) {
    const date = new Date(startDate);
    let added = 0;
    while (added < workDays) {
        date.setDate(date.getDate() + 1);
        if (isWorkingDay(date)) added++;
    }
    return date;
}

function calculateProcessingDeadline() {
    const receiptDate = document.getElementById('receipt-date').value;
    if (!receiptDate) return;
    const deadline = addWorkingDays(new Date(receiptDate), 12);
    document.getElementById('processing-deadline').value = deadline.toISOString().split('T')[0];
}

// ============================================================================
// ê³ ì • ì²´í¬(ğŸ“Œ) ê¸°ëŠ¥ â€” localStorageë¡œ ìœ ì§€
// ============================================================================
function togglePin(fieldId) {
    const checkbox = document.getElementById('pin-' + fieldId);
    const label = checkbox.closest('.pin-check');
    const icon = label.querySelector('.pin-icon');
    const pins = getPinnedFields();
    if (checkbox.checked) {
        savePinValue(fieldId, pins);
        label.classList.add('active');
        if (icon) icon.textContent = 'ğŸ”’';
    } else {
        delete pins[fieldId];
        if (fieldId === 'test-purpose') delete pins['_test-field-via-purpose'];
        label.classList.remove('active');
        if (icon) icon.textContent = 'ğŸ”“';
    }
    localStorage.setItem('bfl_pinned_fields', JSON.stringify(pins));
}

// ê³ ì • í•„ë“œì˜ í˜„ì¬ ê°’ì„ ì €ì¥
function savePinValue(fieldId, pins) {
    if (!pins) pins = getPinnedFields();
    if (fieldId === 'test-field') {
        pins[fieldId] = { value: document.querySelector('input[name="test-field"]:checked')?.value || '', field: 'radio' };
    } else {
        const el = document.getElementById(fieldId);
        if (el) pins[fieldId] = { value: el.value, field: el.tagName === 'SELECT' ? 'select' : 'input' };
    }
    if (fieldId === 'test-purpose') {
        pins['_test-field-via-purpose'] = document.querySelector('input[name="test-field"]:checked')?.value || '';
    }
    localStorage.setItem('bfl_pinned_fields', JSON.stringify(pins));
    return pins;
}

// ê³ ì •ëœ í•„ë“œ ê°’ì´ ë³€ê²½ë˜ë©´ ìë™ ì—…ë°ì´íŠ¸
function updatePinnedValue(fieldId) {
    var pins = getPinnedFields();
    if (pins[fieldId]) {
        savePinValue(fieldId, pins);
    }
}

function getPinnedFields() {
    try {
        return JSON.parse(localStorage.getItem('bfl_pinned_fields')) || {};
    } catch(e) { return {}; }
}

function restorePinnedFields() {
    const pins = getPinnedFields();
    // ì‹œí—˜ë¶„ì•¼ ë¨¼ì € ë³µì›
    if (pins['test-field']) {
        const checkbox = document.getElementById('pin-test-field');
        if (checkbox) {
            checkbox.checked = true;
            var lbl = checkbox.closest('.pin-check');
            lbl.classList.add('active');
            var ico = lbl.querySelector('.pin-icon'); if (ico) ico.textContent = 'ğŸ”’';
        }
        const radio = document.querySelector(`input[name="test-field"][value="${pins['test-field'].value}"]`);
        if (radio) radio.checked = true;
    }
    Object.keys(pins).forEach(fieldId => {
        if (fieldId === 'test-field' || fieldId === '_test-field-via-purpose') return;
        const checkbox = document.getElementById('pin-' + fieldId);
        const el = document.getElementById(fieldId);
        if (checkbox && el) {
            checkbox.checked = true;
            var lbl2 = checkbox.closest('.pin-check');
            lbl2.classList.add('active');
            var ico2 = lbl2.querySelector('.pin-icon'); if (ico2) ico2.textContent = 'ğŸ”’';
            // ê²€ì‚¬ëª©ì : ì‹œí—˜ë¶„ì•¼ ë¨¼ì € ë³µì› í›„ ì˜µì…˜ ë¡œë“œ â†’ ê°’ ì„¤ì •
            if (fieldId === 'test-purpose') {
                var tf = pins['_test-field-via-purpose'] || (pins['test-field'] && pins['test-field'].value) || '';
                if (tf) {
                    const radio = document.querySelector(`input[name="test-field"][value="${tf}"]`);
                    if (radio) radio.checked = true;
                }
                var savedVal = pins[fieldId].value;
                updateTestPurposeOptions(tf || document.querySelector('input[name="test-field"]:checked')?.value).then(() => {
                    el.value = savedVal;
                    // ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ í‘œì‹œ í…ìŠ¤íŠ¸ ë™ê¸°í™”
                    var textSpan = document.querySelector('#test-purpose-display .custom-select-text');
                    if (textSpan) textSpan.textContent = savedVal || 'ì„ íƒí•˜ì„¸ìš”';
                    // ì„ íƒ í‘œì‹œ
                    document.querySelectorAll('.custom-select-option').forEach(function(o) {
                        o.classList.toggle('selected', o.dataset.value === savedVal);
                    });
                    // â˜… ë³µì› í›„ ê²€ì‚¬ëª¨ë“œ ì „í™˜ ì ìš©
                    updateInspectionMode(savedVal);
                });
            } else {
                el.value = pins[fieldId].value;
            }
        }
    });
    if (pins['receipt-date']) calculateProcessingDeadline();
}

// ============================================================================
// ì‹œí—˜ë¶„ì•¼ ë³€ê²½
// ============================================================================
function onTestFieldChange() {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;

    // ê³ ì •ëœ ê²½ìš° ê°’ ì—…ë°ì´íŠ¸
    updatePinnedValue('test-field');

    // ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    updateTestPurposeOptions(testField);

    // ê²€ì‚¬ëª©ì  ì´ˆê¸°í™”
    document.getElementById('test-purpose').value = '';

    // ê²€ì²´ìœ í˜• ì´ˆê¸°í™”
    document.getElementById('food-type-input').value = '';
    document.getElementById('food-type-value').value = '';

    // ì—…ì²´ì •ë³´ ì´ˆê¸°í™” (ë¶„ì•¼ ë³€ê²½ ì‹œ ì¸í—ˆê°€ ì •ë³´ê°€ ë‹¬ë¼ì§)
    document.getElementById('company-search').value = '';
    document.getElementById('lic-no').value = '';
    document.getElementById('lic-biz-form').value = '';
    document.getElementById('lic-biz-name').value = '';
    document.getElementById('company-phone').value = '';
    document.getElementById('company-fax').value = '';
    document.getElementById('company-mobile').value = '';
    document.getElementById('company-address').value = '';
    document.getElementById('sales-rep').value = '';
    var clWrap = document.getElementById('company-changelog');
    if (clWrap) clWrap.style.display = 'none';
    document.getElementById('company-suggestions').classList.remove('active');

    // ê³„ì‚°ì„œ ì •ë³´ ì´ˆê¸°í™”
    document.getElementById('company-name').value = '';
    document.getElementById('business-no').value = '';
    document.getElementById('ceo').value = '';
    document.getElementById('bill-name').value = '';
    document.getElementById('bill-phone').value = '';
    document.getElementById('bill-fax').value = '';
    document.getElementById('bill-mobile').value = '';
    document.getElementById('bill-email').value = '';
    document.getElementById('bill-edit-check').checked = false;
    document.getElementById('bill-edit-area').style.display = 'none';

    clearInspectionItems();

    showToast(`ì‹œí—˜ë¶„ì•¼ ì„ íƒ: ${testField}. ê²€ì‚¬ëª©ì ì„ ì„ íƒí•˜ì„¸ìš”.`, 'info');
}

// ============================================================================
// ê²€ì‚¬ëª©ì  ì˜µì…˜ ì—…ë°ì´íŠ¸ (Firestore ìš°ì„  â†’ API â†’ í´ë°±)
// ============================================================================
async function updateTestPurposeOptions(testField) {
    const select = document.getElementById('test-purpose');
    if (!select) {
        console.error('ê²€ì‚¬ëª©ì  select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const fieldId = getFieldCode(testField);
    let purposes = [];

    // ë¶„ì•¼ ë¼ë²¨ í—¬í¼: firestoreFieldsì—ì„œ ë¶„ì•¼ì½”ë“œ â†’ ì´ë¦„ ë§¤í•‘
    function getFieldLabel(fieldCode) {
        const f = firestoreFields.find(f => f.code === fieldCode || f.id === fieldCode);
        return f ? f.name : fieldCode;
    }

    // 1ìˆœìœ„: Firestore P ë°°ì—´ (ê²€ì‚¬ëª©ì ê´€ë¦¬ì—ì„œ ì„¤ì •í•œ ì •ë ¬ìˆœì„œëŒ€ë¡œ)
    // o:0 (ë¯¸ì •) í•­ëª©ì€ ì œì™¸, ì´ë¦„ + ë¶„ì•¼ ë¼ë²¨ í¬í•¨
    if (firestorePurposes.length > 0) {
        purposes = firestorePurposes
            .filter(p => p.o !== 0 && p.fields && p.fields.includes(fieldId))
            .map(p => ({
                name: p.n,
                fieldCodes: p.fields || [],
                fieldLabels: (p.fields || []).map(fc => getFieldLabel(fc)),
                rcpt: p.rcpt || ''
            }));
        console.log(`[Firestore] ê²€ì‚¬ëª©ì  í•„í„°: ${testField}(${fieldId}) - ${purposes.length}ê°œ (ë¯¸ì • ì œì™¸)`);
    }

    // 2ìˆœìœ„: API (Firestore ë¯¸ë¡œë“œ ì‹œ)
    if (purposes.length === 0 && apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/test-purposes?field=${encodeURIComponent(testField)}`);
            if (res.ok) {
                const data = await res.json();
                purposes = (data.purposes || []).map(n => ({ name: n, fieldCodes: [], fieldLabels: [], rcpt: '' }));
                console.log(`[API] ê²€ì‚¬ëª©ì  ë¡œë“œ: ${testField} - ${purposes.length}ê°œ`);
            }
        } catch (e) {
            console.warn('[API] ê²€ì‚¬ëª©ì  ë¡œë“œ ì‹¤íŒ¨:', e.message);
        }
    }

    // 3ìˆœìœ„: í´ë°± (Firestore, API ëª¨ë‘ ì‹¤íŒ¨ ì‹œ)
    if (purposes.length === 0) {
        purposes = (FALLBACK_TEST_PURPOSE_MAPPING[testField] || []).map(n => ({ name: n, fieldCodes: [], fieldLabels: [], rcpt: '' }));
        console.log(`[í´ë°±] ê²€ì‚¬ëª©ì  ë¡œë“œ: ${testField} - ${purposes.length}ê°œ`);
    }

    // ë„¤ì´í‹°ë¸Œ select ë™ê¸°í™”
    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    purposes.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        select.appendChild(option);
    });

    // ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ ë Œë”ë§ (ë¶„ì•¼ ìƒ‰ìƒ ë¼ë²¨ í¬í•¨)
    renderCustomSelect(purposes);
}

// ============================================================================
// ì»¤ìŠ¤í…€ ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ (ë¶„ì•¼ ìƒ‰ìƒ ë¼ë²¨)
// ============================================================================
function renderCustomSelect(purposes) {
    const optionsDiv = document.getElementById('test-purpose-options');
    const displayEl = document.getElementById('test-purpose-display');
    optionsDiv.innerHTML = '';

    // "ì„ íƒí•˜ì„¸ìš”" ì˜µì…˜
    const placeholder = document.createElement('div');
    placeholder.className = 'custom-select-option';
    placeholder.textContent = 'ì„ íƒí•˜ì„¸ìš”';
    placeholder.dataset.value = '';
    placeholder.onclick = () => selectCustomOption('', 'ì„ íƒí•˜ì„¸ìš”', placeholder);
    optionsDiv.appendChild(placeholder);

    purposes.forEach(item => {
        const opt = document.createElement('div');
        opt.className = 'custom-select-option';
        opt.dataset.value = item.name;

        // ëª©ì  ì´ë¦„
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.name;
        opt.appendChild(nameSpan);

        opt.onclick = () => selectCustomOption(item.name, item.name, opt);
        optionsDiv.appendChild(opt);
    });

    // í˜„ì¬ ì„ íƒê°’ ì´ˆê¸°í™”
    displayEl.querySelector('.custom-select-text').textContent = 'ì„ íƒí•˜ì„¸ìš”';
}

function toggleCustomSelect() {
    const display = document.getElementById('test-purpose-display');
    const options = document.getElementById('test-purpose-options');
    display.classList.toggle('open');
    options.classList.toggle('open');
}

function selectCustomOption(value, text, optEl) {
    // ë„¤ì´í‹°ë¸Œ select ë™ê¸°í™”
    const select = document.getElementById('test-purpose');
    select.value = value;
    select.dispatchEvent(new Event('change'));

    // ì»¤ìŠ¤í…€ UI ì—…ë°ì´íŠ¸
    const display = document.getElementById('test-purpose-display');
    const textSpan = display.querySelector('.custom-select-text');

    if (value && optEl) {
        // ì„ íƒëœ í•­ëª©ì˜ HTMLì„ displayì— ë³µì‚¬ (ìƒ‰ìƒ ë¼ë²¨ í¬í•¨)
        textSpan.innerHTML = optEl.innerHTML;
    } else {
        textSpan.textContent = 'ì„ íƒí•˜ì„¸ìš”';
    }

    // ì„ íƒ í‘œì‹œ
    document.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
    if (optEl) optEl.classList.add('selected');

    // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    display.classList.remove('open');
    document.getElementById('test-purpose-options').classList.remove('open');
}

// ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    const wrap = document.getElementById('test-purpose-custom');
    if (wrap && !wrap.contains(e.target)) {
        document.getElementById('test-purpose-display')?.classList.remove('open');
        document.getElementById('test-purpose-options')?.classList.remove('open');
    }
});

// ============================================================================
// ê²€ì‚¬ëª©ì  ë³€ê²½
// ============================================================================
function onTestPurposeChange() {
    document.getElementById('food-type-input').value = '';
    document.getElementById('food-type-value').value = '';
    clearInspectionItems();
    clearMfdsStandardItems();
    window._mfdsFeeTotal = 0;

    // ê³ ì •ëœ ê²½ìš° ê°’ ì—…ë°ì´íŠ¸
    updatePinnedValue('test-purpose');

    const testPurpose = document.getElementById('test-purpose').value;
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const helpEl = document.getElementById('test-purpose-help');

    // â˜… ê²€ì‚¬ëª©ì ì— ë”°ë¼ UI ëª¨ë“œ ì „í™˜
    updateInspectionMode(testPurpose);

    if (testPurpose) {
        // Firestore P ë°°ì—´ì—ì„œ ì„ íƒëœ ê²€ì‚¬ëª©ì ì˜ ì ‘ìˆ˜ë²ˆí˜¸ í˜•ì‹ ë¼ë²¨ í‘œì‹œ
        const purposeObj = firestorePurposes.find(p => p.n === testPurpose);
        if (helpEl) {
            if (purposeObj && purposeObj.rcpt) {
                helpEl.innerHTML = `ğŸ“‹ ì ‘ìˆ˜ë²ˆí˜¸ í˜•ì‹: <strong>${purposeObj.rcpt}</strong>` +
                    (purposeObj.rcptDesc ? ` <span style="color:#888">(${purposeObj.rcptDesc})</span>` : '');
            } else {
                var isLims = (testPurpose === 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©');
                helpEl.textContent = isLims ? 'ì‹í’ˆìœ í˜•ì„ ê²€ìƒ‰í•˜ì„¸ìš” (ê³ ì‹œí•­ëª© ê¸°ì¤€)' : 'ê²€ì²´ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”';
            }
        }
        var modeLabel = (testPurpose === 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©') ? ' (ì‹ì•½ì²˜ ì—°ë™)' : '';
        showToast(`ê²€ì‚¬ëª©ì  ì„ íƒ: ${testPurpose}${modeLabel}`, 'info');

        // ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ìë™ ì¡°íšŒ (Firestore receiptsì—ì„œ ìµœê·¼ ë‚´ì—­)
        if (firestoreReady && testField) {
            fetchLatestReceiptNo(testField, testPurpose);
        }
    } else {
        if (helpEl) helpEl.textContent = 'ì‹œí—˜ë¶„ì•¼ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤';
        document.getElementById('prev-receipt-no').value = '';
    }
}

// ============================================================================
// ê²€ì‚¬ëª©ì ì— ë”°ë¥¸ UI ëª¨ë“œ ì „í™˜ (ì‹ì•½ì²˜ ì—°ë™ vs ê¸°ì¡´ ë°©ì‹)
// ============================================================================
// ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œ í”Œë˜ê·¸ â€” ì‹œí—˜í•­ëª© ê²€ìƒ‰ ëª¨ë“œì¸ì§€ ì¶”ì 
var _isRefTestMode = false;
var _refTestItemsCache = null;

function updateInspectionMode(testPurpose) {
    var isLims = (testPurpose === 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©');
    var isRef = (testPurpose === 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)');

    // ëª¨ë“œ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
    _isRefTestMode = isRef;

    // ì‹ì•½ì²˜ ì—°ë™ ì„¹ì…˜ (í’ˆëª©ì½”ë“œ í”¼ì»¤ + ê¸°ì¤€ê·œê²© í…Œì´ë¸”)
    var mfdsPickerEl = document.getElementById('mfds-product-picker-container');
    var mfdsStdEl = document.getElementById('mfds-std-section');

    // ê¸°ì¡´ ë°©ì‹ ì„¹ì…˜ (ê²€ì²´ìœ í˜• + ì‹œí—˜í•­ëª©)
    var foodTypeGroup = document.getElementById('food-type-group');
    var inspectionItemsEl = document.getElementById('inspection-items-section');

    // ê²€ì²´ìœ í˜• input ìš”ì†Œ
    var foodTypeInput = document.getElementById('food-type-input');
    var foodTypeLabel = foodTypeGroup ? foodTypeGroup.querySelector('label') : null;

    // ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©ì´ ì•„ë‹Œ ê²½ìš° ì¹´í…Œê³ ë¦¬ ê³ ì • í•´ì œ
    if (!isLims && typeof MFDS_CODES !== 'undefined' && MFDS_CODES.unlockCategories) {
        MFDS_CODES.unlockCategories();
    }

    if (isRef) {
        // â˜… ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œ: ì‹œí—˜í•­ëª© ì§ì ‘ ê²€ìƒ‰/ì¶”ê°€
        if (mfdsPickerEl) mfdsPickerEl.style.display = 'none';
        if (mfdsStdEl) mfdsStdEl.style.display = 'none';
        if (foodTypeGroup) foodTypeGroup.style.display = '';

        // ë¼ë²¨ ë³€ê²½: "ê²€ì²´ìœ í˜•" â†’ "ì‹œí—˜í•­ëª© ê²€ìƒ‰"
        if (foodTypeLabel) {
            var pinHtml = foodTypeLabel.querySelector('.pin-check');
            foodTypeLabel.innerHTML = 'ì‹œí—˜í•­ëª© ê²€ìƒ‰ <span class="required">*</span>';
            if (pinHtml) foodTypeLabel.appendChild(pinHtml);
        }

        if (foodTypeInput) {
            foodTypeInput.disabled = false;
            foodTypeInput.placeholder = 'ì‹œí—˜í•­ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰... (2,940ê±´)';
            foodTypeInput.value = '';
            // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë³€ê²½: ì‹í’ˆìœ í˜• ê²€ìƒ‰ â†’ ì‹œí—˜í•­ëª© ê²€ìƒ‰
            foodTypeInput.oninput = function() { searchRefTestItems(this.value); };
            foodTypeInput.onfocus = function() { searchRefTestItems(''); };
        }

        // ì‹œí—˜í•­ëª© í…Œì´ë¸” ì´ˆê¸°í™” (ë¹ˆ ìƒíƒœë¡œ í‘œì‹œ)
        if (inspectionItemsEl) {
            inspectionItemsEl.style.display = 'block';
            var tbody = document.getElementById('inspection-items-tbody');
            if (tbody && tbody.children.length === 0) {
                tbody.innerHTML = '<tr id="ref-test-empty-row"><td colspan="7" style="padding:30px;text-align:center;color:#999;font-size:13px">ğŸ” ìœ„ ê²€ìƒ‰ì°½ì—ì„œ ì‹œí—˜í•­ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</td></tr>';
            }
            var tfoot = document.getElementById('inspection-items-tfoot');
            if (tfoot) tfoot.style.display = 'none';
        }

        // help í…ìŠ¤íŠ¸ ë³€ê²½
        var helpEl = foodTypeGroup ? foodTypeGroup.querySelector('.field-help') : null;
        if (helpEl) helpEl.textContent = 'ê²€ì‚¬ëª©ì ê´€ë¦¬ > ì‹œí—˜í•­ëª©(2,940ê±´)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•©ë‹ˆë‹¤';

        // ì‹œí—˜í•­ëª© ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ
        if (typeof MFDS_CODES !== 'undefined') {
            MFDS_CODES.loadTestItems().then(function(items) {
                _refTestItemsCache = items;
                console.log('[ì°¸ê³ ìš©] ì‹œí—˜í•­ëª© ë¡œë“œ ì™„ë£Œ:', items.length + 'ê±´');
            });
        }

    } else if (isLims) {
        // ì‹ì•½ì²˜ ì—°ë™ ëª¨ë“œ: í’ˆëª©ì½”ë“œ í”¼ì»¤(ë©”ì¸) + ê²€ì²´ìœ í˜• ê²€ìƒ‰(ë³´ì¡°) ë³‘í–‰
        _restoreFoodTypeLabel(foodTypeLabel);
        _restoreFoodTypeInput(foodTypeInput);
        if (foodTypeGroup) foodTypeGroup.style.display = '';
        if (foodTypeInput) {
            foodTypeInput.disabled = false;
            foodTypeInput.placeholder = 'ì‹í’ˆìœ í˜• ê²€ìƒ‰ (ê³ ì‹œí•­ëª© ê¸°ì¤€)...';
            foodTypeInput.value = '';
        }
        if (inspectionItemsEl) inspectionItemsEl.style.display = 'none';

        var helpEl2 = foodTypeGroup ? foodTypeGroup.querySelector('.field-help') : null;
        if (helpEl2) helpEl2.textContent = 'ì‹œí—˜ë¶„ì•¼ + ê²€ì‚¬ëª©ì ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤';

        // ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ í”¼ì»¤: í•­ìƒ í¼ì¹¨ (ì ‘í˜ í† ê¸€ ì—†ì´)
        if (mfdsPickerEl) {
            mfdsPickerEl.style.display = '';
            var oldToggle = mfdsPickerEl.querySelector('.mfds-picker-toggle');
            if (oldToggle) oldToggle.remove();
            var content = document.getElementById('mfds-picker-content');
            if (content) content.style.display = '';
        }

        // ëŒ€ë¶„ë¥˜/ì¤‘ë¶„ë¥˜ ê³ ì •: ê°€ê³µì‹í’ˆ > ê°€ê³µì‹í’ˆ(ì „ë¶€ê°œì •)
        if (typeof MFDS_CODES !== 'undefined' && MFDS_CODES.lockCategories) {
            MFDS_CODES.lockCategories('ê°€ê³µì‹í’ˆ', 'ê°€ê³µì‹í’ˆ(ì „ë¶€ê°œì •)');
        }
    } else if (testPurpose) {
        // ê¸°ì¡´ ëª¨ë“œ: ê²€ì²´ìœ í˜• í™œì„±í™”, ì‹ì•½ì²˜ ì„¹ì…˜ ìˆ¨ê¹€
        _restoreFoodTypeLabel(foodTypeLabel);
        _restoreFoodTypeInput(foodTypeInput);
        if (mfdsPickerEl) mfdsPickerEl.style.display = 'none';
        if (mfdsStdEl) mfdsStdEl.style.display = 'none';
        if (foodTypeGroup) foodTypeGroup.style.display = '';
        if (foodTypeInput) {
            foodTypeInput.disabled = false;
            foodTypeInput.placeholder = 'ê²€ìƒ‰ ë˜ëŠ” í´ë¦­...';
        }
        var helpEl3 = foodTypeGroup ? foodTypeGroup.querySelector('.field-help') : null;
        if (helpEl3) helpEl3.textContent = 'ì‹œí—˜ë¶„ì•¼ + ê²€ì‚¬ëª©ì ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤';
    } else {
        // ë¯¸ì„ íƒ: í’ˆëª©ì½”ë“œ ìˆ¨ê¹€, ê²€ì²´ìœ í˜• ë¹„í™œì„±í™”
        _restoreFoodTypeLabel(foodTypeLabel);
        _restoreFoodTypeInput(foodTypeInput);
        if (mfdsPickerEl) mfdsPickerEl.style.display = 'none';
        if (mfdsStdEl) mfdsStdEl.style.display = 'none';
        if (foodTypeGroup) foodTypeGroup.style.display = '';
        if (foodTypeInput) {
            foodTypeInput.disabled = true;
            foodTypeInput.placeholder = 'ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
            foodTypeInput.value = '';
        }
        if (inspectionItemsEl) inspectionItemsEl.style.display = 'none';
        var helpEl4 = foodTypeGroup ? foodTypeGroup.querySelector('.field-help') : null;
        if (helpEl4) helpEl4.textContent = 'ì‹œí—˜ë¶„ì•¼ + ê²€ì‚¬ëª©ì ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤';
    }
}

// ë¼ë²¨ì„ "ê²€ì²´ìœ í˜•"ìœ¼ë¡œ ë³µì›
function _restoreFoodTypeLabel(labelEl) {
    if (!labelEl) return;
    var pinHtml = labelEl.querySelector('.pin-check');
    labelEl.innerHTML = 'ê²€ì²´ìœ í˜• <span class="required">*</span>';
    if (pinHtml) labelEl.appendChild(pinHtml);
}

// input ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ê¸°ë³¸(ì‹í’ˆìœ í˜• ê²€ìƒ‰)ìœ¼ë¡œ ë³µì›
function _restoreFoodTypeInput(inputEl) {
    if (!inputEl) return;
    inputEl.oninput = function() { searchFoodType(this.value); };
    inputEl.onfocus = function() { searchFoodType(''); };
}

// ê³µì „ê·œê²© ì¶”ê°€ ê²€ì‚¬ í† ê¸€
function toggleMfdsPickerSection() {
    var content = document.getElementById('mfds-picker-content');
    var arrow = document.getElementById('mfds-picker-arrow');
    if (!content) return;
    if (content.style.display === 'none') {
        content.style.display = '';
        if (arrow) arrow.textContent = 'â–¼';
    } else {
        content.style.display = 'none';
        if (arrow) arrow.textContent = 'â–¶';
    }
}

// ============================================================================
// ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) â€” ì‹œí—˜í•­ëª© ê²€ìƒ‰ (MFDS ì‹œí—˜í•­ëª© 2,940ê±´)
// ============================================================================

// ì‹œí—˜í•­ëª©ì½”ë“œ â†’ {fee, unit, standard} ë§¤í•‘ ìºì‹œ (mfdsTemplates ê¸°ë°˜)
var _refFeeMap = null;

/**
 * mfdsTemplatesì—ì„œ ì‹œí—˜í•­ëª©ì½”ë“œë³„ ìˆ˜ìˆ˜ë£Œ ë§µ ë¹Œë“œ (1íšŒë§Œ)
 * ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)ëŠ” ê¸°ì¤€ê·œê²©/ë‹¨ìœ„ í•´ë‹¹ ì—†ìŒ â€” ìˆ˜ìˆ˜ë£Œë§Œ ë§¤ì¹­
 */
async function buildRefFeeMap() {
    if (_refFeeMap) return _refFeeMap;
    _refFeeMap = {};
    var templates = await loadMfdsTemplates();
    templates.forEach(function(t) {
        (t.testItems || []).forEach(function(ti) {
            var code = ti.testItemCode;
            if (code && !_refFeeMap[code]) {
                _refFeeMap[code] = { fee: ti.fee || 0 };
            }
        });
    });
    console.log('[ì°¸ê³ ìš©] ìˆ˜ìˆ˜ë£Œ ë§µ ë¹Œë“œ:', Object.keys(_refFeeMap).length + 'ê±´');
    return _refFeeMap;
}

/**
 * ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œì—ì„œ ì‹œí—˜í•­ëª© ê²€ìƒ‰
 * MFDS_CODES.searchTestItems()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œí—˜í•­ëª© ëª©ë¡ì„ í‘œì‹œ
 */
async function searchRefTestItems(query) {
    var list = document.getElementById('food-type-list');
    if (!list) return;

    // ì‹œí—˜í•­ëª© ë°ì´í„° ë¡œë“œ
    if (!_refTestItemsCache) {
        if (typeof MFDS_CODES === 'undefined') {
            list.innerHTML = '<div style="padding:12px;color:#dc3545;font-size:12px;text-align:center">âš  mfds-codes.js ë¡œë“œ í•„ìš”</div>';
            list.classList.add('active');
            return;
        }
        try {
            _refTestItemsCache = await MFDS_CODES.loadTestItems();
        } catch (e) {
            list.innerHTML = '<div style="padding:12px;color:#dc3545;font-size:12px;text-align:center">âš  ì‹œí—˜í•­ëª© ë¡œë“œ ì‹¤íŒ¨</div>';
            list.classList.add('active');
            return;
        }
    }

    // ìˆ˜ìˆ˜ë£Œ ë§µ ë¹Œë“œ (ìµœì´ˆ 1íšŒ)
    await buildRefFeeMap();

    // ê²€ìƒ‰ ì‹¤í–‰
    var results = MFDS_CODES.searchTestItems(query, _refTestItemsCache);

    if (results.length === 0) {
        list.innerHTML = '<div style="padding:12px;color:#8892a4;font-size:12px;text-align:center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        list.classList.add('active');
        return;
    }

    // ì´ë¯¸ í…Œì´ë¸”ì— ì¶”ê°€ëœ í•­ëª© ì½”ë“œ ìˆ˜ì§‘ (ì¤‘ë³µ ë°©ì§€ìš©)
    var addedCodes = new Set();
    var tbody = document.getElementById('inspection-items-tbody');
    if (tbody) {
        tbody.querySelectorAll('tr[data-test-code]').forEach(function(tr) {
            var code = tr.getAttribute('data-test-code');
            if (code) addedCodes.add(code);
        });
    }

    // ëª©ë¡ ë Œë”ë§
    var html = '';
    results.forEach(function(item) {
        var code = item['ì‹œí—˜í•­ëª©ì½”ë“œ'] || '';
        var name = item['í•œê¸€ëª…'] || '';
        var eng = item['ì˜ë¬¸ëª…'] || '';
        var alias = item['ë³„ì¹­'] || '';
        var isAdded = addedCodes.has(code);

        // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
        var displayName = name;
        var displayCode = code;
        if (query) {
            var safeQ = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            var regex = new RegExp('(' + safeQ + ')', 'gi');
            displayName = name.replace(regex, '<mark>$1</mark>');
            displayCode = code.replace(regex, '<mark>$1</mark>');
        }

        var addedBadge = isAdded ? ' <span style="font-size:10px;color:#999;background:#f0f0f0;padding:1px 5px;border-radius:3px;">ì¶”ê°€ë¨</span>' : '';
        // ìˆ˜ìˆ˜ë£Œ ë§¤í•‘ ì •ë³´
        var feeInfo = _refFeeMap[code];
        var feeHtml = feeInfo && feeInfo.fee > 0
            ? ' <span style="font-size:11px;color:#6941C6;font-weight:600;margin-left:auto">' + feeInfo.fee.toLocaleString() + 'ì›</span>'
            : '';
        var subInfo = [];
        if (eng) subInfo.push(eng);
        if (alias) subInfo.push('ë³„ì¹­: ' + alias);
        var subHtml = subInfo.length > 0 ? '<div style="font-size:11px;color:#999;margin-top:2px">' + subInfo.join(' | ') + '</div>' : '';

        html += '<div class="autocomplete-item" style="padding:8px 12px;' + (isAdded ? 'opacity:0.5;' : '') + '" onclick="' + (isAdded ? '' : 'selectRefTestItem(\'' + code.replace(/'/g, "\\'") + '\')') + '">';
        html += '<div style="display:flex;align-items:center;gap:8px">';
        html += '<span style="font-family:monospace;font-size:11px;color:#1565c0;background:#e3f2fd;padding:1px 6px;border-radius:3px">' + displayCode + '</span>';
        html += '<span style="font-weight:500">' + displayName + '</span>';
        html += addedBadge;
        html += feeHtml;
        html += '</div>';
        html += subHtml;
        html += '</div>';
    });

    // ê²€ìƒ‰ ê²°ê³¼ ì•ˆë‚´ (ìµœëŒ€ 50ê±´)
    if (results.length >= 50) {
        html += '<div style="padding:8px 12px;color:#999;font-size:11px;text-align:center;border-top:1px solid #eee">ìµœëŒ€ 50ê±´ í‘œì‹œ â€” ê²€ìƒ‰ì–´ë¥¼ ë” ì…ë ¥í•˜ì„¸ìš”</div>';
    }

    list.innerHTML = html;
    list.classList.add('active');
}

/**
 * ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) â€” ì‹œí—˜í•­ëª© ì„ íƒ ì‹œ í…Œì´ë¸”ì— ì¶”ê°€
 * @param {string} testItemCode - ì„ íƒí•œ ì‹œí—˜í•­ëª©ì½”ë“œ
 */
function selectRefTestItem(testItemCode) {
    if (!testItemCode || !_refTestItemsCache) return;

    // ì‹œí—˜í•­ëª© ë°ì´í„° ì°¾ê¸°
    var item = _refTestItemsCache.find(function(i) {
        return i['ì‹œí—˜í•­ëª©ì½”ë“œ'] === testItemCode;
    });
    if (!item) {
        showToast('ì‹œí—˜í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + testItemCode, 'warning');
        return;
    }

    var tbody = document.getElementById('inspection-items-tbody');
    if (!tbody) return;

    // ì¤‘ë³µ ì²´í¬
    var existing = tbody.querySelector('tr[data-test-code="' + testItemCode + '"]');
    if (existing) {
        showToast('ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤: ' + (item['í•œê¸€ëª…'] || testItemCode), 'warning');
        return;
    }

    // ë¹ˆ ì•ˆë‚´ í–‰ ì œê±°
    var emptyRow = document.getElementById('ref-test-empty-row');
    if (emptyRow) emptyRow.remove();

    // í˜„ì¬ í–‰ ìˆ˜ ê³„ì‚°
    var rowCount = tbody.querySelectorAll('tr[data-test-code]').length;
    var idx = rowCount + 1;

    var name = item['í•œê¸€ëª…'] || '';
    var code = item['ì‹œí—˜í•­ëª©ì½”ë“œ'] || '';
    var eng = item['ì˜ë¬¸ëª…'] || '';

    // â˜… ìˆ˜ìˆ˜ë£Œë§Œ ë§¤ì¹­ (ì°¸ê³ ìš©ì€ ê¸°ì¤€ê·œê²©ì™¸ì´ë¯€ë¡œ ê¸°ì¤€ê·œê²©/ë‹¨ìœ„ëŠ” í•´ë‹¹ ì—†ìŒ)
    var fee = 0;
    if (_refFeeMap && _refFeeMap[code]) {
        fee = _refFeeMap[code].fee || 0;
    }

    // ìƒˆ í–‰ ì¶”ê°€
    var tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #eee';
    tr.setAttribute('data-item-key', name);
    tr.setAttribute('data-fee', fee);
    tr.setAttribute('data-test-code', code);
    tr.setAttribute('data-unit', '');
    tr.innerHTML = '<td style="padding:8px 6px;text-align:center"><input type="checkbox" class="inspection-item-check" value="' + (idx - 1) + '" onchange="onInspectionCheckChange()"></td>'
        + '<td style="padding:8px 12px;color:#667085">' + idx + '</td>'
        + '<td style="padding:8px 12px;color:#344054;font-weight:500">' + name + (eng ? ' <span style="font-size:11px;color:#999">(' + eng + ')</span>' : '') + '</td>'
        + '<td style="padding:8px 12px;font-family:monospace;color:#1565c0;font-size:12px">' + code + '</td>'
        + '<td style="padding:8px 12px;color:#999;font-size:12px">-</td>'
        + '<td style="padding:8px 12px;color:#999;font-size:12px">-</td>'
        + '<td style="padding:8px 12px;text-align:right;color:#344054">' + fee.toLocaleString() + 'ì›</td>';
    tbody.appendChild(tr);

    // í•©ê³„ í‘œì‹œ/ì—…ë°ì´íŠ¸
    recalcInspectionTable();

    // food-type-value ì—…ë°ì´íŠ¸ (ì°¸ê³ ìš© ëª¨ë“œì—ì„œëŠ” "ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)" ì €ì¥)
    document.getElementById('food-type-value').value = 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)';

    // í† ìŠ¤íŠ¸ + ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    showToast('ì‹œí—˜í•­ëª© ì¶”ê°€: ' + name + ' (' + code + ')', 'success');
    document.getElementById('food-type-list').classList.remove('active');

    // input ë¹„ìš°ê¸° (ë‹¤ìŒ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡)
    document.getElementById('food-type-input').value = '';

    saveSampleToArray();
    updateFeeSummary();
}

// ============================================================================
// ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ìë™ ì¡°íšŒ (Firestore receipts ì»¬ë ‰ì…˜)
// ============================================================================
async function fetchLatestReceiptNo(testField, testPurpose) {
    try {
        // ë‹¨ì¼ í•„ë“œ ì¿¼ë¦¬ (ë³µí•© ì¸ë±ìŠ¤ ë¶ˆí•„ìš”)
        const snap = await db.collection('receipts')
            .where('testPurpose', '==', testPurpose)
            .limit(50)
            .get();

        const prevInput = document.getElementById('prev-receipt-no');
        if (!snap.empty) {
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ testField í•„í„° + createdAt ì •ë ¬
            const matched = snap.docs
                .map(d => d.data())
                .filter(r => r.testField === testField && r.receiptNo)
                .sort((a, b) => {
                    const ta = a.createdAt?.toDate?.() || new Date(0);
                    const tb = b.createdAt?.toDate?.() || new Date(0);
                    return tb - ta;
                });

            if (matched.length > 0) {
                const prevNo = matched[0].receiptNo;
                prevInput.value = prevNo;
                console.log(`[Firestore] ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì¡°íšŒ: ${prevNo} (${testPurpose})`);
                showToast(`ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸: ${prevNo}`, 'info');
            } else {
                prevInput.value = '';
                console.log(`[Firestore] ì´ì „ ì ‘ìˆ˜ ë‚´ì—­ ì—†ìŒ (${testField}/${testPurpose})`);
            }
        } else {
            prevInput.value = '';
            console.log(`[Firestore] ì´ì „ ì ‘ìˆ˜ ë‚´ì—­ ì—†ìŒ (${testPurpose})`);
        }
    } catch (e) {
        console.warn('[Firestore] ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨:', e.message);
    }
}

// ============================================================================
// ì‹í’ˆìœ í˜• Firestore ì—°ë™ (foodTypesMapping ì»¬ë ‰ì…˜ - ì ‘ìˆ˜ë‚´ì—­ ê¸°ë°˜ ë§µí•‘)
// ============================================================================
let _foodTypeCache = null;
let _foodTypeCacheTime = 0;

async function loadFoodTypesFromFirestore() {
    var now = Date.now();
    // 5ë¶„ ìºì‹œ
    if (_foodTypeCache && (now - _foodTypeCacheTime < 300000)) return _foodTypeCache;
    try {
        var snap = await db.collection('foodTypesMapping').get();
        _foodTypeCache = snap.docs.map(function(d) { return d.data(); });
        _foodTypeCacheTime = now;
        console.log('[Firestore] ì‹í’ˆìœ í˜•(ë§µí•‘) ë¡œë“œ:', _foodTypeCache.length + 'ê±´');
    } catch (e) {
        console.warn('[Firestore] ì‹í’ˆìœ í˜•(ë§µí•‘) ë¡œë“œ ì‹¤íŒ¨:', e.message);
        _foodTypeCache = _foodTypeCache || [];
    }
    return _foodTypeCache;
}

// ì‹í’ˆìœ í˜•(mfdsTemplates) ë°ì´í„° ë¡œë“œ â€” Firestore ìš°ì„ , JS í´ë°±
let _tmplCache = null;
let _tmplCacheTime = 0;
async function loadMfdsTemplates() {
    var now = Date.now();
    if (_tmplCache && (now - _tmplCacheTime < 300000)) return _tmplCache;
    try {
        var snap = await db.collection('mfdsTemplates').get();
        if (snap.size > 0) {
            _tmplCache = snap.docs.map(function(d) { return d.data(); });
            console.log('[Firestore] ì‹í’ˆìœ í˜• ë¡œë“œ:', _tmplCache.length + 'ê±´');
        } else if (typeof MFDS_TEMPLATES !== 'undefined') {
            _tmplCache = MFDS_TEMPLATES;
            console.log('[JS] ì‹í’ˆìœ í˜• ê¸°ë³¸ê°’:', _tmplCache.length + 'ê±´');
        } else {
            _tmplCache = [];
        }
        _tmplCacheTime = now;
    } catch (e) {
        console.warn('[Firestore] ì‹í’ˆìœ í˜• ë¡œë“œ ì‹¤íŒ¨:', e.message);
        _tmplCache = (typeof MFDS_TEMPLATES !== 'undefined') ? MFDS_TEMPLATES : [];
    }
    return _tmplCache;
}

// ============================================================================
// ê²€ì²´ìœ í˜• ê²€ìƒ‰ (Firestore foodTypes ê¸°ë°˜)
// ============================================================================
async function searchFoodType(query) {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const testPurpose = document.getElementById('test-purpose').value;

    if (!testField || !testPurpose) {
        showToast('ì‹œí—˜ë¶„ì•¼ì™€ ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'warning');
        document.getElementById('food-type-list').classList.remove('active');
        return;
    }

    // ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œ â†’ ì‹œí—˜í•­ëª© ê²€ìƒ‰ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if (_isRefTestMode) {
        searchRefTestItems(query);
        return;
    }

    var typeSet = new Set();
    var isLims = (testPurpose === 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©');

    if (isLims) {
        // ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©: ì‹ì•½ì²˜ mfdsTemplates ê¸°ì¤€ë§Œ ì‚¬ìš©
        var templates = await loadMfdsTemplates();
        templates.forEach(function(t) {
            if (t.templateName) typeSet.add(t.templateName);
        });
    } else {
        // ê¸°íƒ€ ê²€ì‚¬ëª©ì : ê¸°ì¡´ foodTypesMapping ê¸°ë°˜
        var foodTypes = await loadFoodTypesFromFirestore();
        var filtered = foodTypes.filter(function(item) {
            return item.purpose === testPurpose && item['ë¶„ì•¼'] === testField;
        });
        filtered.forEach(function(item) {
            if (item.foodType) typeSet.add(item.foodType);
        });
    }

    var allTypes = Array.from(typeSet).sort();
    const filteredTypes = query ? allTypes.filter(t => t.toLowerCase().includes(query.toLowerCase())) : allTypes;

    const list = document.getElementById('food-type-list');
    if (filteredTypes.length === 0) {
        list.innerHTML = '<div style="padding:12px;color:#8892a4;font-size:12px;text-align:center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        list.classList.add('active');
        return;
    }

    list.innerHTML = filteredTypes.map(type => {
        let display = type;
        if (query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            display = type.replace(regex, '<mark>$1</mark>');
        }
        return `<div class="autocomplete-item" onclick="selectFoodType('${type.replace(/'/g, "\\'")}')">${display}</div>`;
    }).join('');

    list.classList.add('active');
}

// ============================================================================
// ê²€ì²´ìœ í˜• ì„ íƒ
// ============================================================================
function selectFoodType(type) {
    document.getElementById('food-type-input').value = type;
    document.getElementById('food-type-value').value = type;
    document.getElementById('food-type-list').classList.remove('active');
    showToast(`ê²€ì²´ìœ í˜• ì„ íƒ: ${type}`, 'info');
    loadInspectionItems(type);
}

// ============================================================================
// ì‹œí—˜í•­ëª© ë¡œë“œ (ê²€ì²´ìœ í˜• ê¸°ë°˜)
// ============================================================================
async function loadInspectionItems(foodType) {
    var section = document.getElementById('inspection-items-section');
    var tbody = document.getElementById('inspection-items-tbody');
    var tfoot = document.getElementById('inspection-items-tfoot');
    var summary = document.getElementById('inspection-items-summary');
    var totalEl = document.getElementById('inspection-items-total');

    if (!foodType) {
        section.style.display = 'none';
        return;
    }

    // 1) mfdsTemplatesì—ì„œ ë§¤ì¹­ë˜ëŠ” ì‹í’ˆìœ í˜• ì°¾ê¸°
    var templates = await loadMfdsTemplates();
    var tmpl = templates.find(function(t) { return t.templateName === foodType; });

    if (tmpl && tmpl.testItems && tmpl.testItems.length > 0) {
        // â˜… ì‹í’ˆìœ í˜• ë°ì´í„° ê¸°ë°˜ ë¡œë“œ (ì‹œí—˜í•­ëª©ì½”ë“œ + ê¸°ì¤€ê·œê²© + ë‹¨ìœ„ í¬í•¨)
        var total = 0;
        var html = '';
        tmpl.testItems.forEach(function(ti, idx) {
            var fee = ti.fee || 0;
            total += fee;
            var itemName = ti.testItemName + (ti.proviso ? ' (' + ti.proviso + ')' : '');
            var itemKey = (ti.testItemName || '') + '||' + (ti.proviso || '');
            html += '<tr style="border-bottom:1px solid #eee" data-item-key="' + itemKey + '" data-fee="' + fee + '" data-test-code="' + (ti.testItemCode || '') + '" data-unit="' + (ti.unit || '') + '">';
            html += '<td style="padding:8px 6px;text-align:center"><input type="checkbox" class="inspection-item-check" value="' + idx + '" onchange="onInspectionCheckChange()"></td>';
            html += '<td style="padding:8px 12px;color:#667085">' + (idx + 1) + '</td>';
            html += '<td style="padding:8px 12px;color:#344054;font-weight:500">' + itemName + '</td>';
            html += '<td style="padding:8px 12px;font-family:monospace;color:#1565c0;font-size:12px">' + (ti.testItemCode || '') + '</td>';
            html += '<td style="padding:8px 12px;color:#344054;font-size:12px">' + (ti.standard || '-') + '</td>';
            html += '<td style="padding:8px 12px;color:#667085;font-size:12px">' + (ti.unit || '-') + '</td>';
            html += '<td style="padding:8px 12px;text-align:right;color:#344054">' + fee.toLocaleString() + 'ì›</td>';
            html += '</tr>';
        });

        tbody.innerHTML = html;
        tfoot.style.display = '';
        totalEl.textContent = total.toLocaleString() + 'ì›';
        var supply = Math.round(total / 1.1);
        var vat = total - supply;
        document.getElementById('inspection-items-supply').textContent = supply.toLocaleString() + 'ì›';
        document.getElementById('inspection-items-vat').textContent = vat.toLocaleString() + 'ì›';
        summary.textContent = tmpl.testItems.length + 'ê°œ ì‹œí—˜í•­ëª© / ' + tmpl.foodTypeCode + ' / í•©ê³„ ' + total.toLocaleString() + 'ì›';
        section.style.display = 'block';
        saveSampleToArray();
        updateFeeSummary();
        return;
    }

    // 2) ê¸°ì¡´ foodTypesMapping ê¸°ë°˜ í´ë°±
    var currentField = document.querySelector('input[name="test-field"]:checked')?.value || '';
    var currentPurpose = document.getElementById('test-purpose').value || '';
    var allData = await loadFoodTypesFromFirestore();
    var items = allData.filter(function(item) {
        return item.foodType === foodType && item.purpose === currentPurpose &&
               (!currentField || item['ë¶„ì•¼'] === currentField);
    });

    // (í•­ëª©ëª…+ê´„í˜¸) ê¸°ì¤€ ì¤‘ë³µ ì œê±°
    var seen = {};
    var unique = [];
    items.forEach(function(item) {
        var key = (item.item || '') + '||' + (item.bracket || '');
        if (!seen[key]) {
            seen[key] = true;
            unique.push(item);
        }
    });

    if (unique.length === 0) {
        section.style.display = 'block';
        tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:#999;font-size:13px">í•´ë‹¹ ê²€ì²´ìœ í˜•ì— ë“±ë¡ëœ ì‹œí—˜í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        tfoot.style.display = 'none';
        summary.textContent = '';
        return;
    }

    // ê¸°ì¡´ ë°ì´í„°ì—ë„ mfdsTemplatesì—ì„œ ì‹œí—˜í•­ëª©ì½”ë“œ/ë‹¨ìœ„ êµì°¨ ì°¸ì¡°
    var tmplByName = {};
    templates.forEach(function(t) {
        (t.testItems || []).forEach(function(ti) {
            if (!tmplByName[ti.testItemName]) tmplByName[ti.testItemName] = ti;
        });
    });

    var total = 0;
    var html = '';
    unique.forEach(function(item, idx) {
        var fee = item.fee || 0;
        total += fee;
        var itemKey = (item.item || '') + '||' + (item.bracket || '');
        var ref = tmplByName[item.item] || {};
        html += '<tr style="border-bottom:1px solid #eee" data-item-key="' + itemKey + '" data-fee="' + fee + '" data-test-code="' + (ref.testItemCode || '') + '" data-unit="' + (ref.unit || '') + '">';
        html += '<td style="padding:8px 6px;text-align:center"><input type="checkbox" class="inspection-item-check" value="' + idx + '" onchange="onInspectionCheckChange()"></td>';
        html += '<td style="padding:8px 12px;color:#667085">' + (idx + 1) + '</td>';
        html += '<td style="padding:8px 12px;color:#344054">' + (item.item || '') + (item.bracket ? ' (' + item.bracket + ')' : '') + '</td>';
        html += '<td style="padding:8px 12px;font-family:monospace;color:#1565c0;font-size:12px">' + (ref.testItemCode || '') + '</td>';
        html += '<td style="padding:8px 12px;color:#344054;font-size:12px">' + (ref.standard || '-') + '</td>';
        html += '<td style="padding:8px 12px;color:#667085;font-size:12px">' + (ref.unit || '-') + '</td>';
        html += '<td style="padding:8px 12px;text-align:right;color:#344054">' + fee.toLocaleString() + 'ì›</td>';
        html += '</tr>';
    });

    tbody.innerHTML = html;
    tfoot.style.display = '';
    totalEl.textContent = total.toLocaleString() + 'ì›';
    var supply = Math.round(total / 1.1);
    var vat = total - supply;
    document.getElementById('inspection-items-supply').textContent = supply.toLocaleString() + 'ì›';
    document.getElementById('inspection-items-vat').textContent = vat.toLocaleString() + 'ì›';
    summary.textContent = unique.length + 'ê°œ í•­ëª© / í•©ê³„ ' + total.toLocaleString() + 'ì›';
    section.style.display = 'block';
    saveSampleToArray();
    updateFeeSummary();
}

function clearInspectionItems() {
    var section = document.getElementById('inspection-items-section');
    if (section) {
        section.style.display = 'none';
        document.getElementById('inspection-items-tbody').innerHTML = '';
        document.getElementById('inspection-items-tfoot').style.display = 'none';
        document.getElementById('inspection-items-summary').textContent = '';
    }
    var delBtn = document.getElementById('delete-inspection-items-btn');
    if (delBtn) delBtn.style.display = 'none';
    var checkAll = document.getElementById('inspection-check-all');
    if (checkAll) checkAll.checked = false;
}

// ê²€ì‚¬í•­ëª© ì „ì²´ ì„ íƒ/í•´ì œ
function toggleAllInspectionChecks(masterCheckbox) {
    document.querySelectorAll('.inspection-item-check').forEach(function(cb) { cb.checked = masterCheckbox.checked; });
    onInspectionCheckChange();
}

// ê²€ì‚¬í•­ëª© ì²´í¬ ë³€ê²½ ì‹œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
function onInspectionCheckChange() {
    var checked = document.querySelectorAll('.inspection-item-check:checked');
    var btn = document.getElementById('delete-inspection-items-btn');
    if (btn) {
        btn.style.display = checked.length > 0 ? '' : 'none';
        btn.textContent = 'ğŸ—‘ ì„ íƒ ì‚­ì œ (' + checked.length + 'ê±´)';
    }
}

// ì„ íƒëœ ê²€ì‚¬í•­ëª© ì‚­ì œ + ìˆ˜ìˆ˜ë£Œ ì¬ê³„ì‚°
function deleteSelectedInspectionItems() {
    var checks = document.querySelectorAll('.inspection-item-check:checked');
    if (checks.length === 0) return;
    if (!confirm(checks.length + 'ê°œ ê²€ì‚¬í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    checks.forEach(function(cb) {
        var row = cb.closest('tr');
        if (row) row.remove();
    });

    recalcInspectionTable();
    document.getElementById('delete-inspection-items-btn').style.display = 'none';
    var checkAll = document.getElementById('inspection-check-all');
    if (checkAll) checkAll.checked = false;
    saveSampleToArray();
    showToast('ğŸ—‘ ' + checks.length + 'ê°œ ê²€ì‚¬í•­ëª© ì‚­ì œë¨');
}

// ê²€ì‚¬í•­ëª© í…Œì´ë¸” ë²ˆí˜¸/í•©ê³„ ì¬ê³„ì‚°
function recalcInspectionTable() {
    var tbody = document.getElementById('inspection-items-tbody');
    if (!tbody) return;
    var rows = tbody.querySelectorAll('tr[data-item-key]');
    var total = 0;
    rows.forEach(function(row, idx) {
        var numCell = row.querySelector('td:nth-child(2)');
        if (numCell) numCell.textContent = idx + 1;
        total += parseInt(row.getAttribute('data-fee')) || 0;
        // ì²´í¬ë°•ìŠ¤ value ì—…ë°ì´íŠ¸
        var cb = row.querySelector('.inspection-item-check');
        if (cb) cb.value = idx;
    });
    document.getElementById('inspection-items-total').textContent = total.toLocaleString() + 'ì›';
    var supply = Math.round(total / 1.1);
    document.getElementById('inspection-items-supply').textContent = supply.toLocaleString() + 'ì›';
    document.getElementById('inspection-items-vat').textContent = (total - supply).toLocaleString() + 'ì›';
    document.getElementById('inspection-items-summary').textContent = rows.length + 'ê°œ í•­ëª© / í•©ê³„ ' + total.toLocaleString() + 'ì›';
    document.getElementById('inspection-items-tfoot').style.display = rows.length > 0 ? '' : 'none';

    // ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œ: í•­ëª© ì „ë¶€ ì‚­ì œ ì‹œ ë¹ˆ ì•ˆë‚´ í–‰ í‘œì‹œ
    if (rows.length === 0 && _isRefTestMode) {
        tbody.innerHTML = '<tr id="ref-test-empty-row"><td colspan="7" style="padding:30px;text-align:center;color:#999;font-size:13px">ğŸ” ìœ„ ê²€ìƒ‰ì°½ì—ì„œ ì‹œí—˜í•­ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”</td></tr>';
    }

    updateFeeSummary();
}

// ê²€ì‚¬í•­ëª©ëª…ì—ì„œ ê´„í˜¸ ë‚´ìš© ì œê±° (ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ "(ì •ëŸ‰,n=5)" ë“±)
function cleanInspectionItemName(name) {
    if (!name) return '';
    return name.replace(/\s*\([^)]*\)\s*/g, '').trim();
}

// í¬ì¥ë‹¨ìœ„/ê²€ì²´ëŸ‰ íŒŒì‹± (20gx10 â†’ amount=200, unit=g)
function parseSampleAmountInfo(sample) {
    var rawAmount = String(sample.sampleAmount || '');
    var rawUnit = sample.sampleAmountUnit || 'g';
    var rawPackage = sample.packageUnit || '';
    var rawCount = sample.sampleCount || '';
    // í¬ì¥ë‹¨ìœ„ = ë‹¨ì¼ í¬ì¥ì˜ ì¤‘ëŸ‰ (ì˜ˆ: "20g"), ê²€ì²´ëŸ‰ = ì´ ì¤‘ëŸ‰
    // íŒ¨í„´1: "20gx10" â†’ í¬ì¥ë‹¨ìœ„=20g, ê²€ì²´ëŸ‰=200(ì´), ë‹¨ìœ„=g, ê²€ì²´ìˆ˜=10
    var parseTarget = rawPackage || rawAmount;
    var multiMatch = parseTarget.match(/(\d+(?:\.\d+)?)\s*(g|kg|ml|mL|L)\s*[x*Ã—]\s*(\d+)/i);
    if (multiMatch) {
        var single = parseFloat(multiMatch[1]);
        var unit = multiMatch[2].toLowerCase() === 'ml' ? 'ml' : multiMatch[2];
        var count = parseInt(multiMatch[3]);
        return { amount: single * count, unit: unit, packageUnit: multiMatch[1] + unit, sampleCount: count };
    }
    // íŒ¨í„´2: sampleAmountì— "x" í¬í•¨ (ì˜ˆ: "20*10") â†’ ê²€ì²´ëŸ‰=200(ì´), ê²€ì²´ìˆ˜=10
    if (rawAmount.match(/[*xÃ—]/i)) {
        var parts = rawAmount.split(/[*xÃ—]/i);
        if (parts.length === 2) {
            var a = parseFloat(parts[0].replace(/[^0-9.]/g, ''));
            var b = parseFloat(parts[1].replace(/[^0-9.]/g, ''));
            if (!isNaN(a) && !isNaN(b)) {
                return { amount: a * b, unit: rawUnit, packageUnit: a + rawUnit, sampleCount: b };
            }
        }
    }
    // íŒ¨í„´3: ì¼ë°˜ ìˆ«ì
    return {
        amount: rawAmount.replace(/[^0-9.]/g, '') || rawAmount,
        unit: rawUnit,
        packageUnit: rawPackage || (rawAmount ? rawAmount.replace(/[^0-9.]/g, '') + rawUnit : ''),
        sampleCount: rawCount
    };
}

// ============================================================================
// ì‹ì•½ì²˜ ê¸°ì¤€ê·œê²© ì‹œí—˜í•­ëª© ë¡œë“œ (í’ˆëª©ì½”ë“œ ê¸°ë°˜)
// ============================================================================
var _mfdsStdCache = null;       // ê°œë³„ê¸°ì¤€ê·œê²© ìºì‹œ
var _mfdsProductMap = null;     // í’ˆëª©ì½”ë“œâ†’í•œê¸€ëª…
var _mfdsTestItemMap = null;    // ì‹œí—˜í•­ëª©ì½”ë“œâ†’í•œê¸€ëª…
var _mfdsUnitMap = null;        // ë‹¨ìœ„ì½”ë“œâ†’ë‹¨ìœ„ëª…

async function loadMfdsStandardItems(productCode, productName) {
    var section = document.getElementById('mfds-std-section');
    var tbody = document.getElementById('mfds-std-tbody');
    var summary = document.getElementById('mfds-std-summary');
    var info = document.getElementById('mfds-std-info');

    if (!productCode || !section) return;

    // ë¡œë”© í‘œì‹œ
    section.style.display = 'block';
    tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:#667085">ê¸°ì¤€ê·œê²© ë¡œë”©ì¤‘...</td></tr>';
    info.textContent = 'ì„ íƒ: ' + productCode + ' â€” ' + (productName || '');
    summary.textContent = '';

    try {
        // ë°ì´í„° ë¡œë“œ (ìºì‹œ í™œìš©)
        if (!_mfdsStdCache) _mfdsStdCache = await MFDS_CODES.loadIndividualStandards();
        if (!_mfdsTestItemMap) _mfdsTestItemMap = await MFDS_CODES.getTestItemNameMap();
        if (!_mfdsUnitMap) _mfdsUnitMap = await MFDS_CODES.getUnitNameMap();

        // ì„ íƒëœ í’ˆëª©ì½”ë“œì˜ ê¸°ì¤€ê·œê²© í•„í„°ë§
        // prefix ë§¤ì¹­: ì„ íƒ ì½”ë“œì˜ ìœ íš¨ ë¶€ë¶„(ë’¤ 0 ì œê±°)ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê¸°ì¤€ê·œê²© + ì •í™• ì¼ì¹˜
        var trimmed = productCode.replace(/0+$/, ''); // C0101000000000 â†’ C0101
        var matched = _mfdsStdCache.filter(function(s) {
            var stdCode = s['í’ˆëª©ì½”ë“œ'] || '';
            // ê¸°ì¤€ê·œê²© ì½”ë“œê°€ ì„ íƒì½”ë“œë¡œ ì‹œì‘í•˜ê±°ë‚˜, ì„ íƒì½”ë“œê°€ ê¸°ì¤€ê·œê²© ì½”ë“œë¡œ ì‹œì‘
            return stdCode.indexOf(trimmed) === 0 || trimmed.indexOf(stdCode.replace(/0+$/, '')) === 0;
        });

        if (matched.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:#999;font-size:13px">ì´ í’ˆëª©ì½”ë“œì— ë“±ë¡ëœ ê¸°ì¤€ê·œê²©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            summary.textContent = '0ê±´';
            return;
        }

        // ì‹œí—˜í•­ëª©ì½”ë“œ ê¸°ì¤€ ì¤‘ë³µ ì œê±° (ê°™ì€ í•­ëª©ì´ ìƒìœ„/í•˜ìœ„ì— ëª¨ë‘ ìˆì„ ê²½ìš° í•˜ìœ„ ìš°ì„ )
        var seenItems = {};
        matched.forEach(function(s) {
            var key = s['ì‹œí—˜í•­ëª©ì½”ë“œ'];
            if (!seenItems[key] || s['í’ˆëª©ì½”ë“œ'].length > seenItems[key]['í’ˆëª©ì½”ë“œ'].length) {
                seenItems[key] = s;
            }
        });
        var unique = Object.values(seenItems);

        // í…Œì´ë¸” ë Œë”ë§ (ìˆ˜ìˆ˜ë£Œ í¬í•¨)
        var hasFeeMap = typeof MFDS_FEE_MAP !== 'undefined';
        var html = '';
        var totalFee = 0;
        var feeCount = 0;
        unique.forEach(function(s, idx) {
            var testCode = s['ì‹œí—˜í•­ëª©ì½”ë“œ'] || '';
            var testName = (_mfdsTestItemMap && _mfdsTestItemMap[testCode]) || testCode;
            var stdVal = s['ê¸°ì¤€ê·œê²©ê°’'] || s['ê¸°ì¤€ê·œê²©ê°’ì„¤ëª…'] || '';
            var min = s['ê¸°ì¤€ê·œê²©ìµœì†Œê°’'] || '';
            var max = s['ê¸°ì¤€ê·œê²©ìµœëŒ€ê°’'] || '';
            var range = (min || max) ? (min + ' ~ ' + max) : '-';
            var unitCode = s['ë‹¨ìœ„ì½”ë“œ'] || '';
            var unit = (_mfdsUnitMap && _mfdsUnitMap[unitCode]) || unitCode;

            // ìˆ˜ìˆ˜ë£Œ ì¡°íšŒ
            var fee = 0;
            var feeText = '-';
            if (hasFeeMap && MFDS_FEE_MAP[testCode]) {
                fee = MFDS_FEE_MAP[testCode].fee || 0;
                feeText = fee.toLocaleString() + 'ì›';
                totalFee += fee;
                feeCount++;
            }

            html += '<tr style="border-bottom:1px solid #d4e5f7;" data-test-code="' + testCode + '" data-test-name="' + testName.replace(/"/g, '&quot;') + '" data-standard="' + stdVal.replace(/"/g, '&quot;') + '" data-unit="' + unit.replace(/"/g, '&quot;') + '" data-fee="' + fee + '" data-min="' + min + '" data-max="' + max + '">';
            html += '<td style="padding:7px 6px;text-align:center"><input type="checkbox" class="mfds-std-check" value="' + idx + '" onchange="updateMfdsStdCheckCount()"></td>';
            html += '<td style="padding:7px 10px;color:#667085">' + (idx + 1) + '</td>';
            html += '<td style="padding:7px 10px;color:#344054">' + testName;
            if (testCode !== testName) html += ' <span style="color:#999;font-size:11px;">(' + testCode + ')</span>';
            html += '</td>';
            html += '<td style="padding:7px 10px;color:#344054;font-size:12px;max-width:180px;word-break:break-all;">' + stdVal + '</td>';
            html += '<td style="padding:7px 10px;text-align:center;color:#667085;font-size:12px">' + range + '</td>';
            html += '<td style="padding:7px 10px;text-align:center;color:#667085;font-size:12px">' + unit + '</td>';
            html += '<td style="padding:7px 10px;text-align:right;color:' + (fee > 0 ? '#1565c0' : '#ccc') + ';font-weight:' + (fee > 0 ? '600' : '400') + '">' + feeText + '</td>';
            html += '</tr>';
        });

        tbody.innerHTML = html;

        // ìˆ˜ìˆ˜ë£Œ í•©ê³„ í‘œì‹œ
        var tfoot = document.getElementById('mfds-std-tfoot');
        if (totalFee > 0 && tfoot) {
            tfoot.style.display = '';
            document.getElementById('mfds-std-fee-total').textContent = totalFee.toLocaleString() + 'ì›';
            var supply = Math.round(totalFee / 1.1);
            var vat = totalFee - supply;
            document.getElementById('mfds-std-fee-supply').textContent = supply.toLocaleString() + 'ì›';
            document.getElementById('mfds-std-fee-vat').textContent = vat.toLocaleString() + 'ì›';
        } else if (tfoot) {
            tfoot.style.display = 'none';
        }

        summary.textContent = unique.length + 'ê°œ ì‹œí—˜í•­ëª©' + (feeCount > 0 ? ' / ' + totalFee.toLocaleString() + 'ì›' : '');

        // â˜… ìˆ˜ìˆ˜ë£Œ ì „ì—­ ì €ì¥ + ìˆ˜ìˆ˜ë£Œì •ë³´ ì„¹ì…˜ ìë™ ê°±ì‹ 
        window._mfdsFeeTotal = totalFee;
        updateFeeSummary();

        // ì‹œí—˜í•­ëª© ì¶”ê°€ ë²„íŠ¼ ë°” í‘œì‹œ
        var addBar = document.getElementById('mfds-std-add-bar');
        if (addBar && unique.length > 0) {
            addBar.style.display = '';
            var allCheck = document.getElementById('mfds-std-check-all');
            if (allCheck) allCheck.checked = false;
            updateMfdsStdCheckCount();
        }

    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:#e53e3e">ë¡œë“œ ì‹¤íŒ¨: ' + e.message + '</td></tr>';
        console.error('[ê¸°ì¤€ê·œê²©] ë¡œë“œ ì˜¤ë¥˜:', e);
    }
}

function clearMfdsStandardItems() {
    var section = document.getElementById('mfds-std-section');
    if (section) {
        section.style.display = 'none';
        document.getElementById('mfds-std-tbody').innerHTML = '';
        document.getElementById('mfds-std-summary').textContent = '';
        document.getElementById('mfds-std-info').textContent = '';
    }
    var addBar = document.getElementById('mfds-std-add-bar');
    if (addBar) addBar.style.display = 'none';
}

// ============================================================================
// ê¸°ì¤€ê·œê²© â†’ ì‹œí—˜í•­ëª© ì„ íƒ ì´ë™
// ============================================================================

/** ê¸°ì¤€ê·œê²© ì „ì²´ ì„ íƒ/í•´ì œ */
function toggleAllMfdsStdChecks(masterCb) {
    var checks = document.querySelectorAll('.mfds-std-check');
    checks.forEach(function(cb) { cb.checked = masterCb.checked; });
    updateMfdsStdCheckCount();
}

/** ì²´í¬ ê°œìˆ˜ í‘œì‹œ + ë²„íŠ¼ í™œì„±í™” */
function updateMfdsStdCheckCount() {
    var checks = document.querySelectorAll('.mfds-std-check:checked');
    var countEl = document.getElementById('mfds-std-check-count');
    if (countEl) {
        countEl.textContent = checks.length > 0 ? checks.length + 'ê°œ ì„ íƒë¨' : '';
    }
}

/** ê¸°ì¤€ê·œê²©ì—ì„œ ì„ íƒëœ í•­ëª©ì„ ì‹œí—˜í•­ëª© í…Œì´ë¸”ì— ì¶”ê°€ */
function addStdItemsToInspection() {
    var checks = document.querySelectorAll('.mfds-std-check:checked');
    if (checks.length === 0) {
        showToast('âš ï¸ ì¶”ê°€í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
    }

    var tbody = document.getElementById('inspection-items-tbody');
    var section = document.getElementById('inspection-items-section');
    if (!tbody || !section) return;

    // ì‹œí—˜í•­ëª© ì„¹ì…˜ í‘œì‹œ
    section.style.display = '';

    // ê¸°ì¡´ ì‹œí—˜í•­ëª©ì½”ë“œ ì¤‘ë³µ ì²´í¬
    var existingCodes = new Set();
    tbody.querySelectorAll('tr[data-test-code]').forEach(function(tr) {
        existingCodes.add(tr.getAttribute('data-test-code'));
    });

    var added = 0;
    var skipped = 0;

    checks.forEach(function(cb) {
        var row = cb.closest('tr');
        if (!row) return;
        var testCode = row.getAttribute('data-test-code') || '';
        var testName = row.getAttribute('data-test-name') || '';
        var standard = row.getAttribute('data-standard') || '';
        var unit = row.getAttribute('data-unit') || '';
        var fee = parseInt(row.getAttribute('data-fee') || '0');

        // ì¤‘ë³µ ì²´í¬
        if (existingCodes.has(testCode)) {
            skipped++;
            return;
        }

        var idx = tbody.querySelectorAll('tr[data-item-key]').length;
        var itemKey = testName + '||';

        var tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #eee';
        tr.setAttribute('data-item-key', itemKey);
        tr.setAttribute('data-fee', fee);
        tr.setAttribute('data-test-code', testCode);
        tr.setAttribute('data-unit', unit);

        tr.innerHTML =
            '<td style="padding:7px 10px;text-align:center"><input type="checkbox" class="inspection-item-check" value="' + idx + '" onchange="onInspectionItemCheck()"></td>' +
            '<td style="padding:7px 10px;text-align:center;color:#667085">' + (idx + 1) + '</td>' +
            '<td style="padding:7px 10px;color:#344054">' + testName + '</td>' +
            '<td style="padding:7px 10px;text-align:center;color:#667085;font-size:12px">' + testCode + '</td>' +
            '<td style="padding:7px 10px;color:#344054;font-size:12px;max-width:180px;word-break:break-all;">' + (standard || '-') + '</td>' +
            '<td style="padding:7px 10px;text-align:center;color:#667085;font-size:12px">' + (unit || '-') + '</td>' +
            '<td style="padding:7px 10px;text-align:right;color:' + (fee > 0 ? '#6941C6' : '#ccc') + ';font-weight:' + (fee > 0 ? '600' : '400') + '">' + (fee > 0 ? fee.toLocaleString() + 'ì›' : '-') + '</td>';

        tbody.appendChild(tr);
        existingCodes.add(testCode);
        added++;
    });

    // ë¹ˆ í–‰ ì œê±° (ì•ˆë‚´ ë©”ì‹œì§€ í–‰)
    var emptyRow = document.getElementById('ref-test-empty-row');
    if (emptyRow && added > 0) emptyRow.remove();

    // í•©ê³„ ì¬ê³„ì‚°
    recalcInspectionTable();

    // ì²´í¬ í•´ì œ
    document.querySelectorAll('.mfds-std-check').forEach(function(cb) { cb.checked = false; });
    var allCheck = document.getElementById('mfds-std-check-all');
    if (allCheck) allCheck.checked = false;
    updateMfdsStdCheckCount();

    // ê²°ê³¼ ì•Œë¦¼ + ìŠ¤í¬ë¡¤
    if (added > 0) {
        showToast('âœ… ' + added + 'ê°œ ì‹œí—˜í•­ëª© ì¶”ê°€' + (skipped > 0 ? ' (' + skipped + 'ê°œ ì¤‘ë³µ ê±´ë„ˆëœ€)' : ''));
        setTimeout(function() {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        if (typeof saveSampleToArray === 'function') saveSampleToArray();
    } else if (skipped > 0) {
        showToast('â„¹ï¸ ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤ (' + skipped + 'ê°œ)');
    }
}

// ============================================================================
// ì„±ì ì„œ ë°œì†¡ ì˜µì…˜ í† ê¸€
// ============================================================================
function toggleReportSendOption() {
    var checks = document.querySelectorAll('input[name="report-send"]');
    var mailPanel = document.getElementById('mail-option-panel');
    var faxPanel = document.getElementById('fax-option-panel');
    var emailPanel = document.getElementById('email-option-panel');
    var mailChecked = false, faxChecked = false, emailChecked = false;
    checks.forEach(function(cb) {
        if (cb.value === 'ìš°í¸') mailChecked = cb.checked;
        if (cb.value === 'íŒ©ìŠ¤(ì„ )') faxChecked = cb.checked;
        if (cb.value === 'ë©”ì¼(ì‚¬ë³¸)') emailChecked = cb.checked;
    });
    mailPanel.style.display = mailChecked ? '' : 'none';
    faxPanel.style.display = faxChecked ? '' : 'none';
    emailPanel.style.display = emailChecked ? '' : 'none';
    // ìš°í¸ ì²´í¬ ì‹œ ì£¼ì†Œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    if (mailChecked) updateMailAddrPreviews();
    // íŒ©ìŠ¤ ì²´í¬ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    if (faxChecked) updateFaxPreview();
    // ë©”ì¼ ì²´í¬ ì‹œ ê¸°ë³¸ê°’ ì±„ìš°ê¸°
    if (emailChecked && !document.getElementById('report-email').value) {
        var sc = window._selectedCompany || {};
        document.getElementById('report-email').value = sc.taxEmail || (sc.contacts && sc.contacts[0] ? sc.contacts[0].email : '') || '';
    }
}

function updateMailAddrPreviews() {
    var sc = window._selectedCompany || {};
    var bizAddr = (sc.addr1 || '') + (sc.addr2 ? ' ' + sc.addr2 : '');
    var licAddr = document.getElementById('company-address').value || '';
    var licBizName = document.getElementById('lic-biz-name').value || '';
    document.getElementById('mail-biz-addr-preview').textContent = bizAddr ? '(' + bizAddr + ')' : '';
    document.getElementById('mail-lic-addr-preview').textContent = licAddr
        ? (licBizName ? '- ' + licBizName + ' ' : '') + '(' + licAddr + ')'
        : '';
}

function toggleMailAddrType() {
    var otherCb = document.querySelector('input[name="mail-addr-type"][value="other"]');
    document.getElementById('mail-other-addr-panel').style.display = (otherCb && otherCb.checked) ? '' : 'none';
}

function updateFaxPreview() {
    var faxVal = document.getElementById('company-fax').value || '';
    document.getElementById('fax-registered-preview').textContent = faxVal ? '(' + faxVal + ')' : '(ì—†ìŒ)';
}

function toggleFaxType() {
    var otherCb = document.querySelector('input[name="fax-type"][value="other"]');
    document.getElementById('fax-other-panel').style.display = (otherCb && otherCb.checked) ? '' : 'none';
}

function openMailPostcode() {
    new daum.Postcode({
        oncomplete: function(data) {
            document.getElementById('mail-zipcode').value = data.zonecode;
            document.getElementById('mail-addr1').value = data.roadAddress || data.jibunAddress;
            document.getElementById('mail-addr2').value = '';
            document.getElementById('mail-addr2').focus();
        }
    }).open();
}

function toggleMailCc() {
    var checked = document.getElementById('email-cc-toggle').checked;
    document.getElementById('email-cc-panel').style.display = checked ? '' : 'none';
}

function addCcField() {
    var container = document.getElementById('email-cc-fields');
    var existing = container.querySelectorAll('.cc-email-field');
    if (existing.length >= 5) {
        showToast('CCëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        return;
    }
    var input = document.createElement('input');
    input.type = 'email';
    input.className = 'cc-email-field';
    input.placeholder = 'CC ì´ë©”ì¼ ' + (existing.length + 1);
    input.style.cssText = 'width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;margin-bottom:4px';
    container.appendChild(input);
    input.focus();
}

// ============================================================================
// ì‹œë£Œ ë©€í‹° í¼ ê´€ë¦¬
// ============================================================================
var _sampleData = [{}];
var _currentSampleIdx = 0;
var _sampleFieldIds = [
    'product-name','food-type-input','food-type-value',
    'mfds-product-code','mfds-product-name',
    'sample-amount','sample-amount-unit','sample-count','package-unit',
    'transport-status','manufacture-no','manufacture-date',
    'expiry-date','expiry-days','sample-location','sample-box-no',
    'remarks'
];

function updateSampleCount(val) {
    var count = parseInt(val) || 1;
    if (count < 1) count = 1;
    // í˜„ì¬ ì‹œë£Œ ì €ì¥
    saveSampleToArray();
    // ë°°ì—´ í¬ê¸° ì¡°ì •
    while (_sampleData.length < count) _sampleData.push({});
    if (_sampleData.length > count) _sampleData.length = count;
    // í˜„ì¬ ì¸ë±ìŠ¤ ë²”ìœ„ ë³´ì •
    if (_currentSampleIdx >= count) {
        _currentSampleIdx = count - 1;
        loadSampleFromArray(_currentSampleIdx);
    }
    renderSampleNav();
}

function getSampleNo(idx) {
    var rno = document.getElementById('receipt-no').value || '';
    var sno = String(idx + 1).padStart(3, '0');
    if (!rno) return 'ì‹œë£Œ ' + sno;
    // ì ‘ìˆ˜ë²ˆí˜¸ ëì´ -ìˆ«ì íŒ¨í„´ì´ë©´ êµì²´, ì•„ë‹ˆë©´ -ìˆœë²ˆ ì¶”ê°€
    if (/-\d+$/.test(rno)) {
        return rno.replace(/-\d+$/, '-' + sno);
    }
    return rno + '-' + sno;
}

function renderSampleNav() {
    var count = _sampleData.length;
    var tabs = document.getElementById('sample-nav-tabs');
    var html = '';
    for (var i = 0; i < count; i++) {
        var active = (i === _currentSampleIdx);
        html += '<button type="button" onclick="switchSample(' + i + ')" style="' +
            'padding:5px 12px;border-radius:6px;font-size:12px;font-weight:' + (active ? '700' : '500') + ';' +
            'border:1px solid ' + (active ? '#6941C6' : '#d0d5dd') + ';' +
            'background:' + (active ? '#6941C6' : '#fff') + ';' +
            'color:' + (active ? '#fff' : '#344054') + ';' +
            'cursor:pointer;white-space:nowrap">' +
            getSampleNo(i) + '</button>';
    }
    tabs.innerHTML = html;
    document.getElementById('sample-nav-prev').disabled = (_currentSampleIdx <= 0);
    document.getElementById('sample-nav-next').disabled = (_currentSampleIdx >= count - 1);
    var rno = document.getElementById('receipt-no').value || '';
    var sno = String(_currentSampleIdx + 1).padStart(3, '0');
    document.getElementById('sample-label').textContent = 'ğŸ“Œ ' + (rno ? rno.replace(/-\d+$/, '-' + sno) : 'ì‹œë£Œ #' + sno);
    // 1ê°œì¼ ë•Œ ë„¤ë¹„ ìˆ¨ê¹€
    document.getElementById('sample-nav').style.display = (count <= 1) ? 'none' : 'flex';
}

function switchSample(idx) {
    if (idx < 0 || idx >= _sampleData.length || idx === _currentSampleIdx) return;
    saveSampleToArray();
    _currentSampleIdx = idx;
    loadSampleFromArray(idx);
    renderSampleNav();
    updateFeeSummary();
}

function saveSampleToArray() {
    var obj = {};
    _sampleFieldIds.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) obj[id] = el.value;
    });

    // ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œ: ê°œë³„ ì¶”ê°€ëœ ì‹œí—˜í•­ëª©ë„ ì €ì¥
    if (_isRefTestMode) {
        var refItems = [];
        var tbody = document.getElementById('inspection-items-tbody');
        if (tbody) {
            tbody.querySelectorAll('tr[data-test-code]').forEach(function(tr) {
                refItems.push({
                    testCode: tr.getAttribute('data-test-code') || '',
                    itemName: tr.getAttribute('data-item-key') || '',
                    fee: parseInt(tr.getAttribute('data-fee') || '0', 10),
                    unit: tr.getAttribute('data-unit') || ''
                });
            });
        }
        obj._refTestItems = refItems;
    }

    _sampleData[_currentSampleIdx] = obj;
}

function loadSampleFromArray(idx) {
    var obj = _sampleData[idx] || {};
    _sampleFieldIds.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.value = obj[id] || '';
    });

    // ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ëª¨ë“œ: ê°œë³„ ì¶”ê°€ëœ ì‹œí—˜í•­ëª© ë³µì›
    if (_isRefTestMode && obj._refTestItems && obj._refTestItems.length > 0) {
        restoreRefTestItems(obj._refTestItems);
    } else {
        // ê²€ì²´ìœ í˜• ë³€ê²½ì— ë”°ë¼ ì‹œí—˜í•­ëª© ë‹¤ì‹œ ë¡œë“œ
        var foodType = obj['food-type-value'] || '';
        if (foodType && foodType !== 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)') {
            loadInspectionItems(foodType);
        } else if (!_isRefTestMode) {
            clearInspectionItems();
        }
    }

    // ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ì„ íƒ ìƒíƒœ ë³µì›
    restoreMfdsProductDisplay();
    document.getElementById('sample-label').textContent = 'ğŸ“Œ ' + getSampleNo(idx);
}

/**
 * ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) â€” ì €ì¥ëœ ì‹œí—˜í•­ëª© ë³µì›
 * @param {Array} items - [{testCode, itemName, fee, unit}, ...]
 */
function restoreRefTestItems(items) {
    var tbody = document.getElementById('inspection-items-tbody');
    var section = document.getElementById('inspection-items-section');
    if (!tbody || !section) return;

    section.style.display = 'block';
    var html = '';
    items.forEach(function(item, idx) {
        html += '<tr style="border-bottom:1px solid #eee" data-item-key="' + (item.itemName || '') + '" data-fee="' + (item.fee || 0) + '" data-test-code="' + (item.testCode || '') + '" data-unit="' + (item.unit || '') + '">';
        html += '<td style="padding:8px 6px;text-align:center"><input type="checkbox" class="inspection-item-check" value="' + idx + '" onchange="onInspectionCheckChange()"></td>';
        html += '<td style="padding:8px 12px;color:#667085">' + (idx + 1) + '</td>';
        html += '<td style="padding:8px 12px;color:#344054;font-weight:500">' + (item.itemName || '') + '</td>';
        html += '<td style="padding:8px 12px;font-family:monospace;color:#1565c0;font-size:12px">' + (item.testCode || '') + '</td>';
        html += '<td style="padding:8px 12px;color:#344054;font-size:12px">-</td>';
        html += '<td style="padding:8px 12px;color:#667085;font-size:12px">' + (item.unit || '-') + '</td>';
        html += '<td style="padding:8px 12px;text-align:right;color:#344054">' + (item.fee || 0).toLocaleString() + 'ì›</td>';
        html += '</tr>';
    });
    tbody.innerHTML = html;
    recalcInspectionTable();
}

/** ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ì„ íƒ í‘œì‹œ ë³µì› (ì‹œë£Œ ì „í™˜ ì‹œ í˜¸ì¶œ) */
function restoreMfdsProductDisplay() {
    var codeEl = document.getElementById('mfds-product-code');
    var nameEl = document.getElementById('mfds-product-name');
    var selectedDiv = document.getElementById('mfds-product-selected');
    var selectedText = document.getElementById('mfds-product-selected-text');
    if (!codeEl || !selectedDiv) return;
    var code = codeEl.value;
    var name = nameEl ? nameEl.value : '';
    if (code) {
        selectedText.textContent = code + ' â€” ' + name;
        selectedDiv.style.display = 'block';
    } else {
        selectedDiv.style.display = 'none';
    }
    // ë“œë¡­ë‹¤ìš´ì€ ì´ˆê¸°í™” (ì„ íƒ ìƒíƒœëŠ” hidden í•„ë“œë¡œ ê´€ë¦¬)
    var cat1 = document.getElementById('mfds-cat1');
    var cat2 = document.getElementById('mfds-cat2');
    var cat3 = document.getElementById('mfds-cat3');
    if (cat1) cat1.value = '';
    if (cat2) { cat2.innerHTML = '<option value="">ì¤‘ë¶„ë¥˜ ì„ íƒ</option>'; cat2.disabled = true; }
    if (cat3) { cat3.innerHTML = '<option value="">ì†Œë¶„ë¥˜ ì„ íƒ</option>'; cat3.disabled = true; }
}

// ============================================================================
// ìˆ˜ìˆ˜ë£Œ ì´í•© ê³„ì‚° (ëª¨ë“  ì‹œë£Œì˜ ì‹œí—˜í•­ëª© í•©ì‚°)
// ============================================================================
async function updateFeeSummary() {
    var grandTotal = 0;
    var currentPurpose = document.getElementById('test-purpose').value || '';
    var currentField = document.querySelector('input[name="test-field"]:checked')?.value || '';

    if (currentPurpose === 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©') {
        // ì‹ì•½ì²˜ ì—°ë™ ëª¨ë“œ: ì‹œí—˜í•­ëª© í…Œì´ë¸”ì—ì„œ ì§ì ‘ í•©ì‚°
        var tbody = document.getElementById('inspection-items-tbody');
        if (tbody) {
            tbody.querySelectorAll('tr[data-fee]').forEach(function(tr) {
                grandTotal += parseInt(tr.getAttribute('data-fee') || '0', 10);
            });
        }
        // MFDS ê¸°ì¤€ê·œê²© ìˆ˜ìˆ˜ë£Œë„ í•©ì‚° (ê³µì „ê·œê²© ì¶”ê°€ í•­ëª©)
        grandTotal += (window._mfdsFeeTotal || 0);
    } else if (currentPurpose === 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)') {
        // ì°¸ê³ ìš© ëª¨ë“œ: ì‹œí—˜í•­ëª© í…Œì´ë¸”ì—ì„œ ì§ì ‘ í•©ì‚° (ê°œë³„ ì¶”ê°€ëœ í•­ëª©)
        var refTbody = document.getElementById('inspection-items-tbody');
        if (refTbody) {
            refTbody.querySelectorAll('tr[data-fee]').forEach(function(tr) {
                grandTotal += parseInt(tr.getAttribute('data-fee') || '0', 10);
            });
        }
    } else {
        // ê¸°ì¡´ ëª¨ë“œ: foodTypesMappingì—ì„œ ìˆ˜ìˆ˜ë£Œ í•©ì‚°
        var allData = await loadFoodTypesFromFirestore();
        _sampleData.forEach(function(s) {
            var ft = s['food-type-value'] || '';
            if (ft && allData.length > 0) {
                var items = allData.filter(function(item) {
                    return item.foodType === ft && item.purpose === currentPurpose &&
                           (!currentField || item['ë¶„ì•¼'] === currentField);
                });
                var seen = {};
                items.forEach(function(item) {
                    var key = (item.item || '') + '||' + (item.bracket || '');
                    if (!seen[key]) { seen[key] = true; grandTotal += (item.fee || 0); }
                });
            }
        });
    }

    // ì›ê°€ ë³´ì¡´ (í• ì¸ ê³„ì‚° ê¸°ì¤€)
    window._feeGrandTotal = grandTotal;

    // ê³µê¸‰ê°€ì•¡/ì„¸ì•¡/ì´ê³„ í‘œì‹œ (í• ì¸ ì „ ì›ê°€ ê¸°ì¤€)
    var supply = Math.round(grandTotal / 1.1);
    var vat = grandTotal - supply;
    document.getElementById('fee-supply').textContent = supply.toLocaleString() + 'ì›';
    document.getElementById('fee-vat').textContent = vat.toLocaleString() + 'ì›';
    document.getElementById('fee-total').textContent = grandTotal.toLocaleString() + 'ì›';

    // í• ì¸ ì ìš© â†’ window._feeTotal ì„¤ì • + í• ì¸ê°€ í‘œì‹œ
    applyDiscount();
}

// ============================================================================
// í• ì¸ ê¸°ëŠ¥ (% â†” ê¸ˆì•¡ ì–‘ë°©í–¥ ì—°ë™)
// ============================================================================

/**
 * í• ì¸ìœ¨(%) ì…ë ¥ â†’ í• ì¸ê¸ˆì•¡ ìë™ ê³„ì‚°
 */
function onDiscountRateChange() {
    var rate = parseFloat(document.getElementById('discount-rate').value) || 0;
    if (rate < 0) rate = 0;
    if (rate > 100) rate = 100;
    var original = window._feeGrandTotal || 0;
    var discountAmt = Math.round(original * rate / 100);
    document.getElementById('discount-amount').value = discountAmt || '';
    applyDiscount();
}

/**
 * í• ì¸ê¸ˆì•¡ ì…ë ¥ â†’ í• ì¸ìœ¨ ìë™ ê³„ì‚°
 */
function onDiscountAmountChange() {
    var amt = parseInt(document.getElementById('discount-amount').value) || 0;
    if (amt < 0) amt = 0;
    var original = window._feeGrandTotal || 0;
    var rate = original > 0 ? (amt / original * 100) : 0;
    // ì†Œìˆ˜ì  1ìë¦¬ ë°˜ì˜¬ë¦¼ (ì˜ˆ: 11.1%)
    document.getElementById('discount-rate').value = rate > 0 ? Math.round(rate * 10) / 10 : '';
    applyDiscount();
}

/**
 * í• ì¸ ì ìš© â†’ ìµœì¢…ê°€ ê³„ì‚° + í‘œì‹œ + window._feeTotal ê°±ì‹ 
 */
function applyDiscount() {
    var original = window._feeGrandTotal || 0;
    var discountAmt = parseInt(document.getElementById('discount-amount')?.value) || 0;
    if (discountAmt < 0) discountAmt = 0;
    if (discountAmt > original) discountAmt = original;

    var finalTotal = original - discountAmt;
    window._feeTotal = finalTotal;

    // í• ì¸ ì ìš©ê°€ í‘œì‹œ
    var finalEl = document.getElementById('discount-final');
    if (finalEl) {
        finalEl.textContent = finalTotal.toLocaleString() + 'ì›';
    }

    // í• ì¸ ìˆì„ ë•Œ ì‹œê°ì  ê°•ì¡°
    var section = document.getElementById('discount-section');
    if (section) {
        if (discountAmt > 0) {
            section.style.background = '#fff2e0';
            section.style.borderColor = '#f59e0b';
        } else {
            section.style.background = '#fff8f0';
            section.style.borderColor = '#fed7aa';
        }
    }

    updatePaymentSummary();
}

// ============================================================================
// ê²°ì œë°©ë²• í† ê¸€
// ============================================================================
function togglePayMethod() {
    var val = document.querySelector('input[name="pay-method"]:checked')?.value || '';
    document.getElementById('pay-card-panel').style.display = (val === 'ì¹´ë“œ') ? '' : 'none';
    document.getElementById('pay-online-panel').style.display = (val === 'ì˜¨ë¼ì¸') ? '' : 'none';
}

// ============================================================================
// ì…ê¸ˆ ë‚´ì—­ ê´€ë¦¬
// ============================================================================
var _paymentCount = 0;
function addPaymentEntry() {
    _paymentCount++;
    var container = document.getElementById('payment-entries');
    var div = document.createElement('div');
    div.className = 'payment-entry';
    div.id = 'payment-entry-' + _paymentCount;
    div.style.cssText = 'display:grid;grid-template-columns:40px 1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:8px;padding:10px;background:#f8f9fb;border-radius:8px;border:1px solid #e2e6ed';
    div.innerHTML =
        '<div style="font-size:12px;font-weight:700;color:#6941C6;text-align:center;padding-bottom:12px">' + _paymentCount + '</div>' +
        '<div class="form-group" style="margin:0"><label style="font-size:11px">ì…ê¸ˆì¼</label><input type="date" class="pay-entry-date" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;width:100%"></div>' +
        '<div class="form-group" style="margin:0"><label style="font-size:11px">ì…ê¸ˆì•¡</label><input type="text" class="pay-entry-amount" placeholder="ê¸ˆì•¡" oninput="this.value=this.value.replace(/[^0-9]/g,\'\');updatePaymentSummary()" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;width:100%"></div>' +
        '<div class="form-group" style="margin:0"><label style="font-size:11px">ë¹„ê³ </label><input type="text" class="pay-entry-memo" placeholder="ë©”ëª¨" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:12px;width:100%"></div>' +
        '<button type="button" onclick="removePaymentEntry(' + _paymentCount + ')" style="background:none;border:none;cursor:pointer;font-size:16px;color:#e53935;padding-bottom:8px">âœ•</button>';
    container.appendChild(div);
    document.getElementById('payment-summary').style.display = '';
    updatePaymentSummary();
}
function removePaymentEntry(id) {
    var el = document.getElementById('payment-entry-' + id);
    if (el) el.remove();
    updatePaymentSummary();
    if (document.querySelectorAll('.payment-entry').length === 0) {
        document.getElementById('payment-summary').style.display = 'none';
    }
}
function updatePaymentSummary() {
    var total = 0;
    document.querySelectorAll('.pay-entry-amount').forEach(function(el) {
        total += parseInt(el.value) || 0;
    });
    var feeTotal = window._feeTotal || 0;
    var remain = feeTotal - total;
    document.getElementById('payment-total').textContent = total.toLocaleString() + 'ì›';
    document.getElementById('payment-remain').textContent = remain.toLocaleString() + 'ì›';
    document.getElementById('payment-remain').style.color = remain > 0 ? '#e53935' : '#2e7d32';
}

// ============================================================================
// ì†Œë¹„ê¸°í•œ ì¼ìˆ˜ â†’ ë‚ ì§œ ìë™ ê³„ì‚°
// ============================================================================
function calcExpiryDate() {
    var mfDate = document.getElementById('manufacture-date').value;
    var days = parseInt(document.getElementById('expiry-days').value);
    if (mfDate && days > 0) {
        var d = new Date(mfDate);
        d.setDate(d.getDate() + days);
        var yyyy = d.getFullYear();
        var mm = String(d.getMonth() + 1).padStart(2, '0');
        var dd = String(d.getDate()).padStart(2, '0');
        document.getElementById('expiry-date').value = yyyy + '-' + mm + '-' + dd;
    }
}

// ============================================================================
// ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì„¤ì •
// ============================================================================
function setPrevReceiptNo() {
    const prevNo = document.getElementById('prev-receipt-no').value.trim();
    if (prevNo) showToast(`ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸: ${prevNo}ì—ì„œ ì´ì–´ì„œ ì‹œì‘í•©ë‹ˆë‹¤.`, 'info');
}

// ============================================================================
// ì ‘ìˆ˜ë²ˆí˜¸ ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ìƒì„± (ê²€ì‚¬ëª©ì ê´€ë¦¬ ì„¤ì • ì—°ë™)
// ============================================================================
function buildReceiptNoFromSegments(purposeObj, testField) {
    const segments = purposeObj.segments;
    const sep = (purposeObj.segSep === 'none' || purposeObj.segSep === '') ? '' : (purposeObj.segSep !== undefined && purposeObj.segSep !== null ? purposeObj.segSep : '-');
    const fieldId = getFieldCode(testField);
    const today = new Date();
    const y4 = today.getFullYear().toString();
    const y2 = y4.slice(2);
    const m = (today.getMonth() + 1).toString().padStart(2, '0');
    const d = today.getDate().toString().padStart(2, '0');

    const parts = [];
    segments.forEach(s => {
        switch(s.t) {
            case 'fixed':
                // fieldCodesê°€ ìˆìœ¼ë©´ ë¶„ì•¼ë³„ ì½”ë“œ ì‚¬ìš©
                if (purposeObj.fieldCodes && purposeObj.fieldCodes[fieldId]) {
                    parts.push(purposeObj.fieldCodes[fieldId]);
                } else {
                    parts.push(s.v || '??');
                }
                break;
            case 'field':
                parts.push(fieldId);
                break;
            case 'year':
                parts.push(s.v === '4' ? y4 : y2);
                break;
            case 'month':
                parts.push(m);
                break;
            case 'day':
                parts.push(d);
                break;
            case 'serial':
                const digits = parseInt(s.v) || 4;
                parts.push('1'.padStart(digits, '0'));
                break;
            case 'purpose':
                const pDigits = parseInt(s.digits) || 2;
                parts.push((s.v || '01').padStart(pDigits, '0'));
                break;
        }
    });
    return parts.join(sep);
}

// ============================================================================
// ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ (ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ + API + í´ë°±)
// ============================================================================
async function allocateReceiptNo() {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const testPurpose = document.getElementById('test-purpose').value;

    if (!testField || !testPurpose) {
        showToast('ì‹œí—˜ë¶„ì•¼ì™€ ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!', 'error');
        return;
    }

    const prevReceiptNo = document.getElementById('prev-receipt-no').value.trim();
    let receiptNo = '';

    // ì„ íƒëœ ê²€ì‚¬ëª©ì ì˜ P ê°ì²´ ì°¾ê¸° (ì‹œí—˜ë¶„ì•¼ ë§¤ì¹­ ìš°ì„ )
    const fieldCode = getFieldCode(testField);
    const purposeObj = firestorePurposes.find(p => p.n === testPurpose && p.fields && p.fields.includes(fieldCode))
        || firestorePurposes.find(p => p.n === testPurpose);

    // 1ìˆœìœ„: ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ìƒì„± (ê²€ì‚¬ëª©ì ê´€ë¦¬ì—ì„œ ì„¤ì •í•œ ì ‘ìˆ˜ë²ˆí˜¸ í˜•ì‹)
    if (purposeObj && purposeObj.segments && purposeObj.segments.length > 0) {
        receiptNo = buildReceiptNoFromSegments(purposeObj, testField);
        console.log(`[ì„¸ê·¸ë¨¼íŠ¸] ì ‘ìˆ˜ë²ˆí˜¸ ìƒì„±: ${receiptNo} (${testPurpose})`);
    }

    // 2ìˆœìœ„: API í˜¸ì¶œ (ì„¸ê·¸ë¨¼íŠ¸ ë¯¸ì„¤ì • ì‹œ)
    if (!receiptNo && apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/receipt-no/allocate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ testField, testPurpose, prevReceiptNo })
            });
            if (res.ok) {
                const data = await res.json();
                receiptNo = data.receiptNo;
                console.log(`[API] ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹: ${receiptNo}`);
            }
        } catch (e) {
            console.warn('[API] ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // 3ìˆœìœ„: ê¸°ì¡´ í´ë°± (ì„¸ê·¸ë¨¼íŠ¸ ì—†ê³  APIë„ ì‹¤íŒ¨ ì‹œ)
    if (!receiptNo) {
        const today = new Date();
        const yy = today.getFullYear().toString().slice(2);
        const mm = (today.getMonth() + 1).toString().padStart(2, '0');
        const dd = today.getDate().toString().padStart(2, '0');

        const purposeCode = FALLBACK_TEST_PURPOSE_CODES[testPurpose] || 'XX';
        const fieldCode = getFieldCode(testField);

        let seq = '001';
        if (prevReceiptNo) {
            const match = prevReceiptNo.match(/(\d+)-\d+$/);
            if (match) seq = (parseInt(match[1]) + 1).toString().padStart(3, '0');
        }

        receiptNo = `${yy}${mm}${dd}${fieldCode}${purposeCode}${seq}-001`;
        console.log(`[í´ë°±] ì ‘ìˆ˜ë²ˆí˜¸ ìƒì„±: ${receiptNo}`);
    }

    document.getElementById('receipt-no').value = receiptNo;
    document.getElementById('receipt-no').classList.add('receipt-no-allocated');
    document.getElementById('receipt-no-status').textContent = 'âœ… í• ë‹¹ ì™„ë£Œ - ì ‘ìˆ˜ ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
    document.getElementById('receipt-no-status').style.color = '#4caf50';
    document.getElementById('status').value = 'ì ‘ìˆ˜ì¤‘';
    document.getElementById('receipt-no-warning').style.display = 'none';

    isReceiptNoAllocated = true;
    showToast(`ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ ì™„ë£Œ: ${receiptNo}`);
}

// ============================================================================
// ì—…ì²´ ê²€ìƒ‰ (API ì—°ë™ + í´ë°±)
// ============================================================================
let companySearchTimeout = null;

function searchCompany(query, callback) {
    // ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬ (300ms)
    clearTimeout(companySearchTimeout);
    companySearchTimeout = setTimeout(() => _searchCompany(query, callback), 300);
}

async function _searchCompany(query, callback) {
    const suggestions = document.getElementById('company-suggestions');
    if (!query || query.length < 1) {
        suggestions.classList.remove('active');
        return;
    }

    const field = document.querySelector('input[name="test-field"]:checked')?.value || 'ì‹í’ˆ';
    let companies = [];

    // Firestore companies ì»¬ë ‰ì…˜ì—ì„œ ê²€ìƒ‰ (firestore-helpers.js)
    try {
        if (typeof fsSearchCompanies === 'function') {
            const allResults = await fsSearchCompanies(query, 50);
            // ë¶„ì•¼ ì¼ì¹˜ ì—…ì²´ ìš°ì„ , ë¶ˆì¼ì¹˜ ì—…ì²´ë„ í¬í•¨
            var matched = [], unmatched = [];
            allResults.forEach(function(c) {
                if (!c.licenses || c.licenses.length === 0) {
                    matched.push(c);
                } else if (c.licenses.some(function(lic) { return (lic.licField || lic.field) === field; })) {
                    matched.push(c);
                } else {
                    unmatched.push(c);
                }
            });
            companies = matched.concat(unmatched).slice(0, 20);
            console.log(`[Firestore] ì—…ì²´ ê²€ìƒ‰: "${query}" (${field}) - ${companies.length}ê±´ (ë¶„ì•¼ì¼ì¹˜: ${matched.length}, ê¸°íƒ€: ${unmatched.length})`);
        }
    } catch (e) {
        console.warn('[Firestore] ì—…ì²´ ê²€ìƒ‰ ì‹¤íŒ¨:', e.message);
    }

    // í´ë°±: API ë˜ëŠ” í•˜ë“œì½”ë”© ë°ì´í„°
    if (companies.length === 0 && apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/companies/search?q=${encodeURIComponent(query)}`);
            if (res.ok) {
                const data = await res.json();
                companies = (data.companies || []).map(function(c) {
                    return { company: c.name, name: c.name, bizNo: c.businessNo, businessNo: c.businessNo, repName: c.ceo, ceo: c.ceo, contactPhone: c.phone, licenses: [] };
                });
            }
        } catch (e) { /* ignore */ }
    }
    if (companies.length === 0) {
        companies = FALLBACK_COMPANIES.filter(c => c.name.toLowerCase().includes(query.toLowerCase())).map(function(c) {
            return { company: c.name, name: c.name, bizNo: c.businessNo, businessNo: c.businessNo, repName: c.ceo, ceo: c.ceo, contactPhone: c.phone, licenses: [] };
        });
    }

    if (companies.length === 0) {
        suggestions.innerHTML = '<div style="padding:12px;color:#8892a4;font-size:12px;text-align:center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        suggestions.classList.add('active');
        if (typeof callback === 'function') callback(false);
        return;
    }

    suggestions.innerHTML = companies.map(function(c) {
        var companyNm = c.company || c.name || '-';
        var bizNo = c.bizNo || c.businessNo || '';
        var ceoNm = c.repName || c.ceo || '';
        // í•´ë‹¹ ë¶„ì•¼ ì¸í—ˆê°€ ì°¾ê¸°
        var lic = (c.licenses || []).find(function(l) { return (l.licField || l.field) === field; }) || (c.licenses || [])[0] || {};
        var licNo = lic.licNo || lic.licenseNo || '';
        var licBiz = lic.licBizForm || lic.bizForm || '';
        var licBizName = lic.licBizName || '';
        // ì¸í—ˆê°€ ì˜ì—…ì†Œëª… ìš°ì„  í‘œì‹œ
        var displayNm = licBizName || companyNm;
        var cData = JSON.stringify(c).replace(/"/g, '&quot;');
        return '<div class="suggestion-item" onclick="selectCompany(this)" data-company="' + cData + '">' +
            '<strong>' + displayNm + '</strong>' +
            (licBiz ? ' <span style="font-size:10px;background:#e3f2fd;color:#1565c0;padding:1px 5px;border-radius:3px">' + licBiz + '</span>' : '') +
            (licBizName && licBizName !== companyNm ? ' <span style="font-size:10px;color:#8892a4">(' + companyNm + ')</span>' : '') +
            '<br><small style="color:#8892a4">' +
            (licNo ? 'ì¸í—ˆê°€: ' + licNo + ' | ' : '') +
            (bizNo ? 'ì‚¬ì—…ì: ' + bizNo + ' | ' : '') +
            ceoNm + '</small></div>';
    }).join('');
    suggestions.classList.add('active');
    if (typeof callback === 'function') callback(true);
}

// ============================================================================
// ì—…ì²´ ì„ íƒ
// ============================================================================
function selectCompany(elOrObj) {
    var c;
    if (elOrObj && elOrObj.getAttribute) {
        // DOM element í´ë¦­ â†’ data-company ì†ì„±ì—ì„œ íŒŒì‹±
        c = JSON.parse(elOrObj.getAttribute('data-company'));
    } else if (typeof elOrObj === 'string') {
        c = JSON.parse(elOrObj);
    } else {
        c = elOrObj;
    }

    var field = document.querySelector('input[name="test-field"]:checked')?.value || 'ì‹í’ˆ';
    // í•´ë‹¹ ë¶„ì•¼ì˜ ì¸í—ˆê°€ ì°¾ê¸°
    var lic = (c.licenses || []).find(function(l) { return (l.licField || l.field) === field; }) || (c.licenses || [])[0] || {};

    // ê±°ë˜ì²˜ëª… (ì¸í—ˆê°€ ì˜ì—…ì†Œëª… ìš°ì„ )
    var nm = lic.licBizName || c.company || c.name || '';
    document.getElementById('company-search').value = nm;

    // ì¸í—ˆê°€ ì •ë³´
    document.getElementById('lic-no').value = lic.licNo || lic.licenseNo || '';
    document.getElementById('lic-biz-form').value = lic.licBizForm || lic.bizForm || '';
    document.getElementById('lic-biz-name').value = lic.licBizName || lic.bizName || nm;

    // ì—…ì²´ ì „í™”ë²ˆí˜¸, íŒ©ìŠ¤ë²ˆí˜¸, íœ´ëŒ€í°, ì£¼ì†Œ (ì¸í—ˆê°€ ì •ë³´ ê¸°ì¤€)
    document.getElementById('company-phone').value = c.contactPhone || c.phone || '';
    var fax = c.contactFax || '';
    if (!fax && c.contacts && c.contacts[0]) fax = c.contacts[0].fax || '';
    document.getElementById('company-fax').value = fax;
    var mob = c.contactMobile || '';
    if (!mob && c.contacts && c.contacts[0]) mob = c.contacts[0].mobile || '';
    document.getElementById('company-mobile').value = mob;
    var licAddr = lic.licAddr || '';
    var licAddr2 = lic.licAddr2 || lic.licAddrDetail || '';
    document.getElementById('company-address').value = licAddr + (licAddr2 ? ' ' + licAddr2 : '');

    // ë‹´ë‹¹ì
    var rep = c.salesRep || '';
    if (!rep && c.contacts && c.contacts[0]) rep = c.contacts[0].salesRep || '';
    document.getElementById('sales-rep').value = rep;

    // ê³„ì‚°ì„œ ì •ë³´ ìë™ ì±„ì›€ (ì‚¬ì—…ì ì •ë³´ + ë‹´ë‹¹ì)
    document.getElementById('company-name').value = nm;
    document.getElementById('business-no').value = c.bizNo || c.businessNo || '';
    document.getElementById('ceo').value = c.repName || c.ceo || '';
    document.getElementById('bill-name').value = c.taxName || '';
    document.getElementById('bill-phone').value = c.taxPhone || '';
    document.getElementById('bill-fax').value = c.taxFax || '';
    document.getElementById('bill-mobile').value = c.taxMobile || '';
    document.getElementById('bill-email').value = c.taxEmail || '';

    // ì—…ì²´ ë³€ê²½ì´ë ¥ í‘œì‹œ
    var clWrap = document.getElementById('company-changelog');
    var clBody = document.getElementById('company-changelog-body');
    var logs = c.changeLog || [];
    if (logs.length > 0 && clWrap && clBody) {
        clWrap.style.display = '';
        var html = '<table style="width:100%;border-collapse:collapse">' +
            '<tr style="border-bottom:1px solid #e2e6ed;color:#8892a4">' +
            '<th style="text-align:left;padding:4px 6px;width:130px">ì¼ì‹œ</th>' +
            '<th style="text-align:left;padding:4px 6px;width:70px">ë³€ê²½ì</th>' +
            '<th style="text-align:left;padding:4px 6px">ë³€ê²½ ë‚´ìš©</th>' +
            '<th style="text-align:right;padding:4px 6px;width:80px">ë¯¸ìˆ˜ê¸ˆ</th></tr>';
        logs.slice().reverse().forEach(function(log) {
            html += '<tr style="border-bottom:1px solid #f5f5f5">' +
                '<td style="padding:4px 6px;color:#5f6b7a;white-space:nowrap">' + (log.date || '') + '</td>' +
                '<td style="padding:4px 6px">' + (log.who || '') + '</td>' +
                '<td style="padding:4px 6px;font-size:10px">' + (log.detail || '') + '</td>' +
                '<td style="padding:4px 6px;text-align:right;color:#d32f2f;font-weight:600">' + (log.receivable || '') + '</td></tr>';
        });
        html += '</table>';
        clBody.innerHTML = html;
    } else if (clWrap) {
        clWrap.style.display = 'none';
    }

    // ì„±ì ì„œ ë°œì†¡ìš© ë°ì´í„° ë³´ê´€
    window._selectedCompany = {
        company: nm,
        addr1: c.addr1 || c.address || '',
        addr2: c.addr2 || c.addressDetail || '',
        contactFax: fax,
        taxEmail: c.taxEmail || '',
        contacts: c.contacts || []
    };
    // ë°œì†¡ ì˜µì…˜ ì´ˆê¸°í™”
    document.querySelectorAll('input[name="report-send"]').forEach(function(cb){ cb.checked = false; });
    document.getElementById('mail-option-panel').style.display = 'none';
    document.getElementById('fax-option-panel').style.display = 'none';
    document.getElementById('email-option-panel').style.display = 'none';
    document.getElementById('report-fax-no').value = '';
    document.getElementById('report-email').value = '';
    document.getElementById('email-cc-toggle').checked = false;
    document.getElementById('email-cc-panel').style.display = 'none';
    document.getElementById('email-cc-fields').innerHTML = '<input type="email" class="cc-email-field" placeholder="CC ì´ë©”ì¼ 1" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;margin-bottom:4px">';
    document.getElementById('mail-zipcode').value = '';
    document.getElementById('mail-addr1').value = '';
    document.getElementById('mail-addr2').value = '';
    document.querySelectorAll('input[name="mail-addr-type"]').forEach(function(cb){ cb.checked = false; });
    document.getElementById('mail-other-addr-panel').style.display = 'none';
    document.querySelectorAll('input[name="fax-type"]').forEach(function(cb){ cb.checked = false; });
    document.getElementById('fax-other-panel').style.display = 'none';

    document.getElementById('company-suggestions').classList.remove('active');
    showToast('ì—…ì²´ ì„ íƒ: ' + nm + (lic.licNo ? ' (ì¸í—ˆê°€: ' + lic.licNo + ')' : ''), 'info');
}

// ============================================================================
// íŒ€ë³„ ë©”ëª¨ ê¶Œí•œ
// ============================================================================
function setupTeamMemoPermissions() {
    ['customer','quality','finance','marketing','sales'].forEach(team => {
        const textarea = document.getElementById(`memo-${team}`);
        const lock = document.getElementById(`${team}-lock`);
        if (team === currentUserTeam) {
            textarea.disabled = false;
            lock.textContent = 'ğŸ”“ í¸ì§‘ ê°€ëŠ¥';
            lock.style.color = '#4caf50';
        } else {
            textarea.disabled = true;
            lock.textContent = 'ğŸ”’ ì½ê¸° ì „ìš©';
            lock.style.color = '#999';
        }
    });
}

// ============================================================================
// ìˆ˜ì • í‘œì‹œ
// ============================================================================
function markAsModified() {
    if (!isModified) {
        isModified = true;
        const btn = document.getElementById('save-btn');
        btn.classList.add('modified');
        btn.textContent = 'ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥';
    }
}

// ============================================================================
// ì ‘ìˆ˜ ë°ì´í„° ìˆ˜ì§‘
// ============================================================================
function collectReceiptData() {
    // í˜„ì¬ ì‹œë£Œ ì €ì¥
    saveSampleToArray();
    // ì„±ì ì„œ ë°œì†¡ ì •ë³´
    var reportSend = [];
    document.querySelectorAll('input[name="report-send"]:checked').forEach(function(cb){ reportSend.push(cb.value); });
    var mailAddrTypes = [];
    document.querySelectorAll('input[name="mail-addr-type"]:checked').forEach(function(cb){ mailAddrTypes.push(cb.value); });
    var faxTypes = [];
    document.querySelectorAll('input[name="fax-type"]:checked').forEach(function(cb){ faxTypes.push(cb.value); });

    return {
        receiptNo: document.getElementById('receipt-no').value,
        receiptDate: document.getElementById('receipt-date').value,
        testField: document.querySelector('input[name="test-field"]:checked')?.value || '',
        testPurpose: document.getElementById('test-purpose')?.value || '',
        urgent: document.querySelector('input[name="urgency"]:checked')?.value || 'ì¼ë°˜',
        status: document.getElementById('status').value,
        sampleTotalCount: parseInt(document.getElementById('sample-total-count').value) || 1,
        // ì—…ì²´ì •ë³´
        companyName: document.getElementById('company-search').value,
        licNo: document.getElementById('lic-no').value,
        licBizForm: document.getElementById('lic-biz-form').value,
        companyPhone: document.getElementById('company-phone').value,
        companyFax: document.getElementById('company-fax').value,
        companyMobile: document.getElementById('company-mobile').value,
        companyAddress: document.getElementById('company-address').value,
        salesRep: document.getElementById('sales-rep').value,
        // ì„±ì ì„œ ë°œì†¡
        reportSend: reportSend,
        mailAddrTypes: mailAddrTypes,
        mailZipcode: document.getElementById('mail-zipcode').value,
        mailAddr1: document.getElementById('mail-addr1').value,
        mailAddr2: document.getElementById('mail-addr2').value,
        faxTypes: faxTypes,
        reportFaxNo: document.getElementById('report-fax-no').value,
        reportEmail: document.getElementById('report-email').value,
        emailCc: (function() {
            var cc = [];
            document.querySelectorAll('.cc-email-field').forEach(function(el){ if(el.value) cc.push(el.value); });
            return cc;
        })(),
        // ì‹œë£Œ ë°ì´í„° ë°°ì—´
        samples: _sampleData.map(function(s, i) {
            return {
                idx: i + 1,
                productName: s['product-name'] || '',
                foodType: s['food-type-input'] || '',
                foodTypeValue: s['food-type-value'] || '',
                mfdsProductCode: s['mfds-product-code'] || '',
                mfdsProductName: s['mfds-product-name'] || '',
                sampleAmount: s['sample-amount'] || '',
                sampleAmountUnit: s['sample-amount-unit'] || 'g',
                sampleCount: s['sample-count'] || '',
                packageUnit: s['package-unit'] || '',
                transportStatus: s['transport-status'] || '',
                manufactureNo: s['manufacture-no'] || '',
                manufactureDate: s['manufacture-date'] || '',
                expiryDate: s['expiry-date'] || '',
                expiryDays: s['expiry-days'] || '',
                sampleLocation: s['sample-location'] || '',
                sampleBoxNo: s['sample-box-no'] || '',
                remarks: s['remarks'] || '',
                // ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸) ê°œë³„ ì‹œí—˜í•­ëª© (ìˆëŠ” ê²½ìš°ë§Œ)
                refTestItems: s._refTestItems || null
            };
        }),
        // ê²€ì‚¬ì •ë³´
        relatedLaw: document.getElementById('related-law')?.value || '',
        documentNo: document.getElementById('document-no')?.value || '',
        // ê³„ì‚°ì„œ ì •ë³´
        billCompany: document.getElementById('company-name')?.value || '',
        bizNo: document.getElementById('business-no')?.value || '',
        ceo: document.getElementById('ceo')?.value || '',
        billName: document.getElementById('bill-name')?.value || '',
        billPhone: document.getElementById('bill-phone')?.value || '',
        billFax: document.getElementById('bill-fax')?.value || '',
        billMobile: document.getElementById('bill-mobile')?.value || '',
        billEmail: document.getElementById('bill-email')?.value || '',
        // ê³„ì‚°ì„œ ë°œí–‰ì¼ ìœ í˜•
        billingDateType: document.getElementById('billing-date-type')?.value || 'receipt',
        billingDate: document.getElementById('billing-date')?.value || '',
        // íŒ€ ë©”ëª¨
        memoCustomer: document.getElementById('memo-customer')?.value || '',
        memoMarketing: document.getElementById('memo-marketing')?.value || '',
        memoSales: document.getElementById('memo-sales')?.value || '',
        // ì²˜ë¦¬ê¸°í•œ
        processingDeadline: document.getElementById('processing-deadline')?.value || '',
        // ìˆ˜ìˆ˜ë£Œ/ê²°ì œ ì •ë³´
        feeOriginal: window._feeGrandTotal || 0,
        discountRate: parseFloat(document.getElementById('discount-rate')?.value) || 0,
        discountAmount: parseInt(document.getElementById('discount-amount')?.value) || 0,
        feeTotal: window._feeTotal || 0,
        payMethod: document.querySelector('input[name="pay-method"]:checked')?.value || '',
        payCardDate: document.getElementById('pay-card-date')?.value || '',
        payDepositor: document.getElementById('pay-depositor')?.value || '',
        payBankAccount: document.getElementById('pay-bank-account')?.value || '',
        payCounterBank: document.getElementById('pay-counter-bank')?.value || '',
        payDate: document.getElementById('pay-date')?.value || '',
        payments: (function() {
            var arr = [];
            document.querySelectorAll('.payment-entry').forEach(function(entry) {
                arr.push({
                    date: entry.querySelector('.pay-entry-date')?.value || '',
                    amount: parseInt(entry.querySelector('.pay-entry-amount')?.value) || 0,
                    memo: entry.querySelector('.pay-entry-memo')?.value || ''
                });
            });
            return arr;
        })()
    };
}

// ============================================================================
// ì €ì¥
// ============================================================================
async function saveReceipt() {
    if (!isReceiptNoAllocated) {
        showToast('ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!', 'error');
        return;
    }
    try {
        var data = collectReceiptData();
        data.status = 'ì ‘ìˆ˜ì¤‘';
        await fsSaveReceipt(data);
        showToast('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        isModified = false;
        var btn = document.getElementById('save-btn');
        btn.classList.remove('modified');
        btn.textContent = 'ğŸ’¾ ì €ì¥';
        document.getElementById('status').value = 'ì ‘ìˆ˜ì¤‘';
    } catch(err) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', err);
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ============================================================================
// ì„ì‹œì €ì¥
// ============================================================================
function saveDraft() {
    const data = {
        receiptNo: document.getElementById('receipt-no').value,
        foodType: document.getElementById('food-type-value').value,
        memoCustomer: document.getElementById('memo-customer').value
    };
    localStorage.setItem('receipt-draft', JSON.stringify(data));
    showToast('ğŸ’¾ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ë¶ˆëŸ¬ì˜¤ê¸°
// ============================================================================
function loadDraft() {
    const draft = localStorage.getItem('receipt-draft');
    if (!draft) return;
    const data = JSON.parse(draft);
    Object.keys(data).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = data[key];
    });
}

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
function resetForm() {
    if (!confirm('ì…ë ¥í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    document.getElementById('receipt-form').reset();
    localStorage.removeItem('receipt-draft');
    isReceiptNoAllocated = false;
    isModified = false;

    document.getElementById('receipt-no').value = '';
    document.getElementById('receipt-no').classList.remove('receipt-no-allocated');
    document.getElementById('receipt-no-status').textContent = 'âŒ ë¯¸í• ë‹¹';
    document.getElementById('receipt-no-status').style.color = '#f44336';
    document.getElementById('status').value = 'ëŒ€ê¸°ì¤‘';
    document.getElementById('receipt-no-warning').style.display = 'flex';

    setTodayDate();
    clearInspectionItems();

    // ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ì´ˆê¸°í™”
    if (typeof MFDS_CODES !== 'undefined') {
        MFDS_CODES._clearProductSelection('mfds-product-picker-container');
    }

    // ì‹œë£Œ í¼ ì´ˆê¸°í™”
    _sampleData = [{}];
    _currentSampleIdx = 0;
    document.getElementById('sample-total-count').value = '1';
    renderSampleNav();

    // ì„±ì ì„œ ë°œì†¡ ì˜µì…˜ ì´ˆê¸°í™”
    document.querySelectorAll('input[name="report-send"]').forEach(function(cb){ cb.checked = false; });
    document.getElementById('mail-option-panel').style.display = 'none';
    document.getElementById('fax-option-panel').style.display = 'none';
    document.getElementById('email-option-panel').style.display = 'none';
    document.getElementById('report-fax-no').value = '';
    document.getElementById('report-email').value = '';
    document.getElementById('email-cc-toggle').checked = false;
    document.getElementById('email-cc-panel').style.display = 'none';
    document.getElementById('email-cc-fields').innerHTML = '<input type="email" class="cc-email-field" placeholder="CC ì´ë©”ì¼ 1" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;margin-bottom:4px">';
    document.getElementById('mail-zipcode').value = '';
    document.getElementById('mail-addr1').value = '';
    document.getElementById('mail-addr2').value = '';
    document.querySelectorAll('input[name="mail-addr-type"]').forEach(function(cb){ cb.checked = false; });
    document.getElementById('mail-other-addr-panel').style.display = 'none';
    document.getElementById('mail-biz-addr-preview').textContent = '';
    document.getElementById('mail-lic-addr-preview').textContent = '';
    document.querySelectorAll('input[name="fax-type"]').forEach(function(cb){ cb.checked = false; });
    document.getElementById('fax-other-panel').style.display = 'none';
    document.getElementById('fax-registered-preview').textContent = '';
    document.getElementById('company-fax').value = '';
    window._selectedCompany = null;

    const btn = document.getElementById('save-btn');
    btn.classList.remove('modified');
    btn.textContent = 'ğŸ’¾ ì €ì¥';

    showToast('ğŸ”„ í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ì œì¶œ
// ============================================================================
document.getElementById('receipt-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!isReceiptNoAllocated) {
        showToast('ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!', 'error');
        return;
    }

    const required = [
        {id:'receipt-date', name:'ì ‘ìˆ˜ì¼ì'},
        {id:'company-search', name:'ê±°ë˜ì²˜'},
        {id:'food-type-value', name:'ê²€ì²´ìœ í˜•'},
        {id:'product-name', name:'ì œí’ˆ/ì‹œë£Œëª…'},
        {id:'sample-amount', name:'ê²€ì²´ëŸ‰'},
        {id:'sample-count', name:'ê²€ì²´ìˆ˜'}
    ];

    for (const f of required) {
        const el = document.getElementById(f.id);
        if (!el.value) {
            showToast(`${f.name}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'error');
            el.focus();
            return;
        }
    }

    try {
        var data = collectReceiptData();
        data.status = 'ì ‘ìˆ˜ì™„ë£Œ';
        await fsSaveReceipt(data);
        showToast('âœ… ì‹œë£Œ ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        setTimeout(() => {
            localStorage.removeItem('receipt-draft');
            window.location.reload();
        }, 2000);
    } catch(err) {
        console.error('ì ‘ìˆ˜ ì™„ë£Œ ì‹¤íŒ¨:', err);
        showToast('ì ‘ìˆ˜ ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
});

// ============================================================================
// í† ìŠ¤íŠ¸
// ============================================================================
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast';
    if (type) toast.classList.add(type);
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
}

// ============================================================================
// ì œí’ˆ ì ‘ìˆ˜ì´ë ¥ ì¡°íšŒ
// ============================================================================
async function searchProductHistory() {
    var pn = (document.getElementById('product-name').value || '').trim();
    var panel = document.getElementById('product-history-panel');
    if (!pn) {
        showToast('ì œí’ˆ/ì‹œë£Œëª…ì„ ì…ë ¥ í›„ ì¡°íšŒí•˜ì„¸ìš”.', 'warning');
        return;
    }
    panel.innerHTML = '<div style="padding:16px;text-align:center;color:#888"><span class="loading-spinner" style="display:inline-block;width:16px;height:16px;border:2px solid #ddd;border-top-color:#5b67f5;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:6px"></span> ì¡°íšŒ ì¤‘...</div>';
    panel.style.display = '';
    try {
        var snap = await db.collection('receipts')
            .where('productName', '==', pn)
            .limit(50)
            .get();
        if (snap.empty) {
            panel.innerHTML = '<div style="padding:16px;text-align:center;color:#999;font-size:13px">ğŸ“­ "' + pn + '" ì ‘ìˆ˜ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        // í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ (ìµœì‹ ìˆœ)
        var docs = snap.docs.sort(function(a, b) {
            var ta = a.data().createdAt?.toDate?.() || new Date(0);
            var tb = b.data().createdAt?.toDate?.() || new Date(0);
            return tb - ta;
        }).slice(0, 20);
        var html = '<div style="padding:8px 12px;border-bottom:1px solid #eee;font-size:11px;font-weight:700;color:#5f6b7a;display:flex;gap:4px;align-items:center">ğŸ“‹ ì ‘ìˆ˜ì´ë ¥ <span style="color:#5b67f5">' + docs.length + 'ê±´</span><span style="flex:1"></span><button type="button" onclick="closeProductHistory()" style="border:none;background:none;cursor:pointer;font-size:14px;color:#999">âœ•</button></div>';
        docs.forEach(function(doc) {
            var r = doc.data();
            var dt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toISOString().slice(0,10) : '';
            var rno = r.receiptNo || '-';
            var ft = r.foodType || '';
            var co = r.companyName || '';
            var tf = r.testField || '';
            var tp = r.testPurpose || '';
            html += '<div class="product-history-item" onclick="fillFromHistory(\'' + doc.id + '\')" style="padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;font-size:12px;transition:background 0.15s"';
            html += ' onmouseover="this.style.background=\'#f0f4ff\'" onmouseout="this.style.background=\'#fff\'">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">';
            html += '<span style="font-weight:600;color:#1565c0;font-family:monospace">' + rno + '</span>';
            html += '<span style="color:#888;font-size:11px">' + dt + '</span>';
            html += '</div>';
            html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
            if (tf) html += '<span style="background:#e3f2fd;color:#1565c0;padding:1px 6px;border-radius:4px;font-size:10px">' + tf + '</span>';
            if (tp) html += '<span style="background:#f3e5f5;color:#7b1fa2;padding:1px 6px;border-radius:4px;font-size:10px">' + tp + '</span>';
            if (ft) html += '<span style="background:#e8f5e9;color:#2e7d32;padding:1px 6px;border-radius:4px;font-size:10px">' + ft + '</span>';
            if (co) html += '<span style="color:#666;font-size:11px">ğŸ¢ ' + co + '</span>';
            html += '</div></div>';
        });
        panel.innerHTML = html;
    } catch(e) {
        console.warn('[ì œí’ˆì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨]', e);
        panel.innerHTML = '<div style="padding:16px;text-align:center;color:#e53935;font-size:13px">âš ï¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (e.message || '') + '</div>';
    }
}

function closeProductHistory() {
    document.getElementById('product-history-panel').style.display = 'none';
}

async function fillFromHistory(docId) {
    try {
        var doc = await db.collection('receipts').doc(docId).get();
        if (!doc.exists) { showToast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
        var r = doc.data();
        // ì‹œë£Œì •ë³´ ìë™ ì±„ì›€
        if (r.foodType) {
            document.getElementById('food-type-input').value = r.foodType;
            document.getElementById('food-type-value').value = r.foodType;
        }
        if (r.sampleAmount) document.getElementById('sample-amount').value = r.sampleAmount;
        if (r.sampleCount) document.getElementById('sample-count').value = r.sampleCount;
        if (r.packageUnit) document.getElementById('package-unit').value = r.packageUnit;
        if (r.transportStatus) document.getElementById('transport-status').value = r.transportStatus;
        if (r.manufactureNo) document.getElementById('manufacture-no').value = r.manufactureNo;
        // ì‹ì•½ì²˜ í’ˆëª©ì½”ë“œ ë³µì› (ì‹œë£Œ ë°°ì—´ ì²« ë²ˆì§¸ì—ì„œ)
        if (r.samples && r.samples[0]) {
            var s0 = r.samples[0];
            if (s0.mfdsProductCode) {
                document.getElementById('mfds-product-code').value = s0.mfdsProductCode;
                document.getElementById('mfds-product-name').value = s0.mfdsProductName || '';
                restoreMfdsProductDisplay();
            }
        }
        closeProductHistory();
        showToast('ğŸ“‹ ì´ì „ ì ‘ìˆ˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
    } catch(e) {
        console.warn('[ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨]', e);
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
    }
}

// ============================================================================
// ì™¸ë¶€ í´ë¦­
// ============================================================================
document.addEventListener('click', function(e) {
    if (!e.target.closest('.company-search')) {
        document.getElementById('company-suggestions').classList.remove('active');
    }
    if (!e.target.closest('.autocomplete-input')) {
        document.getElementById('food-type-list').classList.remove('active');
    }
    // ì œí’ˆì´ë ¥ íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
    if (!e.target.closest('#product-history-panel') && !e.target.closest('[onclick*="searchProductHistory"]')) {
        var ph = document.getElementById('product-history-panel');
        if (ph) ph.style.display = 'none';
    }
});

// ì‚¬ì´ë“œë°” JS â†’ js/sidebar.jsë¡œ ì´ê´€ë¨
</script>
</body>
</html>
