<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ì‹œë£Œ ì ‘ìˆ˜ ë“±ë¡</title>
<style>
:root{--primary:#2563eb;--success:#10b981;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-600:#4b5563;--gray-900:#111827;--accent:#667eea;--accent2:#764ba2}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;background:#f5f5f5;color:#1a1a1a}
.app-layout{display:flex;height:100vh}
/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */
.main-container{flex:1;margin-left:250px;display:flex;flex-direction:column;overflow:hidden}
.top-header{background:white;padding:16px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:#64748b}
.breadcrumb-current{color:#1e293b;font-weight:600}
.server-status{display:flex;align-items:center;gap:6px;font-size:12px;padding:4px 12px;border-radius:20px;background:#f1f5f9}
.server-status.online{color:#16a34a;background:#f0fdf4}
.server-status.offline{color:#dc2626;background:#fef2f2}
.main-content{flex:1;overflow-y:auto;padding:24px}

/* ====== RECEIPT FORM STYLES ====== */
.form-container{max-width:1100px;margin:0 auto}
.section{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;background:white}
.section-header{background:#f8f9fa;padding:18px 24px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:16px;color:#333;transition:all 0.3s}
.section-header:hover{background:#e9ecef}
.section-header.active{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white}
.toggle-icon{transition:transform 0.3s;font-size:12px}
.section-header.active .toggle-icon{transform:rotate(180deg)}
.section-content{padding:24px;display:none}
.section-content.active{display:block}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
.form-group{display:flex;flex-direction:column}
.form-group label{font-weight:500;margin-bottom:8px;color:#333;font-size:14px}
.required{color:#f44336;margin-left:4px}
.form-group input,.form-group select,.form-group textarea{padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:all 0.3s;font-family:inherit}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.form-group input:disabled,.form-group select:disabled,.form-group textarea:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
.pin-check{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:400;color:#888;cursor:pointer;margin-left:8px;vertical-align:middle}
.pin-check input[type="checkbox"]{width:14px;height:14px;accent-color:#ff9800;cursor:pointer}
.pin-check.active{color:#ff9800;font-weight:600}
.radio-group{display:flex;gap:20px;margin-top:8px}
.radio-label{display:flex;align-items:center;padding:10px 20px;border:2px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.3s;margin-bottom:0!important}
.radio-label:hover{border-color:var(--accent);background:#f8f9ff}
.radio-label input[type="radio"]:checked{accent-color:var(--accent)}
.radio-label input[type="radio"]{margin-right:8px}
.company-search{position:relative}
.search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#999}
.suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none}
.suggestions.active{display:block}
.suggestion-item{padding:12px;cursor:pointer;transition:background 0.2s}
.suggestion-item:hover{background:#f5f7fa}
.field-help{font-size:12px;color:#999;margin-top:4px}
.buttons{display:flex;gap:12px;justify-content:center;margin-top:40px;padding-top:30px;border-top:1px solid #e0e0e0}
.btn-receipt{padding:14px 32px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s}
.btn-receipt.primary{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white}
.btn-receipt.primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4)}
.btn-receipt.save{background:#e0e0e0;color:#666}
.btn-receipt.save.modified{background:linear-gradient(135deg,#1de9b6 0%,#1dc4e9 100%);color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.btn-receipt.secondary{background:white;color:var(--accent);border:2px solid var(--accent)}
.btn-receipt.secondary:hover{background:#f8f9ff}
.btn-receipt.cancel{background:#f5f5f5;color:#666}
.btn-receipt.cancel:hover{background:#e0e0e0}
.auto-value{background:#e3f2fd;border-color:#90caf9}
.receipt-no-allocated{background:#c8e6c9;border-color:#4caf50;font-weight:600}
.autocomplete-input{position:relative}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none}
.autocomplete-list.active{display:block}
.autocomplete-item{padding:10px;cursor:pointer;transition:background 0.2s}
.autocomplete-item:hover{background:#f0f0f0}
.autocomplete-item mark{background:#ffeb3b;padding:0 2px}
.team-memo{border-left:4px solid;padding:16px;margin-bottom:16px;background:#f9f9f9;border-radius:8px}
.team-memo.customer-support{border-color:#2196f3}
.team-memo.quality{border-color:#4caf50}
.team-memo.finance{border-color:#ff9800}
.team-memo.marketing{border-color:#e91e63}
.team-memo-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.team-memo-title{font-weight:600;font-size:14px}
.team-memo-lock{font-size:12px;color:#999}
.team-memo textarea{width:100%;min-height:80px;resize:vertical}
.team-memo textarea:disabled{background:#fafafa;cursor:not-allowed}
.toast{position:fixed;top:20px;right:20px;background:#4caf50;color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);display:none;z-index:2000;min-width:250px}
.toast.active{display:block;animation:slideIn 0.3s}
.toast.error{background:#f44336}
.toast.warning{background:#ff9800}
.toast.info{background:#2196f3}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:16px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.warning-box-icon{font-size:24px}
.warning-box-text{flex:1}
@media(max-width:768px){.sidebar{display:none}.main-container{margin-left:0}.form-row{grid-template-columns:1fr}.buttons{flex-direction:column}.btn-receipt{width:100%}}
/* ì»¤ìŠ¤í…€ ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ */
.custom-select-wrap{position:relative;width:100%}
.custom-select-display{padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.3s}
.custom-select-display:hover{border-color:var(--accent)}
.custom-select-display.open{border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,126,234,0.1);border-radius:8px 8px 0 0}
.custom-select-arrow{color:#888;font-size:12px;transition:transform 0.2s}
.custom-select-display.open .custom-select-arrow{transform:rotate(180deg)}
.custom-select-options{display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--accent);border-top:none;border-radius:0 0 8px 8px;max-height:300px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.custom-select-options.open{display:block}
.custom-select-option{padding:10px 14px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:8px;transition:background 0.15s}
.custom-select-option:hover{background:#f0f4ff}
.custom-select-option.selected{background:#e8edff;font-weight:600}
.custom-select-option .field-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.custom-select-option .field-label{font-size:12px;padding:1px 6px;border-radius:4px;color:#fff;margin-left:auto;white-space:nowrap}
</style>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>
</head>
<body>
<div class="app-layout">
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=2"></script>
<div class="main-container">
<header class="top-header">
<div class="breadcrumb">
<span>ì ‘ìˆ˜ ê´€ë¦¬</span>
<span>â€º</span>
<span class="breadcrumb-current">ì ‘ìˆ˜ ë“±ë¡</span>
</div>
<div class="server-status offline" id="server-status">
<span id="server-status-icon">ğŸ”´</span>
<span id="server-status-text">API ì˜¤í”„ë¼ì¸</span>
</div>
</header>
<main class="main-content">
<div class="form-container">
    <form id="receipt-form">

        <!-- 1. ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´ -->
        <div class="section">
            <div class="section-header active" onclick="toggleSection(this)">
                <span>ğŸ“‹ ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content active">
                <div class="warning-box" id="receipt-no-warning">
                    <span class="warning-box-icon">âš ï¸</span>
                    <div class="warning-box-text">
                        <strong>ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!</strong><br>
                        ë™ì‹œ ì ‘ìˆ˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ í›„ ì‘ì—…ì„ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <div class="form-row" style="grid-template-columns:auto 1fr auto;align-items:end;margin-bottom:16px">
                    <div class="form-group">
                        <label>ì‹œí—˜ë¶„ì•¼ <span class="required">*</span>
                            <label class="pin-check" title="ê³ ì •: ë‹¤ìŒ ì ‘ìˆ˜ì—ë„ ì´ ì‹œí—˜ë¶„ì•¼ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤">
                                <input type="checkbox" id="pin-test-field" onchange="togglePin('test-field')"> ğŸ“Œ ê³ ì •
                            </label>
                        </label>
                        <div class="radio-group" style="margin-top:0;gap:12px">
                            <label class="radio-label" style="padding:11px 18px">
                                <input type="radio" name="test-field" value="ì‹í’ˆ" checked onchange="onTestFieldChange()">
                                <span>ğŸ ì‹í’ˆ</span>
                            </label>
                            <label class="radio-label" style="padding:11px 18px">
                                <input type="radio" name="test-field" value="ì¶•ì‚°" onchange="onTestFieldChange()">
                                <span>ğŸ¥© ì¶•ì‚°</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì‚¬ëª©ì  <span class="required">*</span>
                            <label class="pin-check" title="ê³ ì •: ë‹¤ìŒ ì ‘ìˆ˜ì—ë„ ì´ ê²€ì‚¬ëª©ì ì„ ìœ ì§€í•©ë‹ˆë‹¤">
                                <input type="checkbox" id="pin-test-purpose" onchange="togglePin('test-purpose')"> ğŸ“Œ ê³ ì •
                            </label>
                        </label>
                        <select id="test-purpose" required onchange="onTestPurposeChange()" style="display:none;">
                            <option value="">ë¨¼ì € ì‹œí—˜ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <div class="custom-select-wrap" id="test-purpose-custom">
                            <div class="custom-select-display" id="test-purpose-display" onclick="toggleCustomSelect()">
                                <span class="custom-select-text">ì„ íƒí•˜ì„¸ìš”</span>
                                <span class="custom-select-arrow">â–¾</span>
                            </div>
                            <div class="custom-select-options" id="test-purpose-options"></div>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn-receipt primary" onclick="allocateReceiptNo()" style="padding:11px 24px;white-space:nowrap">
                            ğŸ”¢ ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹
                        </button>
                    </div>
                </div>

                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="form-group">
                        <label>ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ (ì„ íƒ)</label>
                        <input type="text" id="prev-receipt-no" placeholder="ì˜ˆ: 260207FQ001-001" onchange="setPrevReceiptNo()">
                        <small class="field-help">ì´ì–´ë°›ì„ ê²½ìš° ì…ë ¥í•˜ì„¸ìš”</small>
                    </div>
                    <div class="form-group">
                        <label>í• ë‹¹ëœ ì ‘ìˆ˜ë²ˆí˜¸</label>
                        <input type="text" id="receipt-no" class="auto-value" readonly>
                        <small class="field-help" id="receipt-no-status" style="color:#f44336;">âŒ ë¯¸í• ë‹¹</small>
                    </div>
                    <div class="form-group">
                        <label>ì ‘ìˆ˜ì¼ì <span class="required">*</span>
                            <label class="pin-check" title="ê³ ì •: ë‹¤ìŒ ì ‘ìˆ˜ì—ë„ ì´ ì ‘ìˆ˜ì¼ìë¥¼ ìœ ì§€í•©ë‹ˆë‹¤">
                                <input type="checkbox" id="pin-receipt-date" onchange="togglePin('receipt-date')"> ğŸ“Œ ê³ ì •
                            </label>
                        </label>
                        <input type="date" id="receipt-date" required onchange="calculateProcessingDeadline()">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ê¸´ê¸‰ì—¬ë¶€</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="urgent" value="ì¼ë°˜" checked>
                                <span>ì¼ë°˜</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="urgent" value="ê¸´ê¸‰">
                                <span>âš¡ ê¸´ê¸‰</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì²˜ë¦¬ê¸°í•œ</label>
                        <input type="date" id="processing-deadline" class="auto-value" readonly>
                        <small class="field-help">ì ‘ìˆ˜ì¼ + ì›Œí‚¹ë°ì´ 12ì¼</small>
                    </div>
                    <div class="form-group">
                        <label>ìƒíƒœ</label>
                        <input type="text" id="status" value="ëŒ€ê¸°ì¤‘" class="auto-value" readonly>
                        <small class="field-help">ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ í›„ 'ì ‘ìˆ˜ì¤‘'</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ì—…ì²´ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ¢ ì—…ì²´ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="form-group company-search">
                        <label>ê±°ë˜ì²˜ <span class="required">*</span></label>
                        <input type="text" id="company-search" placeholder="ì—…ì²´ëª… ê²€ìƒ‰..." oninput="searchCompany(this.value)" required>
                        <span class="search-icon">ğŸ”</span>
                        <div class="suggestions" id="company-suggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>ì¸í—ˆê°€ë²ˆí˜¸</label>
                        <input type="text" id="lic-no" readonly style="font-family:monospace;color:#1565c0">
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì</label>
                        <input type="text" id="sales-rep" readonly style="background:#f0f4c3;font-weight:600">
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="form-group">
                        <label>ì¸í—ˆê°€ ë¶„ì•¼</label>
                        <input type="text" id="lic-biz-form" readonly>
                    </div>
                    <div class="form-group">
                        <label>ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="company-phone" readonly>
                    </div>
                    <div class="form-group">
                        <label>íœ´ëŒ€í°</label>
                        <input type="tel" id="company-mobile" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì£¼ì†Œ</label>
                        <input type="text" id="company-address" readonly>
                    </div>
                </div>
                <input type="hidden" id="lic-biz-name">
                <!-- ì—…ì²´ ë³€ê²½ì´ë ¥ -->
                <div id="company-changelog" style="display:none;margin-top:12px;border-top:1px solid #e2e6ed;padding-top:10px">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                        <div style="font-size:12px;font-weight:600;color:#5f6b7a">ğŸ“‹ ë³€ê²½ì´ë ¥</div>
                        <button type="button" onclick="toggleChangeLog()" id="changelog-toggle-btn" style="background:none;border:1px solid #e2e6ed;border-radius:4px;padding:2px 8px;font-size:11px;color:#5f6b7a;cursor:pointer">ì ‘ê¸° â–²</button>
                    </div>
                    <div id="company-changelog-body" style="max-height:150px;overflow-y:auto;font-size:11px"></div>
                </div>
            </div>
        </div>

        <!-- 3. ì‹œë£Œì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ§ª ì‹œë£Œì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row" style="grid-template-columns:1fr 1fr auto;align-items:start">
                    <div class="form-group" style="position:relative">
                        <label>ì œí’ˆ/ì‹œë£Œëª… <span class="required">*</span></label>
                        <div style="display:flex;gap:6px">
                            <input type="text" id="product-name" required style="flex:1;min-width:0">
                            <button type="button" class="btn-receipt secondary" onclick="searchProductHistory()" style="padding:8px 14px;font-size:13px;white-space:nowrap">ğŸ“‹ ì¡°íšŒ</button>
                        </div>
                        <div id="product-history-panel" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:200;background:#fff;border:1px solid #d0d5dd;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.15);margin-top:4px;max-height:300px;overflow-y:auto"></div>
                    </div>
                    <div class="form-group autocomplete-input">
                        <label>ê²€ì²´ìœ í˜• <span class="required">*</span></label>
                        <input type="text" id="food-type-input" placeholder="ê²€ìƒ‰ ë˜ëŠ” í´ë¦­..." oninput="searchFoodType(this.value)" onfocus="searchFoodType('')" required autocomplete="off">
                        <input type="hidden" id="food-type-value">
                        <div class="autocomplete-list" id="food-type-list"></div>
                        <small class="field-help">ì‹œí—˜ë¶„ì•¼ + ê²€ì‚¬ëª©ì ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                    <div style="padding-top:24px">
                        <button type="button" disabled class="btn-receipt secondary" style="padding:9px 16px;font-size:13px;opacity:0.6;cursor:not-allowed" title="3ì›” êµ¬í˜„ ì˜ˆì •">ğŸ” APIì¡°íšŒ <span style="font-size:10px;color:#999">(3ì›”)</span></button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ê²€ì²´ëŸ‰ <span class="required">*</span></label>
                        <input type="text" id="sample-amount" placeholder="ì˜ˆ: 500g, 1L" required>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì²´ìˆ˜ <span class="required">*</span></label>
                        <input type="number" id="sample-count" placeholder="ì˜ˆ: 3" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>í¬ì¥ë‹¨ìœ„</label>
                        <input type="text" id="package-unit" placeholder="ì˜ˆ: ë³‘, íŒ©, ë´‰ì§€">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìš´ë°˜ìƒíƒœ</label>
                        <select id="transport-status">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ëƒ‰ì¥">â„ï¸ ëƒ‰ì¥</option>
                            <option value="ëƒ‰ë™">ğŸ§Š ëƒ‰ë™</option>
                            <option value="ì‹¤ì˜¨">ğŸŒ¡ï¸ ì‹¤ì˜¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>í’ˆëª©ì œì¡°NO</label>
                        <input type="text" id="manufacture-no">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì œì¡°ì¼ì</label>
                        <input type="date" id="manufacture-date">
                    </div>
                    <div class="form-group">
                        <label>ìœ íš¨ê¸°ê°„</label>
                        <input type="date" id="expiry-date">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œë£Œìœ„ì¹˜</label>
                        <input type="text" id="sample-location" placeholder="ì˜ˆ: A-01">
                    </div>
                    <div class="form-group">
                        <label>ì‹œë£Œë°•ìŠ¤ë²ˆí˜¸</label>
                        <input type="text" id="sample-box-no">
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. ê²€ì‚¬ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ“Š ê²€ì‚¬ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>ê´€ë ¨ë²•ë ¹</label>
                        <select id="related-law">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì‹í’ˆìœ„ìƒë²•">ì‹í’ˆìœ„ìƒë²•</option>
                            <option value="ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²•">ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²•</option>
                            <option value="ê±´ê°•ê¸°ëŠ¥ì‹í’ˆë²•">ê±´ê°•ê¸°ëŠ¥ì‹í’ˆë²•</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì‚¬êµ¬ë¶„</label>
                        <select id="test-type" disabled>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <small class="field-help">ì¶”í›„ ìˆ˜ì • ì˜ˆì •</small>
                    </div>
                    <div class="form-group">
                        <label>ì˜ë¢°êµ¬ë¶„</label>
                        <select id="request-type" disabled>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <small class="field-help">ì¶”í›„ ìˆ˜ì • ì˜ˆì •</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¬¸ì„œë²ˆí˜¸</label>
                        <input type="text" id="document-no">
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. ê³„ì‚°ì„œ ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ§¾ ê³„ì‚°ì„œ ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <!-- ì‚¬ì—…ìë“±ë¡ì¦ ì •ë³´ (ì—…ì²´ ì„ íƒ ì‹œ ìë™ ì±„ì›€) -->
                <div class="form-row">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œì—…ì²´</label>
                        <input type="text" id="company-name" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                        <input type="text" id="business-no" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ëŒ€í‘œì</label>
                        <input type="text" id="ceo" readonly style="background:#e8f5e9">
                    </div>
                </div>
                <!-- ê³„ì‚°ì„œ ë‹´ë‹¹ ì •ë³´ (ì—…ì²´ ì„ íƒ ì‹œ ìë™ ì±„ì›€) -->
                <div class="form-row" style="grid-template-columns:repeat(4,1fr)">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œ ë‹´ë‹¹ì</label>
                        <input type="text" id="bill-name" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="tel" id="bill-phone" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>íœ´ëŒ€í°</label>
                        <input type="tel" id="bill-mobile" readonly style="background:#e8f5e9">
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="bill-email" readonly style="background:#e8f5e9">
                    </div>
                </div>

                <!-- ìˆ˜ì • ì²´í¬ë°•ìŠ¤ -->
                <div style="margin-bottom:15px">
                    <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
                        <input type="checkbox" id="bill-edit-check" onchange="toggleBillEdit()">
                        <span>ê³„ì‚°ì„œ ì…ë ¥ ì •ë³´ ìˆ˜ì •í•˜ê¸°</span>
                    </label>
                </div>

                <!-- ìˆ˜ì • ì…ë ¥ ì˜ì—­ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                <div id="bill-edit-area" style="display:none;border:1px dashed #bdbdbd;border-radius:8px;padding:16px;background:#fff8e1;margin-bottom:16px">
                    <div class="form-row" style="grid-template-columns:repeat(4,1fr)">
                        <div class="form-group">
                            <label>ê³„ì‚°ì„œì—…ì²´ëª…</label>
                            <input type="text" id="bill-edit-company">
                        </div>
                        <div class="form-group">
                            <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                            <input type="text" id="bill-edit-bizno">
                        </div>
                        <div class="form-group">
                            <label>ë‹´ë‹¹ì</label>
                            <input type="text" id="bill-edit-name">
                        </div>
                        <div class="form-group">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" id="bill-edit-phone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="bill-edit-email">
                        </div>
                    </div>
                </div>

                <!-- ë°œí–‰ ì˜µì…˜ -->
                <div class="form-row">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œ ë°œí–‰ì¼</label>
                        <select id="billing-date-type" onchange="onBillingDateTypeChange()">
                            <option value="receipt">ì ‘ìˆ˜ì¼</option>
                            <option value="specific">íŠ¹ì •ì¼</option>
                            <option value="monthEnd">ì›”ë§ ë°œí–‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>íŠ¹ì •ì¼</label>
                        <input type="date" id="billing-date" style="display:none">
                    </div>
                    <div class="form-group">
                        <label>ë°œí–‰ ìœ í˜•</label>
                        <select id="billing-type" onchange="onBillingTypeChange()">
                            <option value="byPurpose">ëª©ì ë³„ êµ¬ë¶„ ë°œí–‰</option>
                            <option value="combined">í•©ì‚° ë°œí–‰</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="billing-type-note-row" style="display:none">
                    <div class="form-group">
                        <label>ê¸°íƒ€ ë‚´ìš©</label>
                        <textarea id="billing-type-note" rows="2" placeholder="ê¸°íƒ€ ë°œí–‰ ë°©ì‹ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. íŒ€ë³„ ë©”ëª¨ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ“ íŒ€ë³„ ë©”ëª¨</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="team-memo customer-support">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’™ ê³ ê°ì§€ì›íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="customer-lock">ğŸ”“ í¸ì§‘ ê°€ëŠ¥</span>
                    </div>
                    <textarea id="memo-customer" rows="4" placeholder="ê³ ê°ì§€ì›íŒ€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="markAsModified()"></textarea>
                </div>
                <div class="team-memo quality">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’š í’ˆì§ˆë³´ì¦íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="quality-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-quality" rows="4" placeholder="í’ˆì§ˆë³´ì¦íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">í’ˆì§ˆë³´ì¦íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo finance">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ§¡ ì¬ë¬´íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="finance-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-finance" rows="4" placeholder="ì¬ë¬´íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">ì¬ë¬´íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo marketing">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’— ë§ˆì¼€íŒ…íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="marketing-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-marketing" rows="4" placeholder="ë§ˆì¼€íŒ…íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">ë§ˆì¼€íŒ…íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="buttons">
            <button type="button" class="btn-receipt secondary" onclick="saveDraft()">
                ğŸ’¾ ì„ì‹œì €ì¥
            </button>
            <button type="button" class="btn-receipt save" id="save-btn" onclick="saveReceipt()">
                ğŸ’¾ ì €ì¥
            </button>
            <button type="submit" class="btn-receipt primary">
                âœ… ì ‘ìˆ˜ ì™„ë£Œ
            </button>
            <button type="button" class="btn-receipt cancel" onclick="resetForm()">
                âŒ ì·¨ì†Œ
            </button>
        </div>
    </form>
</div>
</main>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================================
// API ì„¤ì •
// ============================================================================
const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://127.0.0.1:5001' : '';
let apiOnline = false;
let firestorePurposes = [];  // Firestoreì—ì„œ ë¡œë“œí•œ ê²€ì‚¬ëª©ì  P ë°°ì—´
let firestoreFields = [];    // Firestoreì—ì„œ ë¡œë“œí•œ ê²€ì‚¬ ë¶„ì•¼ ì •ë³´ [{code,name,color}]
let firestoreReady = false;  // Firebase ì¤€ë¹„ ìƒíƒœ

// ============================================================================
// í´ë°± ë°ì´í„° (API ì„œë²„ ë¯¸ì‹¤í–‰ ì‹œ ì‚¬ìš©)
// ============================================================================
const FALLBACK_TEST_PURPOSE_MAPPING = {
  'ì‹í’ˆ': [
    'Allergen(RT-PCR)', 'ì—°êµ¬ìš©ì—­', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©',
    'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)', 'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)'
  ],
  'ì¶•ì‚°': [
    'Allergen(ELISA)', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©',
    'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)', 'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)'
  ]
};

const FALLBACK_TEST_PURPOSE_CODES = {
  'Allergen(RT-PCR)': 'AR', 'Allergen(ELISA)': 'AE',
  'ì—°êµ¬ìš©ì—­': 'RD', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': 'QC',
  'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': 'PR', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': 'RF',
  'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': 'SL', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': 'NR',
  'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': 'AB'
};

const FALLBACK_FOOD_TYPE_BY_PURPOSE = {
  'ì‹í’ˆ-Allergen(RT-PCR)': ['Sample', 'ê¸°íƒ€ê°€ê³µí’ˆ', 'ê³¼ì', 'ë¹µë¥˜'],
  'ì‹í’ˆ-ì—°êµ¬ìš©ì—­': ['Sample', 'ê¸°íƒ€ê°€ê³µí’ˆ'],
  'ì‹í’ˆ-ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': ['Sample', 'ê°€ê³µê¹€(ì¡°ë¯¸ê¹€ ë˜ëŠ” êµ¬ìš´ê¹€)', 'ê°€ê³µì†Œê¸ˆ', 'ê°„í¸ì¡°ë¦¬ì„¸íŠ¸', 'ê³ ì¶§ê°€ë£¨', 'ê³¼ì', 'ê¹€ì¹˜', 'ë¹µë¥˜', 'ì†ŒìŠ¤', 'ì»¤í”¼'],
  'ì‹í’ˆ-ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': ['Sample', 'ì”ë¥˜ë†ì•½(463ì¢…)', 'ì”ë¥˜ë†ì•½(510ì¢…)'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': ['Sample', 'ê³¼.ì±„ê°€ê³µí’ˆ', 'ê³¼.ì±„ìŒë£Œ', 'ê¸°íƒ€ê°€ê³µí’ˆ', 'ì•¡ìƒì°¨'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': ['Sample', 'ê¸°íƒ€ë†ì‚°ê°€ê³µí’ˆ', 'ê¸°íƒ€ìˆ˜ì‚°ë¬¼ê°€ê³µí’ˆ'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': ['Sample', 'ê³µì¤‘ë‚™í•˜ê· ', 'í‘œë©´ê· ', 'ê³¼ì', 'ë¹µë¥˜'],
  'ì¶•ì‚°-Allergen(ELISA)': ['Sample', 'ê°€ê³µì¹˜ì¦ˆ', 'ì†Œì‹œì§€'],
  'ì¶•ì‚°-ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': ['Sample', 'ê°€ê³µì¹˜ì¦ˆ', 'ì†Œì‹œì§€', 'í–„', 'ì–‘ë…ìœ¡', 'í¬ì¥ìœ¡'],
  'ì¶•ì‚°-ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': ['Sample', 'ê±´ì¡°ì €ì¥ìœ¡ë¥˜', 'ë¶„ì‡„ê°€ê³µìœ¡ì œí’ˆ', 'ì‹ìœ¡ì¶”ì¶œê°€ê³µí’ˆ'],
  'ì¶•ì‚°-ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': ['Sample', 'ì‹ìš©ë€', 'ì¹˜ì¦ˆ', 'ë°œíš¨ìœ ', 'ë†í›„ë°œíš¨ìœ '],
  'ì¶•ì‚°-í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': ['Sample', 'í•­ìƒë¬¼ì§ˆ(156ì¢…)', 'í•­ìƒë¬¼ì§ˆ(99ì¢…)']
};

const FALLBACK_COMPANIES = [
  { id: 1, name: '(ì£¼)íƒ­ìŠ¤ì¸í„°ë‚´ì…”ë„1ê³µì¥', businessNo: '725-85-02346', ceo: 'ë°°ìœ¤ì„±', phone: '02-1234-5678' },
  { id: 2, name: '(ì£¼)ë‚˜ëˆ”ê³µë™ì²´', businessNo: '119-81-63685', ceo: 'ìµœì˜ë‚¨', phone: '02-2345-6789' },
  { id: 3, name: 'ìš°ë¦¬ë°”ì´ì˜¤ ì£¼ì‹íšŒì‚¬', businessNo: '134-81-55919', ceo: 'ì—„íƒœìš± ì™¸ 1ëª…', phone: '02-3456-7890' }
];

// ============================================================================
// ì „ì—­ ë³€ìˆ˜
// ============================================================================
let isReceiptNoAllocated = false;
let isModified = false;
let currentUserTeam = 'customer-support'; // ëª©ì—…: ê³ ê°ì§€ì›íŒ€ ì‚¬ìš©ì

// ============================================================================
// ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
// ============================================================================
async function checkServerStatus() {
    try {
        const res = await fetch(`${API_BASE}/api/health`, { signal: AbortSignal.timeout(3000) });
        if (res.ok) {
            apiOnline = true;
            updateServerStatusUI(true);
            return true;
        }
    } catch (e) {
        // ì„œë²„ ì—°ê²° ì‹¤íŒ¨
    }
    apiOnline = false;
    updateServerStatusUI(false);
    return false;
}

function updateServerStatusUI(online) {
    const statusEl = document.getElementById('server-status');
    const iconEl = document.getElementById('server-status-icon');
    const textEl = document.getElementById('server-status-text');
    if (online) {
        statusEl.className = 'server-status online';
        iconEl.textContent = 'ğŸŸ¢';
        textEl.textContent = 'API ì—°ê²°ë¨';
    } else {
        statusEl.className = 'server-status offline';
        iconEl.textContent = 'ğŸ”´';
        textEl.textContent = 'API ì˜¤í”„ë¼ì¸ (í´ë°± ëª¨ë“œ)';
    }
}

// ============================================================================
// Firebase ì´ˆê¸°í™” â€” Firestoreì—ì„œ ê²€ì‚¬ëª©ì (P ë°°ì—´) ë¡œë“œ
// ============================================================================
window.addEventListener('firebase-ready', async function() {
    firestoreReady = true;
    try {
        // ê²€ì‚¬ ë¶„ì•¼ ì •ë³´ ë¡œë“œ (ì‹í’ˆ/ì¶•ì‚° ë¼ë²¨, ìƒ‰ìƒ)
        const fieldsDoc = await db.collection('settings').doc('inspectionFields').get();
        if (fieldsDoc.exists && fieldsDoc.data().fields) {
            firestoreFields = fieldsDoc.data().fields;
            console.log('[Firestore] ê²€ì‚¬ ë¶„ì•¼ ë¡œë“œ:', firestoreFields.map(f => f.name).join(', '));
        }

        // ê²€ì‚¬ëª©ì  P ë°°ì—´ ë¡œë“œ
        const doc = await db.collection('settings').doc('inspectionPurposes').get();
        if (doc.exists && doc.data().purposes) {
            firestorePurposes = doc.data().purposes;
            // ì •ë ¬ìˆœì„œ(c) ê¸°ì¤€ ì •ë ¬
            firestorePurposes.sort((a, b) => (a.c || 999) - (b.c || 999));
            console.log('[Firestore] ê²€ì‚¬ëª©ì  ë¡œë“œ ì™„ë£Œ:', firestorePurposes.length + 'ê°œ');
            // í˜„ì¬ ì„ íƒëœ ì‹œí—˜ë¶„ì•¼ê°€ ìˆìœ¼ë©´ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
            const currentField = document.querySelector('input[name="test-field"]:checked')?.value;
            if (currentField) updateTestPurposeOptions(currentField);
        }
    } catch(e) {
        console.warn('[Firestore] ë¡œë“œ ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©:', e.message);
    }
});

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
window.onload = async function() {
    setTodayDate();

    // ì„œë²„ ìƒíƒœ í™•ì¸
    await checkServerStatus();

    // ì´ˆê¸° ì‹œí—˜ë¶„ì•¼ ì„ íƒ ì‹œ ê²€ì‚¬ëª©ì  ë¡œë“œ
    const initialTestField = document.querySelector('input[name="test-field"]:checked')?.value;
    if (initialTestField) {
        await updateTestPurposeOptions(initialTestField);
    }

    loadDraft();
    setupTeamMemoPermissions();

    // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
    document.querySelectorAll('input:not([readonly]), select:not([disabled]), textarea:not([disabled])').forEach(el => {
        el.addEventListener('input', markAsModified);
        el.addEventListener('change', markAsModified);
    });

    // ì£¼ê¸°ì  ì„œë²„ ìƒíƒœ í™•ì¸ (30ì´ˆë§ˆë‹¤)
    setInterval(checkServerStatus, 30000);
};

// ============================================================================
// Accordion í† ê¸€
// ============================================================================
function toggleSection(header) {
    header.classList.toggle('active');
    header.nextElementSibling.classList.toggle('active');
}

// ë³€ê²½ì´ë ¥ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleChangeLog() {
    var body = document.getElementById('company-changelog-body');
    var btn = document.getElementById('changelog-toggle-btn');
    if (body.style.display === 'none') {
        body.style.display = '';
        btn.textContent = 'ì ‘ê¸° â–²';
    } else {
        body.style.display = 'none';
        btn.textContent = 'í¼ì¹˜ê¸° â–¼';
    }
}

// ============================================================================
// ê³„ì‚°ì„œ ì •ë³´ í† ê¸€/ì¡°ê±´ë¶€ í‘œì‹œ
// ============================================================================
function toggleBillEdit() {
    var chk = document.getElementById('bill-edit-check').checked;
    document.getElementById('bill-edit-area').style.display = chk ? 'block' : 'none';
}
function onBillingDateTypeChange() {
    var v = document.getElementById('billing-date-type').value;
    document.getElementById('billing-date').style.display = v === 'specific' ? '' : 'none';
}
function onBillingTypeChange() {
    var v = document.getElementById('billing-type').value;
    document.getElementById('billing-type-note-row').style.display = v === 'other' ? '' : 'none';
}

// ============================================================================
// ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
// ============================================================================
function setTodayDate() {
    const pins = getPinnedFields();
    if (!pins['receipt-date']) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receipt-date').value = today;
    }
    restorePinnedFields();
    calculateProcessingDeadline();
}

// ============================================================================
// ì²˜ë¦¬ê¸°í•œ ê³„ì‚° (ì›Œí‚¹ë°ì´ 12ì¼ ê¸°ì¤€)
// ============================================================================
function getHolidays() {
    try {
        const stored = localStorage.getItem('bfl_holidays');
        return stored ? JSON.parse(stored) : [];
    } catch(e) { return []; }
}

function isWorkingDay(date) {
    const day = date.getDay();
    if (day === 0 || day === 6) return false; // ì£¼ë§
    const dateStr = date.toISOString().split('T')[0];
    const holidays = getHolidays();
    return !holidays.includes(dateStr);
}

function addWorkingDays(startDate, workDays) {
    const date = new Date(startDate);
    let added = 0;
    while (added < workDays) {
        date.setDate(date.getDate() + 1);
        if (isWorkingDay(date)) added++;
    }
    return date;
}

function calculateProcessingDeadline() {
    const receiptDate = document.getElementById('receipt-date').value;
    if (!receiptDate) return;
    const deadline = addWorkingDays(new Date(receiptDate), 12);
    document.getElementById('processing-deadline').value = deadline.toISOString().split('T')[0];
}

// ============================================================================
// ê³ ì • ì²´í¬(ğŸ“Œ) ê¸°ëŠ¥ â€” localStorageë¡œ ìœ ì§€
// ============================================================================
function togglePin(fieldId) {
    const checkbox = document.getElementById('pin-' + fieldId);
    const label = checkbox.closest('.pin-check');
    const pins = getPinnedFields();
    if (checkbox.checked) {
        if (fieldId === 'test-field') {
            pins[fieldId] = { value: document.querySelector('input[name="test-field"]:checked')?.value || 'ì‹í’ˆ', field: 'radio' };
        } else {
            const el = document.getElementById(fieldId);
            pins[fieldId] = { value: el.value, field: el.tagName === 'SELECT' ? 'select' : 'input' };
        }
        if (fieldId === 'test-purpose') {
            pins['_test-field-via-purpose'] = document.querySelector('input[name="test-field"]:checked')?.value || 'ì‹í’ˆ';
        }
        label.classList.add('active');
    } else {
        delete pins[fieldId];
        if (fieldId === 'test-purpose') delete pins['_test-field-via-purpose'];
        label.classList.remove('active');
    }
    localStorage.setItem('bfl_pinned_fields', JSON.stringify(pins));
}

function getPinnedFields() {
    try {
        return JSON.parse(localStorage.getItem('bfl_pinned_fields')) || {};
    } catch(e) { return {}; }
}

function restorePinnedFields() {
    const pins = getPinnedFields();
    // ì‹œí—˜ë¶„ì•¼ ë¨¼ì € ë³µì›
    if (pins['test-field']) {
        const checkbox = document.getElementById('pin-test-field');
        if (checkbox) {
            checkbox.checked = true;
            checkbox.closest('.pin-check').classList.add('active');
        }
        const radio = document.querySelector(`input[name="test-field"][value="${pins['test-field'].value}"]`);
        if (radio) radio.checked = true;
    }
    Object.keys(pins).forEach(fieldId => {
        if (fieldId === 'test-field' || fieldId === '_test-field-via-purpose') return;
        const checkbox = document.getElementById('pin-' + fieldId);
        const el = document.getElementById(fieldId);
        if (checkbox && el) {
            checkbox.checked = true;
            checkbox.closest('.pin-check').classList.add('active');
            // ê²€ì‚¬ëª©ì : ì‹œí—˜ë¶„ì•¼ ë¨¼ì € ë³µì› í›„ ì˜µì…˜ ë¡œë“œ â†’ ê°’ ì„¤ì •
            if (fieldId === 'test-purpose') {
                var tf = pins['_test-field-via-purpose'] || (pins['test-field'] && pins['test-field'].value) || 'ì‹í’ˆ';
                const radio = document.querySelector(`input[name="test-field"][value="${tf}"]`);
                if (radio) radio.checked = true;
                updateTestPurposeOptions(tf).then(() => {
                    el.value = pins[fieldId].value;
                });
            } else {
                el.value = pins[fieldId].value;
            }
        }
    });
    if (pins['receipt-date']) calculateProcessingDeadline();
}

// ============================================================================
// ì‹œí—˜ë¶„ì•¼ ë³€ê²½
// ============================================================================
function onTestFieldChange() {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;

    // ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    updateTestPurposeOptions(testField);

    // ê²€ì‚¬ëª©ì  ì´ˆê¸°í™”
    document.getElementById('test-purpose').value = '';

    // ê²€ì²´ìœ í˜• ì´ˆê¸°í™”
    document.getElementById('food-type-input').value = '';
    document.getElementById('food-type-value').value = '';

    // ì—…ì²´ì •ë³´ ì´ˆê¸°í™” (ë¶„ì•¼ ë³€ê²½ ì‹œ ì¸í—ˆê°€ ì •ë³´ê°€ ë‹¬ë¼ì§)
    document.getElementById('company-search').value = '';
    document.getElementById('lic-no').value = '';
    document.getElementById('lic-biz-form').value = '';
    document.getElementById('lic-biz-name').value = '';
    document.getElementById('company-phone').value = '';
    document.getElementById('company-mobile').value = '';
    document.getElementById('company-address').value = '';
    document.getElementById('sales-rep').value = '';
    var clWrap = document.getElementById('company-changelog');
    if (clWrap) clWrap.style.display = 'none';
    document.getElementById('company-suggestions').classList.remove('active');

    // ê³„ì‚°ì„œ ì •ë³´ ì´ˆê¸°í™”
    document.getElementById('company-name').value = '';
    document.getElementById('business-no').value = '';
    document.getElementById('ceo').value = '';
    document.getElementById('bill-name').value = '';
    document.getElementById('bill-phone').value = '';
    document.getElementById('bill-mobile').value = '';
    document.getElementById('bill-email').value = '';
    document.getElementById('bill-edit-check').checked = false;
    document.getElementById('bill-edit-area').style.display = 'none';

    showToast(`ì‹œí—˜ë¶„ì•¼ ì„ íƒ: ${testField}. ê²€ì‚¬ëª©ì ì„ ì„ íƒí•˜ì„¸ìš”.`, 'info');
}

// ============================================================================
// ê²€ì‚¬ëª©ì  ì˜µì…˜ ì—…ë°ì´íŠ¸ (Firestore ìš°ì„  â†’ API â†’ í´ë°±)
// ============================================================================
async function updateTestPurposeOptions(testField) {
    const select = document.getElementById('test-purpose');
    if (!select) {
        console.error('ê²€ì‚¬ëª©ì  select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const fieldId = testField === 'ì‹í’ˆ' ? 'F' : 'L';
    let purposes = [];

    // ë¶„ì•¼ ë¼ë²¨ í—¬í¼: firestoreFieldsì—ì„œ ë¶„ì•¼ì½”ë“œ â†’ ì´ë¦„ ë§¤í•‘
    function getFieldLabel(fieldCode) {
        const f = firestoreFields.find(f => f.code === fieldCode || f.id === fieldCode);
        return f ? f.name : fieldCode;
    }

    // 1ìˆœìœ„: Firestore P ë°°ì—´ (ê²€ì‚¬ëª©ì ê´€ë¦¬ì—ì„œ ì„¤ì •í•œ ì •ë ¬ìˆœì„œëŒ€ë¡œ)
    // o:0 (ë¯¸ì •) í•­ëª©ì€ ì œì™¸, ì´ë¦„ + ë¶„ì•¼ ë¼ë²¨ í¬í•¨
    if (firestorePurposes.length > 0) {
        purposes = firestorePurposes
            .filter(p => p.o !== 0 && p.fields && p.fields.includes(fieldId))
            .map(p => ({
                name: p.n,
                fieldCodes: p.fields || [],
                fieldLabels: (p.fields || []).map(fc => getFieldLabel(fc)),
                rcpt: p.rcpt || ''
            }));
        console.log(`[Firestore] ê²€ì‚¬ëª©ì  í•„í„°: ${testField}(${fieldId}) - ${purposes.length}ê°œ (ë¯¸ì • ì œì™¸)`);
    }

    // 2ìˆœìœ„: API (Firestore ë¯¸ë¡œë“œ ì‹œ)
    if (purposes.length === 0 && apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/test-purposes?field=${encodeURIComponent(testField)}`);
            if (res.ok) {
                const data = await res.json();
                purposes = (data.purposes || []).map(n => ({ name: n, fieldCodes: [], fieldLabels: [], rcpt: '' }));
                console.log(`[API] ê²€ì‚¬ëª©ì  ë¡œë“œ: ${testField} - ${purposes.length}ê°œ`);
            }
        } catch (e) {
            console.warn('[API] ê²€ì‚¬ëª©ì  ë¡œë“œ ì‹¤íŒ¨:', e.message);
        }
    }

    // 3ìˆœìœ„: í´ë°± (Firestore, API ëª¨ë‘ ì‹¤íŒ¨ ì‹œ)
    if (purposes.length === 0) {
        purposes = (FALLBACK_TEST_PURPOSE_MAPPING[testField] || []).map(n => ({ name: n, fieldCodes: [], fieldLabels: [], rcpt: '' }));
        console.log(`[í´ë°±] ê²€ì‚¬ëª©ì  ë¡œë“œ: ${testField} - ${purposes.length}ê°œ`);
    }

    // ë„¤ì´í‹°ë¸Œ select ë™ê¸°í™”
    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    purposes.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.textContent = item.name;
        select.appendChild(option);
    });

    // ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ ë Œë”ë§ (ë¶„ì•¼ ìƒ‰ìƒ ë¼ë²¨ í¬í•¨)
    renderCustomSelect(purposes);
}

// ============================================================================
// ì»¤ìŠ¤í…€ ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ (ë¶„ì•¼ ìƒ‰ìƒ ë¼ë²¨)
// ============================================================================
function renderCustomSelect(purposes) {
    const optionsDiv = document.getElementById('test-purpose-options');
    const displayEl = document.getElementById('test-purpose-display');
    optionsDiv.innerHTML = '';

    // "ì„ íƒí•˜ì„¸ìš”" ì˜µì…˜
    const placeholder = document.createElement('div');
    placeholder.className = 'custom-select-option';
    placeholder.textContent = 'ì„ íƒí•˜ì„¸ìš”';
    placeholder.dataset.value = '';
    placeholder.onclick = () => selectCustomOption('', 'ì„ íƒí•˜ì„¸ìš”', placeholder);
    optionsDiv.appendChild(placeholder);

    purposes.forEach(item => {
        const opt = document.createElement('div');
        opt.className = 'custom-select-option';
        opt.dataset.value = item.name;

        // ëª©ì  ì´ë¦„
        const nameSpan = document.createElement('span');
        nameSpan.textContent = item.name;
        opt.appendChild(nameSpan);

        opt.onclick = () => selectCustomOption(item.name, item.name, opt);
        optionsDiv.appendChild(opt);
    });

    // í˜„ì¬ ì„ íƒê°’ ì´ˆê¸°í™”
    displayEl.querySelector('.custom-select-text').textContent = 'ì„ íƒí•˜ì„¸ìš”';
}

function toggleCustomSelect() {
    const display = document.getElementById('test-purpose-display');
    const options = document.getElementById('test-purpose-options');
    display.classList.toggle('open');
    options.classList.toggle('open');
}

function selectCustomOption(value, text, optEl) {
    // ë„¤ì´í‹°ë¸Œ select ë™ê¸°í™”
    const select = document.getElementById('test-purpose');
    select.value = value;
    select.dispatchEvent(new Event('change'));

    // ì»¤ìŠ¤í…€ UI ì—…ë°ì´íŠ¸
    const display = document.getElementById('test-purpose-display');
    const textSpan = display.querySelector('.custom-select-text');

    if (value && optEl) {
        // ì„ íƒëœ í•­ëª©ì˜ HTMLì„ displayì— ë³µì‚¬ (ìƒ‰ìƒ ë¼ë²¨ í¬í•¨)
        textSpan.innerHTML = optEl.innerHTML;
    } else {
        textSpan.textContent = 'ì„ íƒí•˜ì„¸ìš”';
    }

    // ì„ íƒ í‘œì‹œ
    document.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
    if (optEl) optEl.classList.add('selected');

    // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    display.classList.remove('open');
    document.getElementById('test-purpose-options').classList.remove('open');
}

// ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    const wrap = document.getElementById('test-purpose-custom');
    if (wrap && !wrap.contains(e.target)) {
        document.getElementById('test-purpose-display')?.classList.remove('open');
        document.getElementById('test-purpose-options')?.classList.remove('open');
    }
});

// ============================================================================
// ê²€ì‚¬ëª©ì  ë³€ê²½
// ============================================================================
function onTestPurposeChange() {
    document.getElementById('food-type-input').value = '';
    document.getElementById('food-type-value').value = '';

    const testPurpose = document.getElementById('test-purpose').value;
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const helpEl = document.getElementById('test-purpose-help');

    if (testPurpose) {
        // Firestore P ë°°ì—´ì—ì„œ ì„ íƒëœ ê²€ì‚¬ëª©ì ì˜ ì ‘ìˆ˜ë²ˆí˜¸ í˜•ì‹ ë¼ë²¨ í‘œì‹œ
        const purposeObj = firestorePurposes.find(p => p.n === testPurpose);
        if (purposeObj && purposeObj.rcpt) {
            helpEl.innerHTML = `ğŸ“‹ ì ‘ìˆ˜ë²ˆí˜¸ í˜•ì‹: <strong>${purposeObj.rcpt}</strong>` +
                (purposeObj.rcptDesc ? ` <span style="color:#888">(${purposeObj.rcptDesc})</span>` : '');
        } else {
            helpEl.textContent = 'ê²€ì²´ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”';
        }
        showToast(`ê²€ì‚¬ëª©ì  ì„ íƒ: ${testPurpose}. ê²€ì²´ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.`, 'info');

        // ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ìë™ ì¡°íšŒ (Firestore receiptsì—ì„œ ìµœê·¼ ë‚´ì—­)
        if (firestoreReady && testField) {
            fetchLatestReceiptNo(testField, testPurpose);
        }
    } else {
        helpEl.textContent = 'ì‹œí—˜ë¶„ì•¼ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤';
        document.getElementById('prev-receipt-no').value = '';
    }
}

// ============================================================================
// ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ìë™ ì¡°íšŒ (Firestore receipts ì»¬ë ‰ì…˜)
// ============================================================================
async function fetchLatestReceiptNo(testField, testPurpose) {
    try {
        // ë‹¨ì¼ í•„ë“œ ì¿¼ë¦¬ (ë³µí•© ì¸ë±ìŠ¤ ë¶ˆí•„ìš”)
        const snap = await db.collection('receipts')
            .where('testPurpose', '==', testPurpose)
            .limit(50)
            .get();

        const prevInput = document.getElementById('prev-receipt-no');
        if (!snap.empty) {
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ testField í•„í„° + createdAt ì •ë ¬
            const matched = snap.docs
                .map(d => d.data())
                .filter(r => r.testField === testField && r.receiptNo)
                .sort((a, b) => {
                    const ta = a.createdAt?.toDate?.() || new Date(0);
                    const tb = b.createdAt?.toDate?.() || new Date(0);
                    return tb - ta;
                });

            if (matched.length > 0) {
                const prevNo = matched[0].receiptNo;
                prevInput.value = prevNo;
                console.log(`[Firestore] ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì¡°íšŒ: ${prevNo} (${testPurpose})`);
                showToast(`ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸: ${prevNo}`, 'info');
            } else {
                prevInput.value = '';
                console.log(`[Firestore] ì´ì „ ì ‘ìˆ˜ ë‚´ì—­ ì—†ìŒ (${testField}/${testPurpose})`);
            }
        } else {
            prevInput.value = '';
            console.log(`[Firestore] ì´ì „ ì ‘ìˆ˜ ë‚´ì—­ ì—†ìŒ (${testPurpose})`);
        }
    } catch (e) {
        console.warn('[Firestore] ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì¡°íšŒ ì‹¤íŒ¨:', e.message);
    }
}

// ============================================================================
// ê²€ì²´ìœ í˜• ê²€ìƒ‰ (API ì—°ë™ + í´ë°±)
// ============================================================================
async function searchFoodType(query) {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const testPurpose = document.getElementById('test-purpose').value;

    if (!testField || !testPurpose) {
        showToast('ì‹œí—˜ë¶„ì•¼ì™€ ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'warning');
        document.getElementById('food-type-list').classList.remove('active');
        return;
    }

    let allTypes = [];

    // API í˜¸ì¶œ ì‹œë„
    if (apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/food-types?field=${encodeURIComponent(testField)}&purpose=${encodeURIComponent(testPurpose)}`);
            if (res.ok) {
                const data = await res.json();
                allTypes = data.food_types || [];
                console.log(`[API] ê²€ì²´ìœ í˜• ë¡œë“œ: ${testField}-${testPurpose} - ${allTypes.length}ê°œ`);
            }
        } catch (e) {
            console.warn('[API] ê²€ì²´ìœ í˜• ë¡œë“œ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // í´ë°±
    if (allTypes.length === 0) {
        const key = `${testField}-${testPurpose}`;
        allTypes = FALLBACK_FOOD_TYPE_BY_PURPOSE[key] || [];
        console.log(`[í´ë°±] ê²€ì²´ìœ í˜• ë¡œë“œ: ${key} - ${allTypes.length}ê°œ`);
    }

    const filtered = query ? allTypes.filter(t => t.toLowerCase().includes(query.toLowerCase())) : allTypes;

    const list = document.getElementById('food-type-list');
    if (filtered.length === 0) {
        list.classList.remove('active');
        return;
    }

    list.innerHTML = filtered.map(type => {
        let display = type;
        if (query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            display = type.replace(regex, '<mark>$1</mark>');
        }
        return `<div class="autocomplete-item" onclick="selectFoodType('${type.replace(/'/g, "\\'")}')">${display}</div>`;
    }).join('');

    list.classList.add('active');
}

// ============================================================================
// ê²€ì²´ìœ í˜• ì„ íƒ
// ============================================================================
function selectFoodType(type) {
    document.getElementById('food-type-input').value = type;
    document.getElementById('food-type-value').value = type;
    document.getElementById('food-type-list').classList.remove('active');
    showToast(`ê²€ì²´ìœ í˜• ì„ íƒ: ${type}`, 'info');
}

// ============================================================================
// ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì„¤ì •
// ============================================================================
function setPrevReceiptNo() {
    const prevNo = document.getElementById('prev-receipt-no').value.trim();
    if (prevNo) showToast(`ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸: ${prevNo}ì—ì„œ ì´ì–´ì„œ ì‹œì‘í•©ë‹ˆë‹¤.`, 'info');
}

// ============================================================================
// ì ‘ìˆ˜ë²ˆí˜¸ ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ìƒì„± (ê²€ì‚¬ëª©ì ê´€ë¦¬ ì„¤ì • ì—°ë™)
// ============================================================================
function buildReceiptNoFromSegments(purposeObj, testField) {
    const segments = purposeObj.segments;
    const sep = (purposeObj.segSep === 'none' || purposeObj.segSep === '') ? '' : (purposeObj.segSep !== undefined && purposeObj.segSep !== null ? purposeObj.segSep : '-');
    const fieldId = testField === 'ì‹í’ˆ' ? 'F' : 'L';
    const today = new Date();
    const y4 = today.getFullYear().toString();
    const y2 = y4.slice(2);
    const m = (today.getMonth() + 1).toString().padStart(2, '0');
    const d = today.getDate().toString().padStart(2, '0');

    const parts = [];
    segments.forEach(s => {
        switch(s.t) {
            case 'fixed':
                // fieldCodesê°€ ìˆìœ¼ë©´ ë¶„ì•¼ë³„ ì½”ë“œ ì‚¬ìš©
                if (purposeObj.fieldCodes && purposeObj.fieldCodes[fieldId]) {
                    parts.push(purposeObj.fieldCodes[fieldId]);
                } else {
                    parts.push(s.v || '??');
                }
                break;
            case 'field':
                parts.push(fieldId);
                break;
            case 'year':
                parts.push(s.v === '4' ? y4 : y2);
                break;
            case 'month':
                parts.push(m);
                break;
            case 'day':
                parts.push(d);
                break;
            case 'serial':
                const digits = parseInt(s.v) || 4;
                parts.push('1'.padStart(digits, '0'));
                break;
            case 'purpose':
                const pDigits = parseInt(s.digits) || 2;
                parts.push((s.v || '01').padStart(pDigits, '0'));
                break;
        }
    });
    return parts.join(sep);
}

// ============================================================================
// ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ (ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ + API + í´ë°±)
// ============================================================================
async function allocateReceiptNo() {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const testPurpose = document.getElementById('test-purpose').value;

    if (!testField || !testPurpose) {
        showToast('ì‹œí—˜ë¶„ì•¼ì™€ ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!', 'error');
        return;
    }

    const prevReceiptNo = document.getElementById('prev-receipt-no').value.trim();
    let receiptNo = '';

    // ì„ íƒëœ ê²€ì‚¬ëª©ì ì˜ P ê°ì²´ ì°¾ê¸°
    const purposeObj = firestorePurposes.find(p => p.n === testPurpose);

    // 1ìˆœìœ„: ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ìƒì„± (ê²€ì‚¬ëª©ì ê´€ë¦¬ì—ì„œ ì„¤ì •í•œ ì ‘ìˆ˜ë²ˆí˜¸ í˜•ì‹)
    if (purposeObj && purposeObj.segments && purposeObj.segments.length > 0) {
        receiptNo = buildReceiptNoFromSegments(purposeObj, testField);
        console.log(`[ì„¸ê·¸ë¨¼íŠ¸] ì ‘ìˆ˜ë²ˆí˜¸ ìƒì„±: ${receiptNo} (${testPurpose})`);
    }

    // 2ìˆœìœ„: API í˜¸ì¶œ (ì„¸ê·¸ë¨¼íŠ¸ ë¯¸ì„¤ì • ì‹œ)
    if (!receiptNo && apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/receipt-no/allocate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ testField, testPurpose, prevReceiptNo })
            });
            if (res.ok) {
                const data = await res.json();
                receiptNo = data.receiptNo;
                console.log(`[API] ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹: ${receiptNo}`);
            }
        } catch (e) {
            console.warn('[API] ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // 3ìˆœìœ„: ê¸°ì¡´ í´ë°± (ì„¸ê·¸ë¨¼íŠ¸ ì—†ê³  APIë„ ì‹¤íŒ¨ ì‹œ)
    if (!receiptNo) {
        const today = new Date();
        const yy = today.getFullYear().toString().slice(2);
        const mm = (today.getMonth() + 1).toString().padStart(2, '0');
        const dd = today.getDate().toString().padStart(2, '0');

        const purposeCode = FALLBACK_TEST_PURPOSE_CODES[testPurpose] || 'XX';
        const fieldCode = testField === 'ì‹í’ˆ' ? 'F' : 'L';

        let seq = '001';
        if (prevReceiptNo) {
            const match = prevReceiptNo.match(/(\d+)-\d+$/);
            if (match) seq = (parseInt(match[1]) + 1).toString().padStart(3, '0');
        }

        receiptNo = `${yy}${mm}${dd}${fieldCode}${purposeCode}${seq}-001`;
        console.log(`[í´ë°±] ì ‘ìˆ˜ë²ˆí˜¸ ìƒì„±: ${receiptNo}`);
    }

    document.getElementById('receipt-no').value = receiptNo;
    document.getElementById('receipt-no').classList.add('receipt-no-allocated');
    document.getElementById('receipt-no-status').textContent = 'âœ… í• ë‹¹ ì™„ë£Œ - ì ‘ìˆ˜ ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
    document.getElementById('receipt-no-status').style.color = '#4caf50';
    document.getElementById('status').value = 'ì ‘ìˆ˜ì¤‘';
    document.getElementById('receipt-no-warning').style.display = 'none';

    isReceiptNoAllocated = true;
    showToast(`ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ ì™„ë£Œ: ${receiptNo}`);
}

// ============================================================================
// ì—…ì²´ ê²€ìƒ‰ (API ì—°ë™ + í´ë°±)
// ============================================================================
let companySearchTimeout = null;

function searchCompany(query) {
    // ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬ (300ms)
    clearTimeout(companySearchTimeout);
    companySearchTimeout = setTimeout(() => _searchCompany(query), 300);
}

async function _searchCompany(query) {
    const suggestions = document.getElementById('company-suggestions');
    if (!query || query.length < 1) {
        suggestions.classList.remove('active');
        return;
    }

    const field = document.querySelector('input[name="test-field"]:checked')?.value || 'ì‹í’ˆ';
    let companies = [];

    // Firestore companies ì»¬ë ‰ì…˜ì—ì„œ ê²€ìƒ‰ (firestore-helpers.js)
    try {
        if (typeof fsSearchCompanies === 'function') {
            const allResults = await fsSearchCompanies(query, 50);
            // ë¶„ì•¼ í•„í„°: licenses[].licField ë§¤ì¹­
            companies = allResults.filter(function(c) {
                if (!c.licenses || c.licenses.length === 0) return true;
                return c.licenses.some(function(lic) {
                    return (lic.licField || lic.field) === field;
                });
            }).slice(0, 20);
            console.log(`[Firestore] ì—…ì²´ ê²€ìƒ‰: "${query}" (${field}) - ${companies.length}ê±´`);
        }
    } catch (e) {
        console.warn('[Firestore] ì—…ì²´ ê²€ìƒ‰ ì‹¤íŒ¨:', e.message);
    }

    // í´ë°±: API ë˜ëŠ” í•˜ë“œì½”ë”© ë°ì´í„°
    if (companies.length === 0 && apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/companies/search?q=${encodeURIComponent(query)}`);
            if (res.ok) {
                const data = await res.json();
                companies = (data.companies || []).map(function(c) {
                    return { company: c.name, name: c.name, bizNo: c.businessNo, businessNo: c.businessNo, repName: c.ceo, ceo: c.ceo, contactPhone: c.phone, licenses: [] };
                });
            }
        } catch (e) { /* ignore */ }
    }
    if (companies.length === 0) {
        companies = FALLBACK_COMPANIES.filter(c => c.name.toLowerCase().includes(query.toLowerCase())).map(function(c) {
            return { company: c.name, name: c.name, bizNo: c.businessNo, businessNo: c.businessNo, repName: c.ceo, ceo: c.ceo, contactPhone: c.phone, licenses: [] };
        });
    }

    if (companies.length === 0) {
        suggestions.innerHTML = '<div style="padding:12px;color:#8892a4;font-size:12px;text-align:center">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
        suggestions.classList.add('active');
        return;
    }

    suggestions.innerHTML = companies.map(function(c) {
        var nm = c.company || c.name || '-';
        var bizNo = c.bizNo || c.businessNo || '';
        var ceoNm = c.repName || c.ceo || '';
        // í•´ë‹¹ ë¶„ì•¼ ì¸í—ˆê°€ ì°¾ê¸°
        var lic = (c.licenses || []).find(function(l) { return (l.licField || l.field) === field; }) || (c.licenses || [])[0] || {};
        var licNo = lic.licNo || lic.licenseNo || '';
        var licBiz = lic.licBizForm || lic.bizForm || '';
        var cData = JSON.stringify(c).replace(/"/g, '&quot;');
        return '<div class="suggestion-item" onclick="selectCompany(this)" data-company="' + cData + '">' +
            '<strong>' + nm + '</strong>' +
            (licBiz ? ' <span style="font-size:10px;background:#e3f2fd;color:#1565c0;padding:1px 5px;border-radius:3px">' + licBiz + '</span>' : '') +
            '<br><small style="color:#8892a4">' +
            (licNo ? 'ì¸í—ˆê°€: ' + licNo + ' | ' : '') +
            (bizNo ? 'ì‚¬ì—…ì: ' + bizNo + ' | ' : '') +
            ceoNm + '</small></div>';
    }).join('');
    suggestions.classList.add('active');
}

// ============================================================================
// ì—…ì²´ ì„ íƒ
// ============================================================================
function selectCompany(elOrObj) {
    var c;
    if (elOrObj && elOrObj.getAttribute) {
        // DOM element í´ë¦­ â†’ data-company ì†ì„±ì—ì„œ íŒŒì‹±
        c = JSON.parse(elOrObj.getAttribute('data-company'));
    } else if (typeof elOrObj === 'string') {
        c = JSON.parse(elOrObj);
    } else {
        c = elOrObj;
    }

    var field = document.querySelector('input[name="test-field"]:checked')?.value || 'ì‹í’ˆ';
    // í•´ë‹¹ ë¶„ì•¼ì˜ ì¸í—ˆê°€ ì°¾ê¸°
    var lic = (c.licenses || []).find(function(l) { return (l.licField || l.field) === field; }) || (c.licenses || [])[0] || {};

    // ê±°ë˜ì²˜ëª…
    var nm = c.company || c.name || '';
    document.getElementById('company-search').value = nm;

    // ì¸í—ˆê°€ ì •ë³´
    document.getElementById('lic-no').value = lic.licNo || lic.licenseNo || '';
    document.getElementById('lic-biz-form').value = lic.licBizForm || lic.bizForm || '';
    document.getElementById('lic-biz-name').value = lic.licBizName || lic.bizName || nm;

    // ì—…ì²´ ì „í™”ë²ˆí˜¸, íœ´ëŒ€í°, ì£¼ì†Œ (ì¸í—ˆê°€ ì •ë³´ ê¸°ì¤€)
    document.getElementById('company-phone').value = c.contactPhone || c.phone || '';
    var mob = c.contactMobile || '';
    if (!mob && c.contacts && c.contacts[0]) mob = c.contacts[0].mobile || '';
    document.getElementById('company-mobile').value = mob;
    var licAddr = lic.licAddr || '';
    var licAddr2 = lic.licAddr2 || lic.licAddrDetail || '';
    document.getElementById('company-address').value = licAddr + (licAddr2 ? ' ' + licAddr2 : '');

    // ë‹´ë‹¹ì
    var rep = c.salesRep || '';
    if (!rep && c.contacts && c.contacts[0]) rep = c.contacts[0].salesRep || '';
    document.getElementById('sales-rep').value = rep;

    // ê³„ì‚°ì„œ ì •ë³´ ìë™ ì±„ì›€ (ì‚¬ì—…ì ì •ë³´ + ë‹´ë‹¹ì)
    document.getElementById('company-name').value = nm;
    document.getElementById('business-no').value = c.bizNo || c.businessNo || '';
    document.getElementById('ceo').value = c.repName || c.ceo || '';
    document.getElementById('bill-name').value = c.taxName || '';
    document.getElementById('bill-phone').value = c.taxPhone || '';
    document.getElementById('bill-mobile').value = c.taxMobile || '';
    document.getElementById('bill-email').value = c.taxEmail || '';

    // ì—…ì²´ ë³€ê²½ì´ë ¥ í‘œì‹œ
    var clWrap = document.getElementById('company-changelog');
    var clBody = document.getElementById('company-changelog-body');
    var logs = c.changeLog || [];
    if (logs.length > 0 && clWrap && clBody) {
        clWrap.style.display = '';
        var html = '<table style="width:100%;border-collapse:collapse">' +
            '<tr style="border-bottom:1px solid #e2e6ed;color:#8892a4">' +
            '<th style="text-align:left;padding:4px 6px;width:130px">ì¼ì‹œ</th>' +
            '<th style="text-align:left;padding:4px 6px;width:70px">ë³€ê²½ì</th>' +
            '<th style="text-align:left;padding:4px 6px">ë³€ê²½ ë‚´ìš©</th>' +
            '<th style="text-align:right;padding:4px 6px;width:80px">ë¯¸ìˆ˜ê¸ˆ</th></tr>';
        logs.slice().reverse().forEach(function(log) {
            html += '<tr style="border-bottom:1px solid #f5f5f5">' +
                '<td style="padding:4px 6px;color:#5f6b7a;white-space:nowrap">' + (log.date || '') + '</td>' +
                '<td style="padding:4px 6px">' + (log.who || '') + '</td>' +
                '<td style="padding:4px 6px;font-size:10px">' + (log.detail || '') + '</td>' +
                '<td style="padding:4px 6px;text-align:right;color:#d32f2f;font-weight:600">' + (log.receivable || '') + '</td></tr>';
        });
        html += '</table>';
        clBody.innerHTML = html;
    } else if (clWrap) {
        clWrap.style.display = 'none';
    }

    document.getElementById('company-suggestions').classList.remove('active');
    showToast('ì—…ì²´ ì„ íƒ: ' + nm + (lic.licNo ? ' (ì¸í—ˆê°€: ' + lic.licNo + ')' : ''), 'info');
}

// ============================================================================
// íŒ€ë³„ ë©”ëª¨ ê¶Œí•œ
// ============================================================================
function setupTeamMemoPermissions() {
    ['customer','quality','finance','marketing'].forEach(team => {
        const textarea = document.getElementById(`memo-${team}`);
        const lock = document.getElementById(`${team}-lock`);
        if (team === currentUserTeam) {
            textarea.disabled = false;
            lock.textContent = 'ğŸ”“ í¸ì§‘ ê°€ëŠ¥';
            lock.style.color = '#4caf50';
        } else {
            textarea.disabled = true;
            lock.textContent = 'ğŸ”’ ì½ê¸° ì „ìš©';
            lock.style.color = '#999';
        }
    });
}

// ============================================================================
// ìˆ˜ì • í‘œì‹œ
// ============================================================================
function markAsModified() {
    if (!isModified) {
        isModified = true;
        const btn = document.getElementById('save-btn');
        btn.classList.add('modified');
        btn.textContent = 'ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥';
    }
}

// ============================================================================
// ì €ì¥
// ============================================================================
function saveReceipt() {
    if (!isReceiptNoAllocated) {
        showToast('ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!', 'error');
        return;
    }
    if (!isModified) {
        showToast('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        return;
    }
    showToast('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    isModified = false;
    const btn = document.getElementById('save-btn');
    btn.classList.remove('modified');
    btn.textContent = 'ğŸ’¾ ì €ì¥';
}

// ============================================================================
// ì„ì‹œì €ì¥
// ============================================================================
function saveDraft() {
    const data = {
        receiptNo: document.getElementById('receipt-no').value,
        foodType: document.getElementById('food-type-value').value,
        memoCustomer: document.getElementById('memo-customer').value
    };
    localStorage.setItem('receipt-draft', JSON.stringify(data));
    showToast('ğŸ’¾ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ë¶ˆëŸ¬ì˜¤ê¸°
// ============================================================================
function loadDraft() {
    const draft = localStorage.getItem('receipt-draft');
    if (!draft) return;
    const data = JSON.parse(draft);
    Object.keys(data).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = data[key];
    });
}

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
function resetForm() {
    if (!confirm('ì…ë ¥í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    document.getElementById('receipt-form').reset();
    localStorage.removeItem('receipt-draft');
    isReceiptNoAllocated = false;
    isModified = false;

    document.getElementById('receipt-no').value = '';
    document.getElementById('receipt-no').classList.remove('receipt-no-allocated');
    document.getElementById('receipt-no-status').textContent = 'âŒ ë¯¸í• ë‹¹';
    document.getElementById('receipt-no-status').style.color = '#f44336';
    document.getElementById('status').value = 'ëŒ€ê¸°ì¤‘';
    document.getElementById('receipt-no-warning').style.display = 'flex';

    setTodayDate();

    const btn = document.getElementById('save-btn');
    btn.classList.remove('modified');
    btn.textContent = 'ğŸ’¾ ì €ì¥';

    showToast('ğŸ”„ í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ì œì¶œ
// ============================================================================
document.getElementById('receipt-form').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!isReceiptNoAllocated) {
        showToast('ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!', 'error');
        return;
    }

    const required = [
        {id:'receipt-date', name:'ì ‘ìˆ˜ì¼ì'},
        {id:'company-search', name:'ê±°ë˜ì²˜'},
        {id:'food-type-value', name:'ê²€ì²´ìœ í˜•'},
        {id:'product-name', name:'ì œí’ˆ/ì‹œë£Œëª…'},
        {id:'sample-amount', name:'ê²€ì²´ëŸ‰'},
        {id:'sample-count', name:'ê²€ì²´ìˆ˜'}
    ];

    for (const f of required) {
        const el = document.getElementById(f.id);
        if (!el.value) {
            showToast(`${f.name}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'error');
            el.focus();
            return;
        }
    }

    showToast('âœ… ì‹œë£Œ ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    setTimeout(() => {
        localStorage.removeItem('receipt-draft');
        window.location.reload();
    }, 2000);
});

// ============================================================================
// í† ìŠ¤íŠ¸
// ============================================================================
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast';
    if (type) toast.classList.add(type);
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
}

// ============================================================================
// ì œí’ˆ ì ‘ìˆ˜ì´ë ¥ ì¡°íšŒ
// ============================================================================
async function searchProductHistory() {
    var pn = (document.getElementById('product-name').value || '').trim();
    var panel = document.getElementById('product-history-panel');
    if (!pn) {
        showToast('ì œí’ˆ/ì‹œë£Œëª…ì„ ì…ë ¥ í›„ ì¡°íšŒí•˜ì„¸ìš”.', 'warning');
        return;
    }
    panel.innerHTML = '<div style="padding:16px;text-align:center;color:#888"><span class="loading-spinner" style="display:inline-block;width:16px;height:16px;border:2px solid #ddd;border-top-color:#5b67f5;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle;margin-right:6px"></span> ì¡°íšŒ ì¤‘...</div>';
    panel.style.display = '';
    try {
        var snap = await db.collection('receipts')
            .where('productName', '==', pn)
            .limit(50)
            .get();
        if (snap.empty) {
            panel.innerHTML = '<div style="padding:16px;text-align:center;color:#999;font-size:13px">ğŸ“­ "' + pn + '" ì ‘ìˆ˜ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        // í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ (ìµœì‹ ìˆœ)
        var docs = snap.docs.sort(function(a, b) {
            var ta = a.data().createdAt?.toDate?.() || new Date(0);
            var tb = b.data().createdAt?.toDate?.() || new Date(0);
            return tb - ta;
        }).slice(0, 20);
        var html = '<div style="padding:8px 12px;border-bottom:1px solid #eee;font-size:11px;font-weight:700;color:#5f6b7a;display:flex;gap:4px;align-items:center">ğŸ“‹ ì ‘ìˆ˜ì´ë ¥ <span style="color:#5b67f5">' + docs.length + 'ê±´</span><span style="flex:1"></span><button type="button" onclick="closeProductHistory()" style="border:none;background:none;cursor:pointer;font-size:14px;color:#999">âœ•</button></div>';
        docs.forEach(function(doc) {
            var r = doc.data();
            var dt = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toISOString().slice(0,10) : '';
            var rno = r.receiptNo || '-';
            var ft = r.foodType || '';
            var co = r.companyName || '';
            var tf = r.testField || '';
            var tp = r.testPurpose || '';
            html += '<div class="product-history-item" onclick="fillFromHistory(\'' + doc.id + '\')" style="padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;font-size:12px;transition:background 0.15s"';
            html += ' onmouseover="this.style.background=\'#f0f4ff\'" onmouseout="this.style.background=\'#fff\'">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">';
            html += '<span style="font-weight:600;color:#1565c0;font-family:monospace">' + rno + '</span>';
            html += '<span style="color:#888;font-size:11px">' + dt + '</span>';
            html += '</div>';
            html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
            if (tf) html += '<span style="background:#e3f2fd;color:#1565c0;padding:1px 6px;border-radius:4px;font-size:10px">' + tf + '</span>';
            if (tp) html += '<span style="background:#f3e5f5;color:#7b1fa2;padding:1px 6px;border-radius:4px;font-size:10px">' + tp + '</span>';
            if (ft) html += '<span style="background:#e8f5e9;color:#2e7d32;padding:1px 6px;border-radius:4px;font-size:10px">' + ft + '</span>';
            if (co) html += '<span style="color:#666;font-size:11px">ğŸ¢ ' + co + '</span>';
            html += '</div></div>';
        });
        panel.innerHTML = html;
    } catch(e) {
        console.warn('[ì œí’ˆì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨]', e);
        panel.innerHTML = '<div style="padding:16px;text-align:center;color:#e53935;font-size:13px">âš ï¸ ì¡°íšŒ ì‹¤íŒ¨: ' + (e.message || '') + '</div>';
    }
}

function closeProductHistory() {
    document.getElementById('product-history-panel').style.display = 'none';
}

async function fillFromHistory(docId) {
    try {
        var doc = await db.collection('receipts').doc(docId).get();
        if (!doc.exists) { showToast('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
        var r = doc.data();
        // ì‹œë£Œì •ë³´ ìë™ ì±„ì›€
        if (r.foodType) {
            document.getElementById('food-type-input').value = r.foodType;
            document.getElementById('food-type-value').value = r.foodType;
        }
        if (r.sampleAmount) document.getElementById('sample-amount').value = r.sampleAmount;
        if (r.sampleCount) document.getElementById('sample-count').value = r.sampleCount;
        if (r.packageUnit) document.getElementById('package-unit').value = r.packageUnit;
        if (r.transportStatus) document.getElementById('transport-status').value = r.transportStatus;
        if (r.manufactureNo) document.getElementById('manufacture-no').value = r.manufactureNo;
        closeProductHistory();
        showToast('ğŸ“‹ ì´ì „ ì ‘ìˆ˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
    } catch(e) {
        console.warn('[ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨]', e);
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
    }
}

// ============================================================================
// ì™¸ë¶€ í´ë¦­
// ============================================================================
document.addEventListener('click', function(e) {
    if (!e.target.closest('.company-search')) {
        document.getElementById('company-suggestions').classList.remove('active');
    }
    if (!e.target.closest('.autocomplete-input')) {
        document.getElementById('food-type-list').classList.remove('active');
    }
    // ì œí’ˆì´ë ¥ íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
    if (!e.target.closest('#product-history-panel') && !e.target.closest('[onclick*="searchProductHistory"]')) {
        var ph = document.getElementById('product-history-panel');
        if (ph) ph.style.display = 'none';
    }
});

// ì‚¬ì´ë“œë°” JS â†’ js/sidebar.jsë¡œ ì´ê´€ë¨
</script>
</body>
</html>
