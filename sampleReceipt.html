<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ì‹œë£Œ ì ‘ìˆ˜ ë“±ë¡</title>
<style>
:root{--primary:#2563eb;--success:#10b981;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-600:#4b5563;--gray-900:#111827;--accent:#667eea;--accent2:#764ba2}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;background:#f5f5f5;color:#1a1a1a}
.app-layout{display:flex;height:100vh}
/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */
.main-container{flex:1;margin-left:250px;display:flex;flex-direction:column;overflow:hidden}
.top-header{background:white;padding:16px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:#64748b}
.breadcrumb-current{color:#1e293b;font-weight:600}
.server-status{display:flex;align-items:center;gap:6px;font-size:12px;padding:4px 12px;border-radius:20px;background:#f1f5f9}
.server-status.online{color:#16a34a;background:#f0fdf4}
.server-status.offline{color:#dc2626;background:#fef2f2}
.main-content{flex:1;overflow-y:auto;padding:24px}

/* ====== RECEIPT FORM STYLES ====== */
.form-container{max-width:1100px;margin:0 auto}
.section{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:12px;overflow:hidden;background:white}
.section-header{background:#f8f9fa;padding:18px 24px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:16px;color:#333;transition:all 0.3s}
.section-header:hover{background:#e9ecef}
.section-header.active{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white}
.toggle-icon{transition:transform 0.3s;font-size:12px}
.section-header.active .toggle-icon{transform:rotate(180deg)}
.section-content{padding:24px;display:none}
.section-content.active{display:block}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
.form-group{display:flex;flex-direction:column}
.form-group label{font-weight:500;margin-bottom:8px;color:#333;font-size:14px}
.required{color:#f44336;margin-left:4px}
.form-group input,.form-group select,.form-group textarea{padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:all 0.3s;font-family:inherit}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.form-group input:disabled,.form-group select:disabled,.form-group textarea:disabled{background:#f5f5f5;color:#999;cursor:not-allowed}
.radio-group{display:flex;gap:20px;margin-top:8px}
.radio-label{display:flex;align-items:center;padding:10px 20px;border:2px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.3s}
.radio-label:hover{border-color:var(--accent);background:#f8f9ff}
.radio-label input[type="radio"]:checked{accent-color:var(--accent)}
.radio-label input[type="radio"]{margin-right:8px}
.company-search{position:relative}
.search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#999}
.suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none}
.suggestions.active{display:block}
.suggestion-item{padding:12px;cursor:pointer;transition:background 0.2s}
.suggestion-item:hover{background:#f5f7fa}
.field-help{font-size:12px;color:#999;margin-top:4px}
.buttons{display:flex;gap:12px;justify-content:center;margin-top:40px;padding-top:30px;border-top:1px solid #e0e0e0}
.btn-receipt{padding:14px 32px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s}
.btn-receipt.primary{background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%);color:white}
.btn-receipt.primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4)}
.btn-receipt.save{background:#e0e0e0;color:#666}
.btn-receipt.save.modified{background:linear-gradient(135deg,#1de9b6 0%,#1dc4e9 100%);color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.btn-receipt.secondary{background:white;color:var(--accent);border:2px solid var(--accent)}
.btn-receipt.secondary:hover{background:#f8f9ff}
.btn-receipt.cancel{background:#f5f5f5;color:#666}
.btn-receipt.cancel:hover{background:#e0e0e0}
.auto-value{background:#e3f2fd;border-color:#90caf9}
.receipt-no-allocated{background:#c8e6c9;border-color:#4caf50;font-weight:600}
.autocomplete-input{position:relative}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:100;display:none}
.autocomplete-list.active{display:block}
.autocomplete-item{padding:10px;cursor:pointer;transition:background 0.2s}
.autocomplete-item:hover{background:#f0f0f0}
.autocomplete-item mark{background:#ffeb3b;padding:0 2px}
.team-memo{border-left:4px solid;padding:16px;margin-bottom:16px;background:#f9f9f9;border-radius:8px}
.team-memo.customer-support{border-color:#2196f3}
.team-memo.quality{border-color:#4caf50}
.team-memo.finance{border-color:#ff9800}
.team-memo.marketing{border-color:#e91e63}
.team-memo-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.team-memo-title{font-weight:600;font-size:14px}
.team-memo-lock{font-size:12px;color:#999}
.team-memo textarea{width:100%;min-height:80px;resize:vertical}
.team-memo textarea:disabled{background:#fafafa;cursor:not-allowed}
.toast{position:fixed;top:20px;right:20px;background:#4caf50;color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);display:none;z-index:2000;min-width:250px}
.toast.active{display:block;animation:slideIn 0.3s}
.toast.error{background:#f44336}
.toast.warning{background:#ff9800}
.toast.info{background:#2196f3}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.warning-box{background:#fff3cd;border:1px solid #ffc107;padding:16px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.warning-box-icon{font-size:24px}
.warning-box-text{flex:1}
@media(max-width:768px){.sidebar{display:none}.main-container{margin-left:0}.form-row{grid-template-columns:1fr}.buttons{flex-direction:column}.btn-receipt{width:100%}}
</style>
</head>
<body>
<div class="app-layout">
<aside class="sidebar" id="sidebar"></aside>
<script src="js/sidebar.js?v=2"></script>
<div class="main-container">
<header class="top-header">
<div class="breadcrumb">
<span>ì ‘ìˆ˜ ê´€ë¦¬</span>
<span>â€º</span>
<span class="breadcrumb-current">ì ‘ìˆ˜ ë“±ë¡</span>
</div>
<div class="server-status offline" id="server-status">
<span id="server-status-icon">ğŸ”´</span>
<span id="server-status-text">API ì˜¤í”„ë¼ì¸</span>
</div>
</header>
<main class="main-content">
<div class="form-container">
    <form id="receipt-form">

        <!-- 1. ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´ -->
        <div class="section">
            <div class="section-header active" onclick="toggleSection(this)">
                <span>ğŸ“‹ ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content active">
                <div class="warning-box" id="receipt-no-warning">
                    <span class="warning-box-icon">âš ï¸</span>
                    <div class="warning-box-text">
                        <strong>ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!</strong><br>
                        ë™ì‹œ ì ‘ìˆ˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ í›„ ì‘ì—…ì„ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œí—˜ë¶„ì•¼ <span class="required">*</span></label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="test-field" value="ì‹í’ˆ" checked onchange="onTestFieldChange()">
                                <span>ğŸ ì‹í’ˆ</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="test-field" value="ì¶•ì‚°" onchange="onTestFieldChange()">
                                <span>ğŸ¥© ì¶•ì‚°</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì‚¬ëª©ì  <span class="required">*</span></label>
                        <select id="test-purpose" required onchange="onTestPurposeChange()">
                            <option value="">ë¨¼ì € ì‹œí—˜ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <small class="field-help">ì‹œí—˜ë¶„ì•¼ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ (ì„ íƒ)</label>
                        <input type="text" id="prev-receipt-no" placeholder="ì˜ˆ: 260207FQ001-001" onchange="setPrevReceiptNo()">
                        <small class="field-help">ì´ì–´ë°›ì„ ê²½ìš° ì…ë ¥í•˜ì„¸ìš”</small>
                    </div>
                    <div class="form-group">
                        <label>ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹</label>
                        <button type="button" class="btn-receipt primary" onclick="allocateReceiptNo()" style="width:100%;margin-top:8px;">
                            ğŸ”¢ ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ë°›ê¸°
                        </button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>í• ë‹¹ëœ ì ‘ìˆ˜ë²ˆí˜¸</label>
                        <input type="text" id="receipt-no" class="auto-value" readonly>
                        <small class="field-help" id="receipt-no-status" style="color:#f44336;">âŒ ë¯¸í• ë‹¹ - ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”</small>
                    </div>
                    <div class="form-group">
                        <label>ì ‘ìˆ˜ì¼ì <span class="required">*</span></label>
                        <input type="date" id="receipt-date" required onchange="calculateProcessingDeadline()">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ê¸´ê¸‰ì—¬ë¶€</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="urgent" value="ì¼ë°˜" checked>
                                <span>ì¼ë°˜</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="urgent" value="ê¸´ê¸‰">
                                <span>âš¡ ê¸´ê¸‰</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì²˜ë¦¬ê¸°í•œ</label>
                        <input type="date" id="processing-deadline" class="auto-value" readonly>
                        <small class="field-help">ì ‘ìˆ˜ì¼ + 12ì¼</small>
                    </div>
                    <div class="form-group">
                        <label>ìƒíƒœ</label>
                        <input type="text" id="status" value="ëŒ€ê¸°ì¤‘" class="auto-value" readonly>
                        <small class="field-help">ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ í›„ 'ì ‘ìˆ˜ì¤‘'</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ì—…ì²´ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ¢ ì—…ì²´ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group company-search">
                        <label>ê±°ë˜ì²˜ <span class="required">*</span></label>
                        <input type="text" id="company-search" placeholder="ì—…ì²´ëª… ê²€ìƒ‰..." oninput="searchCompany(this.value)" required>
                        <span class="search-icon">ğŸ”</span>
                        <div class="suggestions" id="company-suggestions"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ê³„ì‚°ì„œì—…ì²´</label>
                        <input type="text" id="company-name" readonly>
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                        <input type="text" id="business-no" readonly>
                    </div>
                    <div class="form-group">
                        <label>ëŒ€í‘œì</label>
                        <input type="text" id="ceo" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì</label>
                        <input type="text" id="contact-person">
                    </div>
                    <div class="form-group">
                        <label>ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label>íœ´ëŒ€í°</label>
                        <input type="tel" id="mobile">
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ì‹œë£Œì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ§ª ì‹œë£Œì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group autocomplete-input">
                        <label>ê²€ì²´ìœ í˜• <span class="required">*</span></label>
                        <input type="text" id="food-type-input" placeholder="ê²€ìƒ‰ ë˜ëŠ” í´ë¦­..." oninput="searchFoodType(this.value)" onfocus="searchFoodType('')" required autocomplete="off">
                        <input type="hidden" id="food-type-value">
                        <div class="autocomplete-list" id="food-type-list"></div>
                        <small class="field-help">ì‹œí—˜ë¶„ì•¼ + ê²€ì‚¬ëª©ì ì— ë”°ë¼ í‘œì‹œë©ë‹ˆë‹¤</small>
                    </div>
                    <div class="form-group">
                        <label>ì œí’ˆ/ì‹œë£Œëª… <span class="required">*</span></label>
                        <input type="text" id="product-name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ê²€ì²´ëŸ‰ <span class="required">*</span></label>
                        <input type="text" id="sample-amount" placeholder="ì˜ˆ: 500g, 1L" required>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì²´ìˆ˜ <span class="required">*</span></label>
                        <input type="number" id="sample-count" placeholder="ì˜ˆ: 3" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>í¬ì¥ë‹¨ìœ„</label>
                        <input type="text" id="package-unit" placeholder="ì˜ˆ: ë³‘, íŒ©, ë´‰ì§€">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìš´ë°˜ìƒíƒœ</label>
                        <select id="transport-status">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ëƒ‰ì¥">â„ï¸ ëƒ‰ì¥</option>
                            <option value="ëƒ‰ë™">ğŸ§Š ëƒ‰ë™</option>
                            <option value="ì‹¤ì˜¨">ğŸŒ¡ï¸ ì‹¤ì˜¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>í’ˆëª©ì œì¡°NO</label>
                        <input type="text" id="manufacture-no">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì œì¡°ì¼ì</label>
                        <input type="date" id="manufacture-date">
                    </div>
                    <div class="form-group">
                        <label>ìœ íš¨ê¸°ê°„</label>
                        <input type="date" id="expiry-date">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹œë£Œìœ„ì¹˜</label>
                        <input type="text" id="sample-location" placeholder="ì˜ˆ: A-01">
                    </div>
                    <div class="form-group">
                        <label>ì‹œë£Œë°•ìŠ¤ë²ˆí˜¸</label>
                        <input type="text" id="sample-box-no">
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. ê²€ì‚¬ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ“Š ê²€ì‚¬ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>ê´€ë ¨ë²•ë ¹</label>
                        <select id="related-law">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì‹í’ˆìœ„ìƒë²•">ì‹í’ˆìœ„ìƒë²•</option>
                            <option value="ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²•">ì¶•ì‚°ë¬¼ìœ„ìƒê´€ë¦¬ë²•</option>
                            <option value="ê±´ê°•ê¸°ëŠ¥ì‹í’ˆë²•">ê±´ê°•ê¸°ëŠ¥ì‹í’ˆë²•</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê²€ì‚¬êµ¬ë¶„</label>
                        <select id="test-type" disabled>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <small class="field-help">ì¶”í›„ ìˆ˜ì • ì˜ˆì •</small>
                    </div>
                    <div class="form-group">
                        <label>ì˜ë¢°êµ¬ë¶„</label>
                        <select id="request-type" disabled>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <small class="field-help">ì¶”í›„ ìˆ˜ì • ì˜ˆì •</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¬¸ì„œë²ˆí˜¸</label>
                        <input type="text" id="document-no">
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. ì˜ë¢°ì¸ ì •ë³´ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ‘¤ ì˜ë¢°ì¸ ì •ë³´</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>ì˜ë¢°ì¸ëª…</label>
                        <input type="text" id="requester-name">
                    </div>
                    <div class="form-group">
                        <label>ì˜ë¢°ì—…ì²´ëª…</label>
                        <input type="text" id="request-company">
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. íŒ€ë³„ ë©”ëª¨ -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ“ íŒ€ë³„ ë©”ëª¨</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content">
                <div class="team-memo customer-support">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’™ ê³ ê°ì§€ì›íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="customer-lock">ğŸ”“ í¸ì§‘ ê°€ëŠ¥</span>
                    </div>
                    <textarea id="memo-customer" rows="4" placeholder="ê³ ê°ì§€ì›íŒ€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="markAsModified()"></textarea>
                </div>
                <div class="team-memo quality">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’š í’ˆì§ˆë³´ì¦íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="quality-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-quality" rows="4" placeholder="í’ˆì§ˆë³´ì¦íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">í’ˆì§ˆë³´ì¦íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo finance">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ§¡ ì¬ë¬´íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="finance-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-finance" rows="4" placeholder="ì¬ë¬´íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">ì¬ë¬´íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
                <div class="team-memo marketing">
                    <div class="team-memo-header">
                        <span class="team-memo-title">ğŸ’— ë§ˆì¼€íŒ…íŒ€ ë©”ëª¨</span>
                        <span class="team-memo-lock" id="marketing-lock">ğŸ”’ ì½ê¸° ì „ìš©</span>
                    </div>
                    <textarea id="memo-marketing" rows="4" placeholder="ë§ˆì¼€íŒ…íŒ€ ë©”ëª¨..." disabled></textarea>
                    <small class="field-help">ë§ˆì¼€íŒ…íŒ€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="buttons">
            <button type="button" class="btn-receipt secondary" onclick="saveDraft()">
                ğŸ’¾ ì„ì‹œì €ì¥
            </button>
            <button type="button" class="btn-receipt save" id="save-btn" onclick="saveReceipt()">
                ğŸ’¾ ì €ì¥
            </button>
            <button type="submit" class="btn-receipt primary">
                âœ… ì ‘ìˆ˜ ì™„ë£Œ
            </button>
            <button type="button" class="btn-receipt cancel" onclick="resetForm()">
                âŒ ì·¨ì†Œ
            </button>
        </div>
    </form>
</div>
</main>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================================
// API ì„¤ì •
// ============================================================================
const API_BASE = 'http://127.0.0.1:5001';
let apiOnline = false;

// ============================================================================
// í´ë°± ë°ì´í„° (API ì„œë²„ ë¯¸ì‹¤í–‰ ì‹œ ì‚¬ìš©)
// ============================================================================
const FALLBACK_TEST_PURPOSE_MAPPING = {
  'ì‹í’ˆ': [
    'Allergen(RT-PCR)', 'ì—°êµ¬ìš©ì—­', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©',
    'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)', 'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)'
  ],
  'ì¶•ì‚°': [
    'Allergen(ELISA)', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©',
    'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)', 'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)'
  ]
};

const FALLBACK_TEST_PURPOSE_CODES = {
  'Allergen(RT-PCR)': 'AR', 'Allergen(ELISA)': 'AE',
  'ì—°êµ¬ìš©ì—­': 'RD', 'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': 'QC',
  'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': 'PR', 'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': 'RF',
  'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': 'SL', 'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': 'NR',
  'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': 'AB'
};

const FALLBACK_FOOD_TYPE_BY_PURPOSE = {
  'ì‹í’ˆ-Allergen(RT-PCR)': ['Sample', 'ê¸°íƒ€ê°€ê³µí’ˆ', 'ê³¼ì', 'ë¹µë¥˜'],
  'ì‹í’ˆ-ì—°êµ¬ìš©ì—­': ['Sample', 'ê¸°íƒ€ê°€ê³µí’ˆ'],
  'ì‹í’ˆ-ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': ['Sample', 'ê°€ê³µê¹€(ì¡°ë¯¸ê¹€ ë˜ëŠ” êµ¬ìš´ê¹€)', 'ê°€ê³µì†Œê¸ˆ', 'ê°„í¸ì¡°ë¦¬ì„¸íŠ¸', 'ê³ ì¶§ê°€ë£¨', 'ê³¼ì', 'ê¹€ì¹˜', 'ë¹µë¥˜', 'ì†ŒìŠ¤', 'ì»¤í”¼'],
  'ì‹í’ˆ-ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': ['Sample', 'ì”ë¥˜ë†ì•½(463ì¢…)', 'ì”ë¥˜ë†ì•½(510ì¢…)'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': ['Sample', 'ê³¼.ì±„ê°€ê³µí’ˆ', 'ê³¼.ì±„ìŒë£Œ', 'ê¸°íƒ€ê°€ê³µí’ˆ', 'ì•¡ìƒì°¨'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': ['Sample', 'ê¸°íƒ€ë†ì‚°ê°€ê³µí’ˆ', 'ê¸°íƒ€ìˆ˜ì‚°ë¬¼ê°€ê³µí’ˆ'],
  'ì‹í’ˆ-ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': ['Sample', 'ê³µì¤‘ë‚™í•˜ê· ', 'í‘œë©´ê· ', 'ê³¼ì', 'ë¹µë¥˜'],
  'ì¶•ì‚°-Allergen(ELISA)': ['Sample', 'ê°€ê³µì¹˜ì¦ˆ', 'ì†Œì‹œì§€'],
  'ì¶•ì‚°-ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': ['Sample', 'ê°€ê³µì¹˜ì¦ˆ', 'ì†Œì‹œì§€', 'í–„', 'ì–‘ë…ìœ¡', 'í¬ì¥ìœ¡'],
  'ì¶•ì‚°-ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': ['Sample', 'ê±´ì¡°ì €ì¥ìœ¡ë¥˜', 'ë¶„ì‡„ê°€ê³µìœ¡ì œí’ˆ', 'ì‹ìœ¡ì¶”ì¶œê°€ê³µí’ˆ'],
  'ì¶•ì‚°-ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': ['Sample', 'ì‹ìš©ë€', 'ì¹˜ì¦ˆ', 'ë°œíš¨ìœ ', 'ë†í›„ë°œíš¨ìœ '],
  'ì¶•ì‚°-í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': ['Sample', 'í•­ìƒë¬¼ì§ˆ(156ì¢…)', 'í•­ìƒë¬¼ì§ˆ(99ì¢…)']
};

const FALLBACK_COMPANIES = [
  { id: 1, name: '(ì£¼)íƒ­ìŠ¤ì¸í„°ë‚´ì…”ë„1ê³µì¥', businessNo: '725-85-02346', ceo: 'ë°°ìœ¤ì„±', phone: '02-1234-5678' },
  { id: 2, name: '(ì£¼)ë‚˜ëˆ”ê³µë™ì²´', businessNo: '119-81-63685', ceo: 'ìµœì˜ë‚¨', phone: '02-2345-6789' },
  { id: 3, name: 'ìš°ë¦¬ë°”ì´ì˜¤ ì£¼ì‹íšŒì‚¬', businessNo: '134-81-55919', ceo: 'ì—„íƒœìš± ì™¸ 1ëª…', phone: '02-3456-7890' }
];

// ============================================================================
// ì „ì—­ ë³€ìˆ˜
// ============================================================================
let isReceiptNoAllocated = false;
let isModified = false;
let currentUserTeam = 'customer-support'; // ëª©ì—…: ê³ ê°ì§€ì›íŒ€ ì‚¬ìš©ì

// ============================================================================
// ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
// ============================================================================
async function checkServerStatus() {
    try {
        const res = await fetch(`${API_BASE}/api/health`, { signal: AbortSignal.timeout(3000) });
        if (res.ok) {
            apiOnline = true;
            updateServerStatusUI(true);
            return true;
        }
    } catch (e) {
        // ì„œë²„ ì—°ê²° ì‹¤íŒ¨
    }
    apiOnline = false;
    updateServerStatusUI(false);
    return false;
}

function updateServerStatusUI(online) {
    const statusEl = document.getElementById('server-status');
    const iconEl = document.getElementById('server-status-icon');
    const textEl = document.getElementById('server-status-text');
    if (online) {
        statusEl.className = 'server-status online';
        iconEl.textContent = 'ğŸŸ¢';
        textEl.textContent = 'API ì—°ê²°ë¨';
    } else {
        statusEl.className = 'server-status offline';
        iconEl.textContent = 'ğŸ”´';
        textEl.textContent = 'API ì˜¤í”„ë¼ì¸ (í´ë°± ëª¨ë“œ)';
    }
}

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
window.onload = async function() {
    setTodayDate();

    // ì„œë²„ ìƒíƒœ í™•ì¸
    await checkServerStatus();

    // ì´ˆê¸° ì‹œí—˜ë¶„ì•¼ ì„ íƒ ì‹œ ê²€ì‚¬ëª©ì  ë¡œë“œ
    const initialTestField = document.querySelector('input[name="test-field"]:checked')?.value;
    if (initialTestField) {
        await updateTestPurposeOptions(initialTestField);
    }

    loadDraft();
    setupTeamMemoPermissions();

    // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
    document.querySelectorAll('input:not([readonly]), select:not([disabled]), textarea:not([disabled])').forEach(el => {
        el.addEventListener('input', markAsModified);
        el.addEventListener('change', markAsModified);
    });

    // ì£¼ê¸°ì  ì„œë²„ ìƒíƒœ í™•ì¸ (30ì´ˆë§ˆë‹¤)
    setInterval(checkServerStatus, 30000);
};

// ============================================================================
// Accordion í† ê¸€
// ============================================================================
function toggleSection(header) {
    header.classList.toggle('active');
    header.nextElementSibling.classList.toggle('active');
}

// ============================================================================
// ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
// ============================================================================
function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('receipt-date').value = today;
    calculateProcessingDeadline();
}

// ============================================================================
// ì²˜ë¦¬ê¸°í•œ ê³„ì‚° (12ì¼ ê³ ì •)
// ============================================================================
function calculateProcessingDeadline() {
    const receiptDate = document.getElementById('receipt-date').value;
    if (!receiptDate) return;
    const date = new Date(receiptDate);
    date.setDate(date.getDate() + 12);
    document.getElementById('processing-deadline').value = date.toISOString().split('T')[0];
}

// ============================================================================
// ì‹œí—˜ë¶„ì•¼ ë³€ê²½
// ============================================================================
function onTestFieldChange() {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;

    // ê²€ì‚¬ëª©ì  ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    updateTestPurposeOptions(testField);

    // ê²€ì‚¬ëª©ì  ì´ˆê¸°í™”
    document.getElementById('test-purpose').value = '';

    // ê²€ì²´ìœ í˜• ì´ˆê¸°í™”
    document.getElementById('food-type-input').value = '';
    document.getElementById('food-type-value').value = '';

    showToast(`ì‹œí—˜ë¶„ì•¼ ì„ íƒ: ${testField}. ê²€ì‚¬ëª©ì ì„ ì„ íƒí•˜ì„¸ìš”.`, 'info');
}

// ============================================================================
// ê²€ì‚¬ëª©ì  ì˜µì…˜ ì—…ë°ì´íŠ¸ (API ì—°ë™ + í´ë°±)
// ============================================================================
async function updateTestPurposeOptions(testField) {
    const select = document.getElementById('test-purpose');
    if (!select) {
        console.error('ê²€ì‚¬ëª©ì  select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let purposes = [];

    // API í˜¸ì¶œ ì‹œë„
    if (apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/test-purposes?field=${encodeURIComponent(testField)}`);
            if (res.ok) {
                const data = await res.json();
                purposes = data.purposes || [];
                console.log(`[API] ê²€ì‚¬ëª©ì  ë¡œë“œ: ${testField} - ${purposes.length}ê°œ`);
            }
        } catch (e) {
            console.warn('[API] ê²€ì‚¬ëª©ì  ë¡œë“œ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // í´ë°±
    if (purposes.length === 0) {
        purposes = FALLBACK_TEST_PURPOSE_MAPPING[testField] || [];
        console.log(`[í´ë°±] ê²€ì‚¬ëª©ì  ë¡œë“œ: ${testField} - ${purposes.length}ê°œ`);
    }

    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    purposes.forEach(purpose => {
        const option = document.createElement('option');
        option.value = purpose;
        option.textContent = purpose;
        select.appendChild(option);
    });
}

// ============================================================================
// ê²€ì‚¬ëª©ì  ë³€ê²½
// ============================================================================
function onTestPurposeChange() {
    document.getElementById('food-type-input').value = '';
    document.getElementById('food-type-value').value = '';

    const testPurpose = document.getElementById('test-purpose').value;
    if (testPurpose) {
        showToast(`ê²€ì‚¬ëª©ì  ì„ íƒ: ${testPurpose}. ê²€ì²´ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.`, 'info');
    }
}

// ============================================================================
// ê²€ì²´ìœ í˜• ê²€ìƒ‰ (API ì—°ë™ + í´ë°±)
// ============================================================================
async function searchFoodType(query) {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const testPurpose = document.getElementById('test-purpose').value;

    if (!testField || !testPurpose) {
        showToast('ì‹œí—˜ë¶„ì•¼ì™€ ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'warning');
        document.getElementById('food-type-list').classList.remove('active');
        return;
    }

    let allTypes = [];

    // API í˜¸ì¶œ ì‹œë„
    if (apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/food-types?field=${encodeURIComponent(testField)}&purpose=${encodeURIComponent(testPurpose)}`);
            if (res.ok) {
                const data = await res.json();
                allTypes = data.food_types || [];
                console.log(`[API] ê²€ì²´ìœ í˜• ë¡œë“œ: ${testField}-${testPurpose} - ${allTypes.length}ê°œ`);
            }
        } catch (e) {
            console.warn('[API] ê²€ì²´ìœ í˜• ë¡œë“œ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // í´ë°±
    if (allTypes.length === 0) {
        const key = `${testField}-${testPurpose}`;
        allTypes = FALLBACK_FOOD_TYPE_BY_PURPOSE[key] || [];
        console.log(`[í´ë°±] ê²€ì²´ìœ í˜• ë¡œë“œ: ${key} - ${allTypes.length}ê°œ`);
    }

    const filtered = query ? allTypes.filter(t => t.toLowerCase().includes(query.toLowerCase())) : allTypes;

    const list = document.getElementById('food-type-list');
    if (filtered.length === 0) {
        list.classList.remove('active');
        return;
    }

    list.innerHTML = filtered.map(type => {
        let display = type;
        if (query) {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            display = type.replace(regex, '<mark>$1</mark>');
        }
        return `<div class="autocomplete-item" onclick="selectFoodType('${type.replace(/'/g, "\\'")}')">${display}</div>`;
    }).join('');

    list.classList.add('active');
}

// ============================================================================
// ê²€ì²´ìœ í˜• ì„ íƒ
// ============================================================================
function selectFoodType(type) {
    document.getElementById('food-type-input').value = type;
    document.getElementById('food-type-value').value = type;
    document.getElementById('food-type-list').classList.remove('active');
    showToast(`ê²€ì²´ìœ í˜• ì„ íƒ: ${type}`, 'info');
}

// ============================================================================
// ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸ ì„¤ì •
// ============================================================================
function setPrevReceiptNo() {
    const prevNo = document.getElementById('prev-receipt-no').value.trim();
    if (prevNo) showToast(`ì´ì „ ì ‘ìˆ˜ë²ˆí˜¸: ${prevNo}ì—ì„œ ì´ì–´ì„œ ì‹œì‘í•©ë‹ˆë‹¤.`, 'info');
}

// ============================================================================
// ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ (API ì—°ë™ + í´ë°±)
// ============================================================================
async function allocateReceiptNo() {
    const testField = document.querySelector('input[name="test-field"]:checked')?.value;
    const testPurpose = document.getElementById('test-purpose').value;

    if (!testField || !testPurpose) {
        showToast('ì‹œí—˜ë¶„ì•¼ì™€ ê²€ì‚¬ëª©ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!', 'error');
        return;
    }

    const prevReceiptNo = document.getElementById('prev-receipt-no').value.trim();
    let receiptNo = '';

    // API í˜¸ì¶œ ì‹œë„
    if (apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/receipt-no/allocate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ testField, testPurpose, prevReceiptNo })
            });
            if (res.ok) {
                const data = await res.json();
                receiptNo = data.receiptNo;
                console.log(`[API] ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹: ${receiptNo}`);
            }
        } catch (e) {
            console.warn('[API] ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // í´ë°±: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒì„±
    if (!receiptNo) {
        const today = new Date();
        const yy = today.getFullYear().toString().slice(2);
        const mm = (today.getMonth() + 1).toString().padStart(2, '0');
        const dd = today.getDate().toString().padStart(2, '0');

        const purposeCode = FALLBACK_TEST_PURPOSE_CODES[testPurpose] || 'XX';
        const fieldCode = testField === 'ì‹í’ˆ' ? 'F' : 'L';

        let seq = '001';
        if (prevReceiptNo) {
            const match = prevReceiptNo.match(/(\d+)-\d+$/);
            if (match) seq = (parseInt(match[1]) + 1).toString().padStart(3, '0');
        }

        receiptNo = `${yy}${mm}${dd}${fieldCode}${purposeCode}${seq}-001`;
        console.log(`[í´ë°±] ì ‘ìˆ˜ë²ˆí˜¸ ìƒì„±: ${receiptNo}`);
    }

    document.getElementById('receipt-no').value = receiptNo;
    document.getElementById('receipt-no').classList.add('receipt-no-allocated');
    document.getElementById('receipt-no-status').textContent = 'âœ… í• ë‹¹ ì™„ë£Œ - ì ‘ìˆ˜ ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
    document.getElementById('receipt-no-status').style.color = '#4caf50';
    document.getElementById('status').value = 'ì ‘ìˆ˜ì¤‘';
    document.getElementById('receipt-no-warning').style.display = 'none';

    isReceiptNoAllocated = true;
    showToast(`ì ‘ìˆ˜ë²ˆí˜¸ í• ë‹¹ ì™„ë£Œ: ${receiptNo}`);
}

// ============================================================================
// ì—…ì²´ ê²€ìƒ‰ (API ì—°ë™ + í´ë°±)
// ============================================================================
let companySearchTimeout = null;

function searchCompany(query) {
    // ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬ (300ms)
    clearTimeout(companySearchTimeout);
    companySearchTimeout = setTimeout(() => _searchCompany(query), 300);
}

async function _searchCompany(query) {
    const suggestions = document.getElementById('company-suggestions');
    if (!query) {
        suggestions.classList.remove('active');
        return;
    }

    let companies = [];

    // API í˜¸ì¶œ ì‹œë„
    if (apiOnline) {
        try {
            const res = await fetch(`${API_BASE}/api/companies/search?q=${encodeURIComponent(query)}`);
            if (res.ok) {
                const data = await res.json();
                companies = data.companies || [];
                console.log(`[API] ì—…ì²´ ê²€ìƒ‰: "${query}" - ${companies.length}ê±´`);
            }
        } catch (e) {
            console.warn('[API] ì—…ì²´ ê²€ìƒ‰ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', e.message);
        }
    }

    // í´ë°±
    if (companies.length === 0) {
        companies = FALLBACK_COMPANIES.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
        console.log(`[í´ë°±] ì—…ì²´ ê²€ìƒ‰: "${query}" - ${companies.length}ê±´`);
    }

    if (companies.length === 0) {
        suggestions.classList.remove('active');
        return;
    }

    suggestions.innerHTML = companies.map(c => `
        <div class="suggestion-item" onclick="selectCompany(${JSON.stringify(c).replace(/"/g, '&quot;')})">
            <strong>${c.name}</strong><br>
            <small>${c.businessNo} | ${c.ceo}</small>
        </div>
    `).join('');
    suggestions.classList.add('active');
}

// ============================================================================
// ì—…ì²´ ì„ íƒ
// ============================================================================
function selectCompany(c) {
    if (typeof c === 'string') c = JSON.parse(c);
    document.getElementById('company-search').value = c.name;
    document.getElementById('company-name').value = c.name;
    document.getElementById('business-no').value = c.businessNo;
    document.getElementById('ceo').value = c.ceo;
    document.getElementById('phone').value = c.phone || '';
    document.getElementById('company-suggestions').classList.remove('active');
    showToast(`ì—…ì²´ ì„ íƒ: ${c.name}`, 'info');
}

// ============================================================================
// íŒ€ë³„ ë©”ëª¨ ê¶Œí•œ
// ============================================================================
function setupTeamMemoPermissions() {
    ['customer','quality','finance','marketing'].forEach(team => {
        const textarea = document.getElementById(`memo-${team}`);
        const lock = document.getElementById(`${team}-lock`);
        if (team === currentUserTeam) {
            textarea.disabled = false;
            lock.textContent = 'ğŸ”“ í¸ì§‘ ê°€ëŠ¥';
            lock.style.color = '#4caf50';
        } else {
            textarea.disabled = true;
            lock.textContent = 'ğŸ”’ ì½ê¸° ì „ìš©';
            lock.style.color = '#999';
        }
    });
}

// ============================================================================
// ìˆ˜ì • í‘œì‹œ
// ============================================================================
function markAsModified() {
    if (!isModified) {
        isModified = true;
        const btn = document.getElementById('save-btn');
        btn.classList.add('modified');
        btn.textContent = 'ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥';
    }
}

// ============================================================================
// ì €ì¥
// ============================================================================
function saveReceipt() {
    if (!isReceiptNoAllocated) {
        showToast('ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!', 'error');
        return;
    }
    if (!isModified) {
        showToast('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        return;
    }
    showToast('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    isModified = false;
    const btn = document.getElementById('save-btn');
    btn.classList.remove('modified');
    btn.textContent = 'ğŸ’¾ ì €ì¥';
}

// ============================================================================
// ì„ì‹œì €ì¥
// ============================================================================
function saveDraft() {
    const data = {
        receiptNo: document.getElementById('receipt-no').value,
        foodType: document.getElementById('food-type-value').value,
        memoCustomer: document.getElementById('memo-customer').value
    };
    localStorage.setItem('receipt-draft', JSON.stringify(data));
    showToast('ğŸ’¾ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ë¶ˆëŸ¬ì˜¤ê¸°
// ============================================================================
function loadDraft() {
    const draft = localStorage.getItem('receipt-draft');
    if (!draft) return;
    const data = JSON.parse(draft);
    Object.keys(data).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.value = data[key];
    });
}

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
function resetForm() {
    if (!confirm('ì…ë ¥í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    document.getElementById('receipt-form').reset();
    localStorage.removeItem('receipt-draft');
    isReceiptNoAllocated = false;
    isModified = false;

    document.getElementById('receipt-no').value = '';
    document.getElementById('receipt-no').classList.remove('receipt-no-allocated');
    document.getElementById('receipt-no-status').textContent = 'âŒ ë¯¸í• ë‹¹';
    document.getElementById('receipt-no-status').style.color = '#f44336';
    document.getElementById('status').value = 'ëŒ€ê¸°ì¤‘';
    document.getElementById('receipt-no-warning').style.display = 'flex';

    setTodayDate();

    const btn = document.getElementById('save-btn');
    btn.classList.remove('modified');
    btn.textContent = 'ğŸ’¾ ì €ì¥';

    showToast('ğŸ”„ í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ============================================================================
// ì œì¶œ
// ============================================================================
document.getElementById('receipt-form').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!isReceiptNoAllocated) {
        showToast('ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ë¨¼ì € í• ë‹¹ë°›ìœ¼ì„¸ìš”!', 'error');
        return;
    }

    const required = [
        {id:'receipt-date', name:'ì ‘ìˆ˜ì¼ì'},
        {id:'company-search', name:'ê±°ë˜ì²˜'},
        {id:'food-type-value', name:'ê²€ì²´ìœ í˜•'},
        {id:'product-name', name:'ì œí’ˆ/ì‹œë£Œëª…'},
        {id:'sample-amount', name:'ê²€ì²´ëŸ‰'},
        {id:'sample-count', name:'ê²€ì²´ìˆ˜'}
    ];

    for (const f of required) {
        const el = document.getElementById(f.id);
        if (!el.value) {
            showToast(`${f.name}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'error');
            el.focus();
            return;
        }
    }

    showToast('âœ… ì‹œë£Œ ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    setTimeout(() => {
        localStorage.removeItem('receipt-draft');
        window.location.reload();
    }, 2000);
});

// ============================================================================
// í† ìŠ¤íŠ¸
// ============================================================================
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast';
    if (type) toast.classList.add(type);
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
}

// ============================================================================
// ì™¸ë¶€ í´ë¦­
// ============================================================================
document.addEventListener('click', function(e) {
    if (!e.target.closest('.company-search')) {
        document.getElementById('company-suggestions').classList.remove('active');
    }
    if (!e.target.closest('.autocomplete-input')) {
        document.getElementById('food-type-list').classList.remove('active');
    }
});

// ì‚¬ì´ë“œë°” JS â†’ js/sidebar.jsë¡œ ì´ê´€ë¨
</script>
</body>
</html>
