<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab - ê³ ê°ì‚¬ ë“±ë¡ (v2)</title>
<!-- Daum Postcode API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- PDF.js (OCR PDFâ†’ì´ë¯¸ì§€ ë³€í™˜) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; height: 100vh; display: flex; background: #f8f9fb; font-size: 13px; }

  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; margin-left: 250px; }
  .topbar { background: #fff; border-bottom: 1px solid #e2e6ed; padding: 0 24px; height: 52px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .topbar-title { font-size: 15px; font-weight: 700; color: #1a2332; }
  .topbar-sep { color: #c8d6e5; }
  .topbar-sub { font-size: 13px; color: #5f6b7a; }
  .content { flex: 1; padding: 24px; overflow-y: auto; }

  .form-container { max-width: 920px; }
  .section { background: #fff; border-radius: 12px; border: 1px solid #e2e6ed; padding: 20px; margin-bottom: 16px; }
  .section-title { font-size: 15px; font-weight: 700; color: #1a2332; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid #eef0f4; display: flex; align-items: center; gap: 8px; }
  .section-title .num { background: #1a73e8; color: #fff; width: 22px; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
  .section-title .right { margin-left: auto; font-size: 11px; color: #8892a4; font-weight: 400; }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  .form-full { grid-column: 1 / -1; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-group label { font-size: 12px; color: #5f6b7a; font-weight: 600; }
  .form-group label .req { color: #e53935; margin-left: 2px; }
  .form-group input, .form-group select, .form-group textarea {
    padding: 9px 12px; border: 1px solid #e2e6ed; border-radius: 8px; font-size: 13px;
    outline: none; font-family: inherit; transition: border-color 0.15s;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #4fc3f7; box-shadow: 0 0 0 3px rgba(79,195,247,0.1); }
  .form-group textarea { resize: vertical; min-height: 70px; }
  .form-group select { cursor: pointer; background: #fff; }
  .hint { font-size: 10px; color: #8892a4; margin-top: 2px; }

  .radio-group { display: flex; gap: 12px; padding: 8px 0; }
  .radio-item { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; }
  .radio-item input[type="radio"] { accent-color: #1a73e8; width: 16px; height: 16px; cursor: pointer; }

  .sub-card { background: #f8f9fb; border-radius: 10px; border: 1px solid #eef0f4; padding: 14px; margin-bottom: 10px; position: relative; }
  .sub-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .sub-card-title { font-size: 12px; font-weight: 700; color: #1a2332; display: flex; align-items: center; gap: 6px; }
  .sub-card-num { background: #e3f2fd; color: #1565c0; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
  .btn-remove { background: none; border: none; color: #e53935; font-size: 18px; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
  .btn-remove:hover { background: #fce4ec; }

  .btn-add { display: flex; align-items: center; gap: 6px; padding: 10px 16px; border: 2px dashed #c8d6e5; border-radius: 10px; background: transparent; color: #5f6b7a; font-size: 12px; font-weight: 600; cursor: pointer; width: 100%; justify-content: center; transition: all 0.15s; }
  .btn-add:hover { border-color: #1a73e8; color: #1a73e8; background: #f0f7ff; }

  .address-row { display: flex; gap: 8px; }
  .address-row input { flex: 1; }
  .btn-address { padding: 9px 14px; border: 1px solid #e2e6ed; border-radius: 8px; background: #fff; font-size: 12px; color: #5f6b7a; cursor: pointer; white-space: nowrap; font-weight: 600; }
  .btn-address:hover { background: #f0f2f5; }

  .file-area { border: 2px dashed #e2e6ed; border-radius: 10px; padding: 14px; text-align: center; color: #8892a4; font-size: 12px; cursor: pointer; }
  .file-area:hover { border-color: #1a73e8; color: #1a73e8; background: #f0f7ff; }

  .dup-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; justify-content: center; align-items: center; }
  .dup-overlay.show { display: flex; }
  .dup-popup { background: #fff; border-radius: 14px; padding: 24px; max-width: 520px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
  .dup-popup h3 { font-size: 16px; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
  .dup-company-result { border: 1px solid #e2e6ed; border-radius: 10px; padding: 14px; margin-bottom: 10px; }
  .dup-company-name { font-size: 15px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
  .dup-company-info { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px; }
  .dup-label { color: #8892a4; width: 70px; flex-shrink: 0; font-size: 12px; }
  .dup-value { color: #1a2332; font-weight: 500; }
  .dup-masked { color: #1a2332; font-weight: 500; letter-spacing: 1px; }
  .dup-result { border: 1px solid #e2e6ed; border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
  .dup-result-header { background: #f8f9fb; padding: 10px 14px; font-size: 12px; font-weight: 600; color: #5f6b7a; display: flex; justify-content: space-between; align-items: center; }
  .dup-result-body { padding: 12px 14px; }
  .dup-row { display: flex; gap: 20px; font-size: 13px; margin-bottom: 6px; }
  .dup-actions { display: flex; gap: 8px; margin-top: 14px; }
  .dup-btn { flex: 1; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; text-align: center; }
  .dup-btn-link { background: #e3f2fd; color: #1565c0; }
  .dup-btn-link:hover { background: #bbdefb; }
  .dup-btn-new { background: #e8f5e9; color: #2e7d32; }
  .dup-btn-new:hover { background: #c8e6c9; }
  .dup-btn-cancel { background: #f0f2f5; color: #5f6b7a; }
  .dup-btn-cancel:hover { background: #e2e6ed; }
  .msg-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; background: #fff3e0; color: #e65100; }

  .our-row { display: flex; gap: 10px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
  .our-row select { padding: 7px 10px; border: 1px solid #e2e6ed; border-radius: 6px; font-size: 12px; flex: 1; min-width: 140px; }
  .our-arrow { color: #1a73e8; font-size: 13px; font-weight: 700; }

  .tax-copy-btn { font-size: 11px; color: #1a73e8; cursor: pointer; background: #e3f2fd; border: none; padding: 4px 10px; border-radius: 6px; font-weight: 600; }
  .tax-copy-btn:hover { background: #bbdefb; }

  .traffic-preview { display: flex; gap: 6px; align-items: center; padding: 8px 0; }
  .traffic-dot { width: 14px; height: 14px; border-radius: 50%; }

  .btn-check { padding: 7px 14px; border: 1px solid #1a73e8; border-radius: 8px; background: #e3f2fd; color: #1565c0; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }
  .btn-check:hover { background: #bbdefb; }

  .btn { padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; }
  .btn-success { background: #2e7d32; color: #fff; }
  .btn-success:hover { background: #1b5e20; }
  .btn-primary { background: #1565c0; color: #fff; }
  .btn-primary:hover { background: #0d47a1; }

  .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
  .btn-cancel { padding: 10px 24px; border: 1px solid #e2e6ed; border-radius: 8px; background: #fff; color: #5f6b7a; font-size: 13px; font-weight: 600; cursor: pointer; }
  .btn-cancel:hover { background: #f0f2f5; }
  .btn-submit { padding: 10px 24px; border: none; border-radius: 8px; background: #1a73e8; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; }
  .btn-submit:hover { background: #1557b0; }

  .toast { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1a2332; color: #fff; padding: 14px 28px; border-radius: 10px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 200; }
  .toast.show { display: block; animation: fadeUp 0.3s ease; }
  @keyframes fadeUp { from { opacity:0; transform: translateX(-50%) translateY(10px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }

  .info-banner { background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 10px; padding: 10px 14px; margin-bottom: 12px; font-size: 12px; color: #1565c0; display: flex; align-items: center; gap: 8px; }

  .combo-input { display: flex; gap: 6px; }
  .combo-input select { flex: 1; }
  .combo-input input { flex: 1; }
  .combo-input input.hidden { display: none; }

  .check-result { margin-top: 6px; font-size: 11px; padding: 6px 10px; border-radius: 6px; }
  .check-ok { background: #e8f5e9; color: #2e7d32; }
  .check-dup { background: #fff3e0; color: #e65100; }

  .eng-toggle { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 6px 0; color: #1565c0; font-size: 13px; font-weight: 500; }
  .law-badge { display:inline-flex; align-items:center; gap:4px; padding:6px 12px; border-radius:8px; font-size:11px; font-weight:600; background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; margin-top:8px; }

  .sales-rep-row { display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap; }
  .sales-rep-row select { padding:7px 10px; border:1px solid #e2e6ed; border-radius:6px; font-size:12px; min-width:140px; }
  .sales-rep-row .rep-label { font-size:11px; color:#8892a4; font-weight:600; flex-shrink:0; }
  .rep-badge { display:inline-flex; align-items:center; gap:4px; background:#e3f2fd; color:#1565c0; font-size:11px; padding:4px 12px; border-radius:10px; font-weight:600; }
  .lic-tags-area { display:flex; gap:4px; flex-wrap:wrap; margin-top:8px; }
  .lic-match-tag { display:inline-flex; align-items:center; gap:3px; background:#e8f5e9; color:#2e7d32; font-size:11px; padding:3px 8px; border-radius:10px; }
  /* .btn-match ì œê±°ë¨ */

  @media(max-width:768px) { .main { margin-left: 0; } }
  body.sidebar-collapsed .main { margin-left: 64px; }
</style>
</head>
<body>

<!-- ===== SIDEBAR (js/sidebar.js) ===== -->
<nav class="sidebar" id="sidebar"></nav>

<!-- íšŒì‚¬ ì¤‘ë³µ í™•ì¸ íŒì—… -->
<div class="dup-overlay" id="companyDupPopup">
  <div class="dup-popup">
    <h3>ğŸ” ë™ì¼ ê³ ê°ì‚¬ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤</h3>
    <div class="dup-company-result">
      <div class="dup-company-name">
        <span style="background:#ff9800;width:10px;height:10px;border-radius:50%;display:inline-block;"></span>
        í’€ë¬´ì›ì‹í’ˆ(ì£¼)
        <span class="msg-badge">ğŸŸ  ì£¼í™©</span>
      </div>
      <div class="dup-company-info">
        <div><span class="dup-label">ì‚¬ì—…ìë²ˆí˜¸</span> 234-56-78901</div>
        <div><span class="dup-label">ëŒ€í‘œì</span> ì›í’€ë¬´</div>
        <div><span class="dup-label">ë‹´ë‹¹ ì˜ì—…</span> ë°•ì£¼ì„</div>
        <div><span class="dup-label">ìµœê·¼ê±°ë˜</span> 2026-01-28</div>
      </div>
    </div>
    <div style="background:#fffde7; border:1px solid #fff176; border-radius:8px; padding:10px 12px; font-size:12px; color:#f57f17; margin-bottom:14px;">
      âš ï¸ ì´ë¯¸ <strong>ë°•ì£¼ì„</strong>ì´ ë‹´ë‹¹í•˜ê³  ìˆëŠ” ì—…ì²´ì…ë‹ˆë‹¤. ì‹ ê·œ ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•˜ë©´ ë°•ì£¼ì„ì—ê²Œ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.
    </div>
    <div class="dup-actions">
      <button class="dup-btn dup-btn-cancel" onclick="closeDup('companyDupPopup')">ì·¨ì†Œ</button>
      <button class="dup-btn dup-btn-link" onclick="closeDup('companyDupPopup'); showToastMsg('ğŸ“© ë°•ì£¼ì„ì—ê²Œ ì•Œë¦¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤. ë‹´ë‹¹ìë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.')">ê¸°ì¡´ ì—…ì²´ì— ë‹´ë‹¹ì ì¶”ê°€</button>
    </div>
  </div>
</div>

<!-- ë‹´ë‹¹ì ì¤‘ë³µ í™•ì¸ íŒì—… -->
<div class="dup-overlay" id="contactDupPopup">
  <div class="dup-popup">
    <h3>ğŸ” ë™ì¼ ë‹´ë‹¹ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p style="font-size:13px; color:#5f6b7a; margin-bottom:14px;">ì…ë ¥í•˜ì‹  ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¡œ ì¡°íšŒí•œ ê²°ê³¼, ì•„ë˜ ì •ë³´ê°€ í™•ì¸ë©ë‹ˆë‹¤.</p>
    <div class="dup-result">
      <div class="dup-result-header">
        <span>ê¸°ì¡´ ë“±ë¡ ì •ë³´</span>
        <span class="msg-badge">ë‹´ë‹¹: ë°•ì£¼ì„</span>
      </div>
      <div class="dup-result-body">
        <div class="dup-row"><span class="dup-label">ì´ë¦„</span><span class="dup-value">ì´ê·œì„±</span></div>
        <div class="dup-row"><span class="dup-label">ì „í™”ë²ˆí˜¸</span><span class="dup-masked">010-****-5678</span></div>
        <div class="dup-row"><span class="dup-label">ì´ë©”ì¼</span><span class="dup-masked">lee***@pulmu.com</span></div>
        <div class="dup-row"><span class="dup-label">ì†Œì†</span><span class="dup-value">í’€ë¬´ì›ì‹í’ˆ(ì£¼)</span></div>
      </div>
    </div>
    <div style="font-size:12px; color:#5f6b7a; margin-bottom:14px;">ì´ ì‚¬ëŒê³¼ <strong>ë™ì¼ ì¸ë¬¼</strong>ì…ë‹ˆê¹Œ?</div>
    <div class="dup-actions" style="flex-wrap:wrap;">
      <button class="dup-btn dup-btn-cancel" onclick="closeDup('contactDupPopup')">ì·¨ì†Œ</button>
      <button class="dup-btn dup-btn-new" onclick="closeDup('contactDupPopup'); showToastMsg('âœ… ì‹ ê·œ ë‹´ë‹¹ìë¡œ ë“±ë¡í•©ë‹ˆë‹¤.')">ì•„ë‹ˆì˜¤, ì‹ ê·œ ë“±ë¡</button>
      <button class="dup-btn dup-btn-link" onclick="closeDup('contactDupPopup'); showToastMsg('ğŸ“© ê¸°ì¡´ ë‹´ë‹¹ ë°•ì£¼ì„ì—ê²Œ ì•Œë¦¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.')">ì˜ˆ, ë™ì¼ ì¸ë¬¼ (ê¸°ì¡´ ì—°ê²°)</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<div class="main">
  <div class="topbar">
    <span class="topbar-title">ì˜ì—… ê´€ë¦¬</span>
    <span class="topbar-sep">â€º</span>
    <span class="topbar-sub">ê³ ê°ì‚¬ ê´€ë¦¬</span>
    <span class="topbar-sep">â€º</span>
    <span class="topbar-sub" style="color:#1a73e8; font-weight:600;">ì‹ ê·œ ë“±ë¡</span>
  </div>
  <div class="content">
    <div class="form-container">

      <!-- ì‚¬ì—…ìë“±ë¡ì¦ / ì¸í—ˆê°€ë¬¸ì„œ OCR (ë‚˜ë€íˆ) -->
      <div style="background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);border:2px solid #90caf9;border-radius:12px;padding:16px;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span style="font-size:18px">ğŸ”„</span>
          <div>
            <div style="font-size:13px;font-weight:700;color:#1565c0">ì‚¬ì—…ìë“±ë¡ì¦ / ì¸í—ˆê°€ë¬¸ì„œ OCR ìë™ì…ë ¥</div>
            <div style="font-size:11px;color:#5c6bc0">ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ ê¸°ë³¸ì •ë³´ + ì£¼ì†Œ + ì¸í—ˆê°€ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="file-area" id="bizLicFileArea" style="flex:1;min-width:200px;padding:10px;position:relative" onclick="document.getElementById('bizLicFileInput').click()" ondragover="event.preventDefault();this.style.borderColor='#1565c0'" ondragleave="this.style.borderColor='#90caf9'" ondrop="event.preventDefault();this.style.borderColor='#90caf9';handleBizLicFile(event.dataTransfer.files[0])">
            <input type="file" id="bizLicFileInput" accept="image/*,.pdf" style="display:none" onchange="handleBizLicFile(this.files[0])">
            <span id="bizLicFileName" style="font-size:11px">ğŸ“ ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼</span>
          </div>
          <button class="btn btn-primary" id="bizLicOcrBtn" onclick="runBizLicOCR()" disabled style="white-space:nowrap;padding:8px 14px;font-size:12px">ğŸ¤– ì‚¬ì—…ìë“±ë¡ì¦ OCR</button>
          <div class="file-area" id="licFileArea_1" style="flex:1;min-width:200px;padding:10px;position:relative" onclick="document.getElementById('licFileInput_1').click()" ondragover="event.preventDefault();this.style.borderColor='#1565c0'" ondragleave="this.style.borderColor='#90caf9'" ondrop="event.preventDefault();this.style.borderColor='#90caf9';handleLicFile(1,event.dataTransfer.files[0])">
            <input type="file" id="licFileInput_1" accept="image/*,.pdf" style="display:none" onchange="handleLicFile(1,this.files[0])">
            <span id="licFileName_1" style="font-size:11px">ğŸ“ ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼</span>
          </div>
          <button class="btn btn-check" id="licOcrBtn_1" onclick="runLicOCR(1)" disabled style="white-space:nowrap;padding:8px 14px;font-size:12px">ğŸ¤– ì¸í—ˆê°€ OCR</button>
        </div>
        <div id="bizLicOcrStatus" style="margin-top:6px;font-size:11px;color:#1565c0;display:none"></div>
        <div id="bizLicPreview" style="margin-top:10px;display:none"><img id="bizLicPreviewImg" style="max-width:100%;max-height:200px;border-radius:8px;border:1px solid #90caf9"></div>
      </div>

      <!-- 1. ê¸°ë³¸ ì •ë³´ -->
      <div class="section">
        <div class="section-title"><span class="num">1</span> ê¸°ë³¸ ì •ë³´</div>
        <div class="form-grid">
          <div class="form-group">
            <label>ë²•ì¸ ì—¬ë¶€ <span class="req">*</span></label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="corpType" value="ë²•ì¸" checked onchange="toggleCorpNo()"> ë²•ì¸</label>
              <label class="radio-item"><input type="radio" name="corpType" value="ê°œì¸" onchange="toggleCorpNo()"> ê°œì¸</label>
            </div>
          </div>
          <div class="form-group">
            <label>ê±°ë˜ì²˜ ë“±ê¸‰</label>
            <div style="display:flex;align-items:center;gap:8px;padding:8px 0">
              <span style="background:#e3f2fd;color:#1565c0;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600">ìë™ ì‚°ì¶œ</span>
              <span style="font-size:11px;color:#8892a4">ê´€ë¦¬ì â€º ë“±ê¸‰ì„¤ì • â€º ë“±ê¸‰ê·œì¹™ì— ë”°ë¼ ìë™ ì‚°ì¶œë©ë‹ˆë‹¤</span>
            </div>
          </div>
          <div class="form-group">
            <label>íšŒì‚¬ëª… <span class="req">*</span></label>
            <div style="display:flex; gap:6px;">
              <input type="text" id="companyName" placeholder="ì˜ˆ: í’€ë¬´ì›ì‹í’ˆ(ì£¼)" style="flex:1;" />
              <button class="btn-check" onclick="checkCompanyDup()">ì¤‘ë³µ í™•ì¸</button>
            </div>
            <div class="check-result check-ok" id="companyCheckResult" style="display:none;"></div>
          </div>
          <div class="form-group">
            <label>ëŒ€í‘œìëª… <span class="req">*</span></label>
            <input type="text" id="regRepName" placeholder="ëŒ€í‘œì ì´ë¦„" />
          </div>
          <div class="form-group">
            <label>ì‚¬ì—…ìë²ˆí˜¸ <span class="req">*</span></label>
            <div style="display:flex; gap:6px;">
              <input type="text" id="bizNo" placeholder="000-00-00000" maxlength="12" oninput="formatBizNo(this)" style="flex:1;" />
              <button class="btn-check" onclick="checkBizDup()">ì¤‘ë³µ í™•ì¸</button>
            </div>
            <div class="check-result" id="bizCheckResult" style="display:none;"></div>
          </div>
          <div class="form-group" id="corpNoGroup">
            <label>ë²•ì¸ë²ˆí˜¸ <span class="req">*</span></label>
            <input type="text" id="regCorpNo" placeholder="000000-0000000" maxlength="14" oninput="formatCorpNo(this)" />
          </div>
          <div class="form-group">
            <label>ì—…íƒœ <span class="req">*</span></label>
            <input type="text" id="regBizType" placeholder="ì˜ˆ: ì œì¡°ì—…" />
          </div>
          <div class="form-group">
            <label>ì¢…ëª© <span class="req">*</span></label>
            <input type="text" id="regBizItem" placeholder="ì˜ˆ: ì‹í’ˆ" />
          </div>
          <div class="form-group">
            <label>ê³„ì•½ ìƒíƒœ</label>
            <select id="regStatus"><option value="í™œë™" selected>í™œë™</option><option value="íœ´ë©´">íœ´ë©´</option><option value="í•´ì§€">í•´ì§€</option></select>
          </div>
          <div class="form-group">
            <label>ì‹ í˜¸ë“±</label>
            <div class="traffic-preview">
              <span class="traffic-dot" style="background:#2196f3;"></span>
              <span style="font-size:11px; color:#5f6b7a;">íŒŒë‘ (ì‹ ê·œ ë“±ë¡ ì‹œ ê¸°ë³¸ê°’ â€” ìë™ ì‚°ì¶œ)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. ì£¼ì†Œ -->
      <div class="section">
        <div class="section-title"><span class="num">2</span> ì£¼ì†Œ</div>
        <div class="form-group" style="margin-bottom:10px;">
          <label>ì‚¬ì—…ì¥ ì£¼ì†Œ <span class="req">*</span></label>
          <div class="address-row">
            <input type="text" id="regZipcode" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;" readonly />
            <button class="btn-address" onclick="openPostcodeSearch()">ğŸ” ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:10px;">
          <input type="text" id="regAddr1" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ì‹œ ìë™ì…ë ¥)" readonly />
        </div>
        <div class="form-group">
          <input type="text" id="regAddr2" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥" />
        </div>
        <div class="eng-toggle" onclick="toggleEngSection('bizEngSection')" style="margin-top:12px">
          <span id="bizEngArrow" style="transition:transform .2s;display:inline-block">â–¶</span> ì‚¬ì—…ìë“±ë¡ì¦ (ì˜ë¬¸ ì •ë³´)
        </div>
        <div id="bizEngSection" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed;margin-bottom:8px">
          <div class="form-group" style="margin-bottom:8px"><label>Company Name (EN)</label><input id="regCompanyNameEn" placeholder="Company name in English"></div>
          <div class="form-group" style="margin-bottom:8px"><label>Representative (EN)</label><input id="regRepNameEn" placeholder="Representative name in English"></div>
          <div class="form-group"><label>Address (EN)</label><input id="regAddrEn" placeholder="Address in English (auto-converted)"></div>
        </div>
      </div>

      <!-- 3. ì¸í—ˆê°€ ì •ë³´ -->
      <div class="section">
        <div class="section-title"><span class="num">3</span> ì¸í—ˆê°€ ì •ë³´ <span class="right">ì—¬ëŸ¬ ê°œ ë“±ë¡ ê°€ëŠ¥</span></div>
        <div class="info-banner">ğŸ“‹ ì‹í’ˆ/ì¶•ì‚° ë¶„ì•¼ë³„ ì˜ì—…ë“±ë¡ì¦, í—ˆê°€ì¦, ì‹ ê³ í•„ì¦ ë“±ì˜ ì¸í—ˆê°€ ì •ë³´ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.</div>
        <div id="licenseList">
          <div class="sub-card" id="license-1">
            <div class="sub-card-header">
              <div class="sub-card-title"><span class="sub-card-num">1</span> ì¸í—ˆê°€</div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>ë¶„ì•¼ <span class="req">*</span></label>
                <select id="licField_1" onchange="updateBizTypeOptions(this)">
                  <option value="">ì„ íƒ</option>
                  <option value="ì‹í’ˆ">ì‹í’ˆ</option>
                  <option value="ì¶•ì‚°">ì¶•ì‚°</option>
                </select>
              </div>
              <div class="form-group">
                <label>ì˜ì—…ì˜ í˜•íƒœ <span class="req">*</span></label>
                <div class="combo-input">
                  <select id="licBizForm_1" onchange="toggleCustomInput(this)">
                    <option value="">ì„ íƒ</option>
                    <optgroup label="ì‹í’ˆ">
                      <option>ì‹í’ˆì œì¡°ê°€ê³µì—…</option><option>ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</option><option>ì‹í’ˆì†Œë¶„ì—…</option><option>ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì‹í’ˆìš´ë°˜ì—…</option><option>ì‹í’ˆëƒ‰ë™ëƒ‰ì¥ì—…</option>
                    </optgroup>
                    <optgroup label="ì¶•ì‚°">
                      <option>ì¶•ì‚°ë¬¼ê°€ê³µì—…</option><option>ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</option><option>ì¶•ì‚°ë¬¼ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì¶•ì‚°ë¬¼ìš´ë°˜ì—…</option><option>ì¶•ì‚°ë¬¼ë³´ê´€ì—…</option>
                    </optgroup>
                    <option value="ì§ì ‘ì…ë ¥">âœï¸ ì§ì ‘ ì…ë ¥</option>
                  </select>
                  <input type="text" class="hidden" placeholder="ì˜ì—…ì˜ í˜•íƒœ ì§ì ‘ ì…ë ¥" />
                </div>
              </div>
              <div class="form-group">
                <label>ëŒ€í‘œì <span class="req">*</span></label>
                <input type="text" id="licRepName_1" placeholder="ì¸í—ˆê°€ ëŒ€í‘œì" />
              </div>
              <div class="form-group">
                <label>ì¸í—ˆê°€ë²ˆí˜¸ <span class="req">*</span></label>
                <input type="text" id="licNo_1" placeholder="ì¸í—ˆê°€ë²ˆí˜¸ ì…ë ¥" />
              </div>
              <div class="form-group">
                <label>ì˜ì—…ì†Œëª…ì¹­ <span class="req">*</span></label>
                <input type="text" id="licBizName_1" placeholder="ì˜ì—…ì†Œ ëª…ì¹­" />
              </div>
              <div class="form-group form-full">
                <label>ì†Œì¬ì§€ <span class="req">*</span></label>
                <div class="address-row" style="margin-bottom:6px">
                  <input type="text" id="licZipcode_1" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;" readonly />
                  <button type="button" class="btn-address" onclick="openLicPostcode(1)">ğŸ” ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
                </div>
                <input type="text" id="licAddr_1" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ì‹œ ìë™ì…ë ¥)" readonly style="margin-bottom:6px" />
                <input type="text" id="licAddrDetail_1" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥" />
              </div>
              <div class="form-group form-full">
                <div id="licOcrStatus_1" style="font-size:11px;color:#1565c0;display:none"></div>
              </div>
            </div>
            <div id="licLawBadge_1" class="law-badge" style="display:none"></div>
            <div class="eng-toggle" onclick="toggleEngSection('licEngSection_1')" style="margin-top:8px">
              <span id="licEngArrow_1" style="transition:transform .2s;display:inline-block">â–¶</span> ì¸í—ˆê°€ ì •ë³´ (ì˜ë¬¸)
            </div>
            <div id="licEngSection_1" style="display:none;padding:8px 0 4px 0;border-top:1px dashed #e2e6ed">
              <div class="form-group" style="margin-bottom:8px"><label>Business Name (EN)</label><input id="licBizNameEn_1" placeholder="Business name in English"></div>
              <div class="form-group" style="margin-bottom:8px"><label>Representative (EN)</label><input id="licRepNameEn_1" placeholder="Representative name in English"></div>
              <div class="form-group"><label>Address (EN)</label><input id="licAddrEn_1" placeholder="Address in English (auto-converted)"></div>
            </div>
          </div>
        </div>
        <button class="btn-add" onclick="addLicense()">+ ì¸í—ˆê°€ ì •ë³´ ì¶”ê°€</button>
      </div>

      <!-- 4. ê³ ê°ì‚¬ ë‹´ë‹¹ì -->
      <div class="section">
        <div class="section-title"><span class="num">4</span> ê³ ê°ì‚¬ ë‹´ë‹¹ì <span class="right">ì—¬ëŸ¬ ëª… ë“±ë¡ ê°€ëŠ¥ Â· ì¤‘ë³µ í™•ì¸ ìë™ ì‹¤í–‰</span></div>
        <div class="info-banner">ğŸ” ì´ë¦„ + ì „í™”ë²ˆí˜¸ ì…ë ¥ í›„ ì¤‘ë³µ í™•ì¸ì„ í´ë¦­í•˜ë©´ ê¸°ì¡´ ë“±ë¡ ì—¬ë¶€ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. ë™ì¼ ì¸ë¬¼ ë°œê²¬ ì‹œ ê¸°ì¡´ ë‹´ë‹¹ ì˜ì—…ì‚¬ì›ì—ê²Œ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.</div>
        <div id="contactList">
          <div class="sub-card" id="contact-1">
            <div class="sub-card-header">
              <div class="sub-card-title"><span class="sub-card-num">1</span> ë‹´ë‹¹ì</div>
              <div style="display:flex;gap:4px;align-items:center">
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group"><label>ì—…ì²´ëª…</label><input type="text" id="cCompany1" placeholder="í´ë¦­í•˜ì—¬ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥" onclick="openCompanySelectModal(1)" readonly style="cursor:pointer;background:#fafbfc" /><input type="text" id="cCompanyCustom1" placeholder="ì—…ì²´ëª… ì§ì ‘ ì…ë ¥" style="display:none;margin-top:4px" /></div>
              <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="cDept1" placeholder="ë¶€ì„œëª…" /></div>
            </div>
            <div class="form-grid-3" style="margin-top:8px">
              <div class="form-group"><label>ë‹´ë‹¹ì(ì´ë¦„) <span class="req">*</span></label><input type="text" id="cName1" placeholder="ë‹´ë‹¹ì ì´ë¦„" /></div>
              <div class="form-group"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input type="text" id="cPhone1" placeholder="010-0000-0000" oninput="formatPhone(this)" /></div>
              <div class="form-group"><label>ì´ë©”ì¼ <span class="req">*</span></label><input type="email" id="cEmail1" placeholder="email@example.com" /></div>
            </div>
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button class="btn-check" onclick="checkContactDup()">ğŸ” ì¤‘ë³µ í™•ì¸</button>
              <div class="check-result check-ok" id="contactCheckResult1" style="display:none;"></div>
            </div>
            <div class="sales-rep-row">
              <span class="rep-label">ìì‚¬ ë‹´ë‹¹ì ì—°ê²°:</span>
              <select id="cTeam1" onchange="filterRepByTeam(1)"><option value="">ë¶€ì„œ(íŒ€) ì„ íƒ</option></select>
              <select id="cRep1" onchange="updateRepBadge(1)"><option value="">ì ‘ìˆ˜ì(ë‹´ë‹¹ì) ì„ íƒ</option></select>
              <span id="cRepBadge1"></span>
            </div>
            <div id="contactLicTags_1" class="lic-tags-area"></div>
            <input type="hidden" id="contactLicNums_1" value="" />
          </div>
        </div>
        <button class="btn-add" onclick="addContact()">+ ë‹´ë‹¹ì ì¶”ê°€</button>
      </div>

      <!-- 5. ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì -->
      <div class="section">
        <div class="section-title">
          <span class="num">5</span> ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì
          <button class="tax-copy-btn" style="margin-left:auto;" onclick="copyFromContact1()">ğŸ“‹ 1ë²ˆ ë‹´ë‹¹ì ì •ë³´ ë³µì‚¬</button>
        </div>
        <div class="form-grid">
          <div class="form-group"><label>ì—…ì²´ëª…</label><input type="text" id="taxCompany" placeholder="í´ë¦­í•˜ì—¬ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥" onclick="openCompanySelectModal('tax')" readonly style="cursor:pointer;background:#fafbfc" /><input type="text" id="taxCompanyCustom" placeholder="ì—…ì²´ëª… ì§ì ‘ ì…ë ¥" style="display:none;margin-top:4px" /></div>
          <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="taxDept" placeholder="ë¶€ì„œëª…" /></div>
        </div>
        <div class="form-grid-3" style="margin-top:8px">
          <div class="form-group"><label>ë‹´ë‹¹ì(ì´ë¦„) <span class="req">*</span></label><input type="text" id="taxName" placeholder="ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì ì´ë¦„" /></div>
          <div class="form-group"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input type="text" id="taxPhone" placeholder="010-0000-0000" oninput="formatPhone(this)" /></div>
          <div class="form-group"><label>ì´ë©”ì¼ <span class="req">*</span></label><input type="email" id="taxEmail" placeholder="ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì‹  ì´ë©”ì¼" /></div>
        </div>
      </div>

      <!-- 6. ë©”ëª¨ -->
      <div class="section">
        <div class="section-title"><span class="num">6</span> ë©”ëª¨ / ë¹„ê³ </div>
        <div class="form-group">
          <textarea id="regNote" placeholder="íŠ¹ì´ì‚¬í•­, ê³„ì•½ ì¡°ê±´, ì°¸ê³ ì‚¬í•­ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
      </div>

      <!-- 7. ë³€ê²½ ì´ë ¥ -->
      <div class="section">
        <div class="section-title"><span class="num">7</span> ë³€ê²½ ì´ë ¥</div>
        <div id="changeLogArea" style="max-height:300px;overflow-y:auto">
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead>
              <tr style="border-bottom:2px solid #e2e6ed">
                <th style="width:140px;text-align:left;padding:8px;color:#5f6b7a">ì¼ì‹œ</th>
                <th style="width:80px;text-align:left;padding:8px;color:#5f6b7a">ë³€ê²½ì</th>
                <th style="text-align:left;padding:8px;color:#5f6b7a">ë³€ê²½ ë‚´ìš©</th>
              </tr>
            </thead>
            <tbody id="changeLogTbody">
              <tr><td colspan="3" style="text-align:center;color:#8892a4;padding:20px">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn-cancel" onclick="if(confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) history.back()">ì·¨ì†Œ</button>
        <button class="btn-submit" onclick="submitCompanyForm()">âœ… ê³ ê°ì‚¬ ë“±ë¡</button>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>

<!-- ì—…ì²´ëª… ì„ íƒ ëª¨ë‹¬ -->
<div class="dup-overlay" id="companySelectModal">
  <div class="dup-popup" style="max-width:460px">
    <h3>ğŸ¢ ì—…ì²´ëª… ì„ íƒ</h3>
    <div style="font-size:12px;color:#5f6b7a;margin-bottom:14px">ì‚¬ì—…ìë“±ë¡ì¦ ë˜ëŠ” ì¸í—ˆê°€ ì •ë³´ì—ì„œ ì—…ì²´ëª…ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</div>
    <div id="companySelectList" style="max-height:260px;overflow-y:auto;margin-bottom:12px"></div>
    <div style="border-top:1px solid #eef0f4;padding-top:12px;margin-bottom:12px">
      <label style="display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e2e6ed;border-radius:8px;cursor:pointer">
        <input type="radio" name="companySelectRadio" value="__custom__" style="width:18px;height:18px;accent-color:#1a73e8" />
        <div style="flex:1"><div style="font-weight:600;font-size:13px">âœï¸ ì§ì ‘ ì…ë ¥</div><div style="font-size:11px;color:#8892a4">ìœ„ ëª©ë¡ì— ì—†ëŠ” ì—…ì²´ëª…ì„ ì§ì ‘ ì…ë ¥</div></div>
      </label>
    </div>
    <div class="dup-actions">
      <button class="dup-btn dup-btn-cancel" onclick="closeCompanySelectModal()">ì·¨ì†Œ</button>
      <button class="dup-btn dup-btn-link" onclick="applyCompanySelect()">ì„ íƒ</button>
    </div>
  </div>
</div>

<!-- ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­ ëª¨ë‹¬ -->
<div class="dup-overlay" id="licContactMatchModal">
  <div class="dup-popup" style="max-width:420px">
    <h3>ğŸ”— ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­</h3>
    <div style="font-size:13px;color:#5f6b7a;margin-bottom:16px" id="licMatchDesc">ì´ ë‹´ë‹¹ìë¥¼ ì–´ë–¤ ì¸í—ˆê°€ì˜ ë‹´ë‹¹ìë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <div id="licMatchList" style="max-height:240px;overflow-y:auto;margin-bottom:16px"></div>
    <div class="dup-actions">
      <button class="dup-btn-cancel" onclick="closeLicMatchModal()">ì·¨ì†Œ</button>
      <button class="dup-btn-link" onclick="applyLicMatch()">ì ìš©</button>
    </div>
  </div>
</div>

<script src="js/sidebar.js"></script>
<script>
/* ===== OCR ì„¤ì • ===== */
var OCR_PROXY_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'https://localhost:5002' : '/ocr';
var OCR_BIZ_LICENSE_URL = OCR_PROXY_BASE + '/api/ocr/biz-license';
var OCR_GENERAL_URL = OCR_PROXY_BASE + '/api/ocr/general';
/* ===== ë³€ê²½ ì´ë ¥ ===== */
var changeLog = [];

function renderChangeLog(logs) {
  var tbody = document.getElementById('changeLogTbody');
  if (!tbody) return;
  if (!logs || logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8892a4;padding:20px">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }
  tbody.innerHTML = '';
  var sorted = logs.slice().reverse();
  sorted.forEach(function(log) {
    var tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #f0f2f5';
    tr.innerHTML = '<td style="white-space:nowrap;color:#5f6b7a;padding:8px">' + log.date + '</td>' +
      '<td style="padding:8px">' + (log.who || 'ì‹œìŠ¤í…œ') + '</td>' +
      '<td style="font-size:11px;padding:8px">' + (log.detail || '') + '</td>';
    tbody.appendChild(tr);
  });
}
var _bizLicFile = null;
var _licFiles = {};
var _bizLicOcrResult = null;   // ì‚¬ì—…ìë“±ë¡ì¦ OCR ì¸ì‹ ê²°ê³¼ (Firebase ì €ì¥ìš©)
var _licOcrResults = {};        // ì¸í—ˆê°€ OCR ì¸ì‹ ê²°ê³¼ {idx: {...}} (Firebase ì €ì¥ìš©)

/* ===== ì‚¬ì—…ìë“±ë¡ì¦ OCR ===== */
function handleBizLicFile(file) {
  if (!file) return;
  _bizLicFile = file;
  document.getElementById('bizLicFileName').textContent = 'ğŸ“ ' + file.name;
  document.getElementById('bizLicOcrBtn').disabled = false;
  if (file.type.startsWith('image/')) {
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('bizLicPreviewImg').src = e.target.result;
      document.getElementById('bizLicPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    document.getElementById('bizLicPreview').style.display = 'none';
  }
}

function runBizLicOCR() {
  if (!_bizLicFile) return;
  var statusEl = document.getElementById('bizLicOcrStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = 'â³ OCR ì¸ì‹ ì¤‘...';
  document.getElementById('bizLicOcrBtn').disabled = true;

  fileToBase64(_bizLicFile).then(function(b64) {
    var fmt = _bizLicFile.name.split('.').pop().toLowerCase();
    if (fmt === 'pdf') fmt = 'pdf';
    else if (fmt === 'png') fmt = 'png';
    else fmt = 'jpg';

    var payload = {
      version: 'V2',
      requestId: 'bfl-' + Date.now(),
      timestamp: Date.now(),
      images: [{ format: fmt, name: _bizLicFile.name, data: b64 }]
    };

    return fetch(OCR_BIZ_LICENSE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  }).then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result) {
      var res = data.images[0].bizLicense.result;
      var getText = function(arr) { return (arr && arr[0] && arr[0].text) ? arr[0].text.trim() : ''; };
      var companyName = getText(res.companyName) || getText(res.corpName);
      var repName = getText(res.repName);
      var bizNo = getText(res.registerNumber) || getText(res.bisRegistrationNumber);
      // ë²•ì¸ë²ˆí˜¸: Clova OCR ì‹¤ì œ í•„ë“œëª… = corpRegisterNum
      var corpNo = getText(res.corpRegisterNum) || getText(res.corporationNumber) || getText(res.corpRegisterNumber);
      var taxType = getText(res.taxType); // "ë²•ì¸ì‚¬ì—…ì", "ì¼ë°˜ê³¼ì„¸ì" ë“±
      var bizType = getText(res.bisType);
      var bizItem = getText(res.bisItem);
      var addr = '';
      if (res.bisAddress && res.bisAddress[0] && res.bisAddress[0].text) addr = res.bisAddress[0].text.trim();

      // ===== ë²•ì¸/ê°œì¸ ìë™ íŒë³„ =====
      var isCorp = !!corpNo || /ë²•ì¸/.test(taxType);
      var corpTypeRadios = document.querySelectorAll('input[name="corpType"]');
      if (isCorp) {
        // ë²•ì¸ë²ˆí˜¸ê°€ ìˆê±°ë‚˜ ê³¼ì„¸ìœ í˜•ì´ "ë²•ì¸ì‚¬ì—…ì" â†’ ë²•ì¸
        corpTypeRadios.forEach(function(r) { r.checked = (r.value === 'ë²•ì¸'); });
        document.getElementById('corpNoGroup').style.display = 'flex';
      } else {
        // ê°œì¸ì‚¬ì—…ì
        corpTypeRadios.forEach(function(r) { r.checked = (r.value === 'ê°œì¸'); });
        document.getElementById('corpNoGroup').style.display = 'none';
      }

      var changes = [];
      function setField(id, label, val) {
        if (!val) return;
        var el = document.getElementById(id);
        if (!el) return;
        var oldVal = el.value || '';
        el.value = val;
        if (oldVal !== val) changes.push({ field: label, from: oldVal, to: val });
      }
      setField('companyName', 'íšŒì‚¬ëª…', companyName);
      setField('regRepName', 'ëŒ€í‘œìëª…', repName);
      if (bizNo) { setField('bizNo', 'ì‚¬ì—…ìë²ˆí˜¸', bizNo); formatBizNo(document.getElementById('bizNo')); }
      if (corpNo) { setField('regCorpNo', 'ë²•ì¸ë²ˆí˜¸', corpNo); formatCorpNo(document.getElementById('regCorpNo')); }
      changes.push({ field: 'ë²•ì¸ì—¬ë¶€', from: '', to: isCorp ? 'ë²•ì¸' : 'ê°œì¸' });
      setField('regBizType', 'ì—…íƒœ', bizType);
      setField('regBizItem', 'ì¢…ëª©', bizItem);
      // ì£¼ì†Œ: ì‰¼í‘œ(,) ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ì£¼ì†Œ/ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬
      if (addr) {
        var addrEl = document.getElementById('regAddr1');
        var commaIdx = addr.indexOf(',');
        if (commaIdx > -1) {
          var baseAddr = addr.substring(0, commaIdx).trim();
          var detailAddr = addr.substring(commaIdx + 1).trim();
          if (addrEl) { addrEl.removeAttribute('readonly'); }
          setField('regAddr1', 'ì£¼ì†Œ(ê¸°ë³¸)', baseAddr);
          if (addrEl) { addrEl.setAttribute('readonly', 'readonly'); }
          setField('regAddr2', 'ì£¼ì†Œ(ìƒì„¸)', detailAddr);
        } else {
          if (addrEl) { addrEl.removeAttribute('readonly'); }
          setField('regAddr1', 'ì£¼ì†Œ', addr);
          if (addrEl) { addrEl.setAttribute('readonly', 'readonly'); }
        }
      }

      // OCR ì£¼ì†Œ ê¸°ë°˜ ìš°í¸ë²ˆí˜¸ ìë™ê²€ìƒ‰ íŒì—… ì˜¤í”ˆ
      var ocrBaseAddr = document.getElementById('regAddr1').value;
      if (ocrBaseAddr) {
        setTimeout(function() {
          searchPostcodeByAddress(ocrBaseAddr, 'regZipcode', 'regAddr1');
        }, 500);
      }

      // ë³€ê²½ ì´ë ¥ ê¸°ë¡
      if (changes.length > 0) {
        var now = new Date().toISOString().slice(0,16).replace('T',' ');
        var detail = changes.map(function(c) { return 'ã€'+c.field+'ã€‘ "'+(c.from||'(ì—†ìŒ)')+'" â†’ "'+c.to+'"'; }).join(', ');
        changeLog.push({ date: now, who: 'ì‹œìŠ¤í…œ (ì‚¬ì—…ìë“±ë¡ì¦ OCR)', detail: 'ì‚¬ì—…ìë“±ë¡ì¦ ì¸ì‹ì— ì˜í•´ ì…ë ¥ë¨ â€” ' + detail });
        renderChangeLog(changeLog);
      }

      // ===== OCR ê²°ê³¼ Firebase ì €ì¥ìš© ë°ì´í„° ë³´ê´€ =====
      _bizLicOcrResult = {
        type: 'bizLicense',
        fileName: _bizLicFile.name,
        ocrAt: new Date().toISOString(),
        data: {
          companyName: companyName || '',
          repName: repName || '',
          bizNo: bizNo || '',
          corpNo: corpNo || '',
          taxType: taxType || '',
          bizType: bizType || '',
          bizItem: bizItem || '',
          address: addr || '',
          isCorp: isCorp
        }
      };
      console.log('[OCR] ì‚¬ì—…ìë“±ë¡ì¦ ê²°ê³¼ ë³´ê´€ ì™„ë£Œ:', _bizLicOcrResult);

      statusEl.textContent = 'âœ… OCR ì¸ì‹ ì™„ë£Œ! í•„ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
      statusEl.style.color = '#2e7d32';
    } else {
      statusEl.textContent = 'âš ï¸ OCR ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      statusEl.style.color = '#e65100';
    }
    document.getElementById('bizLicOcrBtn').disabled = false;
  }).catch(function(err) {
    statusEl.textContent = 'âŒ OCR ì‹¤íŒ¨: ' + err.message;
    statusEl.style.color = '#c62828';
    document.getElementById('bizLicOcrBtn').disabled = false;
  });
}

/* ===== ì¸í—ˆê°€ OCR ===== */
function handleLicFile(idx, file) {
  if (!file) return;
  _licFiles[idx] = file;
  document.getElementById('licFileName_' + idx).textContent = 'ğŸ“ ' + file.name;
  document.getElementById('licOcrBtn_' + idx).disabled = false;
}

function runLicOCR(idx) {
  var file = _licFiles[idx];
  if (!file) return;
  var statusEl = document.getElementById('licOcrStatus_' + idx);
  statusEl.style.display = 'block';
  statusEl.textContent = 'â³ ì¸í—ˆê°€ OCR ì¸ì‹ ì¤‘...';
  document.getElementById('licOcrBtn_' + idx).disabled = true;

  fileToBase64(file).then(function(b64) {
    var fmt = file.name.split('.').pop().toLowerCase();
    if (fmt === 'pdf') fmt = 'pdf'; else if (fmt === 'png') fmt = 'png'; else fmt = 'jpg';
    var payload = {
      version: 'V2', requestId: 'bfl-lic-' + Date.now(), timestamp: Date.now(),
      images: [{ format: fmt, name: file.name, data: b64 }]
    };
    return fetch(OCR_BIZ_LICENSE_URL, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
  }).then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.images && data.images[0] && data.images[0].bizLicense && data.images[0].bizLicense.result) {
      var res = data.images[0].bizLicense.result;
      var getText = function(arr) { return (arr && arr[0] && arr[0].text) ? arr[0].text.trim() : ''; };
      var repName = getText(res.repName);
      var bizName = getText(res.companyName) || getText(res.corpName);
      var licNo = getText(res.registerNumber) || getText(res.bisRegistrationNumber);
      var addr = (res.bisAddress && res.bisAddress[0]) ? res.bisAddress[0].text.trim() : '';

      var licChanges = [];
      function setLicField(id, label, val) {
        if (!val) return;
        var el = document.getElementById(id);
        if (!el) return;
        var oldVal = el.value || '';
        el.value = val;
        if (oldVal !== val) licChanges.push({ field: label, from: oldVal, to: val });
      }
      setLicField('licRepName_' + idx, 'ì¸í—ˆê°€ ëŒ€í‘œì', repName);
      setLicField('licBizName_' + idx, 'ì˜ì—…ì†Œëª…ì¹­', bizName);
      setLicField('licNo_' + idx, 'ì¸í—ˆê°€ë²ˆí˜¸', licNo);

      // ===== ì˜ì—…ì˜ í˜•íƒœ ìë™ ë§¤í•‘ =====
      var getUniqueText = function(arr) {
        if (!arr || !arr.length) return '';
        var seen = {}, result = [];
        arr.forEach(function(item) {
          var t = (item.text || '').trim();
          if (t && !seen[t]) { seen[t] = true; result.push(t); }
        });
        return result.join(', ');
      };
      var bizForm = getUniqueText(res.bisType) || getUniqueText(res.bisItem);
      if (bizForm) {
        var sel = document.getElementById('licBizForm_' + idx);
        if (sel) {
          var matched = false;
          var normalize = function(s) { return s.replace(/[Â·\s\-Â·â€§ãƒ»]/g, ''); };
          var normBiz = normalize(bizForm);
          for (var j = 0; j < sel.options.length; j++) {
            var normOpt = normalize(sel.options[j].text);
            if (normOpt && (normOpt.includes(normBiz) || normBiz.includes(normOpt))) {
              sel.selectedIndex = j;
              matched = true;
              break;
            }
          }
          if (!matched) {
            var opt = document.createElement('option');
            opt.value = bizForm;
            opt.textContent = bizForm + ' (OCR)';
            opt.selected = true;
            sel.appendChild(opt);
          }
          licChanges.push({ field: 'ì˜ì—…ì˜ í˜•íƒœ', from: '(ì—†ìŒ)', to: matched ? sel.options[sel.selectedIndex].text : bizForm });
        }
      }

      // ===== ë¶„ì•¼ ìë™ ì„¤ì •: ì¶•ì‚° í‚¤ì›Œë“œ â†’ 'ì¶•ì‚°', ë‚˜ë¨¸ì§€ â†’ 'ì‹í’ˆ' (OCR ì‹œ í•­ìƒ ì¬íŒë³„) =====
      var allText = [bizForm || '', bizName || '', getText(res.documentType)].join(' ');
      var fieldSel = document.getElementById('licField_' + idx);
      if (fieldSel) {
        var oldField = fieldSel.value || '';
        var isLivestock = /ì¶•ì‚°ë¬¼?ìœ„ìƒ|ì¶•ì‚°ë¬¼?ê°€ê³µ|ì‹ìœ¡|ë„ì¶•|ì‹ìš©ë€|ìœ ê°€ê³µ|ìš°ìœ |ë‚™ë†|ì§‘ìœ |ì¶•ì‚°/.test(allText);
        for (var k = 0; k < fieldSel.options.length; k++) {
          if ((isLivestock && fieldSel.options[k].value === 'ì¶•ì‚°') ||
              (!isLivestock && fieldSel.options[k].value === 'ì‹í’ˆ')) {
            fieldSel.selectedIndex = k;
            break;
          }
        }
        var newField = isLivestock ? 'ì¶•ì‚°' : 'ì‹í’ˆ';
        if (oldField !== newField) licChanges.push({ field: 'ë¶„ì•¼', from: oldField || '(ì—†ìŒ)', to: newField });
        // ê·¼ê±°ë²• ë°°ì§€ ì—…ë°ì´íŠ¸
        if (typeof updateBizTypeOptions === 'function') updateBizTypeOptions(fieldSel);
      }

      // ì£¼ì†Œ íŒŒì‹±: ì‰¼í‘œ(,) ê¸°ì¤€ìœ¼ë¡œ ê¸°ë³¸ì£¼ì†Œ/ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬ (bisAddress=ì†Œì¬ì§€ë§Œ, headAddress=ë²•ì¸ì£¼ì†Œ ì œì™¸)
      if (addr) {
        var commaIdx = addr.indexOf(',');
        var baseAddr = addr, detailAddr = '';
        if (commaIdx > -1) {
          baseAddr = addr.substring(0, commaIdx).trim();
          detailAddr = addr.substring(commaIdx + 1).trim();
        }
        // ê¸°ë³¸ì£¼ì†Œ readonly í•´ì œ â†’ ê°’ ì…ë ¥ â†’ ë‹¤ì‹œ readonly
        var addrEl = document.getElementById('licAddr_' + idx);
        if (addrEl) {
          var oldBase = addrEl.value || '';
          addrEl.removeAttribute('readonly'); addrEl.value = baseAddr; addrEl.setAttribute('readonly', 'readonly');
          if (oldBase !== baseAddr) licChanges.push({ field: 'ì†Œì¬ì§€(ê¸°ë³¸ì£¼ì†Œ)', from: oldBase, to: baseAddr });
        }
        // ìƒì„¸ì£¼ì†Œ
        if (detailAddr) {
          setLicField('licAddrDetail_' + idx, 'ì†Œì¬ì§€(ìƒì„¸ì£¼ì†Œ)', detailAddr);
        }
      }

      // OCR ì¸í—ˆê°€ ì£¼ì†Œ ê¸°ë°˜ ìš°í¸ë²ˆí˜¸ ìë™ê²€ìƒ‰ íŒì—… ì˜¤í”ˆ
      var ocrLicAddr = document.getElementById('licAddr_' + idx) ? document.getElementById('licAddr_' + idx).value : '';
      if (ocrLicAddr) {
        setTimeout(function() {
          searchPostcodeByAddress(ocrLicAddr, 'licZipcode_' + idx, 'licAddr_' + idx);
        }, 500);
      }

      // ===== OCR ê²°ê³¼ Firebase ì €ì¥ìš© ë°ì´í„° ë³´ê´€ =====
      var fieldVal = document.getElementById('licField_' + idx) ? document.getElementById('licField_' + idx).value : '';
      _licOcrResults[idx] = {
        type: 'permit',
        licenseIndex: idx,
        fileName: file.name,
        ocrAt: new Date().toISOString(),
        data: {
          repName: repName || '',
          bizName: bizName || '',
          licNo: licNo || '',
          bizForm: bizForm || '',
          field: fieldVal || '',
          address: addr || ''
        }
      };
      console.log('[OCR] ì¸í—ˆê°€ ' + idx + ' ê²°ê³¼ ë³´ê´€ ì™„ë£Œ:', _licOcrResults[idx]);

      // ë³€ê²½ ì´ë ¥ ê¸°ë¡
      if (licChanges.length > 0) {
        var now = new Date().toISOString().slice(0,16).replace('T',' ');
        var detail = licChanges.map(function(c) { return 'ã€'+c.field+'ã€‘ "'+(c.from||'(ì—†ìŒ)')+'" â†’ "'+c.to+'"'; }).join(', ');
        changeLog.push({ date: now, who: 'ì‹œìŠ¤í…œ (ì¸í—ˆê°€ë¬¸ì„œ OCR)', detail: 'ì¸í—ˆê°€ë¬¸ì„œ ì¸ì‹ì— ì˜í•´ ì…ë ¥ë¨ â€” ' + detail });
        renderChangeLog(changeLog);
      }

      statusEl.textContent = 'âœ… ì¸í—ˆê°€ OCR ì™„ë£Œ!';
      statusEl.style.color = '#2e7d32';
    } else {
      statusEl.textContent = 'âš ï¸ ì¸ì‹ ê²°ê³¼ ì—†ìŒ';
      statusEl.style.color = '#e65100';
    }
    document.getElementById('licOcrBtn_' + idx).disabled = false;
  }).catch(function(err) {
    statusEl.textContent = 'âŒ ì‹¤íŒ¨: ' + err.message;
    statusEl.style.color = '#c62828';
    document.getElementById('licOcrBtn_' + idx).disabled = false;
  });
}

/* ===== íŒŒì¼â†’Base64 ë³€í™˜ ===== */
function fileToBase64(file) {
  if (file.type === 'application/pdf' && window.pdfjsLib) {
    return file.arrayBuffer().then(function(buf) {
      return pdfjsLib.getDocument({ data: buf }).promise;
    }).then(function(pdf) {
      return pdf.getPage(1);
    }).then(function(page) {
      var vp = page.getViewport({ scale: 2 });
      var canvas = document.createElement('canvas');
      canvas.width = vp.width; canvas.height = vp.height;
      return page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise.then(function() {
        return canvas.toDataURL('image/jpeg', 0.92).split(',')[1];
      });
    });
  }
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function() { resolve(reader.result.split(',')[1]); };
    reader.readAsDataURL(file);
  });
}

/* ===== ì¸í—ˆê°€ ì¶”ê°€/ì‚­ì œ ===== */
let licenseCount = 1;
function addLicense() {
  licenseCount++;
  const idx = licenseCount;
  const html = `
    <div class="sub-card" id="license-${idx}">
      <div class="sub-card-header">
        <div class="sub-card-title"><span class="sub-card-num">${idx}</span> ì¸í—ˆê°€</div>
        <button class="btn-remove" onclick="removeLicense(${idx})" title="ì‚­ì œ">Ã—</button>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>ë¶„ì•¼ <span class="req">*</span></label><select id="licField_${idx}" onchange="updateBizTypeOptions(this)"><option value="">ì„ íƒ</option><option value="ì‹í’ˆ">ì‹í’ˆ</option><option value="ì¶•ì‚°">ì¶•ì‚°</option></select></div>
        <div class="form-group"><label>ì˜ì—…ì˜ í˜•íƒœ <span class="req">*</span></label><div class="combo-input"><select id="licBizForm_${idx}" onchange="toggleCustomInput(this)"><option value="">ì„ íƒ</option><optgroup label="ì‹í’ˆ"><option>ì‹í’ˆì œì¡°ê°€ê³µì—…</option><option>ì¦‰ì„íŒë§¤ì œì¡°ê°€ê³µì—…</option><option>ì‹í’ˆì†Œë¶„ì—…</option><option>ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì‹í’ˆìš´ë°˜ì—…</option><option>ì‹í’ˆëƒ‰ë™ëƒ‰ì¥ì—…</option></optgroup><optgroup label="ì¶•ì‚°"><option>ì¶•ì‚°ë¬¼ê°€ê³µì—…</option><option>ì‹ìœ¡í¬ì¥ì²˜ë¦¬ì—…</option><option>ì¶•ì‚°ë¬¼ìœ í†µì „ë¬¸íŒë§¤ì—…</option><option>ì¶•ì‚°ë¬¼ìš´ë°˜ì—…</option><option>ì¶•ì‚°ë¬¼ë³´ê´€ì—…</option></optgroup><option value="ì§ì ‘ì…ë ¥">âœï¸ ì§ì ‘ ì…ë ¥</option></select><input type="text" class="hidden" placeholder="ì˜ì—…ì˜ í˜•íƒœ ì§ì ‘ ì…ë ¥" /></div></div>
        <div class="form-group"><label>ëŒ€í‘œì <span class="req">*</span></label><input type="text" id="licRepName_${idx}" placeholder="ì¸í—ˆê°€ ëŒ€í‘œì" /></div>
        <div class="form-group"><label>ì¸í—ˆê°€ë²ˆí˜¸ <span class="req">*</span></label><input type="text" id="licNo_${idx}" placeholder="ì¸í—ˆê°€ë²ˆí˜¸ ì…ë ¥" /></div>
        <div class="form-group"><label>ì˜ì—…ì†Œëª…ì¹­ <span class="req">*</span></label><input type="text" id="licBizName_${idx}" placeholder="ì˜ì—…ì†Œ ëª…ì¹­" /></div>
        <div class="form-group form-full"><label>ì†Œì¬ì§€ <span class="req">*</span></label><div class="address-row" style="margin-bottom:6px"><input type="text" id="licZipcode_${idx}" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:120px;" readonly /><button type="button" class="btn-address" onclick="openLicPostcode(${idx})">ğŸ” ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button></div><input type="text" id="licAddr_${idx}" placeholder="ê¸°ë³¸ì£¼ì†Œ (ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ì‹œ ìë™ì…ë ¥)" readonly style="margin-bottom:6px" /><input type="text" id="licAddrDetail_${idx}" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥" /></div>
        <div class="form-group form-full"><label>ì¸í—ˆê°€ ë¬¸ì„œ ì²¨ë¶€</label><div style="display:flex;gap:8px;align-items:center"><div class="file-area" id="licFileArea_${idx}" style="flex:1;padding:10px" onclick="document.getElementById('licFileInput_${idx}').click()" ondragover="event.preventDefault();this.style.borderColor='#1a73e8'" ondragleave="this.style.borderColor='#e2e6ed'" ondrop="event.preventDefault();this.style.borderColor='#e2e6ed';handleLicFile(${idx},event.dataTransfer.files[0])"><input type="file" id="licFileInput_${idx}" accept="image/*,.pdf" style="display:none" onchange="handleLicFile(${idx},this.files[0])"><span id="licFileName_${idx}">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸</span></div><button class="btn-check" id="licOcrBtn_${idx}" onclick="runLicOCR(${idx})" disabled style="white-space:nowrap">ğŸ¤– OCR ì¸ì‹</button></div><div id="licOcrStatus_${idx}" style="margin-top:4px;font-size:11px;color:#1565c0;display:none"></div></div>
      </div>
      <div id="licLawBadge_${idx}" class="law-badge" style="display:none"></div>
    </div>`;
  document.getElementById('licenseList').insertAdjacentHTML('beforeend', html);
}
function removeLicense(id) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) document.getElementById('license-'+id).remove(); }

/* ===== HTML ì´ìŠ¤ì¼€ì´í”„ ìœ í‹¸ ===== */
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ===== ìì‚¬ ë‹´ë‹¹ì ë°ì´í„° (ê´€ë¦¬ì > ì‚¬ìš©ìê´€ë¦¬ USERS_DATA + localStorage ì—°ë™) ===== */
var USERS_DATA = [
  {"ë¶€ì„œëª…":"ì„ì›","ì•„ì´ë””":"ì´ìš©í‘œ","ì§ê¸‰":"ëŒ€í‘œì´ì‚¬"},
  {"ë¶€ì„œëª…":"ê´€ë¦¬íŒ€","ì•„ì´ë””":"ê¹€ì˜ê¸°","ì§ê¸‰":"ë¶€ì¥"},
  {"ë¶€ì„œëª…":"ê³ ê°ì§€ì›íŒ€","ì•„ì´ë””":"í—ˆí˜„ë¯¸","ì§ê¸‰":"ë¶€ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ì§€ì˜","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ë¬¸ìœ ì§„","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ìœ¤ì •í•œ","ì§ê¸‰":"ì°¨ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì†ìœ¤ì£¼","ì§ê¸‰":"ë¶€ì¥"},
  {"ë¶€ì„œëª…":"í’ˆì§ˆë³´ì¦íŒ€","ì•„ì´ë””":"ê¹€ì£¼í˜„","ì§ê¸‰":"ë¶€ì¥"},
  {"ë¶€ì„œëª…":"ê³ ê°ì§€ì›íŒ€","ì•„ì´ë””":"ì´ì€ê²½","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ê³ ê°ì§€ì›íŒ€","ì•„ì´ë””":"ê¹€ìˆ˜ì •","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ê³ ê°ê´€ë¦¬","ì•„ì´ë””":"ê¹€í¬ì„±","ì§ê¸‰":"ë¶€ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ìµœì£¼ë¦¬","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ì§€ì€","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ì‚¬ë¼","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ë¬¸íƒœì„±","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì„œì„¸ì§„","ì§ê¸‰":"ì°¨ì¥"},
  {"ë¶€ì„œëª…":"ê³ ê°ì§€ì›íŒ€","ì•„ì´ë””":"ë°•ì‹ ì˜","ì§ê¸‰":"ì°¨ì¥"},
  {"ë¶€ì„œëª…":"í’ˆì§ˆë³´ì¦íŒ€","ì•„ì´ë””":"ê¹€ë¯¼ê·œ","ì§ê¸‰":"ì°¨ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì¥ë¯¼ê²½","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ë¯¼ì˜","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì´ì¢…í›ˆ","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ê²½ì˜ì§€ì›ì‹¤","ì•„ì´ë””":"ê¹€ì„±í˜¸","ì§ê¸‰":"ì „ë¬´ì´ì‚¬"},
  {"ë¶€ì„œëª…":"ê²½ì˜ì§€ì›ì‹¤","ì•„ì´ë””":"ê¹€ìœ ë¹ˆ","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€","ì•„ì´ë””":"ì¡°í˜„ì •","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ê³ ê°ê´€ë¦¬","ì•„ì´ë””":"ì¡°ë´‰í˜„","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€","ì•„ì´ë””":"ì´ìŠ¬ê¸°","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ê³ ê°ê´€ë¦¬","ì•„ì´ë””":"ì—„ìƒí ","ì§ê¸‰":"ë¶€ì¥"},
  {"ë¶€ì„œëª…":"ê³ ê°ì§€ì›íŒ€","ì•„ì´ë””":"ë¥˜í•˜ëŠ˜","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì´ì§„ì•„","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì§„ë¯¸ì •","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ì„ í™”","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ê³ ê°ê´€ë¦¬","ì•„ì´ë””":"ì˜¤ì„¸ì¤‘","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì—¼í•˜ë¦¼","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ë°±ì§€ì—°","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ë°•ì§€ìˆ˜","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì†¡ì§€ì€","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ê³ ê°ê´€ë¦¬","ì•„ì´ë””":"ì¥ë™ì£¼","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì‹ ê²½ì„","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"í’ˆì§ˆë³´ì¦íŒ€","ì•„ì´ë””":"ê¹€ì •í•œ","ì§ê¸‰":"ì°¨ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€í˜„ì •","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì„œì§„ì˜","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ê³ ê°ì§€ì›íŒ€","ì•„ì´ë””":"ì´ì§„í¬","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ê³ ê°ê´€ë¦¬","ì•„ì´ë””":"ì˜¤ì„í˜„","ì§ê¸‰":"ì£¼ì„"},
  {"ë¶€ì„œëª…":"ê²½ì˜ì§€ì›ì‹¤","ì•„ì´ë””":"ì´ì£¼í•˜","ì§ê¸‰":"ì°¨ì¥"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ë°•ì‹œì€","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì•ˆì¤€ì´","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"í’ˆì§ˆë³´ì¦íŒ€","ì•„ì´ë””":"ê°•ì€ì• ","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"í•˜ì£¼ì‹ ","ì§ê¸‰":"ê³¼ì¥"},
  {"ë¶€ì„œëª…":"ë§ˆì¼€íŒ…íŒ€","ì•„ì´ë””":"ê¹€ë„í¬","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"íƒœí˜ì§„","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ê³ ì€","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ë²”ì¤€","ì§ê¸‰":"ëŒ€ë¦¬"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¶Œí˜œì›","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ë§ˆì¼€íŒ…íŒ€","ì•„ì´ë””":"ì†¡ì„±í˜„","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ê¹€ë¬¸ê¸°","ì§ê¸‰":"ì‚¬ì›"},
  {"ë¶€ì„œëª…":"ì‹í’ˆì¶•ì‚°ë¶„ì„ì‹¤","ì•„ì´ë””":"ì§€í˜„ì •","ì§ê¸‰":"ì‚¬ì›"}
];
/* ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ (ê¸°ë³¸ê°’ â†’ Firestore êµì²´) */
function loadSalesUsersDefault() {
  return USERS_DATA.map(function(u) { return Object.assign({ íŒ€ëª…:'', ì ‘ìˆ˜ì:'', ì…ì‚¬ì¼:'', í‡´ì‚¬ì¼:'' }, u); });
}
var SALES_TEAMS = ['ê³ ê°ì§€ì›íŒ€', 'ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€', 'ê³ ê°ê´€ë¦¬', 'ì§€ì‚¬'];
var salesTeamList = SALES_TEAMS;
var _allUsers = loadSalesUsersDefault();
var salesUsersList = _allUsers.filter(function(u) { return SALES_TEAMS.indexOf(u.ë¶€ì„œëª…) !== -1; });

/* Firebase ì¤€ë¹„ í›„ Firestoreì—ì„œ ì‚¬ìš©ì ë¡œë“œ */
window.addEventListener('firebase-ready', async function() {
  try {
    var fsUsers = await fsGetUsers();
    if (fsUsers && fsUsers.length > 0) {
      _allUsers = fsUsers.map(function(u) {
        return { ë¶€ì„œëª…: u.department || u.ë¶€ì„œëª… || '', ì•„ì´ë””: u.name || u.ì•„ì´ë”” || '', ì§ê¸‰: u.position || u.ì§ê¸‰ || '', íŒ€ëª…: u.team || u.íŒ€ëª… || '', ì ‘ìˆ˜ì: u.receiver || u.ì ‘ìˆ˜ì || '', ì…ì‚¬ì¼: u.joinDate || u.ì…ì‚¬ì¼ || '', í‡´ì‚¬ì¼: u.leaveDate || u.í‡´ì‚¬ì¼ || '' };
      });
      salesUsersList = _allUsers.filter(function(u) { return SALES_TEAMS.indexOf(u.ë¶€ì„œëª…) !== -1; });
      // ë‹´ë‹¹ì ì…€ë ‰íŠ¸ ê°±ì‹ 
      for (var i = 1; i <= contactCount; i++) {
        if (document.getElementById('cTeam' + i)) filterRepByTeam(i);
      }
      console.log('[companyRegForm] Firestore ì‚¬ìš©ì ' + _allUsers.length + 'ëª… ë¡œë“œ');
    }
  } catch(e) { console.warn('Firestore ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨:', e.message); }
});
/* ë¶€ì„œ <option> HTML ìƒì„± ìœ í‹¸ */
function buildTeamOptions() {
  return salesTeamList.map(function(t) { return '<option value="' + escHtml(t) + '">' + escHtml(t) + '</option>'; }).join('');
}

function filterRepByTeam(n) {
  var teamSel = document.getElementById('cTeam' + n);
  var repSel  = document.getElementById('cRep' + n);
  var badgeEl = document.getElementById('cRepBadge' + n);
  if (!teamSel || !repSel) return;
  var team = teamSel.value;
  repSel.innerHTML = '<option value="">ì ‘ìˆ˜ì(ë‹´ë‹¹ì) ì„ íƒ</option>';
  if (badgeEl) badgeEl.innerHTML = '';
  /* ì ‘ìˆ˜ì í•„ë“œê°€ ìˆëŠ” ì‚¬ìš©ìë§Œ â†’ ì ‘ìˆ˜ì ê³ ìœ ê°’ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ìƒì„± */
  var list = team ? salesUsersList.filter(function(u) { return u.ë¶€ì„œëª… === team; }) : salesUsersList;
  var hasReceiver = list.filter(function(u) { return u.ì ‘ìˆ˜ì && u.ì ‘ìˆ˜ì.trim(); });
  var seen = {};
  hasReceiver.forEach(function(u) {
    var rv = u.ì ‘ìˆ˜ì.trim();
    if (seen[rv]) return;
    seen[rv] = true;
    var opt = document.createElement('option');
    opt.value = rv;
    opt.textContent = rv + ' (' + u.ë¶€ì„œëª… + ')';
    repSel.appendChild(opt);
  });
}
function updateRepBadge(n) {
  var repSel  = document.getElementById('cRep' + n);
  var teamSel = document.getElementById('cTeam' + n);
  var badgeEl = document.getElementById('cRepBadge' + n);
  if (!repSel || !badgeEl) return;
  if (repSel.value) {
    var rv = repSel.value;
    /* ì ‘ìˆ˜ì ê°’ìœ¼ë¡œ í•´ë‹¹ ì‚¬ìš©ì ì°¾ê¸° (ë¶€ì„œ ì •ë³´ í‘œì‹œìš©) */
    var info = salesUsersList.find(function(u) { return u.ì ‘ìˆ˜ì && u.ì ‘ìˆ˜ì.trim() === rv; });
    var teamLabel = info ? info.ë¶€ì„œëª… : (teamSel ? teamSel.value : '');
    badgeEl.innerHTML = '<span class="rep-badge">ğŸ¢ ' + escHtml(teamLabel) + ' Â· ' + escHtml(rv) + '</span>';
  } else { badgeEl.innerHTML = ''; }
}

/* ===== ë‹´ë‹¹ì ì¶”ê°€/ì‚­ì œ ===== */
let contactCount = 1;
function addContact() {
  contactCount++;
  var n = contactCount;
  var html =
    '<div class="sub-card" id="contact-' + n + '">' +
      '<div class="sub-card-header">' +
        '<div class="sub-card-title"><span class="sub-card-num">' + n + '</span> ë‹´ë‹¹ì</div>' +
        '<div style="display:flex;gap:4px;align-items:center">' +
          '<button class="btn-remove" onclick="removeContact(' + n + ')">Ã—</button>' +
        '</div>' +
      '</div>' +
      '<div class="form-grid">' +
        '<div class="form-group"><label>ì—…ì²´ëª…</label><input type="text" id="cCompany' + n + '" placeholder="í´ë¦­í•˜ì—¬ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥" onclick="openCompanySelectModal(' + n + ')" readonly style="cursor:pointer;background:#fafbfc" /><input type="text" id="cCompanyCustom' + n + '" placeholder="ì—…ì²´ëª… ì§ì ‘ ì…ë ¥" style="display:none;margin-top:4px" /></div>' +
        '<div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="cDept' + n + '" placeholder="ë¶€ì„œëª…" /></div>' +
      '</div>' +
      '<div class="form-grid-3" style="margin-top:8px">' +
        '<div class="form-group"><label>ë‹´ë‹¹ì(ì´ë¦„) <span class="req">*</span></label><input type="text" id="cName' + n + '" placeholder="ë‹´ë‹¹ì ì´ë¦„" /></div>' +
        '<div class="form-group"><label>ì „í™”ë²ˆí˜¸ <span class="req">*</span></label><input type="text" id="cPhone' + n + '" placeholder="010-0000-0000" oninput="formatPhone(this)" /></div>' +
        '<div class="form-group"><label>ì´ë©”ì¼ <span class="req">*</span></label><input type="email" id="cEmail' + n + '" placeholder="email@example.com" /></div>' +
      '</div>' +
      '<div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap"><button class="btn-check" onclick="showToastMsg(\'âœ… ì¤‘ë³µ ì—†ìŒ â€” ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥\')">ğŸ” ì¤‘ë³µ í™•ì¸</button><div class="check-result" id="contactCheckResult' + n + '" style="display:none"></div></div>' +
      '<div class="sales-rep-row">' +
        '<span class="rep-label">ìì‚¬ ë‹´ë‹¹ì ì—°ê²°:</span>' +
        '<select id="cTeam' + n + '" onchange="filterRepByTeam(' + n + ')"><option value="">ë¶€ì„œ(íŒ€) ì„ íƒ</option>' + buildTeamOptions() + '</select>' +
        '<select id="cRep' + n + '" onchange="updateRepBadge(' + n + ')"><option value="">ì ‘ìˆ˜ì(ë‹´ë‹¹ì) ì„ íƒ</option></select>' +
        '<span id="cRepBadge' + n + '"></span>' +
      '</div>' +
      '<div id="contactLicTags_' + n + '" class="lic-tags-area"></div>' +
      '<input type="hidden" id="contactLicNums_' + n + '" value="" />' +
    '</div>';
  document.getElementById('contactList').insertAdjacentHTML('beforeend', html);
  filterRepByTeam(n);  // ì ‘ìˆ˜ì ì „ì²´ ëª©ë¡ ë¡œë“œ
}
function removeContact(id) { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) document.getElementById('contact-'+id).remove(); }

/* ===== ì¸í—ˆê°€ ë‹´ë‹¹ì ë§¤ì¹­ ===== */
var _licMatchContactNum = null;
function openLicMatchModal(contactNum) {
  _licMatchContactNum = contactNum;
  var modal = document.getElementById('licContactMatchModal');
  if (!modal) return;
  var contactName = (document.getElementById('cName' + contactNum) || {}).value || 'ë‹´ë‹¹ì ' + contactNum;
  document.getElementById('licMatchDesc').innerHTML =
    '<strong>' + escHtml(contactName) + '</strong> ë‹˜ì„ ì–´ë–¤ ì¸í—ˆê°€ì˜ ë‹´ë‹¹ìë¡œ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
  var listEl = document.getElementById('licMatchList');
  listEl.innerHTML = '';
  var currentMatched = [];
  var hiddenEl = document.getElementById('contactLicNums_' + contactNum);
  if (hiddenEl && hiddenEl.value) { try { currentMatched = JSON.parse(hiddenEl.value); } catch(e) {} }
  var found = 0;
  for (var li = 1; li <= licenseCount; li++) {
    if (!document.getElementById('license-' + li)) continue;
    var bizName = (document.getElementById('licBizName_' + li) || {}).value || '';
    var licField = (document.getElementById('licField_' + li) || {}).value || '';
    var licNo = (document.getElementById('licNo_' + li) || {}).value || '';
    var label = bizName || ('ì¸í—ˆê°€ ' + li);
    var subLabel = (licField ? licField : '') + (licNo ? ' Â· ' + licNo : '');
    var checked = currentMatched.indexOf(li) !== -1 ? ' checked' : '';
    var item = document.createElement('label');
    item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e2e6ed;border-radius:8px;margin-bottom:6px;cursor:pointer';
    item.innerHTML =
      '<input type="checkbox" class="lic-match-chk" value="' + li + '"' + checked + ' style="width:18px;height:18px;accent-color:#43a047">' +
      '<div style="flex:1"><div style="font-weight:600;font-size:13px">' + escHtml(label) + '</div>' +
      '<div style="font-size:11px;color:#8892a4">' + escHtml(subLabel) + '</div></div>';
    listEl.appendChild(item);
    found++;
  }
  if (found === 0) {
    listEl.innerHTML = '<div style="text-align:center;color:#8892a4;padding:16px">ë“±ë¡ëœ ì¸í—ˆê°€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € ì¸í—ˆê°€ ì •ë³´ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.</div>';
  }
  modal.classList.add('show');
}
function closeLicMatchModal() {
  var modal = document.getElementById('licContactMatchModal');
  if (modal) modal.classList.remove('show');
  _licMatchContactNum = null;
}
function applyLicMatch() {
  var num = _licMatchContactNum;
  if (!num) return;
  var checkedNums = [];
  document.querySelectorAll('#licMatchList .lic-match-chk:checked').forEach(function(chk) {
    checkedNums.push(parseInt(chk.value));
  });
  var hiddenEl = document.getElementById('contactLicNums_' + num);
  if (hiddenEl) hiddenEl.value = JSON.stringify(checkedNums);
  var tagsEl = document.getElementById('contactLicTags_' + num);
  if (tagsEl) {
    tagsEl.innerHTML = '';
    checkedNums.forEach(function(ln) {
      var bizName = (document.getElementById('licBizName_' + ln) || {}).value || '';
      var licField = (document.getElementById('licField_' + ln) || {}).value || '';
      var label = bizName || licField || ('ì¸í—ˆê°€ ' + ln);
      tagsEl.innerHTML += '<span class="lic-match-tag">ğŸ”— ' + escHtml(label) + '</span>';
    });
  }
  closeLicMatchModal();
  var contactName = (document.getElementById('cName' + num) || {}).value || 'ë‹´ë‹¹ì ' + num;
  showToastMsg(checkedNums.length > 0
    ? 'ğŸ”— ' + contactName + ' â†’ ' + checkedNums.length + 'ê°œ ì¸í—ˆê°€ ì—°ê²°'
    : 'â„¹ï¸ ' + contactName + ' ì¸í—ˆê°€ ì—°ê²° í•´ì œ');
}

/* ===== ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì ë³µì‚¬ ===== */
function copyFromContact1() {
  /* ê¸°ë³¸ ì—°ë½ì²˜ë§Œ ë³µì‚¬ (ì´ë¦„, ì „í™”, ì´ë©”ì¼, ë¶€ì„œ)
     â€” ìì‚¬ ë‹´ë‹¹ì ì—°ê²° ì •ë³´(ë¶€ì„œ(íŒ€), ì ‘ìˆ˜ì(ë‹´ë‹¹ì))ëŠ” ì œì™¸ */
  var map = { Name:'Name', Phone:'Phone', Email:'Email', Dept:'Dept' };
  Object.keys(map).forEach(function(f) {
    var src = document.getElementById('c' + f + '1');
    var dst = document.getElementById('tax' + map[f]);
    if (src && dst) dst.value = src.value;
  });
  /* ì—…ì²´ëª… ë³µì‚¬ â€” ì§ì ‘ ì…ë ¥ / ëª¨ë‹¬ ì„ íƒ ëª¨ë“œ ë‘˜ ë‹¤ ì²˜ë¦¬ */
  var srcCompany = document.getElementById('cCompany1');
  var srcCustom  = document.getElementById('cCompanyCustom1');
  var taxCompany = document.getElementById('taxCompany');
  var taxCustom  = document.getElementById('taxCompanyCustom');
  if (srcCustom && srcCustom.style.display !== 'none' && srcCustom.value) {
    // 1ë²ˆ ë‹´ë‹¹ìê°€ ì§ì ‘ ì…ë ¥ ëª¨ë“œ â†’ ì„¸ê¸ˆê³„ì‚°ì„œë„ ì§ì ‘ ì…ë ¥ ëª¨ë“œ
    if (taxCompany) { taxCompany.style.display = 'none'; }
    if (taxCustom) { taxCustom.style.display = 'block'; taxCustom.value = srcCustom.value; }
  } else {
    // 1ë²ˆ ë‹´ë‹¹ìê°€ ëª¨ë‹¬ ì„ íƒ ëª¨ë“œ â†’ ì„¸ê¸ˆê³„ì‚°ì„œë„ ì„ íƒê°’ í‘œì‹œ
    if (taxCompany) { taxCompany.value = srcCompany ? srcCompany.value : ''; taxCompany.style.display = 'block'; }
    if (taxCustom) { taxCustom.style.display = 'none'; taxCustom.value = ''; }
  }
  /* ìì‚¬ ë‹´ë‹¹ì ì—°ê²° ì •ë³´(cTeam1, cRep1)ëŠ” ë³µì‚¬í•˜ì§€ ì•ŠìŒ */
  showToastMsg('ğŸ“‹ 1ë²ˆ ë‹´ë‹¹ì ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ìì‚¬ ë‹´ë‹¹ì ì—°ê²° ì •ë³´ ì œì™¸)');
}

/* ===== ì—…ì²´ëª… ì„ íƒ ëª¨ë‹¬ ===== */
var _companySelectContactNum = null;
function openCompanySelectModal(contactNum) {
  _companySelectContactNum = contactNum;
  var modal = document.getElementById('companySelectModal');
  if (!modal) return;
  var listEl = document.getElementById('companySelectList');
  listEl.innerHTML = '';

  var items = [];
  // 1) ì‚¬ì—…ìë“±ë¡ì¦ íšŒì‚¬ëª…
  var bizCompany = (document.getElementById('companyName') || {}).value || '';
  if (bizCompany.trim()) {
    items.push({ label: bizCompany.trim(), sub: 'ì‚¬ì—…ìë“±ë¡ì¦', type: 'biz' });
  }
  // 2) ì¸í—ˆê°€ë³„ ì˜ì—…ì†Œëª…ì¹­
  for (var li = 1; li <= licenseCount; li++) {
    if (!document.getElementById('license-' + li)) continue;
    var licBizName = (document.getElementById('licBizName_' + li) || {}).value || '';
    var licField = (document.getElementById('licField_' + li) || {}).value || '';
    var licNo = (document.getElementById('licNo_' + li) || {}).value || '';
    if (licBizName.trim()) {
      var sub = 'ì¸í—ˆê°€ ' + li;
      if (licField) sub += ' Â· ' + licField;
      if (licNo) sub += ' Â· ' + licNo;
      // ì¤‘ë³µ ì œê±° (ì‚¬ì—…ìë“±ë¡ì¦ê³¼ ê°™ì€ ì´ë¦„ì´ë©´ ê±´ë„ˆë›°ê¸°)
      var dup = items.some(function(it) { return it.label === licBizName.trim(); });
      if (!dup) items.push({ label: licBizName.trim(), sub: sub, type: 'lic-' + li });
    }
  }

  if (items.length === 0) {
    listEl.innerHTML = '<div style="text-align:center;color:#8892a4;padding:16px;font-size:12px">' +
      'ë“±ë¡ëœ ì—…ì²´ëª…ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì‚¬ì—…ìë“±ë¡ì¦ ë˜ëŠ” ì¸í—ˆê°€ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>';
  } else {
    items.forEach(function(item, idx) {
      var row = document.createElement('label');
      row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #e2e6ed;border-radius:8px;margin-bottom:6px;cursor:pointer';
      row.innerHTML =
        '<input type="radio" name="companySelectRadio" value="' + escHtml(item.label) + '" style="width:18px;height:18px;accent-color:#1a73e8"' + (idx === 0 ? ' checked' : '') + ' />' +
        '<div style="flex:1"><div style="font-weight:600;font-size:13px">' + escHtml(item.label) + '</div>' +
        '<div style="font-size:11px;color:#8892a4">' + escHtml(item.sub) + '</div></div>';
      listEl.appendChild(row);
    });
  }
  modal.classList.add('show');
}

function closeCompanySelectModal() {
  var modal = document.getElementById('companySelectModal');
  if (modal) modal.classList.remove('show');
  _companySelectContactNum = null;
}

function applyCompanySelect() {
  var num = _companySelectContactNum;
  if (!num) return;
  var selected = document.querySelector('input[name="companySelectRadio"]:checked');
  if (!selected) { alert('ì—…ì²´ëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

  var isTax = (num === 'tax');
  var companyInput = document.getElementById(isTax ? 'taxCompany' : 'cCompany' + num);
  var customInput  = document.getElementById(isTax ? 'taxCompanyCustom' : 'cCompanyCustom' + num);

  if (selected.value === '__custom__') {
    // ì§ì ‘ ì…ë ¥ ëª¨ë“œ
    if (companyInput) { companyInput.style.display = 'none'; }
    if (customInput) { customInput.style.display = 'block'; customInput.focus(); }
  } else {
    // ì„ íƒí•œ ì—…ì²´ëª… ì ìš©
    if (companyInput) { companyInput.value = selected.value; companyInput.style.display = 'block'; }
    if (customInput) { customInput.style.display = 'none'; customInput.value = ''; }
  }
  closeCompanySelectModal();
  showToastMsg('ğŸ¢ ì—…ì²´ëª…ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* ===== ì¤‘ë³µ í™•ì¸ ë°ëª¨ ===== */
function checkCompanyDup() {
  const name = document.getElementById('companyName').value.trim();
  if (!name) { alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  if (name.includes('í’€ë¬´ì›')) {
    document.getElementById('companyDupPopup').classList.add('show');
  } else {
    const el = document.getElementById('companyCheckResult');
    el.style.display = 'block';
    el.className = 'check-result check-ok';
    el.textContent = 'âœ… ì¤‘ë³µ ì—†ìŒ â€” ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
  }
}
function checkBizDup() {
  const biz = document.getElementById('bizNo').value.trim();
  if (!biz) { alert('ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  if (biz === '234-56-78901') {
    const el = document.getElementById('bizCheckResult');
    el.style.display = 'block'; el.className = 'check-result check-dup';
    el.textContent = 'âš ï¸ ì´ë¯¸ ë“±ë¡ëœ ì‚¬ì—…ìë²ˆí˜¸ì…ë‹ˆë‹¤. (í’€ë¬´ì›ì‹í’ˆ(ì£¼) / ë‹´ë‹¹: ë°•ì£¼ì„)';
  } else {
    const el = document.getElementById('bizCheckResult');
    el.style.display = 'block'; el.className = 'check-result check-ok';
    el.textContent = 'âœ… ì¤‘ë³µ ì—†ìŒ.';
  }
}
function checkContactDup() {
  const name = document.getElementById('cName1').value.trim();
  const phone = document.getElementById('cPhone1').value.trim();
  if (!name || !phone) { alert('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  if (name === 'ì´ê·œì„±') {
    document.getElementById('contactDupPopup').classList.add('show');
  } else {
    const el = document.getElementById('contactCheckResult1');
    el.style.display = 'inline-block'; el.className = 'check-result check-ok';
    el.textContent = 'âœ… ì¤‘ë³µ ì—†ìŒ â€” ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥';
  }
}
function closeDup(id) { document.getElementById(id).classList.remove('show'); }

/* ===== ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ (ì‚¬ì—…ì¥ ì£¼ì†Œ) ===== */
function openPostcodeSearch() {
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById('regZipcode').value = data.zonecode;
      document.getElementById('regAddr1').value = data.roadAddress || data.jibunAddress;
    }
  }).open();
}

/* ===== ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ (ì¸í—ˆê°€ ì†Œì¬ì§€) ===== */
function openLicPostcode(idx) {
  new daum.Postcode({
    oncomplete: function(data) {
      var zipEl = document.getElementById('licZipcode_' + idx);
      var addrEl = document.getElementById('licAddr_' + idx);
      if (zipEl) zipEl.value = data.zonecode;
      if (addrEl) addrEl.value = data.roadAddress || data.jibunAddress;
    }
  }).open();
}

/* ===== OCR í›„ ìš°í¸ë²ˆí˜¸ ìë™ì¡°íšŒ (Kakao REST API) ===== */
function searchPostcodeByAddress(baseAddr, zipcodeId, addrId) {
  if (!baseAddr || !baseAddr.trim()) return;
  var cleanAddr = baseAddr.replace(/\([^)]*\)/g, '').trim();
  var apiKey = '8e5dab09aacd882449bd3865699a9d69';
  fetch('https://dapi.kakao.com/v2/local/search/address.json?query=' + encodeURIComponent(cleanAddr), {
    headers: { 'Authorization': 'KakaoAK ' + apiKey }
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.documents && data.documents.length > 0) {
      var doc = data.documents[0];
      var roadAddr = doc.road_address;
      var zipEl = document.getElementById(zipcodeId);
      var addrEl = document.getElementById(addrId);
      if (roadAddr && roadAddr.zone_no) {
        if (zipEl) zipEl.value = roadAddr.zone_no;
        if (addrEl) { addrEl.removeAttribute('readonly'); addrEl.value = roadAddr.address_name; addrEl.setAttribute('readonly','readonly'); }
        highlightField(zipcodeId);
        highlightField(addrId);
      } else if (doc.address && doc.address.address_name) {
        if (addrEl) { addrEl.removeAttribute('readonly'); addrEl.value = doc.address.address_name; addrEl.setAttribute('readonly','readonly'); }
        highlightField(addrId);
      }
    }
  })
  .catch(function(e) { console.log('ìš°í¸ë²ˆí˜¸ ìë™ì¡°íšŒ ì‹¤íŒ¨:', e); });
}

function highlightField(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.style.background = '#e8f5e9';
  el.style.borderColor = '#66bb6a';
  setTimeout(function() { el.style.background = ''; el.style.borderColor = ''; }, 5000);
}

/* ===== ì˜ë¬¸ ì„¹ì…˜ í† ê¸€ ===== */
function toggleEngSection(id) {
  var sec = document.getElementById(id);
  if (!sec) return;
  var isHidden = sec.style.display === 'none';
  sec.style.display = isHidden ? 'block' : 'none';
  var arrowId = id.replace('Section', 'Arrow').replace('biz', 'biz').replace('lic', 'lic');
  var arrow = document.getElementById(arrowId);
  if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : '';
}

/* ===== í¬ë§· ===== */
function formatBizNo(el) {
  let v = el.value.replace(/[^0-9]/g,'');
  if(v.length>10) v=v.slice(0,10);
  if(v.length>5) v=v.slice(0,3)+'-'+v.slice(3,5)+'-'+v.slice(5);
  else if(v.length>3) v=v.slice(0,3)+'-'+v.slice(3);
  el.value=v;
}
function formatCorpNo(el) {
  let v = el.value.replace(/[^0-9]/g,'');
  if(v.length>13) v=v.slice(0,13);
  if(v.length>6) v=v.slice(0,6)+'-'+v.slice(6);
  el.value=v;
}
function formatPhone(el) {
  let v = el.value.replace(/[^0-9]/g,'');
  if(v.length>11) v=v.slice(0,11);
  if(v.length>7) v=v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  else if(v.length>3) v=v.slice(0,3)+'-'+v.slice(3);
  el.value=v;
}

function toggleCorpNo() {
  const val = document.querySelector('input[name="corpType"]:checked').value;
  document.getElementById('corpNoGroup').style.display = val === 'ê°œì¸' ? 'none' : 'flex';
}
function toggleCustomInput(sel) {
  const input = sel.parentElement.querySelector('input');
  if (sel.value === 'ì§ì ‘ì…ë ¥') { input.classList.remove('hidden'); input.focus(); }
  else { input.classList.add('hidden'); input.value = ''; }
}
function updateBizTypeOptions(sel) {
  var field = sel.value;
  var idx = sel.id.split('_').pop();
  var badgeEl = document.getElementById('licLawBadge_' + idx);
  if (!badgeEl) return;
  var lawMap = { 'ì‹í’ˆ': 'ì‹í’ˆìœ„ìƒë²•', 'ì¶•ì‚°': 'ì¶•ì‚°ë¬¼ ìœ„ìƒê´€ë¦¬ë²•' };
  if (field && lawMap[field]) {
    badgeEl.textContent = 'ğŸ“‹ ê·¼ê±°ë²•: ã€Œ' + lawMap[field] + 'ã€';
    badgeEl.style.display = 'inline-flex';
  } else {
    badgeEl.style.display = 'none';
    badgeEl.textContent = '';
  }
}

/* ===== í† ìŠ¤íŠ¸ ===== */
function showToastMsg(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

/* ===== Firestore ì €ì¥ â€” ê³ ê°ì‚¬ ë“±ë¡ (í‘œì¤€ í˜•ì‹: companyMgmt.html í˜¸í™˜) ===== */
async function submitCompanyForm() {
  // í•„ìˆ˜ ê²€ì¦
  var companyName = (document.getElementById('companyName') || {}).value || '';
  var bizNo = (document.getElementById('bizNo') || {}).value || '';
  var repName = (document.getElementById('regRepName') || {}).value || '';
  if (!companyName.trim()) { alert('íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (!bizNo.trim()) { alert('ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if (!repName.trim()) { alert('ëŒ€í‘œìëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘ â€” í‘œì¤€ í•„ë“œëª… ì‚¬ìš© (companyMgmt.html ê¸°ì¤€)
  var corpType = document.querySelector('input[name="corpType"]:checked');
  var data = {
    company: companyName.trim(),
    bizNo: bizNo.trim(),
    repName: repName.trim(),
    corpType: corpType ? corpType.value : 'ë²•ì¸',
    corpNo: (document.getElementById('regCorpNo') || {}).value || '',
    bizType: (document.getElementById('regBizType') || {}).value || '',
    bizItem: (document.getElementById('regBizItem') || {}).value || '',
    status: (document.getElementById('regStatus') || {}).value || 'í™œë™',
    grade: 'C'
  };

  // ì£¼ì†Œ ìˆ˜ì§‘ â€” flat í•„ë“œ (í‘œì¤€ í˜•ì‹)
  data.zipcode = (document.getElementById('regZipcode') || {}).value || '';
  data.addr1 = (document.getElementById('regAddr1') || {}).value || '';
  data.addr2 = (document.getElementById('regAddr2') || {}).value || '';

  // ì˜ë¬¸ ì •ë³´
  data.companyEn = (document.getElementById('regCompanyNameEn') || {}).value || '';
  data.repNameEn = (document.getElementById('regRepNameEn') || {}).value || '';
  data.addrEn = (document.getElementById('regAddrEn') || {}).value || '';

  // ì¸í—ˆê°€ ìˆ˜ì§‘ â€” í‘œì¤€ í•„ë“œëª… (licField, licBizForm, licRepName, licNo, licBizName + ì£¼ì†Œ/ì˜ë¬¸)
  data.licenses = [];
  for (var l = 1; l <= licenseCount; l++) {
    if (!document.getElementById('license-' + l)) continue;
    var lic = {
      licField: (document.getElementById('licField_' + l) || {}).value || '',
      licBizForm: (document.getElementById('licBizForm_' + l) || {}).value || '',
      licRepName: (document.getElementById('licRepName_' + l) || {}).value || '',
      licNo: (document.getElementById('licNo_' + l) || {}).value || '',
      licBizName: (document.getElementById('licBizName_' + l) || {}).value || '',
      licZipcode: (document.getElementById('licZipcode_' + l) || {}).value || '',
      licAddr: (document.getElementById('licAddr_' + l) || {}).value || '',
      licAddr2: (document.getElementById('licAddrDetail_' + l) || {}).value || '',
      licBizNameEn: (document.getElementById('licBizNameEn_' + l) || {}).value || '',
      licRepNameEn: (document.getElementById('licRepNameEn_' + l) || {}).value || '',
      licAddrEn: (document.getElementById('licAddrEn_' + l) || {}).value || ''
    };
    if (lic.licField || lic.licNo) data.licenses.push(lic);
  }
  // í•˜ìœ„ í˜¸í™˜ì„±: ì²« ë²ˆì§¸ ì¸í—ˆê°€ ì •ë³´ë¥¼ flat í•„ë“œì—ë„ ì €ì¥
  if (data.licenses.length > 0) {
    var firstLic = data.licenses[0];
    data.licField = firstLic.licField || '';
    data.licBizForm = firstLic.licBizForm || '';
    data.licRepName = firstLic.licRepName || '';
    data.licNo = firstLic.licNo || '';
    data.licBizName = firstLic.licBizName || '';
    data.licZipcode = firstLic.licZipcode || '';
    data.licAddr = firstLic.licAddr || '';
    data.licAddr2 = firstLic.licAddr2 || '';
    data.licBizNameEn = firstLic.licBizNameEn || '';
    data.licRepNameEn = firstLic.licRepNameEn || '';
    data.licAddrEn = firstLic.licAddrEn || '';
  }

  // ë‹´ë‹¹ì ìˆ˜ì§‘ â€” í‘œì¤€ í˜•ì‹ (role, licNums í¬í•¨)
  data.contacts = [];
  for (var c = 1; c <= contactCount; c++) {
    if (!document.getElementById('contact-' + c)) continue;
    var ct = {
      name: (document.getElementById('cName' + c) || {}).value || '',
      phone: (document.getElementById('cPhone' + c) || {}).value || '',
      email: (document.getElementById('cEmail' + c) || {}).value || '',
      role: (document.getElementById('cTeam' + c) || {}).value || '',
      salesRep: (document.getElementById('cRep' + c) || {}).value || '',
      licNums: []
    };
    if (ct.name.trim()) data.contacts.push(ct);
  }
  // flat ë‹´ë‹¹ì í•„ë“œ (ì²« ë²ˆì§¸ ë‹´ë‹¹ì ê¸°ì¤€)
  if (data.contacts.length > 0) {
    data.contactName = data.contacts[0].name || '';
    data.contactPhone = data.contacts[0].phone || '';
    data.contactEmail = data.contacts[0].email || '';
    data.salesRep = data.contacts[0].salesRep || '';
  } else {
    data.contactName = '';
    data.contactPhone = '';
    data.contactEmail = '';
    data.salesRep = '';
  }

  // ì„¸ê¸ˆê³„ì‚°ì„œ ì •ë³´ â€” flat í•„ë“œ (í‘œì¤€ í˜•ì‹)
  data.taxName = (document.getElementById('taxName') || {}).value || '';
  data.taxPhone = (document.getElementById('taxPhone') || {}).value || '';
  data.taxEmail = (document.getElementById('taxEmail') || {}).value || '';

  // ë¹„ê³  â€” í‘œì¤€ í•„ë“œëª…
  data.memo = (document.getElementById('regNote') || {}).value || '';

  // ë“±ë¡ì¼/ë³€ê²½ì´ë ¥ (í‘œì¤€ í•„ë“œ)
  data.regDate = new Date().toISOString().slice(0, 10);
  data.changeLog = [];

  try {
    // Firestoreì— ì—…ì²´ ì €ì¥
    var docId = await fsSaveCompany(data);
    console.log('[companyRegForm] ì—…ì²´ ì €ì¥ ì™„ë£Œ, docId:', docId);

    // ì‚¬ì—…ìë“±ë¡ì¦ íŒŒì¼ ì—…ë¡œë“œ
    var bizLicFile = document.getElementById('bizLicFileInput');
    if (bizLicFile && bizLicFile.files && bizLicFile.files[0]) {
      try {
        await fsUploadBizLicense(docId, bizLicFile.files[0]);
        console.log('[companyRegForm] ì‚¬ì—…ìë“±ë¡ì¦ ì—…ë¡œë“œ ì™„ë£Œ');
      } catch(e) { console.warn('ì‚¬ì—…ìë“±ë¡ì¦ ì—…ë¡œë“œ ì‹¤íŒ¨:', e.message); }
    }

    // ì¸í—ˆê°€ë¬¸ì„œ íŒŒì¼ ì—…ë¡œë“œ
    for (var f = 1; f <= licenseCount; f++) {
      var licFileInput = document.getElementById('licFileInput_' + f);
      if (licFileInput && licFileInput.files && licFileInput.files[0]) {
        try {
          await fsUploadPermitDoc(docId, licFileInput.files[0]);
          console.log('[companyRegForm] ì¸í—ˆê°€ë¬¸ì„œ ' + f + ' ì—…ë¡œë“œ ì™„ë£Œ');
        } catch(e) { console.warn('ì¸í—ˆê°€ë¬¸ì„œ ' + f + ' ì—…ë¡œë“œ ì‹¤íŒ¨:', e.message); }
      }
    }

    // ===== OCR ì¸ì‹ ê²°ê³¼ Firestore ì €ì¥ =====
    var ocrResults = [];
    if (_bizLicOcrResult) ocrResults.push(_bizLicOcrResult);
    Object.keys(_licOcrResults).forEach(function(k) {
      if (_licOcrResults[k]) ocrResults.push(_licOcrResults[k]);
    });
    if (ocrResults.length > 0) {
      try {
        await db.collection('companies').doc(docId).update({
          'files.ocrResults': ocrResults,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('[companyRegForm] OCR ê²°ê³¼ ' + ocrResults.length + 'ê±´ ì €ì¥ ì™„ë£Œ');
      } catch(e) { console.warn('OCR ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', e.message); }
    }

    showToastMsg('âœ… ê³ ê°ì‚¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
    // 2ì´ˆ í›„ ì—…ì²´ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
    setTimeout(function() {
      location.href = 'companyMgmt.html';
    }, 2000);

  } catch(e) {
    console.error('ì—…ì²´ ë“±ë¡ ì‹¤íŒ¨:', e);
    alert('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + e.message);
  }
}

/* ===== ì¤‘ë³µ í™•ì¸ â€” Firestore ì—°ë™ ===== */
var _origCheckBizDup = typeof checkBizDup === 'function' ? checkBizDup : null;
async function checkBizDupFirestore() {
  var bizNo = (document.getElementById('bizNo') || {}).value || '';
  if (!bizNo.trim()) { alert('ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try {
    var dup = await fsCheckDuplicateBusinessNo(bizNo.trim());
    var resultEl = document.getElementById('bizCheckResult');
    if (dup) {
      resultEl.className = 'check-result check-dup';
      resultEl.textContent = 'âš ï¸ ì´ë¯¸ ë“±ë¡ëœ ì‚¬ì—…ìë²ˆí˜¸ì…ë‹ˆë‹¤: ' + (dup.name || '');
      resultEl.style.display = 'block';
    } else {
      resultEl.className = 'check-result check-ok';
      resultEl.textContent = 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ì‚¬ì—…ìë²ˆí˜¸ì…ë‹ˆë‹¤.';
      resultEl.style.display = 'block';
    }
  } catch(e) {
    console.warn('ì¤‘ë³µ í™•ì¸ ì‹¤íŒ¨:', e.message);
    if (_origCheckBizDup) _origCheckBizDup();
  }
}

/* Firebase ì¤€ë¹„ í›„ ì¤‘ë³µí™•ì¸ì„ Firestore ë²„ì „ìœ¼ë¡œ êµì²´ */
window.addEventListener('firebase-ready', function() {
  // checkBizDup í•¨ìˆ˜ë¥¼ Firestore ë²„ì „ìœ¼ë¡œ êµì²´
  if (typeof checkBizDup === 'function') {
    window.checkBizDup = checkBizDupFirestore;
  }
});

/* ===== í˜ì´ì§€ ì´ˆê¸°í™” ===== */
/* 1ë²ˆ ë‹´ë‹¹ì ë¶€ì„œ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë™ì  ìƒì„± */
(function() {
  var ts = document.getElementById('cTeam1');
  if (ts) ts.innerHTML = '<option value="">ë¶€ì„œ(íŒ€) ì„ íƒ</option>' + buildTeamOptions();
})();
filterRepByTeam(1);  // 1ë²ˆ ë‹´ë‹¹ì ì ‘ìˆ˜ì ë“œë¡­ë‹¤ìš´ ì „ì²´ ëª©ë¡ ë¡œë“œ
</script>
</body>
</html>
