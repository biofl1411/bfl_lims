<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ì ‘ìˆ˜ í˜„í™©</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,sans-serif;height:100vh;background:#f8f9fb;font-size:13px;overflow:hidden;display:flex}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;margin-left:250px;height:100vh}
.topbar{background:#fff;border-bottom:1px solid #e2e6ed;padding:0 24px;height:52px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.topbar-title{font-size:15px;font-weight:700;color:#1a2332}
.topbar-sep{color:#c8d6e5}
.topbar-sub{font-size:13px;color:#5f6b7a}
.content{flex:1;padding:24px;overflow-y:auto}
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:#1a73e8;color:#fff}.btn-primary:hover{background:#1557b0}
.btn-secondary{background:#fff;color:#5f6b7a;border:1px solid #e2e6ed}.btn-secondary:hover{background:#f0f2f5}
.btn-sm{padding:6px 12px;font-size:11px}
.card{background:#fff;border-radius:12px;border:1px solid #e2e6ed;margin-bottom:16px}
.card-hd{padding:16px 20px;border-bottom:1px solid #eef0f4;display:flex;align-items:center;gap:10px}
.card-hd h3{font-size:15px;font-weight:700;color:#1a2332}
.card-hd .right{margin-left:auto;display:flex;gap:8px;align-items:center}
.card-bd{padding:20px;overflow-x:auto}

/* í•„í„°ë°” */
.filter-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:16px}
.filter-bar input,.filter-bar select{padding:8px 12px;border:1px solid #e2e6ed;border-radius:8px;font-size:12px;font-family:inherit}
.filter-bar input[type="text"]{width:200px}
.filter-bar input[type="date"]{width:140px}

/* í…Œì´ë¸” */
.tbl{width:100%;border-collapse:collapse;min-width:900px}
.tbl th{background:#f8f9fb;padding:10px 14px;font-size:11px;font-weight:700;color:#5f6b7a;text-align:left;border-bottom:2px solid #e2e6ed;white-space:nowrap;cursor:pointer;user-select:none;position:relative}
.tbl th:hover{background:#eef0f4}
.tbl th .sort-icon{font-size:10px;margin-left:4px;color:#bbb}
.tbl th.sorted-asc .sort-icon{color:#1a73e8}
.tbl th.sorted-desc .sort-icon{color:#1a73e8}
.tbl td{padding:10px 14px;border-bottom:1px solid #eef0f4;font-size:12px;color:#333;white-space:nowrap}
.tbl tr:hover{background:#fafbfc}
.tbl .center{text-align:center}

/* ìƒíƒœ íƒœê·¸ */
.tag{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.tag-waiting{background:#fff3e0;color:#e65100}
.tag-inprogress{background:#e3f2fd;color:#1565c0}
.tag-complete{background:#e8f5e9;color:#2e7d32}

/* ì»¬ëŸ¼ ì„¤ì • ë“œë¡­ë‹¤ìš´ */
.col-settings-wrap{position:relative}
.col-settings-panel{display:none;position:absolute;top:100%;right:0;z-index:100;background:#fff;border:1px solid #e2e6ed;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.12);padding:12px;min-width:220px;max-height:400px;overflow-y:auto;margin-top:4px}
.col-settings-panel.active{display:block}
.col-settings-panel label{display:flex;align-items:center;gap:8px;padding:5px 6px;font-size:12px;cursor:pointer;border-radius:4px}
.col-settings-panel label:hover{background:#f8f9fb}

/* í˜ì´ì§€ë„¤ì´ì…˜ */
.pagination{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:16px}
.pagination button{padding:6px 12px;border:1px solid #e2e6ed;border-radius:6px;background:#fff;font-size:12px;cursor:pointer}
.pagination button.active{background:#1a73e8;color:#fff;border-color:#1a73e8}
.pagination button:disabled{opacity:0.4;cursor:not-allowed}
.pagination .page-info{font-size:12px;color:#5f6b7a}

/* ë¡œë”© */
.loading{text-align:center;padding:40px;color:#999;font-size:14px}

/* ì‹ í˜¸ë“± */
.tl{display:inline-block;width:12px;height:12px;border-radius:50%;vertical-align:middle}
.tl-blue{background:#2196f3}.tl-green{background:#4caf50}.tl-yellow{background:#ffeb3b}.tl-orange{background:#ff9800}.tl-red{background:#f44336}
/* ë“±ê¸‰ íƒœê·¸ */
.tag-vip{background:#fce4ec;color:#c62828}.tag-a{background:#e3f2fd;color:#1565c0}.tag-b{background:#e8f5e9;color:#2e7d32}.tag-c{background:#f3e5f5;color:#7b1fa2}
/* ì‹ í˜¸ë“± íˆ´íŒ */
[data-tooltip]{position:relative;cursor:help}
[data-tooltip]:hover::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:10px 14px;border-radius:8px;font-size:11px;white-space:pre-line;min-width:240px;max-width:320px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.2);line-height:1.7;pointer-events:none;font-weight:400;letter-spacing:0}
[data-tooltip]:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b;z-index:9999;pointer-events:none}

/* ìƒì„¸ ëª¨ë‹¬ */
.modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:2000;align-items:center;justify-content:center}
.modal-bg.active{display:flex}
.modal{background:#fff;border-radius:14px;width:90%;max-width:800px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
.modal-hd{padding:18px 24px;border-bottom:1px solid #eef0f4;display:flex;align-items:center;justify-content:space-between}
.modal-hd h3{font-size:16px;font-weight:700}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:#666}
.modal-bd{padding:24px}
.detail-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:16px}
.detail-item label{font-size:11px;font-weight:600;color:#5f6b7a;display:block;margin-bottom:4px}
.detail-item .val{font-size:13px;color:#1a2332}
</style>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>
<script src="js/sidebar.js?v=2"></script>
</head>
<body>
<aside class="sidebar" id="sidebar"></aside>
<div class="main">
    <div class="topbar">
        <span class="topbar-title">ì ‘ìˆ˜ ê´€ë¦¬</span>
        <span class="topbar-sep">â€º</span>
        <span class="topbar-sub">ì ‘ìˆ˜ í˜„í™©</span>
    </div>
    <div class="content">
        <div class="card">
            <div class="card-hd">
                <h3>ğŸ“‹ ì ‘ìˆ˜ í˜„í™©</h3>
                <div class="right">
                    <span id="total-count" style="font-size:12px;color:#5f6b7a"></span>
                    <button class="btn btn-secondary btn-sm" onclick="loadReceipts()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    <div class="col-settings-wrap">
                        <button class="btn btn-secondary btn-sm" onclick="toggleColSettings()" id="col-settings-btn">âš™ï¸ ì»¬ëŸ¼</button>
                        <div class="col-settings-panel" id="col-settings-panel"></div>
                    </div>
                </div>
            </div>
            <div class="card-bd">
                <!-- í•„í„° -->
                <div class="filter-bar">
                    <input type="text" id="filter-search" placeholder="ì ‘ìˆ˜ë²ˆí˜¸, ê±°ë˜ì²˜, ì œí’ˆëª… ê²€ìƒ‰..." oninput="applyFilter()">
                    <select id="filter-status" onchange="applyFilter()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="ëŒ€ê¸°ì¤‘">ëŒ€ê¸°ì¤‘</option>
                        <option value="ì ‘ìˆ˜ì¤‘">ì ‘ìˆ˜ì¤‘</option>
                        <option value="ì ‘ìˆ˜ì™„ë£Œ">ì ‘ìˆ˜ì™„ë£Œ</option>
                    </select>
                    <input type="date" id="filter-from" onchange="applyFilter()">
                    <span style="color:#999">~</span>
                    <input type="date" id="filter-to" onchange="applyFilter()">
                    <select id="filter-field" onchange="applyFilter()">
                        <option value="">ì „ì²´ ë¶„ì•¼</option>
                        <option value="ì‹í’ˆ">ì‹í’ˆ</option>
                        <option value="ì¶•ì‚°">ì¶•ì‚°</option>
                    </select>
                </div>
                <!-- í…Œì´ë¸” -->
                <div style="overflow-x:auto">
                    <table class="tbl" id="receipt-table">
                        <thead id="receipt-thead"></thead>
                        <tbody id="receipt-tbody"></tbody>
                    </table>
                </div>
                <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>
</div>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-bg" id="detail-modal">
    <div class="modal">
        <div class="modal-hd">
            <h3 id="detail-title">ì ‘ìˆ˜ ìƒì„¸</h3>
            <button class="modal-close" onclick="closeDetailModal()">âœ•</button>
        </div>
        <div class="modal-bd" id="detail-body"></div>
    </div>
</div>

<script>
// ============================================================================
// ì‹ í˜¸ë“± / ë“±ê¸‰ í•¨ìˆ˜ (salesMgmt.htmlì—ì„œ ë³µì œ)
// ============================================================================
var _cachedGradeRules = null;
var _cachedSignalRules = null;
var _companyMap = {}; // companyName â†’ company ë°ì´í„°

function getGradeRules() {
    if (_cachedGradeRules) return _cachedGradeRules;
    return JSON.parse(localStorage.getItem('bfl_grade_rules') || 'null') || {
        gradeThresholds: { vip: 90, a: 70, b: 50 },
        revenue:      { scores: [5,10,20,30,40], thresholds: [1000,3000,5000,10000] },
        frequency:    { scores: [5,10,15,20,25], thresholds: [1,3,5,10] },
        duration:     { scores: [3,6,9,12,15],   thresholds: [1,2,3,5] },
        payment:      { scores: [3,6,9,12,15] },
        department:   { scores: [1,3,5], conditions: ['ì§€ì‚¬','ê³ ê°ê´€ë¦¬','ê³ ê°ì§€ì›íŒ€, ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€'] },
        receiptType:  { scores: [1,3,5], conditions: ['íƒë°°ì ‘ìˆ˜','ë°©ë¬¸ì ‘ìˆ˜','í™ˆí˜ì´ì§€ì ‘ìˆ˜'] }
    };
}

function getSignalRules() {
    if (_cachedSignalRules) return _cachedSignalRules;
    return JSON.parse(localStorage.getItem('bfl_signal_rules') || 'null') || {
        green:30, blueMin:31, blueMax:60, yellowMin:61, yellowMax:90,
        orangeMin:91, orangeMax:120, redMin:121
    };
}

function calcCustomerScore(customer) {
    var rules = getGradeRules();
    var detail = {};
    var total = 0;
    // 1. ì—°ê°„ ë§¤ì¶œì•¡
    var rev = rules.revenue || { scores:[5,10,20,30,40], thresholds:[1000,3000,5000,10000] };
    var revVal = customer.annualRevenue || 0;
    var revScore = rev.scores[0];
    for (var i = rev.thresholds.length - 1; i >= 0; i--) {
        if (revVal >= rev.thresholds[i]) { revScore = rev.scores[i + 1]; break; }
    }
    detail.revenue = { label:'ì—°ê°„ë§¤ì¶œì•¡', value: Number(revVal).toLocaleString() + 'ë§Œì›', score: revScore, max: rev.scores[rev.scores.length-1] };
    total += revScore;
    // 2. ê±°ë˜ ë¹ˆë„
    var freq = rules.frequency || { scores:[5,10,15,20,25], thresholds:[1,3,5,10] };
    var freqVal = customer.monthlyFrequency || 0;
    var freqScore = freq.scores[0];
    for (var i = freq.thresholds.length - 1; i >= 0; i--) {
        if (freqVal >= freq.thresholds[i]) { freqScore = freq.scores[i + 1]; break; }
    }
    detail.frequency = { label:'ê±°ë˜ë¹ˆë„', value: 'ì›” ' + freqVal + 'ê±´', score: freqScore, max: freq.scores[freq.scores.length-1] };
    total += freqScore;
    // 3. ê±°ë˜ ê¸°ê°„
    var dur = rules.duration || { scores:[3,6,9,12,15], thresholds:[1,2,3,5] };
    var durVal = customer.tradeDuration || 0;
    var durScore = dur.scores[0];
    for (var i = dur.thresholds.length - 1; i >= 0; i--) {
        if (durVal >= dur.thresholds[i]) { durScore = dur.scores[i + 1]; break; }
    }
    detail.duration = { label:'ê±°ë˜ê¸°ê°„', value: durVal + 'ë…„', score: durScore, max: dur.scores[dur.scores.length-1] };
    total += durScore;
    // 4. ê²°ì œ ì‹ ë¢°ë„ (ì‹ í˜¸ë“± ë§¤í•‘)
    var pay = rules.payment || { scores:[3,6,9,12,15] };
    var tlMap = { red:0, orange:1, yellow:2, blue:3, green:4 };
    var tlIdx = tlMap[customer.trafficLight] !== undefined ? tlMap[customer.trafficLight] : 3;
    var payScore = pay.scores[tlIdx];
    var tlLabels = { green:'ì •ìƒ', blue:'ì–‘í˜¸', yellow:'ì£¼ì˜', orange:'ê²½ê³ ', red:'ìœ„í—˜' };
    detail.payment = { label:'ê²°ì œì‹ ë¢°ë„', value: tlLabels[customer.trafficLight] || 'ì–‘í˜¸', score: payScore, max: pay.scores[pay.scores.length-1] };
    total += payScore;
    // 5. ë‹´ë‹¹ë¶€ì„œ
    var dept = rules.department || { scores:[1,3,5], conditions:['ì§€ì‚¬','ê³ ê°ê´€ë¦¬','ê³ ê°ì§€ì›íŒ€, ë§ˆì¼€íŒ…ì‚¬ì—…ë¶€'] };
    var custDept = customer.department || '';
    var deptScore = 0;
    for (var i = dept.conditions.length - 1; i >= 0; i--) {
        if (dept.conditions[i].indexOf(custDept) !== -1 && custDept) { deptScore = dept.scores[i]; break; }
    }
    detail.department = { label:'ë‹´ë‹¹ë¶€ì„œ', value: custDept || 'ë¯¸ì§€ì •', score: deptScore, max: dept.scores[dept.scores.length-1] };
    total += deptScore;
    // 6. ì ‘ìˆ˜í˜•íƒœ
    var rcpt = rules.receiptType || { scores:[1,3,5], conditions:['íƒë°°ì ‘ìˆ˜','ë°©ë¬¸ì ‘ìˆ˜','í™ˆí˜ì´ì§€ì ‘ìˆ˜'] };
    var custRcpt = customer.receiptType || '';
    var rcptScore = 0;
    for (var i = rcpt.conditions.length - 1; i >= 0; i--) {
        if (rcpt.conditions[i] === custRcpt) { rcptScore = rcpt.scores[i]; break; }
    }
    detail.receiptType = { label:'ì ‘ìˆ˜í˜•íƒœ', value: custRcpt || 'ì—†ìŒ', score: rcptScore, max: rcpt.scores[rcpt.scores.length-1] };
    total += rcptScore;
    // ë“±ê¸‰ íŒì •
    var th = rules.gradeThresholds || { vip:90, a:70, b:50 };
    var grade = 'C';
    if (total >= th.vip) grade = 'VIP';
    else if (total >= th.a) grade = 'A';
    else if (total >= th.b) grade = 'B';
    return { total: total, grade: grade, detail: detail };
}

// ============================================================================
// ì»¬ëŸ¼ ì •ì˜
// ============================================================================
var ALL_COLUMNS = [
    { key: 'receiptNo',     label: 'ì ‘ìˆ˜ë²ˆí˜¸',   visible: true,  width: '140px' },
    { key: 'receiptDate',   label: 'ì ‘ìˆ˜ì¼ì',   visible: true,  width: '100px' },
    { key: 'status',        label: 'ìƒíƒœ',       visible: true,  width: '80px' },
    { key: 'trafficLight',  label: 'ì‹ í˜¸ë“±',     visible: true,  width: '50px' },
    { key: 'grade',         label: 'ë“±ê¸‰',       visible: true,  width: '50px' },
    { key: 'testField',     label: 'ì‹œí—˜ë¶„ì•¼',   visible: true,  width: '70px' },
    { key: 'testPurpose',   label: 'ê²€ì‚¬ëª©ì ',   visible: true,  width: '100px' },
    { key: 'companyName',   label: 'ê±°ë˜ì²˜',     visible: true,  width: '140px' },
    { key: 'productName',   label: 'ì œí’ˆ/ì‹œë£Œëª…', visible: true,  width: '160px' },
    { key: 'sampleTotalCount', label: 'ì‹œë£Œìˆ˜',  visible: true,  width: '60px' },
    { key: 'foodType',      label: 'ì‹í’ˆìœ í˜•',   visible: true,  width: '120px' },
    { key: 'urgent',        label: 'ê¸´ê¸‰',       visible: true,  width: '50px' },
    { key: 'salesRep',      label: 'ë‹´ë‹¹ì',     visible: true,  width: '80px' },
    { key: 'feeSupply',     label: 'ê³µê¸‰ê°€ì•¡',   visible: true,  width: '100px' },
    { key: 'feeVat',        label: 'ì„¸ì•¡',       visible: true,  width: '90px' },
    { key: 'feeTotal',      label: 'ìˆ˜ìˆ˜ë£Œì´ê³„', visible: true,  width: '100px' },
    { key: 'reportSend',    label: 'ë°œì†¡ë°©ë²•',   visible: false, width: '100px' },
    { key: 'companyPhone',  label: 'ì „í™”ë²ˆí˜¸',   visible: false, width: '110px' },
    { key: 'companyFax',    label: 'íŒ©ìŠ¤ë²ˆí˜¸',   visible: false, width: '110px' },
    { key: 'companyMobile', label: 'íœ´ëŒ€ì „í™”',   visible: false, width: '110px' },
    { key: 'companyAddress',label: 'ì£¼ì†Œ',       visible: false, width: '200px' },
    { key: 'licNo',         label: 'ì¸í—ˆê°€ë²ˆí˜¸', visible: false, width: '120px' },
    { key: 'licBizForm',    label: 'ì—…ì¢…/ì—…íƒœ',  visible: false, width: '100px' },
    { key: 'payMethod',     label: 'ê²°ì œë°©ë²•',   visible: false, width: '80px' },
    { key: 'payDate',       label: 'ê²°ì œì¼',     visible: false, width: '100px' },
    { key: 'processingDeadline', label: 'ì²˜ë¦¬ê¸°í•œ', visible: false, width: '100px' },
    { key: 'billCompany',   label: 'ê³„ì‚°ì„œì—…ì²´', visible: false, width: '130px' },
    { key: 'bizNo',         label: 'ì‚¬ì—…ìë²ˆí˜¸', visible: false, width: '120px' },
    { key: 'ceo',           label: 'ëŒ€í‘œì',     visible: false, width: '80px' },
    { key: 'billName',      label: 'ë‹´ë‹¹ìëª…',   visible: false, width: '80px' },
    { key: 'billPhone',     label: 'ê³„ì‚°ì„œì „í™”', visible: false, width: '110px' },
    { key: 'billEmail',     label: 'ê³„ì‚°ì„œì´ë©”ì¼', visible: false, width: '140px' },
    { key: 'relatedLaw',    label: 'ê´€ë ¨ë²•ë ¹',   visible: false, width: '120px' },
    { key: 'documentNo',    label: 'ë¬¸ì„œë²ˆí˜¸',   visible: false, width: '100px' },
    { key: 'reportFaxNo',   label: 'ë°œì†¡íŒ©ìŠ¤',   visible: false, width: '110px' },
    { key: 'reportEmail',   label: 'ë°œì†¡ì´ë©”ì¼', visible: false, width: '140px' }
];

var _allReceipts = [];
var _filteredReceipts = [];
var _sortKey = 'receiptDate';
var _sortDir = 'desc';
var _page = 1;
var _pageSize = 30;

// ============================================================================
// ë°ì´í„° ë¡œë“œ
// ============================================================================
async function loadReceipts() {
    document.getElementById('loading').style.display = '';
    document.getElementById('receipt-tbody').innerHTML = '';
    try {
        // ê±°ë˜ì²˜ ë°ì´í„° ë¡œë“œ â†’ ì‹ í˜¸ë“±/ë“±ê¸‰ ë§¤ì¹­ìš©
        var companies = [];
        try { companies = await fsGetCompanies({ limit: 5000 }); } catch(e) { console.warn('ê±°ë˜ì²˜ ë¡œë“œ ì‹¤íŒ¨:', e); }
        _companyMap = {};
        companies.forEach(function(c) {
            var name = (c.company || c.name || '').trim();
            if (name && !_companyMap[name]) _companyMap[name] = c;
        });

        var rawReceipts = await fsGetReceipts({ limit: 500 });
        // ì‹œë£Œë³„ í–‰ í¼ì¹¨: ì ‘ìˆ˜ 1ê±´ â†’ ì‹œë£Œ ìˆ˜ë§Œí¼ í–‰ ìƒì„±
        _allReceipts = [];
        rawReceipts.forEach(function(r) {
            if (r.reportSend && Array.isArray(r.reportSend)) {
                r.reportSendText = r.reportSend.join(', ');
            }
            // ê±°ë˜ì²˜ ë§¤ì¹­ â†’ ì‹ í˜¸ë“±/ë“±ê¸‰
            var cust = _companyMap[(r.companyName || '').trim()];
            var trafficLight = cust ? (cust.trafficLight || 'blue') : '';
            var grade = '';
            if (cust) { try { grade = calcCustomerScore(cust).grade; } catch(e) {} }
            // ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ê³µê¸‰ê°€ì•¡/ì„¸ì•¡/ì´ê³„)
            var ft = r.feeTotal || 0;
            var feeSupply = ft ? Math.round(ft / 1.1) : 0;
            var feeVat = ft ? ft - feeSupply : 0;

            var samples = r.samples && r.samples.length > 0 ? r.samples : [{}];
            var totalCount = r.sampleTotalCount || samples.length || 1;
            samples.forEach(function(s, idx) {
                var sno = String(idx + 1).padStart(3, '0');
                var row = Object.assign({}, r);
                row.receiptNo = (r.receiptNo || '') + '-' + sno;
                row._baseReceiptNo = r.receiptNo || '';
                row.productName = s.productName || r.productName || '';
                row.foodType = s.foodType || r.foodType || '';
                row.sampleTotalCount = totalCount;
                row._sampleIdx = idx;
                // ì‹ í˜¸ë“±/ë“±ê¸‰
                row.trafficLight = trafficLight;
                row.grade = grade;
                // ìˆ˜ìˆ˜ë£Œ
                row.feeSupply = feeSupply;
                row.feeVat = feeVat;
                row.feeTotal = ft;
                // ì ‘ìˆ˜ë“±ë¡ ëˆ„ë½ í•„ë“œ
                row.testPurpose = r.testPurpose || '';
                row.payMethod = r.payMethod || '';
                row.payDate = r.payDate || '';
                row.licNo = r.licNo || '';
                row.licBizForm = r.licBizForm || '';
                row.companyMobile = r.companyMobile || '';
                row.companyAddress = r.companyAddress || '';
                row.ceo = r.ceo || '';
                row.billName = r.billName || '';
                row.billPhone = r.billPhone || '';
                row.billEmail = r.billEmail || '';
                row.relatedLaw = r.relatedLaw || '';
                row.documentNo = r.documentNo || '';
                row.reportFaxNo = r.reportFaxNo || '';
                row.reportEmail = r.reportEmail || '';
                _allReceipts.push(row);
            });
        });
        applyFilter();
    } catch(err) {
        console.error('ì ‘ìˆ˜ í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', err);
        document.getElementById('loading').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
    }
}

// ============================================================================
// í•„í„° + ì •ë ¬
// ============================================================================
function applyFilter() {
    var search = (document.getElementById('filter-search').value || '').toLowerCase();
    var status = document.getElementById('filter-status').value;
    var from = document.getElementById('filter-from').value;
    var to = document.getElementById('filter-to').value;
    var field = document.getElementById('filter-field').value;

    _filteredReceipts = _allReceipts.filter(function(r) {
        if (status && r.status !== status) return false;
        if (field && r.testField !== field) return false;
        if (from && r.receiptDate < from) return false;
        if (to && r.receiptDate > to) return false;
        if (search) {
            var hay = ((r.receiptNo || '') + (r._baseReceiptNo || '') + (r.companyName || '') + (r.productName || '') + (r.foodType || '') + (r.testPurpose || '') + (r.billCompany || '') + (r.salesRep || '')).toLowerCase();
            if (hay.indexOf(search) < 0) return false;
        }
        return true;
    });

    // ì •ë ¬
    _filteredReceipts.sort(function(a, b) {
        var va = (a[_sortKey] || ''), vb = (b[_sortKey] || '');
        if (typeof va === 'number' && typeof vb === 'number') {
            return _sortDir === 'asc' ? va - vb : vb - va;
        }
        va = String(va); vb = String(vb);
        return _sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
    });

    _page = 1;
    renderTable();
}

// ============================================================================
// ì •ë ¬
// ============================================================================
function sortBy(key) {
    if (_sortKey === key) {
        _sortDir = (_sortDir === 'asc') ? 'desc' : 'asc';
    } else {
        _sortKey = key;
        _sortDir = 'asc';
    }
    applyFilter();
}

// ============================================================================
// í…Œì´ë¸” ë Œë”ë§
// ============================================================================
function renderTable() {
    var visibleCols = ALL_COLUMNS.filter(function(c) { return c.visible; });
    // í—¤ë”
    var thead = document.getElementById('receipt-thead');
    var hhtml = '<tr>';
    visibleCols.forEach(function(col) {
        var cls = '';
        var icon = 'â†•';
        if (_sortKey === col.key) {
            cls = _sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc';
            icon = _sortDir === 'asc' ? 'â–²' : 'â–¼';
        }
        hhtml += '<th class="' + cls + '" style="width:' + col.width + '" onclick="sortBy(\'' + col.key + '\')">' +
            col.label + ' <span class="sort-icon">' + icon + '</span></th>';
    });
    hhtml += '</tr>';
    thead.innerHTML = hhtml;

    // ë°ì´í„°
    var tbody = document.getElementById('receipt-tbody');
    var start = (_page - 1) * _pageSize;
    var pageData = _filteredReceipts.slice(start, start + _pageSize);
    document.getElementById('loading').style.display = 'none';

    if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + visibleCols.length + '" style="text-align:center;padding:40px;color:#999">ì ‘ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        document.getElementById('total-count').textContent = '';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    document.getElementById('total-count').textContent = 'ì´ ' + _filteredReceipts.length + 'ê±´';

    var bhtml = '';
    pageData.forEach(function(r) {
        bhtml += '<tr onclick="openDetailModal(\'' + r.id + '\',' + r._sampleIdx + ')">';
        visibleCols.forEach(function(col) {
            var val = r[col.key];
            if (val === undefined || val === null) val = '';
            if (col.key === 'status') {
                var tagCls = val === 'ì ‘ìˆ˜ì™„ë£Œ' ? 'tag-complete' : val === 'ì ‘ìˆ˜ì¤‘' ? 'tag-inprogress' : 'tag-waiting';
                val = '<span class="tag ' + tagCls + '">' + val + '</span>';
            } else if (col.key === 'trafficLight') {
                if (val) {
                    var tlLabels = {green:'ì •ìƒ',blue:'ì–‘í˜¸',yellow:'ì£¼ì˜',orange:'ê²½ê³ ',red:'ìœ„í—˜'};
                    val = '<span class="tl tl-' + val + '" data-tooltip="ìˆ˜ê¸ˆìƒíƒœ: ' + (tlLabels[val]||val) + '"></span>';
                } else { val = '-'; }
            } else if (col.key === 'grade') {
                if (val) {
                    var g = val.toLowerCase();
                    val = '<span class="tag tag-' + g + '">' + val + '</span>';
                } else { val = '-'; }
            } else if (col.key === 'feeSupply' || col.key === 'feeVat' || col.key === 'feeTotal') {
                val = val ? Number(val).toLocaleString() + 'ì›' : '-';
            } else if (col.key === 'urgent') {
                val = val === 'ê¸´ê¸‰' ? '<span style="color:#e53935;font-weight:700">âš¡ê¸´ê¸‰</span>' : 'ì¼ë°˜';
            } else if (col.key === 'reportSend') {
                val = r.reportSendText || '';
            } else if (col.key === 'sampleTotalCount') {
                val = val || 1;
            }
            bhtml += '<td>' + val + '</td>';
        });
        bhtml += '</tr>';
    });
    tbody.innerHTML = bhtml;

    // í˜ì´ì§€ë„¤ì´ì…˜
    renderPagination();
}

// ============================================================================
// í˜ì´ì§€ë„¤ì´ì…˜
// ============================================================================
function renderPagination() {
    var totalPages = Math.ceil(_filteredReceipts.length / _pageSize);
    if (totalPages <= 1) { document.getElementById('pagination').innerHTML = ''; return; }
    var html = '<button ' + (_page <= 1 ? 'disabled' : '') + ' onclick="goPage(' + (_page - 1) + ')">â—€</button>';
    for (var i = 1; i <= totalPages; i++) {
        if (totalPages > 7 && Math.abs(i - _page) > 2 && i !== 1 && i !== totalPages) {
            if (i === _page - 3 || i === _page + 3) html += '<span class="page-info">...</span>';
            continue;
        }
        html += '<button class="' + (i === _page ? 'active' : '') + '" onclick="goPage(' + i + ')">' + i + '</button>';
    }
    html += '<button ' + (_page >= totalPages ? 'disabled' : '') + ' onclick="goPage(' + (_page + 1) + ')">â–¶</button>';
    html += '<span class="page-info" style="margin-left:8px">' + _page + ' / ' + totalPages + '</span>';
    document.getElementById('pagination').innerHTML = html;
}
function goPage(p) { _page = p; renderTable(); }

// ============================================================================
// ì»¬ëŸ¼ ì„¤ì •
// ============================================================================
function toggleColSettings() {
    var panel = document.getElementById('col-settings-panel');
    panel.classList.toggle('active');
    if (panel.classList.contains('active')) renderColSettings();
}
function renderColSettings() {
    var panel = document.getElementById('col-settings-panel');
    var html = '<div style="font-size:12px;font-weight:700;margin-bottom:8px;color:#344054">ì»¬ëŸ¼ í‘œì‹œ ì„¤ì •</div>';
    ALL_COLUMNS.forEach(function(col, i) {
        html += '<label><input type="checkbox" ' + (col.visible ? 'checked' : '') + ' onchange="toggleColumn(' + i + ',this.checked)"> ' + col.label + '</label>';
    });
    panel.innerHTML = html;
}
function toggleColumn(idx, checked) {
    ALL_COLUMNS[idx].visible = checked;
    renderTable();
    // localStorageì— ì €ì¥
    var vis = {};
    ALL_COLUMNS.forEach(function(c) { vis[c.key] = c.visible; });
    localStorage.setItem('receiptStatus_columns', JSON.stringify(vis));
}
function loadColumnSettings() {
    var saved = localStorage.getItem('receiptStatus_columns');
    if (saved) {
        var vis = JSON.parse(saved);
        ALL_COLUMNS.forEach(function(c) {
            if (vis.hasOwnProperty(c.key)) c.visible = vis[c.key];
        });
    }
}

// íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    var wrap = document.querySelector('.col-settings-wrap');
    if (wrap && !wrap.contains(e.target)) {
        document.getElementById('col-settings-panel').classList.remove('active');
    }
});

// ============================================================================
// ìƒì„¸ ëª¨ë‹¬
// ============================================================================
function openDetailModal(id, sampleIdx) {
    var r = _allReceipts.find(function(x) { return x.id === id && x._sampleIdx === sampleIdx; });
    if (!r) return;
    var s = (r.samples && r.samples[sampleIdx]) || {};
    var sno = String(sampleIdx + 1).padStart(3, '0');

    document.getElementById('detail-title').textContent = 'ì‹œë£Œ ìƒì„¸ â€” ' + (r.receiptNo || '');
    // ì‹ í˜¸ë“±/ë“±ê¸‰ í‘œì‹œìš©
    var tlLabels = {green:'ì •ìƒ',blue:'ì–‘í˜¸',yellow:'ì£¼ì˜',orange:'ê²½ê³ ',red:'ìœ„í—˜'};
    var tlDisplay = r.trafficLight ? '<span class="tl tl-' + r.trafficLight + '"></span> ' + (tlLabels[r.trafficLight]||'') : '-';
    var gradeDisplay = r.grade ? '<span class="tag tag-' + r.grade.toLowerCase() + '">' + r.grade + '</span>' : '-';

    var html = '';
    // ê¸°ë³¸ì •ë³´
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin-bottom:10px">ğŸ“‹ ê¸°ë³¸ì •ë³´</div>';
    html += '<div class="detail-row">';
    html += di('ì ‘ìˆ˜ë²ˆí˜¸', r._baseReceiptNo);
    html += di('ì‹œë£Œë²ˆí˜¸', r.receiptNo);
    html += di('ì ‘ìˆ˜ì¼ì', r.receiptDate);
    html += di('ìƒíƒœ', r.status);
    html += di('ì‹œí—˜ë¶„ì•¼', r.testField);
    html += di('ê²€ì‚¬ëª©ì ', r.testPurpose);
    html += di('ê¸´ê¸‰ì—¬ë¶€', r.urgent);
    html += di('ì²˜ë¦¬ê¸°í•œ', r.processingDeadline);
    html += '</div>';
    // ì—…ì²´ì •ë³´
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin:16px 0 10px">ğŸ¢ ì—…ì²´ì •ë³´</div>';
    html += '<div class="detail-row">';
    html += di('ê±°ë˜ì²˜', r.companyName);
    html += '<div class="detail-item"><label>ì‹ í˜¸ë“±</label><div class="val">' + tlDisplay + '</div></div>';
    html += '<div class="detail-item"><label>ë“±ê¸‰</label><div class="val">' + gradeDisplay + '</div></div>';
    html += di('ì¸í—ˆê°€ë²ˆí˜¸', r.licNo);
    html += di('ì—…ì¢…/ì—…íƒœ', r.licBizForm);
    html += '</div>';
    html += '<div class="detail-row">';
    html += di('ì „í™”ë²ˆí˜¸', r.companyPhone);
    html += di('íŒ©ìŠ¤ë²ˆí˜¸', r.companyFax);
    html += di('íœ´ëŒ€ì „í™”', r.companyMobile);
    html += di('ë‹´ë‹¹ì', r.salesRep);
    html += '</div>';
    html += '<div class="detail-row">';
    html += di('ì£¼ì†Œ', r.companyAddress);
    html += '</div>';
    // í•´ë‹¹ ì‹œë£Œì •ë³´
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin:16px 0 10px">ğŸ§ª ì‹œë£Œì •ë³´</div>';
    html += '<div style="padding:10px;background:#f8f9fb;border-radius:8px;margin-bottom:8px;border:1px solid #eef0f4">';
    html += '<div class="detail-row">';
    html += di('ì œí’ˆ/ì‹œë£Œëª…', s.productName || r.productName);
    html += di('ì‹í’ˆìœ í˜•', s.foodType || r.foodType);
    html += di('ê²€ì²´ëŸ‰', (s.sampleAmount || '') + (s.sampleAmountUnit || ''));
    html += di('ê²€ì²´ìˆ˜', s.sampleCount);
    html += '</div>';
    html += '<div class="detail-row">';
    html += di('í¬ì¥ë‹¨ìœ„', s.packageUnit || s.packagingUnit);
    html += di('ìš´ë°˜ìƒíƒœ', s.transportStatus);
    html += di('ì œì¡°ì¼ì', s.manufactureDate);
    html += di('ì†Œë¹„ê¸°í•œ', s.expiryDate);
    html += '</div>';
    html += '<div class="detail-row">';
    html += di('ì‹œë£Œìœ„ì¹˜', s.sampleLocation);
    html += di('ì‹œë£Œë°•ìŠ¤ë²ˆí˜¸', s.sampleBoxNo);
    html += di('í’ˆëª©ì œì¡°NO', s.manufactureNo || s.productMfgNo);
    html += '</div>';
    html += '</div>';
    // ìˆ˜ìˆ˜ë£Œ ì •ë³´
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin:16px 0 10px">ğŸ’° ìˆ˜ìˆ˜ë£Œ ì •ë³´</div>';
    html += '<div class="detail-row">';
    html += di('ê³µê¸‰ê°€ì•¡', r.feeSupply ? Number(r.feeSupply).toLocaleString() + 'ì›' : '-');
    html += di('ì„¸ì•¡', r.feeVat ? Number(r.feeVat).toLocaleString() + 'ì›' : '-');
    html += di('ì´ê³„', r.feeTotal ? Number(r.feeTotal).toLocaleString() + 'ì›' : '-');
    html += di('ê²°ì œë°©ë²•', r.payMethod);
    html += di('ê²°ì œì¼', r.payDate);
    html += '</div>';
    // ê³„ì‚°ì„œ ì •ë³´
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin:16px 0 10px">ğŸ“„ ê³„ì‚°ì„œ ì •ë³´</div>';
    html += '<div class="detail-row">';
    html += di('ê³„ì‚°ì„œì—…ì²´', r.billCompany);
    html += di('ì‚¬ì—…ìë²ˆí˜¸', r.bizNo);
    html += di('ëŒ€í‘œì', r.ceo);
    html += di('ë‹´ë‹¹ìëª…', r.billName);
    html += '</div>';
    html += '<div class="detail-row">';
    html += di('ì „í™”', r.billPhone);
    html += di('íŒ©ìŠ¤', r.billFax);
    html += di('íœ´ëŒ€ì „í™”', r.billMobile);
    html += di('ì´ë©”ì¼', r.billEmail);
    html += '</div>';
    // ë°œì†¡ì •ë³´
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin:16px 0 10px">ğŸ“® ë°œì†¡ì •ë³´</div>';
    html += '<div class="detail-row">';
    html += di('ë°œì†¡ë°©ë²•', (r.reportSend || []).join(', '));
    html += di('íŒ©ìŠ¤ë²ˆí˜¸', r.reportFaxNo);
    html += di('ì´ë©”ì¼', r.reportEmail);
    html += di('CC', (r.emailCc || []).join(', '));
    html += '</div>';
    // ê²€ì‚¬ê´€ë ¨
    html += '<div style="font-size:13px;font-weight:700;color:#1a2332;margin:16px 0 10px">ğŸ“‘ ê²€ì‚¬ ê´€ë ¨</div>';
    html += '<div class="detail-row">';
    html += di('ê´€ë ¨ë²•ë ¹', r.relatedLaw);
    html += di('ë¬¸ì„œë²ˆí˜¸', r.documentNo);
    html += '</div>';

    document.getElementById('detail-body').innerHTML = html;
    document.getElementById('detail-modal').classList.add('active');
}
function di(label, val) {
    return '<div class="detail-item"><label>' + label + '</label><div class="val">' + (val || '-') + '</div></div>';
}
function closeDetailModal() {
    document.getElementById('detail-modal').classList.remove('active');
}
document.getElementById('detail-modal').addEventListener('click', function(e) {
    if (e.target === this) closeDetailModal();
});

// ============================================================================
// ì´ˆê¸°í™”
// ============================================================================
window.onload = function() {
    loadColumnSettings();
    loadReceipts();
    // ê¸°ë³¸ ë‚ ì§œ í•„í„° (ìµœê·¼ 30ì¼)
    var now = new Date();
    var from = new Date(now);
    from.setDate(from.getDate() - 30);
    document.getElementById('filter-to').value = now.toISOString().split('T')[0];
    document.getElementById('filter-from').value = from.toISOString().split('T')[0];
};
</script>
</body>
</html>
