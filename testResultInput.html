<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BioFoodLab LIMS - ê²°ê³¼ ì…ë ¥</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="js/firebase-init.js"></script>
<script src="js/firestore-helpers.js"></script>
<script src="js/mfds-api.js"></script>
<script src="js/mfds_templates.js"></script>
<style>
:root{--primary:#2563eb;--primary-light:#dbeafe;--success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;--danger:#ef4444;--danger-light:#fee2e2;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-600:#4b5563;--gray-700:#374151;--gray-900:#111827;--accent:#667eea;--accent2:#764ba2}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;background:#f5f5f5;color:#1a1a1a}
.app-layout{display:flex;height:100vh}

/* ====== UNIFIED SIDEBAR STYLES ====== */
.sidebar{width:250px;background:#1a2332;color:white;position:fixed;left:0;top:0;bottom:0;z-index:1000;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;font-family:'Pretendard',-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif}
.logo{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{display:flex;flex-direction:column}
.logo-title{font-size:18px;font-weight:700}
.logo-subtitle{font-size:11px;color:#94a3b8}
.sidebar-nav{flex:1;padding:8px 0;overflow-y:auto}
.nav-group{margin-bottom:2px}
.nav-parent{padding:10px 20px;display:flex;align-items:center;gap:10px;color:#8ea4c0;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;transition:all 0.15s;border:none;background:none;width:100%}
.nav-parent:hover{background:rgba(255,255,255,0.05);color:#c8d6e5}
.nav-parent.active{color:#4fc3f7;background:rgba(79,195,247,0.1);font-weight:600}
.nav-parent.disabled{color:#4a6785;cursor:default}
.nav-parent.disabled:hover{background:transparent;color:#4a6785}
.nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-arrow{font-size:10px;color:#5a6a7e;transition:transform 0.2s;margin-left:auto}
.nav-group.expanded .nav-arrow{transform:rotate(180deg)}
.nav-submenu{list-style:none;max-height:0;overflow:hidden;transition:max-height 0.25s ease;margin-left:32px;border-left:2px solid rgba(79,195,247,0.15);padding-left:10px}
.nav-group.expanded .nav-submenu{max-height:500px}
.nav-sub-item{display:block;padding:7px 12px;font-size:12px;color:#6b7d93;text-decoration:none;border-radius:6px;cursor:pointer;transition:all 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-sub-item:hover{color:#8ea4c0;background:rgba(255,255,255,0.03)}
.nav-sub-item.active{color:#4fc3f7;font-weight:600;background:rgba(79,195,247,0.08)}
.nav-sub-item.disabled{color:#3d5068;cursor:default}
.nav-sub-item.disabled:hover{background:transparent;color:#3d5068}
/* ====== END UNIFIED SIDEBAR STYLES ====== */

.main-container{flex:1;margin-left:250px;display:flex;flex-direction:column;overflow:hidden;transition:margin-left 0.25s ease}
body.sidebar-collapsed .main-container{margin-left:64px}
.top-header{background:white;padding:16px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:#64748b}
.breadcrumb-current{color:#1e293b;font-weight:600}
.server-status{display:flex;align-items:center;gap:6px;font-size:12px;padding:4px 12px;border-radius:20px;background:#f1f5f9}
.server-status.online{color:#16a34a;background:#f0fdf4}
.server-status.offline{color:#dc2626;background:#fef2f2}
.main-content{flex:1;overflow-y:auto;padding:20px}

/* Stats */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:16px}
.stat-card{background:white;padding:16px 20px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;align-items:center;gap:14px}
.stat-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.stat-info{flex:1}
.stat-value{font-size:24px;font-weight:700}
.stat-label{font-size:12px;color:#64748b}

/* Toolbar */
.toolbar{background:white;padding:16px 20px;border-radius:12px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.toolbar-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
.toolbar-row:last-child{margin-bottom:0}
.search-box{position:relative;flex:1;min-width:200px}
.search-box input{width:100%;padding:9px 14px 9px 36px;border:1px solid var(--gray-300);border-radius:8px;font-size:13px}
.search-box input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
.search-box::before{content:'ğŸ”';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px}
.filter-group{display:flex;gap:6px;align-items:center}
.filter-label{font-size:12px;font-weight:600;color:#64748b;min-width:40px}
.filter-chips{display:flex;gap:6px}
.filter-chip{padding:6px 14px;border-radius:18px;font-size:12px;background:var(--gray-100);color:var(--gray-700);cursor:pointer;border:2px solid transparent;transition:all 0.2s;font-weight:500}
.filter-chip:hover{background:var(--gray-200)}
.filter-chip.active{background:var(--primary);color:white;border-color:var(--primary)}
.form-select{padding:8px 12px;border:1px solid var(--gray-300);border-radius:8px;font-size:13px;background:white}
.form-select:focus{outline:none;border-color:var(--primary)}
input[type="date"]{padding:7px 10px;border:1px solid var(--gray-300);border-radius:8px;font-size:12px}

/* Split panel */
.split-panel{display:grid;grid-template-columns:340px 1fr;gap:16px;height:calc(100vh - 260px);min-height:500px}
.left-panel{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-direction:column}
.panel-header{padding:14px 18px;border-bottom:1px solid var(--gray-200);font-weight:700;font-size:14px;display:flex;justify-content:space-between;align-items:center;background:var(--gray-50)}
.panel-body{overflow-y:auto;flex:1}
.right-panel{overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;gap:16px;min-width:0}

/* Receipt list rows */
.receipt-row{padding:12px 16px;border-bottom:1px solid var(--gray-100);cursor:pointer;transition:background 0.15s}
.receipt-row:hover{background:var(--gray-50)}
.receipt-row.active{background:var(--primary-light);border-left:3px solid var(--primary)}
.receipt-row .row-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.receipt-row .row-no{font-weight:600;font-size:13px;color:var(--gray-900)}
.receipt-row .row-bottom{display:flex;gap:8px;align-items:center;font-size:11px;color:var(--gray-600)}
.receipt-row .row-company{font-size:12px;color:var(--gray-600)}
.empty-list{padding:40px;text-align:center;color:#999;font-size:14px}

/* Badges */
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.badge-primary{background:var(--primary-light);color:var(--primary)}
.badge-success{background:var(--success-light);color:var(--success)}
.badge-warning{background:var(--warning-light);color:var(--warning)}
.badge-danger{background:var(--danger-light);color:var(--danger)}
.badge-gray{background:var(--gray-100);color:var(--gray-600)}

/* Accordion sections */
.section{border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;background:white}
.section-header{padding:14px 20px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:14px;color:var(--gray-600);background:white;border-left:4px solid var(--gray-300);transition:all 0.2s}
.section-header:hover{background:var(--gray-50);color:var(--gray-800)}
.section-header.active{color:var(--accent);border-left-color:var(--accent);background:#f8f7ff}
.section-content{max-height:0;overflow:hidden;padding:0 20px;transition:max-height 0.3s ease,padding 0.3s ease}
.section-content.active{max-height:2000px;padding:20px;overflow:visible}
.toggle-icon{font-size:12px;transition:transform 0.2s;color:var(--gray-400)}
.section-header.active .toggle-icon{transform:rotate(180deg);color:var(--accent)}

/* Form */
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:14px}
.form-row:last-child{margin-bottom:0}
.form-group{display:flex;flex-direction:column}
.form-group label{font-weight:500;margin-bottom:6px;color:#333;font-size:13px}
.form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px;transition:all 0.2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
.form-group input[readonly]{background:#f8f9fa;color:#666}
.required{color:#f44336;margin-left:2px}

/* Result table */
.result-table-wrap{overflow-x:auto;margin-top:12px}
.result-table{width:100%;border-collapse:collapse;font-size:13px}
.result-table thead{background:var(--gray-50);border-bottom:2px solid var(--gray-200)}
.result-table th{padding:10px 12px;text-align:left;font-size:12px;font-weight:600;color:var(--gray-700);white-space:nowrap}
.result-table tbody tr{border-bottom:1px solid var(--gray-100);transition:background 0.15s}
.result-table tbody tr:hover{background:var(--gray-50)}
.result-table td{padding:10px 12px;vertical-align:middle}
.result-input{width:120px;padding:7px 10px;border:1px solid var(--gray-300);border-radius:6px;font-size:13px;text-align:center;font-weight:500}
.result-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(37,99,235,0.15)}
.result-input.pass{border-color:var(--success);background:#f0fdf4}
.result-input.fail{border-color:var(--danger);background:#fef2f2}
.remark-input{width:100%;min-width:80px;padding:6px 8px;border:1px solid var(--gray-200);border-radius:6px;font-size:12px}
.quick-btns{display:flex;gap:3px;margin-top:3px}
.quick-btn{padding:2px 7px;font-size:10px;border-radius:4px;cursor:pointer;border:1px solid var(--gray-300);background:white;color:var(--gray-600);transition:all 0.15s}
.quick-btn:hover{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.override-select{padding:4px 6px;border:1px solid var(--warning);border-radius:6px;font-size:11px;background:var(--warning-light)}

/* Sample tabs */
.sample-tabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.sample-tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:500;background:var(--gray-100);color:var(--gray-700);cursor:pointer;border:2px solid transparent;transition:all 0.2s}
.sample-tab.active{background:var(--primary);color:white;border-color:var(--primary)}
.sample-tab .tab-badge{font-size:10px;margin-left:4px;opacity:0.8}

/* Overall result */
.overall-row{display:flex;align-items:center;gap:12px;margin-top:16px;padding:14px 18px;background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-200)}
.overall-label{font-weight:600;font-size:14px}
.overall-badge{font-size:16px;padding:5px 16px;border-radius:8px;font-weight:700}
.overall-badge.pass{background:var(--success-light);color:var(--success)}
.overall-badge.fail{background:var(--danger-light);color:var(--danger)}

/* Buttons */
.btn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:6px;transition:all 0.2s}
.btn:hover{opacity:0.9}
.btn-primary{background:var(--primary);color:white}
.btn-success{background:var(--success);color:white}
.btn-warning{background:var(--warning);color:white}
.btn-danger{background:var(--danger);color:white}
.btn-outline{background:white;color:var(--gray-700);border:1px solid var(--gray-300)}
.btn-outline:hover{background:var(--gray-50)}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-group{display:flex;gap:10px;align-items:center;margin-top:16px;flex-wrap:wrap}

/* No selection placeholder */
.no-selection{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:400px;color:#aaa;font-size:15px;gap:12px}
.no-selection .icon{font-size:48px;opacity:0.3}

/* MFDS info */
.mfds-info{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:16px;font-size:12px;background:#e3f2fd;color:#1565c0;margin-top:8px}
.mfds-info.submitted{background:#e8f5e9;color:#2e7d32}

/* Alert */
.alert{padding:12px 16px;border-radius:8px;font-size:13px;margin-bottom:12px}
.alert-info{background:#e3f2fd;color:#1565c0;border:1px solid #bbdefb}
.alert-warning{background:var(--warning-light);color:#92400e;border:1px solid #fde68a}
.alert-success{background:var(--success-light);color:#065f46;border:1px solid #a7f3d0}

/* Toast */
.toast{position:fixed;top:20px;right:20px;padding:14px 22px;border-radius:10px;color:white;font-size:14px;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,0.2);display:none;z-index:3000;min-width:260px;animation:slideIn 0.3s}
.toast.active{display:block}
.toast.success{background:#10b981}
.toast.error{background:#ef4444}
.toast.warning{background:#f59e0b}
.toast.info{background:#2563eb}
@keyframes slideIn{from{transform:translateX(300px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Modal */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:white;border-radius:14px;width:90%;max-width:560px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.modal-header{padding:18px 24px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:16px}
.modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:var(--gray-600);padding:4px}
.modal-body{padding:24px;overflow-y:auto;max-height:60vh}
.modal-footer{padding:16px 24px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:10px}

/* Responsive */
@media(max-width:1200px){
  .split-panel{grid-template-columns:300px 1fr}
}
@media(max-width:1000px){
  .split-panel{grid-template-columns:1fr;height:auto}
  .left-panel{max-height:300px}
  .stats-row{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:768px){
  .main-container{margin-left:0!important}
  .stats-row{grid-template-columns:1fr}
  .toolbar-row{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>
<div class="app-layout">
  <aside class="sidebar" id="sidebar"></aside>
  <div class="main-container">
    <!-- Header -->
    <header class="top-header">
      <div class="breadcrumb">
        <span>ì‹œí—˜ ê²°ì¬</span><span style="color:#cbd5e1">â€º</span>
        <span class="breadcrumb-current">ê²°ê³¼ ì…ë ¥</span>
      </div>
      <div class="server-status" id="server-status">
        <span id="server-status-icon">â³</span>
        <span id="server-status-text">ì—°ê²° í™•ì¸ì¤‘...</span>
      </div>
    </header>

    <main class="main-content">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background:#dbeafe;color:#2563eb">ğŸ“‹</div>
          <div class="stat-info"><div class="stat-value" id="stat-total">0</div><div class="stat-label">ì „ì²´ ì ‘ìˆ˜</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#fef3c7;color:#f59e0b">ğŸ”¬</div>
          <div class="stat-info"><div class="stat-value" id="stat-testing">0</div><div class="stat-label">ì‹œí—˜ì¤‘</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#d1fae5;color:#10b981">âœ…</div>
          <div class="stat-info"><div class="stat-value" id="stat-done">0</div><div class="stat-label">ê²°ê³¼ì…ë ¥ì™„ë£Œ</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#fee2e2;color:#ef4444">â°</div>
          <div class="stat-info"><div class="stat-value" id="stat-pending">0</div><div class="stat-label">ë¯¸ì…ë ¥</div></div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="toolbar-row">
          <div class="search-box">
            <input type="text" id="search-input" placeholder="ì ‘ìˆ˜ë²ˆí˜¸, ê±°ë˜ì²˜, ì œí’ˆëª… ê²€ìƒ‰..." oninput="debounceSearch()">
          </div>
          <div class="filter-group">
            <div class="filter-label">ë¶„ì•¼</div>
            <div class="filter-chips">
              <button class="filter-chip active" onclick="setFilter('field','ì „ì²´',this)">ì „ì²´</button>
              <button class="filter-chip" onclick="setFilter('field','ì‹í’ˆ',this)">ì‹í’ˆ</button>
              <button class="filter-chip" onclick="setFilter('field','ì¶•ì‚°',this)">ì¶•ì‚°</button>
            </div>
          </div>
          <div class="filter-group">
            <div class="filter-label">ìƒíƒœ</div>
            <div class="filter-chips">
              <button class="filter-chip active" onclick="setFilter('status','ì „ì²´',this)">ì „ì²´</button>
              <button class="filter-chip" onclick="setFilter('status','ì ‘ìˆ˜ì™„ë£Œ',this)">ì ‘ìˆ˜ì™„ë£Œ</button>
              <button class="filter-chip" onclick="setFilter('status','ì‹œí—˜ì¤‘',this)">ì‹œí—˜ì¤‘</button>
              <button class="filter-chip" onclick="setFilter('status','ê²°ê³¼ì…ë ¥ì™„ë£Œ',this)">ì™„ë£Œ</button>
            </div>
          </div>
        </div>
        <div class="toolbar-row">
          <div class="filter-group">
            <div class="filter-label">ë‹´ë‹¹ì</div>
            <select id="filter-tester" class="form-select" style="width:160px" onchange="applyFilters()">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div class="filter-group">
            <div class="filter-label">ê¸°ê°„</div>
            <input type="date" id="filter-from" onchange="applyFilters()">
            <span style="color:#aaa;font-size:12px">~</span>
            <input type="date" id="filter-to" onchange="applyFilters()">
          </div>
          <div style="margin-left:auto;font-size:12px;color:#999" id="list-count">0ê±´</div>
        </div>
      </div>

      <!-- Split Panel -->
      <div class="split-panel">
        <!-- Left: Receipt list -->
        <div class="left-panel">
          <div class="panel-header">
            <span>ì ‘ìˆ˜ ëª©ë¡</span>
            <button class="btn btn-sm btn-outline" onclick="loadReceipts()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
          </div>
          <div class="panel-body" id="receipt-list">
            <div class="empty-list">ë°ì´í„° ë¡œë”©ì¤‘...</div>
          </div>
        </div>

        <!-- Right: Result input -->
        <div class="right-panel" id="right-panel">
          <div class="no-selection">
            <div class="icon">ğŸ”¬</div>
            <div>ì¢Œì¸¡ ëª©ë¡ì—ì„œ ì ‘ìˆ˜ê±´ì„ ì„ íƒí•˜ì„¸ìš”</div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><span id="toast-msg"></span></div>

<!-- MFDS Confirm Modal -->
<div class="modal-overlay" id="mfds-modal">
  <div class="modal">
    <div class="modal-header">
      <span>ì‹ì•½ì²˜ ì „ì†¡ í™•ì¸</span>
      <button class="modal-close" onclick="closeMfdsModal()">&times;</button>
    </div>
    <div class="modal-body" id="mfds-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeMfdsModal()">ì·¨ì†Œ</button>
      <button class="btn btn-success" onclick="confirmMfdsSubmit()">ì „ì†¡</button>
    </div>
  </div>
</div>

<script src="js/sidebar.js?v=3"></script>
<script>
/* ============================================================
   ì „ì—­ ë³€ìˆ˜
   ============================================================ */
var allReceipts = [];
var filteredReceipts = [];
var currentReceipt = null;      // ì„ íƒëœ ì ‘ìˆ˜
var currentSampleIdx = 0;       // í˜„ì¬ ì‹œë£Œ ì¸ë±ìŠ¤ (0-based)
var currentTestItems = [];      // í˜„ì¬ ì‹œë£Œì˜ ì‹œí—˜í•­ëª© ë°°ì—´
var currentResults = {};        // sampleIdxë³„ ê²°ê³¼ {0: [{...}], 1: [{...}]}
var currentDiary = {};          // ì‹œí—˜ì¼ì§€ ë°ì´í„°
var savedTestResults = {};      // Firestoreì—ì„œ ë¡œë“œí•œ ê¸°ì¡´ ê²°ê³¼
var isModified = false;
var MFDS_ENABLED = false;       // ê¸°ë³¸: ë¹„í™œì„±í™” (ì•ˆì „)

// í•„í„° ìƒíƒœ
var filters = { field: 'ì „ì²´', status: 'ì „ì²´', tester: '', search: '', dateFrom: '', dateTo: '' };
var searchTimer = null;

// MFDS Templates ìºì‹œ
var _mfdsTemplatesCache = null;
var _mfdsTemplatesLoaded = false;

/* ============================================================
   ì´ˆê¸°í™”
   ============================================================ */
window.addEventListener('firebase-ready', function() {
  init();
});

async function init() {
  checkMfdsStatus();
  loadMfdsEnabled();
  await loadMfdsTemplatesData();
  await loadReceipts();
  handleUrlParams();
}

function checkMfdsStatus() {
  var el = document.getElementById('server-status');
  var icon = document.getElementById('server-status-icon');
  var text = document.getElementById('server-status-text');
  if (typeof MFDS !== 'undefined' && MFDS.testConnection) {
    MFDS.testConnection().then(function(ok) {
      if (ok) {
        el.className = 'server-status online';
        icon.textContent = 'ğŸŸ¢';
        text.textContent = 'API ì˜¨ë¼ì¸';
      } else {
        el.className = 'server-status offline';
        icon.textContent = 'ğŸ”´';
        text.textContent = 'API ì˜¤í”„ë¼ì¸';
      }
    }).catch(function() {
      el.className = 'server-status offline';
      icon.textContent = 'ğŸ”´';
      text.textContent = 'API ì˜¤í”„ë¼ì¸';
    });
  } else {
    el.className = 'server-status offline';
    icon.textContent = 'âšª';
    text.textContent = 'MFDS ëª¨ë“ˆ ì—†ìŒ';
  }
}

function loadMfdsEnabled() {
  var v = localStorage.getItem('bfl_mfds_result_enabled');
  MFDS_ENABLED = v === '1';
}

async function loadMfdsTemplatesData() {
  try {
    if (typeof MFDS_TEMPLATES !== 'undefined' && MFDS_TEMPLATES.length > 0) {
      _mfdsTemplatesCache = MFDS_TEMPLATES;
      _mfdsTemplatesLoaded = true;
      return;
    }
    var snap = await db.collection('mfdsTemplates').get();
    _mfdsTemplatesCache = snap.docs.map(function(d) { return d.data(); });
    _mfdsTemplatesLoaded = true;
  } catch(e) {
    console.warn('MFDS Templates ë¡œë“œ ì‹¤íŒ¨:', e);
    _mfdsTemplatesCache = [];
    _mfdsTemplatesLoaded = true;
  }
}

/* ============================================================
   ì ‘ìˆ˜ ëª©ë¡ ë¡œë“œ
   ============================================================ */
async function loadReceipts() {
  try {
    document.getElementById('receipt-list').innerHTML = '<div class="empty-list">ë¡œë”©ì¤‘...</div>';
    var snap = await db.collection('receipts').orderBy('createdAt', 'desc').limit(200).get();
    allReceipts = snap.docs.map(function(d) {
      return Object.assign({ id: d.id }, d.data());
    });
    applyFilters();
    updateStats();
  } catch(e) {
    console.error('ì ‘ìˆ˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
    document.getElementById('receipt-list').innerHTML = '<div class="empty-list">ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</div>';
  }
}

/* ============================================================
   í•„í„°/ê²€ìƒ‰
   ============================================================ */
function setFilter(type, value, el) {
  filters[type] = value;
  // UI: ê°™ì€ ê·¸ë£¹ ë‚´ ì¹© active í† ê¸€
  var parent = el.parentElement;
  parent.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
  el.classList.add('active');
  applyFilters();
}

function debounceSearch() {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(function() {
    filters.search = document.getElementById('search-input').value.trim().toLowerCase();
    applyFilters();
  }, 300);
}

function applyFilters() {
  filters.tester = document.getElementById('filter-tester').value;
  filters.dateFrom = document.getElementById('filter-from').value;
  filters.dateTo = document.getElementById('filter-to').value;

  filteredReceipts = allReceipts.filter(function(r) {
    // ë¶„ì•¼
    if (filters.field !== 'ì „ì²´' && r.testField !== filters.field) return false;
    // ìƒíƒœ: ì ‘ìˆ˜ì™„ë£Œ, ì‹œí—˜ì¤‘, ê²°ê³¼ì…ë ¥ì™„ë£Œë§Œ í‘œì‹œ
    var validStatuses = ['ì ‘ìˆ˜ì™„ë£Œ', 'ì‹œí—˜ì¤‘', 'ê²°ê³¼ì…ë ¥ì™„ë£Œ'];
    if (!validStatuses.includes(r.status || '')) return false;
    if (filters.status !== 'ì „ì²´' && r.status !== filters.status) return false;
    // ë‹´ë‹¹ì
    if (filters.tester && r.testerName !== filters.tester) return false;
    // í…ìŠ¤íŠ¸ ê²€ìƒ‰
    if (filters.search) {
      var q = filters.search;
      var haystack = ((r.receiptNo || '') + ' ' + (r.companyName || '') + ' ' + getSampleNames(r)).toLowerCase();
      if (haystack.indexOf(q) === -1) return false;
    }
    // ë‚ ì§œ
    var rd = r.receiptDate || '';
    if (filters.dateFrom && rd < filters.dateFrom) return false;
    if (filters.dateTo && rd > filters.dateTo) return false;
    return true;
  });

  renderReceiptList();
  document.getElementById('list-count').textContent = filteredReceipts.length + 'ê±´';
}

function getSampleNames(r) {
  if (!r.samples || !r.samples.length) return '';
  return r.samples.map(function(s) { return s.productName || ''; }).join(' ');
}

/* ============================================================
   í†µê³„ ì¹´ë“œ
   ============================================================ */
function updateStats() {
  var total = 0, testing = 0, done = 0, pending = 0;
  allReceipts.forEach(function(r) {
    if (r.status === 'ì ‘ìˆ˜ì™„ë£Œ') { total++; pending++; }
    else if (r.status === 'ì‹œí—˜ì¤‘') { total++; testing++; }
    else if (r.status === 'ê²°ê³¼ì…ë ¥ì™„ë£Œ') { total++; done++; }
  });
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-testing').textContent = testing;
  document.getElementById('stat-done').textContent = done;
  document.getElementById('stat-pending').textContent = pending;
}

/* ============================================================
   ì ‘ìˆ˜ ëª©ë¡ ë Œë”ë§
   ============================================================ */
function renderReceiptList() {
  var wrap = document.getElementById('receipt-list');
  if (!filteredReceipts.length) {
    wrap.innerHTML = '<div class="empty-list">ì¡°ê±´ì— ë§ëŠ” ì ‘ìˆ˜ê±´ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  wrap.innerHTML = filteredReceipts.map(function(r, i) {
    var statusBadge = getStatusBadge(r.status);
    var fieldBadge = r.testField === 'ì¶•ì‚°' ? '<span class="badge badge-danger">ì¶•ì‚°</span>' : '<span class="badge badge-primary">ì‹í’ˆ</span>';
    var sampleCnt = (r.samples && r.samples.length) || 0;
    var isActive = currentReceipt && currentReceipt.id === r.id ? ' active' : '';
    return '<div class="receipt-row' + isActive + '" onclick="selectReceipt(\'' + r.id + '\')">' +
      '<div class="row-top"><span class="row-no">' + (r.receiptNo || '-') + '</span>' + statusBadge + '</div>' +
      '<div class="row-bottom">' + fieldBadge + ' <span class="row-company">' + (r.companyName || '-') + '</span>' +
      '<span style="margin-left:auto">ì‹œë£Œ ' + sampleCnt + 'ê±´</span></div>' +
      '</div>';
  }).join('');
}

function getStatusBadge(status) {
  if (status === 'ì ‘ìˆ˜ì™„ë£Œ') return '<span class="badge badge-gray">ì ‘ìˆ˜ì™„ë£Œ</span>';
  if (status === 'ì‹œí—˜ì¤‘') return '<span class="badge badge-warning">ì‹œí—˜ì¤‘</span>';
  if (status === 'ê²°ê³¼ì…ë ¥ì™„ë£Œ') return '<span class="badge badge-success">ê²°ê³¼ì™„ë£Œ</span>';
  return '<span class="badge badge-gray">' + (status || '-') + '</span>';
}

/* ============================================================
   ì ‘ìˆ˜ ì„ íƒ â†’ ìš°ì¸¡ íŒ¨ë„ ë Œë”ë§
   ============================================================ */
async function selectReceipt(receiptId) {
  var r = allReceipts.find(function(x) { return x.id === receiptId; });
  if (!r) return;
  currentReceipt = r;
  currentSampleIdx = 0;
  currentResults = {};
  currentDiary = {};
  savedTestResults = {};

  // ëª©ë¡ì—ì„œ active í‘œì‹œ
  document.querySelectorAll('.receipt-row').forEach(function(el) { el.classList.remove('active'); });
  var rows = document.querySelectorAll('.receipt-row');
  var idx = filteredReceipts.findIndex(function(x) { return x.id === receiptId; });
  if (rows[idx]) rows[idx].classList.add('active');

  // ê¸°ì¡´ ê²°ê³¼ ë¡œë“œ
  try {
    var results = await fsGetTestResults(r.receiptNo);
    results.forEach(function(tr) {
      savedTestResults[tr.sampleIdx] = tr;
      currentResults[tr.sampleIdx] = (tr.items || []).map(function(it) { return Object.assign({}, it); });
      if (!currentDiary.testStartDate && tr.testStartDate) {
        currentDiary = { testStartDate: tr.testStartDate, testEndDate: tr.testEndDate, testerName: tr.testerName, diaryMemo: tr.diaryMemo, exprDiarySn: tr.exprDiarySn };
      }
    });
  } catch(e) { console.warn('ê¸°ì¡´ ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', e); }

  renderRightPanel();
  isModified = false;
}

function renderRightPanel() {
  var r = currentReceipt;
  if (!r) return;
  var panel = document.getElementById('right-panel');

  var html = '';
  // Section 1: ê¸°ë³¸ì •ë³´
  html += '<div class="section"><div class="section-header active" onclick="toggleSection(this)"><span>ğŸ“‹ ì ‘ìˆ˜ ê¸°ë³¸ì •ë³´</span><span class="toggle-icon">â–¼</span></div>';
  html += '<div class="section-content active">';
  html += '<div class="form-row">';
  html += formGroupRO('ì ‘ìˆ˜ë²ˆí˜¸', r.receiptNo || '-');
  html += formGroupRO('ì ‘ìˆ˜ì¼ì', r.receiptDate || '-');
  html += formGroupRO('ê±°ë˜ì²˜', r.companyName || '-');
  html += '</div><div class="form-row">';
  html += formGroupRO('ì‹œí—˜ë¶„ì•¼', r.testField || '-');
  html += formGroupRO('ê²€ì‚¬ëª©ì ', r.testPurpose || '-');
  html += '<div class="form-group"><label>ìƒíƒœ</label><div>' + getStatusBadge(r.status) + '</div></div>';
  html += '</div></div></div>';

  // Section 2: ì‹œí—˜ì¼ì§€
  html += '<div class="section"><div class="section-header active" onclick="toggleSection(this)"><span>ğŸ““ ì‹œí—˜ì¼ì§€</span><span class="toggle-icon">â–¼</span></div>';
  html += '<div class="section-content active">';
  html += '<div class="form-row">';
  html += '<div class="form-group"><label>ì‹œí—˜ì‹œì‘ì¼ <span class="required">*</span></label><input type="date" id="diary-start" value="' + (currentDiary.testStartDate || today()) + '" onchange="markModified()"></div>';
  html += '<div class="form-group"><label>ì‹œí—˜ì¢…ë£Œì¼</label><input type="date" id="diary-end" value="' + (currentDiary.testEndDate || '') + '" onchange="markModified()"></div>';
  html += '<div class="form-group"><label>ì‹œí—˜ì</label><input type="text" id="diary-tester" value="' + (currentDiary.testerName || '') + '" placeholder="ì‹œí—˜ìëª… ì…ë ¥" onchange="markModified()"></div>';
  html += '</div>';
  html += '<div class="form-group"><label>ì‹œí—˜ ë©”ëª¨</label><textarea id="diary-memo" rows="2" placeholder="ì‹œí—˜ ì§„í–‰ ê´€ë ¨ ë©”ëª¨..." onchange="markModified()">' + (currentDiary.diaryMemo || '') + '</textarea></div>';
  if (currentDiary.exprDiarySn) {
    html += '<div class="mfds-info submitted">ì‹ì•½ì²˜ ì‹œí—˜ì¼ì§€ ë“±ë¡ ì™„ë£Œ (SN: ' + currentDiary.exprDiarySn + ')</div>';
  }
  html += '</div></div>';

  // Section 3: ê²°ê³¼ ì…ë ¥
  html += '<div class="section"><div class="section-header active" onclick="toggleSection(this)"><span>ğŸ”¬ ê²°ê³¼ ì…ë ¥</span><span class="toggle-icon">â–¼</span></div>';
  html += '<div class="section-content active">';

  // ì‹œë£Œ íƒ­
  var samples = r.samples || [];
  if (samples.length > 1) {
    html += '<div class="sample-tabs" id="sample-tabs">';
    samples.forEach(function(s, i) {
      var cls = i === currentSampleIdx ? ' active' : '';
      var label = 'ì‹œë£Œ ' + (i + 1);
      if (s.productName) label += ' (' + s.productName + ')';
      html += '<button class="sample-tab' + cls + '" onclick="switchSample(' + i + ')">' + label + '</button>';
    });
    html += '</div>';
  }

  // í˜„ì¬ ì‹œë£Œ ì •ë³´
  var sample = samples[currentSampleIdx] || {};
  html += '<div class="alert alert-info" id="sample-info">';
  html += '<strong>ì œí’ˆëª…:</strong> ' + (sample.productName || '-');
  html += ' | <strong>ê²€ì²´ìœ í˜•:</strong> ' + (sample.foodType || '-');
  html += ' | <strong>í’ˆëª©ì½”ë“œ:</strong> ' + (sample.mfdsProductCode || '-');
  html += '</div>';

  // ê²°ê³¼ í…Œì´ë¸”
  html += '<div class="result-table-wrap"><table class="result-table"><thead><tr>';
  html += '<th style="width:40px">No</th><th>ì‹œí—˜í•­ëª©</th><th>í•­ëª©ì½”ë“œ</th><th>ê¸°ì¤€ê·œê²©</th><th>ë‹¨ìœ„</th>';
  html += '<th style="width:140px">ì¸¡ì •ê°’</th><th style="width:90px">íŒì •</th><th style="width:60px">ìˆ˜ë™</th><th>ë¹„ê³ </th>';
  html += '</tr></thead><tbody id="result-tbody"></tbody></table></div>';

  // ì¢…í•© íŒì •
  html += '<div class="overall-row"><span class="overall-label">ì¢…í•© íŒì •:</span><span class="overall-badge pass" id="overall-badge">-</span></div>';

  html += '</div></div>';

  // Section 4: ë²„íŠ¼ ì˜ì—­
  html += '<div class="btn-group">';
  html += '<button class="btn btn-outline" onclick="cancelEdit()">ì·¨ì†Œ</button>';
  html += '<button class="btn btn-primary" id="save-btn" onclick="saveResults()">ğŸ’¾ Firestore ì €ì¥</button>';
  html += '<button class="btn btn-success" onclick="openMfdsModal()">ğŸ›ï¸ ì‹ì•½ì²˜ ì „ì†¡</button>';
  html += '<label style="margin-left:8px;display:flex;align-items:center;gap:4px;font-size:12px;color:#999;cursor:pointer">';
  html += '<input type="checkbox" id="mfds-toggle" ' + (MFDS_ENABLED ? 'checked' : '') + ' onchange="toggleMfdsEnabled()">';
  html += 'ì‹ì•½ì²˜ ì „ì†¡ í™œì„±í™”</label>';
  html += '</div>';

  panel.innerHTML = html;

  // ì‹œí—˜í•­ëª© ë¡œë“œ í›„ í…Œì´ë¸” ë Œë”ë§
  loadAndRenderItems();
}

function formGroupRO(label, value) {
  return '<div class="form-group"><label>' + label + '</label><input type="text" value="' + value + '" readonly></div>';
}

function today() {
  var d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

/* ============================================================
   ì‹œí—˜í•­ëª© ë¡œë“œ ë° í…Œì´ë¸” ë Œë”ë§
   ============================================================ */
function loadAndRenderItems() {
  var r = currentReceipt;
  var sample = (r.samples || [])[currentSampleIdx] || {};

  currentTestItems = findTestItems(r, sample);

  // ê¸°ì¡´ ì €ì¥ëœ ê²°ê³¼ ë³µì›
  var savedItems = currentResults[currentSampleIdx] || [];

  var tbody = document.getElementById('result-tbody');
  if (!tbody) return;

  if (!currentTestItems.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:#999">ì‹œí—˜í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }

  tbody.innerHTML = currentTestItems.map(function(item, idx) {
    var saved = savedItems[idx] || {};
    var mv = saved.measuredValue || '';
    var jr = saved.judgmentResult || '';
    var rm = saved.remarks || '';
    var mo = saved.manualOverride || false;
    var judgeBadge = jr ? getJudgeBadge(jr) : '<span class="badge badge-gray">-</span>';
    var inputClass = jr === 'ì í•©' ? 'pass' : (jr === 'ë¶€ì í•©' ? 'fail' : '');

    var quickBtns = '';
    if (isTextJudgment(item)) {
      quickBtns = '<div class="quick-btns">';
      quickBtns += '<button class="quick-btn" onclick="quickInput(' + idx + ',\'ë¶ˆê²€ì¶œ\')">ë¶ˆê²€ì¶œ</button>';
      quickBtns += '<button class="quick-btn" onclick="quickInput(' + idx + ',\'ìŒì„±\')">ìŒì„±</button>';
      quickBtns += '<button class="quick-btn" onclick="quickInput(' + idx + ',\'ê²€ì¶œ\')">ê²€ì¶œ</button>';
      quickBtns += '</div>';
    }

    var overrideHtml = '<input type="checkbox" title="ìˆ˜ë™ íŒì •" ' + (mo ? 'checked' : '') + ' onchange="toggleOverride(' + idx + ',this)">';
    if (mo) {
      overrideHtml += '<select class="override-select" onchange="manualJudge(' + idx + ',this.value)">';
      overrideHtml += '<option value="ì í•©"' + (jr === 'ì í•©' ? ' selected' : '') + '>ì í•©</option>';
      overrideHtml += '<option value="ë¶€ì í•©"' + (jr === 'ë¶€ì í•©' ? ' selected' : '') + '>ë¶€ì í•©</option>';
      overrideHtml += '</select>';
    }

    return '<tr>' +
      '<td style="text-align:center">' + (idx+1) + '</td>' +
      '<td>' + (item.testItemName || '-') + '</td>' +
      '<td style="font-size:11px;color:#888">' + (item.testItemCode || '-') + '</td>' +
      '<td style="font-size:12px">' + (item.standard || '-') + '</td>' +
      '<td style="font-size:12px">' + (item.unit || '-') + '</td>' +
      '<td><input type="text" class="result-input ' + inputClass + '" data-idx="' + idx + '" value="' + mv + '" placeholder="ì…ë ¥" oninput="onResultInput(' + idx + ',this)">' + quickBtns + '</td>' +
      '<td id="judge-' + idx + '">' + judgeBadge + '</td>' +
      '<td>' + overrideHtml + '</td>' +
      '<td><input type="text" class="remark-input" data-idx="' + idx + '" value="' + rm + '" placeholder="ë¹„ê³ " oninput="markModified()"></td>' +
      '</tr>';
  }).join('');

  calculateOverallResult();
}

function findTestItems(receipt, sample) {
  // 1. ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸): ê°œë³„ ì¶”ê°€ëœ í•­ëª© ì‚¬ìš©
  if (sample.refTestItems && sample.refTestItems.length > 0) {
    return sample.refTestItems.map(function(ri) {
      var tpl = findTemplateItem(ri.testCode);
      return {
        testItemCode: ri.testCode || '',
        testItemName: ri.itemName || '',
        standard: (tpl && tpl.standard) || '-',
        unit: ri.unit || (tpl && tpl.unit) || '',
        fee: ri.fee || 0,
        judgmentType: (tpl && tpl.judgmentType) || '',
        maxValue: (tpl && tpl.maxValue) || '',
        maxValueCode: (tpl && tpl.maxValueCode) || '',
        minValue: (tpl && tpl.minValue) || '',
        minValueCode: (tpl && tpl.minValueCode) || '',
        passText: (tpl && tpl.passText) || '',
        failText: (tpl && tpl.failText) || '',
        precision: (tpl && tpl.precision) || ''
      };
    });
  }

  // 2. MFDS Templates ë§¤ì¹­
  if (_mfdsTemplatesCache && sample.mfdsProductCode) {
    var tpl = _mfdsTemplatesCache.find(function(t) { return t.foodTypeCode === sample.mfdsProductCode; });
    if (tpl && tpl.testItems && tpl.testItems.length > 0) {
      return tpl.testItems.map(function(ti) {
        return {
          testItemCode: ti.testItemCode || '',
          testItemName: ti.testItemName || '',
          standard: ti.standard || '',
          unit: ti.unit || '',
          fee: ti.fee || 0,
          judgmentType: ti.judgmentType || '',
          maxValue: ti.maxValue || '',
          maxValueCode: ti.maxValueCode || '',
          minValue: ti.minValue || '',
          minValueCode: ti.minValueCode || '',
          passText: ti.passText || '',
          failText: ti.failText || '',
          precision: ti.precision || ''
        };
      });
    }
  }

  // 3. foodTypeName í´ë°± ë§¤ì¹­
  if (_mfdsTemplatesCache && sample.foodType) {
    var tpl2 = _mfdsTemplatesCache.find(function(t) {
      return t.templateName === sample.foodType || t.foodTypeName === sample.foodType;
    });
    if (tpl2 && tpl2.testItems && tpl2.testItems.length > 0) {
      return tpl2.testItems.map(function(ti) {
        return {
          testItemCode: ti.testItemCode || '',
          testItemName: ti.testItemName || '',
          standard: ti.standard || '',
          unit: ti.unit || '',
          fee: ti.fee || 0,
          judgmentType: ti.judgmentType || '',
          maxValue: ti.maxValue || '',
          maxValueCode: ti.maxValueCode || '',
          minValue: ti.minValue || '',
          minValueCode: ti.minValueCode || '',
          passText: ti.passText || '',
          failText: ti.failText || '',
          precision: ti.precision || ''
        };
      });
    }
  }

  return [];
}

function findTemplateItem(testCode) {
  if (!_mfdsTemplatesCache || !testCode) return null;
  for (var t = 0; t < _mfdsTemplatesCache.length; t++) {
    var items = _mfdsTemplatesCache[t].testItems || [];
    for (var i = 0; i < items.length; i++) {
      if (items[i].testItemCode === testCode) return items[i];
    }
  }
  return null;
}

/* ============================================================
   ì‹œë£Œ íƒ­ ì „í™˜
   ============================================================ */
function switchSample(idx) {
  // í˜„ì¬ ì‹œë£Œ ê²°ê³¼ ìˆ˜ì§‘
  collectCurrentResults();
  currentSampleIdx = idx;
  renderRightPanel();
}

/* ============================================================
   ìë™ íŒì • ì—”ì§„
   ============================================================ */
function onResultInput(idx, inputEl) {
  markModified();
  var item = currentTestItems[idx];
  var value = inputEl.value.trim();

  // ìˆ˜ë™ ìˆ˜ì • ëª¨ë“œë©´ ìë™ íŒì • ìŠ¤í‚µ
  var overrideCheckbox = inputEl.closest('tr').querySelector('input[type="checkbox"]');
  if (overrideCheckbox && overrideCheckbox.checked) return;

  var result = autoJudge(value, item);
  setJudgment(idx, result, inputEl);
  calculateOverallResult();
}

function autoJudge(value, item) {
  if (!value) return '';

  var std = (item.standard || '').trim();
  if (!std || std === '-') return 'ì í•©';  // ê¸°ì¤€ì—†ìŒ â†’ ì í•©

  // í…ìŠ¤íŠ¸ íŒì •: ë¶ˆê²€ì¶œ, ìŒì„± ë“±
  if (isTextJudgment(item) || isTextValue(std)) {
    return judgeByText(value, std, item);
  }

  // ìˆ«ì íŒì •
  var numVal = parseFloat(value);
  if (isNaN(numVal)) return judgeByText(value, std, item);

  return judgeByNumber(numVal, std, item);
}

function isTextJudgment(item) {
  var std = (item.standard || '').toLowerCase();
  return std.indexOf('ë¶ˆê²€ì¶œ') >= 0 || std.indexOf('ìŒì„±') >= 0 || std.indexOf('ê²€ì¶œ') >= 0 || std.indexOf('ì–‘ì„±') >= 0;
}

function isTextValue(std) {
  return std === 'ë¶ˆê²€ì¶œ' || std === 'ìŒì„±' || std === 'ê²€ì¶œë˜ì–´ì„œëŠ” ì•„ë‹ˆ ëœë‹¤' || std === 'ì–‘ì„±ì´ì–´ì„œëŠ” ì•„ë‹ˆëœë‹¤';
}

function judgeByText(value, std, item) {
  var v = value.trim();
  var s = std.trim();

  // ë¶ˆê²€ì¶œ/ìŒì„± ê¸°ì¤€
  if (s.indexOf('ë¶ˆê²€ì¶œ') >= 0 || s.indexOf('ê²€ì¶œë˜ì–´ì„œëŠ”') >= 0) {
    if (v === 'ë¶ˆê²€ì¶œ' || v === 'ND' || v === 'nd' || v === '0' || v === 'ìŒì„±') return 'ì í•©';
    if (v === 'ê²€ì¶œ' || v === 'ì–‘ì„±') return 'ë¶€ì í•©';
  }
  if (s.indexOf('ìŒì„±') >= 0 || s.indexOf('ì–‘ì„±ì´ì–´ì„œëŠ”') >= 0) {
    if (v === 'ìŒì„±' || v === 'negative' || v === 'ë¶ˆê²€ì¶œ' || v === 'ND') return 'ì í•©';
    if (v === 'ì–‘ì„±' || v === 'positive' || v === 'ê²€ì¶œ') return 'ë¶€ì í•©';
  }

  return 'ìˆ˜ë™íŒì •';
}

function judgeByNumber(numVal, std, item) {
  // maxValue / maxValueCode ì‚¬ìš© (ì´í•˜, ë¯¸ë§Œ)
  if (item.maxValue) {
    var max = parseFloat(item.maxValue);
    if (!isNaN(max)) {
      if (item.maxValueCode === 'ë¯¸ë§Œ' && numVal >= max) return 'ë¶€ì í•©';
      if (numVal > max) return 'ë¶€ì í•©';  // ì´í•˜ ê¸°ë³¸
    }
  }
  // minValue / minValueCode ì‚¬ìš© (ì´ìƒ, ì´ˆê³¼)
  if (item.minValue) {
    var min = parseFloat(item.minValue);
    if (!isNaN(min)) {
      if (item.minValueCode === 'ì´ˆê³¼' && numVal <= min) return 'ë¶€ì í•©';
      if (numVal < min) return 'ë¶€ì í•©';  // ì´ìƒ ê¸°ë³¸
    }
  }

  // ê¸°ì¤€ê·œê²© í…ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ íŒŒì‹± ì‹œë„
  var std2 = (item.standard || '').replace(/,/g, '');
  var match;

  // "Xì´í•˜" íŒ¨í„´
  match = std2.match(/([\d.]+)\s*ì´í•˜/);
  if (match) { if (numVal > parseFloat(match[1])) return 'ë¶€ì í•©'; return 'ì í•©'; }

  // "Xë¯¸ë§Œ" íŒ¨í„´
  match = std2.match(/([\d.]+)\s*ë¯¸ë§Œ/);
  if (match) { if (numVal >= parseFloat(match[1])) return 'ë¶€ì í•©'; return 'ì í•©'; }

  // "Xì´ìƒ" íŒ¨í„´
  match = std2.match(/([\d.]+)\s*ì´ìƒ/);
  if (match) { if (numVal < parseFloat(match[1])) return 'ë¶€ì í•©'; return 'ì í•©'; }

  // "X~Y" ë²”ìœ„ íŒ¨í„´
  match = std2.match(/([\d.]+)\s*[~\-]\s*([\d.]+)/);
  if (match) {
    var lo = parseFloat(match[1]), hi = parseFloat(match[2]);
    if (numVal < lo || numVal > hi) return 'ë¶€ì í•©';
    return 'ì í•©';
  }

  return 'ì í•©';
}

function setJudgment(idx, result, inputEl) {
  var cell = document.getElementById('judge-' + idx);
  if (cell) cell.innerHTML = result ? getJudgeBadge(result) : '<span class="badge badge-gray">-</span>';

  if (inputEl) {
    inputEl.classList.remove('pass', 'fail');
    if (result === 'ì í•©') inputEl.classList.add('pass');
    else if (result === 'ë¶€ì í•©') inputEl.classList.add('fail');
  }
}

function getJudgeBadge(result) {
  if (result === 'ì í•©') return '<span class="badge badge-success">ì í•©</span>';
  if (result === 'ë¶€ì í•©') return '<span class="badge badge-danger">ë¶€ì í•©</span>';
  if (result === 'ìˆ˜ë™íŒì •') return '<span class="badge badge-warning">ìˆ˜ë™</span>';
  return '<span class="badge badge-gray">' + result + '</span>';
}

function quickInput(idx, value) {
  var input = document.querySelector('.result-input[data-idx="' + idx + '"]');
  if (input) {
    input.value = value;
    onResultInput(idx, input);
  }
}

function toggleOverride(idx, checkbox) {
  markModified();
  // ìˆ˜ë™ ìˆ˜ì • ì‹œ ë“œë¡­ë‹¤ìš´ í‘œì‹œ ìœ„í•´ ì „ì²´ íŒ¨ë„ ì¬ë Œë”ë§
  collectCurrentResults();
  var saved = currentResults[currentSampleIdx] || [];
  if (saved[idx]) {
    saved[idx].manualOverride = checkbox.checked;
  }
  loadAndRenderItems();
}

function manualJudge(idx, value) {
  markModified();
  var cell = document.getElementById('judge-' + idx);
  if (cell) cell.innerHTML = getJudgeBadge(value);
  calculateOverallResult();
}

function calculateOverallResult() {
  var badge = document.getElementById('overall-badge');
  if (!badge) return;

  var allJudged = true;
  var anyFail = false;

  currentTestItems.forEach(function(item, idx) {
    var cell = document.getElementById('judge-' + idx);
    if (!cell) return;
    var text = cell.textContent.trim();
    if (!text || text === '-') { allJudged = false; return; }
    if (text === 'ë¶€ì í•©') anyFail = true;
  });

  if (!allJudged) {
    badge.textContent = '-';
    badge.className = 'overall-badge';
  } else if (anyFail) {
    badge.textContent = 'ë¶€ì í•©';
    badge.className = 'overall-badge fail';
  } else {
    badge.textContent = 'ì í•©';
    badge.className = 'overall-badge pass';
  }
}

/* ============================================================
   ê²°ê³¼ ìˆ˜ì§‘
   ============================================================ */
function collectCurrentResults() {
  if (!currentTestItems.length) return;

  var items = [];
  currentTestItems.forEach(function(item, idx) {
    var input = document.querySelector('.result-input[data-idx="' + idx + '"]');
    var remarkInput = document.querySelector('.remark-input[data-idx="' + idx + '"]');
    var judgeCell = document.getElementById('judge-' + idx);
    var overrideCb = input ? input.closest('tr').querySelector('input[type="checkbox"]') : null;

    var mv = input ? input.value.trim() : '';
    var jr = judgeCell ? judgeCell.textContent.trim() : '';
    if (jr === '-') jr = '';

    items.push({
      testItemCode: item.testItemCode || '',
      testItemName: item.testItemName || '',
      standard: item.standard || '',
      unit: item.unit || '',
      judgmentType: item.judgmentType || '',
      maxValue: item.maxValue || '',
      maxValueCode: item.maxValueCode || '',
      minValue: item.minValue || '',
      minValueCode: item.minValueCode || '',
      measuredValue: mv,
      judgmentResult: jr,
      autoJudgment: (overrideCb && overrideCb.checked) ? '' : jr,
      manualOverride: overrideCb ? overrideCb.checked : false,
      remarks: remarkInput ? remarkInput.value.trim() : ''
    });
  });

  currentResults[currentSampleIdx] = items;
}

function collectDiary() {
  return {
    testStartDate: (document.getElementById('diary-start') || {}).value || '',
    testEndDate: (document.getElementById('diary-end') || {}).value || '',
    testerName: (document.getElementById('diary-tester') || {}).value || '',
    diaryMemo: (document.getElementById('diary-memo') || {}).value || '',
    exprDiarySn: currentDiary.exprDiarySn || null
  };
}

/* ============================================================
   Firestore ì €ì¥
   ============================================================ */
async function saveResults() {
  if (!currentReceipt) { showToast('ì ‘ìˆ˜ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning'); return; }

  // í•„ìˆ˜ê°’ í™•ì¸
  var startDate = (document.getElementById('diary-start') || {}).value;
  if (!startDate) { showToast('ì‹œí—˜ì‹œì‘ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning'); return; }

  collectCurrentResults();
  var diary = collectDiary();

  try {
    var r = currentReceipt;
    var samples = r.samples || [];
    var totalSamples = samples.length || 1;

    // í˜„ì¬ ì‹œë£Œ ê²°ê³¼ ì €ì¥
    var items = currentResults[currentSampleIdx] || [];
    var allItemsJudged = items.length > 0 && items.every(function(it) { return it.measuredValue && it.judgmentResult; });
    var anyFail = items.some(function(it) { return it.judgmentResult === 'ë¶€ì í•©'; });

    var docData = {
      receiptNo: r.receiptNo,
      receiptId: r.id,
      sampleIdx: currentSampleIdx,
      testStartDate: diary.testStartDate,
      testEndDate: diary.testEndDate,
      testerName: diary.testerName,
      diaryMemo: diary.diaryMemo,
      exprDiarySn: diary.exprDiarySn || null,
      items: items,
      overallResult: allItemsJudged ? (anyFail ? 'ë¶€ì í•©' : 'ì í•©') : '',
      status: allItemsJudged ? 'ê²°ê³¼ì…ë ¥ì™„ë£Œ' : 'ì‹œí—˜ì¤‘',
      mfdsSubmitted: (savedTestResults[currentSampleIdx] || {}).mfdsSubmitted || false,
      mfdsResultSaved: (savedTestResults[currentSampleIdx] || {}).mfdsResultSaved || false
    };

    await fsSaveTestResult(docData);

    // ì ‘ìˆ˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    var allComplete = await fsCheckAllSamplesComplete(r.receiptNo, totalSamples);
    var newStatus = allComplete ? 'ê²°ê³¼ì…ë ¥ì™„ë£Œ' : 'ì‹œí—˜ì¤‘';
    if (r.status !== newStatus) {
      await fsUpdateReceiptStatus(r.id, newStatus);
      r.status = newStatus;
    }

    // ìºì‹œ ì—…ë°ì´íŠ¸
    savedTestResults[currentSampleIdx] = docData;
    currentDiary = diary;
    isModified = false;

    showToast('ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    updateStats();
    renderReceiptList();

  } catch(e) {
    console.error('ì €ì¥ ì‹¤íŒ¨:', e);
    showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
  }
}

/* ============================================================
   ì‹ì•½ì²˜ API ì—°ë™
   ============================================================ */
function toggleMfdsEnabled() {
  MFDS_ENABLED = document.getElementById('mfds-toggle').checked;
  localStorage.setItem('bfl_mfds_result_enabled', MFDS_ENABLED ? '1' : '0');
}

function openMfdsModal() {
  if (!MFDS_ENABLED) {
    showToast('ì‹ì•½ì²˜ ì „ì†¡ì´ ë¹„í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤. í™œì„±í™” í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'warning');
    return;
  }
  if (!currentReceipt) { showToast('ì ‘ìˆ˜ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning'); return; }

  collectCurrentResults();
  var items = currentResults[currentSampleIdx] || [];
  if (!items.length || !items[0].measuredValue) {
    showToast('ì¸¡ì •ê°’ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
    return;
  }

  var body = document.getElementById('mfds-modal-body');
  body.innerHTML = '<div class="alert alert-warning">ì‹ì•½ì²˜ì— ì „ì†¡í•˜ë©´ <strong>ì·¨ì†Œ/ì‚­ì œê°€ ë¶ˆê°€ëŠ¥</strong>í•©ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ í™•ì¸í•´ì£¼ì„¸ìš”.</div>' +
    '<table class="result-table" style="font-size:12px"><thead><tr><th>ì‹œí—˜í•­ëª©</th><th>ì¸¡ì •ê°’</th><th>íŒì •</th></tr></thead><tbody>' +
    items.map(function(it) {
      return '<tr><td>' + it.testItemName + '</td><td>' + it.measuredValue + '</td><td>' + getJudgeBadge(it.judgmentResult) + '</td></tr>';
    }).join('') +
    '</tbody></table>';

  document.getElementById('mfds-modal').classList.add('active');
}

function closeMfdsModal() {
  document.getElementById('mfds-modal').classList.remove('active');
}

async function confirmMfdsSubmit() {
  closeMfdsModal();

  // ë¨¼ì € Firestore ì €ì¥
  await saveResults();

  try {
    showToast('ì‹ì•½ì²˜ ì „ì†¡ ì¤‘...', 'info');

    // Step 1: ì‹œí—˜ì¼ì§€ ë“±ë¡
    var diary = collectDiary();
    var exprDiarySn = diary.exprDiarySn;

    if (!exprDiarySn) {
      var diaryParams = {
        jobSeCode: 'IM18000001',
        webApi: 'Y',
        sploreReqestNo: currentReceipt.sploreReqestNo || currentReceipt.receiptNo,
        sploreSn: String(currentSampleIdx + 1),
        exprBeginDe: (diary.testStartDate || '').replace(/-/g, ''),
        exprEndDe: (diary.testEndDate || diary.testStartDate || '').replace(/-/g, ''),
        exprDiaryCn: diary.diaryMemo || 'ì‹œí—˜ ì§„í–‰',
        sploreChargerId: (typeof MFDS !== 'undefined' && MFDS.DEFAULT_USER) ? MFDS.DEFAULT_USER.mfdsLimsId : 'apitest34'
      };

      var diaryRes = await MFDS.insertExprDiary(diaryParams);
      if (diaryRes && (diaryRes.resultFlag === '1' || diaryRes.exprDiarySn)) {
        exprDiarySn = diaryRes.exprDiarySn || (diaryRes.resultData && diaryRes.resultData[0] && diaryRes.resultData[0].exprDiarySn);
        currentDiary.exprDiarySn = exprDiarySn;
        // Firestore ì—…ë°ì´íŠ¸
        var docId = currentReceipt.receiptNo + '_S' + currentSampleIdx;
        await db.collection('testResults').doc(docId).update({ exprDiarySn: exprDiarySn, mfdsSubmitted: true });
        showToast('ì‹œí—˜ì¼ì§€ ë“±ë¡ ì™„ë£Œ (SN: ' + exprDiarySn + ')', 'success');
      } else {
        throw new Error(diaryRes.errorMessage || 'ì‹œí—˜ì¼ì§€ ë“±ë¡ ì‹¤íŒ¨');
      }
    }

    // Step 2: ê²€ì‚¬ê²°ê³¼ ì „ì†¡
    var items = currentResults[currentSampleIdx] || [];
    var resultParams = {
      jobSeCode: 'IM18000001',
      webApi: 'Y',
      sploreReqestNo: currentReceipt.sploreReqestNo || currentReceipt.receiptNo,
      sploreSn: String(currentSampleIdx + 1),
      exprDiarySn: exprDiarySn,
      inspctResultList: items.map(function(it, i) {
        return {
          testItmSn: String(i + 1),
          testItmCode: it.testItemCode,
          testItmNm: it.testItemName,
          inspctRsltValue: it.measuredValue,
          sstfcYn: it.judgmentResult === 'ì í•©' ? 'Y' : 'N',
          fdqntLimitApplcAt: 'N'
        };
      })
    };

    var resultRes = await MFDS.saveSploreInspctResult(resultParams);
    if (resultRes && resultRes.resultFlag === '1') {
      var docId2 = currentReceipt.receiptNo + '_S' + currentSampleIdx;
      await db.collection('testResults').doc(docId2).update({ mfdsResultSaved: true });
      showToast('ì‹ì•½ì²˜ ê²€ì‚¬ê²°ê³¼ ì „ì†¡ ì™„ë£Œ!', 'success');
    } else {
      showToast('ê²€ì‚¬ê²°ê³¼ ì „ì†¡ ì‹¤íŒ¨: ' + (resultRes.errorMessage || ''), 'error');
    }

  } catch(e) {
    console.error('ì‹ì•½ì²˜ ì „ì†¡ ì˜¤ë¥˜:', e);
    showToast('ì‹ì•½ì²˜ ì „ì†¡ ì‹¤íŒ¨: ' + (e.message || e), 'error');
  }
}

/* ============================================================
   ìœ í‹¸ë¦¬í‹°
   ============================================================ */
function toggleSection(header) {
  header.classList.toggle('active');
  var content = header.nextElementSibling;
  if (content) content.classList.toggle('active');
}

function markModified() {
  isModified = true;
}

function cancelEdit() {
  if (isModified && !confirm('ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì·¨ì†Œí• ê¹Œìš”?')) return;
  currentReceipt = null;
  isModified = false;
  document.getElementById('right-panel').innerHTML = '<div class="no-selection"><div class="icon">ğŸ”¬</div><div>ì¢Œì¸¡ ëª©ë¡ì—ì„œ ì ‘ìˆ˜ê±´ì„ ì„ íƒí•˜ì„¸ìš”</div></div>';
  document.querySelectorAll('.receipt-row').forEach(function(el) { el.classList.remove('active'); });
}

function showToast(msg, type) {
  var t = document.getElementById('toast');
  var m = document.getElementById('toast-msg');
  m.textContent = msg;
  t.className = 'toast active ' + (type || 'success');
  clearTimeout(t._timer);
  t._timer = setTimeout(function() { t.classList.remove('active'); }, 3500);
}

function handleUrlParams() {
  var params = new URLSearchParams(window.location.search);
  var rn = params.get('receiptNo');
  if (rn) {
    var found = allReceipts.find(function(r) { return r.receiptNo === rn; });
    if (found) selectReceipt(found.id);
  }
}
</script>
</body>
</html>
