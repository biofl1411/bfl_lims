<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firebase ìˆ˜ìˆ˜ë£Œ ë§¤í•‘ ë°ì´í„° ì—…ë¡œë“œ</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
    .card { background: #fff; border: 1px solid #e2e6ed; border-radius: 12px; padding: 24px; margin-bottom: 20px; }
    h1 { color: #1a1d23; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #1a73e8; color: #fff; }
    .btn-primary:disabled { background: #ccc; }
    .btn-danger { background: #dc2626; color: #fff; }
    .btn-success { background: #16a34a; color: #fff; }
    .progress { margin: 16px 0; height: 24px; background: #f1f3f5; border-radius: 12px; overflow: hidden; }
    .progress-bar { height: 100%; background: #1a73e8; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 600; }
    .log { background: #f8f9fa; border: 1px solid #e2e6ed; border-radius: 8px; padding: 12px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
    .status { font-size: 14px; color: #666; margin-top: 8px; }
    .count { font-size: 24px; font-weight: 700; color: #1a73e8; }
  </style>
</head>
<body>
  <h1>ğŸ”¥ Firebase ìˆ˜ìˆ˜ë£Œ ë§¤í•‘ ë°ì´í„° ì—…ë¡œë“œ</h1>

  <div class="card">
    <h3>ë°ì´í„° í˜„í™©</h3>
    <p>ì†ŒìŠ¤: <code>js/food_item_fee_mapping.js</code></p>
    <p>ì´ í•­ëª©: <span class="count" id="totalCount">ë¡œë”© ì¤‘...</span></p>
    <p class="status" id="firestoreStatus">Firestore ì—°ê²° í™•ì¸ ì¤‘...</p>
  </div>

  <div class="card">
    <h3>1ë‹¨ê³„: ë°ì´í„° ì—…ë¡œë“œ</h3>
    <p>food_item_fee_mapping ë°ì´í„°ë¥¼ Firestore <code>feeMapping</code> ì»¬ë ‰ì…˜ì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>
    <button class="btn btn-primary" id="uploadBtn" onclick="startUpload()" disabled>ğŸš€ ì—…ë¡œë“œ ì‹œì‘</button>
    <div class="progress" id="progressArea" style="display:none">
      <div class="progress-bar" id="progressBar" style="width:0%">0%</div>
    </div>
    <p class="status" id="uploadStatus"></p>
  </div>

  <div class="card">
    <h3>2ë‹¨ê³„: localStorage ë§ˆì´ê·¸ë ˆì´ì…˜</h3>
    <p>ê¸°ì¡´ localStorage ë°ì´í„°(ì—…ì²´, ì‚¬ìš©ì, ì„¤ì •)ë¥¼ Firestoreë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•©ë‹ˆë‹¤.</p>
    <button class="btn btn-success" id="migrateBtn" onclick="startMigration()" disabled>ğŸ“¦ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>
    <p class="status" id="migrateStatus"></p>
  </div>

  <div class="card">
    <h3>ë¡œê·¸</h3>
    <div class="log" id="logArea"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <script src="js/firebase-init.js"></script>
  <script src="js/firestore-helpers.js"></script>
  <script src="js/food_item_fee_mapping.js"></script>

  <script>
    // ì‹í’ˆ/ì¶•ì‚° ë¶„ë¥˜ ë§¤í•‘
    var PURPOSE_FIELD_MAP = {
      'Allergen(RT-PCR)': 'ì‹í’ˆ',
      'ì—°êµ¬ìš©ì—­': 'ì‹í’ˆ',
      'ì”ë¥˜ë†ì•½(ì°¸ê³ ìš©)': 'ì‹í’ˆ',
      'ì°¸ê³ ìš©(ì†Œë¹„ê¸°í•œì„¤ì •)': 'ì‹í’ˆ',
      'Vegan food(RT-PCR)': 'ì‹í’ˆ',
      'Halal food(RT_PCR)': 'ì‹í’ˆ',
      'ë¬¼ì§ˆê²€ì‚¬': 'ì‹í’ˆ',
      'ë°©ì‚¬ëŠ¥(HPGe)': 'ì‹í’ˆ',
      'í‘œì‹œê¸°ì¤€': 'ì‹í’ˆ',
      'ì°¸ê³ ìš©(ì™¸ë¶€ì˜ë¢°)': 'ì‹í’ˆ',
      'ì ‘ìˆ˜ì·¨ì†Œ': 'ì‹í’ˆ',
      'Allergen(ELISA)': 'ì¶•ì‚°',
      'í•­ìƒë¬¼ì§ˆ(ì°¸ê³ ìš©)': 'ì¶•ì‚°',
      // ê³µí†µ (ì‹í’ˆ/ì¶•ì‚° ëª¨ë‘)
      'ìê°€í’ˆì§ˆìœ„íƒê²€ì‚¬ìš©': 'ê³µí†µ',
      'ì°¸ê³ ìš©(ê¸°ì¤€ê·œê²©ì™¸)': 'ê³µí†µ',
      'ì°¸ê³ ìš©(ì˜ì–‘ì„±ë¶„)': 'ê³µí†µ'
    };

    function log(msg) {
      var el = document.getElementById('logArea');
      el.textContent += '[' + new Date().toLocaleTimeString() + '] ' + msg + '\n';
      el.scrollTop = el.scrollHeight;
    }

    // ì´ˆê¸°í™”
    window.onload = function() {
      var data = typeof FOOD_ITEM_FEE_MAPPING !== 'undefined' ? FOOD_ITEM_FEE_MAPPING : [];
      document.getElementById('totalCount').textContent = data.length + 'ê±´';
      log('ë°ì´í„° ë¡œë“œ: ' + data.length + 'ê±´');

      // Firestore ì—°ê²° í™•ì¸
      setTimeout(function() {
        if (typeof db !== 'undefined') {
          document.getElementById('firestoreStatus').textContent = 'âœ… Firestore ì—°ê²°ë¨';
          document.getElementById('uploadBtn').disabled = false;
          document.getElementById('migrateBtn').disabled = false;
          log('Firestore ì—°ê²° ì„±ê³µ');
        } else {
          document.getElementById('firestoreStatus').textContent = 'âŒ Firestore ì—°ê²° ì‹¤íŒ¨';
          log('ERROR: Firestore ì—°ê²° ì‹¤íŒ¨');
        }
      }, 2000);
    };

    // ì—…ë¡œë“œ
    async function startUpload() {
      var data = FOOD_ITEM_FEE_MAPPING;
      if (!data || data.length === 0) { log('ERROR: ë°ì´í„° ì—†ìŒ'); return; }

      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('progressArea').style.display = '';
      var statusEl = document.getElementById('uploadStatus');
      var barEl = document.getElementById('progressBar');

      // Firestore batch ì œí•œ: 500ê±´
      var BATCH_SIZE = 400;
      var total = data.length;
      var uploaded = 0;
      var errors = 0;

      log('ì—…ë¡œë“œ ì‹œì‘: ' + total + 'ê±´, ë°°ì¹˜ í¬ê¸°: ' + BATCH_SIZE);

      for (var i = 0; i < total; i += BATCH_SIZE) {
        var batch = db.batch();
        var chunk = data.slice(i, i + BATCH_SIZE);

        chunk.forEach(function(item) {
          var field = PURPOSE_FIELD_MAP[item.purpose] || 'ì‹í’ˆ';
          var docData = {
            purpose: item.purpose || '',
            foodType: item.foodType || '',
            bracket: item.bracket || '',
            item: item.item || '',
            fee: item.fee || 0,
            count: item.count || 0,
            field: field
          };
          var ref = db.collection('feeMapping').doc();
          batch.set(ref, docData);
        });

        try {
          await batch.commit();
          uploaded += chunk.length;
        } catch (e) {
          errors += chunk.length;
          log('ERROR ë°°ì¹˜ ' + Math.floor(i/BATCH_SIZE) + ': ' + e.message);
        }

        var pct = Math.round((uploaded / total) * 100);
        barEl.style.width = pct + '%';
        barEl.textContent = pct + '%';
        statusEl.textContent = uploaded + ' / ' + total + ' ì—…ë¡œë“œ ì™„ë£Œ' + (errors > 0 ? ' (ì˜¤ë¥˜: ' + errors + ')' : '');
        log('ë°°ì¹˜ ì™„ë£Œ: ' + uploaded + '/' + total);
      }

      log('ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: ' + uploaded + ', ì˜¤ë¥˜: ' + errors);
      statusEl.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ! ' + uploaded + 'ê±´ ì„±ê³µ' + (errors > 0 ? ', ' + errors + 'ê±´ ì˜¤ë¥˜' : '');
    }

    // localStorage ë§ˆì´ê·¸ë ˆì´ì…˜
    async function startMigration() {
      document.getElementById('migrateBtn').disabled = true;
      var statusEl = document.getElementById('migrateStatus');
      statusEl.textContent = 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ì¤‘...';
      log('localStorage ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘');

      try {
        var result = await fsMigrateFromLocalStorage();
        var msg = 'âœ… ì™„ë£Œ! ì—…ì²´: ' + result.companies + 'ê±´, ì‚¬ìš©ì: ' + result.users + 'ê±´, ì„¤ì •: ' + result.settings + 'ê±´';
        statusEl.textContent = msg;
        log(msg);
      } catch (e) {
        statusEl.textContent = 'âŒ ì˜¤ë¥˜: ' + e.message;
        log('ERROR: ' + e.message);
      }
    }
  </script>
</body>
</html>
